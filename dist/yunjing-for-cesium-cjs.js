"use strict";var t=require("cesium"),e="undefined"!=typeof document?document.currentScript:null;function n(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var i=n(t);class r extends i.Terrain{constructor(t){let e;switch(t.crs){case"gcj02":default:e="China02";break;case"wgs84":e="China84"}const n=`https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/gaus/Terrain/${e}`;super(i.CesiumTerrainProvider.fromUrl(n))}}class o extends i.ImageryLayer{constructor(t){super(new i.UrlTemplateImageryProvider({url:"https://webst0{S}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",minimumLevel:3,maximumLevel:t?.maximumLevel||18,customTags:{S:function(t,e,n,i){return(e+n)%4+1}}}))}}var s,a,u,h,l,c,f,d,p,v,m,y,w,g,b,_,x,k,$,S,E,M,C,A,O,I,T,z,R,F,D,P,N,U=Object.defineProperty,q=Object.getOwnPropertyDescriptor,j=Object.getOwnPropertyNames,L={}.hasOwnProperty,B=(s=function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')},typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):s),H=(t,e)=>()=>(t&&(e=t(t=0)),e),W=(t,e)=>{for(var n in e)U(t,n,{get:e[n],enumerable:!0})},V=t=>((t,e,n,i)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let n of j(e))!L.call(t,n)&&void 0!==n&&U(t,n,{get:()=>e[n],enumerable:!(i=q(e,n))||i.enumerable});return t})(U({},"__esModule",{value:!0}),t),G=H((()=>{a=new Map,u=[],h=(t,e,n)=>{if(!e||"function"!=typeof e.init||"function"!=typeof e.createInferenceSessionHandler)throw new TypeError("not a valid backend");{let i=a.get(t);if(void 0===i)a.set(t,{backend:e,priority:n});else{if(i.priority>n)return;if(i.priority===n&&i.backend!==e)throw new Error(`cannot register backend "${t}" using priority ${n}`)}if(n>=0){let e=u.indexOf(t);-1!==e&&u.splice(e,1);for(let e=0;e<u.length;e++)if(a.get(u[e]).priority<=n)return void u.splice(e,0,t);u.push(t)}}},l=async t=>{let e=a.get(t);if(!e)return"backend not found.";if(e.initialized)return e.backend;if(e.aborted)return e.error;{let n=!!e.initPromise;try{return n||(e.initPromise=e.backend.init(t)),await e.initPromise,e.initialized=!0,e.backend}catch(t){return n||(e.error=`${t}`,e.aborted=!0),e.error}finally{delete e.initPromise}}},c=async t=>{let e,n=t.executionProviders||[],i=n.map((t=>"string"==typeof t?t:t.name)),r=0===i.length?u:i,o=[],s=new Set;for(let t of r){let n=await l(t);"string"==typeof n?o.push({name:t,err:n}):(e||(e=n),e===n&&s.add(t))}if(!e)throw new Error(`no available backend found. ERR: ${o.map((t=>`[${t.name}] ${t.err}`)).join(", ")}`);for(let{name:t,err:e}of o)i.includes(t);let a=n.filter((t=>s.has("string"==typeof t?t:t.name)));return[e,new Proxy(t,{get:(t,e)=>"executionProviders"===e?a:Reflect.get(t,e)})]}})),Y=H((()=>{G()})),K=H((()=>{f="1.19.2"})),X=H((()=>{K(),d="warning",p={wasm:{},webgl:{},webgpu:{},versions:{common:f},set logLevel(t){if(void 0!==t){if("string"!=typeof t||-1===["verbose","info","warning","error","fatal"].indexOf(t))throw new Error(`Unsupported logging level: ${t}`);d=t}},get logLevel(){return d}},Object.defineProperty(p,"logLevel",{enumerable:!0})})),Q=H((()=>{X(),v=p})),Z=H((()=>{m=(t,e)=>{let n=typeof document<"u"?document.createElement("canvas"):new OffscreenCanvas(1,1);n.width=t.dims[3],n.height=t.dims[2];let i=n.getContext("2d");if(null!=i){let r,o;void 0!==e?.tensorLayout&&"NHWC"===e.tensorLayout?(r=t.dims[2],o=t.dims[3]):(r=t.dims[3],o=t.dims[2]);let s,a,u=void 0!==e?.format?e.format:"RGB",h=e?.norm;void 0===h||void 0===h.mean?s=[255,255,255,255]:"number"==typeof h.mean?s=[h.mean,h.mean,h.mean,h.mean]:(s=[h.mean[0],h.mean[1],h.mean[2],0],void 0!==h.mean[3]&&(s[3]=h.mean[3])),void 0===h||void 0===h.bias?a=[0,0,0,0]:"number"==typeof h.bias?a=[h.bias,h.bias,h.bias,h.bias]:(a=[h.bias[0],h.bias[1],h.bias[2],0],void 0!==h.bias[3]&&(a[3]=h.bias[3]));let l=o*r,c=0,f=l,d=2*l,p=-1;"RGBA"===u?(c=0,f=l,d=2*l,p=3*l):"RGB"===u?(c=0,f=l,d=2*l):"RBG"===u&&(c=0,d=l,f=2*l);for(let e=0;e<o;e++)for(let n=0;n<r;n++){let r=(t.data[c++]-a[0])*s[0],o=(t.data[f++]-a[1])*s[1],u=(t.data[d++]-a[2])*s[2],h=-1===p?255:(t.data[p++]-a[3])*s[3];i.fillStyle="rgba("+r+","+o+","+u+","+h+")",i.fillRect(n,e,1,1)}if("toDataURL"in n)return n.toDataURL();throw new Error("toDataURL is not supported")}throw new Error("Can not access image data")},y=(t,e)=>{let n,i=typeof document<"u"?document.createElement("canvas").getContext("2d"):new OffscreenCanvas(1,1).getContext("2d");if(null==i)throw new Error("Can not access image data");{let r,o,s;void 0!==e?.tensorLayout&&"NHWC"===e.tensorLayout?(r=t.dims[2],o=t.dims[1],s=t.dims[3]):(r=t.dims[3],o=t.dims[2],s=t.dims[1]);let a,u,h=void 0!==e&&void 0!==e.format?e.format:"RGB",l=e?.norm;void 0===l||void 0===l.mean?a=[255,255,255,255]:"number"==typeof l.mean?a=[l.mean,l.mean,l.mean,l.mean]:(a=[l.mean[0],l.mean[1],l.mean[2],255],void 0!==l.mean[3]&&(a[3]=l.mean[3])),void 0===l||void 0===l.bias?u=[0,0,0,0]:"number"==typeof l.bias?u=[l.bias,l.bias,l.bias,l.bias]:(u=[l.bias[0],l.bias[1],l.bias[2],0],void 0!==l.bias[3]&&(u[3]=l.bias[3]));let c=o*r;if(void 0!==e&&(void 0!==e.format&&4===s&&"RGBA"!==e.format||3===s&&"RGB"!==e.format&&"BGR"!==e.format))throw new Error("Tensor format doesn't match input tensor dims");let f=4,d=0,p=1,v=2,m=3,y=0,w=c,g=2*c,b=-1;"RGBA"===h?(y=0,w=c,g=2*c,b=3*c):"RGB"===h?(y=0,w=c,g=2*c):"RBG"===h&&(y=0,g=c,w=2*c),n=i.createImageData(r,o);for(let e=0;e<o*r;d+=f,p+=f,v+=f,m+=f,e++)n.data[d]=(t.data[y++]-u[0])*a[0],n.data[p]=(t.data[w++]-u[1])*a[1],n.data[v]=(t.data[g++]-u[2])*a[2],n.data[m]=-1===b?255:(t.data[b++]-u[3])*a[3]}return n}})),J=H((()=>{nt(),w=(t,e)=>{if(void 0===t)throw new Error("Image buffer must be defined");if(void 0===e.height||void 0===e.width)throw new Error("Image height and width must be defined");if("NHWC"===e.tensorLayout)throw new Error("NHWC Tensor layout is not supported yet");let n,i,{height:r,width:o}=e,s=e.norm??{mean:255,bias:0};n="number"==typeof s.mean?[s.mean,s.mean,s.mean,s.mean]:[s.mean[0],s.mean[1],s.mean[2],s.mean[3]??255],i="number"==typeof s.bias?[s.bias,s.bias,s.bias,s.bias]:[s.bias[0],s.bias[1],s.bias[2],s.bias[3]??0];let a=void 0!==e.format?e.format:"RGBA",u=void 0!==e.tensorFormat&&void 0!==e.tensorFormat?e.tensorFormat:"RGB",h=r*o,l="RGBA"===u?new Float32Array(4*h):new Float32Array(3*h),c=4,f=0,d=1,p=2,v=3,m=0,y=h,w=2*h,g=-1;"RGB"===a&&(c=3,f=0,d=1,p=2,v=-1),"RGBA"===u?g=3*h:"RBG"===u?(m=0,w=h,y=2*h):"BGR"===u&&(w=0,y=h,m=2*h);for(let e=0;e<h;e++,f+=c,p+=c,d+=c,v+=c)l[m++]=(t[f]+i[0])/n[0],l[y++]=(t[d]+i[1])/n[1],l[w++]=(t[p]+i[2])/n[2],-1!==g&&-1!==v&&(l[g++]=(t[v]+i[3])/n[3]);return new A("float32",l,"RGBA"===u?[1,4,r,o]:[1,3,r,o])},g=async(t,e)=>{let n,i=typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement,r=typeof ImageData<"u"&&t instanceof ImageData,o=typeof ImageBitmap<"u"&&t instanceof ImageBitmap,s="string"==typeof t,a=e??{},u=()=>{if(typeof document<"u")return document.createElement("canvas");if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(1,1);throw new Error("Canvas is not supported")},h=t=>t instanceof HTMLCanvasElement||t instanceof OffscreenCanvas?t.getContext("2d"):null;if(i){let i=u();i.width=t.width,i.height=t.height;let r=h(i);if(null==r)throw new Error("Can not access image data");{let i=t.height,o=t.width;if(void 0!==e&&void 0!==e.resizedHeight&&void 0!==e.resizedWidth&&(i=e.resizedHeight,o=e.resizedWidth),void 0!==e){if(a=e,void 0!==e.tensorFormat)throw new Error("Image input config format must be RGBA for HTMLImageElement");a.tensorFormat="RGBA",a.height=i,a.width=o}else a.tensorFormat="RGBA",a.height=i,a.width=o;r.drawImage(t,0,0),n=r.getImageData(0,0,o,i).data}}else{if(!r){if(o){if(void 0===e)throw new Error("Please provide image config with format for Imagebitmap");let i=u();i.width=t.width,i.height=t.height;let r=h(i);if(null!=r){let e=t.height,i=t.width;return r.drawImage(t,0,0,i,e),n=r.getImageData(0,0,i,e).data,a.height=e,a.width=i,w(n,a)}throw new Error("Can not access image data")}if(s)return new Promise(((e,n)=>{let i=u(),r=h(i);if(!t||!r)return n();let o=new Image;o.crossOrigin="Anonymous",o.src=t,o.onload=()=>{i.width=o.width,i.height=o.height,r.drawImage(o,0,0,i.width,i.height);let t=r.getImageData(0,0,i.width,i.height);a.height=i.height,a.width=i.width,e(w(t.data,a))}}));throw new Error("Input data provided is not supported - aborted tensor creation")}{let i,r;if(void 0!==e&&void 0!==e.resizedWidth&&void 0!==e.resizedHeight?(i=e.resizedHeight,r=e.resizedWidth):(i=t.height,r=t.width),void 0!==e&&(a=e),a.format="RGBA",a.height=i,a.width=r,void 0!==e){let e=u();e.width=r,e.height=i;let o=h(e);if(null==o)throw new Error("Can not access image data");o.putImageData(t,0,0),n=o.getImageData(0,0,r,i).data}else n=t.data}}if(void 0!==n)return w(n,a);throw new Error("Input data provided is not supported - aborted tensor creation")},b=(t,e)=>{let{width:n,height:i,download:r,dispose:o}=e;return new A({location:"texture",type:"float32",texture:t,dims:[1,i,n,4],download:r,dispose:o})},_=(t,e)=>{let{dataType:n,dims:i,download:r,dispose:o}=e;return new A({location:"gpu-buffer",type:n??"float32",gpuBuffer:t,dims:i,download:r,dispose:o})},x=(t,e,n)=>new A({location:"cpu-pinned",type:t,data:e,dims:n??[e.length]})})),tt=H((()=>{k=new Map([["float32",Float32Array],["uint8",Uint8Array],["int8",Int8Array],["uint16",Uint16Array],["int16",Int16Array],["int32",Int32Array],["bool",Uint8Array],["float64",Float64Array],["uint32",Uint32Array]]),$=new Map([[Float32Array,"float32"],[Uint8Array,"uint8"],[Int8Array,"int8"],[Uint16Array,"uint16"],[Int16Array,"int16"],[Int32Array,"int32"],[Float64Array,"float64"],[Uint32Array,"uint32"]]),S=!1,E=()=>{if(!S){S=!0;let t=typeof BigInt64Array<"u"&&BigInt64Array.from,e=typeof BigUint64Array<"u"&&BigUint64Array.from,n=typeof Float16Array<"u"&&Float16Array.from;t&&(k.set("int64",BigInt64Array),$.set(BigInt64Array,"int64")),e&&(k.set("uint64",BigUint64Array),$.set(BigUint64Array,"uint64")),n?(k.set("float16",Float16Array),$.set(Float16Array,"float16")):k.set("float16",Uint16Array)}}})),et=H((()=>{nt(),M=t=>{let e=1;for(let n=0;n<t.length;n++){let i=t[n];if("number"!=typeof i||!Number.isSafeInteger(i))throw new TypeError(`dims[${n}] must be an integer, got: ${i}`);if(i<0)throw new RangeError(`dims[${n}] must be a non-negative integer, got: ${i}`);e*=i}return e},C=(t,e)=>{switch(t.location){case"cpu":return new A(t.type,t.data,e);case"cpu-pinned":return new A({location:"cpu-pinned",data:t.data,type:t.type,dims:e});case"texture":return new A({location:"texture",texture:t.texture,type:t.type,dims:e});case"gpu-buffer":return new A({location:"gpu-buffer",gpuBuffer:t.gpuBuffer,type:t.type,dims:e});default:throw new Error(`tensorReshape: tensor location ${t.location} is not supported`)}}})),nt=H((()=>{Z(),J(),tt(),et(),A=class{constructor(t,e,n){let i,r;if(E(),"object"==typeof t&&"location"in t)switch(this.dataLocation=t.location,i=t.type,r=t.dims,t.location){case"cpu-pinned":{let e=k.get(i);if(!e)throw new TypeError(`unsupported type "${i}" to create tensor from pinned buffer`);if(!(t.data instanceof e))throw new TypeError(`buffer should be of type ${e.name}`);this.cpuData=t.data;break}case"texture":if("float32"!==i)throw new TypeError(`unsupported type "${i}" to create tensor from texture`);this.gpuTextureData=t.texture,this.downloader=t.download,this.disposer=t.dispose;break;case"gpu-buffer":if("float32"!==i&&"float16"!==i&&"int32"!==i&&"int64"!==i&&"uint32"!==i&&"uint8"!==i&&"bool"!==i)throw new TypeError(`unsupported type "${i}" to create tensor from gpu buffer`);this.gpuBufferData=t.gpuBuffer,this.downloader=t.download,this.disposer=t.dispose;break;default:throw new Error(`Tensor constructor: unsupported location '${this.dataLocation}'`)}else{let o,s;if("string"==typeof t)if(i=t,s=n,"string"===t){if(!Array.isArray(e))throw new TypeError("A string tensor's data must be a string array.");o=e}else{let n=k.get(t);if(void 0===n)throw new TypeError(`Unsupported tensor type: ${t}.`);if(Array.isArray(e)){if("float16"===t&&n===Uint16Array)throw new TypeError("Creating a float16 tensor from number array is not supported. Please use Uint16Array as data.");o="uint64"===t||"int64"===t?n.from(e,BigInt):n.from(e)}else{if(!(e instanceof n))throw new TypeError(`A ${i} tensor's data must be type of ${n}`);o=e}}else if(s=e,Array.isArray(t)){if(0===t.length)throw new TypeError("Tensor type cannot be inferred from an empty array.");let e=typeof t[0];if("string"===e)i="string",o=t;else{if("boolean"!==e)throw new TypeError(`Invalid element type of data array: ${e}.`);i="bool",o=Uint8Array.from(t)}}else{let e=$.get(t.constructor);if(void 0===e)throw new TypeError(`Unsupported type for tensor data: ${t.constructor}.`);i=e,o=t}if(void 0===s)s=[o.length];else if(!Array.isArray(s))throw new TypeError("A tensor's dims must be a number array");r=s,this.cpuData=o,this.dataLocation="cpu"}let o=M(r);if(this.cpuData&&o!==this.cpuData.length)throw new Error(`Tensor's size(${o}) does not match data length(${this.cpuData.length}).`);this.type=i,this.dims=r,this.size=o}static async fromImage(t,e){return g(t,e)}static fromTexture(t,e){return b(t,e)}static fromGpuBuffer(t,e){return _(t,e)}static fromPinnedBuffer(t,e,n){return x(t,e,n)}toDataURL(t){return m(this,t)}toImageData(t){return y(this,t)}get data(){if(this.ensureValid(),!this.cpuData)throw new Error("The data is not on CPU. Use `getData()` to download GPU data to CPU, or use `texture` or `gpuBuffer` property to access the GPU data directly.");return this.cpuData}get location(){return this.dataLocation}get texture(){if(this.ensureValid(),!this.gpuTextureData)throw new Error("The data is not stored as a WebGL texture.");return this.gpuTextureData}get gpuBuffer(){if(this.ensureValid(),!this.gpuBufferData)throw new Error("The data is not stored as a WebGPU buffer.");return this.gpuBufferData}async getData(t){switch(this.ensureValid(),this.dataLocation){case"cpu":case"cpu-pinned":return this.data;case"texture":case"gpu-buffer":if(!this.downloader)throw new Error("The current tensor is not created with a specified data downloader.");if(this.isDownloading)throw new Error("The current tensor is being downloaded.");try{this.isDownloading=!0;let e=await this.downloader();return this.downloader=void 0,this.dataLocation="cpu",this.cpuData=e,t&&this.disposer&&(this.disposer(),this.disposer=void 0),e}finally{this.isDownloading=!1}default:throw new Error(`cannot get data from location: ${this.dataLocation}`)}}dispose(){if(this.isDownloading)throw new Error("The current tensor is being downloaded.");this.disposer&&(this.disposer(),this.disposer=void 0),this.cpuData=void 0,this.gpuTextureData=void 0,this.gpuBufferData=void 0,this.downloader=void 0,this.isDownloading=void 0,this.dataLocation="none"}ensureValid(){if("none"===this.dataLocation)throw new Error("The tensor is disposed.")}reshape(t){if(this.ensureValid(),this.downloader||this.disposer)throw new Error("Cannot reshape a tensor that owns GPU resource.");return C(this,t)}}})),it=H((()=>{nt(),O=A})),rt=H((()=>{X(),I=(t,e)=>{typeof p.trace>"u"?p.wasm.trace:p.trace},T=(t,e)=>{let n=(new Error).stack?.split(/\r\n|\r|\n/g)||[],i=!1;for(let r=0;r<n.length;r++){if(i&&!n[r].includes("TRACE_FUNC")){let i=`FUNC_${t}::${n[r].trim().split(" ")[1]}`;return e&&(i+=`::${e}`),void I("CPU",i)}n[r].includes("TRACE_FUNC")&&(i=!0)}},z=t=>{(typeof p.trace>"u"?!p.wasm.trace:!p.trace)||T("BEGIN",t)},R=t=>{(typeof p.trace>"u"?!p.wasm.trace:!p.trace)||T("END",t)}})),ot=H((()=>{G(),it(),rt(),F=class t{constructor(t){this.handler=t}async run(t,e,n){z();let i={},r={};if("object"!=typeof t||null===t||t instanceof O||Array.isArray(t))throw new TypeError("'feeds' must be an object that use input names as keys and OnnxValue as corresponding values.");let o=!0;if("object"==typeof e){if(null===e)throw new TypeError("Unexpected argument[1]: cannot be null.");if(e instanceof O)throw new TypeError("'fetches' cannot be a Tensor");if(Array.isArray(e)){if(0===e.length)throw new TypeError("'fetches' cannot be an empty array.");o=!1;for(let t of e){if("string"!=typeof t)throw new TypeError("'fetches' must be a string array or an object.");if(-1===this.outputNames.indexOf(t))throw new RangeError(`'fetches' contains invalid output name: ${t}.`);i[t]=null}if("object"==typeof n&&null!==n)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else{let t=!1,s=Object.getOwnPropertyNames(e);for(let n of this.outputNames)if(-1!==s.indexOf(n)){let r=e[n];(null===r||r instanceof O)&&(t=!0,o=!1,i[n]=r)}if(t){if("object"==typeof n&&null!==n)r=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else r=e}}else if(typeof e<"u")throw new TypeError("Unexpected argument[1]: must be 'fetches' or 'options'.");for(let e of this.inputNames)if(typeof t[e]>"u")throw new Error(`input '${e}' is missing in 'feeds'.`);if(o)for(let t of this.outputNames)i[t]=null;let s=await this.handler.run(t,i,r),a={};for(let t in s)if(Object.hasOwnProperty.call(s,t)){let e=s[t];a[t]=e instanceof O?e:new O(e.type,e.data,e.dims)}return R(),a}async release(){return this.handler.dispose()}static async create(e,n,i,r){z();let o,s={};if("string"==typeof e){if(o=e,"object"==typeof n&&null!==n)s=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else if(e instanceof Uint8Array){if(o=e,"object"==typeof n&&null!==n)s=n;else if(typeof n<"u")throw new TypeError("'options' must be an object.")}else{if(!(e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer))throw new TypeError("Unexpected argument[0]: must be 'path' or 'buffer'.");{let t=e,a=0,u=e.byteLength;if("object"==typeof n&&null!==n)s=n;else if("number"==typeof n){if(a=n,!Number.isSafeInteger(a))throw new RangeError("'byteOffset' must be an integer.");if(a<0||a>=t.byteLength)throw new RangeError(`'byteOffset' is out of range [0, ${t.byteLength}).`);if(u=e.byteLength-a,"number"==typeof i){if(u=i,!Number.isSafeInteger(u))throw new RangeError("'byteLength' must be an integer.");if(u<=0||a+u>t.byteLength)throw new RangeError(`'byteLength' is out of range (0, ${t.byteLength-a}].`);if("object"==typeof r&&null!==r)s=r;else if(typeof r<"u")throw new TypeError("'options' must be an object.")}else if(typeof i<"u")throw new TypeError("'byteLength' must be a number.")}else if(typeof n<"u")throw new TypeError("'options' must be an object.");o=new Uint8Array(t,a,u)}}let[a,u]=await c(s),h=await a.createInferenceSessionHandler(o,u);return R(),new t(h)}startProfiling(){this.handler.startProfiling()}endProfiling(){this.handler.endProfiling()}get inputNames(){return this.handler.inputNames}get outputNames(){return this.handler.outputNames}}})),st=H((()=>{ot(),D=F})),at=H((()=>{})),ut=H((()=>{})),ht=H((()=>{})),lt=H((()=>{})),ct=H((()=>{G(),it(),P=class t{constructor(t,e,n){this.handler=t,this.hasOptimizerModel=e,this.hasEvalModel=n}get trainingInputNames(){return this.handler.inputNames}get trainingOutputNames(){return this.handler.outputNames}get evalInputNames(){if(this.hasEvalModel)return this.handler.evalInputNames;throw new Error("This training session has no evalModel loaded.")}get evalOutputNames(){if(this.hasEvalModel)return this.handler.evalOutputNames;throw new Error("This training session has no evalModel loaded.")}static async create(e,n){let i=e.evalModel||"",r=e.optimizerModel||"",o=n||{},[s,a]=await c(o);if(s.createTrainingSessionHandler){let n=await s.createTrainingSessionHandler(e.checkpointState,e.trainModel,i,r,a);return new t(n,!!e.optimizerModel,!!e.evalModel)}throw new Error("Training backend could not be resolved. Make sure you're using the correct configuration & WebAssembly files.")}typeNarrowingForRunStep(t,e,n,i,r){let o={},s={};if("object"!=typeof n||null===n||n instanceof O||Array.isArray(n))throw new TypeError("'feeds' must be an object that use input names as keys and OnnxValue as corresponding values.");let a=!0;if("object"==typeof i){if(null===i)throw new TypeError("Unexpected argument[1]: cannot be null.");if(i instanceof O)throw new TypeError("'fetches' cannot be a Tensor");if(Array.isArray(i)){if(0===i.length)throw new TypeError("'fetches' cannot be an empty array.");a=!1;for(let t of i){if("string"!=typeof t)throw new TypeError("'fetches' must be a string array or an object.");if(-1===e.indexOf(t))throw new RangeError(`'fetches' contains invalid output name: ${t}.`);o[t]=null}if("object"==typeof r&&null!==r)s=r;else if(typeof r<"u")throw new TypeError("'options' must be an object.")}else{let t=!1,n=Object.getOwnPropertyNames(i);for(let r of e)if(-1!==n.indexOf(r)){let e=i[r];(null===e||e instanceof O)&&(t=!0,a=!1,o[r]=e)}if(t){if("object"==typeof r&&null!==r)s=r;else if(typeof r<"u")throw new TypeError("'options' must be an object.")}else s=i}}else if(typeof i<"u")throw new TypeError("Unexpected argument[1]: must be 'fetches' or 'options'.");for(let e of t)if(typeof n[e]>"u")throw new Error(`input '${e}' is missing in 'feeds'.`);if(a)for(let t of e)o[t]=null;return[o,s]}convertHandlerReturnTypeToMapOfTensors(t){let e={};for(let n in t)if(Object.hasOwnProperty.call(t,n)){let i=t[n];e[n]=i instanceof O?i:new O(i.type,i.data,i.dims)}return e}async lazyResetGrad(){await this.handler.lazyResetGrad()}async runTrainStep(t,e,n){let[i,r]=this.typeNarrowingForRunStep(this.trainingInputNames,this.trainingOutputNames,t,e,n),o=await this.handler.runTrainStep(t,i,r);return this.convertHandlerReturnTypeToMapOfTensors(o)}async runOptimizerStep(t){if(!this.hasOptimizerModel)throw new Error("This TrainingSession has no OptimizerModel loaded.");await this.handler.runOptimizerStep(t||{})}async runEvalStep(t,e,n){if(this.hasEvalModel){let[i,r]=this.typeNarrowingForRunStep(this.evalInputNames,this.evalOutputNames,t,e,n),o=await this.handler.runEvalStep(t,i,r);return this.convertHandlerReturnTypeToMapOfTensors(o)}throw new Error("This TrainingSession has no EvalModel loaded.")}async getParametersSize(t=!0){return this.handler.getParametersSize(t)}async loadParametersBuffer(t,e=!0){let n=await this.getParametersSize(e);if(t.length!==4*n)throw new Error("Size of the buffer passed into loadParametersBuffer must match the number of parameters in the model. Please use getParametersSize method to check.");return this.handler.loadParametersBuffer(t,e)}async getContiguousParameters(t=!0){return this.handler.getContiguousParameters(t)}async release(){return this.handler.dispose()}}})),ft=H((()=>{ct(),N=P})),dt={};W(dt,{InferenceSession:()=>D,TRACE:()=>I,TRACE_FUNC_BEGIN:()=>z,TRACE_FUNC_END:()=>R,Tensor:()=>O,TrainingSession:()=>N,env:()=>v,registerBackend:()=>h});var pt=H((()=>{Y(),Q(),st(),it(),at(),ut(),rt(),ht(),lt(),ft()})),vt=H((()=>{})),mt={};W(mt,{default:()=>gt});var yt,wt,gt,bt=H((()=>{ul(),du(),fu(),yt="ort-wasm-proxy-worker",(wt=globalThis.self?.name===yt)&&(self.onmessage=t=>{let{type:e,in:n}=t.data;try{switch(e){case"init-wasm":Ut(n.wasm).then((()=>{Mh(n).then((()=>{postMessage({type:e})}),(t=>{postMessage({type:e,err:t})}))}),(t=>{postMessage({type:e,err:t})}));break;case"init-ep":{let{epName:t,env:i}=n;Ch(i,t).then((()=>{postMessage({type:e})}),(t=>{postMessage({type:e,err:t})}));break}case"copy-from":{let{buffer:t}=n,i=Ih(t);postMessage({type:e,out:i});break}case"create":{let{model:t,options:i}=n;Th(t,i).then((t=>{postMessage({type:e,out:t})}),(t=>{postMessage({type:e,err:t})}));break}case"release":zh(n),postMessage({type:e});break;case"run":{let{sessionId:t,inputIndices:i,inputs:r,outputIndices:o,options:s}=n;Fh(t,i,r,o,new Array(o.length).fill(null),s).then((t=>{t.some((t=>"cpu"!==t[3]))?postMessage({type:e,err:"Proxy does not support non-cpu tensor location."}):postMessage({type:e,out:t},Ph([...r,...t]))}),(t=>{postMessage({type:e,err:t})}));break}case"end-profiling":Dh(n),postMessage({type:e})}}catch(t){postMessage({type:e,err:t})}}),gt=wt?null:t=>new Worker(t??St,{type:"module",name:yt})})),_t={};W(_t,{default:()=>$t});var xt,kt,$t,St,Et,Mt,Ct,At,Ot,It,Tt,zt,Rt,Ft,Dt,Pt,Nt,Ut,qt,jt,Lt,Bt,Ht,Wt,Vt,Gt,Yt,Kt,Xt,Qt,Zt,Jt,te,ee,ne,ie,re,oe,se,ae,ue,he,le,ce,fe,de,pe,ve,me,ye,we,ge,be,_e,xe,ke,$e,Se,Ee,Me,Ce,Ae,Oe,Ie,Te,ze,Re,Fe,De,Pe,Ne,Ue,qe,je,Le,Be,He,We,Ve,Ge,Ye,Ke,Xe,Qe,Ze,Je,tn,en,nn,rn,on,sn,an,un,hn,ln,cn,fn,dn,pn,vn,mn,yn,wn,gn,bn,_n,xn,kn,$n,Sn,En,Mn,Cn,An,On,In,Tn,zn,Rn,Fn,Dn,Pn,Nn,Un,qn,jn,Ln,Bn,Hn,Wn,Vn,Gn,Yn,Kn,Xn,Qn,Zn,Jn,ti,ei,ni,ii,ri,oi,si,ai,ui,hi,li,ci,fi,di,pi,vi,mi,yi,wi,gi,bi,_i,xi,ki,$i,Si,Ei,Mi,Ci,Ai,Oi,Ii,Ti,zi,Ri,Fi,Di,Pi,Ni,Ui,qi,ji,Li,Bi,Hi,Wi,Vi,Gi,Yi,Ki,Xi,Qi,Zi,Ji,tr,er,nr,ir,rr,or,sr,ar,ur,hr,lr,cr,fr,dr,pr,vr,mr,yr,wr,gr,br,_r,xr,kr,$r,Sr,Er,Mr,Cr,Ar,Or,Ir,Tr,zr,Rr,Fr,Dr,Pr,Nr,Ur,qr,jr,Lr,Br,Hr,Wr,Vr,Gr,Yr,Kr,Xr,Qr,Zr,Jr,to,eo,no,io,ro,oo,so,ao,uo,ho,lo,co,fo,po,vo,mo,yo,wo,go,bo,_o,xo,ko,$o,So,Eo,Mo,Co,Ao,Oo,Io,To,zo,Ro,Fo,Do,Po,No,Uo,qo,jo,Lo,Bo,Ho,Wo,Vo,Go,Yo,Ko,Xo,Qo,Zo,Jo,ts,es,ns,is,rs,os,ss,as,us,hs,ls,cs,fs,ds,ps,vs,ms,ys,ws,gs,bs,_s,xs,ks,$s,Ss,Es,Ms,Cs,As,Os,Is,Ts,zs,Rs,Fs,Ds,Ps,Ns,Us,qs,js,Ls,Bs,Hs,Ws,Vs,Gs,Ys,Ks,Xs,Qs,Zs,Js,ta,ea,na,ia,ra,oa,sa,aa,ua,ha,la,ca,fa,da,pa,va,ma,ya,wa,ga,ba,_a,xa,ka,$a,Sa,Ea,Ma,Ca,Aa,Oa,Ia,Ta,za,Ra,Fa,Da,Pa,Na,Ua,qa,ja,La,Ba,Ha,Wa,Va,Ga,Ya,Ka,Xa,Qa,Za,Ja,tu,eu,nu,iu,ru,ou,su,au,uu,hu,lu,cu=H((()=>{xt="undefined"==typeof document?require("url").pathToFileURL(__filename).href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("yunjing-for-cesium-cjs.js",document.baseURI).href,kt=async function(t={}){function n(){return I.buffer!=R.buffer&&W(),R}function i(){return I.buffer!=R.buffer&&W(),F}function r(){return I.buffer!=R.buffer&&W(),D}function o(){return I.buffer!=R.buffer&&W(),P}function s(){return I.buffer!=R.buffer&&W(),N}function a(){return I.buffer!=R.buffer&&W(),U}function u(){return I.buffer!=R.buffer&&W(),q}function h(){return I.buffer!=R.buffer&&W(),B}var l,c,f=Object.assign({},t),d=new Promise(((t,e)=>{l=t,c=e})),p="object"==typeof window,v="function"==typeof importScripts,m=v&&"em-pthread"==self.name;f.mountExternalData=(t,e)=>{(f.Fb||(f.Fb=new Map)).set(t,e)},f.unmountExternalData=()=>{delete f.Fb};var y=globalThis.SharedArrayBuffer??new WebAssembly.Memory({initial:0,maximum:0,shared:!0}).buffer.constructor;let w=()=>{let t=(t,e,n)=>(...i)=>{let r=We,o=e?.();i=t(...i);let s=e?.();return o!==s&&(t=s,n(o),e=n=null),We!=r?new Promise(((t,e)=>{Qe={resolve:t,reject:e}})):i},e=t=>async(...e)=>{try{if(f.Eb)throw Error("Session already started");let n=f.Eb={bc:e[0],errors:[]},i=await t(...e);if(f.Eb!==n)throw Error("Session mismatch");f.Mb?.flush();let r=n.errors;if(0<r.length){let t=await Promise.all(r);if(t=t.filter((t=>t)),0<t.length)throw Error(t.join("\n"))}return i}finally{f.Eb=null}};f._=t(f._,(()=>f._),(t=>f._=t)),f.tt=e(t(f.tt,(()=>f.tt),(t=>f.tt=t))),f.et=e(t(f.et,(()=>f.et),(t=>f.et=t))),f.nt=t(f.nt,(()=>f.nt),(t=>f.nt=t)),w=void 0};f.jsepInit=(t,e)=>{if(w?.(),"webgpu"===t){[f.Mb,f.Tb,f.Xb,f.Nb,f.Wb,f.jb,f.Yb,f.$b,f.Ub,f.Vb,f.Zb]=e;let t=f.Mb;f.jsepRegisterBuffer=(e,n,i,r)=>t.registerBuffer(e,n,i,r),f.jsepGetBuffer=e=>t.getBuffer(e),f.jsepCreateDownloader=(e,n,i)=>t.createDownloader(e,n,i),f.jsepOnReleaseSession=e=>{t.onReleaseSession(e)},f.jsepOnRunStart=e=>t.onRunStart(e)}};var g,b,_=Object.assign({},f),x=(t,e)=>{throw e},k="";(p||v)&&(v?k=self.location.href:typeof document<"u"&&document.currentScript&&(k=document.currentScript.src),xt&&(k=xt),k=k.startsWith("blob:")?"":k.substr(0,k.replace(/[?#].*/,"").lastIndexOf("/")+1),v&&(b=t=>{var e=new XMLHttpRequest;return e.open("GET",t,!1),e.responseType="arraybuffer",e.send(null),new Uint8Array(e.response)}),g=(t,e,n)=>{var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=()=>{200==i.status||0==i.status&&i.response?e(i.response):n()},i.onerror=n,i.send(null)});var $,S=function(){}.bind(),E=function(){}.bind(),M=S,C=E;if(Object.assign(f,_),_=null,m){let t=function(e){try{var n=e.data,i=n.cmd;if("load"===i){let e=[];self.onmessage=t=>e.push(t),self.startWorker=()=>{postMessage({cmd:"loaded"});for(let n of e)t(n);self.onmessage=t};for(let t of n.handlers)f[t]&&!f[t].proxy||(f[t]=(...e)=>{postMessage({Lb:"callHandler",kc:t,args:e})},"print"==t&&(M=f[t]),"printErr"==t&&(C=f[t]));I=n.wasmMemory,W(),A(n.wasmModule)}else if("run"===i){_i(n.pthread_ptr,0,0,1,0,0),ze(n.pthread_ptr),Et(),_t(),O||(mi(),O=!0);try{Mt(n.start_routine,n.arg)}catch(t){if("unwind"!=t)throw t}}else"cancel"===i?wi()&&Si(-1):"setimmediate"!==n.target&&("checkMailbox"===i?O&&Re():i&&(C(`worker: received unknown command ${i}`),C(n)))}catch(t){throw xi(),t}};var A,O=!1;C=function(...t){t=t.join(" ")},self.alert=function(...t){postMessage({Lb:"alert",text:t.join(" "),mc:wi()})},f.instantiateWasm=(t,e)=>new Promise((t=>{A=n=>{n=new WebAssembly.Instance(n,rt()),e(n),t()}})),self.onunhandledrejection=t=>{throw t.reason||t},self.onmessage=t}f.wasmBinary&&($=f.wasmBinary);var I,T,z,R,F,D,P,N,U,q,j,L,B,H=!1;function W(){var t=I.buffer;f.HEAP8=R=new Int8Array(t),f.HEAP16=D=new Int16Array(t),f.HEAPU8=F=new Uint8Array(t),f.HEAPU16=P=new Uint16Array(t),f.HEAP32=N=new Int32Array(t),f.HEAPU32=U=new Uint32Array(t),f.HEAPF32=q=new Float32Array(t),f.HEAPF64=B=new Float64Array(t),f.HEAP64=j=new BigInt64Array(t),f.HEAPU64=L=new BigUint64Array(t)}if(!m){if(!((I=new WebAssembly.Memory({initial:256,maximum:65536,shared:!0})).buffer instanceof y))throw C("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),Error("bad memory");W()}var V=[],G=[],Y=[],K=0,X=null;function Q(){if(0==--K&&X){var t=X;X=null,t()}}function Z(t){throw C(t="Aborted("+t+")"),H=!0,z=1,t=new WebAssembly.RuntimeError(t+". Build with -sASSERTIONS for more info."),c(t),t}var J,tt=t=>t.startsWith("data:application/octet-stream;base64,"),et=t=>t.startsWith("file://");function nt(t){if(t==J&&$)return new Uint8Array($);if(b)return b(t);throw"both async and sync fetching of the wasm failed"}function it(t,e,n){return function(t){if(!$&&(p||v)){if("function"==typeof fetch&&!et(t))return fetch(t,{credentials:"same-origin"}).then((e=>{if(!e.ok)throw`failed to load wasm binary file at '${t}'`;return e.arrayBuffer()})).catch((()=>nt(t)));if(g)return new Promise(((e,n)=>{g(t,(t=>e(new Uint8Array(t))),n)}))}return Promise.resolve().then((()=>nt(t)))}(t).then((t=>WebAssembly.instantiate(t,e))).then(n,(t=>{C(`failed to asynchronously prepare wasm: ${t}`),Z(t)}))}function rt(){return{a:{M:at,za:st,b:At,$:It,z:Ft,pa:Dt,X:qt,Z:jt,qa:Lt,na:Bt,ga:Ht,ma:Wt,J:Vt,Y:Gt,V:Yt,oa:Kt,W:Xt,va:Jt,D:oe,P:ae,O:ve,C:ye,s:we,p:ge,E:be,y:Ce,Q:Ae,ta:Oe,ja:Ie,T:Fe,aa:Pe,F:Ne,ia:ze,sa:Ue,u:Le,B:tn,o:nn,m:sn,c:le,n:un,k:fn,Aa:dn,r:pn,f:vn,v:mn,l:yn,g:wn,i:gn,j:bn,h:_n,e:xn,da:kn,ea:Mn,fa:Cn,ba:An,ca:On,S:In,d:Rn,N:Fn,G:Dn,K:Pn,w:Nn,ra:qn,U:jn,t:Un,x:Ln,L:Bn,R:Hn,ya:Yn,xa:Kn,ka:Jn,la:ti,it:vt,A:ei,I:ni,ha:ii,H:oi,a:I,wa:dt,ua:hi,q:li}}}var ot={849620:(t,e,n,r)=>{if(void 0===f||!f.Fb)return 1;if((t=Rt(t>>>0)).startsWith("./")&&(t=t.substring(2)),!(t=f.Fb.get(t)))return 2;if(r>>>=0,(e>>>=0)+(n>>>=0)>t.byteLength)return 3;try{return i().set(t.subarray(e,e+n),r>>>0),0}catch{return 4}},850121:()=>{f.Ub()},850152:()=>{f.Vb()},850181:()=>{f.Zb()},850206:t=>f.Tb(t),850239:t=>f.Xb(t),850271:(t,e,n)=>{f.Nb(t,e,n,!0)},850310:(t,e,n)=>{f.Nb(t,e,n)},850343:()=>typeof wasmOffsetConverter<"u",850400:t=>{f.jb("Abs",t,void 0)},850451:t=>{f.jb("Neg",t,void 0)},850502:t=>{f.jb("Floor",t,void 0)},850555:t=>{f.jb("Ceil",t,void 0)},850607:t=>{f.jb("Reciprocal",t,void 0)},850665:t=>{f.jb("Sqrt",t,void 0)},850717:t=>{f.jb("Exp",t,void 0)},850768:t=>{f.jb("Erf",t,void 0)},850819:t=>{f.jb("Sigmoid",t,void 0)},850874:(t,e,n)=>{f.jb("HardSigmoid",t,{alpha:e,beta:n})},850953:t=>{f.jb("Log",t,void 0)},851004:t=>{f.jb("Sin",t,void 0)},851055:t=>{f.jb("Cos",t,void 0)},851106:t=>{f.jb("Tan",t,void 0)},851157:t=>{f.jb("Asin",t,void 0)},851209:t=>{f.jb("Acos",t,void 0)},851261:t=>{f.jb("Atan",t,void 0)},851313:t=>{f.jb("Sinh",t,void 0)},851365:t=>{f.jb("Cosh",t,void 0)},851417:t=>{f.jb("Asinh",t,void 0)},851470:t=>{f.jb("Acosh",t,void 0)},851523:t=>{f.jb("Atanh",t,void 0)},851576:t=>{f.jb("Tanh",t,void 0)},851628:t=>{f.jb("Not",t,void 0)},851679:(t,e,n)=>{f.jb("Clip",t,{min:e,max:n})},851748:t=>{f.jb("Clip",t,void 0)},851800:(t,e)=>{f.jb("Elu",t,{alpha:e})},851858:t=>{f.jb("Relu",t,void 0)},851910:(t,e)=>{f.jb("LeakyRelu",t,{alpha:e})},851974:(t,e)=>{f.jb("ThresholdedRelu",t,{alpha:e})},852044:(t,e)=>{f.jb("Cast",t,{to:e})},852102:t=>{f.jb("Add",t,void 0)},852153:t=>{f.jb("Sub",t,void 0)},852204:t=>{f.jb("Mul",t,void 0)},852255:t=>{f.jb("Div",t,void 0)},852306:t=>{f.jb("Pow",t,void 0)},852357:t=>{f.jb("Equal",t,void 0)},852410:t=>{f.jb("Greater",t,void 0)},852465:t=>{f.jb("GreaterOrEqual",t,void 0)},852527:t=>{f.jb("Less",t,void 0)},852579:t=>{f.jb("LessOrEqual",t,void 0)},852638:(t,e,n,i,r)=>{f.jb("ReduceMean",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},852797:(t,e,n,i,r)=>{f.jb("ReduceMax",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},852955:(t,e,n,i,r)=>{f.jb("ReduceMin",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853113:(t,e,n,i,r)=>{f.jb("ReduceProd",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853272:(t,e,n,i,r)=>{f.jb("ReduceSum",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853430:(t,e,n,i,r)=>{f.jb("ReduceL1",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853587:(t,e,n,i,r)=>{f.jb("ReduceL2",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853744:(t,e,n,i,r)=>{f.jb("ReduceLogSum",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},853905:(t,e,n,i,r)=>{f.jb("ReduceSumSquare",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},854069:(t,e,n,i,r)=>{f.jb("ReduceLogSumExp",t,{keepDims:!!e,noopWithEmptyAxes:!!n,axes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},854233:t=>{f.jb("Where",t,void 0)},854286:(t,e,n)=>{f.jb("Transpose",t,{perm:e?Array.from(s().subarray(e>>>0,n>>>0)):[]})},854394:(t,e,n,i)=>{f.jb("DepthToSpace",t,{blocksize:e,mode:Rt(n),format:i?"NHWC":"NCHW"})},854527:(t,e,n,i)=>{f.jb("DepthToSpace",t,{blocksize:e,mode:Rt(n),format:i?"NHWC":"NCHW"})},854660:(t,e,i,r,o,a,u,h,l,c,d,p,v,m,y)=>{f.jb("ConvTranspose",t,{format:l?"NHWC":"NCHW",autoPad:e,dilations:[i],group:r,kernelShape:[o],pads:[a,u],strides:[h],wIsConst:()=>!!n()[c>>>0],outputPadding:d?Array.from(s().subarray(d>>>0,p>>>0)):[],outputShape:v?Array.from(s().subarray(v>>>0,m>>>0)):[],activation:Rt(y)})},855061:(t,e,i,r,o,a,u,h,l,c,d,p,v,m)=>{f.jb("ConvTranspose",t,{format:h?"NHWC":"NCHW",autoPad:e,dilations:Array.from(s().subarray(i>>>0,2+(i>>>0)>>>0)),group:r,kernelShape:Array.from(s().subarray(o>>>0,2+(o>>>0)>>>0)),pads:Array.from(s().subarray(a>>>0,4+(a>>>0)>>>0)),strides:Array.from(s().subarray(u>>>0,2+(u>>>0)>>>0)),wIsConst:()=>!!n()[l>>>0],outputPadding:c?Array.from(s().subarray(c>>>0,d>>>0)):[],outputShape:p?Array.from(s().subarray(p>>>0,v>>>0)):[],activation:Rt(m)})},855626:(t,e,i,r,o,a,u,h,l,c,d,p,v,m,y)=>{f.jb("ConvTranspose",t,{format:l?"NHWC":"NCHW",autoPad:e,dilations:[i],group:r,kernelShape:[o],pads:[a,u],strides:[h],wIsConst:()=>!!n()[c>>>0],outputPadding:d?Array.from(s().subarray(d>>>0,p>>>0)):[],outputShape:v?Array.from(s().subarray(v>>>0,m>>>0)):[],activation:Rt(y)})},856027:(t,e,i,r,o,a,u,h,l,c,d,p,v,m)=>{f.jb("ConvTranspose",t,{format:h?"NHWC":"NCHW",autoPad:e,dilations:Array.from(s().subarray(i>>>0,2+(i>>>0)>>>0)),group:r,kernelShape:Array.from(s().subarray(o>>>0,2+(o>>>0)>>>0)),pads:Array.from(s().subarray(a>>>0,4+(a>>>0)>>>0)),strides:Array.from(s().subarray(u>>>0,2+(u>>>0)>>>0)),wIsConst:()=>!!n()[l>>>0],outputPadding:c?Array.from(s().subarray(c>>>0,d>>>0)):[],outputShape:p?Array.from(s().subarray(p>>>0,v>>>0)):[],activation:Rt(m)})},856592:(t,e)=>{f.jb("GlobalAveragePool",t,{format:e?"NHWC":"NCHW"})},856683:(t,e,n,i,r,o,s,a,u,h,l,c,d,p,v,m)=>{f.jb("AveragePool",t,{format:m?"NHWC":"NCHW",auto_pad:e,ceil_mode:n,count_include_pad:i,storage_order:r,dilations:[o,s],kernel_shape:[a,u],pads:[h,l,c,d],strides:[p,v]})},856967:(t,e)=>{f.jb("GlobalAveragePool",t,{format:e?"NHWC":"NCHW"})},857058:(t,e,n,i,r,o,s,a,u,h,l,c,d,p,v,m)=>{f.jb("AveragePool",t,{format:m?"NHWC":"NCHW",auto_pad:e,ceil_mode:n,count_include_pad:i,storage_order:r,dilations:[o,s],kernel_shape:[a,u],pads:[h,l,c,d],strides:[p,v]})},857342:(t,e)=>{f.jb("GlobalMaxPool",t,{format:e?"NHWC":"NCHW"})},857429:(t,e,n,i,r,o,s,a,u,h,l,c,d,p,v,m)=>{f.jb("MaxPool",t,{format:m?"NHWC":"NCHW",auto_pad:e,ceil_mode:n,count_include_pad:i,storage_order:r,dilations:[o,s],kernel_shape:[a,u],pads:[h,l,c,d],strides:[p,v]})},857709:(t,e)=>{f.jb("GlobalMaxPool",t,{format:e?"NHWC":"NCHW"})},857796:(t,e,n,i,r,o,s,a,u,h,l,c,d,p,v,m)=>{f.jb("MaxPool",t,{format:m?"NHWC":"NCHW",auto_pad:e,ceil_mode:n,count_include_pad:i,storage_order:r,dilations:[o,s],kernel_shape:[a,u],pads:[h,l,c,d],strides:[p,v]})},858076:(t,e,n,i,r)=>{f.jb("Gemm",t,{alpha:e,beta:n,transA:i,transB:r})},858180:t=>{f.jb("MatMul",t,void 0)},858234:(t,e,n,i)=>{f.jb("ArgMax",t,{keepDims:!!e,selectLastIndex:!!n,axis:i})},858342:(t,e,n,i)=>{f.jb("ArgMin",t,{keepDims:!!e,selectLastIndex:!!n,axis:i})},858450:(t,e)=>{f.jb("Softmax",t,{axis:e})},858513:(t,e)=>{f.jb("Concat",t,{axis:e})},858573:(t,e,n,i,r)=>{f.jb("Split",t,{axis:e,numOutputs:n,splitSizes:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},858713:t=>{f.jb("Expand",t,void 0)},858767:(t,e)=>{f.jb("Gather",t,{axis:Number(e)})},858838:(t,e)=>{f.jb("GatherElements",t,{axis:Number(e)})},858917:(t,e,n,i,r,o,a,u,h,l,c)=>{f.jb("Resize",t,{antialias:e,axes:n?Array.from(s().subarray(n>>>0,i>>>0)):[],coordinateTransformMode:Rt(r),cubicCoeffA:o,excludeOutside:a,extrapolationValue:u,keepAspectRatioPolicy:Rt(h),mode:Rt(l),nearestMode:Rt(c)})},859263:(t,e,n,i,r,o,a)=>{f.jb("Slice",t,{starts:e?Array.from(s().subarray(e>>>0,n>>>0)):[],ends:i?Array.from(s().subarray(i>>>0,r>>>0)):[],axes:o?Array.from(s().subarray(o>>>0,a>>>0)):[]})},859479:t=>{f.jb("Tile",t,void 0)},859531:(t,e,n)=>{f.jb("InstanceNormalization",t,{epsilon:e,format:n?"NHWC":"NCHW"})},859645:(t,e,n)=>{f.jb("InstanceNormalization",t,{epsilon:e,format:n?"NHWC":"NCHW"})},859759:t=>{f.jb("Range",t,void 0)},859812:(t,e)=>{f.jb("Einsum",t,{equation:Rt(e)})},859893:(t,e,n,i,r)=>{f.jb("Pad",t,{mode:e,value:n,pads:i?Array.from(s().subarray(i>>>0,r>>>0)):[]})},860020:(t,e,n,i,r,o)=>{f.jb("BatchNormalization",t,{epsilon:e,momentum:n,spatial:!!r,trainingMode:!!i,format:o?"NHWC":"NCHW"})},860189:(t,e,n,i,r,o)=>{f.jb("BatchNormalization",t,{epsilon:e,momentum:n,spatial:!!r,trainingMode:!!i,format:o?"NHWC":"NCHW"})},860358:(t,e,n)=>{f.jb("CumSum",t,{exclusive:Number(e),reverse:Number(n)})},860455:(t,e,n,i,r,o,a,u,h)=>{f.jb("Attention",t,{numHeads:e,isUnidirectional:n,maskFilterValue:i,scale:r,doRotary:o,qkvHiddenSizes:a?Array.from(s().subarray(Number(u)>>>0,Number(u)+a>>>0)):[],pastPresentShareBuffer:!!h})},860727:t=>{f.jb("BiasAdd",t,void 0)},860782:t=>{f.jb("BiasSplitGelu",t,void 0)},860843:t=>{f.jb("FastGelu",t,void 0)},860899:(t,e,i,r,o,a,h,l,c,d,p,v,m,y,w,g)=>{f.jb("Conv",t,{format:v?"NHWC":"NCHW",auto_pad:e,dilations:i?Array.from(s().subarray(i>>>0,r>>>0)):[],group:o,kernel_shape:a?Array.from(s().subarray(a>>>0,h>>>0)):[],pads:l?Array.from(s().subarray(l>>>0,c>>>0)):[],strides:d?Array.from(s().subarray(d>>>0,p>>>0)):[],w_is_const:()=>!!n()[m>>>0],activation:Rt(y),activation_params:w?Array.from(u().subarray(w>>>0,g>>>0)):[]})},861395:t=>{f.jb("Gelu",t,void 0)},861447:(t,e,n,i)=>{f.jb("GroupQueryAttention",t,{numHeads:e,kvNumHeads:n,scale:i})},861560:(t,e,n,i)=>{f.jb("LayerNormalization",t,{axis:e,epsilon:n,simplified:!!i})},861671:(t,e,n,i)=>{f.jb("LayerNormalization",t,{axis:e,epsilon:n,simplified:!!i})},861782:(t,e,n,i,r,o)=>{f.jb("MatMulNBits",t,{k:e,n:n,accuracyLevel:i,bits:r,blockSize:o})},861909:(t,e,n,i,r,o)=>{f.jb("MultiHeadAttention",t,{numHeads:e,isUnidirectional:n,maskFilterValue:i,scale:r,doRotary:o})},862068:(t,e)=>{f.jb("QuickGelu",t,{alpha:e})},862132:(t,e,n,i,r)=>{f.jb("RotaryEmbedding",t,{interleaved:!!e,numHeads:n,rotaryEmbeddingDim:i,scale:r})},862271:(t,e,n)=>{f.jb("SkipLayerNormalization",t,{epsilon:e,simplified:!!n})},862373:t=>{f.Yb(t)},862407:(t,e)=>f.$b(t,e,f.Eb.bc,f.Eb.errors),862519:(t,e,n)=>{f.jb("SkipLayerNormalization",t,{epsilon:e,simplified:!!n})}};function st(t,e,n){return Je((async()=>{await f.Wb(t,e,n)}))}function at(){return typeof wasmOffsetConverter<"u"}function ut(t){this.name="ExitStatus",this.message=`Program terminated with exit(${t})`,this.status=t}var ht=t=>{t.terminate(),t.onmessage=()=>{}},lt=t=>{0==mt.length&&($t(),kt(mt[0]));var e=mt.pop();if(!e)return 6;yt.push(e),gt[t.Ab]=e,e.Ab=t.Ab;var n={cmd:"run",start_routine:t.cc,arg:t.Pb,pthread_ptr:t.Ab};return e.postMessage(n,t.ic),0},ct=0,ft=(t,e,...n)=>{for(var i=2*n.length,r=Oi(),o=Ai(8*i),s=o>>>3,a=0;a<n.length;a++){var u=n[a];"bigint"==typeof u?(j[s+2*a]=1n,j[s+2*a+1]=u):(j[s+2*a]=0n,h()[s+2*a+1>>>0]=u)}return t=ki(t,0,i,o,e),Ci(r),t};function dt(t){if(m)return ft(0,1,t);if(z=t,!(0<ct)){for(var e of yt)ht(e);for(e of mt)ht(e);mt=[],yt=[],gt=[],H=!0}x(0,new ut(t))}function pt(t){if(m)return ft(1,0,t);vt(t)}var vt=t=>{if(z=t,m)throw pt(t),"unwind";dt(t)},mt=[],yt=[],wt=[],gt={},bt=t=>{var e=t.Ab;delete gt[e],mt.push(t),yt.splice(yt.indexOf(t),1),t.Ab=0,$i(e)};function _t(){wt.forEach((t=>t()))}var kt=t=>new Promise((e=>{t.onmessage=n=>{var i=(n=n.data).cmd;if(n.targetThread&&n.targetThread!=wi()){var r=gt[n.targetThread];r?r.postMessage(n,n.transferList):C(`Internal error! Worker sent a message "${i}" to target pthread ${n.targetThread}, but that thread no longer exists!`)}else"checkMailbox"===i?Re():"spawnThread"===i?lt(n):"cleanupThread"===i?bt(gt[n.thread]):"killThread"===i?(n=n.thread,i=gt[n],delete gt[n],ht(i),$i(n),yt.splice(yt.indexOf(i),1),i.Ab=0):"cancelThread"===i?gt[n.thread].postMessage({cmd:"cancel"}):"loaded"===i?(t.loaded=!0,e(t)):"alert"===i?alert(`Thread ${n.threadId}: ${n.text}`):"setimmediate"===n.target?t.postMessage(n):"callHandler"===i?f[n.handler](...n.args):i&&C(`worker sent an unknown command ${i}`)},t.onerror=t=>{throw C(`worker sent an error! ${t.filename}:${t.lineno}: ${t.message}`),t};var n,i=[];for(n of[])f.hasOwnProperty(n)&&i.push(n);t.postMessage({cmd:"load",handlers:i,wasmMemory:I,wasmModule:T})}));function $t(){var t=new Worker(new URL("undefined"==typeof document?require("url").pathToFileURL(__filename).href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("yunjing-for-cesium-cjs.js",document.baseURI).href),{type:"module",workerData:"em-pthread",name:"em-pthread"});mt.push(t)}var St=t=>{for(;0<t.length;)t.shift()(f)},Et=()=>{var t=wi(),e=a()[t+52>>>2>>>0];t=a()[t+56>>>2>>>0],Mi(e,e-t),Ci(e)},Mt=(t,e)=>{ct=0,t=Ii(t,e),0<ct?z=t:Si(t)};class Ct{constructor(t){this.Ib=t-24}}function At(t,e,n){var i=new Ct(t>>>=0);throw e>>>=0,n>>>=0,a()[i.Ib+16>>>2>>>0]=0,a()[i.Ib+4>>>2>>>0]=e,a()[i.Ib+8>>>2>>>0]=n,t}function Ot(t,e,n,i){return m?ft(2,1,t,e,n,i):It(t,e,n,i)}function It(t,e,n,i){if(t>>>=0,e>>>=0,n>>>=0,i>>>=0,void 0===y)return C("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;var r=[];return m&&0===r.length?Ot(t,e,n,i):(t={cc:n,Ab:t,Pb:i,ic:r},m?(t.Lb="spawnThread",postMessage(t,r),0):lt(t))}var Tt=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0,zt=(t,e,n)=>{var i=(e>>>=0)+n;for(n=e;t[n]&&!(n>=i);)++n;if(16<n-e&&t.buffer&&Tt)return Tt.decode(t.buffer instanceof y?t.slice(e,n):t.subarray(e,n));for(i="";e<n;){var r=t[e++];if(128&r){var o=63&t[e++];if(192==(224&r))i+=String.fromCharCode((31&r)<<6|o);else{var s=63&t[e++];65536>(r=224==(240&r)?(15&r)<<12|o<<6|s:(7&r)<<18|o<<12|s<<6|63&t[e++])?i+=String.fromCharCode(r):(r-=65536,i+=String.fromCharCode(55296|r>>10,56320|1023&r))}}else i+=String.fromCharCode(r)}return i},Rt=(t,e)=>(t>>>=0)?zt(i(),t,e):"";function Ft(t,e,n){return m?ft(3,1,t,e,n):0}function Dt(t,e){if(m)return ft(4,1,t,e)}var Pt=t=>{for(var e=0,n=0;n<t.length;++n){var i=t.charCodeAt(n);127>=i?e++:2047>=i?e+=2:55296<=i&&57343>=i?(e+=4,++n):e+=3}return e},Nt=(t,e,n,i)=>{if(!(0<i))return 0;var r=n>>>=0;i=n+i-1;for(var o=0;o<t.length;++o){var s=t.charCodeAt(o);if(55296<=s&&57343>=s&&(s=65536+((1023&s)<<10)|1023&t.charCodeAt(++o)),127>=s){if(n>=i)break;e[n++>>>0]=s}else{if(2047>=s){if(n+1>=i)break;e[n++>>>0]=192|s>>6}else{if(65535>=s){if(n+2>=i)break;e[n++>>>0]=224|s>>12}else{if(n+3>=i)break;e[n++>>>0]=240|s>>18,e[n++>>>0]=128|s>>12&63}e[n++>>>0]=128|s>>6&63}e[n++>>>0]=128|63&s}}return e[n>>>0]=0,n-r},Ut=(t,e,n)=>Nt(t,i(),e,n);function qt(t,e){if(m)return ft(5,1,t,e)}function jt(t,e,n){if(m)return ft(6,1,t,e,n)}function Lt(t,e,n){return m?ft(7,1,t,e,n):0}function Bt(t,e){if(m)return ft(8,1,t,e)}function Ht(t,e,n){if(m)return ft(9,1,t,e,n)}function Wt(t,e,n,i){if(m)return ft(10,1,t,e,n,i)}function Vt(t,e,n,i){if(m)return ft(11,1,t,e,n,i)}function Gt(t,e,n,i){if(m)return ft(12,1,t,e,n,i)}function Yt(t){if(m)return ft(13,1,t)}function Kt(t,e){if(m)return ft(14,1,t,e)}function Xt(t,e,n){if(m)return ft(15,1,t,e,n)}var Qt,Zt,Jt=()=>{Z("")},te=t=>{for(var e="";i()[t>>>0];)e+=Qt[i()[t++>>>0]];return e},ee={},ne={};function ie(t,e,n={}){if(!("argPackAdvance"in e))throw new TypeError("registerType registeredInstance requires argPackAdvance");return function(t,e,n={}){var i=e.name;if(!t)throw new Zt(`type "${i}" must have a positive integer typeid pointer`);if(ne.hasOwnProperty(t)){if(n.Rb)return;throw new Zt(`Cannot register type '${i}' twice`)}ne[t]=e,ee.hasOwnProperty(t)&&(e=ee[t],delete ee[t],e.forEach((t=>t())))}(t,e,n)}var re=(t,e,u)=>{switch(e){case 1:return u?t=>n()[t>>>0]:t=>i()[t>>>0];case 2:return u?t=>r()[t>>>1>>>0]:t=>o()[t>>>1>>>0];case 4:return u?t=>s()[t>>>2>>>0]:t=>a()[t>>>2>>>0];case 8:return u?t=>j[t>>>3]:t=>L[t>>>3];default:throw new TypeError(`invalid integer width (${e}): ${t}`)}};function oe(t,e,n){n>>>=0,ie(t>>>=0,{name:e=te(e>>>0),fromWireType:t=>t,toWireType:function(t,e){if("bigint"!=typeof e&&"number"!=typeof e)throw e=null===e?"null":"object"==(t=typeof e)||"array"===t||"function"===t?e.toString():""+e,new TypeError(`Cannot convert "${e}" to ${this.name}`);return"number"==typeof e&&(e=BigInt(e)),e},argPackAdvance:se,readValueFromPointer:re(e,n,-1==e.indexOf("u")),Db:null})}var se=8;function ae(t,e,n,r){ie(t>>>=0,{name:e=te(e>>>0),fromWireType:function(t){return!!t},toWireType:function(t,e){return e?n:r},argPackAdvance:se,readValueFromPointer:function(t){return this.fromWireType(i()[t>>>0])},Db:null})}var ue=[],he=[];function le(t){9<(t>>>=0)&&0==--he[t+1]&&(he[t]=void 0,ue.push(t))}var ce=t=>{if(!t)throw new Zt("Cannot use deleted val. handle = "+t);return he[t]},fe=t=>{switch(t){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:let e=ue.pop()||he.length;return he[e]=t,he[e+1]=1,e}};function de(t){return this.fromWireType(a()[t>>>2>>>0])}var pe={name:"emscripten::val",fromWireType:t=>{var e=ce(t);return le(t),e},toWireType:(t,e)=>fe(e),argPackAdvance:se,readValueFromPointer:de,Db:null};function ve(t){return ie(t>>>0,pe)}var me=(t,e)=>{switch(e){case 4:return function(t){return this.fromWireType(u()[t>>>2>>>0])};case 8:return function(t){return this.fromWireType(h()[t>>>3>>>0])};default:throw new TypeError(`invalid float width (${e}): ${t}`)}};function ye(t,e,n){n>>>=0,ie(t>>>=0,{name:e=te(e>>>0),fromWireType:t=>t,toWireType:(t,e)=>e,argPackAdvance:se,readValueFromPointer:me(e,n),Db:null})}function we(t,e,n,i,r){if(t>>>=0,n>>>=0,e=te(e>>>0),-1===r&&(r=4294967295),r=t=>t,0===i){var o=32-8*n;r=t=>t<<o>>>o}var s=e.includes("unsigned")?function(t,e){return e>>>0}:function(t,e){return e};ie(t,{name:e,fromWireType:r,toWireType:s,argPackAdvance:se,readValueFromPointer:re(e,n,0!==i),Db:null})}function ge(t,e,i){function r(t){var e=a()[t>>>2>>>0];return t=a()[t+4>>>2>>>0],new o(n().buffer,t,e)}var o=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][e];ie(t>>>=0,{name:i=te(i>>>0),fromWireType:r,argPackAdvance:se,readValueFromPointer:r},{Rb:!0})}function be(t,e){t>>>=0;var n="std::string"===(e=te(e>>>0));ie(t,{name:e,fromWireType:function(t){var e=a()[t>>>2>>>0],r=t+4;if(n)for(var o=r,s=0;s<=e;++s){var u=r+s;if(s==e||0==i()[u>>>0]){if(o=Rt(o,u-o),void 0===h)var h=o;else h+=String.fromCharCode(0),h+=o;o=u+1}}else{for(h=Array(e),s=0;s<e;++s)h[s]=String.fromCharCode(i()[r+s>>>0]);h=h.join("")}return bi(t),h},toWireType:function(t,e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var r="string"==typeof e;if(!(r||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int8Array))throw new Zt("Cannot pass non-string to std::string");var o=n&&r?Pt(e):e.length,s=gi(4+o+1),u=s+4;if(a()[s>>>2>>>0]=o,n&&r)Ut(e,u,o+1);else if(r)for(r=0;r<o;++r){var h=e.charCodeAt(r);if(255<h)throw bi(u),new Zt("String has UTF-16 code units that do not fit in 8 bits");i()[u+r>>>0]=h}else for(r=0;r<o;++r)i()[u+r>>>0]=e[r];return null!==t&&t.push(bi,s),s},argPackAdvance:se,readValueFromPointer:de,Db(t){bi(t)}})}var _e=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,xe=(t,e)=>{for(var n=t>>1,s=n+e/2;!(n>=s)&&o()[n>>>0];)++n;if(32<(n<<=1)-t&&_e)return _e.decode(i().slice(t,n));for(n="",s=0;!(s>=e/2);++s){var a=r()[t+2*s>>>1>>>0];if(0==a)break;n+=String.fromCharCode(a)}return n},ke=(t,e,n)=>{if(n??=2147483647,2>n)return 0;var i=e;n=(n-=2)<2*t.length?n/2:t.length;for(var o=0;o<n;++o){var s=t.charCodeAt(o);r()[e>>>1>>>0]=s,e+=2}return r()[e>>>1>>>0]=0,e-i},$e=t=>2*t.length,Se=(t,e)=>{for(var n=0,i="";!(n>=e/4);){var r=s()[t+4*n>>>2>>>0];if(0==r)break;++n,65536<=r?(r-=65536,i+=String.fromCharCode(55296|r>>10,56320|1023&r)):i+=String.fromCharCode(r)}return i},Ee=(t,e,n)=>{if(e>>>=0,n??=2147483647,4>n)return 0;var i=e;n=i+n-4;for(var r=0;r<t.length;++r){var o=t.charCodeAt(r);if(55296<=o&&57343>=o&&(o=65536+((1023&o)<<10)|1023&t.charCodeAt(++r)),s()[e>>>2>>>0]=o,(e+=4)+4>n)break}return s()[e>>>2>>>0]=0,e-i},Me=t=>{for(var e=0,n=0;n<t.length;++n){var i=t.charCodeAt(n);55296<=i&&57343>=i&&++n,e+=4}return e};function Ce(t,e,n){if(t>>>=0,e>>>=0,n=te(n>>>=0),2===e)var i=xe,r=ke,s=$e,u=t=>o()[t>>>1>>>0];else 4===e&&(i=Se,r=Ee,s=Me,u=t=>a()[t>>>2>>>0]);ie(t,{name:n,fromWireType:t=>{for(var n,r=a()[t>>>2>>>0],o=t+4,s=0;s<=r;++s){var h=t+4+s*e;s!=r&&0!=u(h)||(o=i(o,h-o),void 0===n?n=o:(n+=String.fromCharCode(0),n+=o),o=h+e)}return bi(t),n},toWireType:(t,i)=>{if("string"!=typeof i)throw new Zt(`Cannot pass non-string to C++ string type ${n}`);var o=s(i),u=gi(4+o+e);return a()[u>>>2>>>0]=o/e,r(i,u+4,o+e),null!==t&&t.push(bi,u),u},argPackAdvance:se,readValueFromPointer:de,Db(t){bi(t)}})}function Ae(t,e){ie(t>>>=0,{Sb:!0,name:e=te(e>>>0),argPackAdvance:0,fromWireType:()=>{},toWireType:()=>{}})}var Oe=()=>1;function Ie(t){_i(t>>>0,!v,1,!p,131072,!1),_t()}var Te=t=>{if(!H)try{if(t(),!(0<ct))try{m?Si(z):vt(z)}catch(t){t instanceof ut||"unwind"==t||x(0,t)}}catch(t){t instanceof ut||"unwind"==t||x(0,t)}};function ze(t){t>>>=0,"function"==typeof Atomics.jc&&(Atomics.jc(s(),t>>>2,t).value.then(Re),t+=128,Atomics.store(s(),t>>>2,1))}var Re=()=>{var t=wi();t&&(ze(t),Te(Ei))};function Fe(t,e){(t>>>=0)==e>>>0?setTimeout(Re):m?postMessage({targetThread:t,cmd:"checkMailbox"}):(t=gt[t])&&t.postMessage({cmd:"checkMailbox"})}var De=[];function Pe(t,e,n,i,r){for(e>>>=0,i/=2,De.length=i,n=r>>>0>>>3,r=0;r<i;r++)De[r]=j[n+2*r]?j[n+2*r+1]:h()[n+2*r+1>>>0];return(e?ot[e]:di[t])(...De)}function Ne(t){t>>>=0,m?postMessage({cmd:"cleanupThread",thread:t}):bt(gt[t])}function Ue(t){}var qe=(t,e)=>{var n=ne[t];if(void 0===n)throw t=vi(t),n=te(t),bi(t),new Zt(`${e} has unknown type ${n}`);return n},je=(t,e,n)=>{var i=[];return t=t.toWireType(i,n),i.length&&(a()[e>>>2>>>0]=fe(i)),t};function Le(t,e,n){return e>>>=0,n>>>=0,t=ce(t>>>0),e=qe(e,"emval::as"),je(e,n,t)}var Be=t=>{try{t()}catch(t){Z(t)}},He=0,We=null,Ve=0,Ge=[],Ye={},Ke={},Xe=0,Qe=null,Ze=[];function Je(t){return function(){if(!H){if(0===He){var e=!1,n=!1;t().then(((t=0)=>{if(!H&&(Ve=t,e=!0,n)){He=2,Be((()=>Ri(We))),typeof Browser<"u"&&Browser.Jb.Qb&&Browser.Jb.resume(),t=!1;try{var i=(a=s()[We+8>>>2>>>0],a=pi[Ke[a]],--ct,a())}catch(a){i=a,t=!0}var r=!1;if(!We){var o=Qe;o&&(Qe=null,(t?o.reject:o.resolve)(i),r=!0)}if(t&&!r)throw i}var a})),n=!0,e||(He=1,We=function(){var t=gi(65548),e=t+12;a()[t>>>2>>>0]=e,a()[t+4>>>2>>>0]=e+65536,e=Ge[0];var n=Ye[e];return void 0===n&&(n=Xe++,Ye[e]=n,Ke[n]=e),e=n,s()[t+8>>>2>>>0]=e,t}(),typeof Browser<"u"&&Browser.Jb.Qb&&Browser.Jb.pause(),Be((()=>Ti(We))))}else 2===He?(He=0,Be(Fi),bi(We),We=null,Ze.forEach(Te)):Z(`invalid state: ${He}`);return Ve}}()}function tn(t){return t>>>=0,Je((()=>(t=ce(t)).then(fe)))}var en=[];function nn(t,e,n,i){return n>>>=0,i>>>=0,(t=en[t>>>0])(null,e=ce(e>>>0),n,i)}var rn={},on=t=>{var e=rn[t];return void 0===e?te(t):e};function sn(t,e,n,i,r){return n>>>=0,i>>>=0,r>>>=0,(t=en[t>>>0])(e=ce(e>>>0),e[n=on(n)],i,r)}var an=()=>"object"==typeof globalThis?globalThis:Function("","return this")();function un(t){return 0==(t>>>=0)?fe(an()):(t=on(t),fe(an()[t]))}var hn=t=>{var e=en.length;return en.push(t),e},ln=(t,e)=>{for(var n=Array(t),i=0;i<t;++i)n[i]=qe(a()[e+4*i>>>2>>>0],"parameter "+i);return n},cn=(t,e)=>Object.defineProperty(e,"name",{value:t});function fn(t,e,n){var i=(e=ln(t,e>>>0)).shift();t--;var r="return function (obj, func, destructorsRef, args) {\n",o=0,s=[];0===n&&s.push("obj");for(var a=["retType"],u=[i],h=0;h<t;++h)s.push("arg"+h),a.push("argType"+h),u.push(e[h]),r+=`  var arg${h} = argType${h}.readValueFromPointer(args${o?"+"+o:""});\n`,o+=e[h].argPackAdvance;return r+=`  var rv = ${1===n?"new func":"func.call"}(${s.join(", ")});\n`,i.Sb||(a.push("emval_returnValue"),u.push(je),r+="  return emval_returnValue(retType, destructorsRef, rv);\n"),a.push(r+"};\n"),t=function(t){var e=Function;if(!(e instanceof Function))throw new TypeError(`new_ called with constructor type ${typeof e} which is not a function`);var n=cn(e.name||"unknownFunctionName",(function(){}));return n.prototype=e.prototype,n=new n,(t=e.apply(n,t))instanceof Object?t:n}(a)(...u),n=`methodCaller<(${e.map((t=>t.name)).join(", ")}) => ${i.name}>`,hn(cn(n,t))}function dn(t){return t=on(t>>>0),fe(f[t])}function pn(t,e){return e>>>=0,t=ce(t>>>0),e=ce(e),fe(t[e])}function vn(t){9<(t>>>=0)&&(he[t+1]+=1)}function mn(){return fe([])}function yn(t){t=ce(t>>>0);for(var e=Array(t.length),n=0;n<t.length;n++)e[n]=t[n];return fe(e)}function wn(t){return fe(on(t>>>0))}function gn(){return fe({})}function bn(t){for(var e=ce(t>>>=0);e.length;){var n=e.pop();e.pop()(n)}le(t)}function _n(t,e,n){e>>>=0,n>>>=0,t=ce(t>>>0),e=ce(e),n=ce(n),t[e]=n}function xn(t,e){return e>>>=0,t=(t=qe(t>>>0,"_emval_take_value")).readValueFromPointer(e),fe(t)}function kn(t,e){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t),e>>>=0,t=new Date(1e3*t),s()[e>>>2>>>0]=t.getUTCSeconds(),s()[e+4>>>2>>>0]=t.getUTCMinutes(),s()[e+8>>>2>>>0]=t.getUTCHours(),s()[e+12>>>2>>>0]=t.getUTCDate(),s()[e+16>>>2>>>0]=t.getUTCMonth(),s()[e+20>>>2>>>0]=t.getUTCFullYear()-1900,s()[e+24>>>2>>>0]=t.getUTCDay(),t=(t.getTime()-Date.UTC(t.getUTCFullYear(),0,1,0,0,0,0))/864e5|0,s()[e+28>>>2>>>0]=t}var $n=t=>t%4==0&&(t%100!=0||t%400==0),Sn=[0,31,60,91,121,152,182,213,244,274,305,335],En=[0,31,59,90,120,151,181,212,243,273,304,334];function Mn(t,e){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t),e>>>=0,t=new Date(1e3*t),s()[e>>>2>>>0]=t.getSeconds(),s()[e+4>>>2>>>0]=t.getMinutes(),s()[e+8>>>2>>>0]=t.getHours(),s()[e+12>>>2>>>0]=t.getDate(),s()[e+16>>>2>>>0]=t.getMonth(),s()[e+20>>>2>>>0]=t.getFullYear()-1900,s()[e+24>>>2>>>0]=t.getDay();var n=($n(t.getFullYear())?Sn:En)[t.getMonth()]+t.getDate()-1|0;s()[e+28>>>2>>>0]=n,s()[e+36>>>2>>>0]=-60*t.getTimezoneOffset(),n=new Date(t.getFullYear(),6,1).getTimezoneOffset();var i=new Date(t.getFullYear(),0,1).getTimezoneOffset();t=0|(n!=i&&t.getTimezoneOffset()==Math.min(i,n)),s()[e+32>>>2>>>0]=t}function Cn(t){t>>>=0;var e=new Date(s()[t+20>>>2>>>0]+1900,s()[t+16>>>2>>>0],s()[t+12>>>2>>>0],s()[t+8>>>2>>>0],s()[t+4>>>2>>>0],s()[t>>>2>>>0],0),n=s()[t+32>>>2>>>0],i=e.getTimezoneOffset(),r=new Date(e.getFullYear(),6,1).getTimezoneOffset(),o=new Date(e.getFullYear(),0,1).getTimezoneOffset(),a=Math.min(o,r);return 0>n?s()[t+32>>>2>>>0]=+(r!=o&&a==i):0<n!=(a==i)&&(r=Math.max(o,r),e.setTime(e.getTime()+6e4*((0<n?a:r)-i))),s()[t+24>>>2>>>0]=e.getDay(),n=($n(e.getFullYear())?Sn:En)[e.getMonth()]+e.getDate()-1|0,s()[t+28>>>2>>>0]=n,s()[t>>>2>>>0]=e.getSeconds(),s()[t+4>>>2>>>0]=e.getMinutes(),s()[t+8>>>2>>>0]=e.getHours(),s()[t+12>>>2>>>0]=e.getDate(),s()[t+16>>>2>>>0]=e.getMonth(),s()[t+20>>>2>>>0]=e.getYear(),t=e.getTime(),BigInt(isNaN(t)?-1:t/1e3)}function An(t,e,n,i,r,o,s){return m?ft(16,1,t,e,n,i,r,o,s):-52}function On(t,e,n,i,r,o){if(m)return ft(17,1,t,e,n,i,r,o)}function In(t,e,n,i){t>>>=0,e>>>=0,n>>>=0,i>>>=0;var r=(new Date).getFullYear(),o=new Date(r,0,1),u=new Date(r,6,1);r=o.getTimezoneOffset();var h=u.getTimezoneOffset(),l=Math.max(r,h);a()[t>>>2>>>0]=60*l,s()[e>>>2>>>0]=+(r!=h),o=(t=t=>t.toLocaleTimeString(void 0,{hour12:!1,timeZoneName:"short"}).split(" ")[1])(o),u=t(u),h<r?(Ut(o,n,17),Ut(u,i,17)):(Ut(o,i,17),Ut(u,n,17))}var Tn=[],zn=(t,e)=>{Tn.length=0;for(var n;n=i()[t++>>>0];){var r=105!=n;e+=(r&=112!=n)&&e%8?4:0,Tn.push(112==n?a()[e>>>2>>>0]:106==n?j[e>>>3]:105==n?s()[e>>>2>>>0]:h()[e>>>3>>>0]),e+=r?8:4}return Tn};function Rn(t,e,n){return t>>>=0,e=zn(e>>>0,n>>>0),ot[t](...e)}function Fn(t,e,n){return t>>>=0,e=zn(e>>>0,n>>>0),ot[t](...e)}var Dn=()=>{},Pn=()=>Date.now();function Nn(t,e){return C(Rt(t>>>0,e>>>0))}var Un,qn=()=>{throw ct+=1,"unwind"};function jn(){return 4294901760}Un=()=>performance.timeOrigin+performance.now();var Ln=()=>navigator.hardwareConcurrency;function Bn(){return Z("Cannot use emscripten_pc_get_function without -sUSE_OFFSET_CONVERTER"),0}function Hn(t){t>>>=0;var e=i().length;if(t<=e||4294901760<t)return!1;for(var n=1;4>=n;n*=2){var r=e*(1+.2/n);r=Math.min(r,t+100663296);var o=Math;r=Math.max(t,r);t:{o=(o.min.call(o,4294901760,r+(65536-r%65536)%65536)-I.buffer.byteLength+65535)/65536;try{I.grow(o),W();var s=1;break t}catch{}s=void 0}if(s)return!0}return!1}var Wn=()=>(Z("Cannot use convertFrameToPC (needed by __builtin_return_address) without -sUSE_OFFSET_CONVERTER"),0),Vn={},Gn=t=>{t.forEach((t=>{Wn()}))};function Yn(){var t=Error().stack.toString().split("\n");return"Error"==t[0]&&t.shift(),Gn(t),Vn.Ob=Wn(),Vn.ac=t,Vn.Ob}function Kn(t,e,n){if(t>>>=0,e>>>=0,Vn.Ob==t)var i=Vn.ac;else"Error"==(i=Error().stack.toString().split("\n"))[0]&&i.shift(),Gn(i);for(var r=3;i[r]&&Wn()!=t;)++r;for(t=0;t<n&&i[t+r];++t)s()[e+4*t>>>2>>>0]=Wn();return t}var Xn,Qn={},Zn=()=>{if(!Xn){var t,e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",it:"./this.program"};for(t in Qn)void 0===Qn[t]?delete e[t]:e[t]=Qn[t];var n=[];for(t in e)n.push(`${t}=${e[t]}`);Xn=n}return Xn};function Jn(t,e){if(m)return ft(18,1,t,e);t>>>=0,e>>>=0;var i=0;return Zn().forEach(((r,o)=>{var s=e+i;for(o=a()[t+4*o>>>2>>>0]=s,s=0;s<r.length;++s)n()[o++>>>0]=r.charCodeAt(s);n()[o>>>0]=0,i+=r.length+1})),0}function ti(t,e){if(m)return ft(19,1,t,e);t>>>=0,e>>>=0;var n=Zn();a()[t>>>2>>>0]=n.length;var i=0;return n.forEach((t=>i+=t.length+1)),a()[e>>>2>>>0]=i,0}function ei(t){return m?ft(20,1,t):52}function ni(t,e,n,i){return m?ft(21,1,t,e,n,i):52}function ii(t,e,n,i){return m?ft(22,1,t,e,n,i):70}var ri=[null,[],[]];function oi(t,e,n,r){if(m)return ft(23,1,t,e,n,r);e>>>=0,n>>>=0,r>>>=0;for(var o=0,s=0;s<n;s++){var u=a()[e>>>2>>>0],h=a()[e+4>>>2>>>0];e+=8;for(var l=0;l<h;l++){var c=i()[u+l>>>0],f=ri[t];0===c||10===c?((1===t?M:C)(zt(f,0)),f.length=0):f.push(c)}o+=h}return a()[r>>>2>>>0]=o,0}var si=[31,29,31,30,31,30,31,31,30,31,30,31],ai=[31,28,31,30,31,30,31,31,30,31,30,31],ui=(t,e)=>{n().set(t,e>>>0)};function hi(t,e,n,i){function r(t,e,n){for(t="number"==typeof t?t.toString():t||"";t.length<e;)t=n[0]+t;return t}function o(t,e){return r(t,e,"0")}function u(t,e){function n(t){return 0>t?-1:0<t?1:0}var i;return 0===(i=n(t.getFullYear()-e.getFullYear()))&&0===(i=n(t.getMonth()-e.getMonth()))&&(i=n(t.getDate()-e.getDate())),i}function h(t){switch(t.getDay()){case 0:return new Date(t.getFullYear()-1,11,29);case 1:return t;case 2:return new Date(t.getFullYear(),0,3);case 3:return new Date(t.getFullYear(),0,2);case 4:return new Date(t.getFullYear(),0,1);case 5:return new Date(t.getFullYear()-1,11,31);case 6:return new Date(t.getFullYear()-1,11,30)}}function l(t){var e=t.Bb;for(t=new Date(new Date(t.Cb+1900,0,1).getTime());0<e;){var n=t.getMonth(),i=($n(t.getFullYear())?si:ai)[n];if(!(e>i-t.getDate())){t.setDate(t.getDate()+e);break}e-=i-t.getDate()+1,t.setDate(1),11>n?t.setMonth(n+1):(t.setMonth(0),t.setFullYear(t.getFullYear()+1))}return n=new Date(t.getFullYear()+1,0,4),e=h(new Date(t.getFullYear(),0,4)),n=h(n),0>=u(e,t)?0>=u(n,t)?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}t>>>=0,e>>>=0,n>>>=0,i>>>=0;var c=a()[i+40>>>2>>>0];for(var f in i={fc:s()[i>>>2>>>0],ec:s()[i+4>>>2>>>0],Gb:s()[i+8>>>2>>>0],Kb:s()[i+12>>>2>>>0],Hb:s()[i+16>>>2>>>0],Cb:s()[i+20>>>2>>>0],ub:s()[i+24>>>2>>>0],Bb:s()[i+28>>>2>>>0],nc:s()[i+32>>>2>>>0],dc:s()[i+36>>>2>>>0],hc:c?Rt(c):""},n=Rt(n),c={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"})n=n.replace(new RegExp(f,"g"),c[f]);var d,p,v="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),m="January February March April May June July August September October November December".split(" ");for(f in c={"%a":t=>v[t.ub].substring(0,3),"%A":t=>v[t.ub],"%b":t=>m[t.Hb].substring(0,3),"%B":t=>m[t.Hb],"%C":t=>o((t.Cb+1900)/100|0,2),"%d":t=>o(t.Kb,2),"%e":t=>r(t.Kb,2," "),"%g":t=>l(t).toString().substring(2),"%G":l,"%H":t=>o(t.Gb,2),"%I":t=>(0==(t=t.Gb)?t=12:12<t&&(t-=12),o(t,2)),"%j":t=>{for(var e=0,n=0;n<=t.Hb-1;e+=($n(t.Cb+1900)?si:ai)[n++]);return o(t.Kb+e,3)},"%m":t=>o(t.Hb+1,2),"%M":t=>o(t.ec,2),"%n":()=>"\n","%p":t=>0<=t.Gb&&12>t.Gb?"AM":"PM","%S":t=>o(t.fc,2),"%t":()=>"\t","%u":t=>t.ub||7,"%U":t=>o(Math.floor((t.Bb+7-t.ub)/7),2),"%V":t=>{var e=Math.floor((t.Bb+7-(t.ub+6)%7)/7);if(2>=(t.ub+371-t.Bb-2)%7&&e++,e)53==e&&(4==(n=(t.ub+371-t.Bb)%7)||3==n&&$n(t.Cb)||(e=1));else{e=52;var n=(t.ub+7-t.Bb-1)%7;(4==n||5==n&&$n(t.Cb%400-1))&&e++}return o(e,2)},"%w":t=>t.ub,"%W":t=>o(Math.floor((t.Bb+7-(t.ub+6)%7)/7),2),"%y":t=>(t.Cb+1900).toString().substring(2),"%Y":t=>t.Cb+1900,"%z":t=>(0<=(t=t.dc)?"+":"-")+("0000"+((t=Math.abs(t)/60)/60*100+t%60)).slice(-4),"%Z":t=>t.hc,"%%":()=>"%"},n=n.replace(/%%/g,"\0\0"),c)n.includes(f)&&(n=n.replace(new RegExp(f,"g"),c[f](i)));return d=n=n.replace(/\0\0/g,"%"),p=Array(Pt(d)+1),Nt(d,p,0,p.length),(f=p).length>e?0:(ui(f,t),f.length-1)}function li(t,e,n,i){return hi(t>>>0,e>>>0,n>>>0,i>>>0)}m||function(){for(var t=f.numThreads-1;t--;)$t();V.unshift((()=>{var t;K++,t=()=>Q(),m?t():Promise.all(mt.map(kt)).then(t)}))}();for(var ci=Array(256),fi=0;256>fi;++fi)ci[fi]=String.fromCharCode(fi);Qt=ci,Zt=f.BindingError=class extends Error{constructor(t){super(t),this.name="BindingError"}},f.InternalError=class extends Error{constructor(t){super(t),this.name="InternalError"}},he.push(0,1,void 0,1,null,1,!0,1,!1,1),f.count_emval_handles=()=>he.length/2-5-ue.length;var di=[dt,pt,Ot,Ft,Dt,qt,jt,Lt,Bt,Ht,Wt,Vt,Gt,Yt,Kt,Xt,An,On,Jn,ti,ei,ni,ii,oi],pi=function(){function t(t,e){return pi=t.exports,pi=function(){var t=pi,e={};for(let[n,i]of Object.entries(t))e[n]="function"==typeof i?(...t)=>{Ge.push(n);try{return i(...t)}finally{H||(Ge.pop(),We&&1===He&&0===Ge.length&&(He=0,ct+=1,Be(zi),typeof Fibers<"u"&&Fibers.oc()))}}:i;return e}(),pi=function(){var t=pi,e=t=>e=>t(e)>>>0,n=t=>()=>t()>>>0;return(t=Object.assign({},t)).Ca=e(t.Ca),t.fb=n(t.fb),t.gb=e(t.gb),t.emscripten_main_runtime_thread_id=n(t.emscripten_main_runtime_thread_id),t.sb=e(t.sb),t.tb=n(t.tb),t}(),wt.push(pi.ib),G.unshift(pi.Ba),T=e,Q(),pi}var n=rt();if(K++,f.instantiateWasm)try{return f.instantiateWasm(n,t)}catch(t){C(`Module.instantiateWasm callback failed with error: ${t}`),c(t)}return J||=f.locateFile?tt("ort-wasm-simd-threaded.jsep.wasm")?"ort-wasm-simd-threaded.jsep.wasm":f.locateFile?f.locateFile("ort-wasm-simd-threaded.jsep.wasm",k):k+"ort-wasm-simd-threaded.jsep.wasm":new URL("ort-wasm-simd-threaded.jsep.wasm","undefined"==typeof document?require("url").pathToFileURL(__filename).href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("yunjing-for-cesium-cjs.js",document.baseURI).href).href,function(t,e){var n=J;return $||"function"!=typeof WebAssembly.instantiateStreaming||tt(n)||et(n)||"function"!=typeof fetch?it(n,t,e):fetch(n,{credentials:"same-origin"}).then((i=>WebAssembly.instantiateStreaming(i,t).then(e,(function(i){return C(`wasm streaming compile failed: ${i}`),C("falling back to ArrayBuffer instantiation"),it(n,t,e)}))))}(n,(function(e){t(e.instance,e.module)})).catch(c),{}}(),vi=t=>(vi=pi.Ca)(t),mi=()=>(mi=pi.Da)();f.rt=(t,e)=>(f.rt=pi.Ea)(t,e),f.ot=(t,e)=>(f.ot=pi.Fa)(t,e),f.st=(t,e,n,i,r,o,s,a,u,h)=>(f.st=pi.Ga)(t,e,n,i,r,o,s,a,u,h),f.ut=(t,e)=>(f.ut=pi.Ha)(t,e),f.ht=(t,e,n)=>(f.ht=pi.Ia)(t,e,n),f.ct=(t,e,n)=>(f.ct=pi.Ja)(t,e,n),f.ft=t=>(f.ft=pi.Ka)(t),f._=(t,e,n)=>(f._=pi.La)(t,e,n),f.dt=t=>(f.dt=pi.Ma)(t),f.vt=(t,e,n)=>(f.vt=pi.Na)(t,e,n),f.yt=(t,e)=>(f.yt=pi.Oa)(t,e),f.wt=(t,e)=>(f.wt=pi.Pa)(t,e),f.bt=t=>(f.bt=pi.Qa)(t),f._t=(t,e,n,i,r,o)=>(f._t=pi.Ra)(t,e,n,i,r,o),f.xt=(t,e,n,i,r)=>(f.xt=pi.Sa)(t,e,n,i,r),f.kt=t=>(f.kt=pi.Ta)(t),f.$t=(t,e,n,i)=>(f.$t=pi.Ua)(t,e,n,i),f.St=(t,e,n)=>(f.St=pi.Va)(t,e,n),f.Et=t=>(f.Et=pi.Wa)(t),f.Mt=t=>(f.Mt=pi.Xa)(t),f.nt=(t,e,n)=>(f.nt=pi.Ya)(t,e,n),f.Ct=(t,e,n,i)=>(f.Ct=pi.Za)(t,e,n,i),f.At=t=>(f.At=pi.Ot)(t),f.It=t=>(f.It=pi.$a)(t),f.et=(t,e,n,i,r)=>(f.et=pi.ab)(t,e,n,i,r),f.tt=(t,e,n,i,r,o,s,a)=>(f.tt=pi.bb)(t,e,n,i,r,o,s,a),f.Tt=t=>(f.Tt=pi.cb)(t),f.zt=(t,e,n)=>(f.zt=pi.db)(t,e,n),f.Rt=t=>(f.Rt=pi.eb)(t);var yi,wi=()=>(wi=pi.fb)(),gi=f.Ft=t=>(gi=f.Ft=pi.gb)(t),bi=f.Dt=t=>(bi=f.Dt=pi.hb)(t),_i=(t,e,n,i,r,o)=>(_i=pi.kb)(t,e,n,i,r,o),xi=()=>(xi=pi.lb)(),ki=(t,e,n,i,r)=>(ki=pi.mb)(t,e,n,i,r),$i=t=>($i=pi.nb)(t),Si=t=>(Si=pi.ob)(t),Ei=()=>(Ei=pi.pb)(),Mi=(t,e)=>(Mi=pi.qb)(t,e),Ci=t=>(Ci=pi.rb)(t),Ai=t=>(Ai=pi.sb)(t),Oi=()=>(Oi=pi.tb)(),Ii=f.dynCall_ii=(t,e)=>(Ii=f.dynCall_ii=pi.vb)(t,e),Ti=t=>(Ti=pi.wb)(t),zi=()=>(zi=pi.xb)(),Ri=t=>(Ri=pi.yb)(t),Fi=()=>(Fi=pi.zb)();function Di(){0<K||(m?(l(f),m||St(G),startWorker(f)):(St(V),0<K||yi||(yi=!0,f.calledRun=!0,H||(m||St(G),l(f),m||St(Y)))))}return f.Pt=862621,f.Nt=862843,f.stackSave=()=>Oi(),f.stackRestore=t=>Ci(t),f.stackAlloc=t=>Ai(t),f.UTF8ToString=Rt,f.stringToUTF8=Ut,f.lengthBytesUTF8=Pt,X=function t(){yi||Di(),yi||(X=t)},Di(),d},$t=kt,"em-pthread"===globalThis.self?.name&&kt()})),fu=H((()=>{vt(),St=("undefined"==typeof document?require("url").pathToFileURL(__filename).href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("yunjing-for-cesium-cjs.js",document.baseURI).href)??(typeof document<"u"?document.currentScript?.src:typeof self<"u"?self.location?.href:void 0),Et=typeof location>"u"?void 0:location.origin,Mt=(t,e)=>{try{let n=e??St;return(n?new URL(t,n):new URL(t)).origin===Et}catch{return!1}},Ct=async t=>{let e=await(await fetch(t,{credentials:"same-origin"})).blob();return URL.createObjectURL(e)},At=(bt(),V(mt)).default,Ot=async()=>{if(!St)throw new Error("Failed to load proxy worker: cannot determine the script source URL.");if(Mt(St))return[void 0,At()];let t=await Ct(St);return[t,At(t)]},It=(cu(),V(_t)).default,Tt=async(t,e,n)=>[void 0,It]})),du=H((()=>{fu(),Rt=!1,Ft=!1,Dt=!1,Pt=()=>{if(typeof SharedArrayBuffer>"u")return!1;try{return typeof MessageChannel<"u"&&(new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch{return!1}},Nt=()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,30,1,28,0,65,0,253,15,253,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,186,1,26,11]))}catch{return!1}},Ut=async t=>{if(Rt)return Promise.resolve();if(Ft)throw new Error("multiple calls to 'initializeWebAssembly()' detected.");if(Dt)throw new Error("previous call to 'initializeWebAssembly()' failed.");Ft=!0;let e=t.initTimeout,n=t.numThreads;if(!Nt())throw new Error("WebAssembly SIMD is not supported in the current environment.");let i=Pt();n>1&&!i&&(typeof self<"u"&&self.crossOriginIsolated,t.numThreads=n=1);let r=t.wasmPaths,o="string"==typeof r?r:void 0,s=r?.mjs,a=s?.href??s,u=r?.wasm,h=u?.href??u,l=t.wasmBinary,[c,f]=await Tt(a,o,n>1),d=!1,p=[];if(e>0&&p.push(new Promise((t=>{setTimeout((()=>{d=!0,t()}),e)}))),p.push(new Promise(((t,e)=>{let i={numThreads:n};l?i.wasmBinary=l:(h||o)&&(i.locateFile=(t,e)=>h??(o??e)+t),f(i).then((e=>{Ft=!1,Rt=!0,zt=e,t(),c&&URL.revokeObjectURL(c)}),(t=>{Ft=!1,Dt=!0,e(t)}))}))),await Promise.race(p),d)throw new Error(`WebAssembly backend initializing failed due to timeout: ${e}ms`)},qt=()=>{if(Rt&&zt)return zt;throw new Error("WebAssembly is not initialized yet.")}})),pu=H((()=>{du(),jt=(t,e)=>{let n=qt(),i=n.lengthBytesUTF8(t)+1,r=n.Ft(i);return n.stringToUTF8(t,r,i),e.push(r),r},Lt=(t,e,n,i)=>{if("object"==typeof t&&null!==t){if(n.has(t))throw new Error("Circular reference in options");n.add(t)}Object.entries(t).forEach((([t,r])=>{let o=e?e+t:t;if("object"==typeof r)Lt(r,o+".",n,i);else if("string"==typeof r||"number"==typeof r)i(o,r.toString());else{if("boolean"!=typeof r)throw new Error("Can't handle extra config type: "+typeof r);i(o,r?"1":"0")}}))},Bt=t=>{let e=qt(),n=e.stackSave();try{let n=e.stackAlloc(8);e.ot(n,n+4);let i=e.HEAP32[n/4],r=e.HEAPU32[n/4+1],o=r?e.UTF8ToString(r):"";throw new Error(`${t} ERROR_CODE: ${i}, ERROR_MESSAGE: ${o}`)}finally{e.stackRestore(n)}}})),vu=H((()=>{du(),pu(),Ht=t=>{let e=qt(),n=0,i=[],r=t||{};try{if(void 0===t?.logSeverityLevel)r.logSeverityLevel=2;else if("number"!=typeof t.logSeverityLevel||!Number.isInteger(t.logSeverityLevel)||t.logSeverityLevel<0||t.logSeverityLevel>4)throw new Error(`log serverity level is not valid: ${t.logSeverityLevel}`);if(void 0===t?.logVerbosityLevel)r.logVerbosityLevel=0;else if("number"!=typeof t.logVerbosityLevel||!Number.isInteger(t.logVerbosityLevel))throw new Error(`log verbosity level is not valid: ${t.logVerbosityLevel}`);void 0===t?.terminate&&(r.terminate=!1);let o=0;return void 0!==t?.tag&&(o=jt(t.tag,i)),n=e.$t(r.logSeverityLevel,r.logVerbosityLevel,!!r.terminate,o),0===n&&Bt("Can't create run options."),void 0!==t?.extra&&Lt(t.extra,"",new WeakSet,((t,r)=>{let o=jt(t,i),s=jt(r,i);0!==e.St(n,o,s)&&Bt(`Can't set a run config entry: ${t} - ${r}.`)})),[n,i]}catch(t){throw 0!==n&&e.Et(n),i.forEach((t=>e.Dt(t))),t}}})),mu=H((()=>{du(),pu(),Wt=t=>{switch(t){case"disabled":return 0;case"basic":return 1;case"extended":return 2;case"all":return 99;default:throw new Error(`unsupported graph optimization level: ${t}`)}},Vt=t=>{switch(t){case"sequential":return 0;case"parallel":return 1;default:throw new Error(`unsupported execution mode: ${t}`)}},Gt=t=>{t.extra||(t.extra={}),t.extra.session||(t.extra.session={});let e=t.extra.session;e.use_ort_model_bytes_directly||(e.use_ort_model_bytes_directly="1"),t.executionProviders&&t.executionProviders.some((t=>"webgpu"===("string"==typeof t?t:t.name)))&&(t.enableMemPattern=!1)},Yt=(t,e,n)=>{for(let i of e){let e="string"==typeof i?i:i.name;switch(e){case"webnn":if(e="WEBNN","string"!=typeof i){let e=i?.deviceType;if(e){let i=jt("deviceType",n),r=jt(e,n);0!==qt().ct(t,i,r)&&Bt(`Can't set a session config entry: 'deviceType' - ${e}.`)}}break;case"webgpu":if(e="JS","string"!=typeof i){let e=i;if(e?.preferredLayout){if("NCHW"!==e.preferredLayout&&"NHWC"!==e.preferredLayout)throw new Error(`preferredLayout must be either 'NCHW' or 'NHWC': ${e.preferredLayout}`);let i=jt("preferredLayout",n),r=jt(e.preferredLayout,n);0!==qt().ct(t,i,r)&&Bt(`Can't set a session config entry: 'preferredLayout' - ${e.preferredLayout}.`)}}break;case"wasm":case"cpu":continue;default:throw new Error(`not supported execution provider: ${e}`)}let r=jt(e,n);0!==qt().ut(t,r)&&Bt(`Can't append execution provider: ${e}.`)}},Kt=t=>{let e=qt(),n=0,i=[],r=t||{};Gt(r);try{let t=Wt(r.graphOptimizationLevel??"all"),o=Vt(r.executionMode??"sequential"),s="string"==typeof r.logId?jt(r.logId,i):0,a=r.logSeverityLevel??2;if(!Number.isInteger(a)||a<0||a>4)throw new Error(`log serverity level is not valid: ${a}`);let u=r.logVerbosityLevel??0;if(!Number.isInteger(u)||u<0||u>4)throw new Error(`log verbosity level is not valid: ${u}`);let h="string"==typeof r.optimizedModelFilePath?jt(r.optimizedModelFilePath,i):0;if(n=e.st(t,!!r.enableCpuMemArena,!!r.enableMemPattern,o,!!r.enableProfiling,0,s,a,u,h),0===n&&Bt("Can't create session options."),r.executionProviders&&Yt(n,r.executionProviders,i),void 0!==r.enableGraphCapture){if("boolean"!=typeof r.enableGraphCapture)throw new Error(`enableGraphCapture must be a boolean value: ${r.enableGraphCapture}`);let t=jt("enableGraphCapture",i),o=jt(r.enableGraphCapture.toString(),i);0!==e.ct(n,t,o)&&Bt(`Can't set a session config entry: 'enableGraphCapture' - ${r.enableGraphCapture}.`)}if(r.freeDimensionOverrides)for(let[t,o]of Object.entries(r.freeDimensionOverrides)){if("string"!=typeof t)throw new Error(`free dimension override name must be a string: ${t}`);if("number"!=typeof o||!Number.isInteger(o)||o<0)throw new Error(`free dimension override value must be a non-negative integer: ${o}`);let r=jt(t,i);0!==e.ht(n,r,o)&&Bt(`Can't set a free dimension override: ${t} - ${o}.`)}return void 0!==r.extra&&Lt(r.extra,"",new WeakSet,((t,r)=>{let o=jt(t,i),s=jt(r,i);0!==e.ct(n,o,s)&&Bt(`Can't set a session config entry: ${t} - ${r}.`)})),[n,i]}catch(t){throw 0!==n&&e.ft(n),i.forEach((t=>e.Dt(t))),t}}})),yu=H((()=>{Xt=t=>{switch(t){case"int8":return 3;case"uint8":return 2;case"bool":return 9;case"int16":return 5;case"uint16":return 4;case"int32":return 6;case"uint32":return 12;case"float16":return 10;case"float32":return 1;case"float64":return 11;case"string":return 8;case"int64":return 7;case"uint64":return 13;default:throw new Error(`unsupported data type: ${t}`)}},Qt=t=>{switch(t){case 3:return"int8";case 2:return"uint8";case 9:return"bool";case 5:return"int16";case 4:return"uint16";case 6:return"int32";case 12:return"uint32";case 10:return"float16";case 1:return"float32";case 11:return"float64";case 8:return"string";case 7:return"int64";case 13:return"uint64";default:throw new Error(`unsupported data type: ${t}`)}},Zt=t=>[void 0,4,1,1,2,2,4,8,void 0,1,2,8,4,8,void 0,void 0,void 0][t],Jt=t=>{switch(t){case"float16":return typeof Float16Array<"u"&&Float16Array.from?Float16Array:Uint16Array;case"float32":return Float32Array;case"uint8":case"bool":return Uint8Array;case"int8":return Int8Array;case"uint16":return Uint16Array;case"int16":return Int16Array;case"int32":return Int32Array;case"float64":return Float64Array;case"uint32":return Uint32Array;case"int64":return BigInt64Array;case"uint64":return BigUint64Array;default:throw new Error(`unsupported type: ${t}`)}},te=t=>{switch(t){case"verbose":return 0;case"info":return 1;case"warning":return 2;case"error":return 3;case"fatal":return 4;default:throw new Error(`unsupported logging level: ${t}`)}},ee=t=>"float32"===t||"float16"===t||"int32"===t||"int64"===t||"uint32"===t||"uint8"===t||"bool"===t,ne=t=>{switch(t){case"none":return 0;case"cpu":return 1;case"cpu-pinned":return 2;case"texture":return 3;case"gpu-buffer":return 4;default:throw new Error(`unsupported data location: ${t}`)}}})),wu=H((()=>{vt(),ie=async t=>{if("string"==typeof t){let e=await fetch(t);if(!e.ok)throw new Error(`failed to load external data file: ${t}`);let n=e.headers.get("Content-Length"),i=n?parseInt(n,10):0;if(i<1073741824)return new Uint8Array(await e.arrayBuffer());{if(!e.body)throw new Error(`failed to load external data file: ${t}, no response body.`);let n,r=e.body.getReader();try{n=new ArrayBuffer(i)}catch(t){if(!(t instanceof RangeError))throw t;{let t=Math.ceil(i/65536);n=new WebAssembly.Memory({initial:t,maximum:t}).buffer}}let o=0;for(;;){let{done:t,value:e}=await r.read();if(t)break;let i=e.byteLength;new Uint8Array(n,o,i).set(e),o+=i}return new Uint8Array(n,0,i)}}return t instanceof Blob?new Uint8Array(await t.arrayBuffer()):t instanceof Uint8Array?t:new Uint8Array(t)}})),gu=H((()=>{yu(),se=(t,e)=>{re=t,oe=e},ae=(t,e)=>{te(t)>=te(re)&&"function"==typeof e&&e()},ue=(...t)=>{oe&&ae(...t)}})),bu=H((()=>{yu(),he=(t,e)=>new(Jt(e))(t)})),_u=H((()=>{})),xu=H((()=>{gu(),_u(),le=new Map([[64,250],[128,200],[256,200],[512,200],[2048,230],[4096,200],[8192,50],[16384,50],[32768,50],[65536,50],[131072,50],[262144,50],[524288,50],[1048576,50],[2097152,30],[4194304,20],[8388608,10],[12582912,10],[16777216,10],[26214400,15],[33554432,22],[44236800,2],[58982400,6],[67108864,6],[134217728,6],[167772160,6]]),ce=[],fe=t=>16*Math.ceil(t/16),de=t=>{for(let e=0;e<ce.length;e++){let n=ce[e];if(t<=n)return n}return 16*Math.ceil(t/16)},pe=1,ve=()=>pe++,me=async(t,e,n,i)=>{let r=fe(n),o=t.device.createBuffer({size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});try{let s=t.getCommandEncoder();t.endComputePass(),s.copyBufferToBuffer(e,0,o,0,r),t.flush(),await o.mapAsync(GPUMapMode.READ);let a=o.getMappedRange();if(i){let t=i();return t.set(new Uint8Array(a,0,n)),t}return new Uint8Array(a.slice(0,n))}finally{o.destroy()}},ye=class{constructor(t){this.backend=t,this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.buffersForUploadingPending=[],this.buffersPending=[],this.externalBuffers=new Map,this.capturedPendingBuffers=new Map;for(let[t]of le)ce.push(t),this.freeBuffers.set(t,[]),this.freeUniformBuffers.set(t,[])}upload(t,e){let n=e.buffer,i=e.byteOffset,r=e.byteLength,o=fe(r),s=this.storageCache.get(t);if(!s)throw new Error("gpu data for uploading does not exist");if(s.originalSize!==r)throw new Error(`inconsistent data size. gpu data size=${s.originalSize}, data size=${r}`);let a=this.backend.device.createBuffer({mappedAtCreation:!0,size:o,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC}),u=a.getMappedRange();new Uint8Array(u).set(new Uint8Array(n,i,r)),a.unmap();let h=this.backend.getCommandEncoder();this.backend.endComputePass(),h.copyBufferToBuffer(a,0,s.gpuData.buffer,0,o),ue("verbose",(()=>`[WebGPU] GpuDataManager.upload(id=${t})`)),this.buffersForUploadingPending.push(a)}memcpy(t,e){let n=this.storageCache.get(t);if(!n)throw new Error("source gpu data for memcpy does not exist");let i=this.storageCache.get(e);if(!i)throw new Error("destination gpu data for memcpy does not exist");if(n.originalSize!==i.originalSize)throw new Error("inconsistent source and destination gpu data size");let r=fe(n.originalSize),o=this.backend.getCommandEncoder();this.backend.endComputePass(),o.copyBufferToBuffer(n.gpuData.buffer,0,i.gpuData.buffer,0,r)}registerExternalBuffer(t,e,n){let i;if(n){if(i=this.externalBuffers.get(n),void 0===i)throw new Error("previous buffer is not registered");if(t===n)return ue("verbose",(()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${e}) => id=${i}, buffer is the same, skip.`)),i;if(this.backend.capturedCommandList.has(this.backend.currentSessionId))throw new Error("Registering a different external buffer under graph capture mode is not supported yet.\n             Please use the previous external buffer!");this.externalBuffers.delete(n)}else i=ve();return this.storageCache.set(i,{gpuData:{id:i,type:0,buffer:t},originalSize:e}),this.externalBuffers.set(t,i),ue("verbose",(()=>`[WebGPU] GpuDataManager.registerExternalBuffer(size=${e}) => id=${i}, registered.`)),i}unregisterExternalBuffer(t){let e=this.externalBuffers.get(t);void 0!==e&&(this.storageCache.delete(e),this.externalBuffers.delete(t),ue("verbose",(()=>`[WebGPU] GpuDataManager.unregisterExternalBuffer() => id=${e}`)))}create(t,e=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST){let n,i=de(t),r=(e&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE,o=(e&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM;if(r||o){let t=(r?this.freeBuffers:this.freeUniformBuffers).get(i);n=t&&t.length>0?t.pop():this.backend.device.createBuffer({size:i,usage:e})}else n=this.backend.device.createBuffer({size:i,usage:e});let s={id:ve(),type:0,buffer:n};return this.storageCache.set(s.id,{gpuData:s,originalSize:t}),ue("verbose",(()=>`[WebGPU] GpuDataManager.create(size=${t}) => id=${s.id}`)),s}get(t){return this.storageCache.get(t)?.gpuData}release(t){let e=this.storageCache.get(t);if(!e)throw new Error("releasing data does not exist");return ue("verbose",(()=>`[WebGPU] GpuDataManager.release(id=${t}), gpuDataId=${e.gpuData.id}`)),this.storageCache.delete(t),this.buffersPending.push(e.gpuData.buffer),e.originalSize}async download(t,e){let n=this.storageCache.get(t);if(!n)throw new Error("data does not exist");await me(this.backend,n.gpuData.buffer,n.originalSize,e)}refreshPendingBuffers(){for(let t of this.buffersForUploadingPending)t.destroy();if(this.buffersForUploadingPending=[],0!==this.buffersPending.length)if("default"===this.backend.sessionStatus){for(let t of this.buffersPending){let e=le.get(t.size);if((t.usage&GPUBufferUsage.STORAGE)===GPUBufferUsage.STORAGE){let n=this.freeBuffers.get(t.size)||[];void 0===e||n.length>=e?t.destroy():n.push(t)}else if((t.usage&GPUBufferUsage.UNIFORM)===GPUBufferUsage.UNIFORM){let n=this.freeUniformBuffers.get(t.size)||[];void 0===e||n.length>=e?t.destroy():n.push(t)}else t.destroy()}this.buffersPending=[]}else{let t=this.capturedPendingBuffers.get(this.backend.currentSessionId);t||(t=[],this.capturedPendingBuffers.set(this.backend.currentSessionId,t));for(let e of this.buffersPending)t.push(e);this.buffersPending=[]}}dispose(){this.freeBuffers.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.freeUniformBuffers.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.storageCache.forEach((t=>{t.gpuData.buffer.destroy()})),this.capturedPendingBuffers.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.storageCache=new Map,this.freeBuffers=new Map,this.freeUniformBuffers=new Map,this.capturedPendingBuffers=new Map}onReleaseSession(t){let e=this.capturedPendingBuffers.get(t);e&&(e.forEach((t=>{t.destroy()})),this.capturedPendingBuffers.delete(t))}},we=(...t)=>new ye(...t)})),ku=H((()=>{ge=class{constructor(t){Object.assign(this,t)}get cacheKey(){return this.key||(this.key=Object.getOwnPropertyNames(this).sort().map((t=>`${this[t]}`)).join(";")),this.key}},be=t=>new ge(t)})),$u=H((()=>{_e=class{static calcMatMulShape(t,e){return t[1]!==e[0]?void 0:[t[0],e[1]]}},xe=class{static calcShape(t,e,n=!1){let i=t.length,r=e.length;if(0===i)return e;if(0===r)return t;let o=Math.max(t.length,e.length),s=new Array(o);if(n){if(i<2||r<2)return;let n=_e.calcMatMulShape([t[i-2],t[i-1]],[e[r-2],e[r-1]]);if(void 0===n)return;[s[o-2],s[o-1]]=n}for(let a=n?3:1;a<=o;a++){let n=i-a<0?1:t[i-a],u=r-a<0?1:e[r-a];if(n!==u&&n>1&&u>1)return;let h=Math.max(n,u);if(n&&u)s[o-a]=Math.max(n,u);else{if(h>1)return;s[o-a]=0}}return s}static isValidBroadcast(t,e){let n=t.length,i=e.length;if(n>i)return!1;for(let r=1;r<=n;r++)if(1!==t[n-r]&&t[n-r]!==e[i-r])return!1;return!0}},ke=class t{static size(e){return t.getSizeFromDimensionRange(e,0,e.length)}static convertShape(t,e=4){let n=t.length;if(0===n)return[];let i=new Array(n),r=n-1;for(;r>=0;){if(t[r]%e==0){i[r]=t[r]/e;break}if(e%t[r]!=0)throw new Error("cannot convert shape");i[r]=1,e/=t[r],r--}for(r--;r>=0;r--)i[r]=t[r];return i}static sizeFromDimension(e,n){if(n<0||n>e.length)throw new Error(`invalid dimension of ${n} for sizeFromDimension as Tensor has ${e.length} dimensions.`);return t.getSizeFromDimensionRange(e,n,e.length)}static sizeToDimension(e,n){if(n<0||n>e.length)throw new Error(`invalid dimension of ${n} for sizeToDimension as Tensor has ${e.length} dimensions.`);return t.getSizeFromDimensionRange(e,0,n)}static getSizeFromDimensionRange(t,e,n){let i=1;for(let r=e;r<n;r++){if(t[r]<0)throw new Error("cannot get valid size from specified dimension range. Most likely the range contains negative values in them.");i*=t[r]}return i}static computeStrides(t){let e=t.length;if(0===e)return[];if(1===e)return[1];let n=new Array(e);n[e-1]=1,n[e-2]=t[e-1];for(let i=e-3;i>=0;--i)n[i]=n[i+1]*t[i+1];return n}static normalizeAxis(t,e){if(t<-e&&t>=e)throw new Error("unsupported axis for this operation.");return t<0?t+e:t}static normalizeAxes(t,e){return t.map((n=>this.normalizeAxis(n,e??t.length)))}static sortBasedOnPerm(t,e){return e?e.map((e=>t[e])):t.slice().reverse()}static padShape(t,e){let n=t.length;return t.map(((t,i)=>t+e[i]+e[i+n]))}static areEqual(t,e){return t.length===e.length&&t.every(((t,n)=>t===e[n]))}},$e=class t{static adjustPoolAttributes(t,e,n,i,r,o){if(!t&&n.length!==e.length-2)throw new Error("length of specified kernel shapes should be 2 less than length of input dimensions");if(t)for(let t=0;t<e.length-2;t++)t>=n.length?n.push(e[t+2]):n[t]=e[t+2];for(let t=0;t<n.length;t++)if(t<i.length){if(i[t]<0)throw new Error("strides should be greater than or equal to 1")}else i.push(1);for(let t=0;t<n.length;t++)if(t<r.length){if(r[t]<0)throw new Error("dilations should be greater than or equal to 1")}else r.push(1);for(let t=0;t<2*n.length;t++)if(t<o.length){if(o[t]<0)throw new Error("pad should be greater than or equal to 1")}else o.push(0);for(let t=0;t<n.length;t++){if(n[t]<=0)throw new Error("kernel shapes need to be greater than 0");if(o[t]>=n[t]||o[t+n.length]>=n[t])throw new Error("pads should be smaller than kernel")}}static adjustPadsBasedOnAutoPad(e,n,i,r,o,s,a){if(a){if(o.length!==2*(e.length-2))throw new Error("length of pads should be twice the length of data dimensions");if(n.length!==e.length-2)throw new Error("length of strides should be the length of data dimensions");if(r.length!==e.length-2)throw new Error("length of kernel shapes should be the length of data dimensions");for(let u=0;u<e.length-2;u++)t.adjustPadAndReturnShape(e[u+(s?1:2)],n[u],i[u],r[u],o,u,u+e.length-2,a)}}static computePoolOutputShape(e,n,i,r,o,s,a){if(n.length<=0)throw new Error("input shape must be of size greater than 0");let u=[n[0],n[1]];return t.computeShapeHelper(e,n,u,i,r,o,s,a),u}static computeConvOutputShape(e,n,i,r,o,s,a){if(e.length<=0||n.length<=0)throw new Error("invalid input tensor dims or invalid filter tensor dims");let u=[e[0],n[0]];return t.computeShapeHelper(!1,e,u,i,r,o,s,a),u}static computeShapeHelper(e,n,i,r,o,s,a,u){if(e)for(let t=0;t<n.length-2;t++)i.push(1);else for(let e=0;e<n.length-2;e++)i.push(t.adjustPadAndReturnShape(n[e+2],r[e],o[e],s[e],a,e,e+n.length-2,u))}static adjustPadAndReturnShape(t,e,n,i,r,o,s,a){let u=n*(i-1)+1;if(!a||"NOTSET"===a)return Math.floor((t+r[o]+r[s]-u)/e+1);switch(a){case"VALID":return r[o]=0,r[s]=0,Math.floor((t-u)/e+1);case"SAME_LOWER":case"SAME_UPPER":if(1!==n)throw new Error("Dilation not supported for SAME_UPPER or SAME_LOWER");{let n=((t+e-1)/e-1)*e+i-t;return r[o]=Math.floor("SAME_LOWER"===a?(n+1)/2:n/2),r[s]=n-r[o],Math.floor((t+n-i)/e+1)}default:throw new Error("Unsupported AutoPad type")}}},Se=class{static getShapeOfGemmResult(t,e,n,i,r){if(2!==t.length||2!==n.length)throw new Error("shape need to be of size 2");let o,s,a;e?(o=t[1],s=t[0]):(o=t[0],s=t[1]);let u=-1;if(i?(a=n[0],u=1):(a=n[1],u=0),n[u]!==s)throw new Error("dimension mismatch");if(o<=0||a<=0||s<=0)throw new Error("invalid shape specified");if(r&&!xe.isValidBroadcast(r,[o,a]))throw new Error("gemm: invalid bias shape for broadcast");return[o,a,s]}},Ee=-34028234663852886e22,Me=34028234663852886e22})),Su=H((()=>{yu(),$u(),Ce=64,Ae=(t,e)=>{if(3===e)throw new Error("vec3 has same alignment as vec4, use vec4 instead");switch(t){case 10:return e>1?`vec${e}<f16>`:"f16";case 1:return e>1?`vec${e}<f32>`:"f32";case 6:return e>1?`vec${e}<i32>`:"i32";case 12:return e>1?`vec${e}<u32>`:"u32";case 7:if(e>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","i32"];case 13:if(e>1)throw new Error("currently not supported vecX of uint64 yet");return["vec2<u32>","u32"];case 9:if(4!==e)throw new Error("bool must be vec4");return["u32","vec4<bool>"];default:throw new Error(`Unknown data type: ${t}`)}},Oe=(t,e=1)=>{let n=Ae(t,e);return"string"==typeof n?n:n[0]},Ie=(t,e=1)=>{let n=Ae(t,e);return"string"==typeof n?n:n[1]},Te=(...t)=>{let e=[];return t.forEach((t=>{0!==t.length&&e.push({type:12,data:t},{type:12,data:ke.computeStrides(t)})})),e},ze=t=>t%4==0?4:t%2==0?2:1,Re=(t="f32",e,n="0")=>e&&1!==e?`vec${e}<${t}>(${n})`:`${t}(${n})`,Fe=(t,e,n)=>"f32"===t?n:1===e?`f32(${n})`:`vec${e}<f32>(${n})`,De=(t,e)=>4===e?`(${t}.x + ${t}.y + ${t}.z + ${t}.w)`:2===e?`(${t}.x + ${t}.y)`:3===e?`(${t}.x + ${t}.y + ${t}.z)`:t,Pe=(t,e,n,i)=>t.startsWith("uniforms.")&&n>4?"string"==typeof e?"f16"===i?`${t}[(${e}) / 8][(${e}) % 8 / 4][(${e}) % 8 % 4]`:`${t}[(${e}) / 4][(${e}) % 4]`:"f16"===i?`${t}[${Math.floor(e/8)}][${Math.floor(e%8/4)}][${e%8%4}]`:`${t}[${Math.floor(e/4)}][${e%4}]`:n>1?`${t}[${e}]`:t,Ne=(t,e,n,i,r)=>{let o="number"==typeof n,s=o?n:n.length,a=[...new Array(s).keys()],u=s<2?"u32":s<=4?`vec${s}<u32>`:`array<u32, ${s}>`,h=Ae(e,r),l="string"==typeof h?h:h[1],c="string"==typeof h?h:h[0],f={indices:u,value:l,storage:c,tensor:e},d=t=>"string"==typeof t?t:`${t}u`,p={offsetToIndices:!1,indicesToOffset:!1,broadcastedIndicesToOffset:!1,set:!1,setByIndices:!1,get:!1,getByIndices:!1},v=o?"uniforms.":"",m=`${v}${t}_shape`,y=`${v}${t}_strides`,w="";for(let t=0;t<s-1;t++)w+=`\n    let dim${t} = current / ${Pe(y,t,s)};\n    let rest${t} = current % ${Pe(y,t,s)};\n    indices[${t}] = dim${t};\n    current = rest${t};\n    `;w+=`indices[${s-1}] = current;`;let g=s<2?"":`\n  fn o2i_${t}(offset: u32) -> ${f.indices} {\n    var indices: ${f.indices};\n    var current = offset;\n    ${w}\n    return indices;\n  }`,b=[];if(s>=2)for(let t=s-1;t>=0;t--)b.push(`${Pe(y,t,s)} * (indices[${t}])`);let _=s<2?"":`\n  fn i2o_${t}(indices: ${f.indices}) -> u32 {\n    return ${b.join("+")};\n  }`,x=(...t)=>0===s?"0u":`${f.indices}(${t.map(d).join(",")})`,k=(t,e)=>s<2?`${t}`:`${Pe(t,e,s)}`,$={},S=(e,n)=>(()=>{if(f.storage===f.value)return`${t}[${e}]=${n};`;if("vec2<u32>"===f.storage&&"i32"===f.value)return`${t}[${e}]=vec2<u32>(u32(${n}), select(0u, 0xFFFFFFFFu, ${n} < 0));`;if("vec2<u32>"===f.storage&&"u32"===f.value)return`${t}[${e}]=vec2<u32>(u32(${n}), 0u);`;if("u32"===f.storage&&"vec4<bool>"===f.value)return`${t}[${e}]=dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(${n}));`;throw new Error(`not supported combination of storage type ${f.storage} and value type ${f.value} yet`)})(),E=e=>(()=>{if(f.storage===f.value)return`${t}[${e}]`;if("vec2<u32>"===f.storage&&"i32"===f.value)return`i32(${t}[${e}].x)`;if("vec2<u32>"===f.storage&&"u32"===f.value)return`u32(${t}[${e}].x)`;if("u32"===f.storage&&"vec4<bool>"===f.value)return`vec4<bool>(bool(${t}[${e}] & 0xFFu), bool(${t}[${e}] & 0xFF00u), bool(${t}[${e}] & 0xFF0000u), bool(${t}[${e}] & 0xFF000000u))`;throw new Error(`not supported combination of storage type ${f.storage} and value type ${f.value} yet`)})(),M=s<2?"":`\n  fn get_${t}ByIndices(indices: ${f.indices}) -> ${l} {\n    return ${E(`i2o_${t}(indices)`)};\n  }`,C=s<2?"":(()=>{let e=a.map((t=>`d${t}: u32`)).join(", "),n=a.map((t=>`d${t}`)).join(", ");return`\n  fn get_${t}(${e}) -> ${l} {\n    return get_${t}ByIndices(${x(n)});\n  }`})(),A=s<2?"":`\n  fn set_${t}ByIndices(indices: ${f.indices}, value: ${l}) {\n    ${S(`i2o_${t}(indices)`,"value")}\n  }`,O=s<2?"":(()=>{let e=a.map((t=>`d${t}: u32`)).join(", "),n=a.map((t=>`d${t}`)).join(", ");return`\n  fn set_${t}(${e}, value: ${l}) {\n    set_${t}ByIndices(${x(n)}, value);\n  }`})();return{impl:()=>{let t=[],e=!1;return p.offsetToIndices&&(t.push(g),e=!0),p.indicesToOffset&&(t.push(_),e=!0),p.broadcastedIndicesToOffset&&(Object.values($).forEach((e=>t.push(e))),e=!0),p.set&&(t.push(O),e=!0),p.setByIndices&&(t.push(A),e=!0),p.get&&(t.push(C),e=!0),p.getByIndices&&(t.push(M),e=!0),!o&&e&&t.unshift(`const ${m} = ${f.indices}(${n.join(",")});`,`const ${y} = ${f.indices}(${ke.computeStrides(n).join(",")});`),t.join("\n")},type:f,offsetToIndices:e=>(p.offsetToIndices=!0,s<2?e:`o2i_${t}(${e})`),indicesToOffset:e=>(p.indicesToOffset=!0,s<2?e:`i2o_${t}(${e})`),broadcastedIndicesToOffset:(e,n)=>{p.broadcastedIndicesToOffset=!0;let i=`${n.name}broadcastedIndicesTo${t}Offset`;if(i in $)return`${i}(${e})`;let r=[];for(let t=s-1;t>=0;t--){let e=n.indicesGet("outputIndices",t+n.rank-s);r.push(`${k(y,t)} * (${e} % ${k(m,t)})`)}return $[i]=`fn ${i}(outputIndices: ${n.type.indices}) -> u32 {\n             return ${r.length>0?r.join("+"):"0u"};\n           }`,`${i}(${e})`},indices:x,indicesGet:k,indicesSet:(t,e,n)=>s<2?`${t}=${n};`:`${Pe(t,e,s)}=${n};`,set:(...e)=>{if(e.length!==s+1)throw new Error(`indices length must be ${s}`);let n=e[s];if("string"!=typeof n)throw new Error("value must be string");let i=e.slice(0,s).map(d).join(",");return 0===s?S("0u",n):1===s?S(i[0],n):(p.set=!0,p.setByIndices=!0,p.indicesToOffset=!0,`set_${t}(${i}, ${n})`)},setByOffset:S,setByIndices:(e,n)=>s<2?S(e,n):(p.setByIndices=!0,p.indicesToOffset=!0,`set_${t}ByIndices(${e}, ${n});`),get:(...e)=>{if(e.length!==s)throw new Error(`indices length must be ${s}`);let n=e.map(d).join(",");return 0===s?E("0u"):1===s?E(n[0]):(p.get=!0,p.getByIndices=!0,p.indicesToOffset=!0,`get_${t}(${n})`)},getByOffset:E,getByIndices:e=>s<2?E(e):(p.getByIndices=!0,p.indicesToOffset=!0,`get_${t}ByIndices(${e})`),usage:i,name:t,strides:y,shape:m,rank:s}},Ue=(t,e,n,i=1)=>Ne(t,e,n,"input",i),qe=(t,e,n,i=1)=>Ne(t,e,n,"output",i),je=(t,e,n,i=1)=>Ne(t,e,n,"internal",i),Le=class{constructor(t,e){this.normalizedDispatchGroup=t,this.limits=e,this.internalVariables=[],this.variables=[],this.uniforms=[],this.variableIndex=0}guardAgainstOutOfBoundsWorkgroupSizes(t){return`if (global_idx >= ${"number"==typeof t?`${t}u`:t}) { return; }`}mainStart(t=Ce){let e="number"==typeof t?t:t[0],n="number"==typeof t?1:t[1],i="number"==typeof t?1:t[2];if(e>this.limits.maxComputeWorkgroupSizeX||n>this.limits.maxComputeWorkgroupSizeY||i>this.limits.maxComputeWorkgroupSizeZ)throw new Error(`workgroup size [${e}, ${n}, ${i}] exceeds the maximum workgroup size [${this.limits.maxComputeWorkgroupSizeX}, ${this.limits.maxComputeWorkgroupSizeY}, ${this.limits.maxComputeWorkgroupSizeZ}].`);if(e*n*i>this.limits.maxComputeInvocationsPerWorkgroup)throw new Error(`workgroup size [${e}, ${n}, ${i}] exceeds the maximum workgroup invocations ${this.limits.maxComputeInvocationsPerWorkgroup}.`);let r=1===this.normalizedDispatchGroup[1]&&1===this.normalizedDispatchGroup[2];return`@compute @workgroup_size(${e}, ${n}, ${i})\n  fn main(${r?"@builtin(global_invocation_id) global_id : vec3<u32>,\n    @builtin(workgroup_id) workgroup_id : vec3<u32>,\n    @builtin(local_invocation_id) local_id : vec3<u32>":"@builtin(global_invocation_id) global_id : vec3<u32>,\n                                             @builtin(local_invocation_id) local_id : vec3<u32>,\n    @builtin(local_invocation_index) local_idx : u32,\n    @builtin(workgroup_id) workgroup_id : vec3<u32>,\n    @builtin(num_workgroups) num_workgroups : vec3<u32>"}) {\n    ${r?"let global_idx = global_id.x; let local_idx = local_id.x;":`let global_idx = (workgroup_id.z * num_workgroups[0] * num_workgroups[1] +\n          workgroup_id.y * num_workgroups[0] + workgroup_id.x) * ${e*n*i}u + local_idx;`}\n  `}appendVariableUniforms(t){0!==t.rank&&(t.shape.startsWith("uniforms.")&&this.uniforms.push({name:t.shape.replace("uniforms.",""),type:"u32",length:t.rank}),t.strides.startsWith("uniforms.")&&this.uniforms.push({name:t.strides.replace("uniforms.",""),type:"u32",length:t.rank}))}declareVariable(t,e){if("internal"===t.usage)throw new Error("cannot use internal variable with declareVariable(). use registerInternalVariables() instead.");this.variables.push(t),this.appendVariableUniforms(t);let n="input"===t.usage?"read":"read_write",i=t.type.storage;return`@group(0) @binding(${e}) var<storage, ${n}> ${t.name}: array<${i}>;`}declareVariables(...t){return t.map((t=>this.declareVariable(t,this.variableIndex++))).join("\n")}registerInternalVariable(t){if("internal"!==t.usage)throw new Error("cannot use input or output variable with registerInternalVariable(). use declareVariables() instead.");this.internalVariables.push(t),this.appendVariableUniforms(t)}registerInternalVariables(...t){return t.forEach((t=>this.registerInternalVariable(t))),this}registerUniform(t,e,n=1){return this.uniforms.push({name:t,type:e,length:n}),this}registerUniforms(t){return this.uniforms=this.uniforms.concat(t),this}uniformDeclaration(){if(0===this.uniforms.length)return"";let t=[];for(let{name:e,type:n,length:i}of this.uniforms)if(i&&i>4)"f16"===n?t.push(`@align(16) ${e}:array<mat2x4<${n}>, ${Math.ceil(i/8)}>`):t.push(`${e}:array<vec4<${n}>, ${Math.ceil(i/4)}>`);else{let r=null==i||1===i?n:`vec${i}<${n}>`;t.push(`${e}:${r}`)}return`\n      struct Uniforms { ${t.join(", ")} };\n      @group(0) @binding(${this.variableIndex}) var<uniform> uniforms: Uniforms;`}get additionalImplementations(){return this.uniformDeclaration()+this.variables.map((t=>t.impl())).join("\n")+this.internalVariables.map((t=>t.impl())).join("\n")}get variablesInfo(){if(0===this.uniforms.length)return;let t=t=>[12,10,1,6][["u32","f16","f32","i32"].indexOf(t)];return this.uniforms.map((e=>[t(e.type),e.length??1]))}},Be=(t,e)=>new Le(t,e),He=(t,e)=>{let n=t.length,i=[];for(let r=0;r<n;r++){let o=n-1-r,s=t[o]||1;(e[e.length-1-r]||1)>1&&1===s&&i.unshift(o)}return i}})),Eu=H((()=>{yu(),$u(),ku(),Su(),We=t=>{if(!t||1!==t.length)throw new Error("Transpose requires 1 input.")},Ve=(t,e)=>e&&e.length!==t?[...new Array(t).keys()].reverse():e,Ge=(t,e)=>ke.sortBasedOnPerm(t,Ve(t.length,e)),Ye=(t,e,n,i)=>{let r=[];r.push(`fn perm(i: ${i.type.indices}) -> ${n.type.indices} {\n    var a: ${n.type.indices};`);for(let i=0;i<e;++i)r.push(n.indicesSet("a",t[i],`i[${i}]`));return r.push("return a;}"),r.join("\n")},Ke=(t,e)=>{let n,i=t.dataType,r=t.dims.length,o=Ve(r,e),s=Ge(t.dims,o),a=qe("output",i,s.length),u=Ue("a",i,r);if(2===o.length&&1===o[0]&&0===o[1]){let t=a.type.value,e=[16,16,1];n=n=>`\n  ${n.registerUniform("output_size","u32").declareVariables(u,a)}\n  var<workgroup> tile : array<array<${t}, ${e[0]+1}>, ${e[0]}>;\n  ${n.mainStart(e)}\n    var x = workgroup_id.x * ${e[0]}u + local_id.x;\n    var y = workgroup_id.y * ${e[0]}u + local_id.y;\n    let width = uniforms.output_shape[0];\n    let height = uniforms.output_shape[1];\n    if (x < width && y < height) {\n      tile[local_id.y][local_id.x] = ${u.getByOffset("y * width + x")};\n    }\n    workgroupBarrier();\n    x = workgroup_id.y * ${e[0]}u + local_id.x;\n    y = workgroup_id.x * ${e[0]}u + local_id.y;\n    if (x < height && y < width) {\n      ${a.setByOffset("y * height + x","tile[local_id.x][local_id.y]")}\n    }\n  }`}else n=t=>`\n  ${t.registerUniform("output_size","u32").declareVariables(u,a)}\n\n  ${Ye(o,r,u,a)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let indices = ${a.offsetToIndices("global_idx")};\n    let aIndices = perm(indices);\n\n    ${a.setByOffset("global_idx",u.getByIndices("aIndices"))}\n  }`;return{name:"Transpose",shaderCache:{hint:`${e}`,inputDependencies:["rank"]},getRunData:t=>{let e=ke.size(s);return{outputs:[{dims:s,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(e/64)},programUniforms:[{type:12,data:e},...Te(t[0].dims,s)]}},getShaderSource:n}},Xe=(t,e)=>{We(t.inputs),t.compute(Ke(t.inputs[0],e.perm))},Qe=t=>be({perm:t.perm})})),Mu=H((()=>{yu(),$u(),Su(),Cu(),Eu(),Ze={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate * candidate",logSumExp:"bestValue + exp(candidate)",l1:"bestValue + abs(candidate)",l2:"bestValue + candidate * candidate",logSum:"bestValue + candidate"},Je={max:"select(bestValue, candidate, candidate > bestValue)",min:"select(bestValue, candidate, candidate < bestValue)",mean:"bestValue + candidate",sum:"bestValue + candidate",prod:"bestValue * candidate",sumSquare:"bestValue + candidate",logSumExp:"bestValue + candidate",l1:"bestValue + candidate",l2:"bestValue + candidate",logSum:"bestValue + candidate"},tn={max:"_A[offset]",min:"_A[offset]",mean:"0",sum:"0",prod:"1",sumSquare:"0",logSumExp:"0",l1:"0",l2:"0",logSum:"0"},en={max:"bestValue",min:"bestValue",sum:"bestValue",prod:"bestValue",sumSquare:"bestValue",logSumExp:"log(bestValue)",l1:"bestValue",l2:"sqrt(bestValue)",logSum:"log(bestValue)"},nn=(t,e)=>{let n=[];for(let i=e-t;i<e;++i)n.push(i);return n},rn=(t,e)=>{let n=[],i=t.length;for(let r=0;r<i;r++)-1===e.indexOf(r)&&n.push(t[r]);let r=e.map((e=>t[e]));return[n,r]},on=(t,e)=>{let n=t.length+e.length,i=[],r=0;for(let o=0;o<n;o++)-1===e.indexOf(o)?i.push(t[r++]):i.push(1);return i},sn=(t,e)=>{for(let n=0;n<t.length;++n)if(t[t.length-n-1]!==e-1-n)return!1;return!0},an=(t,e)=>{let n=[];if(!sn(t,e)){for(let i=0;i<e;++i)-1===t.indexOf(i)&&n.push(i);t.forEach((t=>n.push(t)))}return n},un=(t,e,n,i,r,o,s)=>{let a=n[0].dims,u=ke.size(o),h=ke.size(s),l=Ue("_A",n[0].dataType,a),c=qe("output",r,o);return{name:t,shaderCache:e,getShaderSource:t=>`\n        ${t.registerUniform("reduceSize","u32").declareVariables(l,c)}\n        \n          var<workgroup> aBestValues : array<f32, 32>;\n       \n        fn DIV_CEIL(a : u32, b : u32) -> u32 {\n          return ((a - 1u) / b + 1u);\n         }\n         ${t.mainStart(32)}\n\n          let outputIndex = global_idx / 32;\n          let offset = outputIndex * uniforms.reduceSize;\n\n          var bestValue = f32(${tn[i]});\n          let Length = uniforms.reduceSize;\n          for (var k = local_idx; k < Length; k = k + 32) {\n           let candidate = f32(${l.getByOffset("offset + k")});\n           bestValue = ${Ze[i]};\n          }\n          aBestValues[local_idx] = bestValue;\n          workgroupBarrier();\n\n         var reduceSize = min(Length, 32u);\n         for (var currentSize = reduceSize / 2u; reduceSize > 1u;\n             currentSize = reduceSize / 2u) {\n           let interval = DIV_CEIL(reduceSize, 2u);\n           if (local_idx < currentSize) {\n            let candidate = aBestValues[local_idx + interval];\n            bestValue = ${Je[i]};\n            aBestValues[local_idx] = bestValue;\n           }\n           reduceSize = interval;\n           workgroupBarrier();\n         }\n\n         if (local_idx == 0u) {\n          ${c.setByOffset("outputIndex","mean"===i?`${c.type.storage}(bestValue / f32(uniforms.reduceSize))`:`${c.type.storage}(${en[i]})`)};\n         }\n        }`,getRunData:()=>({outputs:[{dims:o,dataType:r}],dispatchGroup:{x:u},programUniforms:[{type:12,data:h}]})}},hn=(t,e,n,i)=>{let r=1===t.inputs.length?n:kn(t.inputs,n),o=r.axes;0===o.length&&!r.noopWithEmptyAxes&&(o=t.inputs[0].dims.map(((t,e)=>e)));let s=ke.normalizeAxes(o,t.inputs[0].dims.length),a=s,u=t.inputs[0],h=an(a,t.inputs[0].dims.length);h.length>0&&(u=t.compute(Ke(t.inputs[0],h),{inputs:[0],outputs:[-1]})[0],a=nn(a.length,u.dims.length));let[l,c]=rn(u.dims,a),f=l;r.keepDims&&(f=on(l,s)),t.compute(un(e,{hint:r.cacheKey,inputDependencies:["type"]},[u],i,t.inputs[0].dataType,f,c),{inputs:[u]})},ln=(t,e)=>{hn(t,"ReduceMeanShared",e,"mean")},cn=(t,e)=>{hn(t,"ReduceL1Shared",e,"l1")},fn=(t,e)=>{hn(t,"ReduceL2Shared",e,"l2")},dn=(t,e)=>{hn(t,"ReduceLogSumExpShared",e,"logSumExp")},pn=(t,e)=>{hn(t,"ReduceMaxShared",e,"max")},vn=(t,e)=>{hn(t,"ReduceMinShared",e,"min")},mn=(t,e)=>{hn(t,"ReduceProdShared",e,"prod")},yn=(t,e)=>{hn(t,"ReduceSumShared",e,"sum")},wn=(t,e)=>{hn(t,"ReduceSumSquareShared",e,"sumSquare")},gn=(t,e)=>{hn(t,"ReduceLogSumShared",e,"logSum")}})),Cu=H((()=>{yu(),$u(),ku(),Su(),Mu(),bn=t=>{if(!t||0===t.length||t.length>2)throw new Error("Reduce op requires 1 or 2 inputs.");if(2===t.length&&1!==t[1].dims.length)throw new Error("Invalid axes input dims.")},_n=t=>["","",`var value = ${t.getByIndices("input_indices")};`,""],xn=(t,e,n,i,r,o,s=!1,a=!1)=>{let u=[],h=n[0].dims,l=h.length,c=ke.normalizeAxes(r,l),f=!a&&0===c.length;h.forEach(((t,e)=>{f||c.indexOf(e)>=0?s&&u.push(1):u.push(t)}));let d=u.length,p=ke.size(u);return{name:t,shaderCache:e,getShaderSource:t=>{let e=[],r=Ue("_A",n[0].dataType,l),a=qe("output",o,d),u=i(r,a,c),p=u[2];for(let t=0,n=0;t<l;t++)f||c.indexOf(t)>=0?(s&&n++,p=`for(var j${t}: u32 = 0; j${t} < ${h[t]}; j${t}++) {\n                  ${u[2].includes("last_index")?`let last_index = j${t};`:""}\n                  ${r.indicesSet("input_indices",t,`j${t}`)}\n                  ${p}\n                }`):(e.push(`${r.indicesSet("input_indices",t,a.indicesGet("output_indices",n))};`),n++);return`\n\n        ${t.registerUniform("output_size","u32").declareVariables(r,a)}\n\n        ${t.mainStart()}\n          ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n          var input_indices: ${r.type.indices};\n          let output_indices = ${a.offsetToIndices("global_idx")};\n\n          ${e.join("\n")}\n          ${u[0]}       // init ops for reduce max/min\n          ${u[1]}\n          ${p}\n          ${u[3]}\n          ${4===u.length?a.setByOffset("global_idx","value"):u.slice(4).join("\n")}\n        }`},getRunData:()=>({outputs:[{dims:u,dataType:o}],dispatchGroup:{x:Math.ceil(p/64)},programUniforms:[{type:12,data:p},...Te(h,u)]})}},kn=(t,e)=>{let n=[];return t[1].dims[0]>0&&t[1].getBigInt64Array().forEach((t=>n.push(Number(t)))),be({axes:n,keepDims:e.keepDims,noopWithEmptyAxes:e.noopWithEmptyAxes})},$n=(t,e,n,i)=>{let r=t.inputs,o=1===r.length?n:kn(r,n);t.compute(xn(e,{hint:o.cacheKey,inputDependencies:["rank"]},[r[0]],o.noopWithEmptyAxes&&0===o.axes.length?_n:i,o.axes,r[0].dataType,o.keepDims,o.noopWithEmptyAxes),{inputs:[0]})},Sn=(t,e)=>{bn(t.inputs),$n(t,"ReduceLogSum",e,((t,e)=>[`var value = ${e.type.storage}(0);`,"",`value += ${t.getByIndices("input_indices")};`,"value = log(value);"]))},En=(t,e)=>{bn(t.inputs),$n(t,"ReduceL1",e,((t,e)=>[`var value = ${e.type.storage}(0);`,"",`value += abs(${t.getByIndices("input_indices")});`,""]))},Mn=(t,e)=>{bn(t.inputs),$n(t,"ReduceL2",e,((t,e)=>[`var t = ${e.type.value}(0); var value = ${e.type.value}(0);`,"",`t = ${t.getByIndices("input_indices")}; value += (t * t);`,"value = sqrt(value);"]))},Cn=(t,e)=>{bn(t.inputs),$n(t,"ReduceLogSumExp",e,((t,e)=>[`var value = ${e.type.storage}(0);`,"",`value += exp(${t.getByIndices("input_indices")});`,"value = log(value);"]))},An=(t,e)=>{bn(t.inputs),$n(t,"ReduceMax",e,((t,e,n)=>{let i=[];for(let e=0;e<t.rank;e++)(n.indexOf(e)>=0||0===n.length)&&i.push(t.indicesSet("input_indices",e,0));return[`${i.join("\n")}`,`var value = ${t.getByIndices("input_indices")};`,`value = max(value, ${t.getByIndices("input_indices")});`,""]}))},On=(t,e)=>{bn(t.inputs),$n(t,"ReduceMean",e,((e,n,i)=>{let r=1;for(let n=0;n<e.rank;n++)(i.indexOf(n)>=0||0===i.length)&&(r*=t.inputs[0].dims[n]);return["var sum = f32(0);","",`sum += f32(${e.getByIndices("input_indices")});`,`let value = ${n.type.value}(sum / ${r});`]}))},In=(t,e)=>{bn(t.inputs),$n(t,"ReduceMin",e,((t,e,n)=>{let i=[];for(let e=0;e<t.rank;e++)(n.indexOf(e)>=0||0===n.length)&&i.push(`input_indices[${e}] = 0;`);return[`${i.join("\n")}`,`var value = ${t.getByIndices("input_indices")};`,`value = min(value, ${t.getByIndices("input_indices")});`,""]}))},Tn=(t,e)=>{bn(t.inputs),$n(t,"ReduceProd",e,((t,e)=>[`var value = ${e.type.storage}(1);`,"",`value *= ${t.getByIndices("input_indices")};`,""]))},zn=(t,e)=>{bn(t.inputs),$n(t,"ReduceSum",e,((t,e)=>[`var value = ${e.type.storage}(0);`,"",`value += ${t.getByIndices("input_indices")};`,""]))},Rn=(t,e)=>{bn(t.inputs),$n(t,"ReduceSumSquare",e,((t,e)=>[`var t = ${e.type.value}(0); var value = ${e.type.value}(0);`,"",`t = ${t.getByIndices("input_indices")}; value += t * t;`,""]))},Fn=(t,e,n)=>{if(0===e.length)return n;let i=1,r=1;for(let n=0;n<e.length;n++)-1===e.indexOf(n)?i*=t[n]:r*=t[n];return r<32&&i>1024},Dn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?On(t,e):ln(t,e)},Pn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?En(t,e):cn(t,e)},Nn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?Mn(t,e):fn(t,e)},Un=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?Cn(t,e):dn(t,e)},qn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?An(t,e):pn(t,e)},jn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?In(t,e):vn(t,e)},Ln=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?Tn(t,e):mn(t,e)},Bn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?zn(t,e):yn(t,e)},Hn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?Rn(t,e):wn(t,e)},Wn=(t,e)=>{Fn(t.inputs[0].dims,e.axes,e.noopWithEmptyAxes)?Sn(t,e):gn(t,e)}})),Au=H((()=>{yu(),ku(),Cu(),Vn=t=>{if(!t||0===t.length||t.length>2)throw new Error("ArgMinMaxOp op requires 1 or 2 inputs.");if(1!==t[0].dataType)throw new Error("Invalid input type.")},Gn=(t,e)=>{Vn(t.inputs),t.compute(xn("ArgMin",{hint:e.cacheKey,inputDependencies:["rank"]},[t.inputs[0]],((t,n,i)=>{let r=[];for(let e=0;e<t.rank;e++)(i.indexOf(e)>=0||0===i.length)&&r.push(`input_indices[${e}] = 0;`);return[`${r.join("\n")}`,`var value = ${t.getByIndices("input_indices")};\nvar best_index : i32 = 0;`,`if (${t.getByIndices("input_indices")} ${e.selectLastIndex>0?"<=":"<"} value) {\n         value = ${t.getByIndices("input_indices")};\n         best_index = i32(last_index);\n       }`,"",n.setByOffset("global_idx","best_index")]}),[e.axis],7,e.keepDims),{inputs:[0]})},Yn=(t,e)=>{Vn(t.inputs),t.compute(xn("argMax",{hint:e.cacheKey,inputDependencies:["rank"]},[t.inputs[0]],((t,n,i)=>{let r=[];for(let e=0;e<t.rank;e++)(i.indexOf(e)>=0||0===i.length)&&r.push(`input_indices[${e}] = 0;`);return[`${r.join("\n")}`,`var value = ${t.getByIndices("input_indices")};\nvar best_index : i32 = 0;`,`if (${t.getByIndices("input_indices")} ${e.selectLastIndex>0?">=":">"} value) {\n         value = ${t.getByIndices("input_indices")};\n         best_index = i32(last_index);\n       }`,"",n.setByOffset("global_idx","best_index")]}),[e.axis],7,e.keepDims),{inputs:[0]})},Kn=t=>be(t)})),Ou=H((()=>{yu(),_u(),Su(),Xn=(t,e)=>{let n=t[0],i=t[1],r=t[2],o=t[3],s=t[4],a=t[5];if(s&&a)throw new Error("Attention cannot have both past and relative_position_bias");if(3!==n.dims.length)throw new Error('Input "input" must have 3 dimensions');let u=n.dims[0],h=n.dims[1],l=n.dims[2];if(1!==r.dims.length)throw new Error('Input "bias" is expected to have 1 dimensions');if(2!==i.dims.length)throw new Error('Input "weights" is expected to have 2 dimensions');if(i.dims[0]!==l)throw new Error("Input 1 dimension 0 should have same length as dimension 2 of input 0");if(r.dims[0]!==i.dims[1])throw new Error('Input "bias" dimension 0 should have same length as dimension 1 of input "weights"');let c=r.dims[0]/3,f=c,d=f;if(e.qkvHiddenSizes.length>0){if(3!==e.qkvHiddenSizes.length)throw new Error("qkv_hidden_sizes attribute should have 3 elements");for(let t of e.qkvHiddenSizes)if(t%e.numHeads!=0)throw new Error("qkv_hidden_sizes should be divisible by num_heads");c=e.qkvHiddenSizes[0],f=e.qkvHiddenSizes[1],d=e.qkvHiddenSizes[2]}let p=h;if(c!==f)throw new Error("qkv_hidden_sizes first element should be same as the second");if(r.dims[0]!==c+f+d)throw new Error('Input "bias" dimension 0 should have same length as sum of Q/K/V hidden sizes');let v=0;if(s){if(f!==d)throw new Error('Input "past" expect k_hidden_size == v_hidden_size');if(5!==s.dims.length)throw new Error('Input "past" must have 5 dimensions');if(2!==s.dims[0])throw new Error('Input "past" first dimension must be 2');if(s.dims[1]!==u)throw new Error('Input "past" second dimension must be batch_size');if(s.dims[2]!==e.numHeads)throw new Error('Input "past" third dimension must be num_heads');if(s.dims[4]!==f/e.numHeads)throw new Error('Input "past" fifth dimension must be k_hidden_size / num_heads');e.pastPresentShareBuffer||(v=s.dims[3])}let m=p+v;if(o)throw new Error("Mask not supported");if(s)throw new Error("past is not supported");return{batchSize:u,sequenceLength:h,pastSequenceLength:v,kvSequenceLength:p,totalSequenceLength:m,maxSequenceLength:-1,inputHiddenSize:l,hiddenSize:c,vHiddenSize:d,headSize:Math.floor(c/e.numHeads),vHeadSize:Math.floor(d/e.numHeads),numHeads:e.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:e.maskFilterValue,maskType:0,scale:e.scale,broadcastResPosBias:!1,passPastInKv:!1,qkvFormat:1}},Qn=(t,e,n,i)=>{let r=ze(i),o=64,s=i/r;s<o?o=1:s/8<64&&(o=Math.ceil(s/8));let a=Math.ceil(i/r/o),u=[{type:e.dataType,data:1/i},{type:12,data:s},{type:12,data:a}],h=Oe(e.dataType,r),l=Ie(1,r);return{name:"AttentionProbsSoftmax",shaderCache:{hint:`${o};${h};${r}`},getShaderSource:t=>{let n=qe("x",e.dataType,e.dims,r),i=[{name:"d_inv",type:Ie(e.dataType)},{name:"d_comp",type:"u32"},{name:"elements_per_thread",type:"u32"}];return`\n  var<workgroup> thread_max: array<f32, ${o}>;\n  var<workgroup> thread_sum: array<f32, ${o}>;\n  ${t.registerUniforms(i).declareVariables(n)}\n  ${t.mainStart([o,1,1])}\n    let local_offset = local_idx * uniforms.elements_per_thread;\n    let offset = workgroup_id.x * uniforms.d_comp + local_offset;\n\n    var thread_max_vector = ${l}(-3.402823e+38f);\n    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < uniforms.d_comp; i++) {\n      thread_max_vector = max(${l}(x[offset + i]), thread_max_vector);\n    }\n    thread_max[local_idx] = ${(()=>{switch(r){case 1:return"thread_max_vector";case 2:return"max(thread_max_vector.x, thread_max_vector.y)";case 4:return"max(max(thread_max_vector.x, thread_max_vector.y), max(thread_max_vector.z, thread_max_vector.w))";default:throw new Error(`Unsupported components: ${r}`)}})()};\n    workgroupBarrier();\n\n    var max_value =  f32(-3.402823e+38f);\n    for (var i = 0u; i < ${o}; i++) {\n      max_value = max(thread_max[i], max_value);\n    }\n\n    var sum_vector = ${l}(0);\n    for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < uniforms.d_comp; i++) {\n      sum_vector += exp(${l}(x[offset + i]) - max_value);\n    }\n    thread_sum[local_idx] = ${(()=>{switch(r){case 1:return"sum_vector";case 2:return"sum_vector.x + sum_vector.y";case 4:return"sum_vector.x + sum_vector.y + sum_vector.z + sum_vector.w";default:throw new Error(`Unsupported components: ${r}`)}})()};\n    workgroupBarrier();\n\n    var sum: f32 = 0;\n    for (var i = 0u; i < ${o}; i++) {\n      sum += thread_sum[i];\n    }\n\n    if (sum == 0) {\n      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < uniforms.d_comp; i++) {\n        x[offset + i] = ${n.type.value}(uniforms.d_inv);\n      }\n    } else {\n      for (var i: u32 = 0; i < uniforms.elements_per_thread && i + local_offset < uniforms.d_comp; i++) {\n        var f32input = ${l}(x[offset + i]);\n        x[offset + i] = ${n.type.value}(exp(f32input - max_value) / sum);\n      }\n    }\n  }`},getRunData:()=>({outputs:[],dispatchGroup:{x:n},programUniforms:u})}},Zn=(t,e,n,i,r,o,s,a)=>{let u=a+o.kvSequenceLength,h=[o.batchSize,o.numHeads,o.sequenceLength,u],l=void 0===o.kvNumHeads&&t.outputCount>1,c=l?[o.batchSize,o.numHeads,u,o.headSize]:void 0,f=0===s.scale?1/Math.sqrt(o.headSize):s.scale,d=ze(o.headSize),p=o.headSize/d,v={x:Math.ceil(u/12),y:Math.ceil(o.sequenceLength/12),z:o.batchSize*o.numHeads},m=[{type:12,data:o.sequenceLength},{type:12,data:p},{type:12,data:u},{type:12,data:o.numHeads},{type:1,data:f},{type:12,data:a},{type:12,data:o.kvSequenceLength}],y=["type","type"];i&&y.push("type"),r&&y.push("type");let w=[{dims:h,dataType:e.dataType,gpuDataType:0}];return l&&w.push({dims:c,dataType:e.dataType,gpuDataType:0}),{name:"AttentionProbs",shaderCache:{hint:`${d};${void 0!==r};${void 0!==i};${t.outputCount}`,inputDependencies:y},getRunData:()=>({outputs:w,dispatchGroup:v,programUniforms:m}),getShaderSource:t=>{let o=Ue("q",e.dataType,e.dims,d),s=[o,Ue("key",n.dataType,n.dims,d)];if(i){let t=Ue("past_key",i.dataType,i.dims,d);s.push(t)}r&&s.push(Ue("relative_position_bias",r.dataType,r.dims));let a=qe("output",e.dataType,h),u=[a];l&&u.push(qe("present_key",e.dataType,c,d));let f=Ie(1,d);return`\n  const TILE_SIZE = 12u;\n\n  var<workgroup> tileQ: array<${o.type.storage}, 144>;\n  var<workgroup> tileK: array<${o.type.storage}, 144>;\n  ${t.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"alpha",type:"f32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"}]).declareVariables(...s,...u)}\n  ${t.mainStart([12,12,1])}\n    // x holds the N and y holds the M\n    let headIdx = workgroup_id.z;\n    let m = workgroup_id.y * TILE_SIZE;\n    let n = workgroup_id.x * TILE_SIZE;\n    let qOffset = uniforms.M * uniforms.K * headIdx + m * uniforms.K;\n    ${i&&l?"\n    let kOffset = uniforms.kv_sequence_length * uniforms.K * headIdx;\n    let pastKeyOffset = uniforms.past_sequence_length * uniforms.K * headIdx;":"\n    let kOffset = uniforms.N * uniforms.K * headIdx + n * uniforms.K;"}\n    ${l?"let presentKeyOffset = headIdx * uniforms.N * uniforms.K;":""}\n    var value = ${f}(0);\n    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (global_id.y < uniforms.M && w + local_id.x < uniforms.K) {\n        tileQ[TILE_SIZE * local_id.y + local_id.x] = q[qOffset + local_id.y * uniforms.K + w + local_id.x];\n      }\n      if (n + local_id.y < uniforms.N && w + local_id.x < uniforms.K) {\n        var idx = TILE_SIZE * local_id.y + local_id.x;\n      ${i&&l?"\n              if (n + local_id.y < uniforms.past_sequence_length) {\n                tileK[idx] = past_key[pastKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x];\n              } else {\n                tileK[idx] =\n                         key[kOffset + (n + local_id.y - uniforms.past_sequence_length) * uniforms.K + w + local_id.x];\n              }":"tileK[idx] = key[kOffset + local_id.y * uniforms.K + w + local_id.x];"}\n      ${l?"present_key[presentKeyOffset + (n + local_id.y) * uniforms.K + w + local_id.x] = tileK[idx];":""}\n      }\n      workgroupBarrier();\n\n      for (var k: u32 = 0u; k < TILE_SIZE && w+k < uniforms.K; k++) {\n        value += ${f}(tileQ[TILE_SIZE * local_id.y + k] * tileK[TILE_SIZE * local_id.x + k]);\n      }\n\n      workgroupBarrier();\n    }\n\n    let headOffset = headIdx * uniforms.M * uniforms.N;\n    if (global_id.y < uniforms.M && global_id.x < uniforms.N) {\n      let outputIdx = headOffset + global_id.y * uniforms.N + global_id.x;\n      var sum: f32 = ${(()=>{switch(d){case 1:return"value";case 2:return"value.x + value.y";case 4:return"value.x + value.y + value.z + value.w";default:throw new Error(`Unsupported components: ${d}`)}})()};\n        output[outputIdx] = ${a.type.value} (sum * uniforms.alpha) + ${r?"relative_position_bias[outputIdx]":"0.0"};\n    }\n  }`}}},Jn=(t,e,n,i,r,o)=>{let s=o+r.kvSequenceLength,a=r.nReps?r.nReps:1,u=r.vHiddenSize*a,h=null==r.kvNumHeads&&t.outputCount>1,l=h?[r.batchSize,r.numHeads,s,r.headSize]:void 0,c=[r.batchSize,r.sequenceLength,u],f={x:Math.ceil(r.vHeadSize/12),y:Math.ceil(r.sequenceLength/12),z:r.batchSize*r.numHeads},d=[{type:12,data:r.sequenceLength},{type:12,data:s},{type:12,data:r.vHeadSize},{type:12,data:r.numHeads},{type:12,data:u},{type:12,data:o},{type:12,data:r.kvSequenceLength}],p=i?["type","type","type"]:["type","type"],v=[{dims:c,dataType:e.dataType,gpuDataType:0}];return h&&v.push({dims:l,dataType:e.dataType,gpuDataType:0}),{name:"AttentionScore",shaderCache:{hint:`${void 0!==i};${t.outputCount}`,inputDependencies:p},getRunData:()=>({outputs:v,dispatchGroup:f,programUniforms:d}),getShaderSource:t=>{let r=Ue("probs",e.dataType,e.dims),o=[r,Ue("v",n.dataType,n.dims)];i&&o.push(Ue("past_value",i.dataType,i.dims));let s=[qe("output",e.dataType,c)];return h&&s.push(qe("present_value",e.dataType,l)),`\n  const TILE_SIZE = 12u;\n  var<workgroup> tileQ: array<${r.type.value}, 144>;\n  var<workgroup> tileK: array<${r.type.value}, 144>;\n  ${t.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"v_hidden_size",type:"u32"},{name:"past_sequence_length",type:"u32"},{name:"kv_sequence_length",type:"u32"}]).declareVariables(...o,...s)}\n  ${t.mainStart([12,12,1])}\n   let headIdx = workgroup_id.z;\n   let m = global_id.y;\n   let n = global_id.x;\n\n   let offsetA = headIdx * (uniforms.M * uniforms.K) + m * uniforms.K;\n   ${i&&h?"\n    let pastValueOffset = headIdx * uniforms.N * uniforms.past_sequence_length + n;\n    let vOffset = headIdx * uniforms.N * uniforms.kv_sequence_length + n;\n      ":"\n   let offsetB = headIdx * uniforms.N * uniforms.K + n;\n            "}\n    ${h?"let presentValueOffset = headIdx * uniforms.N * uniforms.K + n;":""}\n   var value = ${r.type.storage}(0);\n   for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (m < uniforms.M && w + local_id.x < uniforms.K) {\n        tileQ[TILE_SIZE * local_id.y + local_id.x] = probs[offsetA + w + local_id.x];\n      }\n      if (n < uniforms.N && w + local_id.y < uniforms.K) {\n        var idx = TILE_SIZE * local_id.y + local_id.x;\n        ${i&&h?"\n        if (w + local_id.y < uniforms.past_sequence_length) {\n          tileK[idx] = past_value[pastValueOffset + (w + local_id.y) * uniforms.N];\n        } else {\n          tileK[idx] = v[vOffset + (w + local_id.y - uniforms.past_sequence_length) * uniforms.N];\n        }\n      ":"\n        tileK[idx] = v[offsetB + (w + local_id.y) * uniforms.N];\n      "}\n        ${h?"present_value[presentValueOffset + (w + local_id.y) * uniforms.N] = tileK[idx];":""}\n      }\n     workgroupBarrier();\n     for (var k: u32 = 0u; k < TILE_SIZE && w+k < uniforms.K; k++) {\n       value += tileQ[TILE_SIZE * local_id.y + k] * tileK[TILE_SIZE * k + local_id.x];\n     }\n     workgroupBarrier();\n   }\n\n   // we need to transpose output from BNSH_v to BSND_v\n   let batchIdx = workgroup_id.z / uniforms.num_heads;\n   let currentBatchHeadNumber = workgroup_id.z % uniforms.num_heads;\n   if (m < uniforms.M && n < uniforms.N) {\n     let outputIdx = batchIdx * uniforms.M * uniforms.v_hidden_size + m * uniforms.v_hidden_size\n       + currentBatchHeadNumber * uniforms.N + n;\n     output[outputIdx] = value;\n   }\n  }`}}},ti=(t,e,n,i,r,o,s,a,u,h,l)=>{let c=t.outputCount,f=void 0!==h.kvNumHeads||c>1?h.pastSequenceLength:0,d=f+h.kvSequenceLength,p=void 0===h.kvNumHeads&&c>1&&s?[e,n,s]:[e,n];u&&p.push(u);let v=t.compute(Zn(t,e,n,c>1?s:void 0,u,h,l,f),{inputs:p,outputs:void 0===h.kvNumHeads&&c>1?[-1,1]:[-1]})[0];t.compute(Qn(0,v,h.batchSize*h.numHeads*h.sequenceLength,d),{inputs:[v],outputs:[]});let m=void 0===h.kvNumHeads&&c>1&&a?[v,i,a]:[v,i];t.compute(Jn(t,v,i,c>1&&a?a:void 0,h,f),{inputs:m,outputs:void 0===h.kvNumHeads&&c>1?[0,2]:[0]})},ei=(t,e)=>{let n=[e.batchSize,e.numHeads,e.sequenceLength,e.headSize],i=e.sequenceLength,r=e.inputHiddenSize,o=e.headSize,s={x:Math.ceil(e.headSize/12),y:Math.ceil(e.sequenceLength/12),z:e.batchSize*e.numHeads},a=[t.inputs[0],t.inputs[1],t.inputs[2]],u=[{type:12,data:i},{type:12,data:r},{type:12,data:o},{type:12,data:e.numHeads},{type:12,data:e.headSize},{type:12,data:e.hiddenSize},{type:12,data:e.hiddenSize+e.hiddenSize+e.vHiddenSize}];return t.compute({name:"AttentionPrepare",shaderCache:{inputDependencies:["type","type","type"]},getRunData:()=>({outputs:[{dims:n,dataType:t.inputs[0].dataType,gpuDataType:0},{dims:n,dataType:t.inputs[0].dataType,gpuDataType:0},{dims:n,dataType:t.inputs[0].dataType,gpuDataType:0}],dispatchGroup:s,programUniforms:u}),getShaderSource:t=>{let e=qe("output_q",a[0].dataType,n),i=qe("output_k",a[0].dataType,n),r=qe("output_v",a[0].dataType,n),o=Ue("input",a[0].dataType,a[0].dims),s=Ue("weight",a[1].dataType,a[1].dims),u=Ue("bias",a[2].dataType,a[2].dims),h=o.type.storage;return`\n  const TILE_SIZE = 12u;\n  var<workgroup> tileInput: array<${h}, 144>;\n  var<workgroup> tileWeightQ: array<${h}, 144>;\n  var<workgroup> tileWeightK: array<${h}, 144>;\n  var<workgroup> tileWeightV: array<${h}, 144>;\n  ${t.registerUniforms([{name:"M",type:"u32"},{name:"K",type:"u32"},{name:"N",type:"u32"},{name:"num_heads",type:"u32"},{name:"head_size",type:"u32"},{name:"hidden_size",type:"u32"},{name:"ldb",type:"u32"}]).declareVariables(o,s,u,e,i,r)}\n  ${t.mainStart([12,12,1])}\n    let batchIndex = workgroup_id.z / uniforms.num_heads;\n    let headNumber = workgroup_id.z % uniforms.num_heads;\n    let m = global_id.y;\n    let n = global_id.x;\n\n    let inputOffset = batchIndex * (uniforms.M * uniforms.K) + m * uniforms.K;\n    let biasOffsetQ = headNumber * uniforms.head_size;\n    let biasOffsetK = uniforms.hidden_size + biasOffsetQ;\n    let biasOffsetV = uniforms.hidden_size + biasOffsetK;\n\n    var valueQ = ${h}(0);\n    var valueK = ${h}(0);\n    var valueV = ${h}(0);\n    for (var w: u32 = 0u; w < uniforms.K; w += TILE_SIZE) {\n      if (m < uniforms.M && w + local_id.x < uniforms.K) {\n        tileInput[TILE_SIZE * local_id.y + local_id.x] = input[inputOffset + w + local_id.x];\n      }\n      if (n < uniforms.N && w + local_id.y < uniforms.K) {\n        let offset = n + (w + local_id.y) * uniforms.ldb;\n        tileWeightQ[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetQ + offset];\n        tileWeightK[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetK + offset];\n        tileWeightV[TILE_SIZE * local_id.y + local_id.x] = weight[biasOffsetV + offset];\n      }\n      workgroupBarrier();\n      for (var k: u32 = 0u; k<TILE_SIZE && w+k < uniforms.K; k++) {\n        let inputTileOffset = TILE_SIZE * local_id.y + k;\n        let weightTileOffset = TILE_SIZE * k + local_id.x;\n        valueQ += tileInput[inputTileOffset] * tileWeightQ[weightTileOffset];\n        valueK += tileInput[inputTileOffset] * tileWeightK[weightTileOffset];\n        valueV += tileInput[inputTileOffset] * tileWeightV[weightTileOffset];\n      }\n\n      workgroupBarrier();\n    }\n\n    let headOffset = (m * uniforms.N + n) % uniforms.head_size;\n    valueQ += bias[headOffset + biasOffsetQ];\n    valueK += bias[headOffset + biasOffsetK];\n    valueV += bias[headOffset + biasOffsetV];\n\n    let offset = workgroup_id.z * uniforms.M * uniforms.N;\n    if (m < uniforms.M && n < uniforms.N) {\n      let outputIdx = offset + m * uniforms.N + n;\n      output_q[outputIdx] = valueQ;\n      output_k[outputIdx] = valueK;\n      output_v[outputIdx] = valueV;\n    }\n  }`}},{inputs:a,outputs:[-1,-1,-1]})},ni=(t,e)=>{let n=Xn(t.inputs,e),[i,r,o]=ei(t,n);return ti(t,i,r,o,t.inputs[4],void 0,void 0,void 0,t.inputs[5],n,e)}})),Iu=H((()=>{pt(),yu(),$u(),ku(),Su(),ii=(t,e)=>{if(!t||5!==t.length)throw new Error("BatchNormalization requires 5 inputs");let n=(t,e,n)=>{let i=e.length;if(i!==t.length)throw new Error(`${n}: num dimensions != ${i}`);e.forEach(((e,i)=>{if(e!==t[i])throw new Error(`${n}: dim[${i}] do not match`)}))};if(t[0].dims.length>1){let i="NHWC"===e.format?e.spatial?t[0].dims.slice(-1):t[0].dims.slice(-1).concat(t[0].dims.slice(1,t[0].dims.length-1)):t[0].dims.slice(1,e.spatial?2:void 0);n(t[1].dims,i,"Invalid input scale"),n(t[2].dims,i,"Invalid input B"),n(t[3].dims,i,"Invalid input mean"),n(t[4].dims,i,"Invalid input var")}else n(t[1].dims,[1],"Invalid input scale"),n(t[2].dims,[1],"Invalid input B"),n(t[3].dims,[1],"Invalid input mean"),n(t[4].dims,[1],"Invalid input var")},ri=(t,e)=>{let{epsilon:n,spatial:i,format:r}=e,o=t[0].dims,s=i?ze(o[o.length-1]):1,a="NHWC"===r&&o.length>1?s:1,u=ke.size(o)/s,h=i,l=h?o.length:o,c=Ue("x",t[0].dataType,t[0].dims,s),f=Ue("scale",t[1].dataType,t[1].dims,a),d=Ue("bias",t[2].dataType,t[2].dims,a),p=Ue("inputMean",t[3].dataType,t[3].dims,a),v=Ue("inputVar",t[4].dataType,t[4].dims,a),m=qe("y",t[0].dataType,l,s);return{name:"BatchNormalization",shaderCache:{hint:`${e.epsilon}_${e.format}_${i}_${s}`,inputDependencies:h?["rank","type","type","type","type"]:void 0},getShaderSource:t=>`\n  const epsilon = ${n};\n  ${t.registerUniform("outputSize","u32").declareVariables(c,f,d,p,v,m)}\n  ${t.mainStart()}\n  ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n    var outputIndices = ${m.offsetToIndices(`global_idx * ${s}`)};\n    ${(()=>{let t="";if(i)t=`let cOffset = ${1===o.length?"0u":"NHWC"===r?`outputIndices[${o.length-1}] / ${s}`:"outputIndices[1]"};`;else if("NCHW"===r)t=`\n            ${m.indicesSet("outputIndices","0","0")}\n            let cOffset = ${m.indicesToOffset("outputIndices")};`;else{t=`var cIndices = ${f.type.indices}(0);\n                       cIndices[0] = outputIndices[${o.length-1}];`;for(let e=1;e<f.rank;e++)t+=`cIndices[${e}] = outputIndices[${e}];`;t+=`let cOffset = ${f.indicesToOffset("cIndices")};`}return t})()}\n    let scale = ${f.getByOffset("cOffset")};\n    let bias = ${d.getByOffset("cOffset")};\n    let inputMean = ${p.getByOffset("cOffset")};\n    let inputVar = ${v.getByOffset("cOffset")};\n    let x = ${c.getByOffset("global_idx")};\n    let value = (x - inputMean) * inverseSqrt(inputVar + epsilon) * scale + bias;\n    ${m.setByOffset("global_idx","value")}\n  }`,getRunData:()=>({outputs:[{dims:t[0].dims,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(u/64)},programUniforms:h?[{type:12,data:u},...Te(o)]:[{type:12,data:u}]})}},oi=t=>be(t),si=(t,e)=>{let{inputs:n,outputCount:i}=t,r=oi({...e,outputCount:i});if(v.webgpu.validateInputContent&&ii(n,r),e.trainingMode)throw new Error("BatchNormalization trainingMode is not supported yet.");t.compute(ri(n,r))}})),Tu=H((()=>{$u(),Su(),ai=t=>{if(3!==t[0].dims.length)throw new Error("input should have 3 dimensions");if(![320,640,1280].includes(t[0].dims[2]))throw new Error("number of channels should be 320, 640 or 1280");if(1!==t[1].dims.length)throw new Error("bias is expected to have 1 dimensions");if(t[0].dims[2]!==t[1].dims[0])throw new Error("last dimension of input and bias are not the same")},ui=t=>{let e=t[0].dims,n=t[0].dims[2],i=ke.size(e)/4,r=t[0].dataType,o=Ue("input",r,e,4),s=Ue("bias",r,[n],4),a=Ue("residual",r,e,4),u=qe("output",r,e,4);return{name:"BiasAdd",getRunData:()=>({outputs:[{dims:e,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(i/64)}}),getShaderSource:t=>`\n  const channels = ${n}u / 4;\n  ${t.declareVariables(o,s,a,u)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes(i)}\n    let value = ${o.getByOffset("global_idx")}\n      + ${s.getByOffset("global_idx % channels")} + ${a.getByOffset("global_idx")};\n    ${u.setByOffset("global_idx","value")}\n  }`}},hi=t=>{ai(t.inputs),t.compute(ui(t.inputs))}})),zu=H((()=>{yu(),$u(),ku(),Su(),li=(t,e,n,i,r,o)=>{let s=Math.ceil(e/4),a="";a="string"==typeof r?`${r}(a)`:r("a");let u=Ue("inputData",n,[s],4),h=qe("outputData",i,[s],4);return`\n      ${t.registerUniform("vec_size","u32").declareVariables(u,h)}\n\n  ${o??""}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n\n    let a = ${u.getByOffset("global_idx")};\n    ${h.setByOffset("global_idx",a)}\n  }`},ci=(t,e,n,i,r,o=t.dataType)=>({name:e,shaderCache:{hint:r,inputDependencies:["type"]},getShaderSource:e=>li(e,ke.size(t.dims),t.dataType,o,n,i),getRunData:e=>({outputs:[{dims:t.dims,dataType:o}],dispatchGroup:{x:Math.ceil(ke.size(e[0].dims)/64/4)},programUniforms:[{type:12,data:Math.ceil(ke.size(t.dims)/4)}]})}),fi=t=>{t.compute(ci(t.inputs[0],"Abs","abs"))},di=t=>{t.compute(ci(t.inputs[0],"Acos","acos"))},pi=t=>{t.compute(ci(t.inputs[0],"Acosh","acosh"))},vi=t=>{t.compute(ci(t.inputs[0],"Asin","asin"))},mi=t=>{t.compute(ci(t.inputs[0],"Asinh","asinh"))},yi=t=>{t.compute(ci(t.inputs[0],"Atan","atan"))},wi=t=>{t.compute(ci(t.inputs[0],"Atanh","atanh"))},gi=t=>be(t),bi=(t,e)=>{let n;switch(e.to){case 10:n="vec4<f16>";break;case 1:n="vec4<f32>";break;case 12:n="vec4<u32>";break;case 6:n="vec4<i32>";break;case 9:n="vec4<bool>";break;default:throw new RangeError(`not supported type (specified in attribute 'to' from 'Cast' operator): ${e.to}`)}t.compute(ci(t.inputs[0],"Cast",n,void 0,e.cacheKey,e.to))},_i=t=>{let e=t.length>=2&&0!==t[1].data?t[1].getFloat32Array()[0]:Ee,n=t.length>=3&&0!==t[2].data?t[2].getFloat32Array()[0]:Me;return be({min:e,max:n})},xi=(t,e)=>{let n=1===t.inputs.length?e:_i(t.inputs),i=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"Clip",(t=>`clamp(${t}, clip_min_, clip_max_)`),`\n    const clip_min_: vec4<${i}> = vec4(${i}(${n.min}));\n    const clip_max_: vec4<${i}> = vec4(${i}(${n.max}));\n`,n.cacheKey),{inputs:[0]})},ki=t=>{t.compute(ci(t.inputs[0],"Ceil","ceil"))},$i=t=>{t.compute(ci(t.inputs[0],"Cos","cos"))},Si=t=>{t.compute(ci(t.inputs[0],"Cosh","cosh"))},Ei=t=>be(t),Mi=(t,e)=>{let n=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"Elu",(t=>`elu_vf32(${t})`),`\n  const elu_alpha_ = ${n}(${e.alpha});\n\n  fn elu_f32(a: ${n}) -> ${n} {\n  return select((exp(a) - 1.0) * elu_alpha_, a, a >= 0.0);\n  }\n\n  fn elu_vf32(v: vec4<${n}>) -> vec4<${n}> {\n  return vec4(elu_f32(v.x), elu_f32(v.y), elu_f32(v.z), elu_f32(v.w));\n  }`,e.cacheKey))},Ci=(t="f32")=>`\nconst r0: ${t} = 0.3275911;\nconst r1: ${t} = 0.254829592;\nconst r2: ${t} = -0.284496736;\nconst r3: ${t} = 1.421413741;\nconst r4: ${t} = -1.453152027;\nconst r5: ${t} = 1.061405429;\n\nfn erf_vf32(v: vec4<${t}>) -> vec4<${t}> {\n  let absv = abs(v);\n  let x = 1.0 / (1.0 + r0 * absv);\n  return sign(v) * (1.0 - ((((r5 * x + r4) * x + r3) * x + r2) * x + r1) * x * exp(-absv * absv));\n}`,Ai=t=>{let e=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"Erf",(t=>`erf_vf32(${t})`),Ci(e)))},Oi=t=>{t.compute(ci(t.inputs[0],"Exp","exp"))},Ii=t=>{t.compute(ci(t.inputs[0],"Floor","floor"))},Ti=t=>{let e=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"Gelu",(t=>`0.5 * ${t} * (1.0 + erf_vf32(${t} * 0.7071067811865475))`),Ci(e)))},zi=(t,e)=>{let n=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"LeakyRelu",(t=>`select(leaky_relu_alpha_ * ${t}, ${t}, ${t} >= vec4<${n}>(0.0))`),`const leaky_relu_alpha_ = ${n}(${e.alpha});`,e.cacheKey))},Ri=t=>{t.compute(ci(t.inputs[0],"Not",(t=>`!${t}`)))},Fi=t=>{t.compute(ci(t.inputs[0],"Neg",(t=>`-${t}`)))},Di=t=>{t.compute(ci(t.inputs[0],"Reciprocal",(t=>`1.0/${t}`)))},Pi=t=>{let e=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"Relu",(t=>`select(vec4<${e}>(0.0), ${t}, ${t} > vec4<${e}>(0.0))`)))},Ni=t=>{t.compute(ci(t.inputs[0],"Sigmoid",(t=>`(1.0 / (1.0 + exp(-${t})))`)))},Ui=t=>be(t),qi=(t,e)=>{let n=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"HardSigmoid",(t=>`max(vec4<${n}>(0.0), min(vec4<${n}>(1.0), ${e.alpha} * ${t} + vec4<${n}>(${e.beta})))`),void 0,e.cacheKey))},ji=t=>{t.compute(ci(t.inputs[0],"Sin","sin"))},Li=t=>{t.compute(ci(t.inputs[0],"Sinh","sinh"))},Bi=t=>{t.compute(ci(t.inputs[0],"Sqrt","sqrt"))},Hi=t=>{t.compute(ci(t.inputs[0],"Tan","tan"))},Wi=t=>`sign(${t}) * (1 - exp(-2 * abs(${t}))) / (1 + exp(-2 * abs(${t})))`,Vi=t=>{t.compute(ci(t.inputs[0],"Tanh",Wi))},Gi=(t="f32")=>`\nconst fast_gelu_a: ${t} = 0.5;\nconst fast_gelu_b: ${t} = 0.7978845608028654;\nconst fast_gelu_c: ${t} = 0.035677408136300125;\n\nfn tanh_v(v: vec4<${t}>) -> vec4<${t}> {\n  return ${Wi("v")};\n}\n`,Yi=t=>`(fast_gelu_a + fast_gelu_a * tanh_v(${t} * (fast_gelu_c * ${t} * ${t} + fast_gelu_b))) * ${t}`,Ki=t=>{let e=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"FastGelu",Yi,Gi(e),void 0,t.inputs[0].dataType))},Xi=(t,e)=>{let n=Ie(t.inputs[0].dataType);return t.compute(ci(t.inputs[0],"ThresholdedRelu",(t=>`select(vec4<${n}>(0.0), ${t}, ${t} > thresholded_relu_alpha_)`),`const thresholded_relu_alpha_ = vec4<${n}>(${e.alpha});`,e.cacheKey)),0},Qi=t=>{t.compute(ci(t.inputs[0],"Log","log"))},Zi=(t,e)=>`\nconst alpha = vec4<${t}>(${e});\nconst one = ${t}(1.0);\nconst zero = ${t}(0.0);\n\nfn quick_gelu_impl(x: vec4<${t}>) -> vec4<${t}> {\n  let v = x *alpha;\n  var x1 : vec4<${t}>;\n  for (var i = 0; i < 4; i = i + 1) {\n    if (v[i] >= zero) {\n      x1[i] = one / (one + exp(-v[i]));\n    } else {\n      x1[i] = one - one / (one + exp(v[i]));\n    }\n  }\n  return x * x1;\n}\n`,Ji=t=>`quick_gelu_impl(${t})`,tr=(t,e)=>{let n=Ie(t.inputs[0].dataType);t.compute(ci(t.inputs[0],"QuickGelu",Ji,Zi(n,e.alpha),e.cacheKey,t.inputs[0].dataType))}})),Ru=H((()=>{$u(),Su(),zu(),er=t=>{if(3!==t[0].dims.length)throw new Error("input should have 3 dimensions");if(![2560,5120,10240].includes(t[0].dims[2]))throw new Error("hidden state should be 2560, 5120 or 10240");if(1!==t[1].dims.length)throw new Error("bias is expected to have 1 dimensions");if(t[0].dims[2]!==t[1].dims[0])throw new Error("last dimension of input and bias are not the same")},nr=t=>{let e=t[0].dims.slice();e[2]=e[2]/2;let n=Ue("input",t[0].dataType,t[0].dims,4),i=Ue("bias",t[0].dataType,[t[0].dims[2]],4),r=qe("output",t[0].dataType,e,4),o=ke.size(e)/4,s=Oe(t[0].dataType);return{name:"BiasSplitGelu",getRunData:()=>({outputs:[{dims:e,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(o/64)}}),getShaderSource:e=>`\n  const M_SQRT2 = sqrt(2.0);\n  const halfChannels = ${t[0].dims[2]/4/2}u;\n\n  ${e.declareVariables(n,i,r)}\n\n  ${Ci(s)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes(o)}\n    let biasIdx = global_idx % halfChannels;\n    let batchIndex = global_idx / halfChannels;\n    let inputOffset = biasIdx + batchIndex * halfChannels * 2;\n    let valueLeft = input[inputOffset] + bias[biasIdx];\n    let valueRight = input[inputOffset + halfChannels] + bias[biasIdx + halfChannels];\n    let geluRight = valueRight * 0.5 * (erf_vf32(valueRight / M_SQRT2) + 1);\n\n    ${r.setByOffset("global_idx","valueLeft * geluRight")}\n  }`}},ir=t=>{er(t.inputs),t.compute(nr(t.inputs))}})),Fu=H((()=>{yu(),$u(),Su(),rr=(t,e,n,i,r,o,s,a,u,h,l,c)=>{let f,d;"string"==typeof a?f=d=(t,e)=>`${a}((${t}),(${e}))`:"function"==typeof a?f=d=a:(f=a.scalar,d=a.vector);let p,v=qe("outputData",l,i.length,4),m=Ue("aData",u,e.length,4),y=Ue("bData",h,n.length,4);if(r)if(o){let t=1===ke.size(e),i=1===ke.size(n),r=e.length>0&&e[e.length-1]%4==0,o=n.length>0&&n[n.length-1]%4==0;p=t||i?v.setByOffset("global_idx",d(t?`${m.type.value}(${m.getByOffset("0")}.x)`:m.getByOffset("global_idx"),i?`${y.type.value}(${y.getByOffset("0")}.x)`:y.getByOffset("global_idx"))):`\n            let outputIndices = ${v.offsetToIndices("global_idx * 4u")};\n            let offsetA = ${m.broadcastedIndicesToOffset("outputIndices",v)};\n            let offsetB = ${y.broadcastedIndicesToOffset("outputIndices",v)};\n            ${v.setByOffset("global_idx",d(s||r?m.getByOffset("offsetA / 4u"):`${m.type.value}(${m.getByOffset("offsetA / 4u")}[offsetA % 4u])`,s||o?y.getByOffset("offsetB / 4u"):`${y.type.value}(${y.getByOffset("offsetB / 4u")}[offsetB % 4u])`))}\n          `}else p=v.setByOffset("global_idx",d(m.getByOffset("global_idx"),y.getByOffset("global_idx")));else{if(!o)throw new Error("no necessary to use scalar implementation for element-wise binary op implementation.");let t=(t,e,n="")=>{let i=`aData[indexA${e}][componentA${e}]`,r=`bData[indexB${e}][componentB${e}]`;return`\n            let outputIndices${e} = ${v.offsetToIndices(`global_idx * 4u + ${e}u`)};\n            let offsetA${e} = ${m.broadcastedIndicesToOffset(`outputIndices${e}`,v)};\n            let offsetB${e} = ${y.broadcastedIndicesToOffset(`outputIndices${e}`,v)};\n            let indexA${e} = offsetA${e} / 4u;\n            let indexB${e} = offsetB${e} / 4u;\n            let componentA${e} = offsetA${e} % 4u;\n            let componentB${e} = offsetB${e} % 4u;\n            ${t}[${e}] = ${n}(${f(i,r)});\n          `};p=9===l?`\n            var data = vec4<u32>(0);\n            ${t("data",0,"u32")}\n            ${t("data",1,"u32")}\n            ${t("data",2,"u32")}\n            ${t("data",3,"u32")}\n            outputData[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:`\n            ${t("outputData[global_idx]",0)}\n            ${t("outputData[global_idx]",1)}\n            ${t("outputData[global_idx]",2)}\n            ${t("outputData[global_idx]",3)}\n          `}return`\n        ${t.registerUniform("vec_size","u32").declareVariables(m,y,v)}\n\n        ${c??""}\n\n        ${t.mainStart()}\n        ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n        ${p}\n      }`},or=(t,e,n,i,r,o,s=n.dataType)=>{let a=!ke.areEqual(n.dims,i.dims),u=n.dims,h=ke.size(n.dims),l=!1,c=!1,f=[a];if(a){let t=xe.calcShape(n.dims,i.dims,!1);if(!t)throw new Error("Can't perform binary op on the given tensors");u=t,h=ke.size(u);let e=1===ke.size(n.dims),r=1===ke.size(i.dims),o=n.dims.length>0&&n.dims[n.dims.length-1]%4==0,s=i.dims.length>0&&i.dims[i.dims.length-1]%4==0;f.push(e),f.push(r),f.push(o),f.push(s);let a=1;for(let t=1;t<u.length;t++){let e=n.dims[n.dims.length-t]??1;if(e!==(i.dims[i.dims.length-t]??1))break;a*=e}a%4==0?(c=!0,l=!0):(e||r||o||s)&&(l=!0)}else l=!0;return f.push(l),{name:t,shaderCache:{hint:e+f.map((t=>t.toString())).join("_"),inputDependencies:["rank","rank"]},getShaderSource:t=>rr(t,n.dims,i.dims,u,l,a,c,r,n.dataType,i.dataType,s,o),getRunData:()=>({outputs:[{dims:u,dataType:s}],dispatchGroup:{x:Math.ceil(h/64/4)},programUniforms:[{type:12,data:Math.ceil(ke.size(u)/4)},...Te(n.dims,i.dims,u)]})}},sr=(t,e,n,i,r,o)=>{t.compute(or(e,r??"",t.inputs[0],t.inputs[1],n,i,o))},ar=t=>{sr(t,"Add",((t,e)=>`${t}+${e}`))},ur=t=>{sr(t,"Div",((t,e)=>`${t}/${e}`))},hr=t=>{sr(t,"Equal",{scalar:(t,e)=>`u32(${t}==${e})`,vector:(t,e)=>`vec4<u32>(${t}==${e})`},void 0,void 0,9)},lr=t=>{sr(t,"Mul",((t,e)=>`${t}*${e}`))},cr=t=>{let e=Ue("input",t.inputs[0].dataType,t.inputs[0].dims).type.value;sr(t,"Pow",{scalar:(t,e)=>`pow_custom(${t},${e})`,vector:(t,e)=>`pow_vector_custom(${t},${e})`},`\n    fn pow_custom(a : ${e}, b : ${e}) -> ${e} {\n      if (b == ${e}(0.0)) {\n        return ${e}(1.0);\n      } else if (a < ${e}(0.0) && f32(b) != floor(f32(b))) {\n        return ${e}(pow(f32(a), f32(b))); // NaN\n      }\n      return select(sign(a), ${e}(1.0), round(f32(abs(b) % ${e}(2.0))) != 1.0) * ${e}(${"i32"===e?"round":""}(pow(f32(abs(a)), f32(b))));\n    }\n    fn pow_vector_custom(a : vec4<${e}>, b : vec4<${e}>) -> vec4<${e}> {\n      // TODO: implement vectorized pow\n      return vec4<${e}>(pow_custom(a.x, b.x), pow_custom(a.y, b.y), pow_custom(a.z, b.z), pow_custom(a.w, b.w));\n    }\n      `)},fr=t=>{sr(t,"Sub",((t,e)=>`${t}-${e}`))},dr=t=>{sr(t,"Greater",{scalar:(t,e)=>`u32(${t}>${e})`,vector:(t,e)=>`vec4<u32>(${t}>${e})`},void 0,void 0,9)},pr=t=>{sr(t,"Less",{scalar:(t,e)=>`u32(${t}<${e})`,vector:(t,e)=>`vec4<u32>(${t}<${e})`},void 0,void 0,9)},vr=t=>{sr(t,"GreaterOrEqual",{scalar:(t,e)=>`u32(${t}>=${e})`,vector:(t,e)=>`vec4<u32>(${t}>=${e})`},void 0,void 0,9)},mr=t=>{sr(t,"LessOrEqual",{scalar:(t,e)=>`u32(${t}<=${e})`,vector:(t,e)=>`vec4<u32>(${t}<=${e})`},void 0,void 0,9)}})),Du=H((()=>{yu(),$u(),ku(),Su(),yr=(t,e)=>{if(!t||t.length<1)throw new Error("too few inputs");let n=t[0],i=n.dataType,r=n.dims.length;t.forEach(((t,o)=>{if(0!==o){if(t.dataType!==i)throw new Error("input tensors should be one type");if(t.dims.length!==r)throw new Error("input tensors should have the same shape");t.dims.forEach(((t,i)=>{if(i!==e&&t!==n.dims[i])throw new Error("non concat dimensions must match")}))}}))},wr=(t,e)=>`\n  fn calculateInputIndex(index: u32) -> u32 {\n    let sizeInConcatAxis = array<u32, ${t}u>(${e});\n    for (var i: u32 = 0u; i < ${t}; i += 1u ) {\n      if (index < sizeInConcatAxis[i]) {\n        return i;\n      }\n    }\n    return ${t}u;\n  }`,gr=(t,e)=>{let n=t.length,i=[];for(let r=0;r<n;++r){let o=e.setByOffset("global_idx",t[r].getByIndices("indices"));1===n?i.push(o):0===r?i.push(`if (inputIndex == ${r}u) { ${o} }`):r===n-1?i.push(`else { ${o} }`):i.push(`else if (inputIndex == ${r}) { ${o} }`)}return i.join("\n")},br=(t,e,n,i)=>{let r=ke.size(n),o=new Array(t.length),s=new Array(t.length),a=0,u=[],h=[],l=[{type:12,data:r}];for(let n=0;n<t.length;++n)a+=t[n].dims[e],o[n]=a,h.push(t[n].dims.length),s[n]=Ue(`input${n}`,i,h[n]),u.push("rank"),l.push({type:12,data:o[n]});for(let e=0;e<t.length;++e)l.push(...Te(t[e].dims));l.push(...Te(n));let c=qe("output",i,n.length),f=c.indicesGet("indices",e),d=Array.from(Array(o.length).keys()).map((t=>`uniforms.sizeInConcatAxis${t}`)).join(",");return{name:"Concat",shaderCache:{hint:`${e}`,inputDependencies:u},getRunData:()=>({outputs:[{dims:n,dataType:i}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:l}),getShaderSource:e=>`\n\n  ${(()=>{e.registerUniform("outputSize","u32");for(let n=0;n<t.length;n++)e.registerUniform(`sizeInConcatAxis${n}`,"u32");return e.declareVariables(...s,c)})()}\n\n  ${wr(o.length,d)}\n\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n    var indices = ${c.offsetToIndices("global_idx")};\n\n    let inputIndex = calculateInputIndex(${f});\n    if (inputIndex != 0u) {\n      let sizeInConcatAxis = array<u32, ${o.length}u>(${d});\n      ${f} -= sizeInConcatAxis[inputIndex - 1u];\n    }\n\n    ${gr(s,c)}\n  }`}},_r=(t,e)=>{let n=t.inputs,i=n[0].dims,r=ke.normalizeAxis(e.axis,i.length);yr(n,r);let o=i.slice();o[r]=n.reduce(((t,e)=>t+(e.dims.length>r?e.dims[r]:0)),0);let s=n.filter((t=>ke.size(t.dims)>0));t.compute(br(s,r,o,n[0].dataType),{inputs:s})},xr=t=>be({axis:t.axis})})),Pu=H((()=>{yu(),$u(),kr=(t,e,n="f32")=>{switch(t.activation){case"Relu":return`value = max(value, ${e}(0.0));`;case"Sigmoid":return`value = (${e}(1.0) / (${e}(1.0) + exp(-value)));`;case"Clip":return`value = clamp(value, ${e}(${n}(uniforms.clip_min)), ${e}(${n}(uniforms.clip_max)));`;case"HardSigmoid":return`value = max(${e}(0.0), min(${e}(1.0), ${n}(uniforms.alpha) * value + ${n}(uniforms.beta)));`;case"LeakyRelu":return`value = select(${n}(uniforms.alpha) * value, value, value >= ${e}(0.0));`;case"Tanh":return"let e2x = exp(-2.0 * abs(value));\n              value = sign(value) * (1.0 - e2x) / (1.0 + e2x);\n        ";case"":return"";default:throw new Error(`Unsupported activation ${t.activation}`)}},$r=(t,e)=>{"Clip"===t.activation?e.push({type:1,data:t.clipMax},{type:1,data:t.clipMin}):"HardSigmoid"===t.activation?e.push({type:1,data:t.alpha},{type:1,data:t.beta}):"LeakyRelu"===t.activation&&e.push({type:1,data:t.alpha})},Sr=(t,e)=>{"Clip"===t.activation?e.push({name:"clip_max",type:"f32"},{name:"clip_min",type:"f32"}):"HardSigmoid"===t.activation?e.push({name:"alpha",type:"f32"},{name:"beta",type:"f32"}):"LeakyRelu"===t.activation&&e.push({name:"alpha",type:"f32"})},Er=t=>{let e=t?.activation||"";if("HardSigmoid"===e){let[n,i]=t?.activation_params||[.2,.5];return{activation:e,alpha:n,beta:i}}if("Clip"===e){let[n,i]=t?.activation_params||[Ee,Me];return{activation:e,clipMax:i,clipMin:n}}if("LeakyRelu"===e){let[n]=t?.activation_params||[.01];return{activation:e,alpha:n}}return{activation:e}}})),Nu=H((()=>{Mr=(t,e)=>{switch(t){case 1:return e;case 2:return`vec2<${e}>`;case 3:return`vec3<${e}>`;case 4:return`vec4<${e}>`;default:throw new Error(`${t}-component is not supported.`)}},Cr=t=>`\n      ${t?"value = value + getBiasByOutputCoords(coords);":""}\n      `})),Uu=H((()=>{Ar=t=>`\nfn getIndexFromCoords4D(coords : vec4<i32>, shape : vec4<i32>) -> i32 {\n  return dot(coords, vec4<i32>(\n      shape.y * shape.z * shape.w, shape.z * shape.w, shape.w, 1));\n}\nfn getOutputIndexFromCoords(coords : vec4<i32>) -> i32 {\n  return dot(coords, vec4<i32>(\n    i32(${t}.x), i32(${t}.y), i32(${t}.z), 1));\n}\n`})),qu=H((()=>{yu(),$u(),Su(),Pu(),Nu(),Or=(t,e)=>t?`\n        mm_Asub[inputRow][inputCol] = mm_readA(batch,\n          kStart + inputRow,\n          globalRowStart / innerElementSize + inputCol${e?", batchIndices":""});\n        `:`\n        mm_Asub[inputRow][inputCol] = mm_readA(batch,\n          globalRow + innerRow,\n          kStart / innerElementSize + inputCol${e?", batchIndices":""});\n        `,Ir=(t,e)=>t?`\n        let ACached0 = mm_Asub[k * innerElementSize][localRow];\n        let ACached1 = mm_Asub[k * innerElementSize + 1][localRow];\n        let ACached2 = mm_Asub[k * innerElementSize + 2][localRow];\n        ${3===e?"":"let ACached3 = mm_Asub[k * innerElementSize + 3][localRow];"}\n        for (var i = 0; i < rowPerThread; i = i + 1) {\n          acc[i] = BCached0 * ACached0[i] + acc[i];\n          acc[i] = BCached1 * ACached1[i] + acc[i];\n          acc[i] = BCached2 * ACached2[i] + acc[i];\n          ${3===e?"":"acc[i] = BCached3 * ACached3[i] + acc[i];"}\n        }`:`\n        for (var i = 0; i < rowPerThread; i = i + 1) {\n          let ACached = mm_Asub[tileRow + i][k];\n          acc[i] = BCached0 * ACached.x + acc[i];\n          acc[i] = BCached1 * ACached.y + acc[i];\n          acc[i] = BCached2 * ACached.z + acc[i];\n          ${3===e?"":"acc[i] = BCached3 * ACached.w + acc[i];"}\n        }`,Tr=(t,e,n="f32",i,r=!1,o=32,s=!1,a=32)=>{let u=e[1]*t[1],h=e[0]*t[0],l=r?u:o,c=r?o:u,f=l/e[0],d=o/e[1];if((!r||4!==f||4!==t[1])&&(r||3!==f&&4!==f)||l%e[0]!=0||o%e[1]!=0||4!==t[0])throw new Error(`If transposeA ${r} is true, innerElementSize ${f} and workPerThread[1] ${t[1]} must be 4.\n      Otherwise, innerElementSize ${f} must be 3 or 4.\n  tileAWidth ${l} must be divisible by workgroupSize[0]${e[0]}. tileInner ${o} must be divisible by workgroupSize[1] ${e[1]}. colPerThread ${t[0]} must be 4.`);return`\nvar<workgroup> mm_Asub: array<array<vec${f}<${n}>, ${l/f}>, ${c}>;\nvar<workgroup> mm_Bsub: array<array<vec4<${n}>, ${h/t[0]}>, ${o}>;\n\nconst rowPerThread = ${t[1]};\nconst colPerThread = ${t[0]};\nconst innerElementSize = ${f};\nconst tileInner = ${o};\n\n@compute @workgroup_size(${e[0]}, ${e[1]}, ${e[2]})\nfn main(@builtin(local_invocation_id) localId : vec3<u32>,\n        @builtin(global_invocation_id) globalId : vec3<u32>,\n        @builtin(workgroup_id) workgroupId : vec3<u32>) {\n  let localRow = i32(localId.y);\n  let tileRow = localRow * rowPerThread;\n  let tileCol = i32(localId.x);\n\n  let globalRow =i32(globalId.y) * rowPerThread;\n  let globalCol = i32(globalId.x);\n  let batch = ${s?"0":"i32(globalId.z)"};\n  ${i?`let batchIndices = ${i.offsetToIndices("u32(batch)")};`:""}\n  let globalRowStart = i32(workgroupId.y) * ${u};\n\n  let num_tiles = ${s?`${Math.ceil(a/o)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};\n  var kStart = ${s?`i32(globalId.z) * ${a}`:"0"};\n\n  var acc: array<vec4<${n}>, rowPerThread>;\n\n  // Loop over shared dimension.\n  let tileRowB = localRow * ${d};\n  for (var t = 0; t < num_tiles; t = t + 1) {\n      // Load one tile of A into local memory.\n      for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n          let inputRow = tileRow + innerRow;\n          let inputCol = tileCol;\n          ${Or(r,i)}\n      }\n\n      // Load one tile of B into local memory.\n      for (var innerRow = 0; innerRow < ${d}; innerRow = innerRow + 1) {\n          let inputRow = tileRowB + innerRow;\n          let inputCol = tileCol;\n          mm_Bsub[inputRow][inputCol] = mm_readB(batch, kStart + inputRow, globalCol${i?", batchIndices":""});\n      }\n      kStart = kStart + tileInner;\n      workgroupBarrier();\n\n      // Compute acc values for a single thread.\n      for (var k = 0; k < tileInner / innerElementSize; k = k + 1) {\n          let BCached0 = mm_Bsub[k * innerElementSize][tileCol];\n          let BCached1 = mm_Bsub[k * innerElementSize + 1][tileCol];\n          let BCached2 = mm_Bsub[k * innerElementSize + 2][tileCol];\n          ${3===f?"":"let BCached3 = mm_Bsub[k * innerElementSize + 3][tileCol];"}\n\n          ${Ir(r,f)}\n      }\n\n      workgroupBarrier();\n  }\n\n  for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      mm_write(batch, globalRow + innerRow, globalCol, acc[innerRow]);\n  }\n}`},zr=(t,e)=>t?`\n            mm_Asub[inputRow][inputCol] = mm_readA(batch,\n              kStart + inputRow,\n              globalRowStart + inputCol${e?", batchIndices":""});\n            `:`\n            mm_Asub[inputRow][inputCol] = mm_readA(batch,\n              globalRowStart + inputRow,\n              kStart + inputCol${e?", batchIndices":""});\n            `,Rr=t=>t?"let ACached = mm_Asub[k][tileRow + innerRow];":"let ACached = mm_Asub[tileRow + innerRow][k];",Fr=(t,e,n="f32",i,r=!1,o=32,s=!1,a=32,u=!1)=>{let h=t[1]*e[1],l=t[0]*e[0],c=r?h:o,f=r?o:h;if(f%e[1]!=0||c%e[0]!=0||o%e[1]!=0)throw new Error(`tileAHight ${f} must be divisible by workgroupSize[1]${e[1]}, tileAWidth ${c} must be divisible by workgroupSize[0]${e[0]}, tileInner ${o} must be divisible by workgroupSize[1]${e[1]}`);let d=f/e[1],p=c/e[0],v=o/e[1],m=u?`\n    let localRow = i32(localId.y);\n    let localCol = i32(localId.x);\n    let globalRowStart = i32(workgroupId.y) * ${h};\n    let globalColStart = i32(workgroupId.x) * ${l};\n\n    // Loop over shared dimension.\n    for (var t = 0; t < num_tiles; t = t + 1) {\n      // Load one tile of A into local memory.\n      for (var inputRow = localRow; inputRow < ${f}; inputRow = inputRow + ${e[1]}) {\n        for (var inputCol = localCol; inputCol < ${c}; inputCol = inputCol + ${e[0]}) {\n          ${zr(r,i)}\n        }\n      }\n      // Load one tile of B into local memory.\n      for (var inputRow = localRow; inputRow < ${o}; inputRow = inputRow + ${e[1]}) {\n            for (var inputCol = localCol; inputCol < ${l}; inputCol = inputCol + ${e[0]}) {\n          mm_Bsub[inputRow][inputCol] = mm_readB(batch,\n            kStart + inputRow,\n            globalColStart + inputCol${i?", batchIndices":""});\n        }\n      }\n      kStart = kStart + tileInner;\n      workgroupBarrier();\n\n      // Compute acc values for a single thread.\n      var BCached : array<${n}, colPerThread>;\n      for (var k = 0; k < tileInner; k = k + 1) {\n        for (var inner = 0; inner < colPerThread; inner = inner + 1) {\n          BCached[inner] = mm_Bsub[k][localCol + inner * ${e[0]}];\n        }\n        for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n          let ACached = ${r?`mm_Asub[k][localRow + innerRow * ${e[1]}];`:`mm_Asub[localRow + innerRow * ${e[1]}][k];`}\n          for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n            acc[innerRow][innerCol] = acc[innerRow][innerCol] +\n                ACached * BCached[innerCol];\n          }\n        }\n      }\n      workgroupBarrier();\n    }\n    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      let gRow = globalRowStart + localRow + innerRow * ${e[1]};\n      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n        let gCol = globalColStart + localCol + innerCol * ${e[0]};\n        mm_write(batch, gRow, gCol, acc[innerRow][innerCol]);\n      }\n    }\n    `:`\nlet tileRow = i32(localId.y) * rowPerThread;\nlet tileCol = i32(localId.x) * colPerThread;\n\nlet globalRow = i32(globalId.y) * rowPerThread;\nlet globalCol = i32(globalId.x) * colPerThread;\nlet globalRowStart = i32(workgroupId.y) * ${h};\n\nlet tileRowA = i32(localId.y) * ${d};\nlet tileColA = i32(localId.x) * ${p};\nlet tileRowB = i32(localId.y) * ${v};\n// Loop over shared dimension.\nfor (var t = 0; t < num_tiles; t = t + 1) {\n  // Load one tile of A into local memory.\n  for (var innerRow = 0; innerRow < ${d}; innerRow = innerRow + 1) {\n    for (var innerCol = 0; innerCol < ${p}; innerCol = innerCol + 1) {\n      let inputRow = tileRowA + innerRow;\n      let inputCol = tileColA + innerCol;\n      ${zr(r,i)}\n    }\n  }\n\n  // Load one tile of B into local memory.\n  for (var innerRow = 0; innerRow < ${v}; innerRow = innerRow + 1) {\n    for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n      let inputRow = tileRowB + innerRow;\n      let inputCol = tileCol + innerCol;\n      mm_Bsub[inputRow][inputCol] = mm_readB(batch,\n        kStart + inputRow,\n        globalCol + innerCol${i?", batchIndices":""});\n    }\n  }\n  kStart = kStart + tileInner;\n  workgroupBarrier();\n\n  // Compute acc values for a single thread.\n  var BCached : array<${n}, colPerThread>;\n  for (var k = 0; k < tileInner; k = k + 1) {\n    for (var inner = 0; inner < colPerThread; inner = inner + 1) {\n      BCached[inner] = mm_Bsub[k][tileCol + inner];\n    }\n\n    for (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n      ${Rr(r)}\n      for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n        acc[innerRow][innerCol] = acc[innerRow][innerCol] + ACached * BCached[innerCol];\n      }\n    }\n  }\n\n  workgroupBarrier();\n}\n\nfor (var innerRow = 0; innerRow < rowPerThread; innerRow = innerRow + 1) {\n  for (var innerCol = 0; innerCol < colPerThread; innerCol = innerCol + 1) {\n    mm_write(batch, globalRow + innerRow, globalCol + innerCol,\n        acc[innerRow][innerCol]);\n  }\n}\n`;return`\n  var<workgroup> mm_Asub : array<array<${n}, ${c}>, ${f}>;\n  var<workgroup> mm_Bsub : array<array<${n}, ${l}>, ${o}>;\n  const rowPerThread = ${t[1]};\n  const colPerThread = ${t[0]};\n  const tileInner = ${o};\n\n@compute @workgroup_size(${e[0]}, ${e[1]}, ${e[2]})\nfn main(@builtin(local_invocation_id) localId : vec3<u32>,\n        @builtin(global_invocation_id) globalId : vec3<u32>,\n        @builtin(workgroup_id) workgroupId : vec3<u32>) {\n    let batch = ${s?"0":"i32(globalId.z)"};\n    ${i?`let batchIndices = ${i.offsetToIndices("u32(batch)")};`:""}\n    let num_tiles = ${s?`${Math.ceil(a/o)}`:"(uniforms.dim_inner - 1) / tileInner + 1"};\n    var kStart = ${s?`i32(globalId.z) * ${a}`:"0"};\n\n    var acc : array<array<${n}, colPerThread>, rowPerThread>;\n    ${m}\n  }\n`},Dr=(t,e,n,i,r,o=!1)=>{let[s,a,u]=r,[h,l,c,f]=i,d=He(s,u),p=He(a,u),v=Oe(i[0].type.tensor);return`\n    fn mm_readA(batch: i32, row: i32, colIn: i32, batchIndices: ${h.type.indices}) -> ${Mr(t,v)} {\n      var value = ${Mr(t,v)}(0.0);\n      let col = colIn * ${t};\n      if(row < uniforms.dim_a_outer && col < uniforms.dim_inner)\n      {\n        ${(()=>{let t=l.rank,e=h.rank,n=`var aIndices: ${l.type.indices};`;for(let i=t-2-1,r=e-1;i>=0;i--,r--)n+=`\naIndices[${i}] = ${e>1?`batchIndices[${r}]`:"batchIndices"};`;return d.forEach((t=>{n+=`\naIndices[${t}] = 0;`})),n+=`\naIndices[${t-2}] = u32(row);\n                   aIndices[${t-1}] = u32(colIn);`,n})()}\n        value = ${l.getByIndices("aIndices")};\n      }\n      return value;\n    }\n\n    fn mm_readB(batch: i32, row: i32, colIn: i32, batchIndices: ${h.type.indices}) -> ${Mr(t,v)} {\n      var value = ${Mr(t,v)}(0.0);\n      let col = colIn * ${t};\n      if(row < uniforms.dim_inner && col < uniforms.dim_b_outer)\n      {\n        ${(()=>{let t=c.rank,e=h.rank,n=`var bIndices: ${c.type.indices};`;for(let i=t-2-1,r=e-1;i>=0;i--,r--)n+=`\nbIndices[${i}] = ${e>1?`batchIndices[${r}]`:"batchIndices"};`;return p.forEach((t=>{n+=`\nbIndices[${t}] = 0;`})),n+=`\nbIndices[${t-2}] = u32(row);\n                   bIndices[${t-1}] = u32(colIn);`,n})()}\n        value = ${c.getByIndices("bIndices")};\n      }\n      return value;\n    }\n\n    fn mm_write(batch: i32, row: i32, colIn: i32, valueIn: ${Mr(t,v)}) {\n      let col = colIn * ${t};\n      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer) {\n        var value = valueIn;\n        let coords = vec3<i32>(batch, row, colIn);\n        ${e?`value = value + ${o?"bias[colIn]":`${Mr(t,v)}(bias[row])`};`:""}\n        ${n}\n        ${f.setByIndices("vec3<u32>(coords)","value")}\n      }\n    }\n    `},Pr=(t,e,n,i,r=!1)=>{let o=t[0].dims,s=t[1].dims,a=o.slice(0,-2),u=s.slice(0,-2),h=i?i.slice(0,-2):n.slice(0,-2),l=ke.size(h),c=o[o.length-2],f=o[o.length-1],d=s[s.length-1],p=f%4==0&&d%4==0,v=c<=8?[4,1,1]:[4,4,1],m=[8,8,1],y=[Math.ceil(d/m[0]/v[0]),Math.ceil(c/m[1]/v[1]),Math.ceil(l/m[2]/v[2])],w=p?4:1,g=[...a,c,f/w],b=g.length,_=[...u,f,d/w],x=_.length,k=[l,c,d/w],$=[{type:6,data:c},{type:6,data:d},{type:6,data:f}];$r(e,$),$.push(...Te(h,g,_));let S=["rank","rank"],E=t.length>2;return E&&($.push(...Te(t[2].dims)),S.push("rank")),$.push(...Te(k)),{name:"MatMul",shaderCache:{hint:`${v};${e.activation};${p};${r}`,inputDependencies:S},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:y[0],y:y[1],z:y[2]},programUniforms:$}),getShaderSource:n=>{let i=h.length,o=je("batchDims",t[0].dataType,i,1),s=Oe(t[0].dataType),l=Ue("a",t[0].dataType,b,w),c=Ue("b",t[1].dataType,x,w),f=qe("result",t[0].dataType,k.length,w),d=[l,c];if(E){let e=r?w:1;d.push(Ue("bias",t[2].dataType,t[2].dims.length,e))}let y=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"}];Sr(e,y);let g=Oe(f.type.tensor),_=kr(e,f.type.value,g),$=Dr(w,E,_,[o,l,c,f],[a,u,h],r);return`\n  ${n.registerUniforms(y).registerInternalVariables(o).declareVariables(...d,f)}\n  ${$}\n  ${p?Tr(v,m,s,o):Fr(v,m,s,o)}\n                   `}}}})),ju=H((()=>{yu(),gu(),Su(),Pu(),Nu(),Uu(),qu(),Nr=(t,e,n,i,r=!1,o,s=4,a=4,u=4,h="f32")=>{let l=t?"\n    let coord = vec4<i32>(batch, xRow, xCol, xCh);\n    ":"\n    let coord = vec4<i32>(batch, xCh, xRow, xCol);\n    ",c=t?"\n    let coords = vec4<i32>(\n      batch,\n      row / outWidth,\n      row % outWidth,\n      col);\n    ":"\n    let coords = vec4<i32>(\n      batch,\n      row,\n      col / outWidth,\n      col % outWidth);\n    ",f=t?"i32(uniforms.x_shape[1])":"i32(uniforms.x_shape[2])",d=t?"i32(uniforms.x_shape[2])":"i32(uniforms.x_shape[3])",p=t?"row":"col",v=t?"col":"row",m=`\n    let inChannels = i32(uniforms.w_shape[2]);\n    let outWidth = ${t?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n    let outRow = ${p} / outWidth;\n    let outCol = ${p} % outWidth;\n\n    let WRow = ${v} / (i32(uniforms.w_shape[1]) * inChannels);\n    let WCol = ${v} / inChannels % i32(uniforms.w_shape[1]);\n    let xRow = outRow * uniforms.stride[0] + uniforms.dilation[0] * WRow - uniforms.pad[0];\n    let xCol = outCol * uniforms.stride[1] + uniforms.dilation[1] * WCol - uniforms.pad[1];\n    let xCh = ${v} % inChannels;\n    var resData = ${Mr(s,h)}(0.0);\n    // The bounds checking is always needed since we use it to pad zero for\n    // the 'same' padding type.\n    if (xRow >= 0 && xRow < ${f} && xCol >= 0 && xCol < ${d}) {\n      ${l}\n      let xIndex = getIndexFromCoords4D(coord, vec4<i32>(uniforms.x_shape));\n      ${(t=>{switch(t){case 1:return"resData = x[xIndex];";case 3:return`resData = vec3<${h}>(x[xIndex], x[xIndex + 1], x[xIndex + 2]);`;case 4:return"resData = x[xIndex / 4];";default:throw new Error(`innerElementSize ${t} is not supported.`)}})(s)}\n    }\n    return resData;`,y=t?e&&i?`\n    let col = colIn * ${s};\n    ${m}`:`\n    let col = colIn * ${s};\n    if (row < uniforms.dim_a_outer && col < uniforms.dim_inner) {\n      ${m}\n    }\n    return ${Mr(s,h)}(0.0);`:i&&n?`\n    let col = colIn * ${s};\n    ${m}`:`\n    let col = colIn * ${s};\n    if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {\n      ${m}\n    }\n    return ${Mr(s,h)}(0.0);`,w=`${(t=>{switch(t){case 1:return"return w[row * i32(uniforms.w_shape[3]) + colIn];";case 4:return"return w[row * i32(uniforms.w_shape[3]) / 4 + colIn];";default:throw new Error(`innerElementSize ${t} is not supported.`)}})(a)}`,g=Mr(u,h),b=Mr(t?s:a,h),_=Mr(t?a:s,h),x=kr(o,g,h);return`\n    fn mm_readA(batch: i32, row : i32, colIn : i32) -> ${b} {\n      ${t?y:w}\n    }\n\n    fn mm_readB(batch: i32, row : i32, colIn : i32) -> ${_} {\n      ${t?w:y}\n    }\n\n    fn mm_write(batch: i32, row : i32, colIn : i32, valueIn : ${g}) {\n      let col = colIn * ${u};\n      if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer)\n      {\n      var value = valueIn;\n      let outWidth = ${t?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n      ${c}\n      ${Cr(r)}\n      ${x}\n      setOutputAtCoords(coords[0], coords[1], coords[2], coords[3], value);\n      }\n    }`},Ur=(t,e,n,i,r,o,s,a)=>{let u="NHWC"===e.format,h=u?t[0].dims[3]:t[0].dims[1],l=n[0],c=u?n[2]:n[3],f=u?n[1]:n[2],d=u?n[3]:n[1],p=u&&(h%4==0||h%3==0)&&d%4==0,v=u?d:c*f,m=u?c*f:d,y=[8,8,1],w=i<=8?[4,1,1]:[4,4,1],g=[Math.ceil(v/y[0]/w[0]),Math.ceil(m/y[1]/w[1]),Math.ceil(l/y[2]/w[2])];ue("verbose",(()=>`[conv2d_mm_webgpu] dispatch = ${g}`));let b=p?u&&h%4!=0?3:4:1,_=y[1]*w[1],x=y[0]*w[0],k=Math.max(y[0]*b,y[1]),$=i%_==0,S=r%x==0,E=o%k==0,M=p?[b,4,4]:[1,1,1],C=[{type:6,data:i},{type:6,data:r},{type:6,data:o},{type:6,data:[e.pads[0],e.pads[1]]},{type:6,data:e.strides},{type:6,data:e.dilations}];$r(e,C),C.push(...Te(t[0].dims,t[1].dims));let A=["rank","rank"];return s&&(C.push(...Te(t[2].dims)),A.push("rank")),C.push(...Te(n)),{name:"Conv2DMatMul",shaderCache:{hint:`${e.cacheKey};${b};${p};${$};${S};${E};${_};${x};${k}`,inputDependencies:A},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:g[0],y:g[1],z:g[2]},programUniforms:C}),getShaderSource:i=>{let r=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"},{name:"pad",type:"i32",length:2},{name:"stride",type:"i32",length:2},{name:"dilation",type:"i32",length:2}];Sr(e,r);let o=p?4:1,h=Oe(t[0].dataType),l=`\n      fn setOutputAtIndex(flatIndex : i32, value : ${p?`vec4<${h}>`:h}) {\n        result[flatIndex] = ${p?`vec4<${h}>`:h}(value);\n      }\n      fn setOutputAtCoords(d0 : i32, d1 : i32, d2 : i32, d3 : i32, value : ${p?`vec4<${h}>`:h}) {\n        let flatIndex = getOutputIndexFromCoords(vec4<i32>(d0, d1, d2, d3));\n        setOutputAtIndex(flatIndex ${p?"/ 4":""}, value);\n      }`,c=[Ue("x",t[0].dataType,t[0].dims.length,3===b?1:b),Ue("w",t[1].dataType,t[1].dims.length,o)],f=qe("result",t[0].dataType,n.length,o);if(s){let e=Ue("bias",t[2].dataType,t[2].dims.length,o);c.push(e),l+=`\n        fn getBiasByOutputCoords(coords : vec4<i32>) -> ${p?`vec4<${h}>`:h} {\n          return bias[coords.${u?"w":"y"}${p?"/ 4":""}];\n        }`}return`\n        ${Ar("uniforms.result_strides")}\n        //struct Uniforms { xShape : vec4<i32>, wShape : vec4<i32>, outShape : vec4<i32>,\n        //  outShapeStrides: vec3<i32>, filterDims : vec2<i32>, pad : vec2<i32>, stride : vec2<i32>,\n        //  dilation : vec2<i32>, dimAOuter : i32, dimBOuter : i32, dimInner : i32 };\n        ${i.registerUniforms(r).declareVariables(...c,f)}\n        ${l}\n        ${Nr(u,$,S,E,s,e,M[0],M[1],M[2],h)}\n        ${p?Tr(w,y,h,void 0,!u,k):Fr(w,y,h,void 0,!u,k,!1,void 0,a)}`}}}})),Lu=H((()=>{yu(),gu(),$u(),Su(),Pu(),Nu(),qr=t=>{let e=1;for(let n=0;n<t.length;n++)e*=t[n];return e},jr=t=>"number"==typeof t?[t,t,t]:t,Lr=(t,e)=>e<=1?t:t+(t-1)*(e-1),Br=(t,e,n,i=1)=>{let r=Lr(e,i);return Math.floor((t[0]*(n-1)-n+r)/2)},Hr=(t,e,n,i,r)=>{null==r&&(r=Br(t,e[0],i[0]));let o=[0,0,0,n];for(let n=0;n<3;n++)t[n]+2*r>=e[n]&&(o[n]=Math.trunc((t[n]-e[n]+2*r)/i[n]+1));return o},Wr=(t,e,n,i,r,o,s,a,u,h)=>{let l,c,f,d;if("VALID"===t&&(t=0),"number"==typeof t){l={top:t,bottom:t,left:t,right:t,front:t,back:t};let p=Hr([e,n,i,1],[a,u,h],1,[r,o,s],t);c=p[0],f=p[1],d=p[2]}else if(Array.isArray(t)){if(!t.every(((t,e,n)=>t===n[0])))throw Error(`Unsupported padding parameter: ${t}`);l={top:t[0],bottom:t[1],left:t[2],right:t[3],front:t[4],back:t[5]};let p=Hr([e,n,i,1],[a,u,h],1,[r,o,s],t[0]);c=p[0],f=p[1],d=p[2]}else{if("SAME_UPPER"!==t)throw Error(`Unknown padding parameter: ${t}`);{c=Math.ceil(e/r),f=Math.ceil(n/o),d=Math.ceil(i/s);let t=(c-1)*r+a-e,p=(f-1)*o+u-n,v=(d-1)*s+h-i,m=Math.floor(t/2),y=t-m,w=Math.floor(p/2),g=p-w,b=Math.floor(v/2);l={top:w,bottom:g,left:b,right:v-b,front:m,back:y}}}return{padInfo:l,outDepth:c,outHeight:f,outWidth:d}},Vr=(t,e,n,i,r,o=!1,s="channelsLast")=>{let a,u,h,l,c;if("channelsLast"===s)[a,u,h,l,c]=t;else{if("channelsFirst"!==s)throw new Error(`Unknown dataFormat ${s}`);[a,c,u,h,l]=t}let[f,,d,p,v]=e,[m,y,w]=jr(n),[g,b,_]=jr(i),x=Lr(d,g),k=Lr(p,b),$=Lr(v,_),{padInfo:S,outDepth:E,outHeight:M,outWidth:C}=Wr(r,u,h,l,m,y,w,x,k,$),A=o?f*c:f,O=[0,0,0,0,0];return"channelsFirst"===s?O=[a,A,E,M,C]:"channelsLast"===s&&(O=[a,E,M,C,A]),{batchSize:a,dataFormat:s,inDepth:u,inHeight:h,inWidth:l,inChannels:c,outDepth:E,outHeight:M,outWidth:C,outChannels:A,padInfo:S,strideDepth:m,strideHeight:y,strideWidth:w,filterDepth:d,filterHeight:p,filterWidth:v,effectiveFilterDepth:x,effectiveFilterHeight:k,effectiveFilterWidth:$,dilationDepth:g,dilationHeight:b,dilationWidth:_,inShape:t,outShape:O,filterShape:e}},Gr=(t,e,n,i,r,o)=>{let s="channelsLast"===o;s?t[0].dims[3]:t[0].dims[1];let a={x:n.map(((t,e)=>e))},u=[Math.ceil(qr(a.x.map((t=>n[t])))/64),1,1];ue("verbose",(()=>`[conv3d_naive_webgpu] dispatch = ${u}`));let h=[{type:12,data:ke.size(n)},{type:12,data:i},{type:12,data:r},{type:12,data:e.strides},{type:12,data:e.dilations}];$r(e,h),h.push(...Te(t[0].dims,t[1].dims));let l=["rank","rank"],c=3===t.length;return c&&(h.push(...Te(t[2].dims)),l.push("rank")),h.push(...Te(n)),{name:"Conv3DNaive",shaderCache:{hint:`${e.cacheKey};${s};1;${c}`,inputDependencies:l},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:u[0],y:u[1],z:u[2]},programUniforms:h}),getShaderSource:o=>{let a=[{name:"output_size",type:"u32"},{name:"filter_dims",type:"u32",length:i.length},{name:"pads",type:"u32",length:r.length},{name:"strides",type:"u32",length:e.strides.length},{name:"dilations",type:"u32",length:e.dilations.length}];Sr(e,a);let u=Oe(t[0].dataType),h=Ue("x",t[0].dataType,t[0].dims.length,1),l=Ue("W",t[1].dataType,t[1].dims.length,1),f=[h,l],d=qe("result",t[0].dataType,n.length,1),p="";if(c){let e=Ue("bias",t[2].dataType,t[2].dims.length,1);f.push(e),p+=`\n        fn getBiasByOutputCoords(coords : array<u32, 5>) -> ${u} {\n          return bias[${Pe("coords",s?4:1,5)}];\n        }`}let v=Mr(1,u),m=kr(e,v,u);return`\n            ${p}\n            fn getX(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {\n              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);\n              return ${h.getByIndices("aIndices")};\n            }\n            fn getW(d0 : u32, d1 : u32, d2 : u32, d3 : u32, d4 : u32) -> f32 {\n              let aIndices = array<u32, 5>(d0, d1, d2, d3, d4);\n              return ${l.getByIndices("aIndices")};\n            }\n          ${o.registerUniforms(a).declareVariables(...f,d)}\n          ${o.mainStart()}\n          ${o.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n              let coords = ${d.offsetToIndices("global_idx")};\n              let batch = ${Pe("coords",0,h.rank)};\n              let d2 = ${Pe("coords",s?h.rank-1:1,h.rank)};\n              let xFRCCorner = vec3<u32>(${Pe("coords",s?1:2,h.rank)},\n              ${Pe("coords",s?2:3,h.rank)},\n              ${Pe("coords",s?3:4,h.rank)}) * uniforms.strides - uniforms.pads;\n              let xFCorner = xFRCCorner.x;\n              let xRCorner = xFRCCorner.y;\n              let xCCorner = xFRCCorner.z;\n              let xShapeY = ${Pe("uniforms.x_shape",s?1:2,h.rank)};\n              let xShapeZ = ${Pe("uniforms.x_shape",s?2:3,h.rank)};\n              let xShapeW = ${Pe("uniforms.x_shape",s?3:4,h.rank)};\n              let xShapeU = ${Pe("uniforms.x_shape",s?4:1,h.rank)};\n              let inputDepthNearestVec4 = (xShapeU / 4) * 4;\n              let inputDepthVec4Remainder = xShapeU % 4;\n\n              var value = 0.0;\n              for (var wF = 0u; wF < uniforms.filter_dims[0]; wF++) {\n                let xF = xFCorner + wF * uniforms.dilations[0];\n                if (xF < 0 || xF >= xShapeY) {\n                  continue;\n                }\n\n                for (var wR = 0u; wR < uniforms.filter_dims[1]; wR++) {\n                  let xR = xRCorner + wR * uniforms.dilations[1];\n                  if (xR < 0 || xR >= xShapeZ) {\n                    continue;\n                  }\n\n                  for (var wC = 0u; wC < uniforms.filter_dims[2]; wC++) {\n                    let xC = xCCorner + wC * uniforms.dilations[2];\n                    if (xC < 0 || xC >= xShapeW) {\n                      continue;\n                    }\n\n                    for (var d1 = 0u; d1 < inputDepthNearestVec4; d1 += 4) {\n                      ${s?"let xValues = vec4<f32>(\n                               getX(batch, xF, xR, xC, d1),\n                               getX(batch, xF, xR, xC, d1 + 1),\n                               getX(batch, xF, xR, xC, d1 + 2),\n                               getX(batch, xF, xR, xC, d1 + 3));\n                            ":"let xValues = vec4<f32>(\n                               getX(batch, d1, xF, xR, xC),\n                               getX(batch, d1 + 1, xF, xR, xC),\n                               getX(batch, d1 + 2, xF, xR, xC),\n                               getX(batch, d1 + 3, xF, xR, xC));\n                            "}\n                            let wValues = vec4<f32>(\n                              getW(d2, d1, wF, wR, wC),\n                              getW(d2, d1 + 1, wF, wR, wC),\n                              getW(d2, d1 + 2, wF, wR, wC),\n                              getW(d2, d1 + 3, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    }\n                    if (inputDepthVec4Remainder == 1) {\n                        ${s?"value += getX(batch, xF, xR, xC, inputDepthNearestVec4)\n                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);":"value += getX(batch, inputDepthNearestVec4, xF, xR, xC)\n                          * getW(d2, inputDepthNearestVec4, wF, wR, wC);"}\n                    } else if (inputDepthVec4Remainder == 2) {\n                      ${s?"let xValues = vec2<f32>(\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1));\n                      ":"let xValues = vec2<f32>(\n                        getX(batch, inputDepthNearestVec4, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC));\n                    "}\n                    let wValues = vec2<f32>(\n                      getW(d2, inputDepthNearestVec4, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    } else if (inputDepthVec4Remainder == 3) {\n                      ${s?"let xValues = vec3<f32>(\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 1),\n                        getX(batch, xF, xR, xC, inputDepthNearestVec4 + 2));\n                      ":"let xValues = vec3<f32>(\n                        getX(batch, inputDepthNearestVec4, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 1, xF, xR, xC),\n                        getX(batch, inputDepthNearestVec4 + 2, xF, xR, xC));\n                    "}\n                    let wValues = vec3<f32>(\n                      getW(d2, inputDepthNearestVec4, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 1, wF, wR, wC),\n                      getW(d2, inputDepthNearestVec4 + 2, wF, wR, wC));\n                      value += dot(xValues, wValues);\n                    }\n                  }\n                }\n              }\n              ${c?"value = value + getBiasByOutputCoords(coords)":""};\n              ${m}\n              result[global_idx] = f32(value);\n          }`}}}})),Bu=H((()=>{yu(),$u(),Su(),Wu(),Pu(),Yr=(t,e,n)=>{let i=t.length>2,r=i?"value += b[output_channel];":"",o=t[0].dims,s=t[1].dims,a=s[0]/e.group,u="NHWC"===e.format,h=Jr(o,s,e.dilations,e.pads,e.strides,u),l=ke.size(h),c=[{type:12,data:l},{type:12,data:e.dilations},{type:12,data:[e.strides[0],e.strides[1]]},{type:12,data:[e.pads[0],e.pads[1]]},{type:12,data:a}];$r(e,c),c.push(...Te(o,s));let f=["rank","rank"];return i&&(c.push(...Te(t[2].dims)),f.push("rank")),c.push(...Te(h)),{name:"GroupedConv",shaderCache:{hint:e.cacheKey,inputDependencies:f},getRunData:()=>({outputs:[{dims:n?n(h):h,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:c}),getShaderSource:n=>{let a=qe("output",t[0].dataType,h.length),l=Oe(a.type.tensor),c=kr(e,a.type.value,l),f=Ue("x",t[0].dataType,o.length),d=Ue("w",t[1].dataType,s.length),p=[f,d];i&&p.push(Ue("b",t[2].dataType,t[2].dims.length));let v=[{name:"output_size",type:"u32"},{name:"dilations",type:"u32",length:e.dilations.length},{name:"strides",type:"u32",length:2},{name:"pads",type:"u32",length:2},{name:"output_channels_per_group",type:"u32"}];return Sr(e,v),`\n  ${n.registerUniforms(v).declareVariables(...p,a)}\n\n  ${n.mainStart()}\n    ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let outputIndices = ${a.offsetToIndices("global_idx")};\n    let batch: u32 = outputIndices[0];\n    let output_channel: u32 = outputIndices[${u?3:1}];\n    let xRCCorner: vec2<u32> = vec2<u32>(outputIndices[${u?1:2}], outputIndices[${u?2:3}]) * uniforms.strides - uniforms.pads;\n    let group_id: u32 = output_channel / uniforms.output_channels_per_group;\n\n    var value: ${a.type.value} = ${a.type.value}(0);\n    for (var wInChannel: u32 = 0u; wInChannel < uniforms.w_shape[1]; wInChannel++) {\n      let input_channel = group_id * uniforms.w_shape[1] + wInChannel;\n      for (var wHeight: u32 = 0u; wHeight < uniforms.w_shape[2]; wHeight++) {\n        let xHeight = xRCCorner.x + wHeight * uniforms.dilations[0];\n\n        if (xHeight < 0u || xHeight >= uniforms.x_shape[${u?1:2}]) {\n          continue;\n        }\n\n        for (var wWidth: u32 = 0u; wWidth < uniforms.w_shape[3]; wWidth++) {\n          let xWidth = xRCCorner.y + wWidth * uniforms.dilations[1];\n          if (xWidth < 0u || xWidth >= uniforms.x_shape[${u?2:3}]) {\n            continue;\n          }\n\n          let xVal = ${u?f.get("batch","xHeight","xWidth","input_channel"):f.get("batch","input_channel","xHeight","xWidth")};\n          let wVal = ${d.get("output_channel","wInChannel","wHeight","wWidth")};\n          value += xVal*wVal;\n        }\n      }\n    }\n    ${r}\n    ${c}\n    ${a.setByOffset("global_idx","value")}\n  }`}}},Kr=(t,e,n)=>{let i=t.length>2,r=ze(n[3]),o=ze(n[2]),s=ke.size(n)/r/o,a=[t[0].dims[0],t[0].dims[1],t[0].dims[2],t[0].dims[3]/r],u=[t[1].dims[0],t[1].dims[1],t[1].dims[2],t[1].dims[3]/r],h=[n[0],n[1],n[2],n[3]/r],l=[{type:12,data:s},{type:6,data:[e.strides[0],e.strides[1]]},{type:6,data:[e.pads[0],e.pads[1]]}];$r(e,l),l.push(...Te(a,u,h));let c=(o-1)*e.strides[1]+u[1];return{name:"GroupedConv-Vectorize",shaderCache:{hint:`${e.cacheKey};${r};${o};${c};${u[0]};${u[1]}`,inputDependencies:i?["rank","rank","type"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:l}),getShaderSource:n=>{let s=qe("output",t[0].dataType,h.length,r),l=Oe(s.type.tensor),f=kr(e,s.type.value,l),d=Ue("x",t[0].dataType,a.length,r),p=Ue("w",t[1].dataType,u.length,r),v=[d,p];i&&v.push(Ue("b",t[2].dataType,t[2].dims,r));let m=i?"value += b[output_channel];":"",y=[{name:"output_size",type:"u32"},{name:"strides",type:"i32",length:2},{name:"pads",type:"i32",length:2}];return Sr(e,y),`\n  ${n.registerUniforms(y).declareVariables(...v,s)}\n  ${n.mainStart()}\n    ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let width0 = uniforms.output_shape[3];\n    let output_channel = global_idx % width0;\n    var index1 = global_idx / width0;\n    let width1 = uniforms.output_shape[2] / ${o}u;\n    let col = (index1 % width1) * ${o}u;\n    index1 = index1 / width1;\n    let row = index1 % uniforms.output_shape[1];\n    let batch = index1 / uniforms.output_shape[1];\n\n    let x_corner = vec2<i32>(i32(row), i32(col)) * uniforms.strides - uniforms.pads;\n\n    var x_vals: array<${d.type.value}, ${c}>;\n    var values: array<${s.type.value}, ${o}>;\n    let input_channel = output_channel;\n    // Use constant instead of uniform can give better performance for w's height/width.\n    for (var w_height: u32 = 0u; w_height < ${u[0]}; w_height++) {\n      let x_height = x_corner.x + i32(w_height);\n      if (x_height >= 0 && u32(x_height) < uniforms.x_shape[1]) {\n        for (var i = 0; i < ${c}; i++) {\n          let x_width = x_corner.y + i;\n          if (x_width >= 0 && u32(x_width) < uniforms.x_shape[2]) {\n            x_vals[i] = ${d.get("batch","u32(x_height)","u32(x_width)","input_channel")};\n          } else {\n            x_vals[i] = ${d.type.value}(0);\n          }\n        }\n        for (var w_width: u32 = 0u; w_width < ${u[1]}; w_width++) {\n          let w_val = ${p.get("w_height","w_width","0","output_channel")};\n          for (var i = 0u; i < ${o}u; i++) {\n            values[i] = fma(x_vals[i * u32(uniforms.strides[1]) + w_width], w_val, values[i]);\n          }\n        }\n      }\n    }\n\n    for (var i = 0u; i < ${o}u; i++) {\n      var value = values[i];\n      ${m}\n      ${f}\n      ${s.set("batch","row","col + i","output_channel","value")};\n    }\n  }`}}}})),Hu=H((()=>{yu(),$u(),qu(),Su(),Pu(),Xr=(t,e,n,i,r=!1)=>{let o=t[0].dims,s=t[1].dims,a=o[o.length-2],u=s[s.length-1],h=o[o.length-1],l=ze(u),c=ze(h),f=ze(a),d=ke.size(n)/l/f,p=t.length>2,v=i?i.slice(0,-2):n.slice(0,-2),m=[ke.size(v),a,u],y=[{type:12,data:d},{type:12,data:a},{type:12,data:u},{type:12,data:h}];return $r(e,y),y.push(...Te(v,o,s)),p&&y.push(...Te(t[2].dims)),y.push(...Te(m)),{name:"MatMulNaive",shaderCache:{hint:`${e.activation};${l};${c};${f};${r}`,inputDependencies:p?["rank","rank","rank"]:["rank","rank"]},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(d/64)},programUniforms:y}),getShaderSource:i=>{let a=je("batch_dims",t[0].dataType,v.length),u=Ue("a",t[0].dataType,o.length,c),h=Ue("b",t[1].dataType,s.length,l),d=qe("output",t[0].dataType,m.length,l),y=Oe(d.type.tensor),w=kr(e,d.type.value,y),g=[u,h],b="";if(p){let e=r?l:1;g.push(Ue("bias",t[2].dataType,t[2].dims.length,e)),b=r?`value += bias[col / ${e}];`:`value += ${d.type.value}(bias[row + i]);`}let _=o.slice(0,-2),x=s.slice(0,-2),k=He(_,v),$=He(x,v),S=[{name:"output_size",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"}];Sr(e,S);let E=(t,e)=>{let n=t.rank,i=t.name;if(2===n)return`var ${i}_indices = ${t.type.indices}(0u, 0u);`;let r=a.rank,o=`var ${i}_indices: ${t.type.indices};`;for(let t=n-2-1,e=r-1;t>=0;t--,e--)o+=`\n${i}_indices[${t}] = ${r>1?`batch_indices[${e}]`:"batch_indices"};`;return e.forEach((t=>{o+=`\n${i}_indices[${t}] = 0;`})),o+=`${i}_indices[${n-2}] = 0u;\n                     ${i}_indices[${n-1}] = 0u;`,o};return`\n  ${i.registerUniforms(S).registerInternalVariables(a).declareVariables(...g,d)}\n  ${i.mainStart()}\n    ${i.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let col = (global_idx % (uniforms.N / ${l})) * ${l};\n    var index1 = global_idx / (uniforms.N / ${l});\n    let stride1 = uniforms.M / ${f};\n    let row = (index1 % stride1) * ${f};\n    let batch = index1 / stride1;\n\n    ${2===n.length?"":`let batch_indices = ${a.offsetToIndices("batch")};`}\n    ${E(u,k)}\n    let a_offset = ${u.indicesToOffset("a_indices")};\n    ${E(h,$)}\n    let b_offset = ${h.indicesToOffset("b_indices")};\n    var values: array<${d.type.value}, ${f}>;\n    for (var k: u32 = 0u; k < uniforms.K; k = k + ${c}) {\n      ${(()=>{let t=`var a_data: ${u.type.value};`;for(let e=0;e<c;e++)t+=`\n              let b_data${e} = b[(b_offset + (k + ${e}) * uniforms.N + col) / ${l}];`;for(let e=0;e<f;e++){t+=`a_data = a[(a_offset + (row + ${e}) * uniforms.K + k) / ${c}];`;for(let n=0;n<c;n++)t+=`\n            values[${e}] = fma(${h.type.value}(a_data${1===c?"":`[${n}]`}), b_data${n}, values[${e}]);\n`}return t})()}\n    }\n    for (var i = 0u; i < ${f}u; i++) {\n      var value = values[i];\n      ${b}\n      ${w}\n      let cur_indices = ${d.type.indices}(batch, row + i, col);\n      let offset = ${d.indicesToOffset("cur_indices")};\n      ${d.setByOffset(`offset / ${l}`,"value")};\n    }\n  }\n  `}}},Qr=t=>{if(!t||2!==t.length)throw new Error("MatMul requires 2 inputs.");if(t[0].dims[t[0].dims.length-1]!==t[1].dims[t[1].dims.length-2])throw new Error("shared dimension does not match.")},Zr=t=>{Qr(t.inputs);let e=xe.calcShape(t.inputs[0].dims,t.inputs[1].dims,!0);if(!e)throw new Error("Can't use matmul on the given tensors");let n=e[e.length-1],i=t.inputs[0].dims[t.inputs[0].dims.length-1];n<8&&i<8?t.compute(Xr(t.inputs,{activation:""},e)):t.compute(Pr(t.inputs,{activation:""},e))}})),Wu=H((()=>{$u(),ju(),Lu(),qu(),Bu(),Pu(),Hu(),Eu(),Jr=(t,e,n,i,r,o)=>{let s=t[0],a=t.slice(o?1:2,o?3:4),u=a.length,h=e[0],l=e.slice(2).map(((t,e)=>t+(t-1)*(n[e]-1))),c=a.map(((t,e)=>t+i[e]+i[e+u])).map(((t,e)=>Math.floor((t-l[e]+r[e])/r[e])));return c.splice(0,0,s),c.splice(o?3:1,0,h),c},to=[2,3,1,0],eo=(t,e)=>{if(!t||2!==t.length&&3!==t.length)throw new Error("Conv requires 2 or 3 inputs");if(t[0].dims.length>5)throw new Error("greater than 5D is not supported");if(t[0].dims.length!==t[1].dims.length)throw new Error("filter does not have same dimension as input");if(t[0].dims["NHWC"===e.format?t[0].dims.length-1:1]!==t[1].dims[1]*e.group)throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");if(3===t.length&&(1!==t[2].dims.length||t[1].dims[0]!==t[2].dims[0]))throw new Error("invalid bias");let n=t[0].dims.length-2;if(e.dilations.length!==n)throw new Error(`dilations should be ${n}D`);if(e.strides.length!==n)throw new Error(`strides should be ${n}D`);if(e.pads.length!==2*n)throw new Error(`pads should be ${2*n}D`);if(0!==e.kernelShape.length&&e.kernelShape.length!==t[1].dims.length-2)throw new Error("invalid kernel shape")},no=(t,e)=>{let n=t.kernelShape.slice();for(let t=2;t<e[1].dims.length;++t)0===n[t-2]&&(n[t-2]=e[1].dims[t]);let i=t.pads.slice();$e.adjustPadsBasedOnAutoPad(e[0].dims,t.strides,t.dilations,n,i,"NHWC"===t.format,t.autoPad);let r=Object.assign({},t);return Object.assign(r,{kernelShape:n,pads:i}),r},io=t=>{let e=Er(t),n=t.format;return{autoPad:["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][t.auto_pad],format:n,dilations:t.dilations,group:t.group,kernelShape:t.kernel_shape,pads:t.pads,strides:t.strides,wIsConst:t.w_is_const(),...e,cacheKey:`${t.format};${e.activation};`}},ro=(t,e,n)=>{let i=no(n,e),r="NHWC"===n.format;if(1!==n.group){if(!t.adapterInfo.isArchitecture("ampere")&&r&&e[1].dims[0]===n.group&&1===e[1].dims[1]&&1===n.dilations[0]&&1===n.dilations[1]){let o=Jr(e[0].dims,e[1].dims,n.dilations,i.pads,n.strides,r),s=t.kernelCustomData.wT??t.compute(Ke(e[1],to),{inputs:[1],outputs:[n.wIsConst?-2:-1]})[0];n.wIsConst&&!t.kernelCustomData.wT&&(t.kernelCustomData.wT=s);let a=[e[0],s];3===e.length&&a.push(e[2]),t.compute(Kr(a,i,o),{inputs:a})}else t.compute(Yr(e,i));return}let o=3===e.length,s=e[0].dims[r?1:2],a=e[0].dims[r?2:3],u=e[0].dims[r?3:1],h=e[1].dims[2],l=e[1].dims[3],c=Jr(e[0].dims,e[1].dims,n.dilations,i.pads,n.strides,r),f=c[r?1:2],d=c[r?2:3],p=c[r?3:1],v=r&&h===s&&l===a&&0===n.pads[0]&&0===n.pads[1];if(v||1===h&&1===l&&1===n.dilations[0]&&1===n.dilations[1]&&1===n.strides[0]&&1===n.strides[1]&&0===n.pads[0]&&0===n.pads[1]){let h,l,m,y=c[0],w=[];if(r){let i=t.kernelCustomData.wT??t.compute(Ke(e[1],to),{inputs:[1],outputs:[n.wIsConst?-2:-1]})[0];if(n.wIsConst&&!t.kernelCustomData.wT&&(t.kernelCustomData.wT=i),v){let t=s*a*u;h=e[0].reshape([1,y,t]),l=i.reshape([1,t,p]),m=[1,y,p]}else h=e[0].reshape([y,s*a,u]),l=i.reshape([1,u,p]),m=[y,f*d,p];w.push(h),w.push(l)}else h=e[0].reshape([y,u,s*a]),l=e[1].reshape([1,p,u]),m=[y,p,f*d],w.push(l),w.push(h);o&&w.push(e[2]);let g=m[2],b=w[0].dims[w[0].dims.length-1];return void(g<8&&b<8?t.compute(Xr(w,i,c,m,r),{inputs:w}):t.compute(Pr(w,i,c,m,r),{inputs:w}))}let m=t.kernelCustomData.wT??t.compute(Ke(e[1],to),{inputs:[1],outputs:[n.wIsConst?-2:-1]})[0];n.wIsConst&&!t.kernelCustomData.wT&&(t.kernelCustomData.wT=m);let y=[e[0],m];o&&y.push(e[2]);let w=r?f*d:p,g=r?p:f*d,b=h*l*u;t.compute(Ur(y,i,c,w,g,b,o,!0),{inputs:y})},oo=(t,e)=>{let n="NHWC"===e.format,i=[t.inputs[0].reshape(n?[t.inputs[0].dims[0],1,t.inputs[0].dims[1],t.inputs[0].dims[2]]:[t.inputs[0].dims[0],t.inputs[0].dims[1],1,t.inputs[0].dims[2]]),t.inputs[1].reshape([t.inputs[1].dims[0],t.inputs[1].dims[1],1,t.inputs[1].dims[2]])];3===t.inputs.length&&i.push(t.inputs[2]);let r=[0,e.pads[0],0,e.pads[1]],o=[1].concat(e.strides),s=[1].concat(e.dilations),a=[1].concat(e.kernelShape),u=no({...e,pads:r,strides:o,dilations:s,kernelShape:a},i);t.compute(Yr(i,u,(t=>n?[t[0],t[2],t[3]]:[])))},so=(t,e,n)=>{let i="NHWC"===n.format?"channelsLast":"channelsFirst",r=no(n,e),o="NOTSET"===n.autoPad?n.pads:n.autoPad,s=Vr(e[0].dims,e[1].dims,n.strides,n.dilations,o,!1,i);t.compute(Gr(e,r,s.outShape,[s.filterDepth,s.filterHeight,s.filterWidth],[s.padInfo.front,s.padInfo.top,s.padInfo.left],i))},ao=(t,e)=>{eo(t.inputs,e),3===t.inputs[0].dims.length?oo(t,e):5===t.inputs[0].dims.length?so(t,t.inputs,e):ro(t,t.inputs,e)}})),Vu=H((()=>{yu(),gu(),Su(),Pu(),Nu(),Uu(),qu(),uo=(t,e=!1,n,i,r=4)=>{let o=t?"\n    let coords = vec4<i32>(\n      batch,\n      row / outWidth,\n      row % outWidth,\n      col);\n    ":"\n    let coords = vec4<i32>(\n      batch,\n      row,\n      col / outWidth,\n      col % outWidth);\n    ",s=t?"row":"col",a=t?"col":"row",u=`\n      let inChannels = ${t?"i32(uniforms.x_shape[3])":"i32(uniforms.x_shape[1])"};\n      let outWidth = ${t?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n      let outRow = ${s} / outWidth;\n      let outCol = ${s} % outWidth;\n\n      let WRow = ${a} / (uniforms.filter_dims[1] * inChannels);\n      let WCol = ${a} / inChannels % uniforms.filter_dims[1];\n      let xR = f32(outRow - uniforms.pads[0] + uniforms.dilations[0] * WRow) / f32(uniforms.strides[0]);\n      let xC = f32(outCol - uniforms.pads[1] + uniforms.dilations[1] * WCol) / f32(uniforms.strides[1]);\n      if (xR < 0.0 || xR >= f32(${t?"i32(uniforms.x_shape[1])":"i32(uniforms.x_shape[2])"}) || fract(xR) > 0.0) {\n        return ${i}(0.0);\n      }\n      if (xC < 0.0 || xC >= f32(${t?"i32(uniforms.x_shape[2])":"i32(uniforms.x_shape[3])"}) || fract(xC) > 0.0) {\n        return ${i}(0.0);\n      }\n      let iXR = i32(xR);\n      let iXC = i32(xC);\n      let xCh = ${a} % inChannels;\n      ${t?"\n      let coord = vec4<i32>(batch, iXR, iXC, xCh);\n      ":"\n      let coord = vec4<i32>(batch, xCh, iXR, iXC);\n      "}\n      return x[getIndexFromCoords4D(coord, vec4<i32>(uniforms.x_shape))/${r}];`,h=t?`\n      let col = colIn * ${r};\n      if (row < uniforms.dim_a_outer && col < uniforms.dim_inner) {\n        ${u}\n      }\n      return ${i}(0.0);`:`\n      let col = colIn * ${r};\n      if (row < uniforms.dim_inner && col < uniforms.dim_b_outer) {\n        ${u}\n      }\n      return ${i}(0.0);`,l=`\n      let col = colIn * ${r};\n      let inChannels = ${t?"i32(uniforms.x_shape[3])":"i32(uniforms.x_shape[1])"};\n      let coordX = uniforms.filter_dims[0] - 1 - row / (uniforms.filter_dims[1] * inChannels);\n      let coordY = uniforms.filter_dims[1] - 1 - (row / inChannels) % uniforms.filter_dims[1];\n      if (${t?"row < uniforms.dim_inner && col < uniforms.dim_b_outer":"row < uniforms.dim_inner && col < uniforms.dim_a_outer"}  && coordX >= 0 && coordY >= 0) {\n        let rowInner = row % inChannels;\n        let coord = vec4<i32>(coordX, coordY, col, rowInner);\n        ${(t=>{switch(t){case 1:return"return w[getIndexFromCoords4D(coord, vec4<i32>(uniforms.w_shape))];";case 4:return`\n            let coord1 = vec4<i32>(coordX, coordY, col + 1, rowInner);\n            let coord2 = vec4<i32>(coordX, coordY, col + 2, rowInner);\n            let coord3 = vec4<i32>(coordX, coordY, col + 3, rowInner);\n            let v0 = w[getIndexFromCoords4D(coord, vec4<i32>(uniforms.w_shape))];\n            let v1 = w[getIndexFromCoords4D(coord1, vec4<i32>(uniforms.w_shape))];\n            let v2 = w[getIndexFromCoords4D(coord2, vec4<i32>(uniforms.w_shape))];\n            let v3 = w[getIndexFromCoords4D(coord3, vec4<i32>(uniforms.w_shape))];\n            return ${i}(v0, v1, v2, v3);\n            `;default:throw new Error(`innerElementSize ${t} is not supported.`)}})(r)}\n      }\n      return ${i}(0.0);\n      `,c=kr(n,i);return`\n  fn mm_readA(batch: i32, row : i32, colIn : i32) -> ${i} {\n    ${t?h:l}\n  }\n\n  fn mm_readB(batch: i32, row : i32, colIn : i32) -> ${i} {\n    ${t?l:h}\n  }\n\n  fn mm_write(batch: i32, row : i32, colIn : i32, valueInput : ${i}) {\n    let col = colIn * ${r};\n    if (row < uniforms.dim_a_outer && col < uniforms.dim_b_outer) {\n      var value = valueInput;\n      let outWidth = ${t?"i32(uniforms.result_shape[2])":"i32(uniforms.result_shape[3])"};\n      ${o}\n      ${Cr(e)}\n      ${c}\n      result[getIndexFromCoords4D(coords, vec4<i32>(uniforms.result_shape))/${r}] = value;\n    }\n  }`},ho=(t,e,n,i,r,o,s,a)=>{let u="NHWC"===e.format,h=u?t[0].dims[3]:t[0].dims[1],l=n[0],c=u?n[2]:n[3],f=u?n[1]:n[2],d=u?n[3]:n[1],p=u&&h%4==0&&h%3&&d%4==0,v=u?d:c*f,m=u?c*f:d,y=[8,8,1],w=i<=8?[4,1,1]:[4,4,1],g=[Math.ceil(v/y[0]/w[0]),Math.ceil(m/y[1]/w[1]),Math.ceil(l/y[2]/w[2])];ue("verbose",(()=>`[conv_backprop_mm_webgpu] dispatch = ${g}`));let b=p?4:1,_=Math.max(y[0]*b,y[1]),x=p?4:1,k=[e.kernelShape[u?1:2],e.kernelShape[u?2:3]],$=[k[0]+(e.dilations[0]<=1?0:(k[0]-1)*(e.dilations[0]-1)),k[1]+(e.dilations[1]<=1?0:(k[1]-1)*(e.dilations[1]-1))],S=[$[0]-1-Math.floor((e.pads[0]+e.pads[2])/2),$[1]-1-Math.floor((e.pads[1]+e.pads[3])/2)],E=[{type:6,data:i},{type:6,data:r},{type:6,data:o},{type:6,data:e.strides},{type:6,data:e.dilations},{type:6,data:k},{type:6,data:S}];$r(e,E),E.push(...Te(t[0].dims,t[1].dims));let M=["rank","rank"];return s&&(E.push(...Te(t[2].dims)),M.push("rank")),E.push(...Te(n)),{name:"Conv2DTransposeMatMul",shaderCache:{hint:`${e.cacheKey};${w};${y};${p}`,inputDependencies:M},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:g[0],y:g[1],z:g[2]},programUniforms:E}),getShaderSource:i=>{let r=Ue("x",t[0].dataType,t[0].dims.length,x),o=Ue("w",t[1].dataType,t[1].dims.length,1),h=qe("result",t[0].dataType,n.length,x),l=[r,o],c="";if(s){let e=Ue("bias",t[2].dataType,t[2].dims.length,x);l.push(e),c+=`\n          fn getBiasByOutputCoords(coords : vec4<i32>) -> ${e.type.value} {\n            return bias[coords.${u?"w":"y"}${p?"/ 4":""}];\n          }`}let f=[{name:"dim_a_outer",type:"i32"},{name:"dim_b_outer",type:"i32"},{name:"dim_inner",type:"i32"},{name:"strides",type:"i32",length:2},{name:"dilations",type:"i32",length:2},{name:"filter_dims",type:"i32",length:k.length},{name:"pads",type:"i32",length:S.length}];Sr(e,f);let d=Oe(t[0].dataType,1);if("f16"!==d&&"f32"!==d)throw new Error(`elemType ${d} is not supported.`);return`\n        ${Ar("uniforms.result_strides")}\n        ${i.registerUniforms(f).declareVariables(...l,h)};\n        ${c}\n        ${uo(u,s,e,r.type.value,b)}\n        ${p?Tr(w,y,d,void 0,!u,_):Fr(w,y,d,void 0,!u,_,!1,void 0,a)}`}}}})),Gu=H((()=>{yu(),gu(),$u(),Su(),lo=(t,e,n,i,r,o=!1,s,a,u=!1)=>{let h=u?1:2,l=u?2:3,c=u?3:1,f=o?2:1,d=`\n  fn setOutputAtIndex(flatIndex : u32, value : ${o?`vec4<${s}>`:s}) {\n    result[flatIndex] = ${o?`vec4<${s}>`:s}(value);\n  }`;i&&(d+=`\n    fn getBiasByOutputCoords(coords : vec4<u32>) -> ${o?`vec4<${s}>`:s} {\n      return bias[coords.${u?"w":"y"}${o?"/ 4":""}];\n    }`);let p=o?4:1,v=Ue("W",e[1].dataType,e[1].dims.length,p),m=Ue("Dy",e[0].dataType,e[0].dims.length,p),y=[m,v];i&&y.push(Ue("bias",e[2].dataType,[n[c]].length,p));let w=qe("result",e[0].dataType,n.length,p),g=`{\n        let batch: u32 = ${r?"global_id.z":"workgroup_id.z"} / uniforms.result_shape[1];\n        let r = ${r?"global_id.z":"workgroup_id.z"} % uniforms.result_shape[1];\n        let c = ${r?"global_id.y":"workgroup_id.y"} * ${f};\n        let d1: u32 = ${r?"global_id.x":"workgroup_id.x"} * 4;\n\n        let dyCorner = vec2<i32>(i32(r), i32(c)) - vec2<i32>(uniforms.pads);\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        var dotProd: array<vec4<${s}>, ${f}>;\n        for (var i = 0; i < ${f}; i++) {\n          dotProd[i] = vec4<${s}>(0.0);\n        }\n        for (var wR: u32 = 0; wR < uniforms.filter_dims[0]; wR = wR + 1) {\n          var dyR = (${s}(dyCorner.x) + ${s}(wR)) / ${s}(uniforms.strides.x);\n          let wRPerm = uniforms.filter_dims[0] - 1 - wR;\n          if (dyR < 0.0 || dyR >= ${s}(uniforms.Dy_shape[1]) ||\n              fract(dyR) > 0.0 || wRPerm < 0) {\n            continue;\n          }\n          let idyR: u32 = u32(dyR);\n\n          for (var wC: u32 = 0; wC < uniforms.filter_dims[1]; wC = wC + 1) {\n            let dyC = (${s}(dyCorner.y) + ${s}(wC)) / ${s}(uniforms.strides.y);\n            let dyC2 = (${s}(dyCorner.y) + 1.0 + ${s}(wC)) / ${s}(uniforms.strides.y);\n            let wCPerm = uniforms.filter_dims[1] - 1 - wC;\n            if (wCPerm < 0) {\n              continue;\n            }\n            var bDyCVal = true;\n            var bDyCVal2 = true;\n            if (dyC < 0.0 || dyC >= ${s}(uniforms.Dy_shape[2]) ||\n                fract(dyC) > 0.0) {\n              bDyCVal = false;\n            }\n            if (dyC2 < 0.0 || dyC2 >= ${s}(uniforms.Dy_shape[2]) ||\n                fract(dyC2) > 0.0) {\n              bDyCVal2 = false;\n            }\n\n            let idyC: u32 = u32(dyC);\n            let idyC2: u32 = u32(dyC2);\n            if (bDyCVal && bDyCVal2) {\n              let d2Length = uniforms.Dy_shape[3];\n              for (var d2 :u32 = 0; d2 < d2Length; d2 = d2 + 4) {\n                let wValue0 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1","d2")};\n                let wValue1 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 1","d2")};\n                let wValue2 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 2","d2")};\n                let wValue3 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 3","d2")};\n\n                var xValue = ${m.get("batch","idyR","idyC","d2")};\n                let tmpval = vec4<${s}>(dot(xValue, wValue0),\n                                      dot(xValue, wValue1),\n                                      dot(xValue, wValue2),\n                                      dot(xValue, wValue3));\n                dotProd[0] = dotProd[0] + tmpval;\n\n                xValue =  ${m.get("batch","idyR","idyC2","d2")};\n\n                dotProd[1] = dotProd[1] + vec4<${s}>(dot(xValue, wValue0),\n                                                    dot(xValue, wValue1),\n                                                    dot(xValue, wValue2),\n                                                    dot(xValue, wValue3));\n              }\n            } else if (bDyCVal) {\n              let d2Length = uniforms.Dy_shape[${c}];\n              for (var d2: u32 = 0; d2 < d2Length; d2 = d2 + 4) {\n                let wValue0 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1","d2")};\n                let wValue1 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 1","d2")};\n                let wValue2 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 2","d2")};\n                let wValue3 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 3","d2")};\n\n                var xValue = ${m.get("batch","idyR","idyC","d2")};\n                let tmpval = vec4<${s}>(dot(xValue, wValue0),\n                                      dot(xValue, wValue1),\n                                      dot(xValue, wValue2),\n                                      dot(xValue, wValue3));\n                dotProd[0] = dotProd[0] + tmpval;\n              }\n            } else if (bDyCVal2) {\n              let d2Length = uniforms.Dy_shape[3];\n              for (var d2: u32 = 0; d2 < d2Length; d2 = d2 + 4) {\n                let wValue0 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1","d2")};\n                let wValue1 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 1","d2")};\n                let wValue2 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 2","d2")};\n                let wValue3 = ${v.get("u32(wRPerm)","u32(wCPerm)","d1 + 3","d2")};\n\n                var xValue = ${m.get("batch","idyR","idyC2","d2")};\n                let tmpval = vec4<${s}>(dot(xValue, wValue0),\n                                      dot(xValue, wValue1),\n                                      dot(xValue, wValue2),\n                                      dot(xValue, wValue3));\n                dotProd[1] = dotProd[1] + tmpval;\n              }\n            }\n          }\n        }\n\n        for (var i: u32 = 0; i < ${f}; i = i + 1) {\n          let value = dotProd[i] + ${i?"bias[c+i]":`vec4<${s}>(0.0)`};\n          ${w.set("batch","r","c + i","d1","value")};\n        }\n      }`,b=`\n          let outputIndices = ${w.offsetToIndices("global_idx")};\n          let batch = ${w.indicesGet("outputIndices",0)};\n          let d1 = ${w.indicesGet("outputIndices",c)};\n          let r = ${w.indicesGet("outputIndices",h)};\n          let c = ${w.indicesGet("outputIndices",l)};\n          let dyCorner = vec2<i32>(i32(r), i32(c)) - uniforms.pads;\n          let dyRCorner = dyCorner.x;\n          let dyCCorner = dyCorner.y;\n          let groupId = d1 / uniforms.output_channels_per_group;\n          let wOutChannel = d1 - groupId * uniforms.output_channels_per_group;\n          // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n          // ? = to be determined. : = across all values in that axis.\n          var dotProd = ${s}(0.0);\n          for (var wR: u32 = 0; wR < uniforms.effective_filter_dims.x; wR = wR + 1) {\n            if (wR % uniforms.dilations.x != 0) {\n              continue;\n            }\n            let dyR = (${s}(dyRCorner) + ${s}(wR)) / ${s}(uniforms.strides[0]);\n            let wRPerm = uniforms.filter_dims.x - 1 - wR / uniforms.dilations.x;\n            if (dyR < 0.0 || dyR >= ${s}(uniforms.Dy_shape[${h}]) || fract(dyR) > 0.0 ||\n                wRPerm < 0) {\n              continue;\n            }\n            let idyR: u32 = u32(dyR);\n\n            for (var wC: u32 = 0; wC < uniforms.effective_filter_dims.y; wC = wC + 1) {\n              if (wC % uniforms.dilations.y != 0) {\n                continue;\n              }\n              let dyC = (${s}(dyCCorner) + ${s}(wC)) / ${s}(uniforms.strides.y);\n              let wCPerm = uniforms.filter_dims.y - 1 - wC / uniforms.dilations.y;\n              if (dyC < 0.0 || dyC >= ${s}(uniforms.Dy_shape[${l}]) ||\n                  fract(dyC) > 0.0 || wCPerm < 0) {\n                continue;\n              }\n              let idyC: u32 = u32(dyC);\n              var inputChannel = groupId * uniforms.input_channels_per_group;\n              for (var d2: u32 = 0; d2 < uniforms.input_channels_per_group; d2 = d2 + 1) {\n                let xValue = ${u?m.get("batch","idyR","idyC","inputChannel"):m.get("batch","inputChannel","idyR","idyC")};\n                let wValue = ${v.get("inputChannel","wOutChannel","u32(wRPerm)","u32(wCPerm)")};\n                dotProd = dotProd + xValue * wValue;\n                inputChannel = inputChannel + 1;\n              }\n            }\n          }\n          let value = dotProd + ${i?"bias[d1]":`${s}(0.0)`};\n          ${w.setByOffset("global_idx","value")};\n        `;return`\n  ${t.registerUniforms(a).declareVariables(...y,w)}\n  ${d}\n\n    ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")};\n  ${o?g:b}}`},co=(t,e,n)=>{let i=t.length>2,r=e.outputShape,o=ke.size(r),s=[Math.ceil(o/64),1,1];ue("verbose",(()=>`[conv2d_backprop_webgpu] dispatch = ${s}`));let a="NHWC"===e.format,u=["rank","rank"],h=[e.strides[0],e.strides[1]],l=[e.kernelShape[a?1:2],e.kernelShape[a?2:3]],c=[e.dilations[0],e.dilations[1]],f=[l[0]+(e.dilations[0]<=1?0:(e.kernelShape[a?1:2]-1)*(e.dilations[0]-1)),l[1]+(e.dilations[1]<=1?0:(e.kernelShape[a?2:3]-1)*(e.dilations[1]-1))],d=[f[0]-1-Math.floor((e.pads[0]+e.pads[2])/2),f[1]-1-Math.floor(e.pads[1]+e.pads[3])/2],p=e.group,v=t[1].dims,m=v[0]/p,y=v[1],w=[{type:12,data:o},{type:12,data:h},{type:12,data:l},{type:12,data:c},{type:12,data:f},{type:6,data:d},{type:12,data:m},{type:12,data:y},...Te(t[0].dims,t[1].dims)];i&&(w.push(...Te(t[2].dims)),u.push("rank")),w.push(...Te(r));let g=1===s[1]&&1===s[2];return{name:"ConvTranspose2D",shaderCache:{hint:`${e.cacheKey};`,inputDependencies:u},getRunData:()=>({dispatchGroup:{x:s[0],y:s[1],z:s[2]},outputs:[{dims:n?n(r):r,dataType:t[0].dataType}],programUniforms:w}),getShaderSource:e=>{let n=[{name:"output_size",type:"u32"},{name:"strides",type:"u32",length:h.length},{name:"filter_dims",type:"u32",length:l.length},{name:"dilations",type:"u32",length:l.length},{name:"effective_filter_dims",type:"u32",length:f.length},{name:"pads",type:"i32",length:d.length},{name:"input_channels_per_group",type:"u32"},{name:"output_channels_per_group",type:"u32"}],o=Oe(t[0].dataType);return`${lo(e,t,r,i,g,!1,o,n,a)}`}}}})),Yu=H((()=>{Vu(),Gu(),Pu(),Eu(),fo=(t,e,n,i,r,o)=>(t-1)*e+n+(i-1)*r+1-o,po=(t,e,n,i,r)=>{let o=Math.floor(t/2);"SAME_UPPER"===e?(n[i]=o,n[r]=t-o):"SAME_LOWER"===e&&(n[i]=t-o,n[r]=o)},vo=(t,e,n,i,r,o,s,a,u,h)=>{let l=t.length-2,c=0===h.length;if(0===u.length)for(let t=0;t<l;++t)u.push(0);let f=t[0],d=e[a?3:1]*r;for(let r=0,f=t.length-l-(a?1:0);r<l;++r,++f){let a=t[f],d=c?a*s[r]:h[r],p=fo(a,s[r],o[r],e[f],n[r],d);po(p,i,o,r,r+l),c&&h.push(s[r]*(a-1)+u[r]+(e[f]-1)*n[r]+1-o[r]-o[r+l])}h.splice(0,0,f),h.splice(a?3:1,0,d)},mo=(t,e)=>{let n=t.kernelShape.slice();if(0===t.kernelShape.length||0===t.kernelShape.reduce(((t,e)=>t*e),1)){n.length=0;for(let t=2;t<e[1].dims.length;++t)n.push(e[1].dims[t])}let i="NHWC"===t.format;n.splice(0,0,e[1].dims[0]),n.splice(i?3:1,0,e[1].dims[1]);let r=t.pads.slice(),o=t.outputShape.slice(),s=t.outputPadding.slice(),a=e[0].dims,u=t.dilations.slice();if(0===u.reduce(((t,e)=>t+e),0)){let t=e[0].dims.length-2;u=new Array(t).fill(1)}let h=t.strides.slice();if(0===h.reduce(((t,e)=>t+e),0)){let t=e[0].dims.length-2;h=new Array(t).fill(1)}vo(a,n,u,t.autoPad,t.group,r,h,i,s,o);let l=Object.assign({},t);return Object.assign(l,{kernelShape:n,pads:r,outputPadding:s,outputShape:o,dilations:u,strides:h}),l},yo=t=>{let e=Er(t),n=t.format,i=["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][typeof t.autoPad>"u"?0:t.autoPad],r=t.dilations,o=t.group,s=t.kernelShape,a=t.pads,u=t.strides,h=t.wIsConst();return{autoPad:i,format:n,dilations:r,group:o,kernelShape:s,outputPadding:t.outputPadding,outputShape:t.outputShape,pads:a,strides:u,wIsConst:h,...e,cacheKey:`${t.format};${e.activation};`}},wo=(t,e)=>{if(!t||2!==t.length&&3!==t.length)throw new Error("Conv requires 2 or 3 inputs");if(4!==t[0].dims.length&&3!==t[0].dims.length)throw new Error("currently only support 2-dimensional conv");if(t[0].dims.length!==t[1].dims.length)throw new Error("filter does not have same dimension as input");if(t[0].dims["NHWC"===e.format?t[0].dims.length-1:1]!==t[1].dims[0])throw new Error("FILTER_IN_CHANNEL should be equal to DATA_CHANNEL");let n=t[1].dims[1]*e.group;if(3===t.length&&(1!==t[2].dims.length||t[2].dims[0]!==n))throw new Error("invalid bias");let i=t[0].dims.length-2;if(e.dilations.reduce(((t,e)=>t+e),0)>0&&e.dilations.length!==i)throw new Error(`dilations should be ${i}D`);if(e.strides.reduce(((t,e)=>t+e),0)>0&&e.strides.length!==i)throw new Error(`strides should be ${i}D`);if(e.pads.reduce(((t,e)=>t+e),0)>0&&e.pads.length!==2*i)throw new Error(`pads should be ${2*i}D`);if(e.outputPadding.length!==i&&0!==e.outputPadding.length)throw new Error(`output_padding should be ${i}D`);if(e.kernelShape.reduce(((t,e)=>t+e),0)>0&&0!==e.kernelShape.length&&e.kernelShape.length!==t[1].dims.length-2)throw new Error("invalid kernel shape");if(0!==e.outputShape.length&&e.outputShape.length!==t[0].dims.length-2)throw new Error("invalid output shape")},go=[2,3,1,0],bo=(t,e,n)=>{let i=mo(n,e),r="NHWC"===n.format,o=i.outputShape,s=o[r?3:1],a=e[0].dims[r?3:1];if(1!==i.group||1===s&&1===a)return void t.compute(co(e,i));let u=o[r?1:2],h=o[r?2:3],l=r?u*h:s,c=r?s:u*h,f=e[1].dims[2]*e[1].dims[3]*a,d=t.kernelCustomData.wT??t.compute(Ke(e[1],go),{inputs:[1],outputs:[n.wIsConst?-2:-1]})[0];n.wIsConst&&!t.kernelCustomData.wT&&(t.kernelCustomData.wT=d);let p=[e[0],d],v=3===e.length;v&&(r||1!==e[2].dims.length?p.push(e[2]):p.push(e[2].reshape([e[2].dims[0],1,1]))),t.compute(ho(p,i,o,l,c,f,v,!0),{inputs:p})},_o=(t,e)=>{let n="NHWC"===e.format,i=[t.inputs[0].reshape(n?[t.inputs[0].dims[0],1,t.inputs[0].dims[1],t.inputs[0].dims[2]]:[t.inputs[0].dims[0],t.inputs[0].dims[1],1,t.inputs[0].dims[2]]),t.inputs[1].reshape([t.inputs[1].dims[0],t.inputs[1].dims[1],1,t.inputs[1].dims[2]])];3===t.inputs.length&&i.push(t.inputs[2]);let r=e.kernelShape;(0===r.length||0===r[0])&&(r=[t.inputs[1].dims[2]]);let o=e.dilations;(0===o.length||0===o[0])&&(o=[1]);let s=e.strides;(0===s.length||0===s[0])&&(s=[1]);let a=e.pads;0===a.length&&(a=[0,0]),a=[0,a[0],0,a[1]],s=[1].concat(s),o=[1].concat(o),r=[1].concat(r);let u=mo({...e,pads:a,strides:s,dilations:o,kernelShape:r},i);t.compute(co(i,u,(t=>n?[t[0],t[2],t[3]]:[t[0],t[1],t[3]])))},xo=(t,e)=>{wo(t.inputs,e),3===t.inputs[0].dims.length?_o(t,e):bo(t,t.inputs,e)}})),Ku=H((()=>{yu(),$u(),ku(),Su(),ko=(t,e,n,i)=>{let r=ke.size(e),o=e.length,s=Ue("input",t,o),a=qe("output",t,o),u=6===n.dataType?n.getInt32Array()[0]:Number(n.getBigInt64Array()[0]),h=ke.normalizeAxis(u,o);return{name:"CumSum",shaderCache:{hint:i.cacheKey,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:e,dataType:t}],dispatchGroup:{x:Math.ceil(r/64)},programUniforms:[{type:12,data:r},{type:12,data:h},...Te(e,e)]}),getShaderSource:t=>{let e=` i32(${s.indicesGet("inputIndices","uniforms.axis")}) `,n=Pe("uniforms.input_shape","uniforms.axis",o),r=i.reverse?e+(i.exclusive?" + 1":""):"0",u=i.reverse?n:e+(i.exclusive?"":" + 1");return`\n                ${t.registerUniform("outputSize","u32").registerUniform("axis","u32").declareVariables(s,a)}\n                ${t.mainStart()}\n                  ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n                  var inputIndices = ${a.offsetToIndices("global_idx")};\n                  var sum = ${a.type.value}(0);\n                  let first : i32 = ${r};\n                  let last : i32 = ${u};\n                  for (var i : i32 = first; i < last; i++) {\n                    ${s.indicesSet("inputIndices","uniforms.axis","u32(i)")};\n                    sum = sum + ${s.getByIndices("inputIndices")};\n                  }\n                  ${a.setByOffset("global_idx","sum")};\n                }`}}},$o=(t,e)=>{let n=t.inputs[0].dims,i=t.inputs[0].dataType,r=t.inputs[1];t.compute(ko(i,n,r,e),{inputs:[0]})},So=t=>{let e=1===t.exclusive,n=1===t.reverse;return be({exclusive:e,reverse:n})}})),Xu=H((()=>{yu(),$u(),ku(),Su(),Eo=t=>{if(!t||1!==t.length)throw new Error("DepthToSpace requires 1 input.");if(4!==t[0].dims.length)throw new Error("DepthToSpace requires 4D input.")},Mo=(t,e,n,i)=>{let r=[];r.push(`fn perm(i: ${i.type.indices}) -> ${n.type.indices} {\n    var a: ${n.type.indices};`);for(let i=0;i<e;++i)r.push(n.indicesSet("a",t[i],`i[${i}]`));return r.push("return a;}"),r.join("\n")},Co=(t,e)=>{let n,i,r,o,s,a,u="NHWC"===e.format,h=e.blocksize,l="DCR"===e.mode;u?([n,i,r,o]=t.dims,s=l?[n,i,r,h,h,o/h**2]:[n,i,r,o/h**2,h,h],a=l?[0,1,3,2,4,5]:[0,1,4,2,5,3]):([n,i,r,o]=[t.dims[0],t.dims[2],t.dims[3],t.dims[1]],s=l?[n,h,h,o/h**2,i,r]:[n,o/h**2,h,h,i,r],a=l?[0,3,4,1,5,2]:[0,1,4,2,5,3]);let c=t.reshape(s),f=c.dims.length,d=t.dataType,p=Ue("a",d,f),v=qe("output",d,f);return{name:"DepthToSpace",shaderCache:{hint:`${t.dims};${e.blocksize};${e.mode}`,inputDependencies:["rank"]},getRunData:t=>{let e=u?[n,i*h,r*h,o/h**2]:[n,o/h**2,i*h,r*h],s=ke.size(e),l=c.dims,f=ke.sortBasedOnPerm(l,a);return{outputs:[{dims:e,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:[{type:12,data:s},...Te(l,f)]}},getShaderSource:t=>`\n  ${t.registerUniform("output_size","u32").declareVariables(p,v)}\n\n  ${Mo(a,f,p,v)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let indices = ${v.offsetToIndices("global_idx")};\n    let aIndices = perm(indices);\n\n    ${v.setByOffset("global_idx",p.getByIndices("aIndices"))}\n  }`}},Ao=(t,e)=>{Eo(t.inputs),t.compute(Co(t.inputs[0],e))},Oo=t=>be({blocksize:t.blocksize,mode:t.mode,format:t.format})})),Qu=H((()=>{yu(),$u(),ku(),Su(),zo="^"+(To="("+(Io="[a-zA-Z]|\\.\\.\\.")+")+")+"$",Ro="^("+To+",)*"+To+"$",Fo=class{constructor(t=-1){this.symbolToIndices=new Map,this.inputIndex=t}addSymbol(t,e){let n=this.symbolToIndices.get(t);void 0===n?n=[e]:n.push(e),this.symbolToIndices.set(t,n)}},Do=class{constructor(t,e){this.equation=e,this.hasEllipsis=!1,this.symbolToInfo=new Map,this.lhs=new Array,this.outputDims=[];let[n,i]=e.includes("->")?e.split("->",2):[e,""];if(!n.match(RegExp(Ro)))throw new Error("Invalid LHS term");if(n.split(",").forEach(((e,n)=>{let i=t[n].dims.slice();if(!e.match(RegExp(zo)))throw new Error("Invalid LHS term");let r=this.processTerm(e,!0,i,n);this.lhs.push(r)})),""===i)i+=[...this.symbolToInfo.entries()].filter((([t,e])=>1===e.count||"..."===t)).map((([t])=>t)).join("");else if(!i.match(RegExp(To)))throw new Error("Invalid RHS");i.match(RegExp(Io,"g"))?.forEach((t=>{if("..."===t)this.outputDims=this.outputDims.concat(this.ellipsisDims);else{let e=this.symbolToInfo.get(t);if(void 0===e)throw new Error("Invalid RHS symbol");this.outputDims.push(e.dimValue)}})),this.rhs=this.processTerm(i,!1,this.outputDims)}addSymbol(t,e,n){let i=this.symbolToInfo.get(t);if(void 0!==i){if(i.dimValue!==e&&1!==i.count)throw new Error("Dimension mismatch");i.count++,i.inputIndices.push(n)}else i={count:1,dimValue:e,inputIndices:[n]};this.symbolToInfo.set(t,i)}processTerm(t,e,n,i=-1){let r=n.length,o=!1,s=[],a=0;if(!t.match(RegExp(zo))&&!e&&""!==t)throw new Error("Invalid LHS term");let u=t.match(RegExp(Io,"g")),h=new Fo(i);return u?.forEach(((t,l)=>{if("..."===t){if(o)throw new Error("Only one ellipsis is allowed per input term");o=!0;let t=r-u.length+1;if(t<0)throw new Error("Ellipsis out of bounds");if(s=n.slice(a,a+t),this.hasEllipsis){if(this.ellipsisDims.length!==s.length||this.ellipsisDims.toString()!==s.toString())throw new Error("Ellipsis dimensions mismatch")}else{if(!e)throw new Error("Ellipsis must be specified in the LHS");this.hasEllipsis=!0,this.ellipsisDims=s}for(let t=0;t<s.length;t++){let e=String.fromCharCode("0".charCodeAt(0)+t);h.addSymbol(e,l+t),this.addSymbol(e,n[a++],i)}}else h.addSymbol(t,l+(this.hasEllipsis?this.ellipsisDims.length-1:0)),this.addSymbol(t,n[a++],i)})),h}},Po=t=>t+"_max",No=(t,e,n,i)=>{let r=t.map((t=>t.length)).map(((t,n)=>Ue(`input${n}`,e,t))),o=ke.size(i),s=qe("output",e,i.length),a=[...n.symbolToInfo.keys()].filter((t=>!n.rhs.symbolToIndices.has(t)));return{name:"Einsum",shaderCache:{hint:n.equation,inputDependencies:t.map((()=>"rank"))},getRunData:()=>{let r=a.filter((t=>n.symbolToInfo.has(t))).map((t=>({type:12,data:n.symbolToInfo.get(t)?.dimValue||0})));r.push({type:12,data:o});let s=t.map(((t,e)=>[...Te(t)])).reduce(((t,e)=>t.concat(e)),r);return s.push(...Te(i)),{outputs:[{dims:i,dataType:e}],dispatchGroup:{x:Math.ceil(o/64)},programUniforms:s}},getShaderSource:t=>{let e=[],i=[],o=[],u=[],h=[],l=n.symbolToInfo.size===n.rhs.symbolToIndices.size;n.symbolToInfo.forEach(((t,a)=>{if(n.rhs.symbolToIndices.has(a)){let i=n.rhs.symbolToIndices.get(a)?.[0];void 0!==i&&n.lhs.forEach(((n,o)=>{if(t.inputIndices.includes(o)){let t=n.symbolToIndices.get(a);if(void 0===t)throw new Error("Invalid symbol error");t.forEach((t=>{e.push(`${r[o].indicesSet(`input${o}Indices`,t,s.indicesGet("outputIndices",i))}`)}))}}))}else n.lhs.forEach(((e,n)=>{if(t.inputIndices.includes(n)){let t=e.symbolToIndices.get(a);if(void 0===t)throw new Error("Invalid symbol error");t.forEach((t=>{i.push(`${r[n].indicesSet(`input${n}Indices`,t,`${a}`)}`)})),h.push(`prod *= ${r[n].getByIndices(`input${n}Indices`)};`)}})),o.push(`for(var ${a}: u32 = 0; ${a} < uniforms.${Po(a)}; ${a}++) {`),u.push("}")}));let c=l?[...e,`let sum = ${r.map(((t,e)=>t.getByIndices(`input${e}Indices`))).join(" * ")};`]:[...e,"var sum = 0.0;",...o,...i,"var prod = 1.0;",...h,"sum += prod;",...u];return`\n            ${t.registerUniforms(a.map((t=>({name:`${Po(t)}`,type:"u32"})))).registerUniform("outputSize","u32").declareVariables(...r,s)}\n\n            ${t.mainStart()}\n            ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n            var outputIndices = ${s.offsetToIndices("global_idx")};\n            ${r.map(((t,e)=>`var input${e}Indices: ${r[e].type.indices};`)).join("\n")}\n            ${c.join("\n")};\n            ${s.setByOffset("global_idx","sum")};\n          }`}}},Uo=(t,e)=>{let n=new Do(t.inputs,e.equation),i=n.outputDims,r=t.inputs.map(((t,e)=>t.dims));t.compute(No(r,t.inputs[0].dataType,n,i))},qo=t=>{let e=t.equation.replace(/\s+/g,"");return be({equation:e})}})),Zu=H((()=>{yu(),$u(),Su(),jo=t=>{if(!t||2!==t.length)throw new Error("Expand requires 2 input.");let e=t[0].dims,n=Array.from(t[1].getBigInt64Array(),Number),i=n.length<e.length?0:n.length-e.length,r=e.length<n.length?0:e.length-n.length;for(;i<n.length&&r<e.length;++i,++r)if(n[i]!==e[r]&&1!==n[i]&&1!==e[r])throw new Error("Expand requires shape to be broadcastable to input")},Lo=(t,e)=>{let n=t.length-e.length,i=[];for(let e=0;e<n;++e)i.push(t[e]);for(let r=0;r<e.length;++r)i.push(1===e[r]?t[r+n]:e[r]);return i},Bo=(t,e)=>t.length>e.length?Lo(t,e):Lo(e,t),Ho=t=>{let e=t[0].dims,n=Array.from(t[1].getBigInt64Array(),Number),i=Bo(e,n),r=t[0].dataType,o=9===r?4:1,s=Math.ceil(ke.size(i)/o),a=[{type:12,data:s},...Te(e,i)];return{name:"Expand",shaderCache:{hint:`${i.length}`,inputDependencies:["rank"]},getShaderSource:t=>{let n,s=Ue("input",r,e.length,o),a=qe("output",r,i.length,o);if(9===r){let t=(t,e,n="")=>`\n          let outputIndices${e} = ${a.offsetToIndices(`outputOffset + ${e}u`)};\n          let offset${e} = ${s.broadcastedIndicesToOffset(`outputIndices${e}`,a)};\n          let index${e} = offset${e} / 4u;\n          let component${e} = offset${e} % 4u;\n          ${t}[${e}] = ${n}(${s.getByOffset(`index${e}`)}[component${e}]);\n        `;n=`\n        let outputOffset = global_idx * ${o};\n        var data = vec4<u32>(0);\n        ${t("data",0,"u32")}\n        ${t("data",1,"u32")}\n        ${t("data",2,"u32")}\n        ${t("data",3,"u32")}\n        ${a.setByOffset("global_idx","data")}\n      }`}else n=`\n        let outputIndices = ${a.offsetToIndices("global_idx")};\n        let inputOffset = ${s.broadcastedIndicesToOffset("outputIndices",a)};\n        ${a.setByOffset("global_idx",s.getByOffset("inputOffset"))}\n      }`;return`\n    ${t.registerUniform("vec_size","u32").declareVariables(s,a)}\n    ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n    ${n}`},getRunData:()=>({outputs:[{dims:i,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:a})}},Wo=t=>{jo(t.inputs),t.compute(Ho(t.inputs),{inputs:[0]})}})),Ju=H((()=>{yu(),$u(),Su(),zu(),Vo=t=>{let e=t[0].dataType,n=ke.size(t[0].dims),i=ke.size(t[1].dims),r=i%4==0;return{name:"FastGeluWithBias",shaderCache:{hint:`${r}`,inputDependencies:["type","type"]},getShaderSource:t=>{let n=Ue("x",e,[1],4),i=Ue("bias",e,[1],4),o=qe("y",e,[1],4),s=t=>`\n      let bias${t}_offset: u32 = (global_idx * 4 + ${t}) % uniforms.bias_size;\n      let bias${t} = ${i.getByOffset(`bias${t}_offset / 4`)}[bias${t}_offset % 4];`,a=r?`\n      let bias = ${i.getByOffset("global_idx % (uniforms.bias_size / 4)")};`:`${s(0)}${s(1)}${s(2)}${s(3)}\n      let bias = ${n.type.value}(bias0, bias1, bias2, bias3);`;return`${t.registerUniforms([{name:"output_vec_size",type:"u32"},{name:"bias_size",type:"u32"}]).declareVariables(n,i,o)}\n\n    ${Gi(Ie(e))}\n\n    ${t.mainStart(Ce)}\n      ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_vec_size")}\n\n      let x = ${n.getByOffset("global_idx")};\n      ${a}\n      let x_in = x + bias;\n      ${o.setByOffset("global_idx",Yi("x_in"))}\n    }`},getRunData:t=>({outputs:[{dims:t[0].dims,dataType:t[0].dataType}],programUniforms:[{type:12,data:Math.ceil(n/4)},{type:12,data:i}],dispatchGroup:{x:Math.ceil(n/Ce/4)}})}},Go=t=>{t.inputs.length<2||0===ke.size(t.inputs[1].dims)?Ki(t):t.compute(Vo(t.inputs))}})),th=H((()=>{yu(),$u(),ku(),Su(),Yo=t=>{if(!t||2!==t.length)throw new Error("Gather requires 2 inputs.")},Ko=(t,e)=>{let n=t[0].dims,i=t[1].dims,r=n.length,o=ke.normalizeAxis(e.axis,r),s=n.slice(0);s.splice(o,1,...i);let a=n[o],u=9===t[0].dataType?4:1,h=Math.ceil(ke.size(s)/u),l=[{type:12,data:h},{type:6,data:a},{type:12,data:o},...Te(t[0].dims,t[1].dims,s)];return{name:"Gather",shaderCache:{hint:e.cacheKey,inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:s,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:l}),getShaderSource:e=>{let n,a=Ue("data",t[0].dataType,t[0].dims.length,u),h=Ue("inputIndices",t[1].dataType,t[1].dims.length),l=qe("output",t[0].dataType,s.length,u),c=t=>{let e=i.length,n=`var indicesIndices${t}  = ${h.type.indices}(0);`;for(let i=0;i<e;i++)n+=`${e>1?`indicesIndices${t}[${i}]`:`indicesIndices${t}`} = ${s.length>1?`outputIndices${t}[uniforms.axis + ${i}]`:`outputIndices${t}`};`;n+=`\n          var idx${t} = ${h.getByIndices(`indicesIndices${t}`)};\n          if (idx${t} < 0) {\n            idx${t} = idx${t} + uniforms.axisDimLimit;\n          }\n          var dataIndices${t} : ${a.type.indices};\n        `;for(let i=0,a=0;i<r;i++)i===o?(n+=`${r>1?`dataIndices${t}[${i}]`:`dataIndices${t}`} = u32(idx${t});`,a+=e):(n+=`${r>1?`dataIndices${t}[${i}]`:`dataIndices${t}`} = ${s.length>1?`outputIndices${t}[${a}]`:`outputIndices${t}`};`,a++);return n};if(9===t[0].dataType){let t=(t,e,n="")=>`\n          let outputIndices${e} = ${l.offsetToIndices(`outputOffset + ${e}u`)};\n          ${c(e)};\n          let offset${e} = ${a.indicesToOffset(`dataIndices${e}`)};\n          let index${e} = offset${e} / 4u;\n          let component${e} = offset${e} % 4u;\n          ${t}[${e}] = ${n}(${a.getByOffset(`index${e}`)}[component${e}]);\n        `;n=`\n        let outputOffset = global_idx * ${u};\n        var value = vec4<u32>(0);\n        ${t("value",0,"u32")}\n        ${t("value",1,"u32")}\n        ${t("value",2,"u32")}\n        ${t("value",3,"u32")}\n        ${l.setByOffset("global_idx","value")}\n      `}else n=`\n      let outputIndices = ${l.offsetToIndices("global_idx")};\n      ${c("")};\n      let value = ${a.getByIndices("dataIndices")};\n      ${l.setByOffset("global_idx","value")};\n      `;return`\n      ${e.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(a,h,l)}\n      ${e.mainStart()}\n        ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n        ${n}\n      }`}}},Xo=t=>be({axis:t.axis}),Qo=(t,e)=>{let n=t.inputs;Yo(n),t.compute(Ko(t.inputs,e))}})),eh=H((()=>{yu(),$u(),ku(),Su(),Zo=t=>{if(!t||2!==t.length)throw new Error("GatherElements requires 2 inputs.");if(t[0].dims.length<1)throw new Error("GatherElements requires that the data input be rank >= 1.");if(t[0].dims.length!==t[1].dims.length)throw new Error("GatherElements requires that the data input and\n                     indices input tensors be of same rank.")},Jo=(t,e)=>{let n=t[0].dims,i=t[0].dataType,r=n.length,o=t[1].dims,s=t[1].dataType,a=ke.normalizeAxis(e.axis,r),u=n[a],h=o.slice(0),l=ke.size(h),c=Ue("input",i,r),f=Ue("indicesInput",s,o.length),d=qe("output",i,h.length),p=[{type:12,data:l},{type:6,data:u},{type:12,data:a}];return p.push(...Te(n,o,h)),{name:"GatherElements",shaderCache:{inputDependencies:["rank","rank"]},getRunData:()=>({outputs:[{dims:h,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(l/64)},programUniforms:p}),getShaderSource:t=>`\n      ${t.registerUniform("outputSize","u32").registerUniform("axisDimLimit","i32").registerUniform("axis","u32").declareVariables(c,f,d)}\n      ${t.mainStart()}\n      ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n      let outputIndices = ${d.offsetToIndices("global_idx")};\n\n      var idx = ${f.getByOffset("global_idx")};\n      if (idx < 0) {\n        idx = idx + uniforms.axisDimLimit;\n      }\n      var inputIndices = ${c.type.indices}(outputIndices);\n      ${c.indicesSet("inputIndices","uniforms.axis","u32(idx)")};\n      let value = ${c.getByIndices("inputIndices")};\n\n      ${d.setByOffset("global_idx","value")};\n  }`}},ts=t=>be({axis:t.axis}),es=(t,e)=>{let n=t.inputs;Zo(n),t.compute(Jo(t.inputs,e))}})),nh=H((()=>{yu(),$u(),Su(),ns=t=>{if(!t)throw new Error("Input is missing");if(t.length<2||t.length>3)throw new Error("Invaid input number.");if(3===t.length&&t[2].dims.length>2)throw new Error("Invalid input shape of C");if(t[0].dataType!==t[1].dataType||3===t.length&&t[0].dataType!==t[2].dataType)throw new Error("Input types are mismatched")},is=(t,e)=>{let n=t[0].dims.slice(),i=t[1].dims.slice(),[r,o,s]=Se.getShapeOfGemmResult(n,e.transA,i,e.transB,3===t.length?t[2].dims:void 0),a=[r,o];if(!a)throw new Error("Can't use gemm on the given tensors");let u=ke.size(a),h=[{type:12,data:u},{type:12,data:r},{type:12,data:o},{type:12,data:s},{type:1,data:e.alpha},{type:1,data:e.beta}],l=["type","type"];return 3===t.length&&(h.push(...Te(t[2].dims)),l.push("rank")),h.push(...Te(a)),{name:"Gemm",shaderCache:{hint:`${e.cacheKey}`,inputDependencies:l},getRunData:()=>({outputs:[{dims:a,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(u/64)},programUniforms:h}),getShaderSource:n=>{let i="";e.transA&&e.transB?i="value += a[k * uniforms.M + m] * b[n * uniforms.K + k];":e.transA&&!e.transB?i="value += a[k * uniforms.M + m] * b[k * uniforms.N + n];":!e.transA&&e.transB?i="value += a[m * uniforms.K + k] * b[n * uniforms.K + k];":!e.transA&&!e.transB&&(i="value += a[m * uniforms.K + k] * b[k * uniforms.N + n];");let r=1===e.alpha?"":"value *= uniforms.alpha;",o=Ue("a",t[0].dataType,t[0].dims),s=Ue("b",t[1].dataType,t[1].dims),u=o.type.value,h=null,l=[o,s];3===t.length&&(h=Ue("c",t[2].dataType,t[2].dims.length),l.push(h));let c=qe("output",t[0].dataType,a.length);return l.push(c),`\n  ${n.registerUniforms([{name:"output_size",type:"u32"},{name:"M",type:"u32"},{name:"N",type:"u32"},{name:"K",type:"u32"},{name:"alpha",type:"f32"},{name:"beta",type:"f32"}]).declareVariables(...l)}\n\n  ${n.mainStart()}\n    ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n    let m = global_idx / uniforms.N;\n    let n = global_idx % uniforms.N;\n\n    var value = ${u}(0);\n    for (var k: u32 = 0u; k < uniforms.K; k++) {\n      ${i}\n    }\n\n    ${r}\n    ${null!=h?`let cOffset = ${h.broadcastedIndicesToOffset("vec2(m, n)",c)}; value += ${u}(uniforms.beta) * ${h.getByOffset("cOffset")};`:""}\n    output[global_idx] = value;\n  }`}}},rs=t=>({transA:t.transA,transB:t.transB,alpha:t.alpha,beta:t.beta,cacheKey:`${t.transA};${t.transB};${1===t.alpha}`}),os=(t,e)=>{ns(t.inputs),t.compute(is(t.inputs,e))}})),ih=H((()=>{yu(),$u(),ku(),_u(),Ou(),Su(),Eu(),ss=(t,e)=>t.length>e&&t[e].dims.length>0&&ke.size(t[e].dims)>0?t[e]:void 0,as=(t,e)=>{let n=t[0],i=ss(t,1),r=ss(t,2),o=ss(t,3),s=ss(t,4),a=ss(t,5),u=ss(t,6),h=ss(t,7);if(3!==n.dims.length&&5!==n.dims.length)throw new Error("Input query is expected to have 3 or 5 dimensions");let l,c=n.dims[0],f=n.dims[1],d=3===n.dims.length?n.dims[2]:e.numHeads*n.dims[4],p=f,v=0,m=0,y=Math.floor(d/e.numHeads);if(u&&h){if(4!==u.dims.length)throw new Error('Input "past_key" is expected to have 4 dimensions');if(u.dims[0]!==c||u.dims[1]!==e.numHeads||u.dims[3]!==y)throw new Error('Input "past_key" shape (batch_size, num_heads, past_sequence_length, head_size)');if(h.dims[0]!==c||h.dims[1]!==e.numHeads||h.dims[3]!==y)throw new Error('Input "past_value" shape (batch_size, num_heads, past_sequence_length, head_size)');if(u.dims[2]!==h.dims[2])throw new Error('Input "past_key" and "past_value" shall have same dim 2 (past_sequence_length)');if(4!==h.dims.length)throw new Error('Input "past_value" is expected to have 4 dimensions');v=u.dims[2],m=u.dims[2]}else if(u||h)throw new Error('Input "past_key" and "past_value" shall be both present or both absent');if(i){if(3!==n.dims.length)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(i.dims.length<3||i.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(n.dims[0]!==i.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(3===i.dims.length){if(i.dims[2]!==n.dims[2])throw new Error('Input "query" and "key" shall have same dim 2 (hidden_size)');l=2,p=i.dims[1]}else if(5===i.dims.length){if(i.dims[2]!==e.numHeads||2!==i.dims[3]||i.dims[4]!==y)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(r)throw new Error('Expect "value" be none when "key" has packed kv format.');l=5,p=i.dims[1]}else{if(i.dims[1]!==e.numHeads||i.dims[3]!==y)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');l=0,p=i.dims[2]}}else{if(3!==n.dims.length&&5!==n.dims.length)throw new Error('Input "query" is expected to have 3 or 5 dimensions when key is empty');if(5===n.dims.length&&(n.dims[2]!==e.numHeads||3!==n.dims[3]))throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');l=3}if(o){if(1!==o.dims.length)throw new Error('Input "bias" is expected to have 1 dimension');if(r&&5===n.dims.length&&2===n.dims[3])throw new Error("bias is not allowed for packed kv.")}let w=0;if(s){w=8;let t=s.dims;throw 1===t.length?t[0]===c?w=1:t[0]===3*c+2&&(w=3):2===t.length&&t[0]===c&&t[1]===p&&(w=5),8===w?new Error('Input "key_padding_mask" shape shall be (batch_size) or (batch_size, kv_sequence_length)'):new Error("Mask not supported")}let g=!1,b=d;if(r){if(3!==r.dims.length&&4!==r.dims.length)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(n.dims[0]!==r.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(3===r.dims.length){if(p!==r.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');b=r.dims[2]}else{if(p!==r.dims[2])throw new Error('Input "past_key" and "past_value" shall have the same dim 2 (kv_sequence_length)');b=r.dims[1]*r.dims[3],g=!0}}let _=v+p;if(s)throw new Error("Key padding mask is not supported");if(a){if(4!==a.dims.length)throw new Error('Input "relative_position_bias" is expected to have 4 dimensions');if(a.dims[0]!==c&&1!==a.dims[0]||a.dims[1]!==e.numHeads||a.dims[2]!==f||a.dims[3]!==_)throw new Error('Input "relative_position_bias" shape (batch_size, 1, sequence_length, kv_sequence_length)')}return{batchSize:c,sequenceLength:f,pastSequenceLength:v,kvSequenceLength:p,totalSequenceLength:_,maxSequenceLength:m,inputHiddenSize:0,hiddenSize:d,vHiddenSize:b,headSize:y,vHeadSize:Math.floor(b/e.numHeads),numHeads:e.numHeads,isUnidirectional:!1,pastPresentShareBuffer:!1,maskFilterValue:e.maskFilterValue,maskType:w,scale:e.scale,broadcastResPosBias:!1,passPastInKv:g,qkvFormat:l}},us=t=>be({...t}),hs=be({perm:[0,2,1,3]}),ls=(t,e,n,i,r,o,s)=>{let a=[i,r,o],u=ke.size(a),h=[{type:12,data:u},{type:12,data:s},{type:12,data:o}];return t.compute({name:"MultiHeadAttentionAddBias",shaderCache:{inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:a,dataType:e.dataType,gpuDataType:0}],dispatchGroup:{x:Math.ceil(u/64)},programUniforms:h}),getShaderSource:t=>{let i=qe("qkv_with_bias",e.dataType,a),r=Ue("qkv",e.dataType,a),o=Ue("bias",n.dataType,a);return`\n  ${t.registerUniforms([{name:"output_size",type:"u32"},{name:"bias_offset",type:"u32"},{name:"hidden_size",type:"u32"}]).declareVariables(r,o,i)}\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    let bias_offset_idx = (global_idx % uniforms.hidden_size) + uniforms.bias_offset;\n\n    qkv_with_bias[global_idx] = qkv[global_idx] + bias[bias_offset_idx];\n  }`}},{inputs:[e,n],outputs:[-1]})[0]},cs=(t,e,n,i,r,o,s,a)=>{let u=o;if(s){if(1===i)throw new Error("AddBiasReshape is not implemented. Please export your model with packed QKV or KV");return u=ls(t,o,s,e,i,n*r,a),u=u.reshape([e,i,n,r]),t.compute(Ke(u,hs.perm),{inputs:[u],outputs:[-1]})[0]}return 3===o.dims.length&&(u=o.reshape([e,i,n,r])),t.compute(Ke(u,hs.perm),{inputs:[u],outputs:[-1]})[0]},fs=(t,e)=>{let n=as(t.inputs,e),i=t.inputs[0],r=ss(t.inputs,1),o=ss(t.inputs,2),s=ss(t.inputs,3),a=ss(t.inputs,4),u=ss(t.inputs,5),h=ss(t.inputs,6),l=ss(t.inputs,7);if(5===i.dims.length)throw new Error("Packed QKV is not implemented");if(5===r?.dims.length)throw new Error("Packed KV is not implemented");let c=r&&o&&4===r.dims.length&&4===o.dims.length,f=cs(t,n.batchSize,n.numHeads,n.sequenceLength,n.headSize,i,s,0);if(c)return ti(t,f,r,o,a,void 0,h,l,u,n,e);if(!r||!o)throw new Error("key and value must be provided");let d=cs(t,n.batchSize,n.numHeads,n.kvSequenceLength,n.headSize,r,s,n.hiddenSize),p=cs(t,n.batchSize,n.numHeads,n.kvSequenceLength,n.vHeadSize,o,s,2*n.hiddenSize);ti(t,f,d,p,a,void 0,h,l,u,n,e)}})),rh=H((()=>{yu(),$u(),Su(),ds=t=>Array.from(t.getBigInt64Array(),Number),ps=t=>{if(!t||2!==t.length)throw new Error("Tile requires 2 inputs.");if(1!==t[0].dataType&&10!==t[0].dataType&&6!==t[0].dataType&&12!==t[0].dataType)throw new Error("Tile only support float, float16, int32, and uint32 data types");if(7!==t[1].dataType)throw new Error("Tile `repeats` input should be of int64 data type");if(1!==t[1].dims.length)throw new Error("Tile `repeats` input should be 1-D");if(ds(t[1]).length!==t[0].dims.length)throw new Error("Tile `repeats` input should have same number of elements as rank of input data tensor")},vs=(t,e)=>{let n=[];for(let i=0;i<t.length;++i)n.push(t[i]*e[i]);return n},ms=(t,e)=>{let n=t[0].dims,i=e??ds(t[1]),r=vs(n,i),o=ke.size(r),s=t[0].dataType,a=Ue("input",s,n.length),u=qe("output",s,r.length);return{name:"Tile",shaderCache:{hint:`${i}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:r,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(o/64)},programUniforms:[{type:12,data:o},...Te(t[0].dims,r)]}),getShaderSource:t=>`\n      const inputShape = ${a.indices(...n)};\n      ${t.registerUniform("output_size","u32").declareVariables(a,u)}\n      ${t.mainStart()}\n      ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n      let output_indices = ${u.offsetToIndices("global_idx")};\n      var input_indices: ${a.type.indices};\n      for (var i = 0; i < ${n.length}; i++) {\n        let input_dim_i = ${a.indicesGet("uniforms.input_shape","i")};\n        let input_dim_value = ${u.indicesGet("output_indices","i")}  % input_dim_i;\n\n        ${a.indicesSet("input_indices","i","input_dim_value")}\n      }\n      ${u.setByOffset("global_idx",a.getByIndices("input_indices"))}\n    }`}},ys=t=>{ps(t.inputs),t.compute(ms(t.inputs),{inputs:[0]})}})),oh=H((()=>{yu(),$u(),ku(),Ou(),Su(),ih(),rh(),Eu(),ws=(t,e)=>{let n=t[0],i=t[1],r=t[2],o=t[3],s=t[4];if(3!==n.dims.length&&5!==n.dims.length)throw new Error("Input query is expected to have 3 or 5 dimensions");let a,u=n.dims[0],h=n.dims[1],l=3===n.dims.length?n.dims[2]:e.numHeads*n.dims[4],c=h,f=0,d=0,p=Math.floor(l/e.numHeads),v=o&&0!==o.dims.length,m=s&&0!==s.dims.length;if(v&&m){if(4!==o.dims.length)throw new Error('Input "past_key" is expected to have 4 dimensions');if(4!==s.dims.length)throw new Error('Input "past_value" is expected to have 4 dimensions');f=o.dims[1],d=o.dims[1]}else if(v||m)throw new Error('Input "past_key" and "past_value" shall be both present or both absent');if(i){if(3!==n.dims.length)throw new Error('Input "query" is expected to have 3 dimensions when key is given');if(i.dims.length<3||i.dims.length>5)throw new Error('Input "key" is expected to have 3, 4, or 5 dimensions');if(n.dims[0]!==i.dims[0])throw new Error('Input "query" and "key" shall have same dim 0 (batch size)');if(3===i.dims.length){if(n.dims[2]%i.dims[2]!=0)throw new Error('Dimension 2 of "query" should be a multiple of "key"');a=2,c=i.dims[1]}else if(5===i.dims.length){if(i.dims[2]!==e.numHeads||2!==i.dims[3]||i.dims[4]!==p)throw new Error('Expect "key" shape (batch_size, kv_sequence_length, num_heads, 2, head_size) for packed kv');if(r)throw new Error('Expect "value" be none when "key" has packed kv format.');a=5,c=i.dims[1]}else{if(i.dims[1]!==e.numHeads||i.dims[3]!==p)throw new Error('Expect "key" shape (batch_size, num_heads, kv_sequence_length, head_size) for past_key');a=0,c=i.dims[2]}}else{if(3!==n.dims.length&&5!==n.dims.length)throw new Error('Input "query" is expected to have 3 or 5 dimensions when key is empty');if(5===n.dims.length&&(n.dims[2]!==e.numHeads||3!==n.dims[3]))throw new Error('Expect "query" shape (batch_size, kv_sequence_length, num_heads, 3, head_size) for packed kv');a=3}let y=!1,w=l;if(r){if(3!==r.dims.length&&4!==r.dims.length)throw new Error('Input "value" is expected to have 3 or 4 dimensions');if(n.dims[0]!==r.dims[0])throw new Error('Input "query" and "value" shall have same dim 0 (batch_size)');if(3===r.dims.length){if(c!==r.dims[1])throw new Error('Input "key" and "value" shall have the same dim 1 (kv_sequence_length)');w=r.dims[2]}else{if(c!==r.dims[2])throw new Error('Input "past_key" and "past_value" shall have the same dim 2 (kv_sequence_length)');w=r.dims[1]*r.dims[3],y=!0}}return{batchSize:u,sequenceLength:h,pastSequenceLength:f,kvSequenceLength:c,totalSequenceLength:f+c,maxSequenceLength:d,inputHiddenSize:0,hiddenSize:l,vHiddenSize:w,headSize:p,vHeadSize:Math.floor(w/e.kvNumHeads),numHeads:e.numHeads,kvNumHeads:e.kvNumHeads,nReps:e.numHeads/e.kvNumHeads,pastPresentShareBuffer:!1,maskType:0,scale:e.scale,broadcastResPosBias:!1,passPastInKv:y,qkvFormat:a,isPastkvBSNH:!0}},gs=(t,e,n,i)=>{let r=[i.batchSize,i.totalSequenceLength,i.kvNumHeads,i.headSize],o=ke.size(r)/4,s=i.totalSequenceLength,a=qe("present_kv",n,r.length,4),u=Ue("new_kv",t.dataType,t.dims.length,4),h=e?Ue("past_kv",e.dataType,e.dims.length,4):void 0,l=Math.ceil(i.headSize/4),c={x:s,y:t.dims[0],z:1},f=e?["rank","rank"]:["rank"],d=[{type:12,data:o},{type:12,data:i.pastSequenceLength},{type:12,data:i.kvSequenceLength},{type:12,data:i.totalSequenceLength}],p=[u];h?(d.push(...Te(t.dims),...Te(e.dims),...Te(r)),p.push(h)):d.push(...Te(t.dims),...Te(r));let v=[{name:"output_size",type:"u32"},{name:"past_seqlen",type:"u32"},{name:"new_seqlen",type:"u32"},{name:"present_seqlen",type:"u32"}],m="      let new_batch_stride = uniforms.new_seqlen * num_heads * H;\n        let new_row_stride = num_heads * H;\n        let new_head_stride = H;\n        let in_offset = b * new_batch_stride + (s - past_seqlen) * new_row_stride + n * new_head_stride + h;\n        present_kv[out_offset] = new_kv[in_offset];",y=e?`if (s < past_seqlen) {\n              let past_batch_stride = uniforms.past_seqlen * num_heads * H;\n        var past_head_stride = uniforms.past_seqlen * H;\n        if (is_bsnh) {\n          past_head_stride = H;\n        }\n        let in_offset = b * past_batch_stride + s * row_stride + n * past_head_stride + h;\n        present_kv[out_offset] = past_kv[in_offset];\n        } else if (s < past_seqlen + uniforms.new_seqlen) {\n        ${m}\n        }`:`if (s < past_seqlen + uniforms.new_seqlen) {\n          ${m}\n        }`;return{name:"ConcatPastNew",shaderCache:{hint:`${i.kvNumHeads}${l}${!!e}`,inputDependencies:f},getRunData:()=>({outputs:[{dims:r,dataType:n}],dispatchGroup:c,programUniforms:d}),getShaderSource:t=>`\n\n  ${t.registerUniforms(v).declareVariables(...p,a)}\n  ${t.mainStart([l,i.kvNumHeads,1])}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n    var indices = ${a.offsetToIndices("global_idx")};\n    let h = local_id.x;\n    let n = local_id.y;\n    let s = workgroup_id.x;\n    let b = workgroup_id.y;\n    let num_heads = ${i.kvNumHeads}u;\n    let H = ${l}u;\n\n    let present_seqlen = uniforms.present_seqlen;\n    let present_batch_stride = present_seqlen * num_heads * H;\n    var row_stride = H;\n    let is_bsnh = ${i.isPastkvBSNH};\n\n    if (is_bsnh) {\n      row_stride = num_heads * H;\n    }\n    var present_head_stride = present_seqlen * H;\n    if (is_bsnh) {\n      present_head_stride = H;\n    }\n\n    let past_seqlen = uniforms.past_seqlen;\n\n    let out_offset = b * present_batch_stride + s * row_stride + n * present_head_stride + h;\n    ${y}\n  }`}},bs=t=>be({...t}),_s=be({perm:[0,2,1,3]}),xs=(t,e,n,i,r)=>{let o=e,s=i.kvNumHeads,a=i.nReps;return 3===e.dims.length&&0!==i.kvSequenceLength&&(o=e.reshape([i.batchSize,i.kvSequenceLength,s,i.headSize])),o=n?t.compute(gs(o,n,o.dataType,i),{inputs:[o,n],outputs:[i.isPastkvBSNH?r:-1]})[0]:t.compute(gs(o,void 0,o.dataType,i),{inputs:[o],outputs:[i.isPastkvBSNH?r:-1]})[0],1!==a&&(o=t.compute(ms([o],[1,1,1,a]),{inputs:[o],outputs:[-1]})[0],o=o.reshape([i.batchSize,i.totalSequenceLength,s*a,i.headSize])),t.compute(Ke(o,_s.perm),{inputs:[o],outputs:[-1]})[0]},ks=(t,e)=>{let n=ws(t.inputs,e);if(5===t.inputs[0].dims.length)throw new Error("Packed QKV is not implemented");if(5===t.inputs[1]?.dims.length)throw new Error("Packed KV is not implemented");let i=cs(t,n.batchSize,n.numHeads,n.sequenceLength,n.headSize,t.inputs[0],void 0,0),r=t.inputs[3]&&0!==t.inputs[3].dims.length?t.inputs[3]:void 0,o=t.inputs[4]&&0!==t.inputs[4].dims.length?t.inputs[4]:void 0,s=xs(t,t.inputs[1],r,n,1),a=xs(t,t.inputs[2],o,n,2);ti(t,i,s,a,void 0,void 0,void 0,void 0,void 0,n,e)}})),sh=H((()=>{yu(),$u(),Su(),$s=(t,e)=>{let n=t[0].dims,i=n,r=ke.sizeToDimension(n,2),o=ke.sizeFromDimension(n,2),s=ze(o),a=o/s,u=[n[0],n[1],a],h=[{type:12,data:o},{type:12,data:a}];return h.push(...Te(u,u)),{name:"InstanceNormalization",shaderCache:{hint:`${e.epsilon};${s}`,inputDependencies:["rank","type","type"]},getRunData:()=>({outputs:[{dims:i,dataType:t[0].dataType}],dispatchGroup:{x:r},programUniforms:h}),getShaderSource:n=>{let i=Ue("x",t[0].dataType,u.length,s),r=Ue("scale",t[1].dataType,t[1].dims),o=Ue("bias",t[2].dataType,t[2].dims),a=qe("output",t[0].dataType,u.length,s),h=[i,r,o,a],l=i.type.value,c=1===s?"f32":`vec${s}<f32>`;return`\n  var<workgroup> meanShared : f32;\n  var<workgroup> squaredNormShared : f32;\n  var<workgroup> workgroupShared : array<${c}, 64>;\n  const workgroupSize = 64u;\n  ${n.registerUniforms([{name:"normSize",type:"u32"},{name:"normPackedSize",type:"u32"}]).declareVariables(...h)}\n  ${n.mainStart(64)}\n    let norm = global_idx / workgroupSize;\n    let batch = norm / uniforms.x_shape[1];\n    let channel = norm % uniforms.x_shape[1];\n    let localIndex = local_id.x;\n\n    // initialize workgroup memory\n    var initial = ${c}(0);\n    for (var h = localIndex; h < uniforms.normPackedSize; h += workgroupSize) {\n      initial = initial + ${c}(${i.get("batch","channel","h")});\n    }\n    workgroupShared[localIndex] = initial;\n    workgroupBarrier();\n\n    // Calculate the mean of current channel data.\n    for (var currSize = workgroupSize >> 1;  currSize > 0; currSize = currSize >> 1) {\n      if (localIndex < currSize) {\n        workgroupShared[localIndex] = workgroupShared[localIndex] + workgroupShared[localIndex + currSize];\n      }\n      workgroupBarrier();\n    }\n    if (localIndex == 0) {\n      meanShared = ${De("workgroupShared[0]",s)} / f32(uniforms.normSize);\n    }\n    workgroupBarrier();\n\n    // reinitialize workgroup memory.\n    initial = ${c}(0);\n    for (var h = localIndex; h < uniforms.normPackedSize; h += workgroupSize) {\n      let deviation =  ${c}(${i.get("batch","channel","h")}) - ${c}(meanShared);\n      initial = initial + deviation * deviation;\n    }\n    workgroupShared[localIndex] = initial;\n    workgroupBarrier();\n\n    // Calculate the sum of square of deviation of current channel data.\n    for (var currSize = workgroupSize >> 1;  currSize > 0; currSize = currSize >> 1) {\n      if (localIndex < currSize) {\n        workgroupShared[localIndex] = workgroupShared[localIndex] + workgroupShared[localIndex + currSize];\n      }\n      workgroupBarrier();\n    }\n    if (localIndex == 0) {\n      squaredNormShared = ${De("workgroupShared[0]",s)};\n    }\n    workgroupBarrier();\n\n    let invStdDev = inverseSqrt(squaredNormShared / f32(uniforms.normSize) + f32(${e.epsilon}));\n    let channelScale = invStdDev * f32(${r.getByOffset("channel")});\n    let channelShift = f32(${o.getByOffset("channel")}) - meanShared * channelScale;\n    for (var h = localIndex; h < uniforms.normPackedSize; h += workgroupSize) {\n      let value = ${i.get("batch","channel","h")} * ${l}(${c}(channelScale)) + ${l}(${c}(channelShift));\n      ${a.set("batch","channel","h","value")};\n    }\n  }`}}},Ss=(t,e,n,i,r,o,s,a)=>{let u=ze(s),h=1===u?"vec2f":`mat2x${u}f`,l=1===u?"f32":`vec${u}f`,c=(t,e)=>`${h}(${t}, ${e})`,f=r*s/u,d=[{type:12,data:Math.ceil(o/64)},{type:12,data:o},{type:12,data:Math.floor(s/u)},{type:12,data:Math.floor(o*s/u)}],p=t.compute({name:"InstanceNormComputeMean",shaderCache:{hint:`${u}`,inputDependencies:["type"]},getRunData:()=>({outputs:[{dims:[r,s,64,2],dataType:1}],dispatchGroup:{x:r*s/u},programUniforms:d}),getShaderSource:t=>{let n=Ue("input",e.dataType,e.dims,u);return`\n  ${t.declareVariables(n)}\n  @group(0) @binding(1) var<storage, read_write> output : array<${h}>;\n  struct Uniforms {wg_size:u32, H:u32, C:u32, image_size:u32};\n  @group(0) @binding(2) var<uniform> uniforms: Uniforms;\n\n  ${t.mainStart(64)}\n    let currentImageNumber = global_idx / 64 / uniforms.C;\n    let currentChannelNumber = (global_idx / 64) % uniforms.C;\n    let wgOffset = local_id.x * uniforms.wg_size;\n    if (wgOffset >= uniforms.H) {\n        return;\n    }\n    let wgMax = min(wgOffset + uniforms.wg_size, uniforms.H);\n\n    let offset = currentImageNumber * uniforms.image_size + currentChannelNumber;\n    var sum = ${Re("f32",u)};\n    var squaredSum = ${Re("f32",u)};\n    for (var i: u32 = wgOffset; i < wgMax; i++) {\n        let value = ${l}(input[offset + i * uniforms.C]);\n        sum += value;\n        squaredSum += value * value;\n    }\n    output[global_idx] = ${c("sum","squaredSum")};\n  }`}},{inputs:[e],outputs:[-1]})[0],v=[{type:12,data:f},{type:12,data:o},{type:12,data:Math.floor(s/u)},{type:12,data:Math.floor(64*s/u)}];return t.compute({name:"InstanceNormComputeChannelScaleShift",shaderCache:{hint:`${u};${a}`,inputDependencies:["type","type","type"]},getRunData:()=>({outputs:[{dims:[r,s,2],dataType:1}],dispatchGroup:{x:Math.ceil(f/64)},programUniforms:v}),getShaderSource:t=>{let e=Ue("scale",n.dataType,n.dims,u),r=Ue("bias",i.dataType,i.dims,u);return`\n  @group(0) @binding(0) var<storage, read> input : array<${h}>;\n  @group(0) @binding(1) var<storage, read> scale : array<${e.type.storage}>;\n  @group(0) @binding(2) var<storage, read> bias : array<${r.type.storage}>;\n  @group(0) @binding(3) var<storage, read_write> output : array<${h}>;\n  struct Uniforms {units_of_work : u32, H: u32, C : u32, image_size : u32};\n  @group(0) @binding(4) var<uniform> uniforms: Uniforms;\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.units_of_work")}\n    let currentImageNumber = global_idx / uniforms.C;\n    let currentChannelNumber = global_idx % uniforms.C;\n\n    let offset = currentImageNumber * uniforms.image_size;\n    var sum = ${Re("f32",u)};\n    var squaredSum = ${Re("f32",u)};\n    for (var i: u32 = 0; i < min(64, uniforms.H); i++) {\n        let value = input[offset + i + currentChannelNumber * 64];\n        sum += value[0];\n        squaredSum += value[1];\n    }\n    sum = sum / f32(uniforms.H);\n    squaredSum = squaredSum / f32(uniforms.H);\n    let invStdDev = inverseSqrt(squaredSum - sum * sum + f32(${a}));\n    let channelScale = invStdDev * ${l}(scale[currentChannelNumber]);\n    let channelShift = ${l}(bias[currentChannelNumber]) - sum * channelScale;\n\n    output[global_idx] = ${c("channelScale","channelShift")};\n  }`}},{inputs:[p,n,i],outputs:[-1]})[0]},Es=(t,e,n)=>{let i=e[0].dims,r=i,o=i[0],s=i[i.length-1],a=ke.sizeFromDimension(i,1)/s,u=ze(s),h=ke.size(r)/u,l=[{type:12,data:a},{type:12,data:Math.floor(s/u)}],c=Ss(t,e[0],e[1],e[2],o,a,s,n.epsilon);t.compute({name:"InstanceNormalizationNHWC",shaderCache:{hint:`${u}`,inputDependencies:["type","type"]},getRunData:()=>({outputs:[{dims:r,dataType:e[0].dataType}],dispatchGroup:{x:Math.ceil(h/64)},programUniforms:l}),getShaderSource:t=>{let n=Oe(e[0].dataType),i=1===u?"vec2f":`mat2x${u}f`,o=1===u?n:`vec${u}<${n}>`,s=Ue("input",e[0].dataType,e[0].dims,u),a=qe("output",e[0].dataType,r,u);return`\n  @group(0) @binding(0) var<storage, read> input : array<${s.type.storage}>;\n  @group(0) @binding(1) var<storage, read> scaleInput : array<${i}>;\n  @group(0) @binding(2) var<storage, read_write> output : array<${a.type.storage}>;\n  struct Uniforms {H: u32, C : u32};\n  @group(0) @binding(3) var<uniform> uniforms: Uniforms;\n\n  ${t.mainStart()}\n    let currentImageNumber = global_idx / (uniforms.C * uniforms.H);\n    let currentChannelNumber = global_idx % uniforms.C;\n\n    let scaleOffset = currentImageNumber * uniforms.C + currentChannelNumber;\n    let scale = scaleInput[scaleOffset];\n    output[global_idx] = fma(input[global_idx], ${o}(scale[0]), ${o}(scale[1]));\n  }`}},{inputs:[e[0],c]})},Ms=(t,e)=>{"NHWC"===e.format?Es(t,t.inputs,e):t.compute($s(t.inputs,e))}})),ah=H((()=>{yu(),$u(),Su(),Cs=t=>{if(!t||t.length<2)throw new Error("layerNorm requires at least 2 inputs.")},As=(t,e,n)=>{let i=e.simplified,r=t[0].dims,o=t[1],s=!i&&t[2],a=r,u=ke.normalizeAxis(e.axis,r.length),h=ke.sizeToDimension(r,u),l=ke.sizeFromDimension(r,u),c=ke.size(o.dims),f=s?ke.size(s.dims):0;if(c!==l||s&&f!==l)throw new Error(`Size of X.shape()[axis:] == ${l}.\n       Size of scale and bias (if provided) must match this.\n       Got scale size of ${c} and bias size of ${f}`);let d=[];for(let t=0;t<r.length;++t)t<u?d.push(r[t]):d.push(1);let p=ze(l),v=["type","type"],m=[{type:12,data:h},{type:1,data:l},{type:12,data:Math.floor(l/p)},{type:1,data:e.epsilon}];s&&v.push("type");let y=n>1,w=n>2,g=[{dims:a,dataType:t[0].dataType}];return y&&g.push({dims:d,dataType:1}),w&&g.push({dims:d,dataType:1}),{name:"LayerNormalization",shaderCache:{hint:`${p};${n};${i}`,inputDependencies:v},getRunData:()=>({outputs:g,dispatchGroup:{x:Math.ceil(h/64)},programUniforms:m}),getShaderSource:e=>{let n=Oe(t[0].dataType),r=[Ue("x",t[0].dataType,t[0].dims,p),Ue("scale",o.dataType,o.dims,p)];return s&&r.push(Ue("bias",s.dataType,s.dims,p)),r.push(qe("output",t[0].dataType,a,p)),y&&r.push(qe("mean_data_output",1,d)),w&&r.push(qe("inv_std_output",1,d)),`\n  ${e.registerUniforms([{name:"norm_count",type:"u32"},{name:"norm_size",type:"f32"},{name:"norm_size_vectorized",type:"u32"},{name:"epsilon",type:"f32"}]).declareVariables(...r)}\n  ${e.mainStart()}\n    ${e.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.norm_count")}\n    let offset = global_idx * uniforms.norm_size_vectorized;\n    var mean_vector = ${Re("f32",p)};\n    var mean_square_vector = ${Re("f32",p)};\n\n    for (var h: u32 = 0u; h < uniforms.norm_size_vectorized; h++) {\n      let value = ${Fe(n,p,"x[h + offset]")};\n      mean_vector += value;\n      mean_square_vector += value * value;\n    }\n    let mean = ${De("mean_vector",p)} / uniforms.norm_size;\n    let inv_std_dev = inverseSqrt(${De("mean_square_vector",p)} / uniforms.norm_size ${i?"":"- mean * mean"} + uniforms.epsilon);\n\n    for (var j: u32 = 0; j < uniforms.norm_size_vectorized; j++) {\n      let f32input = ${Fe(n,p,"x[j + offset]")};\n      let f32scale = ${Fe(n,p,"scale[j]")};\n      output[j + offset] = ${r[0].type.value}((f32input ${i?"":"- mean"}) * inv_std_dev * f32scale\n        ${s?`+ ${Fe(n,p,"bias[j]")}`:""}\n      );\n    }\n\n    ${y?"mean_data_output[global_idx] = mean":""};\n    ${w?"inv_std_output[global_idx] = inv_std_dev":""};\n  }`}}},Os=(t,e)=>{Cs(t.inputs),t.compute(As(t.inputs,e,t.outputCount))}})),uh=H((()=>{yu(),$u(),ku(),Su(),Is=(t,e)=>{if(t.length<3||t.length>4)throw new Error("MatMulNBits requires 3 or 4 inputs");let n=t[0],i=n.dims.length;if(n.dims[i-1]!==e.k)throw new Error("The last dim of input shape does not match the k value");let r=Math.floor((e.k+e.blockSize-1)/e.blockSize),o=e.blockSize/8*e.bits,s=t[1];if(!ke.areEqual(s.dims,[e.n,r,o]))throw new Error("The second inputs must be 3D tensor with shape N X nBlocksPerCol X blobSize");let a=t[2].dims;if(ke.size(a)!==e.n*r)throw new Error("scales input size error.");if(4===t.length){let n=t[3].dims,i=e.bits>4?e.n*r:e.n*Math.floor((r+1)/2);if(ke.size(n)!==i)throw new Error("zeroPoints input size error.")}},Ts=(t,e,n,i)=>{let r=t[0].dims,o=r.length,s=Math.floor((e.k+e.blockSize-1)/e.blockSize),a=r[o-2],u=e.k,h=e.n,l=r.slice(0,o-2),c=ke.size(l),f=e.blockSize/8*e.bits/4,d=t[0].dataType,p=ze(a),v=ze(e.k),m=ze(f),y=Zt(d),w=a*s*y,g=Math.floor(i/w),b=s<=n[0]&&g>0,_=!b||g>=4?ze(h):g>=2&&ze(h)>=2?2:1,x=l.concat([a,h]),k=ke.size(x)/_/p,$=b?[]:[{type:12,data:k},{type:12,data:e.blockSize}],S=[c,a,u/v],E=ke.convertShape(t[1].dims).slice();E.splice(-1,1,f/m),$.push(...Te(S)),$.push(...Te(E)),$.push(...Te(t[2].dims)),4===t.length&&$.push(...Te(ke.convertShape(t[3].dims)));let M=[c,a,h/_];return $.push(...Te(M)),{name:b?"BlockwiseMatMulNBits":"MatMulNBits",shaderCache:{hint:`${e.cacheKey};${a};${d};${t.length}`,inputDependencies:Array(t.length).fill("rank")},getRunData:()=>({outputs:[{dims:x,dataType:d}],name:b?"BlockwiseMatMulNBits":"MatMulNBits",dispatchGroup:b?{x:1,y:Math.ceil(h/_),z:c}:{x:Math.ceil(k/64)},programUniforms:$}),getShaderSource:n=>{let i=S.length,r=Ue("a",t[0].dataType,i,v),o=Ue("b",12,E.length,m),u=Ue("scales",t[2].dataType,t[2].dims.length),l=[r,o,u],c=4===t.length?Ue("zero_points",12,t[3].dims.length):void 0;c&&l.push(c);let d=M.length,y=qe("output",t[0].dataType,d,_),w=Oe(t[0].dataType),g=(()=>{switch(v){case 1:return`array<${w}, 8>`;case 2:return`mat4x2<${w}>`;case 4:return`mat2x4<${w}>`;default:throw new Error(`${v}-component is not supported.`)}})(),x=`\n        for (var word: u32 = 0; word < ${f}; word += ${m}) {\n          ${o.indicesSet("b_indices","2","word")};\n          let b_data = ${o.getByIndices("b_indices")};\n          for (var i: u32 = 0; i < ${m}; i++) {\n            let b_value: u32 = ${1===m?"b_data":"b_data[word + i]"};\n            let b_mask: u32 = 0x0F0F0F0Fu;\n            let b_value_lower: vec4<u32> = unpack4xU8(b_value & b_mask);\n            let b_value_upper: vec4<u32> = unpack4xU8((b_value >> 4) & b_mask);\n            let b_quantized_values = ${g}(${Array.from({length:4},((t,e)=>`${w}(b_value_lower[${e}]), ${w}(b_value_upper[${e}])`)).join(", ")});\n            let b_dequantized_values = ${1===v?`${g}(${Array.from({length:8},((t,e)=>`(b_quantized_values[${e}] - zero_point) * scale`)).join(", ")});`:`(b_quantized_values - ${g}(${Array(8).fill("zero_point").join(",")})) * scale;`};\n            // Number of B elements per 32-bit word is 32/bits = 32/4 = 8\n            for (var m: u32 = 0; m < ${b?a:p}u; m++) {\n              ${r.indicesSet("a_indices",i-2,b?"m":`row * ${p} + m`)};\n              ${r.indicesSet("a_indices",i-1,"word_offset")};\n              var input_offset = ${r.indicesToOffset("a_indices")};\n              var a_data: ${g};\n              for (var j: u32 = 0; j < ${8/v}; j++) {\n                a_data[j] = ${r.getByOffset("input_offset")};\n                input_offset++;\n              }\n              ${b?"workgroup_shared[workgroup_shared_offset + m]":"output_values[m]"}${_>1?"[c]":""} += ${Array.from({length:8/v},((t,e)=>1===v?`a_data[${e}] * b_dequantized_values[${e}]`:`dot(a_data[${e}], b_dequantized_values[${e}])`)).join(" + ")};\n            }\n            word_offset += ${8/v};\n          }\n        }`,k=c?`\n          zero_point_offset += 4;\n          if (zero_point_offset == 32) {\n            zero_point_offset = 0;\n            zero_point_index++;\n            zero_point_word = ${c.getByOffset("zero_point_index")};\n          }`:"";return b?`\n        var<workgroup> workgroup_shared: array<${y.type.value}, ${a*s}>;\n        ${n.declareVariables(...l,y)}\n        ${n.mainStart([s,1,1])}\n          var a_indices: ${r.type.indices};\n          var block = local_id.x;\n          var col = workgroup_id.y;\n          var batch = workgroup_id.z;\n          ${r.indicesSet("a_indices","0","batch")};\n          // Two zero points are packed into one byte when uniforms.bits is 4.\n          for (var c: u32 = 0; c < ${_}; c++) {\n            let col_times_components_plus_c = col * ${_} + c;\n              ${c?`\n            var zero_point_bytes_per_col: u32 = (${s} + 1) / 2;\n            var zero_point_byte_count: u32 = col_times_components_plus_c * zero_point_bytes_per_col + (block >> 0x1u);\n            var zero_point_word_index: u32 = zero_point_byte_count >> 0x2u;\n            var zero_point_byte_offset: u32 = zero_point_byte_count & 0x3u;\n            var zero_point_nibble_offset: u32 = block & 0x1u;\n            var zero_point_bits_offset: u32 = (zero_point_byte_offset << 3) + (zero_point_nibble_offset << 2);\n            var zero_point_word: u32 = ${c.getByOffset("zero_point_word_index")} >> zero_point_bits_offset;`:""}\n            var b_indices: ${o.type.indices};\n            ${o.indicesSet("b_indices","0","col_times_components_plus_c")};\n            // The scale and zero points are computed per block.\n            var scales_index = col_times_components_plus_c * ${s} + block;\n            let scale = ${u.getByOffset("scales_index")};\n            // The default zero point is 8 for unsigned 4-bit quantization.\n            let zero_point = ${w}(${c?"(zero_point_word) & 0xFu":8});\n            ${o.indicesSet("b_indices","1","block")};\n            var word_offset: u32 = block * ${e.blockSize/v};\n            var workgroup_shared_offset: u32 = block * ${a};\n            ${x}\n          }\n          workgroupBarrier();\n          var output_indices: ${y.type.indices};\n          var elements_per_thread: u32 = ${Math.ceil(a/s)};\n          ${y.indicesSet("output_indices","0","batch")};\n          ${y.indicesSet("output_indices",d-1,"col")};\n          ${y.indicesSet("output_indices",d-2,"local_id.x * elements_per_thread")};\n          var output_offset = ${y.indicesToOffset("output_indices")};\n          for (var m: u32 = 0u; m < elements_per_thread; m++) {\n            var row = m + local_id.x * elements_per_thread;\n            if (row < ${a}) {\n              var output_value: ${y.type.value} = ${y.type.value}(0);\n              var workgroup_shared_offset: u32 = row;\n              for (var b: u32 = 0u; b < ${s}u; b++) {\n                output_value += workgroup_shared[workgroup_shared_offset];\n                workgroup_shared_offset += ${a};\n              }\n              ${y.setByOffset("output_offset","output_value")};\n              output_offset += ${h/_};\n            }\n          }\n        }`:`\n        ${n.registerUniforms([{name:"output_size",type:"u32"},{name:"block_size",type:"u32"}]).declareVariables(...l,y)}\n        ${n.mainStart()}\n          ${n.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n          var output_values: array<${y.type.value}, ${p}>;\n          var output_indices = ${y.offsetToIndices("global_idx")};\n          var col = ${y.indicesGet("output_indices",d-1)};\n          var row = ${y.indicesGet("output_indices",d-2)};\n          var a_indices: ${r.type.indices} = output_indices;\n          // Two zero points are packed into one byte because uniforms.bits <= 4.\n          // zero_point_offset is either 0 or 4. It is bit offset within one byte.\n          // TODO support zero_point_offset for bits > 4\n          ${c?`\n          var zero_point_abs_offset = col * ${_} * ((${s} + 1) / 2);\n          var zero_point_index: u32 = zero_point_abs_offset / 4;\n          var zero_point_word: u32 = ${c.getByOffset("zero_point_index")};\n          var zero_point_offset: u32 = (zero_point_abs_offset % 4) * 8;`:""}\n          var scale_index = col * ${s*_};\n          var b_indices: ${o.type.indices};\n          for (var c: u32 = 0; c < ${_}; c++) {\n            ${o.indicesSet("b_indices","0",`col * ${_} + c`)};\n            var block_offset: u32 = 0;\n            for (var block: u32 = 0; block < ${s}; block++) {\n              // The scale and zero points are computed per block.\n              let scale = ${u.getByOffset("scale_index")};\n              // The default zero point is 8 for unsigned 4-bit quantization.\n              let zero_point = ${w}(${c?"extractBits(zero_point_word, zero_point_offset, 4)":8});\n              ${o.indicesSet("b_indices","1","block")};\n              var word_offset: u32 = block_offset;\n              ${x}\n              scale_index++;\n              ${k}\n              block_offset += uniforms.block_size / ${v};\n            }\n            // Drop the trailing 4 bits if the zero_poit_offset is not a byte boundary to align with the next byte.\n            ${c?`if (zero_point_offset % 8 > 0) {\n                ${k}\n              }`:""}\n            }\n            for (var k: u32 = 0u; k < ${p}u; k++) {\n              ${y.indicesSet("output_indices",d-2,`${p} * row + k`)};\n              ${y.setByIndices("output_indices","output_values[k]")}\n            }\n        }`}}},zs=(t,e)=>{Is(t.inputs,e);let n=t.getMaxComputeWorkgroupSizes(),i=t.getMaxComputeWorkgroupStoragesize();t.compute(Ts(t.inputs,e,n,i))},Rs=t=>be(t)})),hh=H((()=>{yu(),$u(),Su(),Fs=t=>{if(!t||t.length<1)throw new Error("Too few inputs");if(1!==t[0].dataType&&10!==t[0].dataType)throw new Error("Input type must be float or float16.");if(t.length>=2){let e=2*t[0].dims.length===t[1].dims[0];if(4===t.length&&(e=2*t[3].dims[0]===t[1].dims[0]),!e)throw new Error("The pads should be a 1D tensor of shape [2 * input_rank] or [2 * num_axes].")}},Ds=(t,e,n)=>{let i="";for(let r=e-1;r>=0;--r)i+=`\n            k = i32(${t.indicesGet("indices",r)}) - ${Pe("uniforms.pads",r,n)};\n            if (k < 0) {\n              break;\n            }\n            if (k >= i32(${Pe("uniforms.x_shape",r,e)})) {\n              break;\n            }\n            offset += k * i32(${Pe("uniforms.x_strides",r,e)});\n        `;return`\n          value = ${t.type.value}(uniforms.constant_value);\n          for (var i = 0; i < 1; i++) {\n            var offset = 0;\n            var k = 0;\n            ${i}\n            value = x[offset];\n          }\n      `},Ps=(t,e,n)=>{let i="";for(let r=e-1;r>=0;--r)i+=`\n                k = i32(${t.indicesGet("indices",r)}) - ${Pe("uniforms.pads",r,n)};\n                if (k < 0) {\n                  k = -k;\n                }\n                {\n                  let _2n_1 = 2 * (i32(${Pe("uniforms.x_shape",r,e)}) - 1);\n                  k = k % _2n_1;\n                  if(k >= i32(${Pe("uniforms.x_shape",r,e)})) {\n                    k = _2n_1 - k;\n                  }\n                }\n                offset += k * i32(${Pe("uniforms.x_strides",r,e)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${i}\n              value = x[offset];\n          `},Ns=(t,e,n)=>{let i="";for(let r=e-1;r>=0;--r)i+=`\n                k = i32(${t.indicesGet("indices",r)}) - ${Pe("uniforms.pads",r,n)};\n                if (k < 0) {\n                  k = 0;\n                }\n                if (k >= i32(${Pe("uniforms.x_shape",r,e)})) {\n                  k = i32(${Pe("uniforms.x_shape",r,e)}) - 1;\n                }\n                offset += k * i32(${Pe("uniforms.x_strides",r,e)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${i}\n              value = x[offset];\n          `},Us=(t,e,n)=>{let i="";for(let r=e-1;r>=0;--r)i+=`\n                k = i32(${t.indicesGet("indices",r)}) - ${Pe("uniforms.pads",r,n)};\n                if (k < 0)  {\n                  k += i32(${Pe("uniforms.x_shape",r,e)}]);\n                }\n                if (k >= i32(${Pe("uniforms.x_shape",r,e)})) {\n                  k -= i32(${Pe("uniforms.x_shape",r,e)});\n                }\n                offset += k * i32(${Pe("uniforms.x_strides",r,e)});\n            `;return`\n              var offset = 0;\n              var k = 0;\n              ${i}\n              value = x[offset];\n          `},qs=(t,e,n)=>{switch(n.mode){case 0:return Ds(t,e,n.pads.length);case 1:return Ps(t,e,n.pads.length);case 2:return Ns(t,e,n.pads.length);case 3:return Us(t,e,n.pads.length);default:throw new Error("Invalid mode")}},js=(t,e)=>{let n=ke.padShape(t[0].dims.slice(),e.pads),i=t[0].dims,r=[{type:12,data:ke.size(n)},{type:6,data:e.pads}];return 0===e.mode&&r.push({type:t[0].dataType,data:e.value}),r.push(...Te(t[0].dims,n)),{name:"Pad",shaderCache:{hint:`${e.mode}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:n,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(ke.size(n)/64)},programUniforms:r}),getShaderSource:r=>{let o=qe("output",t[0].dataType,n.length),s=Ue("x",t[0].dataType,i.length),a=s.type.value,u=qs(o,i.length,e),h=[{name:"output_size",type:"u32"},{name:"pads",type:"i32",length:e.pads.length}];return 0===e.mode&&h.push({name:"constant_value",type:a}),`\n            ${r.registerUniforms(h).declareVariables(s,o)}\n            ${r.mainStart()}\n            ${r.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n\n            let indices = ${o.offsetToIndices("global_idx")};\n\n            var value = ${a}(0);\n            ${u}\n            output[global_idx] = value;\n        }`}}},Ls=(t,e)=>{if(t.length>1){let n=t[1].getBigInt64Array(),i=t.length>=3&&t[2].data?t[2].getFloat32Array()[0]:0,r=t[0].dims.length,o=new Int32Array(2*r).fill(0);if(t.length>=4){let e=t[3].getBigInt64Array();for(let t=0;t<e.length;t++)o[Number(e[t])]=Number(n[t]),o[Number(e[t])+r]=Number(n[t+e.length])}else n.forEach(((t,e)=>o[Number(e)]=Number(t)));let s=[];return o.forEach((t=>s.push(t))),{mode:e.mode,value:i,pads:s}}return e},Bs=(t,e)=>{Fs(t.inputs);let n=Ls(t.inputs,e);t.compute(js(t.inputs,n),{inputs:[0]})}})),lh=H((()=>{pt(),yu(),$u(),Su(),Hs=t=>{if(v.webgpu.validateInputContent&&(!t||1!==t.length))throw new Error("Pool ops requires 1 input.")},Ws=(t,e,n)=>{let i="NHWC"===e.format,r=t.dims.slice();i&&r.splice(1,0,r.pop());let o=Object.hasOwnProperty.call(e,"dilations"),s=e.kernelShape.slice(),a=e.strides.slice(),u=o?e.dilations.slice():[],h=e.pads.slice();$e.adjustPoolAttributes(n,r,s,a,u,h);let l=$e.computePoolOutputShape(n,r,a,u,s,h,e.autoPad),c=Object.assign({},e);o?Object.assign(c,{kernelShape:s,strides:a,pads:h,dilations:u,cacheKey:e.cacheKey}):Object.assign(c,{kernelShape:s,strides:a,pads:h,cacheKey:e.cacheKey});let f=l.slice();return f.push(f.splice(1,1)[0]),[c,i?f:l]},Vs=(t,e)=>{let n="NHWC"===e.format,i=[{type:12,data:ke.size(t)},{type:12,data:ke.size(e.kernelShape)}],r=[{name:"outputSize",type:"u32"},{name:"kernelSize",type:"u32"}];if(e.kernelShape.length<=2){let t=e.kernelShape[e.kernelShape.length-1],n=e.strides[e.strides.length-1],o=e.pads[e.pads.length/2-1],s=e.pads[e.pads.length-1],a=!!(o+s);i.push({type:12,data:t},{type:12,data:n},{type:12,data:o},{type:12,data:s}),r.push({name:"kw",type:"u32"},{name:"sw",type:"u32"},{name:"pwStart",type:"u32"},{name:"pwEnd",type:"u32"});let u=!1;if(2===e.kernelShape.length){let t=e.kernelShape[e.kernelShape.length-2],n=e.strides[e.strides.length-2],o=e.pads[e.pads.length/2-2],s=e.pads[e.pads.length-2];u=!!(o+s),i.push({type:12,data:t},{type:12,data:n},{type:12,data:o},{type:12,data:s}),r.push({name:"kh",type:"u32"},{name:"sh",type:"u32"},{name:"phStart",type:"u32"},{name:"phEnd",type:"u32"})}return[i,r,!0,a,u]}{if(n)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let t=ke.computeStrides(e.kernelShape);i.push({type:12,data:t},{type:12,data:e.pads},{type:12,data:e.strides}),r.push({name:"kernelStrides",type:"u32",length:t.length},{name:"pads",type:"u32",length:e.pads.length},{name:"strides",type:"u32",length:e.strides.length});let o=e.pads.reduce(((t,e)=>t+e));return[i,r,!!o,!1,!1]}},Gs=(t,e,n,i,r,o,s,a,u,h,l,c)=>{let f="NHWC"===r.format,d=e.type.value,p=qe("output",e.type.tensor,i);if(r.kernelShape.length<=2){let i="",h="",v="",m=n-(f?2:1);if(i=l?`\n                for (var i: u32 = 0u; i < uniforms.kw; i++) {\n                  xIndices[${m}] = indices[${m}] * uniforms.sw - uniforms.pwStart + i;\n                  if (xIndices[${m}] < 0 || xIndices[${m}]\n                      >= uniforms.x_shape[${m}]) {\n                    pad++;\n                    continue;\n                  }\n                  let x_val = x[${e.indicesToOffset("xIndices")}];\n                  ${o}\n                }`:`\n                for (var i: u32 = 0u; i < uniforms.kw; i++) {\n                  xIndices[${m}] = indices[${m}] * uniforms.sw - uniforms.pwStart + i;\n                  let x_val = x[${e.indicesToOffset("xIndices")}];\n                  ${o}\n                }`,2===r.kernelShape.length){let t=n-(f?3:2);h=c?`\n                for (var j: u32 = 0u; j < uniforms.kh; j++) {\n                  xIndices[${t}] = indices[${t}] * uniforms.sh - uniforms.phStart + j;\n                  if (xIndices[${t}] < 0 || xIndices[${t}] >= uniforms.x_shape[${t}]) {\n                    pad += i32(uniforms.kw);\n                    continue;\n                  }\n              `:`\n                for (var j: u32 = 0u; j < uniforms.kh; j++) {\n                  xIndices[${t}] = indices[${t}] * uniforms.sh - uniforms.phStart + j;\n                `,v="\n              }\n            "}return`\n            ${t.registerUniforms(u).declareVariables(e,p)}\n\n            ${t.mainStart()}\n              ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n\n              let indices = ${p.offsetToIndices("global_idx")};\n              var xIndices = ${p.offsetToIndices("global_idx")};\n\n              var value = ${d}(${a});\n              var pad = 0;\n              ${h}\n              ${i}\n              ${v}\n              ${s}\n\n              output[global_idx] = value;\n            }`}{if(f)throw new Error("Pooling with kernelShape.length > 2 is not supported for NHWC format.");let i=r.kernelShape.length,l=r.pads.length,c="";return c=h?`\n                if (xIndices[j] >= uniforms.x_shape[j]) {\n                  pad++;\n                  isPad = true;\n                  break;\n                }\n              }\n              if (!isPad) {\n                let x_val = x[${e.indicesToOffset("xIndices")}];\n                ${o}\n              }`:`\n              }\n              let x_val = x[${e.indicesToOffset("xIndices")}];\n              ${o}\n            `,`\n            ${t.registerUniforms(u).declareVariables(e,p)}\n\n            ${t.mainStart()}\n              ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n              let indices = ${p.offsetToIndices("global_idx")};\n              var xIndices = ${p.offsetToIndices("global_idx")};\n\n              var offsets: array<u32, ${i}>;\n\n              var value = ${d}(${a});\n              var pad = 0;\n              var isPad = false;\n\n              for (var i: u32 = 0u; i < uniforms.kernelSize; i++) {\n                var offset = i;\n                for (var j = 0u; j < ${i-1}u; j++) {\n                  offsets[j] = offset / ${Pe("uniforms.kernelStrides","j",i)};\n                  offset -= offsets[j] * ${Pe("uniforms.kernelStrides","j",i)};\n                }\n                offsets[${i-1}] = offset;\n\n                isPad = false;\n                for (var j = ${n-i}u; j < ${n}u; j++) {\n                  xIndices[j] = indices[j] * ${Pe("uniforms.strides",`j - ${n-i}u`,i)}\n                    + offsets[j - ${n-i}u] - ${Pe("uniforms.pads","j - 2u",l)};\n                  ${c}\n              }\n              ${s}\n\n              output[global_idx] = value;\n            }`}},Ys=t=>`${t.format};${t.ceilMode};${t.autoPad};${t.kernelShape.length}`,Ks=t=>`${Ys(t)};${t.countIncludePad}`,Xs=t=>`${Ys(t)};${t.storageOrder};${t.dilations}`,Qs=t=>({format:t.format,autoPad:["NOTSET","VALID","SAME_UPPER","SAME_LOWER"][t.auto_pad],ceilMode:t.ceil_mode,kernelShape:t.kernel_shape,strides:t.strides,pads:t.pads}),Zs=(t,e,n,i)=>{let[r,o]=Ws(e,i,n),s=Ue("x",e.dataType,e.dims.length),a=s.type.value,u="";r.countIncludePad?u+=`value /= ${a}(uniforms.kernelSize);`:u+=`value /= ${a}(i32(uniforms.kernelSize) - pad);`;let[h,l,c,f,d]=Vs(o,r);return h.push(...Te(e.dims,o)),{name:t,shaderCache:{hint:`${i.cacheKey};${c};${f};${d}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:o,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(ke.size(o)/64)},programUniforms:h}),getShaderSource:t=>Gs(t,s,e.dims.length,o.length,r,"value += x_val;",u,0,l,c,f,d)}},Js=t=>{let e=0!==t.count_include_pad,n=Qs(t);if(0!==n.ceilMode)throw new Error("using ceil() in shape computation is not yet supported for AveragePool");let i={countIncludePad:e,...n,cacheKey:""};return{...i,cacheKey:Ks(i)}},ta=(t,e)=>{Hs(t.inputs),t.compute(Zs("AveragePool",t.inputs[0],!1,e))},ea={autoPad:"",ceilMode:0,countIncludePad:!1,kernelShape:[],strides:[],pads:[],storageOrder:0,dilations:[]},na=t=>{let e=t.format;return{format:e,...ea,cacheKey:e}},ia=(t,e)=>{Hs(t.inputs),t.compute(Zs("GlobalAveragePool",t.inputs[0],!0,e))},ra=(t,e,n,i)=>{let[r,o]=Ws(e,i,n),s=Ue("x",e.dataType,e.dims.length),[a,u,h,l,c]=Vs(o,r);return a.push(...Te(e.dims,o)),{name:t,shaderCache:{hint:`${i.cacheKey};${h};${l};${c}`,inputDependencies:["rank"]},getRunData:()=>({outputs:[{dims:o,dataType:e.dataType}],dispatchGroup:{x:Math.ceil(ke.size(o)/64)},programUniforms:a}),getShaderSource:t=>Gs(t,s,e.dims.length,o.length,r,"\n      value = max(x_val, value);\n    ","",10===e.dataType?-65504:-1e5,u,h,l,c)}},oa=(t,e)=>{Hs(t.inputs),t.compute(ra("MaxPool",t.inputs[0],!1,e))},sa=t=>{let e=t.storage_order,n=t.dilations,i=Qs(t);if(0!==e)throw new Error("column major storage order is not yet supported for MaxPool");if(0!==i.ceilMode)throw new Error("using ceil() in shape computation is not yet supported for MaxPool");let r={storageOrder:e,dilations:n,...i,cacheKey:""};return{...r,cacheKey:Xs(r)}},aa=t=>{let e=t.format;return{format:e,...ea,cacheKey:e}},ua=(t,e)=>{Hs(t.inputs),t.compute(ra("GlobalMaxPool",t.inputs[0],!0,e))}})),ch=H((()=>{pt(),yu(),Su(),ha=(t,e,n)=>{if(t===e||t<e&&n<0||t>e&&n>0)throw new Error("Range these inputs' contents are invalid.")},la=(t,e,n,i)=>{let r=Math.abs(Math.ceil((e-t)/n)),o=[r],s=r,a=[{type:12,data:s},{type:i,data:t},{type:i,data:n},...Te(o)];return{name:"Range",shaderCache:{hint:`${i}`},getShaderSource:t=>{let e=qe("output",i,o.length),n=e.type.value,r=[{name:"outputSize",type:"u32"},{name:"start",type:n},{name:"delta",type:n}];return`\n        ${t.registerUniforms(r).declareVariables(e)}\n        ${t.mainStart()}\n        ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n        output[global_idx] = uniforms.start + ${n}(global_idx) * uniforms.delta;\n      }`},getRunData:()=>({outputs:[{dims:o,dataType:i}],dispatchGroup:{x:Math.ceil(s/64)},programUniforms:a})}},ca=t=>{let e=0,n=0,i=0;6===t.inputs[0].dataType?(e=t.inputs[0].getInt32Array()[0],n=t.inputs[1].getInt32Array()[0],i=t.inputs[2].getInt32Array()[0]):1===t.inputs[0].dataType&&(e=t.inputs[0].getFloat32Array()[0],n=t.inputs[1].getFloat32Array()[0],i=t.inputs[2].getFloat32Array()[0]),v.webgpu.validateInputContent&&ha(e,n,i),t.compute(la(e,n,i,t.inputs[0].dataType),{inputs:[]})}})),fh=H((()=>{yu(),$u(),ku(),Su(),fa=(t,e)=>{if(t.every((t=>t>0||(()=>{throw new Error("Resize requires scales input values to be positive")}))),t.length>0)if("linear"===e.mode){if(!(2===t.length||3===t.length||4===t.length&&1===t[0]&&1===t[1]||4===t.length&&1===t[0]&&1===t[3]||5===t.length&&1===t[0]&&1===t[1]))throw new Error("For linear mode, Resize requires scales to be 2D, 3D, 4D with either two outermost or one innermost and\n            one outermost scale values equal to 1, or 5D with two outermost scale values equal to 1")}else if("cubic"===e.mode&&!(2===t.length||4===t.length&&1===t[0]&&1===t[1]||4===t.length&&1===t[0]&&1===t[3]))throw new Error("Resize requires scales input size to be 2 or 4 for cubic mode")},da=(t,e,n)=>{e.every((t=>t>=0&&t<n||(()=>{throw new Error("Resize requires axes input values to be positive and less than rank")})));let i=new Array(n).fill(1);return e.forEach(((e,n)=>i[e]=t[n])),i},pa=(t,e,n,i,r,o)=>{let[s,a,u]=n>10?[1,2,3]:[-1,t.length>1?1:-1,-1],h=t[0].dims.length;if(s>0&&t.length>s&&t[s].dims.length>0)t[s].getFloat32Array().forEach((t=>o.push(t)));else if("tf_crop_and_resize"===e.coordinateTransformMode)throw new Error("Resize requires RoI input to be specified when coordinateTransformMode is tfCropAndResize");if(a>0&&t.length>a&&t[a].dims.length>0){if(t[a].getFloat32Array().forEach((t=>i.push(t))),0!==i.length&&i.length!==h&&n>=18&&i.length!==e.axes.length)throw new Error("Resize requires scales input size to be same as input rank or axes size for opset 18 and up");fa(i,e),e.axes.length>0&&da(i,e.axes,h).forEach(((t,e)=>i[e]=t))}if(u>0&&t.length>u&&(t[u].getBigInt64Array().forEach((t=>r.push(Number(t)))),r.length!==h||n>=18&&r.length===e.axes.length))throw new Error("Resize requires sizes input size to be same as input rank or axes size for opset 18 and up");if(e.axes.length>0){if(i.length!==e.axes.length)throw new Error('Resize requires "scales" input size to be of axes rank when axes attributes is specified');if(r.length!==e.axes.length)throw new Error('Resize requires "sizes" input size to be of rank axes rank when axes attributes is specified')}if(typeof i<"u"&&typeof r<"u"&&i.length>0&&r.length>h)throw new Error("Resize requires only of scales or sizes to be specified")},va=(t,e)=>`fn getOriginalCoordinateFromResizedCoordinate(xResized: u32, xScale: f32, lengthResized: u32,\n     lengthOriginal: u32, roiStart: f32, roiEnd: f32) -> ${e} { `+(()=>{switch(t){case"asymmetric":return`return ${e}(xResized) / ${e}(xScale);`;case"pytorch_half_pixel":return`if (lengthResized > 1) {\n                    return (${e}(xResized) + 0.5) / ${e}(xScale) - 0.5;\n                  } else {\n                    return 0.0;\n                  }`;case"tf_half_pixel_for_nn":return`return (${e}(xResized) + 0.5) / ${e}(xScale);`;case"align_corners":return`if (lengthResized == 1) {\n                    return 0.0;\n                  } else {\n                    // The whole part and the fractional part are calculated separately due to inaccuracy of floating\n                    // point division. As an example, f32(21) / f32(7) may evaluate to 2.99... instead of 3, causing an\n                    // offset-by-one error later in floor().\n                    let whole = ${e}(xResized * (lengthOriginal - 1) / (lengthResized - 1));\n                    let fract =\n                        ${e}(xResized * (lengthOriginal - 1) % (lengthResized - 1)) / ${e}(lengthResized - 1);\n                    return whole + fract;\n                  }`;case"tf_crop_and_resize":return`if (lengthResized > 1) {\n                    return ${e}(roiStart) * ${e}(lengthOriginal - 1) +\n                        (${e}(xResized) * ${e}(roiEnd - roiStart) * ${e}(lengthOriginal - 1)) /\n                        ${e}(lengthResized - 1);\n                  } else {\n                    return 0.5 * ${e}(roiStart + roiEnd) * ${e}(lengthOriginal - 1);\n                  }`;case"half_pixel_symmetric":return`const outputWidth = ${e}xScale * ${e}(lengthResized);\n                  const adjustment = ${e}(lengthResized) / outputWidth;\n                  const center = ${e}(lengthOriginal) / 2;\n                  const offset = center * (1 - adjustment);\n                  return offset + ((${e}(xResized) + 0.5) / ${e}(xScale)) - 0.5;`;case"half_pixel":return`return ((${e}(xResized) + 0.5) / ${e}(xScale)) - 0.5;`;default:throw new Error(`Coordinate transform mode ${t} is not supported`)}})()+"}",ma=(t,e,n)=>`fn getNearestPixelFromOriginal(xOriginal: ${n}, isDownSample: bool) -> ${n} {`+(()=>{switch(t){case"round_prefer_ceil":return"if (fract(xOriginal) == 0.5) {             return ceil(xOriginal);           } else {             return round(xOriginal);           }";case"floor":return"return floor(xOriginal);";case"ceil":return"return ceil(xOriginal);";case"round_prefer_floor":return"if (fract(xOriginal) == 0.5) {                     return floor(xOriginal);                   } else {                     return round(xOriginal);                   }";default:if(e<11)return"if (isDownSample)                     {                       return ceil(xOriginal);                     } else {                       return xOriginal;                     }";throw new Error(`Nearest mode ${t} is not supported`)}})()+"}",ya=(t,e,n)=>{let i=new Array(n).fill(0).concat(new Array(n).fill(1)),r=0===t.length?i:t.slice();return e.length>0?(e.forEach(((t,o)=>{i[t]=r[o],i[o+n]=r[e.length+o]})),i):r},wa=(t,e,n,i)=>{let r=[];if(n.length>0)if(i.length>0){if(t.forEach((t=>r.push(t))),Math.max(...i)>t.length)throw new Error("axes is out of bound");i.forEach(((t,e)=>r[t]=n[e]))}else n.forEach((t=>r.push(t)));else{if(0===e.length)throw new Error("Resize requires either scales or sizes.");r=t.map(((t,n)=>Math.round(t*e[n])))}return r},ga=(t,e,n)=>{let i=(()=>{switch(n.keepAspectRatioPolicy){case"not_larger":return n.axes.length>0?Math.min(...n.axes.map((t=>e[t])),Number.MAX_VALUE):Math.min(...e,Number.MAX_VALUE);case"not_smaller":return n.axes.length>0?Math.max(...n.axes.map((t=>e[t])),Number.MIN_VALUE):Math.max(...e,Number.MIN_VALUE);default:throw new Error(`Keep aspect ratio policy ${n.keepAspectRatioPolicy} is not supported`)}})();e.fill(1,0,e.length);let r=t.slice();return n.axes.length>0?(n.axes.forEach((t=>e[t]=i)),n.axes.forEach((n=>r[n]=Math.round(t[n]*e[n])))):(e.fill(i,0,e.length),r.forEach(((t,n)=>r[n]=Math.round(t*e[n])))),r},ba=(t,e,n,i,r)=>`\n    fn calculateOriginalIndicesFromOutputIndices(output_indices: ${t.type.indices}) -> array<${t.type.value}, ${n.length}> {\n      var original_indices: array<${t.type.value}, ${n.length}>;\n      for (var i:u32 = 0; i < ${n.length}; i++) {\n        var output_index = ${t.indicesGet("output_indices","i")};\n        var scale = ${Pe("uniforms.scales","i",i)};\n        var roi_low = ${Pe("uniforms.roi","i",r)};\n        var roi_hi = ${Pe("uniforms.roi",`i + ${e.length}`,r)};\n        if (scale == 1.0) {\n          original_indices[i] = ${t.type.value}(output_index);\n        } else {\n          var input_shape_i = ${Pe("uniforms.input_shape","i",e.length)};\n          var output_shape_i = ${Pe("uniforms.output_shape","i",n.length)};\n          original_indices[i] = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,\n                                                                           input_shape_i, roi_low, roi_hi);\n        }\n      }\n      return original_indices;\n    }`,_a=(t,e,n,i,r,o,s)=>`\n    fn calculateInputIndicesFromOutputIndices(output_indices: ${e.type.indices}) -> ${t.type.indices} {\n      var input_indices: ${t.type.indices};\n      for (var i:u32 = 0; i < ${i.length}; i++) {\n        var output_index = ${e.indicesGet("output_indices","i")};\n        var input_index: u32;\n        var scale = ${Pe("uniforms.scales","i",r)};\n        if (scale == 1.0) {\n          input_index = output_index;\n        } else {\n          var roi_low = ${Pe("uniforms.roi","i",o)};\n          var roi_hi = ${Pe("uniforms.roi",`i + ${n.length}`,o)};\n          var input_shape_i = ${Pe("uniforms.input_shape","i",n.length)};\n          var output_shape_i = ${Pe("uniforms.output_shape","i",i.length)};\n          var original_idx = getOriginalCoordinateFromResizedCoordinate(output_index, scale, output_shape_i,\n                                                                        input_shape_i, roi_low, roi_hi);\n          if (!${s} || (original_idx >= 0 && original_idx < ${e.type.value}(input_shape_i))) {\n            if (original_idx < 0) {\n              input_index = 0;\n            } else if (original_idx > ${e.type.value}(input_shape_i - 1)) {\n              input_index = input_shape_i - 1;\n            } else {\n              input_index = u32(getNearestPixelFromOriginal(original_idx, scale < 1));\n            }\n          } else {\n            input_index = u32(original_idx);\n          }\n        }\n        ${t.indicesSet("input_indices","i"," input_index")}\n      }\n      return input_indices;\n    }`,xa=(t,e)=>`\n    fn checkInputIndices(input_indices: ${t.type.indices}) -> bool {\n      for (var i:u32 = 0; i < ${e.length}; i++) {\n        var input_index = ${t.indicesGet("input_indices","i")};\n        if (input_index < 0 || input_index >= ${Pe("uniforms.input_shape","i",e.length)}) {\n          return false;\n        }\n      }\n      return true;\n    }`,ka=(t,e,n,i)=>t.rank>i?`\n    ${t.indicesSet("input_indices",e,"channel")};\n    ${t.indicesSet("input_indices",n,"batch")};\n`:"",$a=(t,e,n,i,r)=>{let[o,s,a,u]=2===n.length?[-1,0,1,-1]:[0,2,3,1],h=t.type.value;return`\n    fn getInputValue(batch: u32, channel: u32, row: u32, col: u32) -> ${h} {\n      var input_indices: ${t.type.indices};\n      ${t.indicesSet("input_indices",s,`max(0, min(row, ${n[s]} - 1))`)};\n      ${t.indicesSet("input_indices",a,`max(0, min(col, ${n[a]} - 1))`)};\n      ${ka(t,u,o,2)}\n      return ${t.getByIndices("input_indices")};\n    }\n\n    fn bilinearInterpolation(output_indices: ${e.type.indices}) -> ${h} {\n      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);\n      var row:${h} = originalIndices[${s}];\n      var col:${h} = originalIndices[${a}];\n      ${i?`if (row < 0 || row > (${n[s]} - 1) || col < 0 || col > (${n[a]} - 1)) {\n        return ${r};\n      }`:""};\n      row = max(0, min(row, ${n[s]} - 1));\n      col = max(0, min(col, ${n[a]} - 1));\n      var row1: u32 = u32(row);\n      var col1: u32 = u32(col);\n      var row2: u32 = u32(row + 1);\n      var col2: u32 = u32(col + 1);\n      var channel: u32 = ${n.length>2?`u32(originalIndices[${u}])`:"0"};\n      var batch: u32 =  ${n.length>2?`u32(originalIndices[${o}])`:"0"};\n      var x11: ${h} = getInputValue(batch, channel, row1, col1);\n      var x12: ${h} = getInputValue(batch, channel, row1, col2);\n      var x21: ${h} = getInputValue(batch, channel, row2, col1);\n      var x22: ${h} = getInputValue(batch, channel, row2, col2);\n      var dx1: ${h} = abs(row - ${h}(row1));\n      var dx2: ${h} = abs(${h}(row2) - row);\n      var dy1: ${h} = abs(col - ${h}(col1));\n      var dy2: ${h} = abs(${h}(col2) - col);\n      if (row1 == row2) {\n        dx1 = 0.5;\n        dx2 = 0.5;\n      }\n      if (col1 == col2) {\n        dy1 = 0.5;\n        dy2 = 0.5;\n      }\n      return (x11 * dx2 * dy2 + x12 * dx2 * dy1 + x21 * dx1 * dy2 + x22 * dx1 * dy1);\n    }`},Sa=(t,e,n,i,r,o,s,a,u,h)=>{let l=2===n.length,[c,f]=l?[0,1]:[2,3],d=t.type.value,p=s=>{let l=s===c?"row":"col";return`\n      fn ${l}CubicInterpolation(input_indices: ${t.type.indices}, output_indices: ${e.type.indices}) -> ${d} {\n        var output_index = ${e.indicesGet("output_indices",s)};\n        var originalIdx: ${d} = getOriginalCoordinateFromResizedCoordinate(output_index, ${r[s]},\n        ${i[s]}, ${n[s]}, ${o[s]}, ${o[s]} + ${n.length});\n        var fractOriginalIdx: ${d} = originalIdx - floor(originalIdx);\n        var coefs = getCubicInterpolationCoefs(fractOriginalIdx);\n\n        if (${a} && (originalIdx < 0 || originalIdx > (${n[s]} - 1))) {\n          return ${u};\n        }\n        var data: array<${d}, 4> = array<${d}, 4>(0.0, 0.0, 0.0, 0.0);\n        for (var i: i32 = -1; i < 3; i++) {\n          var ${l}: ${d} = originalIdx + ${d}(i);\n          if (${l} < 0 || ${l} >= ${n[s]}) {\n            ${h?"coefs[i + 1] = 0.0;\n                        continue;":a?`return ${u};`:`${l} = max(0, min(${l}, ${n[s]} - 1));`};\n          }\n        var input_indices_copy: ${t.type.indices} = input_indices;\n          ${t.indicesSet("input_indices_copy",s,`u32(${l})`)};\n          data[i + 1] = ${s===c?t.getByIndices("input_indices_copy"):"rowCubicInterpolation(input_indices_copy, output_indices)"};\n        }\n        return cubicInterpolation1D(data, coefs);\n      }`};return`\n    ${p(c)};\n    ${p(f)};\n  fn getCubicInterpolationCoefs(s: ${d}) -> array<${d}, 4> {\n    var absS = abs(s);\n    var coeffs: array<${d}, 4> = array<${d}, 4>(0.0, 0.0, 0.0, 0.0);\n    var oneMinusAbsS: ${d} = 1.0 - absS;\n    var twoMinusAbsS: ${d} = 2.0 - absS;\n    var onePlusAbsS: ${d} = 1.0 + absS;\n    coeffs[0] = ((${s} * onePlusAbsS - 5 * ${s}) * onePlusAbsS + 8 * ${s}) * onePlusAbsS - 4 * ${s};\n    coeffs[1] = ((${s} + 2) * absS - (${s} + 3)) * absS * absS + 1;\n    coeffs[2] = ((${s} + 2) * oneMinusAbsS - (${s} + 3)) * oneMinusAbsS * oneMinusAbsS + 1;\n    coeffs[3] = ((${s} * twoMinusAbsS - 5 * ${s}) * twoMinusAbsS + 8 * ${s}) * twoMinusAbsS - 4 * ${s};\n    return coeffs;\n  }\n\n  fn cubicInterpolation1D(x: array<${d}, 4>, coefs: array<${d}, 4>) -> ${d} {\n    var coefsSum: ${d} = coefs[0] + coefs[1] + coefs[2] + coefs[3];\n    return (x[0] * coefs[0] + x[1] * coefs[1]+ x[2] * coefs[2]+ x[3] * coefs[3]) / coefsSum;\n  }\n\n  fn bicubicInterpolation(output_indices: ${e.type.indices}) -> ${d} {\n    var input_indices: ${t.type.indices} = output_indices;\n    return colCubicInterpolation(input_indices, output_indices);\n  }\n    `},Ea=(t,e,n,i,r)=>{let[o,s,a,u,h]=3===n.length?[-1,0,1,2,-1]:[0,2,3,4,1],l=t.type.value;return`\n    fn getInputValue(batch: u32, channel: u32, depth:u32, height: u32, width: u32) -> ${l} {\n      var input_indices: ${t.type.indices};\n      ${t.indicesSet("input_indices",s,`max(0, min(depth, ${n[s]} - 1))`)};\n      ${t.indicesSet("input_indices",a,`max(0, min(height, ${n[a]} - 1))`)};\n      ${t.indicesSet("input_indices",u,`max(0, min(width, ${n[u]} - 1))`)};\n      ${ka(t,h,o,3)}\n      return ${t.getByIndices("input_indices")};\n    }\n\n    fn trilinearInterpolation(output_indices: ${e.type.indices}) -> ${l} {\n      var originalIndices = calculateOriginalIndicesFromOutputIndices(output_indices);\n      var depth:${l} = originalIndices[${s}];\n      var height:${l} = originalIndices[${a}];\n      var width:${l} = originalIndices[${u}];\n      ${i?`if (depth < 0 || depth > (${n[s]} - 1) || height < 0 || height > (${n[a]} - 1) || width < 0 || (width > ${n[u]} - 1)) {\n      return ${r};\n        }`:""};\n\n    depth = max(0, min(depth, ${n[s]} - 1));\n      height = max(0, min(height, ${n[a]} - 1));\n      width = max(0, min(width, ${n[u]} - 1));\n      var depth1: u32 = u32(depth);\n      var height1: u32 = u32(height);\n      var width1: u32 = u32(width);\n      var depth2: u32 = u32(depth + 1);\n      var height2: u32 = u32(height + 1);\n      var width2: u32 = u32(width + 1);\n      var channel: u32 = ${n.length>3?`u32(originalIndices[${h}])`:"0"};\n      var batch: u32 =  ${n.length>3?`u32(originalIndices[${o}])`:"0"};\n\n      var x111: ${l} = getInputValue(batch, channel, depth1, height1, width1);\n      var x112: ${l} = getInputValue(batch, channel, depth1, height1, width2);\n      var x121: ${l} = getInputValue(batch, channel, depth1, height2, width1);\n      var x122: ${l} = getInputValue(batch, channel, depth1, height2, width2);\n      var x211: ${l} = getInputValue(batch, channel, depth2, height1, width1);\n      var x212: ${l} = getInputValue(batch, channel, depth2, height1, width2);\n      var x221: ${l} = getInputValue(batch, channel, depth2, height2, width1);\n      var x222: ${l} = getInputValue(batch, channel, depth2, height2, width2);\n      var dx1: ${l} = abs(depth - ${l}(depth1));\n      var dx2: ${l} = abs(${l}(depth2) - depth);\n      var dy1: ${l} = abs(height - ${l}(height1));\n      var dy2: ${l} = abs(${l}(height2) - height);\n      var dz1: ${l} = abs(width - ${l}(width1));\n      var dz2: ${l} = abs(${l}(width2) - width);\n      if (depth1 == depth2) {\n        dx1 = 0.5;\n        dx2 = 0.5;\n      }\n      if (height1 == height2) {\n        dy1 = 0.5;\n        dy2 = 0.5;\n      }\n      if (width1 == width2) {\n        dz1 = 0.5;\n        dz2 = 0.5;\n      }\n      return (x111 * dx2 * dy2 * dz2 + x112 * dx2 * dy2 * dz1 + x121 * dx2 * dy1 *dz2 + x122 * dx2 * dy1 * dz1 +\n              x211 * dx1 * dy2 * dz2 + x212 * dx1 * dy2 * dz1 + x221 * dx1 * dy1 *dz2 + x222 * dx1 * dy1 * dz1);\n    }`},Ma=(t,e,n,i,r,o)=>{let s=t.dims,a=ya(o,e.axes,s.length),u=wa(s,i,r,e.axes),h=i.slice();0===i.length&&(h=s.map(((t,e)=>0===t?1:u[e]/t)),"stretch"!==e.keepAspectRatioPolicy&&(u=ga(s,h,e)));let l=qe("output",t.dataType,u.length),c=Ue("input",t.dataType,s.length),f=ke.size(u),d=s.length===u.length&&s.every(((t,e)=>t===u[e])),p="tf_crop_and_resize"===e.coordinateTransformMode,v=e.extrapolationValue,m=c.type.value;return{name:"Resize",shaderCache:{hint:`${e.cacheKey}|${n}|${h.length>0?h:""}|${r.length>0?r:""}|${a.length>0?a:""}|${d}|${s}`,inputDependencies:["rank"]},getShaderSource:t=>`\n      ${d?"":`\n      ${va(e.coordinateTransformMode,m)};\n      ${(()=>{switch(e.mode){case"nearest":return`\n              ${xa(c,s)};\n              ${ma(e.nearestMode,n,m)};\n              ${_a(c,l,s,u,h.length,a.length,p)};\n              `;case"linear":return`\n              ${ba(l,s,u,h.length,a.length)};\n              ${(()=>{if(2===s.length||4===s.length)return`${$a(c,l,s,p,v)}`;if(3===s.length||5===s.length)return`${Ea(c,l,s,p,v)}`;throw Error("Linear mode only supports input dims 2, 3, 4 and 5 are supported in linear mode.")})()};\n            `;case"cubic":return`\n            ${(()=>{if(2===s.length||4===s.length)return`${Sa(c,l,s,u,h,a,e.cubicCoeffA,p,e.extrapolationValue,e.excludeOutside)}`;throw Error("Cubic mode only supports input dims 2 and 4 are supported in linear mode.")})()};\n            `;default:throw Error("Invalid resize mode")}})()};\n      `}\n      ${t.registerUniform("output_size","u32").registerUniform("scales","f32",h.length).registerUniform("roi","f32",a.length).declareVariables(c,l)}\n      ${t.mainStart()}\n        ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.output_size")}\n        ${d?"output[global_idx] = input[global_idx];":`\n        let output_indices = ${l.offsetToIndices("global_idx")};\n        var input_indices: ${c.type.indices};\n        ${(()=>{switch(e.mode){case"nearest":return`input_indices = calculateInputIndicesFromOutputIndices(output_indices);\n                if (checkInputIndices(input_indices)) {\n                  output[global_idx] = ${c.getByIndices("input_indices")};\n                } else {\n                  output[global_idx] = ${e.extrapolationValue};\n                }`;case"linear":return`output[global_idx] = ${2===s.length||4===s.length?"bilinearInterpolation":"trilinearInterpolation"}(output_indices);`;case"cubic":return"output[global_idx] = bicubicInterpolation(output_indices);";default:throw Error(`Unsupported resize mode: ${e.mode}`)}})()};\n`}\n      }`,getRunData:()=>({outputs:[{dims:u,dataType:t.dataType}],dispatchGroup:{x:Math.ceil(f/64)},programUniforms:[{type:12,data:f},{type:1,data:h},{type:1,data:a},...Te(s,u)]})}},Ca=t=>{let e=t.customDataBuffer;return new Uint32Array(e,e.byteOffset,1)[0]},Aa=(t,e)=>{let n=[],i=[],r=[],o=Ca(t);if(0!==e.antialias)throw Error("Only default value (0) for Antialias attribute is supported");pa(t.inputs,e,o,n,i,r),t.compute(Ma(t.inputs[0],e,o,n,i,r),{inputs:[0]})},Oa=t=>{let e=t.antialias,n=t.axes,i=t.coordinateTransformMode,r=t.cubicCoeffA,o=0!==t.excludeOutside,s=t.extrapolationValue,a=t.keepAspectRatioPolicy,u=t.mode,h=""===t.nearestMode?"simple":t.nearestMode;return be({antialias:e,axes:n,coordinateTransformMode:i,cubicCoeffA:r,excludeOutside:o,extrapolationValue:s,keepAspectRatioPolicy:a,mode:u,nearestMode:h})}})),dh=H((()=>{yu(),$u(),ku(),Su(),Ia=(t,e)=>{let[n,i,r,o]=t,{numHeads:s,rotaryEmbeddingDim:a}=e;if(3!==n.dims.length&&4!==n.dims.length)throw new Error(`Input 'x' is expected to have 3 or 4 dimensions, got ${n.dims.length}`);if(!ke.areEqual(i.dims,[])&&!ke.areEqual(i.dims,[1])&&2!==i.dims.length)throw new Error(`Input 'position_ids' is expected to have 0, 1, or 2 dimensions, got ${i.dims.length}`);if(2!==r.dims.length)throw new Error(`Input 'cos_cache' is expected to have 2 dimensions, got ${r.dims.length}`);if(2!==o.dims.length)throw new Error(`Input 'sin_cache' is expected to have 2 dimensions, got ${o.dims.length}`);if(!ke.areEqual(r.dims,o.dims))throw new Error("Inputs 'cos_cache' and 'sin_cache' are expected to have the same shape");if(a>0&&0===s)throw new Error("num_heads must be provided if rotary_embedding_dim is specified");let u=n.dims[0],h=n.dims[n.dims.length-2],l=r.dims[0],c=ke.sizeFromDimension(n.dims,1)/h,f=0===a?2*r.dims[1]:c/s;if(a>f)throw new Error("rotary_embedding_dim must be less than or equal to head_size");if(2===i.dims.length){if(u!==i.dims[0])throw new Error(`Input 'position_ids' dimension 0 should be of size batch_size, got ${i.dims[0]}`);if(h!==i.dims[1])throw new Error(`Input 'position_ids' dimension 1 should be of size sequence_length, got ${i.dims[1]}`)}if(f/2!==r.dims[1]&&a/2!==r.dims[1])throw new Error(`Input 'cos_cache' dimension 1 should be same as head_size / 2 or rotary_embedding_dim / 2, got ${r.dims[1]}`);if(h>l)throw new Error("Updating cos_cache and sin_cache in RotaryEmbedding is not currently supported")},Ta=(t,e)=>{let{interleaved:n,numHeads:i,rotaryEmbeddingDim:r,scale:o}=e,s=t[0].dims[0],a=ke.sizeFromDimension(t[0].dims,1),u=t[0].dims[t[0].dims.length-2],h=a/u,l=t[2].dims[1],c=0===r?2*l:h/i,f=new Array(s,u,h/c,c-l),d=ke.computeStrides(f),p=[{type:1,data:o},{type:12,data:f},{type:12,data:d},...3===t[0].dims.length?new Array({type:12,data:[a,h,c,1]}):[],...4===t[0].dims.length?new Array({type:12,data:[a,c,u*c,1]}):[],...Te(t[0].dims,t[1].dims,t[2].dims,t[3].dims,t[0].dims)];return{name:"RotaryEmbedding",shaderCache:{hint:be({interleaved:n}).cacheKey,inputDependencies:["rank","rank","rank","rank"]},getShaderSource:e=>{let i=Ue("input",t[0].dataType,t[0].dims.length),r=Ue("position_ids",t[1].dataType,t[1].dims.length),o=Ue("cos_cache",t[2].dataType,t[2].dims.length),s=Ue("sin_cache",t[3].dataType,t[3].dims.length),a=qe("output",t[0].dataType,t[0].dims.length);return e.registerUniforms([{name:"scale",type:"f32"},{name:"global_shape",type:"u32",length:f.length},{name:"global_strides",type:"u32",length:d.length},{name:"input_output_strides",type:"u32",length:d.length}]),`\n        ${e.declareVariables(i,r,o,s,a)}\n\n        ${e.mainStart(Ce)}\n          let half_rotary_emb_dim = uniforms.${o.name}_shape[1];\n          let bsnh = global_idx / uniforms.global_strides % uniforms.global_shape;\n          let size = uniforms.global_shape[0] * uniforms.global_strides[0];\n          ${e.guardAgainstOutOfBoundsWorkgroupSizes("size")}\n\n          if (bsnh[3] < half_rotary_emb_dim) {\n            let position_ids_idx =\n                ${r.broadcastedIndicesToOffset("bsnh.xy",qe("",r.type.tensor,2))};\n            let position_id =\n                u32(${r.getByOffset("position_ids_idx")}) + select(0, bsnh[1], position_ids_idx == 0);\n            let i = dot(bsnh, uniforms.input_output_strides) + select(0, bsnh[3], ${n});\n            let j = i + select(half_rotary_emb_dim, 1, ${n});\n            let re = ${i.getByOffset("i")} * ${o.get("position_id","bsnh[3]")} -\n                ${i.getByOffset("j")} * ${s.get("position_id","bsnh[3]")};\n            ${a.setByOffset("i","re")}\n            let im = ${i.getByOffset("i")} * ${s.get("position_id","bsnh[3]")} +\n                ${i.getByOffset("j")} * ${o.get("position_id","bsnh[3]")};\n            ${a.setByOffset("j","im")}\n          } else {\n            let k = dot(bsnh, uniforms.input_output_strides) + half_rotary_emb_dim;\n            ${a.setByOffset("k",i.getByOffset("k"))}\n          }\n        }`},getRunData:()=>({outputs:[{dims:t[0].dims,dataType:t[0].dataType}],dispatchGroup:{x:Math.ceil(ke.size(f)/Ce)},programUniforms:p})}},za=(t,e)=>{Ia(t.inputs,e),t.compute(Ta(t.inputs,e))}})),ph=H((()=>{yu(),$u(),Su(),Ra=t=>{if(!t||t.length<3)throw new Error("layerNorm requires at least 3 inputs.");let e=t[0],n=t[1],i=t[2];if(e.dataType!==n.dataType||e.dataType!==i.dataType)throw new Error("All inputs must have the same data type");if(3!==e.dims.length&&2!==e.dims.length)throw new Error("Input must be 2D or 3D");if(3!==n.dims.length&&2!==n.dims.length)throw new Error("Skip must be 2D or 3D");let r=e.dims[e.dims.length-1],o=e.dims[e.dims.length-2];if(n.dims[n.dims.length-1]!==r)throw new Error("Skip must have the same hidden size as input");if(n.dims[n.dims.length-2]!==o)throw new Error("Skip must have the same sequence length as input");if(1!==i.dims.length)throw new Error("Gamma must be 1D");if(i.dims[i.dims.length-1]!==r)throw new Error("Gamma must have the same hidden size as input");if(t.length>3){let e=t[3];if(1!==e.dims.length)throw new Error("Beta must be 1D");if(e.dims[e.dims.length-1]!==r)throw new Error("Beta must have the same hidden size as input")}if(t.length>4){let e=t[4];if(1!==e.dims.length)throw new Error("Bias must be 1D");if(e.dims[e.dims.length-1]!==r)throw new Error("Bias must have the same hidden size as input")}},Fa=(t,e,n,i)=>{let r=e.simplified,o=t[0].dims,s=ke.size(o),a=o,u=s,h=o.slice(-1)[0],l=i?o.slice(0,-1).concat(1):[],c=!r&&t.length>3,f=t.length>4,d=i&&n>1,p=i&&n>2,v=n>3,m=ze(h),y=[{type:12,data:u},{type:12,data:m},{type:12,data:h},{type:1,data:e.epsilon}],w=[{dims:a,dataType:t[0].dataType}];return n>1&&w.push({dims:l,dataType:1}),n>2&&w.push({dims:l,dataType:1}),n>3&&w.push({dims:o,dataType:t[0].dataType}),{name:"SkipLayerNormalization",shaderCache:{hint:`${m};${d};${p};${v}`,inputDependencies:t.map(((t,e)=>"type"))},getShaderSource:e=>{let n=[Ue("x",t[0].dataType,t[0].dims,m),Ue("skip",t[1].dataType,t[1].dims,m),Ue("gamma",t[2].dataType,t[2].dims,m)];c&&n.push(Ue("beta",t[3].dataType,t[3].dims,m)),f&&n.push(Ue("bias",t[4].dataType,t[4].dims,m)),n.push(qe("output",t[0].dataType,a,m)),d&&n.push(qe("mean_output",1,l)),p&&n.push(qe("inv_std_output",1,l)),v&&n.push(qe("input_skip_bias_sum",t[0].dataType,a,m));let i=Oe(t[0].dataType),o=Oe(1,m);return`\n\n      ${e.registerUniforms([{name:"output_size",type:"u32"},{name:"components",type:"u32"},{name:"hidden_size",type:"u32"},{name:"epsilon",type:"f32"}]).declareVariables(...n)}\n      var<workgroup> sum_shared : array<${o}, 64>;\n      var<workgroup> sum_squared_shared : array<${o}, 64>;\n\n      ${e.mainStart([64,1,1])}\n        let ix = local_id.x;\n        let iy = global_id.x / 64;\n\n        let hidden_size_vectorized: u32 = uniforms.hidden_size / uniforms.components;\n        var stride = hidden_size_vectorized / 64;\n        let offset = ix * stride + iy * hidden_size_vectorized;\n        let offset1d = stride * ix;\n        if (ix == 63) {\n          stride = hidden_size_vectorized - stride * ix;\n        }\n        for (var i: u32 = 0; i < stride; i++) {\n          let skip_value = skip[offset + i];\n          let bias_value = ${f?"bias[offset1d + i]":i+"(0.0)"};\n          let input_value = x[offset + i];\n          let value = input_value + skip_value + bias_value;\n          ${v?"input_skip_bias_sum[offset + i] = value;":""}\n          output[offset + i] = value;\n          let f32_value = ${Fe(i,m,"value")};\n          sum_shared[ix] += f32_value;\n          sum_squared_shared[ix] += f32_value * f32_value;\n        }\n        workgroupBarrier();\n\n        var reduce_size : u32 = 64;\n        for (var curr_size = reduce_size >> 1;  curr_size > 0; curr_size = reduce_size >> 1) {\n          reduce_size = curr_size + (reduce_size & 1);\n          if (ix < curr_size) {\n            sum_shared[ix] += sum_shared[ix + reduce_size];\n            sum_squared_shared[ix] += sum_squared_shared[ix + reduce_size];\n          }\n          workgroupBarrier();\n        }\n\n        let sum = sum_shared[0];\n        let square_sum = sum_squared_shared[0];\n        let mean = ${De("sum",m)} / f32(uniforms.hidden_size);\n        let inv_std_dev = inverseSqrt(${De("square_sum",m)} / f32(uniforms.hidden_size) ${r?"":"- mean * mean"} + uniforms.epsilon);\n        ${d?"mean_output[global_idx] = mean;":""}\n        ${p?"inv_std_output[global_idx] = inv_std_dev;":""}\n\n        for (var i: u32 = 0; i < stride; i++) {\n          output[offset + i] = (output[offset + i] ${r?"":`- ${i}(mean)`}) *\n            ${i}(inv_std_dev) * gamma[offset1d + i]\n            ${c?"+ beta[offset1d + i]":""};\n        }\n      }`},getRunData:()=>({outputs:w,dispatchGroup:{x:Math.ceil(u/h)},programUniforms:y})}},Da=(t,e)=>{Ra(t.inputs);let n=[0];t.outputCount>1&&n.push(-3),t.outputCount>2&&n.push(-3),t.outputCount>3&&n.push(3),t.compute(Fa(t.inputs,e,t.outputCount,!1),{outputs:n})}})),vh=H((()=>{yu(),$u(),ku(),Su(),Pa=(t,e)=>{if(!t||t.length<1)throw new Error("too few inputs");if(0!==e.axes.length){if(e.axes.length!==e.starts.length||e.axes.length!==e.ends.length)throw new Error("axes, starts and ends must have the same length")}else if(e.starts.length!==e.ends.length)throw new Error("starts and ends must have the same length");t.slice(1).forEach(((e,n)=>{if(6!==t[n+1].dataType&&7!==t[n+1].dataType)throw new Error(`Input ${n} must be an array of int32 or int64`)}))},Na=(t,e)=>{let n=[];if(t.length>e)if(7===t[e].dataType)t[e].getBigInt64Array().forEach((t=>n.push(Number(t))));else{if(6!==t[e].dataType)throw new Error(`Input ${e} must be an array of int32 or int64`);t[e].getInt32Array().forEach((t=>n.push(Number(t))))}return n},Ua=(t,e)=>{if(t.length>1){let e=Na(t,1),n=Na(t,2),i=Na(t,3);return 0===i.length&&(i=[...Array(t[0].dims.length).keys()]),be({starts:e,ends:n,axes:i})}return e},qa=(t,e,n,i,r)=>{let o=t;return t<0&&(o+=n[i[e]]),r[e]<0?Math.max(0,Math.min(o,n[i[e]]-1)):Math.max(0,Math.min(o,n[i[e]]))},ja=(t,e,n)=>`fn calculateInputIndices(output_indices: ${e.type.indices}) -> ${t.type.indices} {\n          var input_indices: ${t.type.indices};\n          var carry = 0u;\n          for (var i = ${n.length}; i >= 0; i--) {\n            let input_shape_i = ${Pe("uniforms.input_shape","i",n.length)};\n            let steps_i = ${Pe("uniforms.steps","i",n.length)};\n            let signs_i = ${Pe("uniforms.signs","i",n.length)};\n            let starts_i = ${Pe("uniforms.starts","i",n.length)};\n            var output_index = ${e.indicesGet("output_indices","i")};\n            var input_index = output_index * steps_i + starts_i + carry;\n            carry = input_index / input_shape_i;\n            input_index = input_index % input_shape_i;\n            if (signs_i < 0) {\n              input_index = input_shape_i - input_index - 1u + starts_i;\n            }\n            ${t.indicesSet("input_indices","i","input_index")};\n          }\n          return input_indices;\n      }`,La=(t,e)=>{let n=t[0].dims,i=ke.size(n),r=e.axes.length>0?ke.normalizeAxes(e.axes,n.length):[...Array(n.length).keys()],o=Na(t,4);o.forEach((t=>0!==t||(()=>{throw new Error("step cannot be 0")}))),0===o.length&&(o=Array(r.length).fill(1));let s=e.starts.map(((t,e)=>qa(t,e,n,r,o))),a=e.ends.map(((t,e)=>qa(t,e,n,r,o)));if(r.length!==s.length||r.length!==a.length)throw new Error("start, ends and axes should have the same number of elements");if(r.length!==n.length)for(let t=0;t<n.length;++t)r.includes(t)||(s.splice(t,0,0),a.splice(t,0,n[t]),o.splice(t,0,1));let u=o.map((t=>Math.sign(t)));o.forEach(((t,e,n)=>{if(t<0){let i=(a[e]-s[e])/t,r=s[e],u=r+i*o[e];s[e]=u,a[e]=r,n[e]=-t}}));let h=n.slice(0);r.forEach(((t,e)=>{h[t]=Math.ceil((a[t]-s[t])/o[t])}));let l={dims:h,dataType:t[0].dataType},c=qe("output",t[0].dataType,h.length),f=Ue("input",t[0].dataType,t[0].dims.length),d=ke.size(h),p=[{name:"outputSize",type:"u32"},{name:"starts",type:"u32",length:s.length},{name:"signs",type:"i32",length:u.length},{name:"steps",type:"u32",length:o.length}],v=[{type:12,data:d},{type:12,data:s},{type:6,data:u},{type:12,data:o},...Te(t[0].dims,h)];return{name:"Slice",shaderCache:{hint:`${u.length}_${s.length}_${o.length}`,inputDependencies:["rank"]},getShaderSource:t=>`\n      ${t.registerUniforms(p).declareVariables(f,c)}\n        ${ja(f,c,n)}\n        ${t.mainStart()}\n          ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.outputSize")}\n          let output_indices = ${c.offsetToIndices("global_idx")};\n          let input_indices = calculateInputIndices(output_indices);\n          ${c.setByOffset("global_idx",f.getByIndices("input_indices"))}\n      }`,getRunData:()=>({outputs:[l],dispatchGroup:{x:Math.ceil(i/64)},programUniforms:v})}},Ba=(t,e)=>{Pa(t.inputs,e);let n=Ua(t.inputs,e);t.compute(La(t.inputs,n),{inputs:[0]})},Ha=t=>{let e=t.starts,n=t.ends,i=t.axes;return be({starts:e,ends:n,axes:i})}})),mh=H((()=>{yu(),$u(),ku(),Su(),Wa=t=>{if(!t||1!==t.length)throw new Error("Softmax op requires 1 input.")},Va=(t,e)=>{let n=t.dims,i=ke.size(n),r=e.axis;if(r<0&&(r=n.length+r),r<n.length-1)throw new Error("softmax only supports last axis for now.");let o=n[r],s=i/o,a=ze(o),u=o/a,h=Ue("x",t.dataType,t.dims,a),l=qe("result",t.dataType,t.dims,a),c=h.type.value,f="f32"===Oe(t.dataType)?`var threadMax = ${c}(-3.402823e+38f);`:`var threadMax = ${c}(-65504.0h);`;return{name:"Softmax",shaderCache:{hint:`${a}`,inputDependencies:["type"]},getRunData:()=>({outputs:[{dims:n,dataType:t.dataType}],dispatchGroup:{x:s},programUniforms:[{type:6,data:u}]}),getShaderSource:t=>`\n      var<workgroup> rowMaxShared : ${c};\n      var<workgroup> rowSumShared : ${c};\n      var<workgroup> threadShared : array<${c}, 64>;\n\n      fn getValue(row: i32, col: i32, row_stride: i32) -> ${c} {\n        let index = row * row_stride + col;\n        return x[index];\n      }\n\n      fn setValue(row: i32, col: i32, row_stride: i32, value: ${c}) {\n        let index = row * row_stride + col;\n        result[index] = value;\n      }\n      ${t.registerUniform("packedCols","i32").declareVariables(h,l)}\n      ${t.mainStart()}\n        let gindex = i32(global_idx);\n        let lindex = i32(local_idx);\n        const wg = 64;\n        let row = gindex / wg;\n        let cols = uniforms.packedCols;\n        let row_stride : i32 = uniforms.packedCols;\n\n        // find the rows max\n        ${f}\n        for (var col = lindex; col < cols; col += wg) {\n          let value = getValue(row, col, row_stride);\n          threadMax = max(threadMax, value);\n        }\n        if (lindex < cols) {\n          threadShared[lindex] = threadMax;\n        }\n        workgroupBarrier();\n\n        var reduceSize = min(cols, wg);\n        for (var currSize = reduceSize >> 1;  currSize > 0; currSize = reduceSize >> 1) {\n          reduceSize = currSize + (reduceSize & 1);\n          if (lindex < currSize) {\n            threadShared[lindex] = max(threadShared[lindex], threadShared[lindex + reduceSize]);\n          }\n          workgroupBarrier();\n        }\n        if (lindex == 0) {\n          rowMaxShared = ${c}(${((t,e)=>4===e?`max(max(${t}.x, ${t}.y), max(${t}.z, ${t}.w))`:2===e?`max(${t}.x, ${t}.y)`:3===e?`max(max(${t}.x, ${t}.y), ${t}.z)`:t)("threadShared[0]",a)});\n        }\n        workgroupBarrier();\n\n        // find the rows sum\n        var threadSum = ${c}(0.0);\n        for (var col = lindex; col < cols; col += wg) {\n          let subExp = exp(getValue(row, col, row_stride) - rowMaxShared);\n          threadSum += subExp;\n        }\n        threadShared[lindex] = threadSum;\n        workgroupBarrier();\n\n        for (var currSize = wg >> 1;  currSize > 0; currSize = currSize >> 1) {\n          if (lindex < currSize) {\n            threadShared[lindex] = threadShared[lindex] + threadShared[lindex + currSize];\n          }\n          workgroupBarrier();\n        }\n        if (lindex == 0) {\n          rowSumShared = ${c}(${De("threadShared[0]",a)});\n        }\n        workgroupBarrier();\n\n        // calculate final value for each element in the row\n        for (var col = lindex; col < cols; col += wg) {\n          let value = exp(getValue(row, col, row_stride) - rowMaxShared) / rowSumShared;\n          setValue(row, col, row_stride, value);\n        }\n      }`}},Ga=(t,e)=>{Wa(t.inputs),t.compute(Va(t.inputs[0],e))},Ya=t=>be({axis:t.axis})})),yh=H((()=>{yu(),$u(),ku(),Su(),Ka=t=>{if(!t||t.length<1)throw new Error("too few inputs")},Xa=(t,e)=>{let n=[],i=e.numOutputs;return t[1].dims[0]>0&&(t[1].getBigInt64Array().forEach((t=>n.push(Number(t)))),i=n.length),be({numOutputs:i,axis:e.axis,splitSizes:n})},Qa=t=>`\nfn calculateOutputIndex(index: u32) -> u32 {\n    for (var i: u32 = 0u; i < ${t}u; i += 1u ) {\n    if (index < ${Pe("uniforms.size_in_split_axis","i",t)}) {\n        return i;\n    }\n    }\n    return ${t}u;\n}`,Za=t=>{let e=t.length,n=[];for(let i=0;i<e;++i){let r=t[i].setByIndices("indices","input[global_idx]");1===e?n.push(r):0===i?n.push(`if (output_number == ${i}u) { ${r} }`):i===e-1?n.push(`else { ${r} }`):n.push(`else if (output_number == ${i}) { ${r} }`)}return`\n      fn writeBufferData(output_number: u32, indices: ${t[0].type.indices}, global_idx: u32) {\n        ${n.join("\n")}\n      }`},Ja=(t,e)=>{let n=t[0].dims,i=ke.size(n),r=t[0].dataType,o=ke.normalizeAxis(e.axis,n.length),s=new Array(e.numOutputs),a=Ue("input",r,n.length),u=new Array(e.numOutputs),h=[],l=[],c=0,f=[{type:12,data:i}];for(let i=0;i<e.numOutputs;i++){c+=e.splitSizes[i],u[i]=c;let o=n.slice();o[e.axis]=e.splitSizes[i],l.push(o),s[i]=qe(`output${i}`,r,o.length),h.push({dims:l[i],dataType:t[0].dataType})}return f.push({type:12,data:u},...Te(n,...l)),{name:"Split",shaderCache:{hint:e.cacheKey,inputDependencies:["rank"]},getShaderSource:t=>`\n  ${t.registerUniform("input_size","u32").registerUniform("size_in_split_axis","u32",u.length).declareVariables(a,...s)}\n  ${Qa(u.length)}\n  ${Za(s)}\n\n  ${t.mainStart()}\n    ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.input_size")}\n\n    var indices = ${a.offsetToIndices("global_idx")};\n    var index = ${a.indicesGet("indices",o)};\n    let output_number = calculateOutputIndex(index);\n    if (output_number != 0) {\n      index -= ${Pe("uniforms.size_in_split_axis","output_number - 1u",u.length)};\n      ${a.indicesSet("indices",o,"index")};\n    }\n    writeBufferData(output_number, indices, global_idx);\n  }`,getRunData:()=>({outputs:h,dispatchGroup:{x:Math.ceil(i/64)},programUniforms:f})}},tu=(t,e)=>{Ka(t.inputs);let n=1===t.inputs.length?e:Xa(t.inputs,e);t.compute(Ja(t.inputs,n),{inputs:[0]})},eu=t=>{let e=t.axis,n=t.splitSizes,i=t.numOutputs<0?n.length:t.numOutputs;if(i!==n.length)throw new Error("numOutputs and splitSizes lengh must be equal");return be({axis:e,numOutputs:i,splitSizes:n})}})),wh=H((()=>{yu(),$u(),Su(),nu=(t,e,n,i,r)=>{let o,s=qe("output_data",r,n.length,4),a=Ue("a_data",e[1].dataType,e[1].dims.length,4),u=Ue("b_data",e[2].dataType,e[2].dims.length,4),h=Ue("c_data",e[0].dataType,e[0].dims.length,4),l=(t,e,n)=>`select(${e}, ${t}, ${n})`;if(i){let t=(t,e,n="")=>{let i=`a_data[index_a${e}][component_a${e}]`,r=`b_data[index_b${e}][component_b${e}]`,o=`bool(c_data[index_c${e}] & (0xffu << (component_c${e} * 8)))`;return`\n            let output_indices${e} = ${s.offsetToIndices(`global_idx * 4u + ${e}u`)};\n            let offset_a${e} = ${a.broadcastedIndicesToOffset(`output_indices${e}`,s)};\n            let offset_b${e} = ${u.broadcastedIndicesToOffset(`output_indices${e}`,s)};\n            let offset_c${e} = ${h.broadcastedIndicesToOffset(`output_indices${e}`,s)};\n            let index_a${e} = offset_a${e} / 4u;\n            let index_b${e} = offset_b${e} / 4u;\n            let index_c${e} = offset_c${e} / 4u;\n            let component_a${e} = offset_a${e} % 4u;\n            let component_b${e} = offset_b${e} % 4u;\n            let component_c${e} = offset_c${e} % 4u;\n            ${t}[${e}] = ${n}(${l(i,r,o)});\n          `};o=9===r?`\n            var data = vec4<u32>(0);\n            ${t("data",0,"u32")}\n            ${t("data",1,"u32")}\n            ${t("data",2,"u32")}\n            ${t("data",3,"u32")}\n            output_data[global_idx] = dot(vec4<u32>(0x1, 0x100, 0x10000, 0x1000000), vec4<u32>(data));`:`\n            ${t("output_data[global_idx]",0)}\n            ${t("output_data[global_idx]",1)}\n            ${t("output_data[global_idx]",2)}\n            ${t("output_data[global_idx]",3)}\n          `}else o=s.setByOffset("global_idx",l(a.getByOffset("global_idx"),u.getByOffset("global_idx"),h.getByOffset("global_idx")));return`\n        ${t.registerUniform("vec_size","u32").declareVariables(h,a,u,s)}\n        ${t.mainStart()}\n        ${t.guardAgainstOutOfBoundsWorkgroupSizes("uniforms.vec_size")}\n        ${o}\n      }`},iu=t=>{let e=t[1].dims,n=t[2].dims,i=t[0].dims,r=t[1].dataType,o=!(ke.areEqual(e,n)&&ke.areEqual(n,i)),s=e,a=ke.size(e);if(o){let t=xe.calcShape(xe.calcShape(e,n,!1),i,!1);if(!t)throw new Error("Can't perform where op on the given tensors");s=t,a=ke.size(s)}let u=Math.ceil(a/4);return{name:"Where",shaderCache:{inputDependencies:["rank","rank","rank"]},getShaderSource:e=>nu(e,t,s,o,r),getRunData:()=>({outputs:[{dims:s,dataType:r}],dispatchGroup:{x:Math.ceil(a/64/4)},programUniforms:[{type:12,data:u},...Te(i,e,n,s)]})}},ru=t=>{t.compute(iu(t.inputs))}})),gh=H((()=>{Au(),Ou(),Iu(),Tu(),Ru(),Fu(),Du(),Wu(),Yu(),Ku(),Xu(),Qu(),Zu(),Ju(),th(),eh(),nh(),oh(),sh(),ah(),Hu(),uh(),ih(),hh(),lh(),ch(),Cu(),fh(),dh(),ph(),vh(),mh(),yh(),rh(),Eu(),zu(),wh(),ou=new Map([["Abs",[fi]],["Acos",[di]],["Acosh",[pi]],["Add",[ar]],["ArgMax",[Yn,Kn]],["ArgMin",[Gn,Kn]],["Asin",[vi]],["Asinh",[mi]],["Atan",[yi]],["Atanh",[wi]],["Attention",[ni]],["AveragePool",[ta,Js]],["BatchNormalization",[si]],["BiasAdd",[hi]],["BiasSplitGelu",[ir]],["Cast",[bi,gi]],["Ceil",[ki]],["Clip",[xi]],["Concat",[_r,xr]],["Conv",[ao,io]],["ConvTranspose",[xo,yo]],["Cos",[$i]],["Cosh",[Si]],["CumSum",[$o,So]],["DepthToSpace",[Ao,Oo]],["Div",[ur]],["Einsum",[Uo,qo]],["Elu",[Mi,Ei]],["Equal",[hr]],["Erf",[Ai]],["Exp",[Oi]],["Expand",[Wo]],["FastGelu",[Go]],["Floor",[Ii]],["FusedConv",[ao,io]],["Gather",[Qo,Xo]],["GatherElements",[es,ts]],["Gelu",[Ti]],["Gemm",[os,rs]],["GlobalAveragePool",[ia,na]],["GlobalMaxPool",[ua,aa]],["Greater",[dr]],["GreaterOrEqual",[vr]],["GroupQueryAttention",[ks,bs]],["HardSigmoid",[qi,Ui]],["InstanceNormalization",[Ms]],["LayerNormalization",[Os]],["LeakyRelu",[zi,Ei]],["Less",[pr]],["LessOrEqual",[mr]],["Log",[Qi]],["MatMul",[Zr]],["MatMulNBits",[zs,Rs]],["MaxPool",[oa,sa]],["Mul",[lr]],["MultiHeadAttention",[fs,us]],["Neg",[Fi]],["Not",[Ri]],["Pad",[Bs]],["Pow",[cr]],["QuickGelu",[tr,Ei]],["Range",[ca]],["Reciprocal",[Di]],["ReduceMin",[jn]],["ReduceMean",[Dn]],["ReduceMax",[qn]],["ReduceSum",[Bn]],["ReduceProd",[Ln]],["ReduceL1",[Pn]],["ReduceL2",[Nn]],["ReduceLogSum",[Wn]],["ReduceLogSumExp",[Un]],["ReduceSumSquare",[Hn]],["Relu",[Pi]],["Resize",[Aa,Oa]],["RotaryEmbedding",[za]],["Sigmoid",[Ni]],["Sin",[ji]],["Sinh",[Li]],["Slice",[Ba,Ha]],["SkipLayerNormalization",[Da]],["Split",[tu,eu]],["Sqrt",[Bi]],["Softmax",[Ga,Ya]],["Sub",[fr]],["Tan",[Hi]],["Tanh",[Vi]],["ThresholdedRelu",[Xi,Ei]],["Tile",[ys]],["Transpose",[Xe,Qe]],["Where",[ru]]])})),bh=H((()=>{pt(),gu(),Su(),su=class{constructor(t){this.backend=t,this.repo=new Map,this.attributesBound=!1}getArtifact(t){return this.repo.get(t)}setArtifact(t,e){this.repo.set(t,e)}run(t,e,n,i,r){z(t.programInfo.name);let o=this.backend.device,s=this.backend.getComputePassEncoder();this.backend.writeTimestamp(2*this.backend.pendingDispatchNumber);let a=[];for(let t of e)a.push({binding:a.length,resource:{buffer:t.buffer}});for(let t of n)a.push({binding:a.length,resource:{buffer:t.buffer}});r&&a.push({binding:a.length,resource:r});let u=o.createBindGroup({layout:t.computePipeline.getBindGroupLayout(0),entries:a,label:t.programInfo.name});if("capturing"===this.backend.sessionStatus){let e={kernelId:this.backend.currentKernelId,computePipeline:t.computePipeline,bindGroup:u,dispatchGroup:i};this.backend.capturedCommandList.get(this.backend.currentSessionId).push(e)}s.setPipeline(t.computePipeline),s.setBindGroup(0,u),s.dispatchWorkgroups(...i),this.backend.writeTimestamp(2*this.backend.pendingDispatchNumber+1),this.backend.pendingDispatchNumber++,(this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber||"at-passes"===this.backend.queryType)&&this.backend.endComputePass(),this.backend.pendingDispatchNumber>=this.backend.maxDispatchNumber&&this.backend.flush(),R(t.programInfo.name)}dispose(){}build(t,e){z(t.name);let n=this.backend.device,i=[];n.features.has("shader-f16")&&i.push("enable f16;");let r=Be(e,this.backend.device.limits),o=t.getShaderSource(r),s=`${i.join("\n")}\n${r.additionalImplementations}\n${o}`,a=n.createShaderModule({code:s,label:t.name});ue("verbose",(()=>`[WebGPU] ${t.name} shader code: ${s}`));let u=n.createComputePipeline({compute:{module:a,entryPoint:"main"},layout:"auto",label:t.name});return R(t.name),{programInfo:t,computePipeline:u,uniformVariablesInfo:r.variablesInfo}}normalizeDispatchGroupSize(t){let e="number"==typeof t?t:t.x,n="number"==typeof t?1:t.y||1,i="number"==typeof t?1:t.z||1,r=this.backend.device.limits.maxComputeWorkgroupsPerDimension;if(e<=r&&n<=r&&i<=r)return[e,n,i];let o=e*n*i,s=Math.ceil(Math.sqrt(o));if(s>r){if(s=Math.ceil(Math.cbrt(o)),s>r)throw new Error("Total dispatch size exceeds WebGPU maximum.");return[s,s,s]}return[s,s,1]}}})),_h=H((()=>{pt(),yu(),gu(),bu(),xu(),gh(),bh(),au=(t,e)=>{if(e.length!==t.length)throw new Error(`inputDependencies length ${e.length} is not equal to inputTensors length ${t.length}.`);let n=[];for(let i=0;i<t.length;++i){let r=t[i].dataType;switch(e[i]){case"none":n.push("");break;case"type":n.push(`${r}`);break;case"rank":{let e=t[i].dims.length;n.push(`${r};${e}`);break}case"dims":{let e=t[i].dims.join(",");n.push(`${r};${e}`);break}default:throw new Error(`unsupported input dependency: ${e[i]}`)}}return n.join("|")},uu=(t,e,n)=>{let i=t.name;return t.shaderCache?.hint&&(i+="["+t.shaderCache.hint+"]"),i+=":"+n+`:${au(e,t.shaderCache?.inputDependencies??new Array(e.length).fill("dims"))}`,i},hu=class{constructor(t){t&&(this.architecture=t.architecture,this.vendor=t.vendor)}isArchitecture(t){return this.architecture===t}isVendor(t){return this.vendor===t}},lu=class{constructor(){this.currentSessionId=null,this.currentKernelId=null,this.commandEncoder=null,this.computePassEncoder=null,this.maxDispatchNumber=16,this.pendingDispatchNumber=0,this.pendingKernels=[],this.pendingQueries=new Map,this.sessionStatus="default",this.capturedCommandList=new Map,this.capturedPendingKernels=new Map,this.sessionExternalDataMapping=new Map}get currentKernelCustomData(){if(null===this.currentKernelId)throw new Error("currentKernelCustomData(): currentKernelId is null. (should not happen)");let t=this.kernelCustomData.get(this.currentKernelId);return t||(t={},this.kernelCustomData.set(this.currentKernelId,t)),t}async initialize(t,e){this.env=t;let n=[],i={requiredLimits:{maxComputeWorkgroupStorageSize:e.limits.maxComputeWorkgroupStorageSize,maxComputeWorkgroupsPerDimension:e.limits.maxComputeWorkgroupsPerDimension,maxStorageBufferBindingSize:e.limits.maxStorageBufferBindingSize,maxBufferSize:e.limits.maxBufferSize,maxComputeInvocationsPerWorkgroup:e.limits.maxComputeInvocationsPerWorkgroup,maxComputeWorkgroupSizeX:e.limits.maxComputeWorkgroupSizeX,maxComputeWorkgroupSizeY:e.limits.maxComputeWorkgroupSizeY,maxComputeWorkgroupSizeZ:e.limits.maxComputeWorkgroupSizeZ},requiredFeatures:n};e.features.has("chromium-experimental-timestamp-query-inside-passes")?n.push("chromium-experimental-timestamp-query-inside-passes"):e.features.has("timestamp-query")&&n.push("timestamp-query"),e.features.has("shader-f16")&&n.push("shader-f16"),this.device=await e.requestDevice(i),this.adapterInfo=new hu(e.info||await e.requestAdapterInfo()),this.gpuDataManager=we(this),this.programManager=new su(this),this.kernels=new Map,this.kernelPersistentData=new Map,this.kernelCustomData=new Map,se(t.logLevel,!!t.debug),this.device.onuncapturederror=t=>{t.error,GPUValidationError},Object.defineProperty(this.env.webgpu,"device",{value:this.device,writable:!1,enumerable:!0,configurable:!1}),Object.defineProperty(this.env.webgpu,"adapter",{value:e,writable:!1,enumerable:!0,configurable:!1}),this.setQueryType()}dispose(){typeof this.querySet<"u"&&this.querySet.destroy(),this.gpuDataManager.dispose()}getCommandEncoder(){return this.commandEncoder||(this.commandEncoder=this.device.createCommandEncoder()),this.commandEncoder}getComputePassEncoder(){if(!this.computePassEncoder){let t=this.getCommandEncoder(),e={};"at-passes"===this.queryType&&(e.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:2*this.pendingDispatchNumber,endOfPassWriteIndex:2*this.pendingDispatchNumber+1}),this.computePassEncoder=t.beginComputePass(e)}return this.computePassEncoder}endComputePass(){this.computePassEncoder&&(this.computePassEncoder.end(),this.computePassEncoder=null)}flush(){if(!this.commandEncoder)return;let t;z(),this.endComputePass(),"none"!==this.queryType&&(this.commandEncoder.resolveQuerySet(this.querySet,0,2*this.pendingDispatchNumber,this.queryResolveBuffer,0),t=this.device.createBuffer({size:16*this.pendingDispatchNumber,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),this.pendingQueries.set(t,this.pendingKernels),this.pendingKernels=[],this.commandEncoder.copyBufferToBuffer(this.queryResolveBuffer,0,t,0,16*this.pendingDispatchNumber)),this.device.queue.submit([this.commandEncoder.finish()]),this.gpuDataManager.refreshPendingBuffers(),this.commandEncoder=null,this.pendingDispatchNumber=0,"none"!==this.queryType&&t.mapAsync(GPUMapMode.READ).then((()=>{let e=new BigUint64Array(t.getMappedRange()),n=this.pendingQueries.get(t);for(let t=0;t<e.length/2;t++){let i=n[t],r=i.kernelId,o=this.kernels.get(r),s=o.kernelType,a=o.kernelName,u=i.programName,h=i.inputTensorViews,l=i.outputTensorViews,c=e[2*t],f=e[2*t+1];typeof this.queryTimeBase>"u"&&(this.queryTimeBase=c);let d=Number(c-this.queryTimeBase),p=Number(f-this.queryTimeBase);if(!Number.isSafeInteger(d)||!Number.isSafeInteger(p))throw new RangeError("incorrect timestamp range");if(this.env.webgpu.profiling?.ondata)this.env.webgpu.profiling.ondata({version:1,inputsMetadata:h.map((t=>({dims:t.dims,dataType:Qt(t.dataType)}))),outputsMetadata:l.map((t=>({dims:t.dims,dataType:Qt(t.dataType)}))),kernelId:r,kernelType:s,kernelName:a,programName:u,startTime:d,endTime:p});else{let t="";h.forEach(((e,n)=>{t+=`input[${n}]: [${e.dims}] | ${Qt(e.dataType)}, `}));let e="";l.forEach(((t,n)=>{e+=`output[${n}]: [${t.dims}] | ${Qt(t.dataType)}, `}))}I("GPU",`${u}::${c}::${f}`)}t.unmap(),this.pendingQueries.delete(t)})),R()}run(t,e,n,i,r,o){z(t.name);let s=[];for(let t=0;t<e.length;++t){let n=e[t].data;if(0===n)continue;let i=this.gpuDataManager.get(n);if(!i)throw new Error(`no GPU data for input: ${n}`);s.push(i)}let{outputs:a,dispatchGroup:u,programUniforms:h}=t.getRunData(e),l=0===n.length?a.map(((t,e)=>e)):n;if(l.length!==a.length)throw new Error(`Output size ${l.length} must be equal to ${a.length}.`);let c,f=[],d=[];for(let t=0;t<a.length;++t){if(!Number.isInteger(l[t])||l[t]<-3||l[t]>=o)throw new Error(`Invalid output index: ${l[t]}`);if(-3===l[t])continue;let e=-1===l[t],n=-2===l[t],s=e||n?r(a[t].dataType,a[t].dims):i(l[t],a[t].dataType,a[t].dims);if(f.push(s),0===s.data)continue;let u=this.gpuDataManager.get(s.data);if(!u)throw new Error(`no GPU data for output: ${s.data}`);if(e&&this.temporaryData.push(u),n){let t=this.kernelPersistentData.get(this.currentKernelId);t||(t=[],this.kernelPersistentData.set(this.currentKernelId,t)),t.push(u)}d.push(u)}if(s.length!==e.length||d.length!==f.length){if(0===d.length)return R(t.name),f;throw new Error(`Program ${t.name} has zero-sized tensor(s) in inputs or outputs. This is not supported now.`)}if(h){let t=0,e=[];h.forEach((n=>{let i="number"==typeof n.data?[n.data]:n.data;if(0===i.length)return;let r,o,s=10===n.type?2:4;10===n.type?(o=i.length>4?16:i.length>2?8:i.length*s,r=i.length>4?16:s*i.length):(o=i.length<=2?i.length*s:16,r=16),t=Math.ceil(t/o)*o,e.push(t);let a=10===n.type?8:4;t+=i.length>4?Math.ceil(i.length/a)*r:i.length*s}));let n=16;t=Math.ceil(t/n)*n;let i=new ArrayBuffer(t);h.forEach(((t,n)=>{let r=e[n],o="number"==typeof t.data?[t.data]:t.data;if(6===t.type)new Int32Array(i,r,o.length).set(o);else if(12===t.type)new Uint32Array(i,r,o.length).set(o);else if(10===t.type)new Uint16Array(i,r,o.length).set(o);else{if(1!==t.type)throw new Error(`Unsupported uniform type: ${Qt(t.type)}`);new Float32Array(i,r,o.length).set(o)}}));let r=this.gpuDataManager.create(t,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM);this.device.queue.writeBuffer(r.buffer,0,i,0,t),this.gpuDataManager.release(r.id),c={offset:0,size:t,buffer:r.buffer}}let p=this.programManager.normalizeDispatchGroupSize(u),v=1===p[1]&&1===p[2],m=uu(t,e,v),y=this.programManager.getArtifact(m);if(y||(y=this.programManager.build(t,p),this.programManager.setArtifact(m,y),ue("info",(()=>`[artifact] key: ${m}, programName: ${t.name}`))),h&&y.uniformVariablesInfo){if(h.length!==y.uniformVariablesInfo.length)throw new Error(`Uniform variables count mismatch: expect ${y.uniformVariablesInfo.length}, got ${h.length} in program "${y.programInfo.name}".`);for(let t=0;t<h.length;t++){let e=h[t],n=e.type,i="number"==typeof e.data?1:e.data.length,[r,o]=y.uniformVariablesInfo[t];if(n!==r||i!==o)throw new Error(`Uniform variable ${t} mismatch: expect type ${r} with size ${o}, got type ${n} with size ${i} in program "${y.programInfo.name}".`)}}if(ue("info",(()=>`[ProgramManager] run "${t.name}" (key=${m}) with ${p[0]}x${p[1]}x${p[2]}`)),"none"!==this.queryType||"capturing"===this.sessionStatus){let t={kernelId:this.currentKernelId,programName:y.programInfo.name,inputTensorViews:e,outputTensorViews:f};this.pendingKernels.push(t),"capturing"===this.sessionStatus&&this.capturedPendingKernels.get(this.currentSessionId).push(t)}return this.programManager.run(y,s,d,p,c),R(t.name),f}upload(t,e){this.gpuDataManager.upload(t,e)}memcpy(t,e){this.gpuDataManager.memcpy(t,e)}async download(t,e){await this.gpuDataManager.download(t,e)}alloc(t){return this.gpuDataManager.create(t).id}free(t){return this.gpuDataManager.release(t)}createKernel(t,e,n,i){let r=ou.get(t);if(!r)throw new Error(`kernel not implemented: ${t}`);let o={kernelType:t,kernelName:i,kernelEntry:r[0],attributes:[r[1],n]};this.kernels.set(e,o)}releaseKernel(t){let e=this.kernelPersistentData.get(t);if(e){for(let t of e)this.gpuDataManager.release(t.id);this.kernelPersistentData.delete(t)}this.kernelCustomData.delete(t),this.kernels.delete(t)}computeKernel(t,e,n){let i=this.kernels.get(t);if(!i)throw new Error(`kernel not created: ${t}`);let r=i.kernelType,o=i.kernelName,s=i.kernelEntry,a=i.attributes;if(null!==this.currentKernelId)throw new Error(`kernel "[${r}] ${o}" is not allowed to be called recursively`);this.currentKernelId=t,a[0]&&(a[1]=a[0](a[1]),a[0]=void 0),ue("info",(()=>`[WebGPU] Start to run kernel "[${r}] ${o}"...`));let u=this.env.debug;this.temporaryData=[];try{return u&&this.device.pushErrorScope("validation"),s(e,a[1]),0}catch(t){return n.push(Promise.resolve(`[WebGPU] Kernel "[${r}] ${o}" failed. ${t}`)),1}finally{u&&n.push(this.device.popErrorScope().then((t=>t?`GPU validation error for kernel "[${r}] ${o}": ${t.message}`:null)));for(let t of this.temporaryData)this.gpuDataManager.release(t.id);this.temporaryData=[],this.currentKernelId=null}}registerBuffer(t,e,n,i){let r=this.sessionExternalDataMapping.get(t);r||(r=new Map,this.sessionExternalDataMapping.set(t,r));let o=r.get(e),s=this.gpuDataManager.registerExternalBuffer(n,i,o?.[1]);return r.set(e,[s,n]),s}unregisterBuffers(t){let e=this.sessionExternalDataMapping.get(t);e&&(e.forEach((t=>this.gpuDataManager.unregisterExternalBuffer(t[1]))),this.sessionExternalDataMapping.delete(t))}getBuffer(t){let e=this.gpuDataManager.get(t);if(!e)throw new Error(`no GPU data for buffer: ${t}`);return e.buffer}createDownloader(t,e,n){return async()=>{let i=await me(this,t,e);return he(i.buffer,n)}}writeTimestamp(t){"inside-passes"===this.queryType&&this.computePassEncoder.writeTimestamp(this.querySet,t)}setQueryType(){this.queryType="none",("default"===this.env.webgpu.profiling?.mode||(typeof this.env.trace>"u"?this.env.wasm.trace:this.env.trace))&&(this.device.features.has("chromium-experimental-timestamp-query-inside-passes")?this.queryType="inside-passes":this.device.features.has("timestamp-query")&&(this.queryType="at-passes"),"none"!==this.queryType&&typeof this.querySet>"u"&&(this.querySet=this.device.createQuerySet({type:"timestamp",count:2*this.maxDispatchNumber}),this.queryResolveBuffer=this.device.createBuffer({size:16*this.maxDispatchNumber,usage:GPUBufferUsage.COPY_SRC|GPUBufferUsage.QUERY_RESOLVE})))}captureBegin(){ue("info","captureBegin"),this.capturedCommandList.get(this.currentSessionId)||this.capturedCommandList.set(this.currentSessionId,[]),this.capturedPendingKernels.get(this.currentSessionId)||this.capturedPendingKernels.set(this.currentSessionId,[]),this.flush(),this.sessionStatus="capturing"}captureEnd(){ue("info","captureEnd"),this.flush(),this.sessionStatus="default"}replay(){ue("info","replay"),this.sessionStatus="replaying";let t=this.capturedCommandList.get(this.currentSessionId),e=this.capturedPendingKernels.get(this.currentSessionId),n=t.length;this.pendingKernels=[];for(let i=0;i<n;i++){let n=this.getComputePassEncoder(),r=t[i];this.writeTimestamp(2*this.pendingDispatchNumber),n.setPipeline(r.computePipeline),n.setBindGroup(0,r.bindGroup),n.dispatchWorkgroups(...r.dispatchGroup),this.writeTimestamp(2*this.pendingDispatchNumber+1),this.pendingDispatchNumber++,"none"!==this.queryType&&this.pendingKernels.push(e[i]),(this.pendingDispatchNumber>=this.maxDispatchNumber||"at-passes"===this.queryType)&&this.endComputePass(),this.pendingDispatchNumber>=this.maxDispatchNumber&&this.flush()}this.flush(),this.sessionStatus="default"}onReleaseSession(t){this.unregisterBuffers(t),this.capturedCommandList.has(t)&&this.capturedCommandList.delete(t),this.capturedPendingKernels.has(t)&&this.capturedPendingKernels.delete(t),this.gpuDataManager.onReleaseSession(t)}onRunStart(t){this.currentSessionId=t,this.setQueryType()}}})),xh={};W(xh,{init:()=>Sh});var kh,$h,Sh,Eh,Mh,Ch,Ah,Oh,Ih,Th,zh,Rh,Fh,Dh,Ph,Nh,Uh,qh,jh,Lh,Bh,Hh,Wh,Vh,Gh,Yh,Kh,Xh,Qh,Zh,Jh,tl,el,nl,il,rl,ol,sl,al=H((()=>{yu(),_h(),gu(),$u(),kh=class t{constructor(t,e,n,i){this.module=t,this.dataType=e,this.data=n,this.dims=i}getFloat32Array(){if(1!==this.dataType)throw new Error("Invalid data type");let t=ke.size(this.dims);return 0===t?new Float32Array:new Float32Array(this.module.HEAP8.buffer,this.data,t)}getBigInt64Array(){if(7!==this.dataType)throw new Error("Invalid data type");let t=ke.size(this.dims);return 0===t?new BigInt64Array:new BigInt64Array(this.module.HEAP8.buffer,this.data,t)}getInt32Array(){if(6!==this.dataType)throw new Error("Invalid data type");let t=ke.size(this.dims);return 0===t?new Int32Array:new Int32Array(this.module.HEAP8.buffer,this.data,t)}reshape(e){if(ke.size(e)!==ke.size(this.dims))throw new Error("Invalid new shape");return new t(this.module,this.dataType,this.data,e)}},$h=class{constructor(t,e,n){this.module=t,this.backend=e,this.customDataOffset=0,this.customDataSize=0,this.adapterInfo=e.adapterInfo;let i=t.HEAPU32,r=n>>>2;this.opKernelContext=i[r++];let o=i[r++];this.outputCount=i[r++],this.customDataOffset=i[r++],this.customDataSize=i[r++];let s=[];for(let e=0;e<o;e++){let e=i[r++],n=i[r++],o=i[r++],a=[];for(let t=0;t<o;t++)a.push(i[r++]);s.push(new kh(t,e,n,a))}this.inputs=s}get kernelCustomData(){return this.backend.currentKernelCustomData}get customDataBuffer(){return this.module.HEAPU8.subarray(this.customDataOffset,this.customDataOffset+this.customDataSize)}getMaxComputeWorkgroupSizes(){return[this.backend.device.limits.maxComputeWorkgroupSizeX,this.backend.device.limits.maxComputeWorkgroupSizeY,this.backend.device.limits.maxComputeWorkgroupSizeZ]}getMaxComputeWorkgroupStoragesize(){return this.backend.device.limits.maxComputeWorkgroupStorageSize}compute(t,e){let n=e?.inputs?.map((t=>"number"==typeof t?this.inputs[t]:t))??this.inputs,i=e?.outputs??[];return this.backend.run(t,n,i,((t,e,n)=>new kh(this.module,e,this.output(t,n),n)),((t,e)=>{let n=Zt(t);if(!n)throw new Error(`Unsupported data type: ${t}`);let i=n*ke.size(e),r=i>0?this.backend.gpuDataManager.create(i).id:0;return new kh(this.module,t,r,e)}),this.outputCount)}output(t,e){let n=this.module.stackSave();try{let n=this.module.stackAlloc(4*(1+e.length)),i=n>>2;this.module.HEAPU32[i++]=e.length;for(let t=0;t<e.length;t++)this.module.HEAPU32[i++]=e[t];return this.module.zt(this.opKernelContext,t,n)}catch(n){throw new Error(`Failed to generate kernel's output[${t}] with dims [${e}]. If you are running with pre-allocated output, please make sure the output type/dims are correct. Error: ${n}`)}finally{this.module.stackRestore(n)}}},Sh=async(t,e,n,i)=>{let r=e.jsepInit;if(!r)throw new Error("Failed to initialize JSEP. The WebAssembly module is not built with JSEP support.");if("webgpu"===t){let t=new lu;await t.initialize(n,i),r("webgpu",[t,e=>t.alloc(e),e=>t.free(e),(n,i,r,o=!1)=>{if(o)ue("verbose",(()=>`[WebGPU] jsepCopyGpuToGpu: src=${n}, dst=${i}, size=${r}`)),t.memcpy(n,i);else{ue("verbose",(()=>`[WebGPU] jsepCopyCpuToGpu: dataOffset=${n}, gpuDataId=${i}, size=${r}`));let o=e.HEAPU8.subarray(n>>>0,(n>>>0)+r);t.upload(i,o)}},async(n,i,r)=>{ue("verbose",(()=>`[WebGPU] jsepCopyGpuToCpu: gpuDataId=${n}, dataOffset=${i}, size=${r}`)),await t.download(n,(()=>e.HEAPU8.subarray(i>>>0,(i>>>0)+r)))},(n,i,r)=>t.createKernel(n,i,r,e.UTF8ToString(e.Rt(i))),e=>t.releaseKernel(e),(n,i,r,o)=>{ue("verbose",(()=>`[WebGPU] jsepRun: sessionHandle=${r}, kernel=${n}, contextDataOffset=${i}`));let s=new $h(e,t,i);return t.computeKernel(n,s,o)},()=>t.captureBegin(),()=>t.captureEnd(),()=>t.replay()])}else r("webnn")}})),ul=H((()=>{vu(),mu(),yu(),du(),pu(),wu(),Eh=(t,e)=>{0!==qt().rt(t,e)&&Bt("Can't initialize onnxruntime.")},Mh=async t=>{Eh(t.wasm.numThreads,te(t.logLevel))},Ch=async(t,e)=>{{let n=(al(),V(xh)).init;if("webgpu"===e){if(typeof navigator>"u"||!navigator.gpu)throw new Error("WebGPU is not supported in current environment");let e=t.webgpu.adapter;if(e){if("object"!=typeof e.limits||"object"!=typeof e.features||"function"!=typeof e.requestDevice)throw new Error("Invalid GPU adapter set in `env.webgpu.adapter`. It must be a GPUAdapter object.")}else{let n=t.webgpu.powerPreference;if(void 0!==n&&"low-power"!==n&&"high-performance"!==n)throw new Error(`Invalid powerPreference setting: "${n}"`);let i=t.webgpu.forceFallbackAdapter;if(void 0!==i&&"boolean"!=typeof i)throw new Error(`Invalid forceFallbackAdapter setting: "${i}"`);if(e=await navigator.gpu.requestAdapter({powerPreference:n,forceFallbackAdapter:i}),!e)throw new Error('Failed to get GPU adapter. You may need to enable flag "--enable-unsafe-webgpu" if you are using Chrome.')}await n("webgpu",qt(),t,e)}if("webnn"===e){if(typeof navigator>"u"||!navigator.ml)throw new Error("WebNN is not supported in current environment");await n("webnn",qt(),t)}}},Ah=new Map,Oh=t=>{let e=qt(),n=e.stackSave();try{let n=e.stackAlloc(8);return 0!==e.vt(t,n,n+4)&&Bt("Can't get session input/output count."),[e.HEAP32[n/4],e.HEAP32[n/4+1]]}finally{e.stackRestore(n)}},Ih=t=>{let e=qt(),n=e.Ft(t.byteLength);if(0===n)throw new Error(`Can't create a session. failed to allocate a buffer of size ${t.byteLength}.`);return e.HEAPU8.set(t,n),[n,t.byteLength]},Th=async(t,e)=>{let n,i,r=qt();Array.isArray(t)?[n,i]=t:t.buffer===r.HEAPU8.buffer?[n,i]=[t.byteOffset,t.byteLength]:[n,i]=Ih(t);let o=0,s=0,a=0,u=[],h=[],l=[];try{if([s,u]=Kt(e),e?.externalData&&r.mountExternalData){let t=[];for(let n of e.externalData){let e="string"==typeof n?n:n.path;t.push(ie("string"==typeof n?n:n.data).then((t=>{r.mountExternalData(e,t)})))}await Promise.all(t)}for(let t of e?.executionProviders??[])if("webnn"===("string"==typeof t?t:t.name)){if(r.currentContext)throw new Error("WebNN execution provider is already set.");if("string"!=typeof t){let e=t,n=e?.context,i=e?.gpuDevice,o=e?.deviceType,s=e?.numThreads,a=e?.powerPreference;r.currentContext=n||(i?await navigator.ml.createContext(i):await navigator.ml.createContext({deviceType:o,numThreads:s,powerPreference:a}))}else r.currentContext=await navigator.ml.createContext();break}o=await r._(n,i,s),0===o&&Bt("Can't create a session."),r.currentContext&&(r.currentContext=void 0);let[t,c]=Oh(o),f=!!e?.enableGraphCapture,d=[],p=[],v=[];for(let e=0;e<t;e++){let t=r.yt(o,e);0===t&&Bt("Can't get an input name."),h.push(t),d.push(r.UTF8ToString(t))}for(let t=0;t<c;t++){let n=r.wt(o,t);0===n&&Bt("Can't get an output name."),l.push(n);let i=r.UTF8ToString(n);p.push(i);{if(f&&void 0===e?.preferredOutputLocation){v.push("gpu-buffer");continue}let t="string"==typeof e?.preferredOutputLocation?e.preferredOutputLocation:e?.preferredOutputLocation?.[i]??"cpu";if("cpu"!==t&&"cpu-pinned"!==t&&"gpu-buffer"!==t)throw new Error(`Not supported preferred output location: ${t}.`);if(f&&"gpu-buffer"!==t)throw new Error(`Not supported preferred output location: ${t}. Only 'gpu-buffer' location is supported when enableGraphCapture is true.`);v.push(t)}}let m=null;return v.some((t=>"gpu-buffer"===t))&&(a=r.Mt(o),0===a&&Bt("Can't create IO binding."),m={handle:a,outputPreferredLocations:v,outputPreferredLocationsEncoded:v.map((t=>ne(t)))}),Ah.set(o,[o,h,l,m,f,!1]),[o,d,p]}catch(t){throw h.forEach((t=>r.bt(t))),l.forEach((t=>r.bt(t))),0!==a&&r.It(a),0!==o&&r.dt(o),t}finally{r.Dt(n),0!==s&&r.ft(s),u.forEach((t=>r.Dt(t))),r.unmountExternalData?.()}},zh=t=>{let e=qt(),n=Ah.get(t);if(!n)throw new Error(`cannot release session. invalid session id: ${t}`);let[i,r,o,s,a]=n;s&&(a&&e.At(s.handle),e.It(s.handle)),e.jsepOnReleaseSession?.(t),r.forEach((t=>e.bt(t))),o.forEach((t=>e.bt(t))),e.dt(i),Ah.delete(t)},Rh=(t,e,n,i,r,o=!1)=>{if(!t)return void e.push(0);let s,a,u=qt(),h=t[0],l=t[1],c=t[3];if("string"===h&&"gpu-buffer"===c)throw new Error("String tensor is not supported on GPU.");if(o&&"gpu-buffer"!==c)throw new Error(`External buffer must be provided for input/output index ${r} when enableGraphCapture is true.`);if("gpu-buffer"===c){let e=t[2].gpuBuffer,n=Zt(Xt(h));a=l.reduce(((t,e)=>t*e),1)*n;let o=u.jsepRegisterBuffer;if(!o)throw new Error('Tensor location "gpu-buffer" is not supported without using WebGPU.');s=o(i,r,e,a)}else{let e=t[2];if(Array.isArray(e)){a=4*e.length,s=u.Ft(a),n.push(s);let t=s/4;for(let i=0;i<e.length;i++){if("string"!=typeof e[i])throw new TypeError(`tensor data at index ${i} is not a string`);u.HEAPU32[t++]=jt(e[i],n)}}else a=e.byteLength,s=u.Ft(a),n.push(s),u.HEAPU8.set(new Uint8Array(e.buffer,e.byteOffset,a),s)}let f=u.stackSave(),d=u.stackAlloc(4*l.length);try{let t=d/4;l.forEach((e=>u.HEAP32[t++]=e));let n=u._t(Xt(h),s,a,d,l.length,ne(c));0===n&&Bt(`Can't create tensor for input/output. session=${i}, index=${r}.`),e.push(n)}finally{u.stackRestore(f)}},Fh=async(t,e,n,i,r,o)=>{let s=qt(),a=Ah.get(t);if(!a)throw new Error(`cannot run inference. invalid session id: ${t}`);let u=a[0],h=a[1],l=a[2],c=a[3],f=a[4],d=a[5],p=e.length,v=i.length,m=0,y=[],w=[],g=[],b=[],_=s.stackSave(),x=s.stackAlloc(4*p),k=s.stackAlloc(4*p),$=s.stackAlloc(4*v),S=s.stackAlloc(4*v);try{[m,y]=Ht(o);for(let i=0;i<p;i++)Rh(n[i],w,b,t,e[i],f);for(let e=0;e<v;e++)Rh(r[e],g,b,t,p+i[e],f);let a,_=x/4,E=k/4,M=$/4,C=S/4;for(let t=0;t<p;t++)s.HEAPU32[_++]=w[t],s.HEAPU32[E++]=h[e[t]];for(let t=0;t<v;t++)s.HEAPU32[M++]=g[t],s.HEAPU32[C++]=l[i[t]];if(c&&!d){let{handle:n,outputPreferredLocations:o,outputPreferredLocationsEncoded:a}=c;if(h.length!==p)throw new Error(`input count from feeds (${p}) is expected to be always equal to model's input count (${h.length}).`);for(let i=0;i<p;i++){let r=e[i];0!==await s.nt(n,h[r],w[i])&&Bt(`Can't bind input[${i}] for session=${t}.`)}for(let e=0;e<v;e++){let u=i[e];r[e]?.[3]?0!==s.Ct(n,l[u],g[e],0)&&Bt(`Can't bind pre-allocated output[${e}] for session=${t}.`):0!==s.Ct(n,l[u],0,a[u])&&Bt(`Can't bind output[${e}] to ${o[e]} for session=${t}.`)}Ah.set(t,[u,h,l,c,f,!0])}s.jsepOnRunStart?.(u),a=c?await s.et(u,c.handle,v,$,m):await s.tt(u,k,x,p,S,v,$,m),0!==a&&Bt("failed to call OrtRun().");let A=[];for(let t=0;t<v;t++){let e=s.HEAPU32[$/4+t];if(e===g[t]){A.push(r[t]);continue}let n,o=s.stackSave(),a=s.stackAlloc(16),u=!1,h=0;try{0!==s.xt(e,a,a+4,a+8,a+12)&&Bt(`Can't access output tensor data on index ${t}.`);let r=a/4,o=s.HEAPU32[r++];h=s.HEAPU32[r++];let l=s.HEAPU32[r++],f=s.HEAPU32[r++],d=[];for(let t=0;t<f;t++)d.push(s.HEAPU32[l/4+t]);s.bt(l);let p=d.reduce(((t,e)=>t*e),1);n=Qt(o);let v=c?.outputPreferredLocations[i[t]];if("string"===n){if("gpu-buffer"===v)throw new Error("String tensor is not supported on GPU.");let t=[],e=h/4;for(let n=0;n<p;n++){let i=s.HEAPU32[e++],r=n===p-1?void 0:s.HEAPU32[e]-i;t.push(s.UTF8ToString(i,r))}A.push([n,d,t,"cpu"])}else if("gpu-buffer"===v&&p>0){let t=s.jsepGetBuffer;if(!t)throw new Error('preferredLocation "gpu-buffer" is not supported without using WebGPU.');let i=t(h),r=Zt(o);if(void 0===r||!ee(n))throw new Error(`Unsupported data type: ${n}`);u=!0,A.push([n,d,{gpuBuffer:i,download:s.jsepCreateDownloader(i,p*r,n),dispose:()=>{s.kt(e)}},"gpu-buffer"])}else{let t=new(Jt(n))(p);new Uint8Array(t.buffer,t.byteOffset,t.byteLength).set(s.HEAPU8.subarray(h,h+t.byteLength)),A.push([n,d,t,"cpu"])}}finally{s.stackRestore(o),"string"===n&&h&&s.Dt(h),u||s.kt(e)}}return c&&!f&&(s.At(c.handle),Ah.set(t,[u,h,l,c,f,!1])),A}finally{s.stackRestore(_),w.forEach((t=>s.kt(t))),g.forEach((t=>s.kt(t))),b.forEach((t=>s.Dt(t))),0!==m&&s.Et(m),y.forEach((t=>s.Dt(t)))}},Dh=t=>{let e=qt(),n=Ah.get(t);if(!n)throw new Error("invalid session id");let i=n[0],r=e.Tt(i);0===r&&Bt("Can't get an profile file name."),e.bt(r)},Ph=t=>{let e=[];for(let n of t){let t=n[2];!Array.isArray(t)&&"buffer"in t&&e.push(t.buffer)}return e}})),hl=H((()=>{pt(),ul(),du(),fu(),Nh=()=>!!v.wasm.proxy&&typeof document<"u",qh=!1,jh=!1,Lh=!1,Wh=new Map,Vh=(t,e)=>{let n=Wh.get(t);n?n.push(e):Wh.set(t,[e])},Gh=()=>{if(qh||!jh||Lh||!Uh)throw new Error("worker not ready")},Yh=t=>{switch(t.data.type){case"init-wasm":qh=!1,t.data.err?(Lh=!0,Hh[1](t.data.err)):(jh=!0,Hh[0]()),Bh&&(URL.revokeObjectURL(Bh),Bh=void 0);break;case"init-ep":case"copy-from":case"create":case"release":case"run":case"end-profiling":{let e=Wh.get(t.data.type);t.data.err?e.shift()[1](t.data.err):e.shift()[0](t.data.out);break}}},Kh=async()=>{if(!jh){if(qh)throw new Error("multiple calls to 'initWasm()' detected.");if(Lh)throw new Error("previous call to 'initWasm()' failed.");if(qh=!0,Nh())return new Promise(((t,e)=>{Uh?.terminate(),Ot().then((([n,i])=>{try{(Uh=i).onerror=t=>e(t),Uh.onmessage=Yh,Hh=[t,e];let r={type:"init-wasm",in:v};Uh.postMessage(r),Bh=n}catch(t){e(t)}}),e)}));try{await Ut(v.wasm),await Mh(v),jh=!0}catch(t){throw Lh=!0,t}finally{qh=!1}}},Xh=async t=>{if(Nh())return Gh(),new Promise(((e,n)=>{Vh("init-ep",[e,n]);let i={type:"init-ep",in:{epName:t,env:v}};Uh.postMessage(i)}));await Ch(v,t)},Qh=async t=>Nh()?(Gh(),new Promise(((e,n)=>{Vh("copy-from",[e,n]);let i={type:"copy-from",in:{buffer:t}};Uh.postMessage(i,[t.buffer])}))):Ih(t),Zh=async(t,e)=>{if(Nh()){if(e?.preferredOutputLocation)throw new Error('session option "preferredOutputLocation" is not supported for proxy.');return Gh(),new Promise(((n,i)=>{Vh("create",[n,i]);let r={type:"create",in:{model:t,options:{...e}}},o=[];t instanceof Uint8Array&&o.push(t.buffer),Uh.postMessage(r,o)}))}return Th(t,e)},Jh=async t=>{if(Nh())return Gh(),new Promise(((e,n)=>{Vh("release",[e,n]);let i={type:"release",in:t};Uh.postMessage(i)}));zh(t)},tl=async(t,e,n,i,r,o)=>{if(Nh()){if(n.some((t=>"cpu"!==t[3])))throw new Error("input tensor on GPU is not supported for proxy.");if(r.some((t=>t)))throw new Error("pre-allocated output tensor is not supported for proxy.");return Gh(),new Promise(((r,s)=>{Vh("run",[r,s]);let a=n,u={type:"run",in:{sessionId:t,inputIndices:e,inputs:a,outputIndices:i,options:o}};Uh.postMessage(u,Ph(a))}))}return Fh(t,e,n,i,r,o)},el=async t=>{if(Nh())return Gh(),new Promise(((e,n)=>{Vh("end-profiling",[e,n]);let i={type:"end-profiling",in:t};Uh.postMessage(i)}));Dh(t)}})),ll=H((()=>{pt(),hl(),yu(),vt(),wu(),nl=(t,e)=>{switch(t.location){case"cpu":return[t.type,t.dims,t.data,"cpu"];case"gpu-buffer":return[t.type,t.dims,{gpuBuffer:t.gpuBuffer},"gpu-buffer"];default:throw new Error(`invalid data location: ${t.location} for ${e()}`)}},il=t=>{switch(t[3]){case"cpu":return new O(t[0],t[2],t[1]);case"gpu-buffer":{let e=t[0];if(!ee(e))throw new Error(`not supported data type: ${e} for deserializing GPU tensor`);let{gpuBuffer:n,download:i,dispose:r}=t[2];return O.fromGpuBuffer(n,{dataType:e,dims:t[1],download:i,dispose:r})}default:throw new Error(`invalid data location: ${t[3]}`)}},rl=class{async fetchModelAndCopyToWasmMemory(t){return Qh(await ie(t))}async loadModel(t,e){let n;z(),n="string"==typeof t?await this.fetchModelAndCopyToWasmMemory(t):t,[this.sessionId,this.inputNames,this.outputNames]=await Zh(n,e),R()}async dispose(){return Jh(this.sessionId)}async run(t,e,n){z();let i=[],r=[];Object.entries(t).forEach((t=>{let e=t[0],n=t[1],o=this.inputNames.indexOf(e);if(-1===o)throw new Error(`invalid input '${e}'`);i.push(n),r.push(o)}));let o=[],s=[];Object.entries(e).forEach((t=>{let e=t[0],n=t[1],i=this.outputNames.indexOf(e);if(-1===i)throw new Error(`invalid output '${e}'`);o.push(n),s.push(i)}));let a=i.map(((t,e)=>nl(t,(()=>`input "${this.inputNames[r[e]]}"`)))),u=o.map(((t,e)=>t?nl(t,(()=>`output "${this.outputNames[s[e]]}"`)):null)),h=await tl(this.sessionId,r,a,s,u,n),l={};for(let t=0;t<h.length;t++)l[this.outputNames[s[t]]]=o[t]??il(h[t]);return R(),l}startProfiling(){}endProfiling(){el(this.sessionId)}}})),cl=H((()=>{pt(),hl(),ll(),fu(),ol=()=>{if(("number"!=typeof v.wasm.initTimeout||v.wasm.initTimeout<0)&&(v.wasm.initTimeout=0),v.wasm.simd,"boolean"!=typeof v.wasm.proxy&&(v.wasm.proxy=!1),"boolean"!=typeof v.wasm.trace&&(v.wasm.trace=!1),"number"!=typeof v.wasm.numThreads||!Number.isInteger(v.wasm.numThreads)||v.wasm.numThreads<=0)if(typeof self<"u"&&!self.crossOriginIsolated)v.wasm.numThreads=1;else{let t=typeof navigator>"u"?B("node:os").cpus().length:navigator.hardwareConcurrency;v.wasm.numThreads=Math.min(4,Math.ceil((t||1)/2))}},sl=class{async init(t){ol(),await Kh(),await Xh(t)}async createInferenceSessionHandler(t,e){let n=new rl;return await n.loadModel(t,e),Promise.resolve(n)}}})),fl={};W(fl,{wasmBackend:()=>dl});var dl,pl=H((()=>{cl(),dl=new sl}));pt(),pt(),pt();var vl=dt;{let t=(pl(),V(fl)).wasmBackend;h("webgpu",t,5),h("webnn",t,5),h("cpu",t,10),h("wasm",t,10)}Object.defineProperty(v.versions,"web",{value:"1.19.2",enumerable:!0});let ml=new Worker(URL.createObjectURL(new Blob(["(",function(){const t=262145;let e=new Uint32Array(t),n=new Uint32Array(2e7),i=new Uint32Array(2e7);self.onmessage=r=>{(async r=>{((r,o)=>{const s=r.Ut,a=!!s.find((t=>t.qt)),u=r.jt;let h=1/0,l=-1/0,c=0,f=1/0,d=0;const p=a?6:2,v=Math.floor(u/p),m=u*v;for(let t=0,e=s.length;t<e;t+=1){const e=s[t],{Lt:n,Bt:i,Ht:r,Wt:o,Vt:a,Gt:u,Yt:p}=e;c+=p,f=Math.min(f,u),d=Math.max(d,u);const v=r[2],m=r[6],y=r[10],w=r[14];for(let t=0;t<8;++t){let e=v*(1&t?i[0]:n[0])+m*(2&t?i[1]:n[1])+y*(4&t?i[2]:n[2])+w;h=Math.min(h,e),l=Math.max(l,e)}}h-=1;const y=t*(d-f+1);e=y<e.length?new Uint32Array(e.buffer,0,y):new Uint32Array(y),c<n.length?(n=new Uint32Array(n.buffer,0,c),i=new Uint32Array(i.buffer,0,c)):c>n.length&&(n=new Uint32Array(c),i=new Uint32Array(c));for(var w=0;w<y;w+=1)e[w]=0;const g=1/(l-h)*262144,b=[],_=Math.ceil(Math.log2(u*u));let x,k=0;for(let r=0,o=s.length;r<o;r+=1){const o=s[r],{Lt:a,Bt:l,Ht:c,Wt:f,Vt:y,Gt:w,Kt:x,Yt:$}=o;let S=0;for(let t=0,e=x.length;t<e;t+=1){const n=x[t];let i=b.indexOf(n._id);-1==i?(b.push(n._id),n.Xt=b.length-1):n.Xt=i;let r,o=f+"_"+t;r=t<e-1?n.Qt[o][1]*v:$-S,n.pixelOffsetInThisTexture=n.Qt[o][0]*u,n.countInThisTexture=r,n.startIdxInTile=S,S+=r}const E=d-w,M=c[2],C=c[6],A=c[10],O=c[14],I=new Float32Array(y);let T=0,z=x[T],R=z.Xt,F=z.startIdxInTile;for(let r=0;r<$;r+=1){const o=3*r,s=((M*I[o]+C*I[o+1]+A*I[o+2]+O-h)*g|0)+E*t;if(n[k]=s,x.length>1&&r>=m){const t=r/m|0;t!==T&&(T=t,z=x[T],R=z.Xt,F=z.startIdxInTile)}const a=r-F,l=z.pixelOffsetInThisTexture+(a/v|0)*u+a%v*p;i[k]=(R<<_)+l,e[s]+=1,k+=1}}for(let t=1;t<y;t+=1)e[t]+=e[t-1];x=r.Zt.length<i.length?new Int32Array(i.length):new Int32Array(r.Zt);for(let t=i.length-1;t>=0;t--){const r=n[t];x[--e[r]]=i[t]}x=x.reverse();const $=[],S=[],E=[],M=[0],C=[];s.forEach((t=>{$.push(t.Wt),S.push(t.Jt),C.push(t.Gt),E.push(t.Vt),M.push(t.Yt+M[M.length-1])})),M.pop(),self.postMessage({te:o,qt:a,ee:$,ne:S,Vt:E,Qt:M,Zt:x,ie:b,re:x.length-k,oe:k},[x.buffer,...E])})(r,r.te)})(r.data)}}.toString(),")(self)"],{type:"application/javascript"})));const yl=ml;for(var wl,gl=[],bl=0;bl<256;++bl)gl.push((bl+256).toString(16).slice(1));var _l=new Uint8Array(16);function xl(){if(!wl&&!(wl="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return wl(_l)}var kl={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function $l(t,e,n){if(kl.randomUUID&&!t)return kl.randomUUID();var i=(t=t||{}).random||(t.rng||xl)();return i[6]=15&i[6]|64,i[8]=63&i[8]|128,function(t,e=0){return(gl[t[e+0]]+gl[t[e+1]]+gl[t[e+2]]+gl[t[e+3]]+"-"+gl[t[e+4]]+gl[t[e+5]]+"-"+gl[t[e+6]]+gl[t[e+7]]+"-"+gl[t[e+8]]+gl[t[e+9]]+"-"+gl[t[e+10]]+gl[t[e+11]]+gl[t[e+12]]+gl[t[e+13]]+gl[t[e+14]]+gl[t[e+15]]).toLowerCase()}(i)}class Sl{static idCount=0;_id;se;ae;ue;he;ce;_texture;Qt={};fe;de=-2;pe=0;ve=!1;constructor(t,e){this._id=Sl.idCount++,this.ce=e,this.ae=this.ue=t,this.fe=[[0,this.ue]],this.he=t,this._texture=new i.Texture({name:this._id,context:this.ce,internalFormat:i.WebGLConstants.RGBA32F,pixelFormat:i.WebGLConstants.RGBA,pixelDatatype:i.WebGLConstants.FLOAT,width:t,height:t,flipY:!1,sampler:new i.Sampler({minificationFilter:i.TextureMinificationFilter.NEAREST,magnificationFilter:i.TextureMagnificationFilter.NEAREST})})}me(t,e,n){const i=this.ye(t.height),r=this.fe[i][0];this._texture.copyFrom({xOffset:0,yOffset:r,source:t}),this.Qt[e]=[r,t.height],this.he-=t.height,this.se?(this.se.x=(this.se.x*this.pe+n.x)/(this.pe+1),this.se.y=(this.se.y*this.pe+n.y)/(this.pe+1),this.se.z=(this.se.z*this.pe+n.z)/(this.pe+1)):this.se=n,this.pe+=1,this.we()}be(t,e){this.he+=this.Qt[t][1],delete this.Qt[t],this.we(),this.fe.length&&this.se?(this.se.x=(this.se.x*this.pe-e.x)/(this.pe-1),this.se.y=(this.se.y*this.pe-e.y)/(this.pe-1),this.se.z=(this.se.z*this.pe-e.z)/(this.pe-1)):this.se=void 0,this.pe-=1}we(){const t=Object.values(this.Qt).map((t=>[t[0],t[0]+t[1]])).sort(((t,e)=>t[0]<e[0]?-1:1)).flat();t.unshift(0),t.push(this.ue);const e=[];for(let n=0;n<t.length;n+=2)t[n]!==t[n+1]&&e.push([t[n],t[n+1]]);this.fe=e}ye(t){for(let e=0;e<this.fe.length;e+=1)if(this.fe[e][1]-this.fe[e][0]>=t)return e;return-1}_e(){this.he=this.ue,this.se=void 0,this.pe=0,this.Qt={},this.fe=[[0,this.ue]]}xe(){return this.he===this.ue}_destroy(){this.ve||(this.ve=!0,this._e(),this._texture.destroy(),this._texture=null)}}class El{ke=[];$e={};ce;jt;Kt={};constructor(t,e){this.ce=t,this.jt=e}Se(t){return t.map((t=>this.Kt[t]))}Ee(t,e,n,i){if(this.$e[i]){let r=this.Me(t,e,n,this.$e[i]);return r||(r=this.ke.length?this.ke.pop():new Sl(this.jt,this.ce),r.de=i,this.$e[i].push(r),this.Kt[r._id]=r),r}{this.$e[i]=[];const t=new Sl(this.jt,this.ce);return t.de=i,this.$e[i].push(t),this.Kt[t._id]=t,t}}_destroy(){Object.keys(this.$e).forEach((t=>{this.$e[t].forEach((t=>{t._destroy(),delete this.Kt[t._id]})),delete this.$e[t]})),this.ke.forEach((t=>{t._destroy(),delete this.Kt[t._id]})),this.ke=[]}Me(e,n,i,r){let o,s=1/0;for(let a=r.length-1;a>=0;a-=1){const u=r[a];if(-1!==u.ye(i)){const i=t.Cartesian3.distance(e,u.se);i<n&&i<s&&(s=i,o=u)}}return o}Ce(t){const{Kt:e}=t;e?.forEach(((e,n)=>{const i=t.Ae+"_"+n;if(e.be(i,t.Oe),e.xe()){e._e(),this.ke.length<2?this.ke.push(e):e._destroy();const n=this.$e[t.Gt].indexOf(e);-1!==n&&this.$e[t.Gt].splice(n,1),delete this.Kt[e._id]}}))}}class Ml{Ie=$l();ce;Te=0;ze;_texture;Re;textureWidth;Fe=!0;De;Pe={Vt:new ArrayBuffer(0),Ht:[],oe:0,Lt:[0,0,0],Bt:[0,0,0]};Ne;afterSort;Ue={Zt:new Int32Array(0),ee:[],_modelMatrix:i.Matrix4.IDENTITY.clone(),Kt:[],oe:0,qe:-1,je:void 0,Le:[0],qt:!1};Be=[0,0,0];constructor(t){this.ce=t.ce,this.Re=t.Re,this.textureWidth=Math.min(4096,this.ce._gl.getParameter(this.ce._gl.MAX_TEXTURE_SIZE)),this.Ne=new El(this.ce,this.textureWidth),yl.addEventListener("message",(t=>{this.He(t.data)})),t.We&&(this.De=t.We,this.Ve(),this.Ge()),this.Be=t.Be}updateData(t,e){this.De=t,this.Be=e,this.Ve(),this.Ge()}He(t){const{Zt:e,Qt:n,oe:r,te:o}=t;if(o!==this.Ie)return;const s=i.Cartesian3.fromDegrees(this.Re[0],this.Re[1],this.Re[2]),a=i.Transforms.eastNorthUpToFixedFrame(s);this.Ue={ee:["single-model"],Zt:e,_modelMatrix:a,Kt:[this._texture],oe:r,qe:this.Ue.qe,je:this.Ue.je,Le:[r],qt:!1},this.Fe=!0,this.afterSort&&this.afterSort(this.Ue)}Ge(){if(this._texture&&this._texture.destroy(),!this.De)return;const t=this.textureWidth;let e=Math.ceil(this.De.byteLength/16/t);e=Math.pow(2,Math.ceil(Math.log2(e)));const n=new Float32Array(new ArrayBuffer(t*e*16));n.set(new Float32Array(this.De),0);const r=new i.Cartesian3(this.Be[0],this.Be[1],this.Be[2]),o=this.Ne.Ee(r,600,e,4);o.me({width:t,height:e,arrayBufferView:n},"single-buffer",r),this._texture=o}_destroy(){this.Ue=void 0,this.Pe=void 0}Ye(t,e){this.Ue.qe=t,this.Ue.je=e||void 0}Ke(t){const e=t.camera.viewMatrix,n=(new Date).getTime();let r=!1;if(!(0==this.Fe||this.Ue&&this.Ue.Zt.buffer.detached)&&(this.Te?this.Xe(this.ze,e)&&(r=!0):r=!0,r)){const r=t.camera.frustum.projectionMatrix;this.Te=n,this.ze=e.clone(),this.Fe=!1;const o=[this.Ue.Zt.buffer],s=i.Cartesian3.fromDegrees(this.Re[0],this.Re[1],this.Re[2]),a=i.Transforms.eastNorthUpToFixedFrame(s);i.Matrix4.multiply(e,a,a),i.Matrix4.multiply(r,a,a);const u={te:this.Ie,Qe:e,Zt:this.Ue.Zt,Qt:[0],Ut:[{Gt:0,Wt:this.Ie,Vt:this.Pe.Vt,Ht:a,Lt:this.Pe.Lt,Bt:this.Pe.Bt,Yt:this.Pe.oe}]};yl.postMessage(u,o)}}Xe(t,e){let n=t[2]*e[2]+t[6]*e[6]+t[10]*e[10];const i=(t[2]**2+t[6]**2+t[10]**2)**.5,r=(e[2]**2+e[6]**2+e[10]**2)**.5;return Math.abs(n/i/r-1)>.01}Ve(){if(!this.De)return;const t=new Float32Array(this.De),e=[1/0,1/0,1/0,-1/0,-1/0,-1/0],n=new Float32Array(this.De.byteLength/8/4*3);for(let i=0;i<t.length;i+=8){const r=t[i],o=t[i+1],s=t[i+2];n[i/8*3]=r,n[i/8*3+1]=o,n[i/8*3+2]=s,e[0]=Math.min(e[0],r),e[1]=Math.min(e[1],o),e[2]=Math.min(e[2],s),e[3]=Math.max(e[3],r),e[4]=Math.max(e[4],o),e[5]=Math.max(e[5],s)}this.Pe.Bt=[e[0],e[1],e[2]],this.Pe.Lt=[e[3],e[4],e[5]],this.Pe.Vt=n.buffer,this.Pe.oe=n.length/3}}class Cl{events;constructor(){this.events=new Map}on(t,e){this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(e)}clear(t){t?this.events.set(t,[]):this.events.clear()}off(t,e){const n=this.events.get(t);if(!n)return;const i=n.indexOf(e);-1!==i&&n.splice(i,1),0===n.length&&this.events.delete(t)}emit(t,e){const n=this.events.get(t);n&&n.forEach((t=>t(e)))}}class Al{Ze;Je;tn;en;nn;We;rn=!1;ve=!1;sn;an;un=!1;classificationType=i.ClassificationType.BOTH;constructor(t,e,n){this.We=t,this.sn=e,this.an=n}prePassesUpdate(t){this.an.hn}update(t){this.ve||this.rn&&this.an.rn&&(t.commandList.push(this.nn),t.commandList.push(this.Ze),this.an.hn&&t.commandList.push(this.en),t.commandList.push(this.tn))}postPassesUpdate(t){}isDestroyed(){return this.ve}setBoundingVolume(t){this.Ze.boundingVolume=t,this.tn.boundingVolume=t,this.en.boundingVolume=t}show(t){0==this.rn&&(this.rn=!0),this.Ze.sort=t}hide(){this.rn&&(this.rn=!1)}destroy(){this.We?.Kt&&this.We?.Kt.forEach((t=>{t._destroy()})),this.Ze.vertexArray.getAttribute(1).vertexBuffer.destroy(),this.Ze.vertexArray.ln=[],this.Ze.vertexArray.destroy(),this.an=void 0,this.We=void 0,this.ve=!0}}class Ol extends Cl{ce;_scene;cn;fn;dn;pn=[];vn;jt;mn;yn;wn;Kt=[];hn;gn;bn=new i.Cartesian2(1,1);rn=!0;tn;nn;_n;xn;kn=!1;_modelMatrix;$n;Sn;en;constructor(t){super(),this.ce=t.scene.context,this.jt=t.jt,t.bn&&(this.bn=new i.Cartesian2(t.bn.brightness||1,t.bn.saturate||1)),this._n=t._n,this.xn=t.xn,this.$n=t.$n,this._scene=t.scene,this.hn=t.hn,this.gn=t.gn,i.FeatureDetection.supportsWebgl2&&i.FeatureDetection.supportsWebgl2(this._scene),this.yn=new i.PrimitiveCollection,this.yn.destroyPrimitives=!1,this._scene.groundPrimitives.add(this.yn),this.cn=i.ShaderProgram.fromCache({context:this.ce,vertexShaderSource:"#version 300 es\nprecision highp int;precision highp float;in vec3 position;in float pIdx;uniform vec2 viewport;uniform highp sampler2D u_txts[16];uniform mat4 u_mvs;uniform mat4 u_view;uniform mat3 u_normalMatrix;uniform ivec4 u_params;uniform int u_sltid;uniform vec4 u_sltc;uniform vec2 u_filter;out vec3 texCoord;out vec4 color;out vec4 allMap;out vec3 vPosition;out float maxScale;vec3 rgbToHls(vec3 rgb){float maxC=max(max(rgb.r,rgb.g),rgb.b);float minC=min(min(rgb.r,rgb.g),rgb.b);float h,l,s;l=(maxC+minC)/2.0f;if(maxC==minC){s=0.0f;h=0.0f;}else{float delta=maxC-minC;s=(l<0.5f)? delta/(maxC+minC): delta/(2.0f-maxC-minC);if(maxC==rgb.r){h=(rgb.g-rgb.b)/delta+(rgb.g<rgb.b ? 6.0f : 0.0f);}else if(maxC==rgb.g){h=(rgb.b-rgb.r)/delta+2.0f;}else{h=(rgb.r-rgb.g)/delta+4.0f;}h/=6.0f;}return vec3(h,l,s);}float hueToRgb(float t1,float t2,float hue){if(hue<0.0f)hue+=1.0f;if(hue>1.0f)hue-=1.0f;if(hue<1.0f/6.0f)return t1+(t2-t1)*6.0f*hue;if(hue<0.5f)return t2;if(hue<2.0f/3.0f)return t1+(t2-t1)*(2.0f/3.0f-hue)*6.0f;return t1;}vec3 hlsToRgb(vec3 hls){float h=hls.x;float l=hls.y;float s=hls.z;vec3 rgb;if(s==0.0f){rgb=vec3(l);}else{float temp2=(l<0.5f)? l*(1.0f+s): l+s-l*s;float temp1=2.0f*l-temp2;rgb.r=hueToRgb(temp1,temp2,h+1.0f/3.0f);rgb.g=hueToRgb(temp1,temp2,h);rgb.b=hueToRgb(temp1,temp2,h-1.0f/3.0f);}return rgb;}vec4 modify(vec4 color,vec2 f){vec3 hls=rgbToHls(color.xyz);hls.y*=f.x;hls.z*=f.y;hls=clamp(hls,0.0f,1.0f);return vec4(hlsToRgb(hls),color.a);}vec3 unpack111011s(uint bits){return vec3((uvec3(bits)>>uvec3(21u,11u,0u))&uvec3(0x7ffu,0x3ffu,0x7ffu))/vec3(2047.0f,1023.0f,2047.0f)*2.0f-1.0f;}void fetchScale(in uvec4 t,out float scale,out vec3 a,out vec3 b,out vec3 c){scale=uintBitsToFloat(t.x);a=unpack111011s(t.y);b=unpack111011s(t.z);c=unpack111011s(t.w);}void fetch(in uvec4 t,out vec3 a,out vec3 b,out vec3 c,out vec3 d){a=unpack111011s(t.x);b=unpack111011s(t.y);c=unpack111011s(t.z);d=unpack111011s(t.w);}void fetch(in uint t,out vec3 a){a=unpack111011s(t);}void readSHData(in uvec4 p0,in uvec4 p1,in uvec4 p2,in uvec4 p3,out vec3 sh[15],out float scale){fetchScale(p0,scale,sh[0],sh[1],sh[2]);fetch(p1,sh[3],sh[4],sh[5],sh[6]);fetch(p2,sh[7],sh[8],sh[9],sh[10]);fetch(p3,sh[11],sh[12],sh[13],sh[14]);}\n#define SH_C1 0.4886025119029199f\n#define SH_C2_0 1.0925484305920792f\n#define SH_C2_1 -1.0925484305920792f\n#define SH_C2_2 0.31539156525252005f\n#define SH_C2_3 -1.0925484305920792f\n#define SH_C2_4 0.5462742152960396f\n#define SH_C3_0 -0.5900435899266435f\n#define SH_C3_1 2.890611442640554f\n#define SH_C3_2 -0.4570457994644658f\n#define SH_C3_3 0.3731763325901154f\n#define SH_C3_4 -0.4570457994644658f\n#define SH_C3_5 1.445305721320277f\n#define SH_C3_6 -0.5900435899266435f\nvec3 evalSH(in uvec4 p0,in uvec4 p1,in uvec4 p2,in uvec4 p3,in vec3 dir){vec3 sh[15];float scale;readSHData(p0,p1,p2,p3,sh,scale);float x=dir.x;float y=dir.y;float z=dir.z;vec3 result=SH_C1*(-sh[0]*y+sh[1]*z-sh[2]*x);float xx=x*x;float yy=y*y;float zz=z*z;float xy=x*y;float yz=y*z;float xz=x*z;result+=sh[3]*(SH_C2_0*xy)*+sh[4]*(SH_C2_1*yz)+sh[5]*(SH_C2_2*(2.0f*zz-xx-yy))+sh[6]*(SH_C2_3*xz)+sh[7]*(SH_C2_4*(xx-yy));result+=sh[8]*(SH_C3_0*y*(3.0f*xx-yy))+sh[9]*(SH_C3_1*xy*z)+sh[10]*(SH_C3_2*y*(4.0f*zz-xx-yy))+sh[11]*(SH_C3_3*z*(2.0f*zz-3.0f*xx-3.0f*yy))+sh[12]*(SH_C3_4*x*(4.0f*zz-xx-yy))+sh[13]*(SH_C3_5*z*(xx-yy))+sh[14]*(SH_C3_6*x*(xx-3.0f*yy));return result*scale;}void main(){int idx=floatBitsToInt(pIdx);int px=u_params.x;int py=u_params.y;int bits=u_params.z;int tw=u_params.w;bool hasSH=px==1;int texId=idx>>bits;idx=idx&((1<<bits)-1);int v=idx/tw;int u_1=idx % tw;int u_2=u_1+1;ivec2 a=ivec2(u_1,v);highp vec4 ct;vec4 cvf;uvec4 p0,p1,p2,p3;switch(texId){case 0:ct=texelFetch(u_txts[0],a,0);a.x+=1;cvf=texelFetch(u_txts[0],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[0],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[0],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[0],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[0],a,0));}break;case 1:ct=texelFetch(u_txts[1],a,0);a.x+=1;cvf=texelFetch(u_txts[1],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[1],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[1],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[1],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[1],a,0));}break;case 2:ct=texelFetch(u_txts[2],a,0);a.x+=1;cvf=texelFetch(u_txts[2],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[2],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[2],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[2],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[2],a,0));}break;case 3:ct=texelFetch(u_txts[3],a,0);a.x+=1;cvf=texelFetch(u_txts[3],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[3],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[3],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[3],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[3],a,0));}break;case 4:ct=texelFetch(u_txts[4],a,0);a.x+=1;cvf=texelFetch(u_txts[4],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[4],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[4],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[4],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[4],a,0));}break;case 5:ct=texelFetch(u_txts[5],a,0);a.x+=1;cvf=texelFetch(u_txts[5],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[5],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[5],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[5],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[5],a,0));}break;case 6:ct=texelFetch(u_txts[6],a,0);a.x+=1;cvf=texelFetch(u_txts[6],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[6],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[6],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[6],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[6],a,0));}break;case 7:ct=texelFetch(u_txts[7],a,0);a.x+=1;cvf=texelFetch(u_txts[7],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[7],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[7],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[7],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[7],a,0));}break;case 8:ct=texelFetch(u_txts[8],a,0);a.x+=1;cvf=texelFetch(u_txts[8],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[8],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[8],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[8],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[8],a,0));}break;case 9:ct=texelFetch(u_txts[9],a,0);a.x+=1;cvf=texelFetch(u_txts[9],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[9],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[9],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[9],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[9],a,0));}break;case 10:ct=texelFetch(u_txts[10],a,0);a.x+=1;cvf=texelFetch(u_txts[10],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[10],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[10],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[10],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[10],a,0));}break;case 11:ct=texelFetch(u_txts[11],a,0);a.x+=1;cvf=texelFetch(u_txts[11],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[11],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[11],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[11],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[11],a,0));}break;case 12:ct=texelFetch(u_txts[12],a,0);a.x+=1;cvf=texelFetch(u_txts[12],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[12],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[12],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[12],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[12],a,0));}break;case 13:ct=texelFetch(u_txts[13],a,0);a.x+=1;cvf=texelFetch(u_txts[13],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[13],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[13],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[13],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[13],a,0));}break;case 14:ct=texelFetch(u_txts[14],a,0);a.x+=1;cvf=texelFetch(u_txts[14],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[14],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[14],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[14],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[14],a,0));}break;case 15:ct=texelFetch(u_txts[15],a,0);a.x+=1;cvf=texelFetch(u_txts[15],a,0);if(hasSH){a.x+=1;p0=floatBitsToUint(texelFetch(u_txts[15],a,0));a.x+=1;p1=floatBitsToUint(texelFetch(u_txts[15],a,0));a.x+=1;p2=floatBitsToUint(texelFetch(u_txts[15],a,0));a.x+=1;p3=floatBitsToUint(texelFetch(u_txts[15],a,0));}break;}vec4 splat_cam=u_mvs*vec4(ct.xyz,1);vec4 splat_proj=czm_projection*splat_cam;splat_proj.z=clamp(splat_proj.z,-abs(splat_proj.w),abs(splat_proj.w));vPosition=ct.xyz;if(splat_proj.z<-splat_proj.w){gl_Position=vec4(0.0f,0.0f,0.0f,0.0f);return;}uvec4 cov=floatBitsToUint(cvf);vec2 s1=unpackHalf2x16(cov.y),s2=unpackHalf2x16(cov.z);vec3 scale=vec3(s1.x,s1.y,s2.x);maxScale=max(max(s1.x,s1.y),s2.x);vec4 rot=vec4((cov.x)&0xffu,(cov.x>>8)&0xffu,(cov.x>>16)&0xffu,(cov.x>>24)&0xffu);rot=(rot-128.0f)/128.0f;mat3 M=mat3((1.0f-2.0f*(rot.z*rot.z+rot.w*rot.w))*scale.x,(2.0f*(rot.y*rot.z+rot.x*rot.w))*scale.x,(2.0f*(rot.y*rot.w-rot.x*rot.z))*scale.x,(2.0f*(rot.y*rot.z-rot.x*rot.w))*scale.y,(1.0f-2.0f*(rot.y*rot.y+rot.w*rot.w))*scale.y,(2.0f*(rot.z*rot.w+rot.x*rot.y))*scale.y,(2.0f*(rot.y*rot.w+rot.x*rot.z))*scale.z,(2.0f*(rot.z*rot.w-rot.x*rot.y))*scale.z,(1.0f-2.0f*(rot.y*rot.y+rot.z*rot.z))*scale.z);vec2 u1=vec2(M[0].x*M[0].x+M[1].x*M[1].x+M[2].x*M[2].x,M[0].x*M[0].y+M[1].x*M[1].y+M[2].x*M[2].y)*4.0f;vec2 u2=vec2(M[0].x*M[0].z+M[1].x*M[1].z+M[2].x*M[2].z,M[0].y*M[0].y+M[1].y*M[1].y+M[2].y*M[2].y)*4.0f;vec2 u3=vec2(M[0].y*M[0].z+M[1].y*M[1].z+M[2].y*M[2].z,M[0].z*M[0].z+M[1].z*M[1].z+M[2].z*M[2].z)*4.0f;mat3 Vrk=mat3(u1.x,u1.y,u2.x,u1.y,u2.y,u3.x,u2.x,u3.x,u3.y);float focal=viewport.x*czm_projection[0][0];mat3 J=mat3(focal/splat_cam.z,0.f,-(focal*splat_cam.x)/(splat_cam.z*splat_cam.z),0.f,focal/splat_cam.z,-(focal*splat_cam.y)/(splat_cam.z*splat_cam.z),0.f,0.f,0.f);mat3 W=transpose(mat3(u_mvs));mat3 T=W*J;mat3 cov2d=transpose(T)*Vrk*T;float diagonal1=cov2d[0][0];float offDiagonal=cov2d[0][1];float diagonal2=cov2d[1][1];float mid=0.5f*(diagonal1+diagonal2);float _radius=length(vec2((diagonal1-diagonal2)/2.0f,offDiagonal));float lambda1=mid+_radius;float lambda2=max(mid-_radius,0.1f);vec2 diagonalVector=normalize(vec2(offDiagonal,lambda1-diagonal1));vec2 v1=min(sqrt(2.0f*lambda1),1024.0f)*diagonalVector;vec2 v2=min(sqrt(2.0f*lambda2),1024.0f)*vec2(diagonalVector.y,-diagonalVector.x);color=clamp(splat_proj.z/splat_proj.w+1.0f,0.0f,1.0f)*vec4((cov.w)&0xffu,(cov.w>>8)&0xffu,(cov.w>>16)&0xffu,(cov.w>>24)&0xffu)/255.0f;if(px==1){vec3 splat_view=splat_cam.xyz/splat_cam.w;vec3 dir=normalize(splat_view*mat3(u_mvs));color.xyz+=evalSH(p0,p1,p2,p3,dir);}color=modify(color,u_filter);if((u_sltid!=0&&(floatBitsToUint(ct.w)&0xffu)==uint(u_sltid))||u_sltid==-1){if(u_sltc.a==0.0f){return;}color.rgb=mix(color.rgb,u_sltc.rgb,u_sltc.a);}texCoord=vec3(position.xy,clamp(splat_proj.z,50.0f,1000.0f));vec2 vct=vec2(splat_proj)/splat_proj.w;gl_Position=vec4((vct+position.x*v1/viewport+position.y*v2/viewport)*splat_proj.w,splat_proj.z,splat_proj.w);vec3 smallAxis=M[0]/max(0.001,scale.x);if(scale.y<scale.x&&scale.y<scale.z){smallAxis=M[1]/max(0.001,scale.y);}else if(scale.z<scale.x&&scale.z<scale.y){smallAxis=M[2]/max(0.001,scale.z);}vec3 normal=(u_normalMatrix*smallAxis);vec3 localNormal=mat3(u_view)*normal;float negMask=dot(localNormal,-splat_cam.xyz)<0.0f ?-1.0f : 1.0f;if(negMask<0.0f){localNormal=-localNormal;}float localDistance=abs(dot(localNormal.xyz,splat_cam.xyz));allMap=vec4(localNormal,localDistance);vPosition=ct.xyz;}",fragmentShaderSource:this.hn?"#version 300 es\nprecision highp int;precision highp float;in vec4 color;in vec3 texCoord;in vec4 allMap;in vec3 vPosition;in float maxScale;layout(location=0)out vec4 out_FragColor;layout(location=1)out vec4 fragNormal;layout(location=2)out vec4 fragDistance;layout(location=3)out vec4 position;void main(){float A=dot(texCoord.xy,texCoord.xy);if(A>1.0){discard;}float B=exp(-A*4.0)*color.a;out_FragColor=vec4(color.xyz,B);fragNormal=vec4(allMap.xyz,B);fragDistance=vec4(allMap.w,0,0,B);position=vec4(vPosition,1);}":"#version 300 es\nprecision highp int;precision highp float;in vec4 color;in vec3 texCoord;layout(location=0)out vec4 out_FragColor;void main(){float A=dot(texCoord.xy,texCoord.xy);if(A>1.0f){discard;}float B=exp(-A*4.0)*color.a;if(B<0.0001*texCoord.z)discard;out_FragColor=vec4(color.xyz,B);}",attributeLocations:{position:0,pIdx:1}}),this.fn=i.RenderState.fromCache({depthTest:{enabled:!1,func:i.DepthFunction.ALWAYS},depthMask:!1,blending:{enabled:!0,equationRgb:i.BlendEquation.ADD,equationAlpha:i.BlendEquation.ADD,functionSourceRgb:i.BlendFunction.SOURCE_ALPHA,functionDestinationRgb:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:i.BlendFunction.ONE,functionDestinationAlpha:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA}}),this.dn={index:0,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0]),context:this.ce}),componentsPerAttribute:3,componentDatatype:i.ComponentDatatype.FLOAT},this.vn=this.En(this._scene.context),this.Mn(),this.Cn(),this.An()}_destroy(){this._scene.primitives.remove(this.yn),this.yn=void 0,this.pn.forEach((t=>{t.destroy()})),this.pn=[]}On(t){if(!t)return void(this._modelMatrix=null);const e=i.Cartesian3.fromDegrees(t[0],t[1],t[2]),n=i.Transforms.eastNorthUpToFixedFrame(e);this._modelMatrix=n}In(t){this.Sn=t,this.pn.forEach((e=>{e.setBoundingVolume(t)}))}Tn(t){this.xn=t}zn(t){this._n=t}En(t){const e=new Uint8Array([255,255,255,255]);return new i.Texture({context:t,source:{width:1,height:1,arrayBufferView:e},pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.UNSIGNED_BYTE})}Cn(){this.nn=new i.ClearCommand({framebuffer:this.wn,color:new i.Color(0,0,0,0),depth:1,stencil:0,pass:i.Pass.GLOBE}),this.nn.Rn="clearCommand";const t=new i.VertexArray({name:"gaussian",context:this.ce,attributes:[{index:0,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:new Float32Array([-1,-1,-1,1,1,1,-1,-1,1,1,1,-1]),context:this.ce}),componentsPerAttribute:2,componentDatatype:i.ComponentDatatype.FLOAT}]}),e="#version 300 es\n            precision mediump float;\n            precision mediump int;\n            in vec2 position;\n            out vec2 vTextCoord;\n            out vec2 vFocal;\n            uniform vec2 fov;\n            uniform vec2 viewport;\n\n            void main() {\n                float xFov = fov.x;\n                float yFov = fov.y;\n                vFocal = vec2( \n                    viewport.x / (2.0 * tan(xFov / 2.0)),\n                    viewport.y / (2.0 * tan(yFov / 2.0))\n                );\n                vTextCoord = (position + 1.0) / 2.0;\n                gl_Position = vec4(position, 0, 1);\n            }\n        ",n=i.ShaderProgram.fromCache({context:this._scene.context,vertexShaderSource1:e,vertexShaderSource:new i.ShaderSource({sources:[e]}),fragmentShaderSource:new i.ShaderSource({defines:["LOG_DEPTH_READ_ONLY"],sources:["#version 300 es\n            precision mediump float;\n            precision mediump int;\n            in vec2 vTextCoord;\n            in vec2 vFocal;\n            uniform sampler2D colorTexture;\n            uniform sampler2D normalTexture;\n            uniform sampler2D distanceTexture;\n            uniform sampler2D positionTexture;\n\n            uniform mat4 projectMatrix;\n            uniform mat4 u_view;\n            uniform vec3 u_cameraPos;\n            uniform mat4 u_model;\n            uniform vec4 u_color;\n\n            // \n            const float PI = 3.14159265359;\n            uniform vec3 u_ambientColor; // \n            uniform vec3 u_lightColor;  // \n            uniform vec3 u_lightDirection;\n            uniform float u_lightIntensity;\n            uniform float u_roughness;\n            uniform float u_metallic;\n\n            // uniform vec3 u_specularColor;  // \n            // uniform float u_shininess;\n            uniform vec2 fov;\n\n            // GGX\n            float D_GGX(float NdotH, float roughness) {\n                float a = roughness * roughness;\n                float a2 = a * a;\n                float denom = (NdotH * NdotH * (a2 - 1.0) + 1.0);\n                return a2 / (PI * denom * denom);\n            }\n\n            // Schlick-GGX\n            float G_SchlickGGX(float NdotV, float roughness) {\n                float r = roughness + 1.0;\n                float k = (r * r) / 8.0;\n                return NdotV / (NdotV * (1.0 - k) + k);\n            }\n\n            // Schlick\n            vec3 F_Schlick(float HdotV, vec3 F0) {\n                return F0 + (1.0 - F0) * pow(1.0 - HdotV, 5.0);\n            }\n\n            \n            void main() {\n                ivec2 size = textureSize(colorTexture, 0);\n                ivec2 texelCoord = ivec2(vTextCoord * vec2(size));\n                out_FragColor = texture(colorTexture, vTextCoord);\n                vec3 normal = texelFetch(normalTexture, texelCoord, 0).xyz;\n                float localDistance = texelFetch(distanceTexture, texelCoord, 0).r;\n                vec3 position = texelFetch(positionTexture, texelCoord, 0).rgb;\n\n                if(u_color.a > 0.0) {\n                    out_FragColor = u_color;\n                }\n\n                vec3 realNormal = inverse(mat3(u_model)) * inverse(mat3(u_view)) * normal;\n                // if(out_FragColor.a > 0.01) {\n                vec2 viewport = vec2(size);\n                vec2 pixf = vec2(vTextCoord.x, 1.0 - vTextCoord.y) * viewport;\n                vec2 ray = (pixf.xy - viewport / 2.0) / vFocal;\n\n                normal.x *= -1.0;\n                // float depth = localDistance / abs(dot(normal.xyz, vec3(ray, 1)) + 1.0e-8);\n                // vec4 ndcDepth = projectMatrix * vec4(0, 0, -depth, 1);\n                \n                // float vDepth = (ndcDepth.w - czm_currentFrustum.x) + 1.0;\n                // if (vDepth <= 0.9999999 || vDepth > czm_farDepthFromNearPlusOne) {\n                //     discard;\n                // }\n                // gl_FragDepth = log2(vDepth) * czm_oneOverLog2FarDepthFromNearPlusOne;\n\n\n\n\n\n                // \n                // \n                // \n                vec3 N = normalize(realNormal);\n                // 0.04Albedo\n                vec3 albedo = vec3(0.7);\n                vec3 F0 = mix(vec3(0.04), albedo, u_metallic);\n                // \n                vec3 V = normalize(position - u_cameraPos);  // \n                vec3 L = normalize(u_lightDirection); // normalize(uLightPos - position);   // \n                vec3 H = normalize(V + L);                   // \n            \n                // \n                float NdotV = max(dot(N, V), 0.001);\n                float NdotL = max(dot(N, L), 0.001);\n                float NdotH = max(dot(N, H), 0.00);\n                float HdotV = max(dot(H, V), 0.00);\n            \n                // BRDF\n                float D = D_GGX(NdotH, u_roughness);          // \n                float G = G_SchlickGGX(NdotV, u_roughness) * G_SchlickGGX(NdotL, u_roughness); // \n                vec3 F = F_Schlick(HdotV, F0);\n\n                // \n                vec3 numerator = D * G * F;\n                float denominator = 4.0 * NdotV * NdotL;\n                vec3 specular = numerator / max(denominator, 0.001);\n            \n                // \n                vec3 kD = (1.0 - F) * (1.0 - u_metallic);\n                // vec3 kD = mix(1.0 - F, vec3(1.0), u_metallic) * (1.0 - u_metallic);\n\n                vec3 diffuse = kD * albedo / PI;\n                diffuse = max(diffuse, vec3(0.0)); // \n            \n                // \n                vec3 radiance = u_lightColor * NdotL * u_lightIntensity;\n                vec3 lightC = (diffuse + specular) * radiance;\n\n\n                // // \n                // vec3 viewDirection = normalize(u_cameraPos - position);\n                // vec3 diffuseTerm = u_lightColor * max(dot(realNormal, normalize(-u_lightDirection)), 0.0) * u_lightIntensity;\n\n                // // \n                // // vec3 halfwayVector = normalize(-u_lightDirection + viewDirection);\n                // // float specularFactor = pow(max(dot(realNormal, halfwayVector), 0.0), u_shininess);\n                // // vec3 specularTerm = u_specularColor * specularFactor;\n\n                // // \n                // vec3 totalLighting = u_ambientColor + diffuseTerm;\n\n                // \n                out_FragColor.rgb *= (lightC + u_ambientColor); //totalLighting;\n                // out_FragColor.rgb = realNormal;\n            }\n        "]}),attributeLocations:{position:0}});n.Fn=!0,this.tn=new i.DrawCommand({vertexArray:t,shaderProgram:n,renderState:i.RenderState.fromCache({depthMask:!1,depthTest:{enabled:!1},blending:{enabled:!0,equationRgb:i.BlendEquation.ADD,equationAlpha:i.BlendEquation.ADD,functionSourceRgb:i.BlendFunction.SOURCE_ALPHA,functionDestinationRgb:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:i.BlendFunction.ONE,functionDestinationAlpha:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA}}),uniformMap:{colorTexture:()=>this.Kt[0],normalTexture:()=>this.Kt[1],distanceTexture:()=>this.Kt[2],positionTexture:()=>this.Kt[3],projectMatrix:()=>this._scene.camera.frustum.projectionMatrix,u_cameraPos:()=>new i.Cartesian3(this._scene.camera.positionWC.x-this.pn[0].We._modelMatrix[12],this._scene.camera.positionWC.y-this.pn[0].We._modelMatrix[13],this._scene.camera.positionWC.z-this.pn[0].We._modelMatrix[14]),u_model:()=>this.pn[0].We._modelMatrix,u_color:()=>this.$n,u_view:()=>{const t=new i.Matrix4;i.Matrix4.multiply(this._scene.camera.viewMatrix,this.pn[0].We._modelMatrix,t);const e=new i.Matrix4;return this._scene.camera.viewMatrix.clone(e),e[12]=t[12],e[13]=t[13],e[14]=t[14],e},fov:()=>new i.Cartesian2(this._scene.camera.frustum.fov,this._scene.camera.frustum.fovy),viewport:()=>new i.Cartesian2(this._scene.context.drawingBufferWidth,this._scene.context.drawingBufferHeight),u_ambientColor:()=>this.xn&&this.xn.enable?this.xn.ambientColor:new i.Cartesian3(1,1,1),u_lightColor:()=>this.xn&&this.xn.enable?this.xn.lightColor:new i.Cartesian3(1,1,1),u_lightDirection:()=>this.xn&&this.xn.enable?this.xn.lightDirection:new i.Cartesian3(0,0,1),u_lightIntensity:()=>this.xn&&this.xn.enable?this.xn.lightIntensity:0,u_metallic:()=>this.xn&&this._n&&this.xn.enable?this._n.metallic:0,u_roughness:()=>this.xn&&this._n&&this.xn.enable?this._n.roughness:1},pass:this.gn||i.Pass.GLOBE}),this.tn.Rn="color_gaussian_fullScreen";const r=i.ShaderProgram.fromCache({context:this._scene.context,vertexShaderSource:new i.ShaderSource({sources:[e]}),fragmentShaderSource:new i.ShaderSource({defines:["LOG_DEPTH_READ_ONLY"],sources:["#version 300 es\n        precision mediump float;\n        precision mediump int;\n        in vec2 vTextCoord;\n        in vec2 vFocal;\n        uniform sampler2D normalTexture;\n        uniform sampler2D distanceTexture;\n\n        uniform mat4 projectMatrix;\n        uniform mat4 u_view;\n        uniform mat4 u_model;\n        \n        void main() {\n            ivec2 size = textureSize(normalTexture, 0);\n            ivec2 texelCoord = ivec2(vTextCoord * vec2(size));\n            vec3 normal = texelFetch(normalTexture, texelCoord, 0).xyz;\n            float localDistance = texelFetch(distanceTexture, texelCoord, 0).r;\n\n            vec3 realNormal = inverse(mat3(u_model)) * inverse(mat3(u_view)) * normal;\n            vec2 viewport = vec2(size);\n            vec2 pixf = vec2(vTextCoord.x, 1.0 - vTextCoord.y) * viewport;\n            vec2 ray = (pixf.xy - viewport / 2.0) / vFocal;\n\n            normal.x *= -1.0;\n            float depth = localDistance / abs(dot(normal.xyz, vec3(ray, 1)) + 1.0e-8);\n            vec4 ndcDepth = projectMatrix * vec4(0, 0, -depth, 1);\n            \n            float vDepth = (ndcDepth.w - czm_currentFrustum.x) + 1.0;\n            if (vDepth <= 0.9999999 || vDepth > czm_farDepthFromNearPlusOne) {\n                discard;\n            }\n            gl_FragDepth = log2(vDepth) * czm_oneOverLog2FarDepthFromNearPlusOne;\n            out_FragColor = vec4(vec3(vDepth), 0);\n        }"]}),attributeLocations:{position:0}});this.en=new i.DrawCommand({vertexArray:t,shaderProgram:r,renderState:i.RenderState.fromCache({depthMask:!0,depthTest:{enabled:!0},colorMask:{red:!1,green:!1,blue:!1,alpha:!1}}),uniformMap:{normalTexture:()=>this.Kt[1],distanceTexture:()=>this.Kt[2],projectMatrix:()=>this._scene.camera.frustum.projectionMatrix,u_model:()=>this.pn[0].We._modelMatrix,u_view:()=>{const t=new i.Matrix4;i.Matrix4.multiply(this._scene.camera.viewMatrix,this.pn[0].We._modelMatrix,t);const e=new i.Matrix4;return this._scene.camera.viewMatrix.clone(e),e[12]=t[12],e[13]=t[13],e[14]=t[14],e},fov:()=>new i.Cartesian2(this._scene.camera.frustum.fov,this._scene.camera.frustum.fovy),viewport:()=>new i.Cartesian2(this._scene.context.drawingBufferWidth,this._scene.context.drawingBufferHeight)},pass:i.Pass.GLOBE}),this.en.Rn="depth_gaussian_fullScreen"}Mn(){const{drawingBufferWidth:t,drawingBufferHeight:e}=this._scene.context,n=Math.floor(t/1),r=Math.floor(e/1),o=new i.Texture({context:this._scene.context,width:n,height:r,pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.HALF_FLOAT}),s=new i.Texture({context:this._scene.context,width:n,height:r,pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.HALF_FLOAT}),a=new i.Texture({context:this._scene.context,width:n,height:r,pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.HALF_FLOAT}),u=new i.Texture({context:this._scene.context,width:n,height:r,pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.HALF_FLOAT});this.Kt=[o,s,a,u],this.wn&&this.wn.destroy(),this.wn=new i.Framebuffer({context:this._scene.context,colorTextures:this.hn?this.Kt:[this.Kt[0]]}),this.wn.Dn=[t,e]}An(){const{drawingBufferWidth:t,drawingBufferHeight:e}=this._scene.context;this.pn.length>0&&(this.wn.Dn[0]===t/1&&this.wn.Dn[1]===e/1||(this.Mn(),this.pn[0].Ze.framebuffer=this.wn,this.pn[0].nn.framebuffer=this.wn))}Pn(){this.An()}Nn(){this.rn=!1,this.yn.show=!1}_show(){this.rn=!0,this.yn.show=!0}Un(){}qn(t,e){if(e){const n=e.getAttribute(1).vertexBuffer;n.sizeInBytes<t.byteLength?(n.destroy(),e=new i.VertexArray({name:"gaussian",context:this.ce,attributes:[this.dn,{name:"pIdx",index:1,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:t,context:this.ce}),componentsPerAttribute:1,componentDatatype:i.ComponentDatatype.FLOAT,instanceDivisor:1}]})):n?.copyFromArrayView(t)}else e=new i.VertexArray({name:"gaussian",context:this.ce,attributes:[this.dn,{name:"pIdx",index:1,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:t,context:this.ce}),componentsPerAttribute:1,componentDatatype:i.ComponentDatatype.FLOAT,instanceDivisor:1}]});return e}jn(t){if(!window.stopUpdate&&this.yn)if(t&&t.oe){this.yn.We=t,this.kn||this.emit("renderfirstframe",null),this.kn=!0;for(let e=0;e<1;e+=1){let n=t;if(this.pn[e]){const t=this.qn(n.Zt,this.pn[e].Ze.vertexArray);this.pn[e].Ze.vertexArray=t,this.pn[e].Ze.instanceCount=n.oe,this.pn[e].We=n}else{this.pn[e]=new Al(n,e,this);const r={viewport:()=>new i.Cartesian2(this._scene.canvas.width,this._scene.canvas.height),u_filter:()=>this.bn,u_cameraPos:()=>new i.Cartesian3(this._scene.camera.positionWC.x-this.pn[e].We._modelMatrix[12],this._scene.camera.positionWC.y-this.pn[e].We._modelMatrix[13],this._scene.camera.positionWC.z-this.pn[e].We._modelMatrix[14]),u_normalMatrix:()=>{let t=this.pn[e].We._modelMatrix,n=i.Matrix4.getMatrix3(t,new i.Matrix3);return i.Matrix3.inverseTranspose(n,n),n},u_modelMatrix:()=>{let t=this.pn[e].We._modelMatrix;return i.Matrix4.getMatrix3(t,new i.Matrix3)},u_view:()=>{const t=new i.Matrix4;i.Matrix4.multiply(this._scene.camera.viewMatrix,this.pn[e].We._modelMatrix,t);const n=new i.Matrix4;return this._scene.camera.viewMatrix.clone(n),n[12]=t[12],n[13]=t[13],n[14]=t[14],n},u_mvs:()=>{const t=new i.Matrix4;return i.Matrix4.multiply(this._scene.camera.viewMatrix,this._modelMatrix||this.pn[e].We._modelMatrix,t),t},u_txts:()=>{const t=this.pn[e].We.Kt,n=new Array(16);return n.fill(this.vn),t.forEach(((t,e)=>{n[e]=t._texture})),n},u_params:()=>new i.Cartesian4(t.qt?1:0,Math.log2(this.jt/2),Math.ceil(Math.log2(this.jt*this.jt)),this.jt),u_sltid:()=>this.pn[e].We.qe||0,u_sltc:()=>this.pn[e].We?.je||i.Color.fromBytes(0,200,255,80)},o=this.qn(n.Zt);this.pn[e].Ze=new i.DrawCommand({vertexArray:o,shaderProgram:this.cn,uniformMap:r,renderState:this.fn,pass:this.gn||i.Pass.GLOBE,instanceCount:n.oe,count:6,framebuffer:this.wn,boundingVolume:this.Sn}),this.pn[e].tn=this.tn,this.pn[e].nn=this.nn,this.pn[e].en=this.en,this.pn[e].Ze.Rn="_drawCmd",this.yn.add(this.pn[e])}this.pn[e].show()}for(let t=1;t<this.pn.length;t+=1)this.pn[t].hide();this._scene.requestRender()}else this.yn&&(this.yn.show=!1)}}class Il{Ln;Ae;We;Be;Re;an;Bn;constructor(t){this.Ln=t.viewer,this.Ae=t.url,this.We=t.data,this.Be=t.deltaCenter,this.Re=t.enuCenter;const e=this.Ln.scene;this.Bn=new Ml({ce:e.context,We:this.We,Be:this.Be,Re:this.Re||[0,0,0]}),this.an=new Ol({hn:!0,scene:e,jt:this.Bn.textureWidth}),this.Bn.afterSort=t=>{this.an.jn(t),this.Ln.scene.requestRender()},e.preRender.addEventListener(((t,e)=>{this.Bn.Ke(t)}),this),this.Ln.scene.requestRender()}selectedEntity(t,e){this.Bn.Ye(+t,e)}hide(){this.an.Nn()}show(){this.an._show()}setData(t,e){this.Bn.updateData(t,e)}destroy(){this.Bn._destroy(),this.an._destroy()}}const Tl=1e-6,zl=[0,0,0],Rl=[0,0,0],Fl=[0,0,0],Dl=[0,0,0],Pl=[0,0,0],Nl=[0,0,0],Ul=[0,0,0],ql=[0,0,0],jl=[0,0,0],Ll=[0,0,0],Bl=[0,0,0],Hl=[0,0],Wl=[0,0,0],Vl=[0,0,0],Gl=[0,0,0],Yl=[0,0,0],Kl=[0,0,0],Xl=[0,0,0];function Ql(t,e,n,i,r,o){if(xc(e)<Tl)return;bc(Wl,n,e),bc(Vl,i,e),bc(Gl,r,e),Jl(t,e,Hl),Kl[1]=Hl[0],Yl[1]=Hl[1],Xl[1]=Yl[1]-Kl[1];const s=[n,i,r],a=[Wl,Vl,Gl];for(let n=0;n<3;++n){Jl(t,s[n],Hl),Kl[0]=Hl[0],Yl[0]=Hl[1],Jl(t,a[n],Hl),Kl[2]=Hl[0],Yl[2]=Hl[1],Xl[0]=Yl[0]-Kl[0],Xl[2]=Yl[2]-Kl[2];const i=vc(Xl);i<o.quality&&(gc(o.b0,s[n]),gc(o.b1,e),gc(o.b2,a[n]),o.quality=i)}}const Zl=[0,0,0];function Jl(t,e,n){const{data:i,offsetIdx:r,strideIdx:o}=t;n[0]=Number.POSITIVE_INFINITY,n[1]=Number.NEGATIVE_INFINITY;for(let t=r;t<i.length;t+=o){const r=i[t]*e[0]+i[t+1]*e[1]+i[t+2]*e[2];n[0]=Math.min(n[0],r),n[1]=Math.max(n[1],r)}}function tc(t,e,n){gc(n.center,t),wc(n.halfSize,e,.5),n.quaternion[0]=0,n.quaternion[1]=0,n.quaternion[2]=0,n.quaternion[3]=1}const ec=[0,0,0],nc=[0,0,0],ic=[0,0,0],rc=[0,0,0],oc=[0,0,0],sc=[0,0,0];function ac(t,e,n){gc(ec,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?ec[0]=0:Math.abs(e[1])>Math.abs(e[2])?ec[1]=0:ec[2]=0,xc(ec)<Tl&&(ec[0]=ec[1]=ec[2]=1),bc(nc,e,ec),_c(nc,nc),bc(ic,e,nc),_c(ic,ic),uc(t,e,nc,ic,rc,oc),yc(sc,oc,rc),fc(e,nc,ic,rc,oc,sc,n)}function uc(t,e,n,i,r,o){Jl(t,e,Hl),r[0]=Hl[0],o[0]=Hl[1],Jl(t,n,Hl),r[1]=Hl[0],o[1]=Hl[1],Jl(t,i,Hl),r[2]=Hl[0],o[2]=Hl[1]}const hc=[0,0,0],lc=[1,0,0,0,1,0,0,0,1],cc=[0,0,0];function fc(t,e,n,i,r,o,s){lc[0]=t[0],lc[1]=t[1],lc[2]=t[2],lc[3]=e[0],lc[4]=e[1],lc[5]=e[2],lc[6]=n[0],lc[7]=n[1],lc[8]=n[2],function(t,e){const n=e[0]+e[4]+e[8];if(n>0){let i=Math.sqrt(n+1);t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i}else{let n=0;e[4]>e[0]&&(n=1),e[8]>e[3*n+n]&&(n=2);const i=(n+1)%3,r=(n+2)%3;let o=Math.sqrt(e[3*n+n]-e[3*i+i]-e[3*r+r]+1);t[n]=.5*o,o=.5/o,t[3]=(e[3*i+r]-e[3*r+i])*o,t[i]=(e[3*i+n]+e[3*n+i])*o,t[r]=(e[3*r+n]+e[3*n+r])*o}}(s.quaternion,lc),mc(cc,i,r),wc(cc,cc,.5),wc(s.center,t,cc[0]),wc(hc,e,cc[1]),mc(s.center,s.center,hc),wc(hc,n,cc[2]),mc(s.center,s.center,hc),wc(s.halfSize,o,.5)}class dc{buffer;minProj;maxProj;minVert=new Array(7);maxVert=new Array(7);constructor(t){this.buffer=new ArrayBuffer(448);let e=0;this.minProj=new Float64Array(this.buffer,e,7),e+=56,this.maxProj=new Float64Array(this.buffer,e,7),e+=56;for(let t=0;t<7;++t)this.minVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.maxVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.minProj[t]=Number.POSITIVE_INFINITY,this.maxProj[t]=Number.NEGATIVE_INFINITY;const n=new Array(7),i=new Array(7),{data:r,offsetIdx:o,strideIdx:s}=t;for(let t=o;t<r.length;t+=s){let e=r[t];e<this.minProj[0]&&(this.minProj[0]=e,n[0]=t),e>this.maxProj[0]&&(this.maxProj[0]=e,i[0]=t),e=r[t+1],e<this.minProj[1]&&(this.minProj[1]=e,n[1]=t),e>this.maxProj[1]&&(this.maxProj[1]=e,i[1]=t),e=r[t+2],e<this.minProj[2]&&(this.minProj[2]=e,n[2]=t),e>this.maxProj[2]&&(this.maxProj[2]=e,i[2]=t),e=r[t]+r[t+1]+r[t+2],e<this.minProj[3]&&(this.minProj[3]=e,n[3]=t),e>this.maxProj[3]&&(this.maxProj[3]=e,i[3]=t),e=r[t]+r[t+1]-r[t+2],e<this.minProj[4]&&(this.minProj[4]=e,n[4]=t),e>this.maxProj[4]&&(this.maxProj[4]=e,i[4]=t),e=r[t]-r[t+1]+r[t+2],e<this.minProj[5]&&(this.minProj[5]=e,n[5]=t),e>this.maxProj[5]&&(this.maxProj[5]=e,i[5]=t),e=r[t]-r[t+1]-r[t+2],e<this.minProj[6]&&(this.minProj[6]=e,n[6]=t),e>this.maxProj[6]&&(this.maxProj[6]=e,i[6]=t)}for(let t=0;t<7;++t){let e=n[t];gc(this.minVert[t],r,e),e=i[t],gc(this.maxVert[t],r,e)}}}class pc{b0=[1,0,0];b1=[0,1,0];b2=[0,0,1];quality=0}function vc(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function mc(t,e,n){t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2]}function yc(t,e,n){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}function wc(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}function gc(t,e,n=0){t[0]=e[n+0],t[1]=e[n+1],t[2]=e[n+2]}function bc(t,e,n){const i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],u=n[2];t[0]=r*u-o*a,t[1]=o*s-i*u,t[2]=i*a-r*s}function _c(t,e){const n=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(n>0){const i=1/Math.sqrt(n);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}}function xc(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function kc(t,e){const n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return n*n+i*i+r*r}function $c(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}const Sc=(t,e)=>{const n=10**e;return Math.round(t*n)/n},Ec=(t,e,n=!1)=>{const i=t[0],r=t[1];let o,s,a,u,h=!1;const l=e.length;for(let t=0,c=l-1;t<l;c=t,t+=1){let l=!1;if(o=e[t][0],s=e[t][1],a=e[c][0],u=e[c][1],o===i&&s===r||a===i&&u===r)return!!n;if(s<r==u>=r){const t=(a-o)*(r-s)/(u-s)+o;if(i===t)return!!n;l=i<t}l&&(h=!h)}return h},Mc=(t,e)=>{var n=e[0],r=e[1],o=e[2],s=t[0],a=t[1],u=t[2];const h=i.Cartesian3.fromDegrees(s,a,u),l=i.Cartesian3.fromDegrees(n,r,o),c=i.Transforms.eastNorthUpToFixedFrame(l);var f=i.Matrix4.inverse(c,new i.Matrix4);return i.Matrix4.multiplyByPoint(f,h,new i.Cartesian3)},Cc=new i.Matrix4,Ac=new i.Matrix4,Oc=new i.Cartesian3;function Ic(t,e,n){const[r,o,s]=e;return i.Cartesian3.fromDegrees(r,o,s,void 0,Oc),i.Transforms.eastNorthUpToFixedFrame(Oc,void 0,Ac),i.Matrix4.inverseTransformation(Ac,Cc),i.Matrix4.multiplyByPoint(Cc,t,n||new i.Cartesian3)}function Tc(t,e,n,r){const o=zc(t,e,n,r),s=i.Cartographic.fromCartesian(o);return[s.longitude,s.latitude,s.height]}function zc(t,e,n,r){if(!n){const[t,r,s]=e;var o=i.Cartesian3.fromDegrees(t,r,s);n=i.Transforms.eastNorthUpToFixedFrame(o)}return i.Matrix4.multiplyByPoint(n,t,r||new i.Cartesian3)}function Rc(t){var e=i.Cartographic.fromCartesian(t);return{lng:i.Math.toDegrees(e.longitude),lat:i.Math.toDegrees(e.latitude),height:e.height}}function Fc(t,e){const n=2*Math.PI;let i=(e=(e%n+n)%n)-(t=(t%n+n)%n);return i>Math.PI?i-=n:i<-Math.PI&&(i+=n),i}var Dc,Pc=new Float32Array(1);function Nc(t){const e=[];for(let n=0,i=t.length;n<i;n+=2)e.push(parseInt(t.substr(n,2),16)/255);return e.push(e.shift()),e}function Uc(t,e){let n,i,r,o,s,a,u,h="ASDFGHJKLQWERTYUIO!sdfghjkleiu3~yr5-P&mq9`%zCN*b=8@^xpVM";for((e=e||"v5")>"v5"?(n=h.length,i=512):(n=27,h=h.substr(0,27),i=333),o=[],s=NaN,a=0,u=t.length;a<u;a++)r=t[a],r=h.indexOf(r),isNaN(s)?s=r*n:(o.push(s+r-i),s=NaN);return o}function qc(t){if(t.toArray)return t.toArray();{const e=[];let n=t.next();for(;!n.done;)e.push(n.value),n=t.next();return e}}new Int32Array(Pc.buffer);class jc{Hn;Wn;ce;Vn;Gn;Yn=[];Kn=-1;Xn="close";Qn={};Zn=0;Jn;ti;ei;ni;ii;ri;oi;si=[0,0];ai=[];ui=[1/0,1/0,1/0,-1/0,-1/0,-1/0];options={layer:void 0,inPointStyle:{color:"rgba(37,165,247,1)",radius:6,borderWidth:4,borderColor:"rgba(255,255,255,1)"},outPointStyle:{color:"rgba(247,55,37,1)",radius:6,borderWidth:4,borderColor:"rgba(255,255,255,1)"},polygonStyle:{color:"rgba(0,255,255,0.6)",borderWidth:4,borderColor:"rgba(255,255,255,1)"},model:{encoderUrl:"",decoderUrl:"",name:"model",wasmPaths:""}};constructor(t){t.viewer&&(this.Hn=t.viewer.container,this.options.inPointStyle=Object.assign(this.options.inPointStyle,t.inPointStyle),this.options.outPointStyle=Object.assign(this.options.outPointStyle,t.outPointStyle),this.options.polygonStyle=Object.assign(this.options.polygonStyle,t.polygonStyle),this.options.model=Object.assign(this.options.model,t.model),this.options.viewer=t.viewer,this.options.layer=t.layer,this.options.layer&&(this.hi(),this.li()))}show(){this.Wn.style.visibility="visible",this.Vn.style.visibility="visible"}hide(){this.Wn.style.visibility="hidden",this.Vn.style.visibility="hidden"}open(){this.Xn="open",this.Wn.style.visibility="visible",this.Vn.style.visibility="visible",this.Wn.style.pointerEvents="all",this.Wn.addEventListener("mousedown",this.ci),this.Wn.addEventListener("mouseup",this.fi),this.Hn.addEventListener("contextmenu",this.ci)}createMask(){"open"!==this.Xn&&"adding"!==this.Xn||(this.Xn="adding",this.Gn.clearRect(0,0,this.Vn.width,this.Vn.height),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Wn.style.pointerEvents=this.Vn.style.pointerEvents="all",this.Kn++,this.Yn[this.Kn]=[])}async embeddings(){await this.di(),void 0===this.ei&&await this.Jn,this.oi=await this.ei}maskCompleted(){this.Gn.clearRect(0,0,this.Vn.width,this.Vn.height),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Wn.style.pointerEvents=this.Vn.style.pointerEvents="none",this.pi()}highLight(t){if(!this.options.viewer)return;if(!this.ii||0===this.ii.length)return;let e=0;for(let t=0;t<this.ii.length;t++){const{centers:n,rgbas:i,sigmas:r}=this.ii[t];n&&i&&r&&(e+=n.byteLength/3*8)}const n=new ArrayBuffer(e),i=new DataView(n);let r=0;const o=[0,0,0];for(let t=0;t<this.ii.length;t++){const{centers:e,rgbas:n,sigmas:s,modelMatrix:a,count:u,indices:h}=this.ii[t];if(0===t&&(o[0]=a[12],o[1]=a[13],o[2]=a[14]),e&&n&&s){const t=new Float32Array(e),o=new Uint8Array(n),a=new Uint32Array(s);for(let e=0;e<t.length/3;e++){const n=r+e,s=t[3*e],u=t[3*e+1],h=t[3*e+2];this.ui[0]=Math.min(s,this.ui[0]),this.ui[1]=Math.min(u,this.ui[1]),this.ui[2]=Math.min(h,this.ui[2]),this.ui[3]=Math.max(s,this.ui[3]),this.ui[4]=Math.max(u,this.ui[4]),this.ui[5]=Math.max(h,this.ui[5]);const l=o[4*e],c=o[4*e+1],f=o[4*e+2],d=o[4*e+3],p=32*n;i.setFloat32(p,s,!0),i.setFloat32(p+4,u,!0),i.setFloat32(p+8,h,!0),i.setUint8(p+12,1),i.setUint8(p+15,1),i.setUint32(p+16,a[3*e],!0),i.setUint32(p+20,a[3*e+1],!0),i.setUint32(p+24,a[3*e+2],!0),i.setUint8(p+28,l),i.setUint8(p+29,c),i.setUint8(p+30,f),i.setUint8(p+31,d)}r+=u||0}}this.ri=new Il({viewer:this.options.viewer,deltaCenter:o,enuCenter:this.options.layer?.getEnuCenter(),data:n}),this.ri.selectedEntity(-1,t)}cancelMask(){this.Xn="open",this.Zn=0,this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Yn[this.Kn]=[],this.Kn--}close(){this.Xn="close",this.Zn=0,this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Gn.clearRect(0,0,this.Vn.width,this.Vn.height),this.Yn=[],this.ui=[1/0,1/0,1/0,-1/0,-1/0,-1/0],this.Kn=-1,this.Wn.style.visibility=this.Vn.style.visibility="hidden",this.Wn.style.pointerEvents=this.Vn.style.pointerEvents="none",this.Hn.removeEventListener("contextmenu",this.ci),this.Wn.removeEventListener("mousedown",this.ci),this.Wn.removeEventListener("mouseup",this.fi)}removePoint(){"adding"===this.Xn&&this.Yn[this.Kn].length>0&&(this.Yn[this.Kn].pop(),this.mi(),this.yi())}getSingleData(){return this.ii}getSingleModel(){return this.ri}lock(){this.Xn="locking",this.Wn.style.pointerEvents="all";var t=this.options.viewer.scene.screenSpaceCameraController;this.Qn={enableTranslate:t.enableTranslate,enableZoom:t.enableZoom,enableRotate:t.enableRotate,enableTilt:t.enableTilt,enableLook:t.enableLook,inertiaSpin:t.inertiaSpin,inertiaTranslate:t.inertiaTranslate,inertiaZoom:t.inertiaZoom},t.enableTranslate=!1,t.enableZoom=!1,t.enableRotate=!1,t.enableTilt=!1,t.enableLook=!1,t.inertiaSpin=0,t.inertiaTranslate=0,t.inertiaZoom=0}unlock(){this.Xn="open",this.Wn.style.pointerEvents="none";var t=this.options.viewer.scene.screenSpaceCameraController;t.enableTranslate=this.Qn.enableTranslate,t.enableZoom=this.Qn.enableZoom,t.enableRotate=this.Qn.enableRotate,t.enableTilt=this.Qn.enableTilt,t.enableLook=this.Qn.enableLook,t.inertiaSpin=this.Qn.inertiaSpin,t.inertiaTranslate=this.Qn.inertiaTranslate,t.inertiaZoom=this.Qn.inertiaZoom}wi(t){const e=this.options.layer?.getEnuCenter();if(!e)return;const n=[];for(let r=0;r<t.length;r++){const{rotation:o,scale:s,center:a}=t[r],u=new i.Cartesian3(2*s[0],2*s[1],2*s[2]),h=zc(new i.Cartesian3(a[0],a[1],a[2]),e),l=new i.HeadingPitchRoll(o[0],o[1],o[2]),c=i.Transforms.headingPitchRollQuaternion(h,l),f=this.options.viewer?.entities.add({name:"single boxs",position:h,orientation:c,box:{dimensions:u,material:new i.Color(1,0,1,1),outline:!0,outlineWidth:5}});n.push(f)}return n}hi(){const t=document.createElement("canvas"),e=document.createElement("canvas"),n=this.Hn?.getBoundingClientRect();n&&(t.width=e.width=n.width*window.devicePixelRatio,t.height=e.height=n.height*window.devicePixelRatio,t.style.cssText=e.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            pointer-events: none;\n        ",this.Hn.appendChild(e),this.Hn.appendChild(t),this.Wn=t,this.Vn=e,this.ce=t.getContext("2d")||void 0,this.Gn=e.getContext("2d")||void 0,this.An())}async yi(){const t=[],e=[];this.Yn[this.Kn].forEach((n=>{e.push(n.isIn?1:0),t.push(...n.point)})),0!==e.length&&(await this.gi(t,e),await this.bi())}async li(){const t=this.options.model;vl.env.wasm.wasmPaths=t.wasmPaths||"../../onnx/",vl.env.wasm.numThreads=10;const e=await caches.open("onnx");await e.match(t.encoderUrl),await e.match(t.decoderUrl);const n={executionProviders:["webgpu"],enableMemPattern:!1,enableCpuMemArena:!1,extra:{session:{disable_prepacking:"1",use_device_allocator_for_initializers:"1",use_ort_model_bytes_directly:"1",use_ort_model_bytes_for_initializers:"1"}}},i=await this._i(t.encoderUrl),r=await this._i(t.decoderUrl);this.Jn=await vl.InferenceSession.create(i,n),this.ti=await vl.InferenceSession.create(r,n)}async _i(t){try{const e=await caches.open("onnx");let n=await e.match(t);if(null==n&&(await e.add(t),n=await e.match(t)),n)return await n.arrayBuffer()}catch(e){return await fetch(t).then((t=>t.arrayBuffer()))}}async gi(t,e){if(t.length>0){const n=this.ti,i=this.xi(t,e),r=(await n.run(i)).masks;this.ni=r.toImageData()}}xi(t,e){const n=new vl.Tensor(new Float32Array(65536),[1,1,256,256]),i=new vl.Tensor(new Float32Array([0]),[1]),r=new vl.Tensor(new Float32Array([1024,1024]),[2]),o=new vl.Tensor(new Float32Array(t),[1,t.length/2,2]),s=new vl.Tensor(new Float32Array(e),[1,e.length]);return{image_embeddings:new vl.Tensor(this.oi.image_embeddings.type,Float32Array.from(this.oi.image_embeddings.data),this.oi.image_embeddings.dims),point_coords:o,point_labels:s,mask_input:n,has_mask_input:i,orig_im_size:r}}async di(){this.ei=void 0;const t=document.createElement("canvas");t.width=1024,t.height=1024;const e=t.getContext("2d");if(e&&this.options.viewer?.canvas){e.drawImage(this.options.viewer?.canvas,0,0,t.width,t.height);const n=e.getImageData(0,0,1024,1024),i=await vl.Tensor.fromImage(n,{resizedWidth:1024,resizedHeight:1024}),r=await this.Jn;this.ei=r.run({input_image:i}),this.ei.then((()=>{}))}}fi=t=>{const e=t;if(this.si[0]!==e.clientX||this.si[1]!==e.clientY)return;const n=this.Wn?.getBoundingClientRect();if(n){const t=Math.trunc(e.clientX-n.left)*window.devicePixelRatio,i=Math.trunc(e.clientY-n.top)*window.devicePixelRatio;0===e.button?this.ki([t,i],!0):2===e.button&&this.ki([t,i],!1)}};ci=t=>{const e=t;e.preventDefault(),this.si=[e.clientX,e.clientY]};ki(t,e){void 0===this.Yn[this.Kn]&&(this.Yn[this.Kn]=[]),this.Yn[this.Kn].length>5||("adding"===this.Xn&&this.Yn[this.Kn].push({isIn:e,point:[Math.trunc(t[0]/this.Wn.width*1024),Math.trunc(t[1]/this.Wn.height*1024)]}),this.mi(),this.yi())}mi(){this.ce?.clearRect(0,0,this.Wn.width,this.Wn.height);for(let t=0;t<this.Yn[this.Kn].length;t++){const e=this.Yn[this.Kn][t],n=e.isIn?this.options.inPointStyle:this.options.outPointStyle;this.ce.strokeStyle=n.borderColor,this.ce.lineWidth=n.borderWidth*window.devicePixelRatio,this.ce.fillStyle=n.color,this.ce.beginPath(),this.ce.arc(e.point[0]/1024*this.Wn.width,e.point[1]/1024*this.Wn.height,n.radius*window.devicePixelRatio,0,2*Math.PI,!1),this.ce.closePath(),this.ce.stroke(),this.ce.fill()}}async bi(){const t=this.ni,e=t.data,n=this.options.polygonStyle.color.slice(5,-1).split(",");this.Gn.clearRect(0,0,this.Vn.width,this.Vn.height);for(let t=0;t<e.length;t+=4)0!==e[t]?(e[t]=+n[0],e[t+1]=+n[1],e[t+2]=+n[2],e[t+3]=255*+n[3]):e[t+3]=0;this.Gn.drawImage(await createImageBitmap(t),0,0,this.Vn.width,this.Vn.height)}pi(){if(!this.options.layer)return;const t=this.options.viewer.scene.camera.viewMatrix,e=this.options.viewer.scene.camera.frustum.projectionMatrix,n=new i.Matrix4;i.Matrix4.multiply(e,t,n),this.ai=[];let r=!1;if(this.ii&&0!==this.ii.length||0!==this.Zn||(r=!0,this.ii=this.options.layer.$i().map((t=>({tileNum:t.Si,modelMatrix:t._modelMatrix,centers:t.Vt,rgbas:t.Ei,sigmas:t.Mi,indices:[]})))),this.ii){const{data:t,width:e,height:o}=this.ni,s=[];for(let a=0;a<this.ii.length;a++){const u=this.ii[a];if(u.centers&&u.centers.byteLength>0&&u.rgbas&&u.sigmas){const a=[],h=[];let l=new Uint32Array(u.centers.byteLength/4);const c=[],f=new Float32Array(u.centers),d=new Uint8Array(u.rgbas),p=new Uint32Array(u.sigmas),v=new i.Matrix4;i.Matrix4.multiply(n,u.modelMatrix,v);const m=f.length,y=u.indices;let w=0;for(let n=0;n<m;n++){const s=f[3*n],u=f[3*n+1],m=f[3*n+2],g=new i.Cartesian3(s,u,m);i.Matrix4.multiplyByPoint(v,new i.Cartesian3(s,u,m),g),g.x=Math.trunc((g.x/g.z+1)/2*e),g.y=o-Math.trunc((g.y/g.z+1)/2*o),g.x>0&&g.x<e&&g.y<o&&g.y>0&&t[4*(e*g.y+g.x)+3]>0&&(r?c.push(n):y&&c.push(y[n]),a.push(s,u,m),this.ai.push([s,u,m]),h.push(d[4*n],d[4*n+1],d[4*n+2],d[4*n+3]),l[w]=p[3*n],l[w+1]=p[3*n+1],l[w+2]=p[3*n+2],w+=3)}l=l.slice(0,w),a.length>0&&s.push({centers:new Float32Array(a).buffer,rgbas:new Uint8Array(h).buffer,sigmas:l.buffer,tileNum:u.tileNum,modelMatrix:u.modelMatrix,count:a.length/3,indices:c})}}this.ii=s}}Ci(t){const e={center:new Float64Array([0,0,0]),halfSize:new Float32Array([0,0,0]),quaternion:new Float32Array([0,0,0,1])};return function(t,e){const{data:n,strideIdx:i}=t,r=n.length/i;if(r<=0)return;const o=new dc(t);mc(zl,o.minProj,o.maxProj),wc(zl,zl,.5),yc(Rl,o.maxProj,o.minProj);const s=vc(Rl),a=new pc;a.quality=s,r<14&&(t={data:new Float64Array(o.buffer,112,42),size:3,offsetIdx:0,strideIdx:3});const u=[0,0,0],h=[0,0,0],l=[0,0,0],c=[0,0,0],f=[0,0,0],d=[0,0,0],p=[0,0,0];switch(function(t,e,n,i,r,o,s,a,u,h){if(function(t,e,n){let i=kc(t.maxVert[0],t.minVert[0]),r=0;for(let e=1;e<7;++e){const n=kc(t.maxVert[e],t.minVert[e]);n>i&&(i=n,r=e)}gc(e,t.minVert[r]),gc(n,t.maxVert[r])}(t,i,r),kc(i,r)<Tl)return 1;yc(s,i,r),_c(s,s);const l=function(t,e,n,i){const{data:r,offsetIdx:o,strideIdx:s}=t;let a=Number.NEGATIVE_INFINITY,u=0;for(let t=o;t<r.length;t+=s){Bl[0]=r[t]-e[0],Bl[1]=r[t+1]-e[1],Bl[2]=r[t+2]-e[2];const i=n[0]*Bl[0]+n[1]*Bl[1]+n[2]*Bl[2],o=n[0]*n[0]+n[1]*n[1]+n[2]*n[2],s=Bl[0]*Bl[0]+Bl[1]*Bl[1]+Bl[2]*Bl[2]-i*i/o;s>a&&(a=s,u=t)}return gc(i,r,u),a}(e,i,s,o);return l<Tl?2:(yc(a,r,o),_c(a,a),yc(u,o,i),_c(u,u),bc(n,a,s),_c(n,n),Ql(e,n,s,a,u,h),0)}(o,t,p,u,h,l,c,f,d,a)){case 1:return void tc(zl,Rl,e);case 2:return void ac(t,c,e)}!function(t,e,n,i,r,o,s,a,u){(function(t,e,n,i,r,o,s){!function(t,e,n,i,r){const{data:o,offsetIdx:s,strideIdx:a}=t;gc(i,o,s),gc(r,i),n[0]=$c(Zl,e),n[1]=n[0];for(let t=s+a;t<o.length;t+=a){const s=o[t]*e[0]+o[t+1]*e[1]+o[t+2]*e[2];s<n[0]&&(n[0]=s,gc(i,o,t)),s>n[1]&&(n[1]=s,gc(r,o,t))}}(t,e,Hl,s,o);const a=$c(n,e);Hl[1]-Tl<=a&&(o[0]=-1/0),Hl[0]+Tl>=a&&(s[0]=-1/0)})(t,e,n,0,0,Fl,Dl),void 0!==Fl[0]&&(yc(Pl,Fl,n),_c(Pl,Pl),yc(Nl,Fl,i),_c(Nl,Nl),yc(Ul,Fl,r),_c(Ul,Ul),bc(ql,Nl,o),_c(ql,ql),bc(jl,Ul,s),_c(jl,jl),bc(Ll,Pl,a),_c(Ll,Ll),Ql(t,ql,o,Nl,Pl,u),Ql(t,jl,s,Ul,Nl,u),Ql(t,Ll,a,Pl,Ul,u)),void 0!==Dl[0]&&(yc(Pl,Dl,n),_c(Pl,Pl),yc(Nl,Dl,i),_c(Nl,Nl),yc(Ul,Dl,r),_c(Ul,Ul),bc(ql,Nl,o),_c(ql,ql),bc(jl,Ul,s),_c(jl,jl),bc(Ll,Pl,a),_c(Ll,Ll),Ql(t,ql,o,Nl,Pl,u),Ql(t,jl,s,Ul,Nl,u),Ql(t,Ll,a,Pl,Ul,u))}(t,p,u,h,l,c,f,d,a),uc(t,a.b0,a.b1,a.b2,rc,oc);const v=[0,0,0];yc(v,oc,rc),a.quality=vc(v),a.quality<s?fc(a.b0,a.b1,a.b2,rc,oc,v,e):tc(zl,Rl,e)}({data:t,size:3,offsetIdx:0,strideIdx:3},e),e}An(){window.addEventListener("resize",(()=>{const t=this.Hn?.getBoundingClientRect();t&&this.Wn&&this.Vn&&(this.Wn.width=this.Vn.width=t.width*window.devicePixelRatio,this.Wn.height=this.Vn.height=t.height*window.devicePixelRatio,this.Wn.style.cssText=this.Vn.style.cssText="\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                pointer-events: none;\n            ")}))}}class Lc{Ln;We;Ai=[];Oi;Ii;Ti;zi;Ri;constructor(t){const e=t.viewer;this.Ln=e,this.We=t.data;const n=t.style.materialColor?t.style.materialColor:"rgba(255 165 0 0.5)",r=void 0===t.style.outline||t.style.outline;let o=t.style.outlineColor?t.style.outlineColor:"rgba(0, 0, 0, 0)";const s=t.style.outlineWidth?t.style.outlineWidth:1;!1===r&&(o="rgba(0, 0, 0, 0)"),this.Ti={materialColor:n,outline:r,outlineColor:o,outlineWidth:s};let a=[],u=[],h=0;for(let t of this.We){const e=i.Cartesian3.fromDegreesArrayHeights(t),r=new i.PolygonGeometry({polygonHierarchy:new i.PolygonHierarchy(e),perPositionHeight:!0}),s=new i.GeometryInstance({id:"polygon_"+h,geometry:r,attributes:{color:i.ColorGeometryInstanceAttribute.fromColor(i.Color.fromCssColorString(n))}});a.push(s);const l=new i.PolygonOutlineGeometry({polygonHierarchy:new i.PolygonHierarchy(e),perPositionHeight:!0});let c=new i.GeometryInstance({id:"polygonOutline_"+h,geometry:l,attributes:{color:i.ColorGeometryInstanceAttribute.fromColor(i.Color.fromCssColorString(o))}});u.push(c),h++}let l=new i.Primitive({geometryInstances:a,appearance:new i.PerInstanceColorAppearance({flat:!0,renderState:{depthTest:{enabled:!1}}})});this.Ai.push(l);const c=e.scene.primitives.add(l);this.zi=c;let f=new i.Primitive({geometryInstances:u,appearance:new i.PerInstanceColorAppearance({flat:!0})});this.Ai.push(f);const d=e.scene.primitives.add(f);this.Ri=d}show(t){"all"===t.id?this.Ai.forEach((t=>{t.show=!0})):this.Ai.forEach((e=>{e.id===t.id&&(e.show=!0)}))}hide(t){"all"===t.id?this.Ai.forEach((t=>{t.show=!1})):this.Ai.forEach((e=>{e.id===t.id&&(e.show=!1)}))}styleChange(t){const e=t.style.materialColor?t.style.materialColor:"rgba(255 165 0 0.5)",n=void 0===t.style.outline||t.style.outline;let r=t.style.outlineColor?t.style.outlineColor:"rgba(0, 0, 0, 0)";const o=t.style.outlineWidth?t.style.outlineWidth:1;!1===n&&(r="rgba(0, 0, 0, 0)"),this.Ti={materialColor:e,outline:n,outlineColor:r,outlineWidth:o};const s=this.zi._instanceIds;for(let e of s){const n=e,r="polygonOutline_"+e.split("_")[1];this.zi.getGeometryInstanceAttributes(n).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(t.style.materialColor)),this.Ri.getGeometryInstanceAttributes(r).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(t.style.outlineColor))}}resetHighlight(){if(this.Oi){const{materialColor:t,outline:e,outlineColor:n,outlineWidth:r}=this.Ti;this.zi.getGeometryInstanceAttributes(this.Oi).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(t)),this.Ri.getGeometryInstanceAttributes(this.Ii).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(n))}}highlight(t){var e=this.Ln.scene.pick(t.position);let n,r,o,s=i.defined(e)?e.id:void 0;if(void 0!==s){if(s.startsWith("polygon_")?(n=s,r="polygonOutline_"+s.split("_")[1],o="polygon"):s.startsWith("polygonOutline_")&&(r=s,n="polygon_"+s.split("_")[1],o="polygonOutline"),this.Oi){const{materialColor:t,outline:e,outlineColor:n,outlineWidth:r}=this.Ti;this.zi.getGeometryInstanceAttributes(this.Oi).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(t)),this.Ri.getGeometryInstanceAttributes(this.Ii).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(n))}if(i.defined(e)&&(this.Oi=n,this.Ii=r,"polygon"===o)){const e=this.zi.getGeometryInstanceAttributes(n);let o=t.style.materialColor?t.style.materialColor:null;if(o&&(e.color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(o))),t.style.outline){const e=this.Ri.getGeometryInstanceAttributes(r);o=t.style.outlineColor?t.style.outlineColor:null,o&&(e.color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString(o)))}else this.Ri.getGeometryInstanceAttributes(r).color=i.ColorGeometryInstanceAttribute.toValue(i.Color.fromCssColorString("rgba(0, 0, 0, 0)"))}}}}class Bc{Fi;Di=new Map;Pi=0;Ni=30;Ui=null;qi=.8;ji=2;Li=300;Bi=0;constructor(t){this.Fi=t.Fi,this.Ni=t.Pi||30}Hi(t){return{Wi:t,Vi:(new Date).getTime(),Gi:0}}Yi(t,e){let n=this.Di.get(t);return n?(e||(n.Vi=(new Date).getTime(),n.Gi+=1),n.Wi):null}Ki(t,e){this.Di.forEach(((n,i)=>{t.call(e,n.Wi,i)}))}Xi(t,e){if(this.Di.has(t)?this.Di.get(t).Wi=e:(this.Pi+=1,this.Di.set(t,this.Hi(e))),this.Pi>this.Ni&&this.Qi(),this.Pi>this.Ni-1)return!0}Zi(t){return this.Di.has(t)}Ji(t){if(!this.Zi(t))return null;this.Pi-=1;let e=this.Di.get(t);return this.Di.delete(t),e.Wi}_e(){this.er(),this.Di.clear(),this.Pi=0}_destroy(){this.Ki(((t,e)=>{this.Fi?this.Fi(e,t)&&this.Ji(e):this.Ji(e)}),this)}er(){this.Ui&&clearTimeout(this.Ui)}Qi(){if(this.Pi>this.Ni*this.ji)this.er(),this.nr();else{if((new Date).getTime()-this.Bi<10)return;this.er();let t=this;this.Ui=setTimeout((function(){t.Ui=null,t.nr()}),this.Li),this.Bi=(new Date).getTime()}}nr(){let t=Math.round(this.Ni*this.qi);if(this.Pi<t)return;let e,n=this.ir(this.Pi-t);for(let t=0,i=n.length;t<i;t+=1)e=n[t],this.Fi?this.Fi(e,this.Di.get(e).Wi)&&this.Ji(e):this.Ji(e)}rr(t,e){let n=this.Di.get(t),i=this.Di.get(e),r=n.Vi-i.Vi;return 0!==r?r:n.Gi-i.Gi}ir(t){const e=qc(this.Di.keys());return this.sr(e,t,this.rr)}sr(t,e,n){if(e<=0)return[];let i,r,o,s=0,a=t.length-1;for(;s<a;){for(i=s,r=a,o=t[e];i<=e&&r>=e;){for(;i<=e&&n.call(this,t[i],o)<0;)i+=1;for(;r>=e&&n.call(this,t[r],o)>0;)r-=1;let s=t[i];t[i]=t[r],t[r]=s,i+=1,r-=1}r<e&&(s=i),i>e&&(a=r)}return t.slice(0,e)}}function Hc(){const t=(t=0,e=0,n=0,i=1)=>[t,e,n,i],e=(t,e,n)=>{const i=e[0],r=e[1],o=e[2],s=e[3],a=n[0],u=n[1],h=n[2],l=n[3];return t[0]=i*l+s*a+r*h-o*u,t[1]=r*l+s*u+o*a-i*h,t[2]=o*l+s*h+i*u-r*a,t[3]=s*l-i*a-r*u-o*h,t},n=(t,e,n,i,r="zyx")=>{let o=.5*Math.PI/180;e*=o,n*=o,i*=o;let s=Math.sin(e),a=Math.cos(e),u=Math.sin(n),h=Math.cos(n),l=Math.sin(i),c=Math.cos(i);switch(r){case"xyz":t[0]=s*h*c+a*u*l,t[1]=a*u*c-s*h*l,t[2]=a*h*l+s*u*c,t[3]=a*h*c-s*u*l;break;case"xzy":t[0]=s*h*c-a*u*l,t[1]=a*u*c-s*h*l,t[2]=a*h*l+s*u*c,t[3]=a*h*c+s*u*l;break;case"yxz":t[0]=s*h*c+a*u*l,t[1]=a*u*c-s*h*l,t[2]=a*h*l-s*u*c,t[3]=a*h*c+s*u*l;break;case"yzx":t[0]=s*h*c+a*u*l,t[1]=a*u*c+s*h*l,t[2]=a*h*l-s*u*c,t[3]=a*h*c-s*u*l;break;case"zxy":t[0]=s*h*c-a*u*l,t[1]=a*u*c+s*h*l,t[2]=a*h*l+s*u*c,t[3]=a*h*c-s*u*l;break;case"zyx":t[0]=s*h*c-a*u*l,t[1]=a*u*c+s*h*l,t[2]=a*h*l-s*u*c,t[3]=a*h*c+s*u*l;break;default:throw new Error("Unknown angle order "+r)}return t};function i(i,r,o=0){const s=t();n(s,0,0,90+o,"xyz");const a=t();n(a,0,90-i[1],0,"xyz");const u=t();n(u,0,0,i[0],"xyz");const h=t();e(h,u,a),e(h,h,s);const l=t();n(l,0,0,-90,"xyz");const c=t();n(c,0,-(90-r[1]),0,"xyz");const f=t();n(f,0,0,-r[0],"xyz");const d=t();e(d,l,c),e(d,d,f);const p=t();return e(p,d,h),p}function r(t,e,n){const i=e[0],r=e[1],o=e[2],s=n[3]*i+n[7]*r+n[11]*o+n[15]||1;return t[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])/s,t[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])/s,t[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])/s,t}var o=new Float32Array(1),s=new Int32Array(o.buffer);let a={};function u(t){o[0]=t;var e,n=s[0],i=n>>23&255,r=8388607&n;return 0==i?e=0:i<113?(e=0,r|=8388608,16777216&(r>>=113-i)&&(e=1,r=0)):i<142?e=i-112:(e=31,r=0),(n>>31&1)<<15|e<<10|r>>13}function h(t,e){return(u(t)|u(e)<<16)>>>0}const l=(t,e,n=!1)=>{const i=t[0],r=t[1];let o,s,a,u,h=!1;const l=e.length;for(let t=0,c=l-1;t<l;c=t,t+=1){let l=!1;if(o=e[t][0],s=e[t][1],a=e[c][0],u=e[c][1],o===i&&s===r||a===i&&u===r)return!!n;if(s<r==u>=r){const t=(a-o)*(r-s)/(u-s)+o;if(i===t)return!!n;l=i<t}l&&(h=!h)}return h},c=(t,e)=>t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5];function f(t,e){return!(t[3]<e[0]||e[3]<t[0]||t[4]<e[1]||e[4]<t[1]||t[5]<e[2]||e[5]<t[2])}self.onmessage=n=>{if(n.data.ar){const o=function(n,o){const{Jt:s,ar:a,te:u,oe:d,Wt:p,jt:v,ur:m,qt:y,hr:w,lr:g}=n,b=w||d,_=new Float32Array(3*b),x=new Uint8Array(4*b),k=new Uint32Array(3*b);let $=2;y&&($=6);const S=4*$,E=v||4096,M=Math.floor(E/$),C=M*E,A=Math.ceil(b/M),O=Math.ceil(A/E),I=[],T=[],z=[];for(let t=0;t<O;t+=1){const e=t==O-1?A-E*(O-1):E;I[t]=new Uint32Array(E*e*4),T[t]=new Uint8Array(I[t].buffer),z[t]=new Float32Array(I[t].buffer)}const R={x:1/0,y:1/0,z:1/0},F={x:-1/0,y:-1/0,z:-1/0};let D=0;return a.forEach((s=>{s.cr?function(s){const{Yt:a,Be:u,dr:d,pr:p,vr:v=1,mr:m=0,yr:w,Re:g,Jt:b}=s;let k;p&&(k=i(g,n.Re,m));let $=[];o&&($=o.filter(((t,e)=>(t.wr=e+1,f(t.yr,w)))));const A=new Uint32Array(d),O=A[0],P=new Float32Array(A.buffer,8,18),N=P[0],U=P[1],q=P[2],j=P[6],L=P[7],B=P[8],H=0==P[9],W=1==P[10],V=0==P[11],G=P[12],Y=P[13],K=P[14],X=P[15],Q=P[16],Z=P[17];let J,tt,et,nt,it,rt,ot,st,at;V?(J=tt=2047,et=1023,nt=Math.ceil(48*O/32),it=Math.ceil(32*O/32),rt=new Uint16Array(A.buffer,80,3*O),ot=new Uint32Array(A.buffer,80+4*nt,O),st=11,at=10):(J=tt=et=1023,nt=Math.ceil(24*O/32),it=Math.ceil(16*O/32),rt=new Uint8Array(A.buffer,80,3*O),ot=new Uint16Array(A.buffer,80+4*nt,O),st=at=10);const ut=2**(st+at),ht=2**at,lt=[0,0,0],ct=t=>{const e=t/ut|0,n=(t-e*ut)/ht|0,i=t-e*ut-n*ht;return lt[0]=e,lt[1]=n,lt[2]=i,lt},ft=nt+it,dt=W?20:4,pt=a*dt,vt=new Uint32Array(A.buffer,80+4*ft,pt),mt=new Uint8Array(A.buffer,80+4*ft,4*pt),yt=G/J,wt=Y/tt,gt=K/et,bt=[0,0,0];let _t,xt,kt,$t,St,Et,Mt,Ct,At,Ot,It,Tt,zt,Rt,Ft,Dt,Pt,Nt,Ut,qt,jt,Lt,Bt,Ht,Wt,Vt=0;for(let n=0;n<O;n+=1){_t=rt[3*n],xt=rt[3*n+1],kt=rt[3*n+2];const i=ot[n];$t=_t*G+N,St=xt*Y+U,Et=kt*K+q;for(let n=0;n<i;n++){Mt=Math.floor(D/C),It=Mt*C,Ct=I[Mt],At=T[Mt],Ot=z[Mt];const n=Vt*dt,i=vt[n];[Tt,zt,Rt]=ct(i),Tt=$t+Tt*yt+u[0],zt=St+zt*wt+u[1],Rt=Et+Rt*gt+u[2];const o=4*(n+2);Ut=(mt[o+4]-128)/128,qt=(mt[o+5]-128)/128,jt=(mt[o+6]-128)/128,Lt=(mt[o+7]-128)/128;let s=vt[n+1];if([Bt,Ht,Wt]=ct(s),Bt=j+Bt*X,Ht=L+Ht*Q,Wt=B+Wt*Z,H&&(Bt=Math.exp(Bt),Ht=Math.exp(Ht),Wt=Math.exp(Wt)),p){[Tt,zt,Rt]=r(bt,[Tt,zt,Rt],p);const n=t(qt,jt,Lt,Ut),i=t();e(i,k,n),Ut=i[3],qt=i[0],jt=i[1],Lt=i[2],Bt*=v,Ht*=v,Wt*=v}if(Ft=mt[o+0],Dt=mt[o+1],Pt=mt[o+2],Nt=mt[o+3],Vt+=1,Nt<13)continue;_[3*D]=Tt,_[3*D+1]=zt,_[3*D+2]=Rt,R.x=Math.min(R.x,Tt),R.y=Math.min(R.y,zt),R.z=Math.min(R.z,Rt),F.x=Math.max(F.x,Tt),F.y=Math.max(F.y,zt),F.z=Math.max(F.z,Rt);const a=D-It,f=Math.floor(a/M)*E*4+a%M*S;Ot[f+0]=Tt,Ot[f+1]=zt,Ot[f+2]=Rt,At[4*(f+7)+0]=Ft,At[4*(f+7)+1]=Dt,At[4*(f+7)+2]=Pt,At[4*(f+7)+3]=Nt,x[4*D]=Ft,x[4*D+1]=Dt,x[4*D+2]=Pt,x[4*D+3]=Nt,Ct[f+5]=h(Bt,Ht),Ct[f+6]=h(Wt,0),At[4*(f+4)+0]=128*Ut+128,At[4*(f+4)+1]=128*qt+128,At[4*(f+4)+2]=128*jt+128,At[4*(f+4)+3]=128*Lt+128,At[4*(f+3)+3]=Math.ceil(10*Math.max(Bt*v,Ht*v,Wt*v));for(let t=0,e=$.length;t<e;t+=1)if(c([Tt,zt,Rt],$[t].yr)&&l([Tt,zt],$[t].gr)){At[4*(f+3)]=$[t].wr;break}if(y)for(let t=0;t<16;t+=1)Ct[f+8+t]=vt[n+4+t];D+=1}}}(s):m?s._r.red?function(s){const a=null==g?1/0:g,{Yt:u,Be:d,dr:p,yr:v,pr:m,vr:y=1,mr:b=0,Re:k,Qt:$,_r:A}=s;let O;m&&(O=i(k,n.Re,b));let P=[];o&&(P=o.filter(((t,e)=>(t.wr=e+1,f(t.yr,v)))));const N=new DataView(p),U=[0,0,0],q=p.byteLength/u;let j=1;w&&(j=Math.ceil(u/w));for(let n=0;n<u;n+=j){const i=Math.floor(D/C),o=i*C;var L=I[i],B=T[i],H=z[i];const s=q*n;let u=N[A.x](s+$.x,!0)+d[0],f=N[A.y](s+$.y,!0)+d[1],p=N[A.z](s+$.z,!0)+(d[2]||0);if(p>a)continue;const v=D-o,w=Math.floor(v/M)*E*4+v%M*S,g=N[A.red](s+$.red,!0),b=N[A.green](s+$.green,!0),k=N[A.blue](s+$.blue,!0),j=255;x[4*D]=g,x[4*D+1]=b,x[4*D+2]=k,x[4*D+3]=j,B[4*(w+7)+0]=g,B[4*(w+7)+1]=b,B[4*(w+7)+2]=k,B[4*(w+7)+3]=j;const W=[.01,.01,.01],V=[1,0,0,0];if(m){[u,f,p]=r(U,[u,f,p],m);const n=t(V[1],V[2],V[3],V[0]),i=t();e(i,O,n),V[0]=i[3],V[1]=i[0],V[2]=i[1],V[3]=i[2],W[0]*=y,W[1]*=y,W[2]*=y}R.x=Math.min(R.x,u),R.y=Math.min(R.y,f),R.z=Math.min(R.z,p),F.x=Math.max(F.x,u),F.y=Math.max(F.y,f),F.z=Math.max(F.z,p),H[w+0]=u,H[w+1]=f,H[w+2]=p,_[3*D]=u,_[3*D+1]=f,_[3*D+2]=p,L[w+5]=h(W[0],W[1]),L[w+6]=h(W[2],0),B[4*(w+4)+0]=128*V[0]+128,B[4*(w+4)+1]=128*V[1]+128,B[4*(w+4)+2]=128*V[2]+128,B[4*(w+4)+3]=128*V[3]+128,B[4*(w+3)+3]=Math.ceil(Math.max(W[0],W[1],W[2]));for(let t=0,e=P.length;t<e;t+=1)if(c([u,f,p],P[t].yr)&&l([u,f],P[t].gr)){B[4*(w+3)]=P[t].wr;break}D+=1}}(s):function(s){const{Yt:a,Be:u,dr:d,yr:p,pr:v,vr:m=1,mr:w=0,Re:g,Qt:b,_r:k}=s;let $;v&&($=i(g,n.Re,w));let A=[];o&&(A=o.filter(((t,e)=>(t.wr=e+1,f(t.yr,p)))));const O=new Float32Array(d),P=[0,0,0],N=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],U=2047,q=1023,j=new Float32Array(1),L=new Uint32Array(j.buffer);for(let n=0;n<a;n++){const i=Math.floor(D/C),o=i*C;var B=I[i],H=T[i],W=z[i];const s=62*n;let a=O[s+0]+u[0],f=O[s+1]+u[1],d=O[s+2]+(u[2]||0);const p=D-o,w=Math.floor(p/M)*E*4+p%M*S,g=.28209479177387814,b=Math.max(0,Math.min(255,255*(.5+g*O[s+6]))),k=Math.max(0,Math.min(255,255*(.5+g*O[s+7]))),V=Math.max(0,Math.min(255,255*(.5+g*O[s+8]))),G=1/(1+Math.exp(-O[s+54]))*255;if(G<13)continue;x[4*D]=b,x[4*D+1]=k,x[4*D+2]=V,x[4*D+3]=G,H[4*(w+7)+0]=b,H[4*(w+7)+1]=k,H[4*(w+7)+2]=V,H[4*(w+7)+3]=G;const Y=[Math.exp(O[s+55]),Math.exp(O[s+56]),Math.exp(O[s+57])],K=[O[s+58],O[s+59],O[s+60],O[s+61]],X=Math.sqrt(K[0]**2+K[1]**2+K[2]**2+K[3]**2);if(K[0]/=X,K[1]/=X,K[2]/=X,K[3]/=X,v){[a,f,d]=r(P,[a,f,d],v);const n=t(K[1],K[2],K[3],K[0]),i=t();e(i,$,n),K[0]=i[3],K[1]=i[0],K[2]=i[1],K[3]=i[2],Y[0]*=m,Y[1]*=m,Y[2]*=m}R.x=Math.min(R.x,a),R.y=Math.min(R.y,f),R.z=Math.min(R.z,d),F.x=Math.max(F.x,a),F.y=Math.max(F.y,f),F.z=Math.max(F.z,d),W[w+0]=a,W[w+1]=f,W[w+2]=d,_[3*D]=a,_[3*D+1]=f,_[3*D+2]=d,B[w+5]=h(Y[0],Y[1]),B[w+6]=h(Y[2],0),H[4*(w+4)+0]=128*K[0]+128,H[4*(w+4)+1]=128*K[1]+128,H[4*(w+4)+2]=128*K[2]+128,H[4*(w+4)+3]=128*K[3]+128,H[4*(w+3)+3]=Math.ceil(Math.max(Y[0],Y[1],Y[2]));for(let t=0,e=A.length;t<e;t+=1)if(c([a,f,d],A[t].yr)&&l([a,f],A[t].gr)){H[4*(w+3)]=A[t].wr;break}if(y){for(let t=0;t<45;t+=1)N[t]=O[s+9+t];const t=(t,e,n)=>{const i=Math.floor(t*U+.5),r=Math.floor(e*q+.5),o=Math.floor(n*U+.5);return(i<0?0:i>U?U:i)<<21|(r<0?0:r>q?q:r)<<11|(o<0?0:o>U?U:o)};let e=Math.abs(N[0]);for(let t=1;t<45;++t){const n=Math.abs(N[t]);n>e&&(e=n)}if(0===e)continue;for(let t=0;t<45;++t)N[t]=N[t]/e*.5+.5;j[0]=e,B[w+8]=L[0],B[w+9]=t(N[0],N[15],N[30]),B[w+10]=t(N[1],N[16],N[31]),B[w+11]=t(N[2],N[17],N[32]),B[w+12]=t(N[3],N[18],N[33]),B[w+13]=t(N[4],N[19],N[34]),B[w+14]=t(N[5],N[20],N[35]),B[w+15]=t(N[6],N[21],N[36]),B[w+16]=t(N[7],N[22],N[37]),B[w+17]=t(N[8],N[23],N[38]),B[w+18]=t(N[9],N[24],N[39]),B[w+19]=t(N[10],N[25],N[40]),B[w+20]=t(N[11],N[26],N[41]),B[w+21]=t(N[12],N[27],N[42]),B[w+22]=t(N[13],N[28],N[43]),B[w+23]=t(N[14],N[29],N[44])}D+=1}}(s):function(s){const{Yt:a,Be:u,dr:d,yr:p,pr:v,vr:m=1,mr:y=0,Re:w}=s;let g;v&&(g=i(w,n.Re,y));let b=[];o&&(b=o.filter(((t,e)=>(t.wr=e+1,f(t.yr,p)))));const k=new Float32Array(d),$=new Uint8Array(d),A=[0,0,0];["rgb(173,221,142)","rgb(120,198,121)","rgb(65,171,93)","rgb(35,132,67)","rgb(0,104,55)","rgb(0,69,41)"].map((t=>t.slice(4,-1).split(",").map((t=>+t)))),["rgb(189,189,189)","rgb(150,150,150)","rgb(115,115,115)","rgb(82,82,82)","rgb(37,37,37)","rgb(0,0,0)"].map((t=>t.slice(4,-1).split(",").map((t=>+t)))),["rgb(254,217,118)","rgb(254,178,76)","rgb(252,78,42)","rgb(227,26,28)","rgb(189,0,38)","rgb(128,0,38)"].map((t=>t.slice(4,-1).split(",").map((t=>+t)))),["rgb(218,218,235)","rgb(158,154,200)","rgb(128,125,186)","rgb(106,81,163)","rgb(84,39,143)","rgb(63,0,125)"].map((t=>t.slice(4,-1).split(",").map((t=>+t))));const O=["rgb(255,247,251)","rgb(236,226,240)","rgb(208,209,230)","rgb(166,189,219)","rgb(103,169,207)","rgb(54,144,192)","rgb(2,129,138)","rgb(1,108,89)","rgb(1,70,54)"].reverse().map((t=>t.slice(4,-1).split(",").map((t=>+t))));O[0],O[1],O[2],O[3],O[4],O[5];for(let n=0;n<a;n++){const i=Math.floor(D/C),o=i*C;var P=I[i],N=T[i],U=z[i];let s=k[8*n+0]+u[0],a=k[8*n+1]+u[1],f=k[8*n+2]+(u[2]||0);const d=D-o,p=Math.floor(d/M)*E*4+d%M*S;let y=$[24+32*n],w=$[25+32*n],O=$[26+32*n],q=$[27+32*n];if(q<13)continue;x[4*D]=y,x[4*D+1]=w,x[4*D+2]=O,x[4*D+3]=q,N[4*(p+7)+0]=y,N[4*(p+7)+1]=w,N[4*(p+7)+2]=O,N[4*(p+7)+3]=q;const j=[k[3+8*n],k[4+8*n],k[5+8*n]],L=[($[28+32*n]-128)/128,($[29+32*n]-128)/128,($[30+32*n]-128)/128,($[31+32*n]-128)/128];if(v){[s,a,f]=r(A,[s,a,f],v);const n=t(L[1],L[2],L[3],L[0]),i=t();e(i,g,n),L[0]=i[3],L[1]=i[0],L[2]=i[1],L[3]=i[2],j[0]*=m,j[1]*=m,j[2]*=m}R.x=Math.min(R.x,s),R.y=Math.min(R.y,a),R.z=Math.min(R.z,f),F.x=Math.max(F.x,s),F.y=Math.max(F.y,a),F.z=Math.max(F.z,f),U[p+0]=s,U[p+1]=a,U[p+2]=f,_[3*D]=s,_[3*D+1]=a,_[3*D+2]=f,P[p+5]=h(j[0],j[1]),P[p+6]=h(j[2],0),N[4*(p+4)+0]=128*L[0]+128,N[4*(p+4)+1]=128*L[1]+128,N[4*(p+4)+2]=128*L[2]+128,N[4*(p+4)+3]=128*L[3]+128,N[4*(p+3)+3]=Math.ceil(Math.max(j[0],j[1],j[2]));for(let t=0,e=b.length;t<e;t+=1)if(c([s,a,f],b[t].yr)&&l([s,a],b[t].gr)){N[4*(p+3)]=b[t].wr;break}D+=1}}(s)})),R.x-=.5,R.y-=.5,R.z-=.5,F.x+=.5,F.y+=.5,F.z+=.5,{layerId:u,hasSH:y,key:p,uri:s,centers:_.buffer.slice(0,12*D),rgbas:x.buffer.slice(0,16*D),sigmas:k.buffer.slice(0,12*D),boundMax:Object.values(F),boundMin:Object.values(R),texdatas:I.map((t=>t.buffer)),vertexCount:D}}(n.data,a[n.data.te]);self.postMessage(o,[o.centers,...o.texdatas,o.rgbas,o.sigmas])}else n.data.kr&&(a[n.data.te]=n.data.kr)}}class Wc{$r=[];Sr=[];Er=0;constructor(t){for(let e=0;e<t;e+=1)this.$r.push(new Worker(URL.createObjectURL(new Blob(["(",Hc.toString(),")(self)"],{type:"application/javascript"}))))}postMessage(t,e){t.broadcast?this.$r.forEach((n=>{n.postMessage(t,e)})):this.$r[this.Er++%this.$r.length].postMessage(t,e)}tryPost(){if(this.Sr.length){const t=this.$r.find((t=>!t.isBusy));if(t){t.isBusy=!0;const e=this.Sr.shift();t.postMessage(e[0],e[1])}}}set onmessage(t){this.$r.forEach((e=>{e.onmessage=t?e=>{t(e)}:null}))}}class Vc{Mr;Cr;Ar=null;Or;Ir=1;MAX_STORAGE_BYTES=21474836480;Tr=!0;constructor(t,e,n=[],i=20){this.Mr=t,this.Cr=e,this.Or=n.sort(((t,e)=>t.version-e.version)),this.MAX_STORAGE_BYTES=1073741824*i}async open(){return new Promise(((t,e)=>{const n=indexedDB.open(this.Mr);n.onerror=()=>e(n.error),n.onsuccess=async()=>{this.Ar=n.result,this.Ir=this.Ar.version,this.zr(this.Ar)?(this.Ar=this.Ar,t(this.Ar)):(this.Ar.close(),t(await this.Rr())),t(this.Ar)},n.onupgradeneeded=t=>{this.Ar=n.result,this.Rr()}}))}Rr(){return new Promise(((t,e)=>{const n=this.Ir+1,i=indexedDB.open(this.Mr,n);i.onerror=()=>e(i.error),i.onsuccess=()=>{this.Ar=i.result},i.onupgradeneeded=t=>{this.Ar=i.result;const e=this.Ar.createObjectStore(this.Cr,{keyPath:"id"});e.indexNames.contains("created_at")||e.createIndex("created_at","metadata.createdAt",{unique:!1}),e.indexNames.contains("last_accessed")||e.createIndex("last_accessed","metadata.lastAccessed",{unique:!1}),e.indexNames.contains("uri")||e.createIndex("uri","metadata.uri",{unique:!0})}}))}zr(t){try{const e=t.transaction(this.Cr,"readonly").objectStore(this.Cr);return["created_at","last_accessed","uri"].every((t=>{try{return e.index(t),!0}catch{return!1}}))}catch(t){return!1}}async store(t,e,n){if(this.Fr())return await this.Dr(),this.Pr({id:t,buffers:e,metadata:{createdAt:Date.now(),lastAccessed:Date.now(),...n}})}async Pr(t){return await this.Nr(),new Promise(((e,n)=>{const i=this.Ar.transaction(this.Cr,"readwrite").objectStore(this.Cr).put(t);i.onsuccess=()=>e(),i.onerror=()=>n(i.error)}))}async get(t){return this.Fr()?(performance.now(),await this.Nr(),new Promise(((e,n)=>{const i=this.Ar.transaction(this.Cr,"readonly").objectStore(this.Cr).get(t);i.onsuccess=async()=>{const n=i.result;e(n??null),n&&await this.Ur(t)},i.onerror=()=>n(i.error)}))):null}async getMultiple(t){return this.Fr()?(performance.now(),await this.Nr(),new Promise(((e,n)=>{const i=this.Ar.transaction(this.Cr,"readonly").objectStore(this.Cr),r=new Map;let o=t.length;t.forEach((n=>{const s=i.get(n);s.onsuccess=async()=>{const i=s.result;r.set(n,i??null),o-=1,0===o&&(e(r),this.qr(t))},s.onerror=()=>{o-=1,r.set(n,null),0===o&&e(r)}}))}))):new Map}async has(t){return!!this.Fr()&&(await this.Nr(),new Promise(((e,n)=>{const i=this.Ar.transaction(this.Cr,"readonly").objectStore(this.Cr).count(t);i.onsuccess=()=>e(i.result>0),i.onerror=()=>n(i.error)})))}async delete(t){if(this.Fr())return await this.Nr(),new Promise(((e,n)=>{const i=this.Ar.transaction(this.Cr,"readwrite").objectStore(this.Cr).delete(t);i.onsuccess=()=>e(),i.onerror=()=>n(i.error)}))}async clear(){return await this.Nr(),new Promise(((t,e)=>{const n=this.Ar.transaction(this.Cr,"readwrite").objectStore(this.Cr).clear();n.onsuccess=()=>t(),n.onerror=()=>e(n.error)}))}async Nr(){this.Ar&&this.Ar.version===this.Ir||await this.open()}Fr(){return!(this.Ar&&!this.Ar.objectStoreNames.contains("tiles")||!this.Ar)}close(){this.Ar&&(this.Ar.close(),this.Ar=null)}async Dr(){if(!this.Ar)return;if(!this.Tr)return;const{usage:t}=await navigator.storage.estimate();if(null!=t&&t>this.MAX_STORAGE_BYTES){const e=this.Ar.transaction(this.Cr,"readwrite").objectStore(this.Cr),n=e.index("last_accessed").openCursor();let i=10;this.Tr=!1,await new Promise(((r,o)=>{n.onsuccess=async()=>{const o=n.result;if(i>0&&o&&t>this.MAX_STORAGE_BYTES){const t=o.value;await e.delete(t.id),i--,i<=0&&(this.Tr=!0),o.continue()}else r()},n.onerror=()=>o(n.error)}))}}async Ur(t){if(!this.Ar)return;const e=this.Ar.transaction(this.Cr,"readwrite").objectStore(this.Cr),n=await new Promise(((n,i)=>{const r=e.get(t);r.onsuccess=()=>n(r.result||null),r.onerror=()=>i(r.error)}));n&&(n.metadata=n.metadata||{},n.metadata.lastAccessed=Date.now(),e.put(n))}async qr(t){if(!this.Ar||0===t.length)return;const e=this.Ar.transaction(this.Cr,"readwrite"),n=e.objectStore(this.Cr);for(const e of t){const t=await new Promise(((t,i)=>{const r=n.get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>i(r.error)}));t&&(t.metadata=t.metadata||{},t.metadata.lastAccessed=Date.now(),n.put(t))}return new Promise(((t,n)=>{e.oncomplete=()=>t(),e.onerror=()=>n(e.error)}))}}!function(t){t[t.init=0]="init",t[t.loading=1]="loading",t[t.failed=2]="failed",t[t.loaded=3]="loaded",t[t.parsed=4]="parsed",t[t.destroyed=5]="destroyed"}(Dc||(Dc={}));class Gc extends Cl{Ae;Ie=$l();Di;ce;_scene;jr=null;Te=0;ze;Lr="";Br=new Map;Hr=[];Wr;Vr="splat";Gr=0;Yr=0;jt;Fe=!0;kr;Kr;Xr;Qr;Zr;Jr=1;Ar;Ue={Zt:new Int32Array(0),ee:[],_modelMatrix:i.Matrix4.IDENTITY.clone(),Kt:[],oe:0,qe:0,je:void 0,Le:[],qt:!1};eo;Ne;no;io;ro=!1;oo;so;ao;uo=!1;constructor(t){super(),this.Xr=new Wc(t.$r||2),this.Ae=t.Ae,this.Wr=this.Ae.substring(0,this.Ae.lastIndexOf("/")+1);const e=this.Wr.match(/\[\d(,\d+)+\]/g);let n,i;if(e&&e[0]){const t=JSON.parse(e[0]);n=e[0],i=t}this.Kr=new Yc(n,i),this.Kr.ho=this.ho.bind(this),this.Kr.lo=this.lo.bind(this),this.Kr.co=this.co.bind(this),this.Kr.fo=this.fo.bind(this),this.ao=t.ao,this.ce=t.ce,this._scene=t._scene,this.no=t.no,this.oo=t.oo,this.io=Math.max(1e-5,Math.min(2,t.io||1)),this.jt=Math.min(4096,this.ce._gl.getParameter(this.ce._gl.MAX_TEXTURE_SIZE)),this.Ne=new El(this.ce,this.jt),this.Di=new Bc({Pi:t.do,Fi:(t,e)=>!(this.Yr===e.po||this.Ue&&-1!==this.Ue.ee.indexOf(t)||this.Hr.find((e=>e.Ae==t))||(this.Ne.Ce(e),this.vo(e),0))}),null!=t.mo&&t.mo>0&&(this.Ar=new Vc("AMapYunJing","tiles",[{version:1,migrate:(t,e)=>{}}],t.mo),this.Ar.open()),this.kr=t.kr,this.so=t.so,t.yo?(this.Vr=t.yo.type||"splat",this.jr=t.yo.root,this.Kr.Vr=this.Vr):this.wo(t).then((()=>{if(t.kr.length){const e=this.jr.enuCenter;t.kr.forEach((t=>{let n=1/0,i=1/0,r=-1/0,o=-1/0;t.gr=t.polygon.map((t=>{const{x:s,y:a,z:u}=Mc([t[0],t[1],0],e);return n=Math.min(n,s),r=Math.max(r,s),i=Math.min(i,a),o=Math.max(o,a),[s,a]})),t.yr=[n,i,t.height,r,o,t.extrudedHeight]})),this.Xr.postMessage({broadcast:!0,te:this.Ie,kr:t.kr})}}));const r=t=>{t.data.te==this.Ie&&this.He(t.data)};this.Xr.onmessage=t=>{t.data.layerId==this.Ie&&this.Ge(t.data)},yl.addEventListener("message",r),this.eo=()=>{this.Xr.onmessage=null,yl.removeEventListener("message",r)}}bo(t){this.so=t}vo(t){t._o=Dc.destroyed,t.dr=void 0,t.Vt=void 0,t.Kt=[]}_destroy(){this.ce=null,this.kr=[],this.Wr="",this.Ae="",this.eo(),this.eo=void 0,this.Ue=void 0,this.jr=null,this.Yr=0,this.Di._destroy(),this.Ne._destroy(),this.Hr=[],this.Br=new Map,this.Kr.clear()}xo(){if(this.jr)return this.jr}He(t){const{ee:e,Vt:n,Zt:r,re:o,oe:s,ie:a,qt:u,ne:h}=t;let l=i.Matrix4.IDENTITY.clone();const c=[];e.forEach(((t,e)=>{const i=this.Di.Yi(h[e],!0);i&&(i.ko=!0,i.Vt=n[e],c[e]=i.Yt,l=i._modelMatrix)})),this.Ue={Zt:new Int32Array(r.buffer,4*o),ee:e,qt:u,_modelMatrix:l,Kt:this.Ne.Se(a),Le:c,oe:s,qe:this.Ue?.qe||0,je:this.Ue?.je},this.Fe=!0,this.Qr&&this.Qr(this.Ue)}$o(){return this.Ar}async Ge(t,e=!1){const{texdatas:n,boundMax:i,boundMin:r,layerId:o,key:s,uri:a,centers:u,rgbas:h,sigmas:l,vertexCount:c}=t,f=this.jt,d=this.Di.Yi(a,!0);d&&(!e&&this.Ar&&await this.Ar.store(a,n,{uri:a,key:s,layerId:o,boundMax:i,boundMin:r,centers:u,vertexCount:c}),d.oe=c,d.Yt=c,d.Kt=[],d.Vt=u,d.Lt=i,d.Bt=r,n.forEach(((t,e)=>{const n=new Float32Array(t),i=t.byteLength/16/f,r={width:f,height:i,arrayBufferView:n},o=s+"_"+e,a=Math.floor(this.jt/(d.qt?6:2)),u=Math.ceil(Math.sqrt(this.jt*a/(this.jr?.avgCount||15e4))),h=this.Ne.Ee(d.Oe,2**(5-d.Gt)*u*240,i,d.Gt);h.me(r,o,d.Oe),d.Kt.push(h)})),d._o=Dc.parsed,this.Zr&&this.Zr())}async wo(t){if(!this.Ae)return;let e=this.Ae;this.Kr.So&&this.Kr.Eo&&(e=e.replace(this.Kr.Eo,this.Kr.So[0]));const n=await fetch(e,{cache:"default",mode:"cors",credentials:"omit"});if(!document.getElementById("yunjinglogo")){const t=document.createElement("img");t.id="yunjinglogo",t.style.cssText="position: absolute; top: 5px; left: 5px;",t.width=200,t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATkAAABFCAYAAAAxdpH/AAAAAXNSR0IArs4c6QAAHk1JREFUeF7tXXn8ftWc/3w+1zLWmVTCCDFlLJWxlAlTUShbRpYwibJFmLFvY2+yZC0UqWQiZI0K2UJobClLlhYlskSFNJ7zdt6P8zyve8/3Ps89d3ue5/vrnn9+r9/3Oevn3vs+53yW90clsQAwEbm7c+6+qrq9iNxaRG6oqldP7OLOqvqNsroA9hKRYxP7mVsNwF9E5DIR+RmA75rZF0TkBFW9qIv+hz4GCQwSWF8S0KrpAriuiDwZwFNV9WZV9ef8vhCQmwGiIxH5pKq+RlW/1GINQ9NBAoME1pkE5oIcgIcDeIOq3riDdS0N5PJzB/AhVT1AVX/ewZqGLgYJDBJYcQmUghyAaznn3m5me3c4/5UAOa4HwG9U9VGqenKH6xu6GiQwSGAFJbAG5ABcH8AnVPXuHc93ZUAuAN1IVfdT1aM6XufQ3SCBQQIrJIECyAG4JoBPqeq/9TDHlQK5AHROVfdS1ff3sN6hy0ECgwRWQAIFkBuNRoeZ2RN6mtfKgVwAuj/5a+u/qup3elr30O0ggUECS5TAFOQA3F9EPt7jXFYS5ALQnamqd1LVK3tc/9D1IIFBAkuQwBjkAFzDW1K/r6q37HEOKwtyYc3PUtWDe1z/0PUggUECS5DABOQeLyKH9zz+UkEOwI9EZAtVvVrZOgH8yhshbqGqf+xZDkP3gwQGCbSUAIDNReRxAHYSkX8UkT8COMPMPiAiNJy6yRBjkHPOfUdVt2k5blXzpYAcgLNU9VAR+aGInFIxyX29w/O7qhYy/D5IYJDAciQAgJj1XADPp8+rmX1CRM4TkWuLyPYAHicivwsuYj/hLBXA7UXkuwuY8kJBzoeK/VBVXyEin2U4moj8WUQ+Om+dAD5jZrsuQBZJQwC4oYjsXFL5A/mdKqmzdVQJwK18KN6doylfpqqfXEfLGKbagwRGo9EhqrqTqu6pqj+IhwBwNefci30Y5xPpBqeqPybIPVNEXtfDfOIuFwJyAH7ir6SvFJFjRGQT59wBZvZi59xLzey/K0DuSlXdaFWurOEo/rmSOV9zlYwkADIRubmIbM2YZobPtXmfANDCf1i+DwBnmxnjpYfSQAIAqG+/d9T066r6zQbdlTYBwJj2f4l+pEvaT7sYI0RgvVpV7yIi2wKYfs/c9J1zF5kZQfDLPob9RQAe7DfG7XQ0Gh1nZg/rYhIVffQKcgDO82QBrxKRo1T1/3kKcs69ycwer6qXO+c+rqq0IFeVHVT1tKpK0QdIkoJP12mTUhfAP6jqtiW71aldn+Scc+dkWfbYaF13dM49NBqfa72OiHBuPGlSN3IzVb0m6zGaxL9omwB4uog8OGWdJeu7sapuFc2Frj5fb9JfaLMr34uSsXp5di3mmdTUP5ezsix7SlLlvz2Xh4jIB6P6L/DP7X9S+6iqNxqNDjSz50f1eOI6vqpt1e8kCOFGp6rPUNUTAqkHD2gTlzcSiOwOgAZEbri/B/BNVT2I8PctVb1D1SAd/N4LyAG4IDyod05ONwA2FREqIB832UWccz9PjMF9bN0oCFqnw3W4AzEtp4vA2FLQywLYx5/QjqwzownIjUajt5jZU+u07blu6el3vT47AKeZ2Q6pMtsAQO6uAI5V1Vup8gKKvXji9yxDBXWOv7kxZHMPVT0VwBMB7E6QS/34U+U5q16nIOcXcJGqvprXGlW9YjIogM0AkHHkOao6NjQAoPXlgsQFPLfudWu9fijRSYm0VAPIJb4ky67WN8iNRqO30Um+5jp5Aufpflr8RnkuT1V1+qFuPMuyZ0X97O+c2yHLskeHb5ogR2akyW3h70RkD686eYWq0ovitwBuB+AkgtyvVXXjOpNoWLcTkANwsapSh3horDvjFRXAZ1X1cFV9cw74HlhldMit6aWq+rI6axxArvBSj3Vnw0muzhtUv27fIOecO1lVYx1e/Yk2aAHgeDPbMwK55znnbppl2fh2EE5y9IQgT+T1VJUqErqOvGTCWwngJmP/3/UCcoE55PUi8mbq2GLZBYA7BcDpWZbRjJzfTV7q5fKSRHk3AbmrATgusf+VrOZN7+dnWfafkdxItfXG3N9ISEq91h9opheRiwFcaGbnBBedMzzpwfjE7NUI+wHYreFiuRMXFNhe18Jn/qmG/YmqPlxVOf9CCY7w65FQ9XQzu2+qPOpeV1cQ5Pbl+zQBv/x1lW4lzrmDVHU3xt17vR3fTb6DdwLw/lUBuf28Q987yh6YV2Bf4i2ebxIR8tpdOqPOpgB4Nb1cVXdWVbqLTEsNowPb1Aa51BdtqJcmgcG6mianOrU2AJC7LYAv+FvaTYJhsaCTC4YJGuR+pKrUJRPknuuc23qpIAdgi+DTsrf3aaMbQv70dSkAKq9fN0HmGQDHYyoBbmOalstozp1zF1I4iS/FAHKJguqr2gBy3Uu2LsgBIAs4WcGXUS6d3Aiiw8pXveX0SG9APKzM8BB0cLSo8gbxtRCqus9SQI4CdM69UFVpySzkiOC1xF8932pmpCr/zTwJT3Rw3ieOFpcdy1wMeC8XkQtrPKlOQA7Azb0qgIrRO9TIg1Fjms2qAvijP+0y7wUVy6Un49Seg/f59YOP3K25a/JZZFn2qGjD2sU5x41sc6/vTKHcb+VC0uUaU2WxSvVofHPO0RF+WoIyfpfouZwO4Nv5v5nZ27v0netSLp4GbgcAzNeyo4jQo+Fued17OL09RkQ28rc3Em5cz8z2WCjIUUnonKNvDn3XOMn8yY2xZ6R64t364irh0E2ERgbvKnI7VX2MNy3T+XdNAfAAEflYVX+531uDnD9W7wzgoxRyjXEXWhXAT1X1nn6jYUhMaQGwa3AWn/xOjCLnIENoNvKWbdLiXzsPXBMXkkmD0Wj0GjN79kIXFwZLWeMy5tX3mN7Vgj6GDGNsUtb4tXlrJyOG7hl19j5VPbvJAD5OnP59sbHzVarKXCxzS3ALeSUjGrxD8IfpTpJvAOBGHuTfxo03vN+/WxjI8aMXkft45zyaeqcFwBUA3mlmB6Zm1ALAKyqtqFs75w6Ozc1R/3WMDmzaCuQAXA/Aj2NTetXDW8bvPqLi87GfUSS7xn5y7KfBBtOHGKjHYRD3Vab0AHJ08D0wEuAD6JTbRKjOOYZcFpy9RSQ5iocGCN72gsPvCWZGN5XrOOe2p8M/gPea2TMnBsqFgVwsDABX+ivdkWZGBP9ZqrACwH2GkQCBxXj3eTuAc+5j3qTM01xqaQty9OMpPVWmTmDB9baisrZszDbOwOyvgez7WvrMNfY14DL73dBBLmygVHPt7pzjBnYTM/uTiJwhIkxURdCbloWDHACGXB1jZjxy0vUguYQrKgFum3Ba2k5VL5nXQU2jA7tqC3KMp1vjZ+ece58PQVlahjBVveOMEw03iRPbghxd0EXkV/5a80UzG4eCOee+p6q3yfcNgE6a/xtcUcY/BWbmqeMpabG8+T8mcOWL/IhJX2GTPKTwMs9e4/2uSsH9XYBccP+5aQAUumYUQvScc4eYGUGldgkOu5tFDfcXkYmLzzk+uP4ztTue0WBhIAdgxLAMM3s5mQHqLiAA3Cm8ogKg9YWU5d+b108Do0MXIEd/PF6Rp4W+e2a2Xd01d1k/5O+gi03Mpzfz2gHgnl7HdkA0j21ictWw4TDmlyA3LTOuJYxEeW0kn4LMZjiDEgS/kgO5y8yMRo+8nKkvrLXGLmW8Kn0BoEqIRqB8oU7toOj50MAXJ3KiquWSVfOTayPb3kHOMwU4OuQFcPt+k8mGKyoBjic4Jp8hu0ClMaEhpXvbk1wZyPF0Q4vQUos3+pBlpWDNFpFaupWySIayuFcudAbIMedt4QTmT4GdgFwY88+xUavuGpf6kHoavK4LyQByCQ8iXF94P36Zqjbmq/O+chvTDy7HxkGuKFIpVZb446ls8LcKfYAcGTSeHEJQEqfRebW7ll2jReT+3r+QxINJZZ2C3AN9Do/S/CUAjqKxKGnxK1aJV3DvlnNEyrQGkOswdjWAG2mNCBbfSnkAs+qEKypj6CYhPmQWYXhOwWw8q31DxXdbkFvDhdZGBgtoSz++5ExlHYDcmlwaXZ3kSJjovdy5oSRfyRcY1tj5o6ReLMuyWJ1QOk5dkBuNRu/pKTVppRxIsJFl2ZMqKyZW6Oy6GsDtpABubXi/xlPPX1HD/0nRTuc/xk0mlQZGhy5OcvTTIXEnfclWugRq+K1TNw0upibIMTnSP+eF4KMZyHrDEL5pHCn9CunTNKkX5kVDzbQ45zbPp8v09Ne8lhZO9ABoXCnjsJt5Wh1Arjs+uVV92TsBOVKjhOj/qWK4zYLzbiIB4JhkhpbUgml43hjesZiOqk2sma1OcmG++/hEG0eoKon8VrIE480uqnp6nQnWBLkTVTU5iLzOPGrWpcN4qZFqALlqkCN5q4hws6IDeGkiqJrPI1+dhA90IftBijNwk3HaghzDg0htwn87KUEHR9AcE3nS5cTTGZPVtdYYDY0OrU9yudPIjt7R+XmBDroQ3dGJoJp3wrC5LwRDUKl/3Lyu64AcALp8vLf5VNu39KSJXzcz0nKXlgHkZoMcg94ZHuZvT8/uOzQRwM98mOF/qWrMXtz6JWgEcgC+Ek5unfmyBEC7QTgV5ml2nuKjB+jdXKsE/vdavHBhgNYnuVoTXWeV64AclzYajY4wswL11aKWDOCXIenJmoQnuc2Ip5NCPK13PSIfIenC84VO3qX+hItaT8k4vLInqW/q6uTC9/gcESEx7UJK8Jy4r1dLdZpKoBbI0d8rgFvnDzvWwVGqzrnDsyxjjFrt4pxj7CjJMuuWAeTmSKwuyIWP5REAGDhN7v1FXOEvCyFrZLD5Zd0XwDlHSn2ySY8LfTwZpke22bp9rUr9JiAXy2ERa+kjY14SyAFgHgieihgilWTZrCOQEjcRvlhf8jzt92qalarFA2oMcoGV48E+jy39+Ao00HXksaC6tBWdY2ZHe73ZV1PHbAJyqX2vQj0f98iMYPHJ7xs+TjNOkbgK002eQ12QA3AtJmyOByAWeDXEzJNx6oTC9ZcpA2+Ub8Nrq5mR5qmzMhfk6OTplecv997Tx/cBbmGXpB/cVAcX/sb7Obnhau/CoX1TowObNwK54L5AZob4mtPZw+qjIyKdV/jS95CZzirLVQDk6LpAFotpcc69NssyXt3WbWkAcvQdLFBxMdxOVZlyspODTri98VufknbQ+m5m01N0FwIvBTkidQC347pOfRehNnVwn2Zc5eTvgQuMFMbfaLpAf62+n09O3IghoQXI0cjQWXq3pmtv0Y60S2U5XgtdpoKc3/EfxMQjLebTaVMzI8VXJZXPjBSdM+N7O51kj511BHK1MoSlLCd281okyPHkxqxVP0mZaJM6AcWZeHZqZAinikf53aKVRa6F0aHxSc45d27I99hEHEtv45w7LsuyaQD8rAmlgtx6SWQTbbrMdfeLvKohWPdvUJZXpO+HBoAeBrG/Ja/OBXr/lHl0BHI/B1DwX0wZe16dkOmeeXzHZWEgFwYjFRIDeMkWMpeht+5CYzeRXHtmx+aJqFVxzn3ER1s8qGEnta+rABgPemXZeNQxiAjD2jo54jdc06QZKebvqqr0eyoUMsSaWZz9fM1wGzjIMai9wKzhiUO/bGYkjVx4cc4xLDJ2bqY7VW2vhi5AbhECWCjI5ZD1dz7gmYR5b8nnN226YABlbiJEcMbhMVjcNe170q6F0YFdNAG50uTSge+OcZO1d962MpjVPjCnkiufls5pmRVkH/ezgYPc07zDK5MmTQv9xLIsI33WwgsAZk9jhrp8oV8q9eS1ygByCbGrAM7zKd1eJCLMYt0IiABsFIwMUx0cn5RPSkGmUJ4wxqnE2hR+xC0D4TsDORGhz8/JEZjwNEXLa2WugzZyCG0ZOsVokZgiuowpZU1y6bLxa4AcnUiX4h9XNu+Q46D0tD2p75wjnfYeUXuGnH2+g2dRuwufz4AW3UJECoCT66QinAw6gFwCyOWExWw49IBmfoXkEk5wDLaPTfHMrk3a4qac9IU5tDQ6sK8uQY4ca6cFIL+Gc4678P5l18VkQdasGDYncvgxEe+4hLwNTNA9LV2f5GpOc+nVPZFj5nMPcEOgc/BETgz232hZJ/Fgsf9tlCuE3wt1hLUOGl2AHAB++//e5cNiREqkA73IzFIz6yVNRZlohPzocW1V3ZLhVLN6CddLGifOrBppzhWVTpa8zn2yqo/U373j5ou9w+n4OA+AyY/n8c4xbq5wyjEzZuGuNR8mKBaRsivpGOTopUEiyBnB46lLa1vv+d5UPyZNHEBurSiZiNjTTv1fBPynmFkhw1Xbh1C3/Qxet2092NRi5e0I5L5qZlMG57prKavvnLso7yvXi05u3kTJDOutOwRBvgBrSmD7ZZ4GnlBKg+EDwBXcRHIdPU9VOw0byRsdnHPHxunxungwcR8JINfGpaWTKZMuPFzZaCF7ps+p2ftJjgYmESGPXlzezHSIIb9q7DRNn8mpczIA8uDFQMMPYw2P2oy6tJa+s0qInlH4WX6zLzAWe4p2ps2ME7hUddXp7wCoIiqkF6RMPTC8vc5AHYEc01nSAk+WoVonyRlz3Z6HkCjb24VmNqZd76pU6oWCF/8jvQWRCWcKyurJJAD8wRMPHhwSQV+W+zuP/oxDWwOSzrn3Zln2yK4WMunHOUfnwomQmLEnVtx2PSRPRnNPcqPR6G1m1hk/VosF7OOB7ugFgtw2IlLGVbcZ0046584gnX20ngLfXNlcPdNvaQSCP7kzT8Ch+f6YYNjMblslM+ccDV9MSpwvpNhPjgapGqPJ7wDIKF3QCTrnjsmybO86/TUAOVLJ87peiRF15lFVlxEVZlbQ2Ve1qfo9eQHMESAiT/M8Xrz2TPUW0QvFgGjmN+Aue53g6LsmHCbc7RnSwQw7nZUSo8NOddlLmkwmAeSY22KvSFb0q3usiFzeZMyKNjdnshjmSC0DkAWCHNk/ykDiugws7wHkKM+p7pFrTwkTogsQE+yo6jRjfKCi2tgb26a8dz08p8ouma8BAD0cps+SfIVm9k+VjXMV6oIcmzrnaIWfyeBSZ/zUus65l2dZRsNYZyUZ5CYj8vrpnGMYEI/M8Uc0rhZi23g94k5eKIEZgiFbyWkIU1frlZi7i8iYyjswGlBp3CpLfMrYTUDOOfeOLMvIItxLcc4xJO/2SwY5qjtOKVlgRsV5DyD3MBE5LtpMfm1mm84TsrdYFpLkhPeH+TzrpLLs5TkGsGEc992iAW6sqr9IHbQJyNG6G/IbL4QePsTIM9qp042/NsjlwO6WzjkmhH5oKjlk0Asx6P5LqQ+nTr3I6HC2mTHYuvfSBORC3op717WSpSxmToLr8VVwgSe5NbpIXoHMbOzF3wPIEZQKhiaGCZrZGsNaBIQv9GSQcd4Qcpu9IUXefdcZjUYHmhkTPOfLQ/wh4kOpYzcBuQD2WzrnmGGNagW6P7EQYNfElwI4X0QujudURm4AgCSmJACgbu83wU3n0FTqqNR1sx6tfvf32bHbkDpuB+Dp+SDbORN4oqoeXmeCderm/ZwAnNZQaXy2qp5dZ9wEkHuXmfEqVSi0JPV0Xd1EVW9QsoaxwnqBIMf8q++PAOW3ZkaDRB8gt7OIFFybQqjg1SsSkNMwFhs37twmfrrO+1NVN39DmdStSxrQFORK3tkbAuA1dovouf6BOXbLbmghNULc1cLkm0S1VPUQUn4n0aaZxUfulKbJdSKjQ3K7qGLnfnJeL7SviFRa+JpOuEY75nM4c4EgR+X40dHHcIGZbd4TyDEs7Zsl8qBubSYXnHPukhLfRfLHFfLI1pBzp1V9MvZbiUghV7G3JJ9kZrGhZOa4XYAcgM047oS1OxpspqfEVQnkPmRmvdEQ8QGISLKOYs5b2AfIUXlMi2Clla/TryPXWd6dxl/h1jC+9uEMPMPa+UMzGye3mXFdpe8l3ZbGBcDeAZSnq+FVJ8uygiEn1CUP2XklMtxKVUup3gHwKlumA6KDeuuETF08TwB3CW4bBRmY2e1S+28LciHR+FHedWe8QUUbF5NMUc9Ov9M15SoDcs65I7MsK4T50Ms8hf4m5UGWHelT2pXU6Rzkwgd4UwAMibtHw3k1ahYMMMf4DeBJjD0Onv2fi+fRE8i9QEQKPHUAvmZm9H0rBTn/MX2RmbuavBf0AJjh9nCPWXrgOW1I9fUIVS2coBo9hBaNPEkGr4d8b+4VAcu5nvC0cGXMbQzUtU/0Z5M/M1KhYJTx7PR0nB87iOcKHfTHDvIcm6GJAB49KzAgWKHp9H7WrGXOALm9VZXvZe9lYddV59wbsyxjwPG4eBeHLYOLycEkKWxrqp/hNNlEgL2AXG7d2/qX7TYLogFnrCZjH2nl5imHbCmMzaTvVaEAOMPMOLe5JTV2lZ2MRqPXm9n0mYfn/gkzox541kmOPzFp0Ue8M27pyWDGBD9IklXnHEOzNonqEKziD3xaxTlHPeyWJTKhUvwiLqVKLj38TqDiKfPvVTUGLH4/MxP0eFDcimkdoznR5a3QDzfA2KlXVZnXeGzQmOGjOO3W/36ZqjLd4xfnrd85x3pT95zQt2NeZoJkidxP7dKNhCB3oTcGdBorNmPBLws+dBTetYNhYOxiAoDH3ae2sbrOCK5u8u7RkhR7vs/tp8rw0GQSXbaZERoUg9ynzOw+VePWBLk1/oE+f+oRWZbtF0COscz3rhoz8ffdPMnDSd6QxtCs2Pm8cAUu+aimoYCJY61CtZnRGAQ5EWkaC76nt6QeXwVypM5nHKsnNPh2lTCcc7w57FRVb/I7QyDNbM/U+lX1CHLUFXXqYTxj0KlJfjQaHW1mBY9tHmkBvMfMCDK1dWsdGR049ceo6rurBJf/fUMAOZ+j9gkh6fPcpdcBOefcqZ77LOZim56UATxeRLqytk+iOWjNpVV3Wpxzh83LyB5vunWe/TLqBuZuWidLM3X1CXI8/TGbmZlx40jyQaUqyfvcnZAaPdE5yI1GozW7bU8Pbl8yYQBg9q1p3F24rzN+bUxyGe74jJogf12St3nQHTTKB1GyVlI+fa2ODNY7yJG+xyeZvl+KHqwmyOVD7CYinW4iQT9IQoTKE2TC83gR81SMRqNXkeo82oQ+Z2Z0TJ5ZAGxK1lvqAxPGWlqVkDGPiZIunDWJPkDOq4P+oqofZhytz2NCEthaxUdtPMNvJq9Jyd/aOcj5cJY1RIG1Zp9emcfP80IWrmmkBB2K/dGUTCbHRi/mmZ6R+IAULi+vzKYpvRZzSNm0fTLoKwK1zhXpyxoD8zWon4jb+JwJOy479pFzcs4xCqSMTYOp945ibs3UrGij0eiNjHaJ1npWHG8YTkd02yg4nIc8qGP6qbCp0UfzOQD28eGAayx3qc8BAK/B+wNgnPWRUbtfpmSACnHaD/T0VPRpZNjh2J9vmSUcAriBMx0oT6kE4rmbP4BbMiVjk3n7WxQNVONvic/Eh2CSJYhMxOTao36ycQFwCxHh86HhiXHw1y8xkHDcE5umIi2bHJ2B29zf6yyYuTcP8h8VFzp5wUlTTreSh8cgN6nDQH4zI3/dvJ2rjKmhztwm8znRzBgaNpRBAvzYqCyPcywsUjI0eFw6yzVjkRNZz2ONd1nnHInr6IvTWwmKyqnJm9Y8xuMxTs0zA9PnqXCSy0/E0+BcHiif31R24pjBhd9kLf+hqu9p0nBoM0hgkMBqSmAMcvSDEZGF+KyE8Wjm305Vzw3/nwtyuZMfUyXyCltI5OGcO7/MSbGOyL2ukBxlWyyLBbbOXIe6gwQGCaRLYAJypH4mawX9t3otIUh/F+/ceGoOvJJALlefPlHkiju/Q6PDUzwN81t7XfzQ+SCBQQILl8BUKQxg55BkxnqexX4xq2vVdbVsPiEJNZkjvk+laMs507udVtUka27LsYbmgwQGCSxQAgXLF/M9UMnf1/hx1EPTk1x+fuFk2JhFJXht8+r8g77WPfQ7SGCQwPIkUAC54LdEi+c47KbLMs8Xq8lJrou5Bd+fPbzRZUy0OZRBAoMENjwJrCHNDHTL1HmR8LDLwtNSIYdkFye5phP0NO5/9sHXDDz+YNM+hnaDBAYJrL4ESpmBeaIjKZ9P9vyM1FCMhKXOJMlb9EmOZJWq+jDPrPDlhHkPVQYJDBJYxxKYS38OYFcAh6gqHYbblqWDXIi7e7eZ0TI7k0Sx7UKH9oMEBgmsjgQqczwwk5GIkLiQ/mmVVDxzlrY0kGO4VoiHY+xcraS8q/OohpkMEhgk0EQClSCX7xQAmUh387FlTFPG0x1J9QiClYWkfz6DfFkOTjojPwTAYZWdpFdgHOkFgSONXFekbP59evOh5iCBQQIbigT+CsiVwM0XmXL2AAAAAElFTkSuQmCC",document.getElementsByClassName("cesium-viewer")[0].appendChild(t)}let i;try{i=await n.json()}catch(t){return void alert("")}if(i){if(this.Vr=i.type||"splat",this.Kr.Vr=this.Vr,this.jr=i.root,t.Mo){const e=Math.floor(1073741824*t.Mo/44/(this.jr.avgCount||15e4));this.Di.Ni=e}this._scene.requestRender(),this.emit("configloaded",null)}}Co(t,e,n,i,r,o,s,a,u){let h=Math.max(t-s,0,s-i),l=Math.max(e-a,0,a-r),c=Math.max(n-u,0,u-o);return Math.sqrt(h*h+l*l+c*c)}Ao(t,e,n){const i=e.bbox;return this.Co(i[0],i[1],i[2],i[3],i[4],n||i[5],t.x,t.y,t.z)}Oo(t,e,n,r,o,s){let a=e;const{enuCenter:u=o,bbox:h,rotate:l,scale:c,depth_Test:f,content:d,geometricError:p}=t,[v,m,y]=u,w=i.Cartesian3.fromDegrees(v,m,y),g=r?e:i.Transforms.eastNorthUpToFixedFrame(w),b=zc(new i.Cartesian3((h[0]+h[3])/2,(h[1]+h[4])/2,(h[2]+h[5])/2),u,g);let _=!1,x=i.Matrix4.IDENTITY.clone();if(r||(_=!0,x=i.Matrix4.multiply(n,g,x)),l){_=!0;const t=i.Math.toRadians(l),e=i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationZ(t));x=i.Matrix4.multiply(x,e,x)}if(c&&1!==c){_=!0;const t=i.Matrix4.fromScale(new i.Cartesian3(c,c,c),new i.Matrix4);x=i.Matrix4.multiply(x,t,x)}return{Io:p,yr:[h[0],h[1],h[2],h[3],h[4],h[5]],qt:!1,rn:!0,hn:f,Si:d.coord,Oe:b,Ae:this.Wr+d.uri,Gt:d.rank,Re:w,To:u,_modelMatrix:a,pr:_?x:void 0,vr:c,mr:l,_o:Dc.init,Gr:this.Gr,Jt:s}}zo(t,e){return t.map((t=>{const n=new i.Cartesian3(t.x,t.y,t.z),r=t.w,o=i.Matrix4.multiplyByPointAsVector(e,n,new i.Cartesian3),s=i.Cartesian3.multiplyByScalar(n,-r,new i.Cartesian3),a=i.Matrix4.multiplyByPoint(e,s,new i.Cartesian3),u=-i.Cartesian3.dot(o,a);return new i.Cartesian4(o.x,o.y,o.z,u)}))}async Ro(t){if(!this.jr)return this.Hr=[],this.Hr;this.Yr=(new Date).getTime(),this.Gr+=1;const e=this.jr,n=new Map,r=[],o=t.camera,s=o.frustum.computeCullingVolume(o.positionWC,o.directionWC,o.upWC).planes;let a=this.jr.enuCenter;const u=a[0],h=a[1],l=a[2],c=i.Cartesian3.fromDegrees(u,h,l),f=i.Transforms.eastNorthUpToFixedFrame(c),d=i.Matrix4.inverse(f,new i.Matrix4),p=this.zo(s,d);let v=Ic(o.positionWC,a);const m=this.oo;let y=!1;const w=(t,u=0)=>{let h=!1,l=!1,c=!1;const{enuCenter:g=a,bbox:b,geometricError:_,content:x,prism:k}=t;y=y||!!k;const $=g[0]===a[0]&&g[1]===a[1]&&g[2]===a[2];let S=p,E=v,M=f;if(!$){const t=i.Cartesian3.fromDegrees(g[0],g[1],g[2]);M=i.Transforms.eastNorthUpToFixedFrame(t);const e=i.Matrix4.inverse(M,new i.Matrix4);E=Ic(o.positionWC,g),S=this.zo(s,e)}const C=new i.Cartesian3(b[0]-m,b[1]-m,b[2]-m),A=new i.Cartesian3(b[3]+m,b[4]+m,b[5]+m),O=new i.AxisAlignedBoundingBox(C,A);if(h=new i.CullingVolume(S).computeVisibility(O)!==i.Intersect.OUTSIDE,h){let i,o;if(k){const t=k[0],e=k[1],n=[];for(let t=2;t<k.length;t+=2)n.push([k[t],k[t+1]]);i=v.z>=t&&v.z<=e&&Ec([v.x,v.y],n,!0)?0:1/0}else i=this.Ao(E,t,e.maxZ);if((0==i||i<=_*this.so[x.uri?u:0]/this.io)&&(l=!0),l){if(x.uri){const e=x.uri;o=this.Di.Yi(e,!1),o||(o=this.Oo(t,f,d,$,a,x.uri),this.Di.Xi(e,o)),o.po=this.Yr,n.has(e)?o.Fo=Math.min(o.Fo,i):(n.set(e,o),o.Fo=i)}if(t.children&&t.children.length){let e=!0,n=!1,i=!1;t.children.forEach((t=>{const[r,o,s]=w(t,x.uri?u+1:0);r&&(i=!0,s||(e=!1),"ADD"==t.refine&&(n=!0))})),e=i&&e,!e||n||"ALWAYS"==t.refine?o&&o._o==Dc.parsed&&(c=!0,-1==r.indexOf(o)&&r.unshift(o)):c=!0}else o&&o._o==Dc.parsed&&(c=!0,-1==r.indexOf(o)&&r.unshift(o))}}return[h,l,c]};w(e),n.size>0&&0==this.Kr.Do&&(this.Kr.Do=performance.now()),this.Ar&&await this.Po(n),this.Hr=r.filter((t=>t.rn&&t.oe)),y&&this.Hr.length>1&&(this.Hr=[this.Hr[this.Hr.length-1]]),this.Br=n;const g=i.Cartographic.fromCartesian(o.positionWC);return this.No([180*g.longitude/Math.PI,180*g.latitude/Math.PI,g.height],this.no),this.Hr}Xe(t,e){let n=t[2]*e[2]+t[6]*e[6]+t[10]*e[10];const i=(t[2]**2+t[6]**2+t[10]**2)**.5,r=(e[2]**2+e[6]**2+e[10]**2)**.5;return Math.abs(n/i/r-1)>.01}async Po(t){if(!this.Ar)return;const e=qc(t.values()).filter((t=>t._o==Dc.init)),n=e.map((t=>t.Jt)).filter((t=>void 0!==t));if(0===n.length)return;const i=await this.Ar.getMultiple(n);for(const t of e){const e=t.Jt;if(e&&t._o===Dc.init){const n=i.get(e);n&&(t._o=Dc.loading,this.Ge({texdatas:n.buffers,...n.metadata},!0))}}}Uo(t){let e=this.Hr;if(!e.length)return;e.sort(((t,e)=>t.Gt==e.Gt?t.Fo>e.Fo?-1:1:t.Gt<e.Gt?-1:1));const n=e[e.length-1].Gt,r=this.ao;if(r&&n-e[0].Gt>=r){const t=n-r;e=e.filter((e=>e.Gt>t))}const o=t.camera.viewMatrix,s=t.camera.frustum.projectionMatrix,a=(new Date).getTime();let u=!1;if(0==this.Fe||this.Ue&&this.Ue.Zt.buffer.detached)return;const h=e.map((t=>t.Ae)).sort().join("|");if(this.Te?((0==this.Kr.Sr.length||a-this.Te>400)&&this.Lr!==h||this.Xe(this.ze,o))&&(u=!0):u=!0,u){this.Te=a,this.ze=o.clone(),this.Lr=h,this.Fe=!1;const t=[this.Ue.Zt.buffer],n={te:this.Ie,Qe:o,Zt:this.Ue.Zt,jt:this.jt,Ut:e.map((e=>{t.push(e.Vt);const n=new i.Matrix4;return i.Matrix4.multiply(o,e._modelMatrix,n),i.Matrix4.multiply(s,n,n),{Gt:e.Gt||0,Wt:e.Ae,Jt:e.Jt,Vt:e.Vt,Ht:n,qt:e.qt,Lt:e.Lt,Bt:e.Bt,Yt:e.oe,Kt:e.Kt?.map((t=>({Qt:t.Qt,_id:t._id})))}}))};yl.busy=!0,yl.postMessage(n,t)}}qo(){if(this.Hr.length)return this.Ue}async jo(){const t=qc(this.Br.values()).filter((t=>t._o==Dc.init));t.sort(((t,e)=>t.Gt==e.Gt?t.Fo<e.Fo?-1:1:t.Gt<e.Gt?-1:1));let e=t;if(this.Ar){const n=t.map((t=>t.Jt)),i=await Promise.all(n.map((t=>this.Ar.has(t))));e=t.filter(((t,e)=>!i[e]))}this.Kr.loads(e)}Lo(t,e){const n=t+"."+this.Vr,i=this.Di.Yi(n,!1);i&&(i.rn=e)}Bo(t){const{x:e,y:n,z:i}=Mc(t,this.jr?.enuCenter);for(let t=0,s=this.kr.length;t<s;t+=1)if(r=[e,n,i],o=this.kr[t].yr,r[0]>=o[0]&&r[1]>=o[1]&&r[2]>=o[2]&&r[0]<=o[3]&&r[1]<=o[4]&&r[2]<=o[5]&&Ec([e,n],this.kr[t].gr))return this.kr[t];var r,o;return null}Ye(t,e){if(t){for(let n=0,i=this.kr.length;n<i;n+=1)if(this.kr[n].id==t){this.Ue.qe=n+1,this.Ue.je=e?.fillColor||void 0;break}}else this.Ue.qe=0}Ho(){return this.Hr}ho(t,e){const n=t,i=this.Di.Yi(n,!0);if(i){if(e||this.Br.has(n))return i._o=Dc.loading,!0;this.Di.Ji(n)}return!1}lo(t){const e=this.Di.Yi(t.uri,!0);e&&(e._o=Dc.failed)}fo(){this.emit("preloadComplete",null)}co(t){const e=this.Di.Yi(t.uri,!0);e&&(e.oe=t.totalVertexCount,e.Yt=t.totalVertexCount,e.dr=t.data,e._o=Dc.loaded,e.qt=t.hasSH,this.Xr.postMessage({ar:[{yr:e.yr,dr:e.dr.buffer,Be:[0,0,0],Yt:t.totalVertexCount,cr:t.isCompressed,pr:e.pr,vr:e.vr,mr:e.mr,Re:e.To,Qt:t.offsets,_r:t.types,Wt:e.Ae,Jt:e.Jt}],lr:this.jr?.clipZ,ur:t.isPly,qt:t.hasSH,Re:this.xo()?.enuCenter,jt:this.jt,oe:t.totalVertexCount,hr:t.isPly&&t.types.red&&t.totalVertexCount>15e6?5e6:0,Wt:e.Ae,te:this.Ie,Si:e.Si,Jt:e.Jt},[e.dr.buffer]))}No(t,e=1e3){if(this.jr){this.ro=!0;let n=this.jr.enuCenter;t=t||n;const r=n[0],o=n[1],s=n[2],a=i.Cartesian3.fromDegrees(r,o,s),u=i.Transforms.eastNorthUpToFixedFrame(a),h=i.Matrix4.inverse(u,new i.Matrix4),l=Mc(t,n),c=new Map,f=i=>{for(let r=0,o=i.length;r<o;r+=1){const o=i[r],{enuCenter:s=n,content:a}=o,d=a.rank,p=s[0]===n[0]&&s[1]===n[1]&&s[2]===n[2],v=p?l:Mc(t,s);if(this.Ao(v,o)<=e){const t=this.Wr+a.uri,e=a.uri;if(e&&!this.Di.Yi(e,!0)){const i=this.Oo(o,u,h,p,n,e),r=this.Di.Xi(e,i);if(c.get(d)||c.set(d,[]),c.get(d)?.push({url:t,uri:e}),r)return r}if(o.children&&f(o.children))return!0}}},d=this.jr;f([d]),qc(c.keys()).forEach((t=>{const e=c.get(t);for(let t=0,n=e.length;t<n;t+=1)this.Kr.Wo(e[t])}))}}}class Yc{Vo=12;Sr=[];Go=[];Yo=[];Xi=new Set;Ko=0;Vr="";Er=0;Do=0;ho;lo;co;fo;Eo;So;Xo=[];constructor(t,e){this.Eo=t,this.So=e,this.Vo=6*(this.So?.length||1)}clear(){this.Sr=[],this.Go=[],this.Xi.clear(),this.Ko=0}loads(t){t.forEach((t=>{if(this.Xi.has(t.Ae)){const e=this.Sr.indexOf(t.Ae);this.Sr.splice(e,1),this.Go.splice(e,1)}else this.Xi.add(t.Ae);this.Sr.push(t.Ae),this.Go.push(t.Jt)})),t.length,this.Qo()}Wo(t){this.Xi.has(t.url)||(this.Yo.push(t.url),this.Xo.push(t.uri),this.Xi.add(t.url),this.Qo())}async Qo(){if(this.Ko<this.Vo&&(this.Sr.length||this.Yo.length)){this.Ko++;const t=this.Vr;let e=this.Sr.shift(),n=this.Go.shift(),i=!1;if(e||(e=this.Yo.shift(),n=this.Xo.shift(),i=!0),this.Xi.delete(e),!this.ho(n,i))return this.Ko--,void this.Qo();let r=e;this.So&&this.Eo&&(r=e.replace(this.Eo,this.So[this.Er%this.So.length]),this.Er+=1);const o=await fetch(r,{cache:"default",mode:"cors",credentials:"omit"});if(200!==o.status&&304!==o.status)return this.lo({url:e,uri:n,message:o.status}),this.Ko--,void this.Qo();const s=parseInt(o.headers.get("content-length"));if(!s)return this.lo({url:e,uri:n,message:"empty"}),this.Ko--,void this.Qo();const a=await o.arrayBuffer();let u,h=new Uint8Array(a),l=!1,c=!1;const f={},d={};let p=!1;if("bin"==t||e.endsWith("bin"))u=new Uint32Array(a,0,2)[1],l=!0,p=1==new Float32Array(a,8,18)[10];else if("splat"==t||e.endsWith("splat"))u=s/32;else if("ply"==t||e.endsWith(".ply")){c=!0;const t=h,e=(new TextDecoder).decode(t.slice(0,10240)),n="end_header\n",i=e.indexOf(n);u=parseInt(/element vertex (\d+)\n/.exec(e)[1]);const r={double:"getFloat64",int:"getInt32",uint:"getUint32",float:"getFloat32",short:"getInt16",ushort:"getUint16",uchar:"getUint8"};let o=0;for(let t of e.slice(0,i).split("\n").filter((t=>t.startsWith("property ")))){const[e,n,i]=t.split(" "),s=r[n]||"getInt8";f[i]=s,d[i]=o,o+=parseInt(s.replace(/[^\d]/g,""))/8}p=!!f.f_rest_44;const s=i+n.length;h=t.slice(s)}this.co({url:e,data:h,isCompressed:l,isPly:c,totalVertexCount:u,offsets:d,types:f,hasSH:p,uri:n}),this.Ko--,this.Qo()}else this.Sr.length||this.Ko||this.fo&&(this.fo(),this.Do)}}class Kc{Zo;Jo="";ts=!1;es;ns;rs;_show=!0;ss;Ln;us;hs;Ut;ls;cs;fs;ds;ps;vs;pe=0;constructor(t){this.us=t,this.vs=t.cb,this.Ln=t.viewer,this.Ut=t.tiles,this.hs=t.api_url,this.cs={},this.ls=[],this.ds={},this.ps=[],this.fs=new Bc({Pi:10,Fi:this.onDrop}),this.es=new i.Event,this.ns=new i.Event,this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this.init()}init(){this.vs&&this.vs(this.Zo)}initMonomer(t,e,n){const i=e.points,r=e.indexes;for(let e=0;e<r.length;e+=3){const o=r[e],s=r[e+1],a=r[e+2];t.push({monomer_id:n,points:[i[o],i[s],i[a]]})}}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}onDrop=(t,e)=>{delete this.cs[t],this.ds=[],this.ps=[],this.ls=[],this.pe=0,this.Zo.removeAll();for(let t in this.cs)this.ls=this.ls.concat(this.cs[t]);let n=this.pe;for(let t of this.ls)this.ds[n]=t,this.initMonomer(this.ps,t,n),n++;return!0};updateData(t){for(let e of t)this.fs.Zi(e)||(this.fs.Xi(e,"1"),fetch(this.hs+e+"_triangle.json").then((t=>t.json())).then((t=>{this.cs[e]=t,this.ls=[];for(let t in this.cs)this.ls=this.ls.concat(this.cs[t]);let n=this.pe;for(let t of this.ls)this.ds[n]=t,this.initMonomer(this.ps,t,n),n++})).catch((t=>{})));return!0}update(){return!0}pick(t){let e=!1,n="";for(let r of this.ps){const o=i.Cartesian3.fromDegrees(r.points[0][0],r.points[0][1],r.points[0][2]),s=i.Cartesian3.fromDegrees(r.points[1][0],r.points[1][1],r.points[1][2]),a=i.Cartesian3.fromDegrees(r.points[2][0],r.points[2][1],r.points[2][2]);if(i.IntersectionTests.rayTriangle(t,o,s,a)){e=!0,n=r.monomer_id;break}}return e?this.ds[n]:null}}class Xc{Ln;ys;ve=!1;constructor(t){const e=t.viewer;this.Ln=e,this.ys=new Kc(t),e.dataSources.add(this.ys)}setVisibility(t,e){this.ys&&(this.ys.show=e)}hide(){this.ys&&(this.ys.entities.show=!1)}show(){this.ys&&(this.ys.entities.show=!0)}destory(){this.ys&&(this.ys.entities.removeAll(),this.Ln?.dataSources.remove(this.ys),this.ys=void 0),this.ve=!0,this.Ln=void 0}getEntities(){return this.ys?.entities}pick(t){return this.ys?.pick(t)}update(t){return this.ys?.updateData(t)}}class Qc extends Cl{ws;Ln;an;rn=!0;ve=!1;gs;bs=.1;_s=1/0;xs=-1/0;ks;$s;Ss;Es={enable:!1,color:new i.Color(1,1,1),intensity:1,direction:new i.Cartesian3(1,1,1)};xn={enable:!1,ambientColor:new i.Color(.9,.9,.9),lightColor:new i.Color(1,1,1),lightIntensity:1,lightDirection:new i.Cartesian3(1,1,1)};Ms={metallic:0,roughness:.8};so=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];constructor(t){super();const e=t.viewer;this.Ln=e;const n=e.scene;this.ws=new Gc({io:t.lodFactor||1,do:t.cacheSize||2e3,Mo:t.cacheMemorySize,no:t.loadBuffer||0,oo:t.renderBuffer||10,Ae:t.url||"",ce:n.context,kr:t.entityInfos||[],yo:t.tileSetData||null,so:this.so,ao:t.maxLevelRange,$r:t.workers,mo:t.cacheNetworkSize,_scene:n}),this.ws.on("configloaded",(()=>{this.emit("configloaded",this.ws.xo());const t=this.ws.xo();if(t){const{enuCenter:e,bbox:n}=t,r=Math.sqrt(Math.pow(n[3]-n[0],2)+Math.pow(n[4]-n[1],2)+Math.pow(n[5]-n[2],2))/2;new i.BoundingSphere(i.Cartesian3.fromDegrees(e[0],e[1],e[2]),r)}})),this.ws.on("todrawtile",(t=>{this.emit("todrawtile",t)})),this.Ms=Object.assign(this.Ms,t.material),this.Es=Object.assign(this.Es,t.sunLight),this.xn=Object.assign(this.xn,t.light),t.maxPitch&&this.setMaxPitch(t.maxPitch),(t.minHeight||t.minRange||t.maxRange)&&this.setMinHeight(t.minHeight,t.minRange,t.maxRange),this.an=new Ol({scene:n,hn:t.depthTest||!1,jt:this.ws.jt,gn:t.pass,bn:t.filter,xn:t.light,_n:t.material,$n:t.modelColor||new i.Color(0,0,0,0)}),this.an.on("renderfirstframe",(t=>{this.emit("renderfirstframe",t)})),t.monomerConfig&&(this.ks=new Xc({name:"",viewer:e,tiles:[],api_url:t.monomerConfig.api_url}),this.Ss=t.monomerConfig.highlight_color),this.ws.Qr=t=>{this.an.jn(t)},this.ws.Zr=()=>{this.Ln?.scene.requestRender()};let r=!1;n.preRender.addEventListener((async(t,e)=>{if(this.rn&&!this.ve){if(!r){r=!0;try{const e=await this.ws.Ro(t);e?.length?(this.Cs(e),this.ks&&this.As(e),this.an._show()):this.an.Nn(),await this.ws.jo()}finally{r=!1}}this.ws.Uo(t),this.an.Pn()}}),this);const o=n.globe.render;n.globe.render=t=>{o.call(n.globe,t),this.Os(t)}}preLoad(t,e=1e3,n){if(this.Ln){this.ws.clear("preloadComplete"),this.ws.on("preloadComplete",(()=>{this.ws.clear("preloadComplete"),n&&n()}));const i=this.getCameraPos();this.ws.xo()?this.ws.No(t||[i.lng,i.lat,i.height],e):this.ws.on("configloaded",(()=>{this.ws.No(t||[i.lng,i.lat,i.height],e)}))}}set lodFactor(t){this.ws.io=Math.max(1e-5,Math.min(300,t)),this.Ln?.scene.requestRender()}set light(t){this.xn=t,this.an.Tn(t)}get light(){return this.xn}set material(t){this.Ms=t,this.an.zn(t)}get material(){return this.Ms}set sunLight(t){this.Es={enable:t.enable,direction:this.Is()||new i.Cartesian3(1,1,1),color:t.color||this.Es&&this.Es.color,intensity:t.intensity},this.updateSunLight()}get sunLight(){return this.Es}getIndexDB(){return this.ws.$o()}updateSunLight(){this.Es&&this.Es.enable&&(this.Es.direction=this.Is()||new i.Cartesian3(1,1,1),this.an.Tn({enable:!0,ambientColor:this.xn?.ambientColor||new i.Color(1,1,1),lightColor:this.Es.color,lightIntensity:this.Es.intensity,lightDirection:this.Es.direction}))}setEnuCenter(t){this.an.On(t)}setScaleByLod(t){this.so=t,this.ws.bo(t)}Is(){if(!this.Ln||!this.Ln.clock)return;const t=this.getEnuCenter();if(!t)return;const e=new i.Cartesian3,n=new i.Cartesian3,r=this.Ln.clock.currentTime;i.Simon1994PlanetaryPositions.computeSunPositionInEarthInertialFrame(r,e);const o=i.Transforms.computeTemeToPseudoFixedMatrix(r);return i.Matrix3.multiplyByVector(o,e,e),i.Cartesian3.normalize(Ic(e,t,new i.Cartesian3),n),n}Cs(t){}Os(t){const e=t.commandList,n=[],i=[];for(const t of e)t.Rn?n.push(t):i.push(t);t.commandList=[...i,...n]}As(t){const e=[];if(t.length>0)for(let n of t){const t=n.Si;if(!t)continue;const i=t[0];if(14===i)e.push(t.join("_"));else{const n=i-14,r=[t[0]-n,t[1]>>n,t[2]>>n];e.push(r.join("_"))}}const n=[...new Set(e)];this.ks&&this.ks.update(n)}getTileSetUrl(){return this.ws.Ae}getEnuCenter(){return this.ws.xo()?.enuCenter}getLimitBounds(){return this.ws.xo()?.limitBounds}getBaseHeight(){const t=this.ws.xo();return t?Math.max(0,t.bbox[2]+t.enuCenter[2]):0}setMaxPitch(t){void 0!==t?(t=t*Math.PI/180,this.gs=t,this.Ln.camera.rotateUp=function(e){t&&(e&&this.pitch+e>t+.2*Math.PI/180&&(e=t-this.pitch),i.Camera.prototype.rotateUp.call(this,e))}):(this.gs=void 0,this.Ln.camera.rotateUp=i.Camera.prototype.rotateUp)}getMaxPitch(){return this.gs||0}setMinHeight(e,n,r){if(void 0!==e||void 0!==n||void 0!==r){this.bs=e,this._s=n,this.xs=r;const o=this.Ln.scene,s=this.Ln;this.Ln.camera.move=function(a,u){let h;const l=o.pickFromRay({direction:a,origin:this.positionWC});if(l&&l.position?h=l.position:s?.trackedEntity&&(h=s.trackedEntity.position?.getValue(s.clock.currentTime)),h){const i=t.Cartesian3.distance(h,this.positionWC);e&&u>0&&i*Math.cos(this.pitch+Math.PI/2)<e&&(u=0),n&&u>0&&i<n&&(u=0),r&&u<0&&i>r&&(u=0)}i.Camera.prototype.move.call(this,a,u)}}else this.bs=void 0,this._s=void 0,this.xs=void 0,this.Ln.camera.move=i.Camera.prototype.move}getMinHeight(){return this.bs||0}set depthTest(t){this.an.hn=t}setVisibility(t,e){this.ws.Lo(t,e)}hide(){this.rn=!1,this.an.Nn()}show(){this.rn=!0,this.an._show()}destory(){this.setMaxPitch(),this.setMinHeight(),this.ws._destroy(),this.an._destroy(),this.ve=!0,this.Ln=void 0,this.ve=!0}pickPosition(t){const e=this.Ln.scene.pickPosition(t);if(i.defined(e)){var n=i.Cartographic.fromCartesian(e),r=i.Math.toDegrees(n.longitude),o=i.Math.toDegrees(n.latitude),s=n.height;return{lnglat:{lng:Sc(r,6),lat:Sc(o,6),alt:Sc(s,1)},ecef:e,target:this}}return null}pickEntity(t){const e=this.Ln.scene.pickPosition(t);if(i.defined(e)){var n=i.Cartographic.fromCartesian(e),r=i.Math.toDegrees(n.longitude),o=i.Math.toDegrees(n.latitude),s=n.height;return this.ws.Bo([r,o,s])}return null}selectedEntity(t,e){this.ws.Ye(t,e),1==this.ws.Fe&&this.an.jn(this.ws.Ue)}getCameraPos(){if(this.Ln){var t=i.Cartographic.fromCartesian(this.Ln.camera.position),e=this.Ln.camera;return{lng:i.Math.toDegrees(t.longitude),lat:i.Math.toDegrees(t.latitude),height:t.height,heading:i.Math.toDegrees(e.heading),pitch:i.Math.toDegrees(e.pitch),roll:0}}}$i(){return this.ws.Ho()}pickMonomer(t){const e=this.Ln;if(e){const a=e.camera.getPickRay(t.position),u=e.scene.camera.positionCartographic,h=i.Math.toDegrees(u.longitude),l=i.Math.toDegrees(u.latitude);new i.Cartesian3(h,l,u.height);var n=e.camera.pickEllipsoid(new i.Cartesian2(t.position.x,t.position.y));if(n){var r=i.Cartographic.fromCartesian(n),o=i.Math.toDegrees(r.longitude),s=i.Math.toDegrees(r.latitude);if(new i.Cartesian3(o,s,0),this.ks){const t=this.ks.pick(a);if(t){this.$s&&e.entities.remove(this.$s);let n=[];const r=t.contours;for(let e of r){const i=parseFloat(e[0]),r=parseFloat(e[1]),o=t.max_height;n.push(i),n.push(r),n.push(o)}let o="RGBA(255,0,0,0.3)";return this.Ss&&(o=this.Ss),this.$s=e.entities.add({name:"polygon",polygon:{hierarchy:i.Cartesian3.fromDegreesArrayHeights(n),material:i.Color.fromCssColorString(o),extrudedHeight:t.min_height,perPositionHeight:!0}}),{id:t.id,contours:t.contours,max_height:t.max_height,min_height:t.min_height}}}}}}pickMonomerReset(){const t=this.Ln;t&&this.$s&&t.entities.remove(this.$s)}}const Zc=new i.Cartesian3,Jc=new i.Cartesian3,tf=new i.Cartesian3,ef=new i.Cartesian3(0,0,1);class nf{Ts;zs;constructor(t=1,e=1,n=.1){this.Ts=new i.Cartesian3(t,e,n),this.zs=0}Rs(t,e){const n=i.Cartesian3.subtract(e,t,new i.Cartesian3);n.z<0?this.zs=i.Cartesian3.magnitude(i.Cartesian3.divideComponents(n,this.Ts,n)):this.zs=i.Cartesian3.magnitude(new i.Cartesian3(n.x,n.y,0))}Fs(t,e=!1){t=i.Cartesian3.divideComponents(t,this.Ts,t),t=i.Cartesian3.normalize(t,t),t=i.Cartesian3.multiplyComponents(t,this.Ts,t);const n=new i.Cartesian3;if(i.Cartesian3.multiplyByScalar(t,this.zs,n),e&&n.z>0){const t=i.Cartesian3.dot(n,ef);i.Cartesian3.multiplyByScalar(ef,t,Zc),i.Cartesian3.multiplyByScalar(i.Cartesian3.normalize(i.Cartesian3.fromElements(n.x,n.y,0,tf),tf),this.zs,tf),i.Cartesian3.add(n,i.Cartesian3.multiplyByScalar(i.Cartesian3.subtract(i.Cartesian3.add(tf,Zc,Jc),n,Jc),2,Jc),Jc),n.x=Jc.x,n.y=Jc.y}return n.x=Math.round(100*n.x)/100,n.y=Math.round(100*n.y)/100,n.z=Math.round(100*n.z)/100,n}}var rf;class of{Ze;rn=!1;ve=!1;_texture;Ds;constructor(t,e){this._texture=t,this.Ds=e}update(t){this.ve||this.rn&&(this.Ds.Ps()||(this._texture.Ns(),t.commandList.unshift(this.Ze)))}isDestroyed(){return this.ve}show(){0==this.rn&&(this.rn=!0)}hide(){this.rn&&(this.rn=!1)}destroy(){this.ve=!0,this.Ze.vertexArray.getAttribute(0).vertexBuffer.destroy(),this.Ze.vertexArray.ln=[],this.Ze.vertexArray.destroy()}}class sf{us;Us;qs;js;Ls;Bs;Hs;rn=!0;Ws;Vs=!0;destroyed=!1;constructor(t){t.autoHide=null==t.autoHide?exports.AUTOHIDE_MODE.AUTO:t.autoHide,t.autoHideDistance=null==t.autoHideDistance?50:t.autoHideDistance,t.autoHideAngle=null==t.autoHideAngle?15:t.autoHideAngle;const e=t.viewer;this.Ws=new nf(1,1,1),this.us=t,e.scene,this.Us=i.Cartesian3.fromDegrees(this.us.pos[0],this.us.pos[1],this.us.pos[2]),this.js=i.Transforms.localFrameToFixedFrameGenerator("north","west"),(t=>new Promise(((e,n)=>{!function n(){t.terrainProvider?setTimeout((()=>{e()}),2e3):setTimeout(n,300)}()})))(this.us.viewer).then((async()=>{this.Hs=(await i.sampleTerrain(this.us.viewer.terrainProvider,13,[i.Cartographic.fromCartesian(this.Us)]))[0]?.height||0,this.Gs(),this.Ys()}))}Ps(){if(this.us.autoHide==exports.AUTOHIDE_MODE.NO)return!1;if(this.us.autoHide==exports.AUTOHIDE_MODE.ALL||this.us.autoHide==exports.AUTOHIDE_MODE.AUTO&&!this.Vs){const t=this.us.viewer.camera;if(i.Cartesian3.distance(t.positionWC,this.Us)>this.us.autoHideDistance)return!0;if(Math.abs(i.Math.toDegrees(t.heading)-this.us.heading)>this.us.autoHideAngle)return!0;if(Math.abs(i.Math.toDegrees(t.pitch)-this.us.pitch)>this.us.autoHideAngle)return!0}return!1}getPosition(){return this.Us}async setPos(t){this.us.pos=t,this.Us=i.Cartesian3.fromDegrees(t[0],t[1],t[2]),this.Hs=(await i.sampleTerrain(this.us.viewer.terrainProvider,13,[i.Cartographic.fromCartesian(this.Us)]))[0]?.height||0,this.Gs()}setOpacity(t){"number"==typeof t&&(this.us.opacity=t)}setInternalParams(t,e,n){this.us.resolution=t,this.us.fov_vertical=e,this.us.fov_horizontal=n,this.Gs()}setHeadingAndPitch(t,e){const n=typeof t,i=typeof e;"number"!=n&&"undefined"!=n||"number"!=i&&"undefined"!=i||this.Gs(t,e)&&(void 0!==t&&(this.us.heading=t),void 0!==e&&(this.us.pitch=e))}Gs(e,n){const r=this.us.resolution[0]/this.us.resolution[1];var o=i.Math.toRadians(this.us.fov_vertical),s=this.us.fov_horizontal?i.Math.toRadians(this.us.fov_vertical):2*Math.atan(Math.tan(o/2)*r);e=i.Math.toRadians(null==e?this.us.heading:e),n=i.Math.toRadians(null==n?this.us.pitch:n),this.Ks(e,n,0,0,0);const a=this.Us,u=new i.Camera(this.us.viewer.scene);u.position=this.Us;let h=new i.HeadingPitchRoll(e,n,0),l=i.Transforms.headingPitchRollToFixedFrame(this.Us,h,i.Ellipsoid.WGS84,this.js),c=i.Matrix4.multiplyByPointAsVector(l,i.Cartesian3.UNIT_X,new i.Cartesian3);u.direction=c,u.frustum.aspectRatio=r,u.frustum.fov=r>1?s:o,u.frustum.near=1,u.frustum.far=1e4,u.setView({destination:this.Us,orientation:{heading:e,pitch:n,roll:0}});var f=u.frustum.projectionMatrix,d=i.Matrix4.multiply(u.viewMatrix,i.Matrix4.fromTranslation(a),new i.Matrix4),p=i.Matrix4.multiply(f,d,new i.Matrix4);this.Bs=p;const v=[],m=16;if(this.us.mode){const i=this.us.pos[2]-this.Hs,r=new t.Cartesian3(0,0,0),u=new t.Cartesian3(0,0,-i);this.Ws.Rs(r,u);let h=-s/2,l=o/2,c=(-o/2-l)/m;for(let t=0;t<=m;t+=1){const i=this.Xs(e,n,0,h,l+c*t);v.push(i.x-a.x,i.y-a.y,i.z-a.z)}h=s/2;for(let t=0;t<=m;t+=1){const i=this.Xs(e,n,0,h,l+c*t);v.push(i.x-a.x,i.y-a.y,i.z-a.z)}}else{let i=-o/2,r=(o/2-i)/m,u=-s/2,h=t.Cartesian3.fromDegrees(this.us.pos[0],this.us.pos[1],this.Hs);for(let t=0;t<=m;t+=1){const o=this.Qs(e,n,0,u,i+r*t);let s=this.Zs(o);s?h=s:(s=this.Js(h,o),this.Vs=!1),v.push(s.x-a.x,s.y-a.y,s.z-a.z)}u=s/2;for(let t=0;t<=m;t+=1){const o=this.Qs(e,n,0,u,i+r*t);let s=this.Zs(o);s?h=s:(s=this.Js(h,o),this.Vs=!1),v.push(s.x-a.x,s.y-a.y,s.z-a.z)}}if(this.Ls=v,this.qs?.Ze){const t=this.qs.Ze.vertexArray.getAttribute(0).vertexBuffer;t?.copyFromArrayView(new Float32Array(v))}return!0}Js(e,n){const i=new t.Cartesian3(0,0,0),r=Ic(e,this.us.pos);return this.Ws.Rs(i,r),zc(this.Ws.Fs(n),this.us.pos)}Zs(e){let n=zc(e,this.us.pos);n=t.Cartesian3.subtract(n,this.Us,new t.Cartesian3);var r=new i.Ray(this.Us,n),o=new i.Ellipsoid(i.Ellipsoid.WGS84.radii.x+this.Hs,i.Ellipsoid.WGS84.radii.y+this.Hs,i.Ellipsoid.WGS84.radii.z+this.Hs),s=i.IntersectionTests.rayEllipsoid(r,o);return s?i.Ray.getPoint(r,s.start):null}Qs(e,n,r,o,s){o=Math.tan(o),s=Math.tan(s);let a=new i.Cartesian3;a=i.Cartesian3.normalize(new t.Cartesian3(o,1,s),a);let u=i.Matrix3.fromRotationX(n),h=i.Matrix3.fromRotationZ(-e),l=i.Matrix3.fromColumnMajorArray([a.x,a.y,a.z,0,0,0,0,0,0]);return l=i.Matrix3.multiply(u,l,new i.Matrix3),l=i.Matrix3.multiply(h,l,new i.Matrix3),i.Matrix3.getColumn(l,0,new t.Cartesian3)}Xs(t,e,n,i,r){const o=this.Qs(t,e,n,i,r);return zc(this.Ws.Fs(o),this.us.pos)}hide(){this.rn=!1,this.qs?.hide()}show(){this.rn=!0,this.qs?.show()}destroy(){this.qs?.destroy(),this.qs=void 0,this.Bs=void 0,this.destroyed=!0}focus(t,e){(e||this.us.viewer).camera.setView({destination:this.Us,orientation:{heading:i.Math.toRadians(this.us.heading),pitch:i.Math.toRadians(this.us.pitch),roll:0}}),t&&this.show()}Ks(e,n,r,o,s){let a=new i.HeadingPitchRoll(e,n,r),u=i.Transforms.headingPitchRollToFixedFrame(this.Us,a,i.Ellipsoid.WGS84,this.js);o=Math.tan(o),s=Math.tan(s);let h=new i.Cartesian3;h=i.Cartesian3.normalize(new t.Cartesian3(1,o,s),h);let l=i.Matrix4.multiplyByPointAsVector(u,h,new i.Cartesian3);var c=new i.Ray(this.Us,l),f=this.Hs,d=new i.Ellipsoid(i.Ellipsoid.WGS84.radii.x+f,i.Ellipsoid.WGS84.radii.y+f,i.Ellipsoid.WGS84.radii.z+f),p=i.IntersectionTests.rayEllipsoid(c,d);return p?i.Ray.getPoint(c,p.start):null}Ys(){var t=document.createElement("video");t.style.cssText="position:fixed;top:0;right:0",t.width=400,t.muted=!0,t.autoplay=!0,t.loop=!0,t.style.display="none",document.body.appendChild(t),t.src=this.us.url,t.crossOrigin="anonymous",t.load(),t.play();const e=[];for(let t=0;t<16;t+=1)e.push(t,t+16+1,t+16+2),e.push(t,t+16+2,t+1);var n=new Uint16Array(e);t.addEventListener("loadeddata",(()=>{const e=this.us.viewer.scene.context,r=i.FeatureDetection.supportsWebgl2&&i.FeatureDetection.supportsWebgl2(this.us.viewer.scene),o=i.ShaderProgram.fromCache({context:e,vertexShaderSource:r?"#version 300 es\nprecision highp int;precision highp float;in vec3 position;out vec3 pos;uniform vec3 u_delta;uniform mat4 u_vp2;void main(){gl_Position=u_vp2*vec4(position,1.0f);pos=position;}":"#version 300 es\nprecision highp int;precision highp float;in vec3 position;in vec2 coord;out vec2 texCoord;void main(){gl_Position=czm_modelViewProjection*vec4(position,1.0f);texCoord=coord;}",fragmentShaderSource:r?"#version 300 es\nprecision highp float;uniform highp sampler2D u_video;uniform mat4 u_vp;uniform float u_opacity;in vec3 pos;void main(){vec4 proj=(u_vp*vec4(pos,1.0f));vec2 uv=proj.xy/proj.w+vec2(1,1);vec4 c=texture(u_video,uv/2.0f);c.a=u_opacity;out_FragColor=c;}":"#version 300 es\nprecision highp float;in vec2 texCoord;uniform highp sampler2D u_video;void main(){highp vec4 c=texelFetch(u_video,texCoord,0.0f);out_FragColor=c;}",attributeLocations:{position:0}}),s={enabled:!0,equationRgb:i.BlendEquation.ADD,equationAlpha:i.BlendEquation.ADD,functionSourceRgb:i.BlendFunction.SOURCE_ALPHA,functionDestinationRgb:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:i.BlendFunction.ONE,functionDestinationAlpha:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA},a=i.RenderState.fromCache({depthTest:{enabled:!1},blending:s,depthMask:!0,colorMask:{red:!0,green:!0,blue:!0,alpha:!0}}),u=(()=>{const n=new i.Texture({name:"camera",context:e,source:t,flipY:!0,sampler:new i.Sampler({minificationFilter:i.TextureMinificationFilter.NEAREST,magnificationFilter:i.TextureMagnificationFilter.LINEAR})});return n.Ns=()=>{n.copyFrom({source:t})},n})();this.qs=new of(u,this),this.rn||this.qs.hide();const h={u_video:()=>u,u_vp:()=>this.Bs,u_vp2:()=>{let t=this.us.viewer.camera.frustum.projectionMatrix;var e=i.Matrix4.multiply(this.us.viewer.camera.viewMatrix,i.Matrix4.fromTranslation(this.Us),new i.Matrix4);return i.Matrix4.multiply(t,e,new i.Matrix4)},u_delta:()=>this.Us,u_opacity:()=>void 0!==this.us.opacity?this.us.opacity:1},l=new i.VertexArray({name:"camera",context:e,attributes:[{index:0,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:new Float32Array(this.Ls),context:e}),componentsPerAttribute:3,componentDatatype:i.ComponentDatatype.FLOAT}],indexBuffer:i.Buffer.createIndexBuffer({context:e,typedArray:n,usage:i.BufferUsage.STATIC_DRAW,indexDatatype:i.IndexDatatype.UNSIGNED_SHORT})}),c=new i.DrawCommand({vertexArray:l,shaderProgram:o,uniformMap:h,renderState:a,pass:i.Pass.OPAQUE,count:96});this.qs.Ze=c,this.us.viewer.scene.primitives.add(this.qs),this.rn&&this.qs.show()}))}}exports.AUTOHIDE_MODE=void 0,(rf=exports.AUTOHIDE_MODE||(exports.AUTOHIDE_MODE={}))[rf.NO=0]="NO",rf[rf.ALL=1]="ALL",rf[rf.AUTO=2]="AUTO";var af=6371008.8,uf={centimeters:637100880,centimetres:637100880,degrees:360/(2*Math.PI),feet:20902260.511392,inches:39.37*af,kilometers:6371.0088,kilometres:6371.0088,meters:af,metres:af,miles:3958.761333810546,millimeters:6371008800,millimetres:6371008800,nauticalmiles:af/1852,radians:1,yards:6967335.223679999};function hf(t,e,n={}){const i={type:"Feature"};return(0===n.id||n.id)&&(i.id=n.id),n.bbox&&(i.bbox=n.bbox),i.properties=e||{},i.geometry=t,i}function lf(t,e={}){const n={type:"FeatureCollection"};return e.id&&(n.id=e.id),e.bbox&&(n.bbox=e.bbox),n.features=t,n}function cf(t,e="kilometers"){const n=uf[e];if(!n)throw new Error(e+" units is invalid");return t*n}function ff(t){return t%360*Math.PI/180}function df(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function pf(t,e,n){if(null!==t)for(var i,r,o,s,a,u,h,l,c=0,f=0,d=t.type,p="FeatureCollection"===d,v="Feature"===d,m=p?t.features.length:1,y=0;y<m;y++){a=(l=!!(h=p?t.features[y].geometry:v?t.geometry:t)&&"GeometryCollection"===h.type)?h.geometries.length:1;for(var w=0;w<a;w++){var g=0,b=0;if(null!==(s=l?h.geometries[w]:h)){u=s.coordinates;var _=s.type;switch(c=0,_){case null:break;case"Point":if(!1===e(u,f,y,g,b))return!1;f++,g++;break;case"LineString":case"MultiPoint":for(i=0;i<u.length;i++){if(!1===e(u[i],f,y,g,b))return!1;f++,"MultiPoint"===_&&g++}"LineString"===_&&g++;break;case"Polygon":case"MultiLineString":for(i=0;i<u.length;i++){for(r=0;r<u[i].length-c;r++){if(!1===e(u[i][r],f,y,g,b))return!1;f++}"MultiLineString"===_&&g++,"Polygon"===_&&b++}"Polygon"===_&&g++;break;case"MultiPolygon":for(i=0;i<u.length;i++){for(b=0,r=0;r<u[i].length;r++){for(o=0;o<u[i][r].length-c;o++){if(!1===e(u[i][r][o],f,y,g,b))return!1;f++}b++}g++}break;case"GeometryCollection":for(i=0;i<s.geometries.length;i++)if(!1===pf(s.geometries[i],e))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function vf(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var n=0;n<t.features.length&&!1!==e(t.features[n],n);n++);}function mf(t,e){var n,i,r,o,s,a,u,h,l,c,f=0,d="FeatureCollection"===t.type,p="Feature"===t.type,v=d?t.features.length:1;for(n=0;n<v;n++){for(a=d?t.features[n].geometry:p?t.geometry:t,h=d?t.features[n].properties:p?t.properties:{},l=d?t.features[n].bbox:p?t.bbox:void 0,c=d?t.features[n].id:p?t.id:void 0,s=(u=!!a&&"GeometryCollection"===a.type)?a.geometries.length:1,r=0;r<s;r++)if(null!==(o=u?a.geometries[r]:a))switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===e(o,f,h,l,c))return!1;break;case"GeometryCollection":for(i=0;i<o.geometries.length;i++)if(!1===e(o.geometries[i],f,h,l,c))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===e(null,f,h,l,c))return!1;f++}}var yf="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function wf(t){return t&&t._a&&{}.hasOwnProperty.call(t,"default")?t.default:t}var gf,bf={exports:{}},_f=(gf||(gf=1,bf.exports=function(){function t(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function e(t,e,n){return e=u(e),function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,l()?Reflect.construct(e,n||[],u(t).constructor):e.apply(t,n))}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e,n){if(l())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,e);var r=new(t.bind.apply(t,i));return n&&c(r,n.prototype),r}function r(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,p(i.key),i)}}function o(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=v(t))||e){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}function a(){return a="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var i=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=u(t)););return t}(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(arguments.length<3?t:n):r.value}},a.apply(null,arguments)}function u(t){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},u(t)}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&c(t,e)}function l(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(l=function(){return!!t})()}function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}function f(t,e,n,i){var r=a(u(1&i?t.prototype:t),e,n);return 2&i&&"function"==typeof r?function(t){return r.apply(n,t)}:r}function d(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(e)||v(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}function v(e,n){if(e){if("string"==typeof e)return t(e,n);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?t(e,n):void 0}}function m(t){var e="function"==typeof Map?new Map:void 0;return m=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return i(t,arguments,u(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,t)},m(t)}var y=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getEndCapStyle",value:function(){return this.tu}},{key:"isSingleSided",value:function(){return this.eu}},{key:"setQuadrantSegments",value:function(e){this.nu=e,0===this.nu&&(this.iu=t.JOIN_BEVEL),this.nu<0&&(this.iu=t.JOIN_MITRE,this.ru=Math.abs(this.nu)),e<=0&&(this.nu=1),this.iu!==t.JOIN_ROUND&&(this.nu=t.DEFAULT_QUADRANT_SEGMENTS)}},{key:"getJoinStyle",value:function(){return this.iu}},{key:"setJoinStyle",value:function(t){this.iu=t}},{key:"setSimplifyFactor",value:function(t){this.ou=t<0?0:t}},{key:"getSimplifyFactor",value:function(){return this.ou}},{key:"getQuadrantSegments",value:function(){return this.nu}},{key:"setEndCapStyle",value:function(t){this.tu=t}},{key:"getMitreLimit",value:function(){return this.ru}},{key:"setMitreLimit",value:function(t){this.ru=t}},{key:"setSingleSided",value:function(t){this.eu=t}}],[{key:"constructor_",value:function(){if(this.nu=t.DEFAULT_QUADRANT_SEGMENTS,this.tu=t.CAP_ROUND,this.iu=t.JOIN_ROUND,this.ru=t.DEFAULT_MITRE_LIMIT,this.eu=!1,this.ou=t.DEFAULT_SIMPLIFY_FACTOR,0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.setQuadrantSegments(e)}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.setQuadrantSegments(n),this.setEndCapStyle(i)}else if(4===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];this.setQuadrantSegments(r),this.setEndCapStyle(o),this.setJoinStyle(s),this.setMitreLimit(a)}}},{key:"bufferDistanceError",value:function(t){var e=Math.PI/2/t;return 1-Math.cos(e/2)}}])}();y.CAP_ROUND=1,y.CAP_FLAT=2,y.CAP_SQUARE=3,y.JOIN_ROUND=1,y.JOIN_MITRE=2,y.JOIN_BEVEL=3,y.DEFAULT_QUADRANT_SEGMENTS=8,y.DEFAULT_MITRE_LIMIT=5,y.DEFAULT_SIMPLIFY_FACTOR=.01;var w=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({Exception:i})[0],r}return h(i,t),o(i,[{key:"toString",value:function(){return this.message}}])}(m(Error)),g=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({IllegalArgumentException:i})[0],r}return h(i,t),o(i)}(w),b=o((function t(){n(this,t)}),[{key:"filter",value:function(t){}}]);function _(){}function x(){}function k(){}var $,S,E,M,C,A,O,I=o((function t(){n(this,t)}),null,[{key:"equalsWithTolerance",value:function(t,e,n){return Math.abs(t-e)<=n}}]),T=o((function t(e,i){n(this,t),this.low=i||0,this.high=e||0}),null,[{key:"toBinaryString",value:function(t){var e,n="";for(e=2147483648;e>0;e>>>=1)n+=(t.high&e)===e?"1":"0";for(e=2147483648;e>0;e>>>=1)n+=(t.low&e)===e?"1":"0";return n}}]);function z(){}function R(){}z.NaN=NaN,z.isNaN=function(t){return Number.isNaN(t)},z.isInfinite=function(t){return!Number.isFinite(t)},z.MAX_VALUE=Number.MAX_VALUE,z.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,z.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,"function"==typeof Float64Array&&"function"==typeof Int32Array?(C=2146435072,A=new Float64Array(1),O=new Int32Array(A.buffer),z.doubleToLongBits=function(t){A[0]=t;var e=0|O[0],n=0|O[1];return(n&C)===C&&1048575&n&&0!==e&&(e=0,n=2146959360),new T(n,e)},z.longBitsToDouble=function(t){return O[0]=t.low,O[1]=t.high,A[0]}):($=Math.log2,S=Math.floor,E=Math.pow,M=function(){for(var t=53;t>0;t--){var e=E(2,t)-1;if(S($(e))+1===t)return e}return 0}(),z.doubleToLongBits=function(t){var e,n,i,r,o,s,a,u,h;if(t<0||1/t===Number.NEGATIVE_INFINITY?(s=1<<31,t=-t):s=0,0===t)return new T(u=s,h=0);if(t===1/0)return new T(u=2146435072|s,h=0);if(t!=t)return new T(u=2146959360,h=0);if(r=0,h=0,(e=S(t))>1)if(e<=M)(r=S($(e)))<=20?(h=0,u=e<<20-r&1048575):(h=e%(n=E(2,i=r-20))<<32-i,u=e/n&1048575);else for(i=e,h=0;0!==(i=S(n=i/2));)r++,h>>>=1,h|=(1&u)<<31,u>>>=1,n!==i&&(u|=524288);if(a=r+1023,o=0===e,e=t-e,r<52&&0!==e)for(i=0;;){if((n=2*e)>=1?(e=n-1,o?(a--,o=!1):(i<<=1,i|=1,r++)):(e=n,o?0==--a&&(r++,o=!1):(i<<=1,r++)),20===r)u|=i,i=0;else if(52===r){h|=i;break}if(1===n){r<20?u|=i<<20-r:r<52&&(h|=i<<52-r);break}}return u|=a<<20,new T(u|=s,h)},z.longBitsToDouble=function(t){var e,n,i,r,o=t.high,s=t.low,a=o&1<<31?-1:1;for(i=((2146435072&o)>>20)-1023,r=0,n=1<<19,e=1;e<=20;e++)o&n&&(r+=E(2,-e)),n>>>=1;for(n=1<<31,e=21;e<=52;e++)s&n&&(r+=E(2,-e)),n>>>=1;if(-1023===i){if(0===r)return 0*a;i=-1022}else{if(1024===i)return 0===r?a/0:NaN;r+=1}return a*r*E(2,i)});var F=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({RuntimeException:i})[0],r}return h(i,t),o(i)}(w),D=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,null,[{key:"constructor_",value:function(){if(0===arguments.length)F.constructor_.call(this);else if(1===arguments.length){var t=arguments[0];F.constructor_.call(this,t)}}}])}(F),P=function(){function t(){n(this,t)}return o(t,null,[{key:"shouldNeverReachHere",value:function(){if(0===arguments.length)t.shouldNeverReachHere(null);else if(1===arguments.length){var e=arguments[0];throw new D("Should never reach here"+(null!==e?": "+e:""))}}},{key:"isTrue",value:function(){if(1===arguments.length){var e=arguments[0];t.isTrue(e,null)}else if(2===arguments.length){var n=arguments[1];if(!arguments[0])throw null===n?new D:new D(n)}}},{key:"equals",value:function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];t.equals(e,n,null)}else if(3===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2];if(!r.equals(i))throw new D("Expected "+i+" but encountered "+r+(null!==o?": "+o:""))}}}])}(),N=new ArrayBuffer(8),U=new Float64Array(N),q=new Int32Array(N),j=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getM",value:function(){return z.NaN}},{key:"setOrdinate",value:function(e,n){switch(e){case t.X:this.x=n;break;case t.Y:this.y=n;break;case t.Z:this.setZ(n);break;default:throw new g("Invalid ordinate index: "+e)}}},{key:"equals2D",value:function(){if(1===arguments.length){var t=arguments[0];return this.x===t.x&&this.y===t.y}if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!I.equalsWithTolerance(this.x,e.x,n)&&!!I.equalsWithTolerance(this.y,e.y,n)}}},{key:"setM",value:function(e){throw new g("Invalid ordinate index: "+t.M)}},{key:"getZ",value:function(){return this.z}},{key:"getOrdinate",value:function(e){switch(e){case t.X:return this.x;case t.Y:return this.y;case t.Z:return this.getZ()}throw new g("Invalid ordinate index: "+e)}},{key:"equals3D",value:function(t){return this.x===t.x&&this.y===t.y&&(this.getZ()===t.getZ()||z.isNaN(this.getZ())&&z.isNaN(t.getZ()))}},{key:"equals",value:function(e){return e instanceof t&&this.equals2D(e)}},{key:"equalInZ",value:function(t,e){return I.equalsWithTolerance(this.getZ(),t.getZ(),e)}},{key:"setX",value:function(t){this.x=t}},{key:"compareTo",value:function(t){var e=t;return this.x<e.x?-1:this.x>e.x?1:this.y<e.y?-1:this.y>e.y?1:0}},{key:"getX",value:function(){return this.x}},{key:"setZ",value:function(t){this.z=t}},{key:"clone",value:function(){try{return null}catch(t){if(t instanceof CloneNotSupportedException)return P.shouldNeverReachHere("this shouldn't happen because this class is Cloneable"),null;throw t}}},{key:"copy",value:function(){return new t(this)}},{key:"toString",value:function(){return"("+this.x+", "+this.y+", "+this.getZ()+")"}},{key:"distance3D",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.getZ()-t.getZ();return Math.sqrt(e*e+n*n+i*i)}},{key:"getY",value:function(){return this.y}},{key:"setY",value:function(t){this.y=t}},{key:"distance",value:function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}},{key:"hashCode",value:function(){var e=17;return 37*(e=37*e+t.hashCode(this.x))+t.hashCode(this.y)}},{key:"setCoordinate",value:function(t){this.x=t.x,this.y=t.y,this.z=t.getZ()}},{key:"interfaces_",get:function(){return[_,x,k]}}],[{key:"constructor_",value:function(){if(this.x=null,this.y=null,this.z=null,0===arguments.length)t.constructor_.call(this,0,0);else if(1===arguments.length){var e=arguments[0];t.constructor_.call(this,e.x,e.y,e.getZ())}else if(2===arguments.length){var n=arguments[0],i=arguments[1];t.constructor_.call(this,n,i,t.NULL_ORDINATE)}else if(3===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2];this.x=r,this.y=o,this.z=s}}},{key:"hashCode",value:function(t){return U[0]=t,q[0]^q[1]}}])}(),L=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"compare",value:function(e,n){var i=t.compare(e.x,n.x);if(0!==i)return i;var r=t.compare(e.y,n.y);return 0!==r?r:this.su<=2?0:t.compare(e.getZ(),n.getZ())}},{key:"interfaces_",get:function(){return[R]}}],[{key:"constructor_",value:function(){if(this.su=2,0===arguments.length)t.constructor_.call(this,2);else if(1===arguments.length){var e=arguments[0];if(2!==e&&3!==e)throw new g("only 2 or 3 dimensions may be specified");this.su=e}}},{key:"compare",value:function(t,e){return t<e?-1:t>e?1:z.isNaN(t)?z.isNaN(e)?0:-1:z.isNaN(e)?1:0}}])}();j.DimensionalComparator=L,j.NULL_ORDINATE=z.NaN,j.X=0,j.Y=1,j.Z=2,j.M=3;var B=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getArea",value:function(){return this.getWidth()*this.getHeight()}},{key:"equals",value:function(e){if(!(e instanceof t))return!1;var n=e;return this.isNull()?n.isNull():this.au===n.getMaxX()&&this.uu===n.getMaxY()&&this.hu===n.getMinX()&&this.lu===n.getMinY()}},{key:"intersection",value:function(e){if(this.isNull()||e.isNull()||!this.intersects(e))return new t;var n=this.hu>e.hu?this.hu:e.hu,i=this.lu>e.lu?this.lu:e.lu;return new t(n,this.au<e.au?this.au:e.au,i,this.uu<e.uu?this.uu:e.uu)}},{key:"isNull",value:function(){return this.au<this.hu}},{key:"getMaxX",value:function(){return this.au}},{key:"covers",value:function(){if(1===arguments.length){if(arguments[0]instanceof j){var e=arguments[0];return this.covers(e.x,e.y)}if(arguments[0]instanceof t){var n=arguments[0];return!this.isNull()&&!n.isNull()&&n.getMinX()>=this.hu&&n.getMaxX()<=this.au&&n.getMinY()>=this.lu&&n.getMaxY()<=this.uu}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];return!this.isNull()&&i>=this.hu&&i<=this.au&&r>=this.lu&&r<=this.uu}}},{key:"intersects",value:function(){if(1===arguments.length){if(arguments[0]instanceof t){var e=arguments[0];return!this.isNull()&&!e.isNull()&&!(e.hu>this.au||e.au<this.hu||e.lu>this.uu||e.uu<this.lu)}if(arguments[0]instanceof j){var n=arguments[0];return this.intersects(n.x,n.y)}}else if(2===arguments.length){if(arguments[0]instanceof j&&arguments[1]instanceof j){var i=arguments[0],r=arguments[1];return!(this.isNull()||(i.x<r.x?i.x:r.x)>this.au||(i.x>r.x?i.x:r.x)<this.hu||(i.y<r.y?i.y:r.y)>this.uu||(i.y>r.y?i.y:r.y)<this.lu)}if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var o=arguments[0],s=arguments[1];return!this.isNull()&&!(o>this.au||o<this.hu||s>this.uu||s<this.lu)}}}},{key:"getMinY",value:function(){return this.lu}},{key:"getDiameter",value:function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return Math.sqrt(t*t+e*e)}},{key:"getMinX",value:function(){return this.hu}},{key:"expandToInclude",value:function(){if(1===arguments.length){if(arguments[0]instanceof j){var e=arguments[0];this.expandToInclude(e.x,e.y)}else if(arguments[0]instanceof t){var n=arguments[0];if(n.isNull())return null;this.isNull()?(this.hu=n.getMinX(),this.au=n.getMaxX(),this.lu=n.getMinY(),this.uu=n.getMaxY()):(n.hu<this.hu&&(this.hu=n.hu),n.au>this.au&&(this.au=n.au),n.lu<this.lu&&(this.lu=n.lu),n.uu>this.uu&&(this.uu=n.uu))}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.isNull()?(this.hu=i,this.au=i,this.lu=r,this.uu=r):(i<this.hu&&(this.hu=i),i>this.au&&(this.au=i),r<this.lu&&(this.lu=r),r>this.uu&&(this.uu=r))}}},{key:"minExtent",value:function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t<e?t:e}},{key:"getWidth",value:function(){return this.isNull()?0:this.au-this.hu}},{key:"compareTo",value:function(t){var e=t;return this.isNull()?e.isNull()?0:-1:e.isNull()?1:this.hu<e.hu?-1:this.hu>e.hu?1:this.lu<e.lu?-1:this.lu>e.lu?1:this.au<e.au?-1:this.au>e.au?1:this.uu<e.uu?-1:this.uu>e.uu?1:0}},{key:"translate",value:function(t,e){if(this.isNull())return null;this.init(this.getMinX()+t,this.getMaxX()+t,this.getMinY()+e,this.getMaxY()+e)}},{key:"copy",value:function(){return new t(this)}},{key:"toString",value:function(){return"Env["+this.hu+" : "+this.au+", "+this.lu+" : "+this.uu+"]"}},{key:"setToNull",value:function(){this.hu=0,this.au=-1,this.lu=0,this.uu=-1}},{key:"disjoint",value:function(t){return!(!this.isNull()&&!t.isNull())||t.hu>this.au||t.au<this.hu||t.lu>this.uu||t.uu<this.lu}},{key:"getHeight",value:function(){return this.isNull()?0:this.uu-this.lu}},{key:"maxExtent",value:function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t>e?t:e}},{key:"expandBy",value:function(){if(1===arguments.length){var t=arguments[0];this.expandBy(t,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.isNull())return null;this.hu-=e,this.au+=e,this.lu-=n,this.uu+=n,(this.hu>this.au||this.lu>this.uu)&&this.setToNull()}}},{key:"contains",value:function(){if(1===arguments.length){if(arguments[0]instanceof t){var e=arguments[0];return this.covers(e)}if(arguments[0]instanceof j){var n=arguments[0];return this.covers(n)}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];return this.covers(i,r)}}},{key:"centre",value:function(){return this.isNull()?null:new j((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)}},{key:"init",value:function(){if(0===arguments.length)this.setToNull();else if(1===arguments.length){if(arguments[0]instanceof j){var e=arguments[0];this.init(e.x,e.x,e.y,e.y)}else if(arguments[0]instanceof t){var n=arguments[0];this.hu=n.hu,this.au=n.au,this.lu=n.lu,this.uu=n.uu}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.init(i.x,r.x,i.y,r.y)}else if(4===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2],u=arguments[3];o<s?(this.hu=o,this.au=s):(this.hu=s,this.au=o),a<u?(this.lu=a,this.uu=u):(this.lu=u,this.uu=a)}}},{key:"getMaxY",value:function(){return this.uu}},{key:"distance",value:function(t){if(this.intersects(t))return 0;var e=0;this.au<t.hu?e=t.hu-this.au:this.hu>t.au&&(e=this.hu-t.au);var n=0;return this.uu<t.lu?n=t.lu-this.uu:this.lu>t.uu&&(n=this.lu-t.uu),0===e?n:0===n?e:Math.sqrt(e*e+n*n)}},{key:"hashCode",value:function(){var t=17;return 37*(t=37*(t=37*(t=37*t+j.hashCode(this.hu))+j.hashCode(this.au))+j.hashCode(this.lu))+j.hashCode(this.uu)}},{key:"interfaces_",get:function(){return[_,k]}}],[{key:"constructor_",value:function(){if(this.hu=null,this.au=null,this.lu=null,this.uu=null,0===arguments.length)this.init();else if(1===arguments.length){if(arguments[0]instanceof j){var e=arguments[0];this.init(e.x,e.x,e.y,e.y)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.init(i.x,r.x,i.y,r.y)}else if(4===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2],u=arguments[3];this.init(o,s,a,u)}}},{key:"intersects",value:function(){if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];return n.x>=(t.x<e.x?t.x:e.x)&&n.x<=(t.x>e.x?t.x:e.x)&&n.y>=(t.y<e.y?t.y:e.y)&&n.y<=(t.y>e.y?t.y:e.y)}if(4===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=Math.min(o.x,s.x),u=Math.max(o.x,s.x),h=Math.min(i.x,r.x),l=Math.max(i.x,r.x);return!(h>u||l<a||(a=Math.min(o.y,s.y),u=Math.max(o.y,s.y),h=Math.min(i.y,r.y),l=Math.max(i.y,r.y),h>u||l<a))}}}])}(),H=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"isGeometryCollection",value:function(){return this.getTypeCode()===t.TYPECODE_GEOMETRYCOLLECTION}},{key:"getFactory",value:function(){return this.cu}},{key:"getGeometryN",value:function(t){return this}},{key:"getArea",value:function(){return 0}},{key:"isRectangle",value:function(){return!1}},{key:"equalsExact",value:function(t){return this===t||this.equalsExact(t,0)}},{key:"geometryChanged",value:function(){this.apply(t.geometryChangedFilter)}},{key:"geometryChangedAction",value:function(){this.fu=null}},{key:"equalsNorm",value:function(t){return null!==t&&this.norm().equalsExact(t.norm())}},{key:"getLength",value:function(){return 0}},{key:"getNumGeometries",value:function(){return 1}},{key:"compareTo",value:function(){var t;if(1===arguments.length){var e=arguments[0];return t=e,this.getTypeCode()!==t.getTypeCode()?this.getTypeCode()-t.getTypeCode():this.isEmpty()&&t.isEmpty()?0:this.isEmpty()?-1:t.isEmpty()?1:this.compareToSameClass(e)}if(2===arguments.length){var n=arguments[0],i=arguments[1];return t=n,this.getTypeCode()!==t.getTypeCode()?this.getTypeCode()-t.getTypeCode():this.isEmpty()&&t.isEmpty()?0:this.isEmpty()?-1:t.isEmpty()?1:this.compareToSameClass(n,i)}}},{key:"getUserData",value:function(){return this.du}},{key:"getSRID",value:function(){return this.pu}},{key:"getEnvelope",value:function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())}},{key:"checkNotGeometryCollection",value:function(e){if(e.getTypeCode()===t.TYPECODE_GEOMETRYCOLLECTION)throw new g("This method does not support GeometryCollection arguments")}},{key:"equal",value:function(t,e,n){return 0===n?t.equals(e):t.distance(e)<=n}},{key:"norm",value:function(){var t=this.copy();return t.normalize(),t}},{key:"reverse",value:function(){var t=this.reverseInternal();return null!=this.envelope&&(t.envelope=this.envelope.copy()),t.setSRID(this.getSRID()),t}},{key:"copy",value:function(){var t=this.copyInternal();return t.envelope=null==this.fu?null:this.fu.copy(),t.pu=this.pu,t.du=this.du,t}},{key:"getPrecisionModel",value:function(){return this.cu.getPrecisionModel()}},{key:"getEnvelopeInternal",value:function(){return null===this.fu&&(this.fu=this.computeEnvelopeInternal()),new B(this.fu)}},{key:"setSRID",value:function(t){this.pu=t}},{key:"setUserData",value:function(t){this.du=t}},{key:"compare",value:function(t,e){for(var n=t.iterator(),i=e.iterator();n.hasNext()&&i.hasNext();){var r=n.next(),o=i.next(),s=r.compareTo(o);if(0!==s)return s}return n.hasNext()?1:i.hasNext()?-1:0}},{key:"hashCode",value:function(){return this.getEnvelopeInternal().hashCode()}},{key:"isEquivalentClass",value:function(t){return this.getClass()===t.getClass()}},{key:"isGeometryCollectionOrDerived",value:function(){return this.getTypeCode()===t.TYPECODE_GEOMETRYCOLLECTION||this.getTypeCode()===t.TYPECODE_MULTIPOINT||this.getTypeCode()===t.TYPECODE_MULTILINESTRING||this.getTypeCode()===t.TYPECODE_MULTIPOLYGON}},{key:"interfaces_",get:function(){return[x,_,k]}},{key:"getClass",value:function(){return t}}],[{key:"hasNonEmptyElements",value:function(t){for(var e=0;e<t.length;e++)if(!t[e].isEmpty())return!0;return!1}},{key:"hasNullElements",value:function(t){for(var e=0;e<t.length;e++)if(null===t[e])return!0;return!1}}])}();H.constructor_=function(t){t&&(this.fu=null,this.du=null,this.cu=t,this.pu=t.getSRID())},H.TYPECODE_POINT=0,H.TYPECODE_MULTIPOINT=1,H.TYPECODE_LINESTRING=2,H.TYPECODE_LINEARRING=3,H.TYPECODE_MULTILINESTRING=4,H.TYPECODE_POLYGON=5,H.TYPECODE_MULTIPOLYGON=6,H.TYPECODE_GEOMETRYCOLLECTION=7,H.TYPENAME_POINT="Point",H.TYPENAME_MULTIPOINT="MultiPoint",H.TYPENAME_LINESTRING="LineString",H.TYPENAME_LINEARRING="LinearRing",H.TYPENAME_MULTILINESTRING="MultiLineString",H.TYPENAME_POLYGON="Polygon",H.TYPENAME_MULTIPOLYGON="MultiPolygon",H.TYPENAME_GEOMETRYCOLLECTION="GeometryCollection",H.geometryChangedFilter={get interfaces_(){return[b]},filter:function(t){t.geometryChangedAction()}};var W=function(){function t(){n(this,t)}return o(t,null,[{key:"toLocationSymbol",value:function(e){switch(e){case t.EXTERIOR:return"e";case t.BOUNDARY:return"b";case t.INTERIOR:return"i";case t.NONE:return"-"}throw new g("Unknown location value: "+e)}}])}();W.INTERIOR=0,W.BOUNDARY=1,W.EXTERIOR=2,W.NONE=-1;var V=o((function t(){n(this,t)}),[{key:"add",value:function(){}},{key:"addAll",value:function(){}},{key:"isEmpty",value:function(){}},{key:"iterator",value:function(){}},{key:"size",value:function(){}},{key:"toArray",value:function(){}},{key:"remove",value:function(){}}]),G=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({NoSuchElementException:i})[0],r}return h(i,t),o(i)}(w),Y=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({UnsupportedOperationException:i})[0],r}return h(i,t),o(i)}(w),K=function(t){function i(){return n(this,i),e(this,i,arguments)}return h(i,t),o(i,[{key:"contains",value:function(){}}])}(V),X=function(t){function i(t){var r;return n(this,i),(r=e(this,i)).map=new Map,t instanceof V&&r.addAll(t),r}return h(i,t),o(i,[{key:"contains",value:function(t){var e=t.hashCode?t.hashCode():t;return!!this.map.has(e)}},{key:"add",value:function(t){var e=t.hashCode?t.hashCode():t;return!this.map.has(e)&&!!this.map.set(e,t)}},{key:"addAll",value:function(t){var e,n=s(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.add(i)}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"remove",value:function(){throw new Y}},{key:"size",value:function(){return this.map.size}},{key:"isEmpty",value:function(){return 0===this.map.size}},{key:"toArray",value:function(){return Array.from(this.map.values())}},{key:"iterator",value:function(){return new Q(this.map)}},{key:Symbol.iterator,value:function(){return this.map}}])}(K),Q=o((function t(e){n(this,t),this.iterator=e.values();var i=this.iterator.next(),r=i.done,o=i.value;this.done=r,this.value=o}),[{key:"next",value:function(){if(this.done)throw new G;var t=this.value,e=this.iterator.next(),n=e.done,i=e.value;return this.done=n,this.value=i,t}},{key:"hasNext",value:function(){return!this.done}},{key:"remove",value:function(){throw new Y}}]),Z=function(){function t(){n(this,t)}return o(t,null,[{key:"opposite",value:function(e){return e===t.LEFT?t.RIGHT:e===t.RIGHT?t.LEFT:e}}])}();Z.ON=0,Z.LEFT=1,Z.RIGHT=2;var J=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({EmptyStackException:i})[0],r}return h(i,t),o(i)}(w),tt=function(t){function i(t){var r;return n(this,i),(r=e(this,i,[t])).name=Object.keys({IndexOutOfBoundsException:i})[0],r}return h(i,t),o(i)}(w),et=function(t){function i(){return n(this,i),e(this,i,arguments)}return h(i,t),o(i,[{key:"get",value:function(){}},{key:"set",value:function(){}},{key:"isEmpty",value:function(){}}])}(V),nt=function(t){function i(){var t;return n(this,i),(t=e(this,i)).array=[],t}return h(i,t),o(i,[{key:"add",value:function(t){return this.array.push(t),!0}},{key:"get",value:function(t){if(t<0||t>=this.size())throw new tt;return this.array[t]}},{key:"push",value:function(t){return this.array.push(t),t}},{key:"pop",value:function(){if(0===this.array.length)throw new J;return this.array.pop()}},{key:"peek",value:function(){if(0===this.array.length)throw new J;return this.array[this.array.length-1]}},{key:"empty",value:function(){return 0===this.array.length}},{key:"isEmpty",value:function(){return this.empty()}},{key:"search",value:function(t){return this.array.indexOf(t)}},{key:"size",value:function(){return this.array.length}},{key:"toArray",value:function(){return this.array.slice()}}])}(et);function it(t,e){return t.interfaces_&&t.interfaces_.indexOf(e)>-1}var rt=o((function t(e){n(this,t),this.str=e}),[{key:"append",value:function(t){this.str+=t}},{key:"setCharAt",value:function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)}},{key:"toString",value:function(){return this.str}}]),ot=function(){function t(e){n(this,t),this.value=e}return o(t,[{key:"intValue",value:function(){return this.value}},{key:"compareTo",value:function(t){return this.value<t?-1:this.value>t?1:0}}],[{key:"compare",value:function(t,e){return t<e?-1:t>e?1:0}},{key:"isNan",value:function(t){return Number.isNaN(t)}},{key:"valueOf",value:function(e){return new t(e)}}])}(),st=o((function t(){n(this,t)}),null,[{key:"isWhitespace",value:function(t){return t<=32&&t>=0||127===t}},{key:"toUpperCase",value:function(t){return t.toUpperCase()}}]),at=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"le",value:function(t){return this.vu<t.vu||this.vu===t.vu&&this.mu<=t.mu}},{key:"extractSignificantDigits",value:function(e,n){var i=this.abs(),r=t.magnitude(i.vu),o=t.TEN.pow(r);(i=i.divide(o)).gt(t.TEN)?(i=i.divide(t.TEN),r+=1):i.lt(t.ONE)&&(i=i.multiply(t.TEN),r-=1);for(var s=r+1,a=new rt,u=t.MAX_PRINT_DIGITS-1,h=0;h<=u;h++){e&&h===s&&a.append(".");var l=Math.trunc(i.vu);if(l<0)break;var c=!1,f=0;l>9?(c=!0,f="9"):f="0"+l,a.append(f),i=i.subtract(t.valueOf(l)).multiply(t.TEN),c&&i.selfAdd(t.TEN);var d=!0,p=t.magnitude(i.vu);if(p<0&&Math.abs(p)>=u-h&&(d=!1),!d)break}return n[0]=r,a.toString()}},{key:"sqr",value:function(){return this.multiply(this)}},{key:"doubleValue",value:function(){return this.vu+this.mu}},{key:"subtract",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return this.add(e.negate())}if("number"==typeof arguments[0]){var n=arguments[0];return this.add(-n)}}},{key:"equals",value:function(){if(1===arguments.length&&arguments[0]instanceof t){var e=arguments[0];return this.vu===e.vu&&this.mu===e.mu}}},{key:"isZero",value:function(){return 0===this.vu&&0===this.mu}},{key:"selfSubtract",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return this.isNaN()?this:this.selfAdd(-e.vu,-e.mu)}if("number"==typeof arguments[0]){var n=arguments[0];return this.isNaN()?this:this.selfAdd(-n,0)}}},{key:"getSpecialNumberString",value:function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null}},{key:"min",value:function(t){return this.le(t)?this:t}},{key:"selfDivide",value:function(){if(1===arguments.length){if(arguments[0]instanceof t){var e=arguments[0];return this.selfDivide(e.vu,e.mu)}if("number"==typeof arguments[0]){var n=arguments[0];return this.selfDivide(n,0)}}else if(2===arguments.length){var i,r,o,s,a=arguments[0],u=arguments[1],h=null,l=null,c=null,f=null;return o=this.vu/a,f=(h=(c=t.SPLIT*o)-(h=c-o))*(l=(f=t.SPLIT*a)-(l=f-a))-(s=o*a)+h*(r=a-l)+(i=o-h)*l+i*r,f=o+(c=(this.vu-s-f+this.mu-o*u)/a),this.vu=f,this.mu=o-f+c,this}}},{key:"dump",value:function(){return"DD<"+this.vu+", "+this.mu+">"}},{key:"divide",value:function(){if(arguments[0]instanceof t){var e,n,i,r,o=arguments[0],s=null,a=null,u=null,h=null;return e=(i=this.vu/o.vu)-(s=(u=t.SPLIT*i)-(s=u-i)),h=s*(a=(h=t.SPLIT*o.vu)-(a=h-o.vu))-(r=i*o.vu)+s*(n=o.vu-a)+e*a+e*n,new t(h=i+(u=(this.vu-r-h+this.mu-i*o.mu)/o.vu),i-h+u)}if("number"==typeof arguments[0]){var l=arguments[0];return z.isNaN(l)?t.createNaN():t.copy(this).selfDivide(l,0)}}},{key:"ge",value:function(t){return this.vu>t.vu||this.vu===t.vu&&this.mu>=t.mu}},{key:"pow",value:function(e){if(0===e)return t.valueOf(1);var n=new t(this),i=t.valueOf(1),r=Math.abs(e);if(r>1)for(;r>0;)r%2==1&&i.selfMultiply(n),(r/=2)>0&&(n=n.sqr());else i=n;return e<0?i.reciprocal():i}},{key:"ceil",value:function(){if(this.isNaN())return t.NaN;var e=Math.ceil(this.vu),n=0;return e===this.vu&&(n=Math.ceil(this.mu)),new t(e,n)}},{key:"compareTo",value:function(t){var e=t;return this.vu<e.vu?-1:this.vu>e.vu?1:this.mu<e.mu?-1:this.mu>e.mu?1:0}},{key:"rint",value:function(){return this.isNaN()?this:this.add(.5).floor()}},{key:"setValue",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return this.init(e),this}if("number"==typeof arguments[0]){var n=arguments[0];return this.init(n),this}}},{key:"max",value:function(t){return this.ge(t)?this:t}},{key:"sqrt",value:function(){if(this.isZero())return t.valueOf(0);if(this.isNegative())return t.NaN;var e=1/Math.sqrt(this.vu),n=this.vu*e,i=t.valueOf(n),r=.5*this.subtract(i.sqr()).vu*e;return i.add(r)}},{key:"selfAdd",value:function(){if(1===arguments.length){if(arguments[0]instanceof t){var e=arguments[0];return this.selfAdd(e.vu,e.mu)}if("number"==typeof arguments[0]){var n,i,r,o,s,a=arguments[0],u=null;return u=(r=this.vu+a)-(o=r-this.vu),i=(s=(u=a-o+(this.vu-u))+this.mu)+(r-(n=r+s)),this.vu=n+i,this.mu=i+(n-this.vu),this}}else if(2===arguments.length){var h,l,c,f,d=arguments[0],p=arguments[1],v=null,m=null,y=null;c=this.vu+d,l=this.mu+p,m=c-(y=c-this.vu),v=l-(f=l-this.mu);var w=(h=c+(y=(m=d-y+(this.vu-m))+l))+(y=(v=p-f+(this.mu-v))+(y+(c-h))),g=y+(h-w);return this.vu=w,this.mu=g,this}}},{key:"selfMultiply",value:function(){if(1===arguments.length){if(arguments[0]instanceof t){var e=arguments[0];return this.selfMultiply(e.vu,e.mu)}if("number"==typeof arguments[0]){var n=arguments[0];return this.selfMultiply(n,0)}}else if(2===arguments.length){var i,r,o=arguments[0],s=arguments[1],a=null,u=null,h=null,l=null;a=(h=t.SPLIT*this.vu)-this.vu,l=t.SPLIT*o,a=h-a,i=this.vu-a,u=l-o;var c=(h=this.vu*o)+(l=a*(u=l-u)-h+a*(r=o-u)+i*u+i*r+this.vu*s+this.mu*o),f=l+(a=h-c);return this.vu=c,this.mu=f,this}}},{key:"selfSqr",value:function(){return this.selfMultiply(this)}},{key:"floor",value:function(){if(this.isNaN())return t.NaN;var e=Math.floor(this.vu),n=0;return e===this.vu&&(n=Math.floor(this.mu)),new t(e,n)}},{key:"negate",value:function(){return this.isNaN()?this:new t(-this.vu,-this.mu)}},{key:"clone",value:function(){try{return null}catch(t){if(t instanceof CloneNotSupportedException)return null;throw t}}},{key:"multiply",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return e.isNaN()?t.createNaN():t.copy(this).selfMultiply(e)}if("number"==typeof arguments[0]){var n=arguments[0];return z.isNaN(n)?t.createNaN():t.copy(this).selfMultiply(n,0)}}},{key:"isNaN",value:function(){return z.isNaN(this.vu)}},{key:"intValue",value:function(){return Math.trunc(this.vu)}},{key:"toString",value:function(){var e=t.magnitude(this.vu);return e>=-3&&e<=20?this.toStandardNotation():this.toSciNotation()}},{key:"toStandardNotation",value:function(){var e=this.getSpecialNumberString();if(null!==e)return e;var n=new Array(1).fill(null),i=this.extractSignificantDigits(!0,n),r=n[0]+1,o=i;if("."===i.charAt(0))o="0"+i;else if(r<0)o="0."+t.stringOfChar("0",-r)+i;else if(-1===i.indexOf(".")){var s=r-i.length;o=i+t.stringOfChar("0",s)+".0"}return this.isNegative()?"-"+o:o}},{key:"reciprocal",value:function(){var e,n,i,r,o=null,s=null,a=null,u=null;e=(i=1/this.vu)-(o=(a=t.SPLIT*i)-(o=a-i)),s=(u=t.SPLIT*this.vu)-this.vu;var h=i+(a=(1-(r=i*this.vu)-(u=o*(s=u-s)-r+o*(n=this.vu-s)+e*s+e*n)-i*this.mu)/this.vu);return new t(h,i-h+a)}},{key:"toSciNotation",value:function(){if(this.isZero())return t.SCI_NOT_ZERO;var e=this.getSpecialNumberString();if(null!==e)return e;var n=new Array(1).fill(null),i=this.extractSignificantDigits(!1,n),r=t.SCI_NOT_EXPONENT_CHAR+n[0];if("0"===i.charAt(0))throw new IllegalStateException("Found leading zero: "+i);var o="";i.length>1&&(o=i.substring(1));var s=i.charAt(0)+"."+o;return this.isNegative()?"-"+s+r:s+r}},{key:"abs",value:function(){return this.isNaN()?t.NaN:this.isNegative()?this.negate():new t(this)}},{key:"isPositive",value:function(){return this.vu>0||0===this.vu&&this.mu>0}},{key:"lt",value:function(t){return this.vu<t.vu||this.vu===t.vu&&this.mu<t.mu}},{key:"add",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return t.copy(this).selfAdd(e)}if("number"==typeof arguments[0]){var n=arguments[0];return t.copy(this).selfAdd(n)}}},{key:"init",value:function(){if(1===arguments.length){if("number"==typeof arguments[0]){var e=arguments[0];this.vu=e,this.mu=0}else if(arguments[0]instanceof t){var n=arguments[0];this.vu=n.vu,this.mu=n.mu}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.vu=i,this.mu=r}}},{key:"gt",value:function(t){return this.vu>t.vu||this.vu===t.vu&&this.mu>t.mu}},{key:"isNegative",value:function(){return this.vu<0||0===this.vu&&this.mu<0}},{key:"trunc",value:function(){return this.isNaN()?t.NaN:this.isPositive()?this.floor():this.ceil()}},{key:"signum",value:function(){return this.vu>0?1:this.vu<0?-1:this.mu>0?1:this.mu<0?-1:0}},{key:"interfaces_",get:function(){return[k,_,x]}}],[{key:"constructor_",value:function(){if(this.vu=0,this.mu=0,0===arguments.length)this.init(0);else if(1===arguments.length){if("number"==typeof arguments[0]){var e=arguments[0];this.init(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}else if("string"==typeof arguments[0]){var i=arguments[0];t.constructor_.call(this,t.parse(i))}}else if(2===arguments.length){var r=arguments[0],o=arguments[1];this.init(r,o)}}},{key:"determinant",value:function(){if("number"==typeof arguments[3]&&"number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var e=arguments[0],n=arguments[1],i=arguments[2],r=arguments[3];return t.determinant(t.valueOf(e),t.valueOf(n),t.valueOf(i),t.valueOf(r))}if(arguments[3]instanceof t&&arguments[2]instanceof t&&arguments[0]instanceof t&&arguments[1]instanceof t){var o=arguments[1],s=arguments[2],a=arguments[3];return arguments[0].multiply(a).selfSubtract(o.multiply(s))}}},{key:"sqr",value:function(e){return t.valueOf(e).selfMultiply(e)}},{key:"valueOf",value:function(){if("string"==typeof arguments[0]){var e=arguments[0];return t.parse(e)}if("number"==typeof arguments[0])return new t(arguments[0])}},{key:"sqrt",value:function(e){return t.valueOf(e).sqrt()}},{key:"parse",value:function(e){for(var n=0,i=e.length;st.isWhitespace(e.charAt(n));)n++;var r=!1;if(n<i){var o=e.charAt(n);"-"!==o&&"+"!==o||(n++,"-"===o&&(r=!0))}for(var s=new t,a=0,u=0,h=0,l=!1;!(n>=i);){var c=e.charAt(n);if(n++,st.isDigit(c)){var f=c-"0";s.selfMultiply(t.TEN),s.selfAdd(f),a++}else{if("."!==c){if("e"===c||"E"===c){var d=e.substring(n);try{h=ot.parseInt(d)}catch(t){throw t instanceof NumberFormatException?new NumberFormatException("Invalid exponent "+d+" in string "+e):t}break}throw new NumberFormatException("Unexpected character '"+c+"' at position "+n+" in string "+e)}u=a,l=!0}}var p=s;l||(u=a);var v=a-u-h;if(0===v)p=s;else if(v>0){var m=t.TEN.pow(v);p=s.divide(m)}else if(v<0){var y=t.TEN.pow(-v);p=s.multiply(y)}return r?p.negate():p}},{key:"createNaN",value:function(){return new t(z.NaN,z.NaN)}},{key:"copy",value:function(e){return new t(e)}},{key:"magnitude",value:function(t){var e=Math.abs(t),n=Math.log(e)/Math.log(10),i=Math.trunc(Math.floor(n));return 10*Math.pow(10,i)<=e&&(i+=1),i}},{key:"stringOfChar",value:function(t,e){for(var n=new rt,i=0;i<e;i++)n.append(t);return n.toString()}}])}();at.PI=new at(3.141592653589793,12246467991473532e-32),at.TWO_PI=new at(6.283185307179586,24492935982947064e-32),at.PI_2=new at(1.5707963267948966,6123233995736766e-32),at.E=new at(2.718281828459045,14456468917292502e-32),at.NaN=new at(z.NaN,z.NaN),at.EPS=123259516440783e-46,at.SPLIT=134217729,at.MAX_PRINT_DIGITS=32,at.TEN=at.valueOf(10),at.ONE=at.valueOf(1),at.SCI_NOT_EXPONENT_CHAR="E",at.SCI_NOT_ZERO="0.0E0";var ut=function(){function t(){n(this,t)}return o(t,null,[{key:"orientationIndex",value:function(e,n,i){var r=t.orientationIndexFilter(e,n,i);if(r<=1)return r;var o=at.valueOf(n.x).selfAdd(-e.x),s=at.valueOf(n.y).selfAdd(-e.y),a=at.valueOf(i.x).selfAdd(-n.x),u=at.valueOf(i.y).selfAdd(-n.y);return o.selfMultiply(u).selfSubtract(s.selfMultiply(a)).signum()}},{key:"signOfDet2x2",value:function(){if(arguments[3]instanceof at&&arguments[2]instanceof at&&arguments[0]instanceof at&&arguments[1]instanceof at){var t=arguments[1],e=arguments[2],n=arguments[3];return arguments[0].multiply(n).selfSubtract(t.multiply(e)).signum()}if("number"==typeof arguments[3]&&"number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=at.valueOf(i),u=at.valueOf(r),h=at.valueOf(o),l=at.valueOf(s);return a.multiply(l).selfSubtract(u.multiply(h)).signum()}}},{key:"intersection",value:function(t,e,n,i){var r=new at(t.y).selfSubtract(e.y),o=new at(e.x).selfSubtract(t.x),s=new at(t.x).selfMultiply(e.y).selfSubtract(new at(e.x).selfMultiply(t.y)),a=new at(n.y).selfSubtract(i.y),u=new at(i.x).selfSubtract(n.x),h=new at(n.x).selfMultiply(i.y).selfSubtract(new at(i.x).selfMultiply(n.y)),l=o.multiply(h).selfSubtract(u.multiply(s)),c=a.multiply(s).selfSubtract(r.multiply(h)),f=r.multiply(u).selfSubtract(a.multiply(o)),d=l.selfDivide(f).doubleValue(),p=c.selfDivide(f).doubleValue();return z.isNaN(d)||z.isInfinite(d)||z.isNaN(p)||z.isInfinite(p)?null:new j(d,p)}},{key:"orientationIndexFilter",value:function(e,n,i){var r=null,o=(e.x-i.x)*(n.y-i.y),s=(e.y-i.y)*(n.x-i.x),a=o-s;if(o>0){if(s<=0)return t.signum(a);r=o+s}else{if(!(o<0))return t.signum(a);if(s>=0)return t.signum(a);r=-o-s}var u=t.DP_SAFE_EPSILON*r;return a>=u||-a>=u?t.signum(a):2}},{key:"signum",value:function(t){return t>0?1:t<0?-1:0}}])}();ut.DP_SAFE_EPSILON=1e-15;var ht=o((function t(){n(this,t)}),[{key:"getM",value:function(t){if(this.hasM()){var e=this.getDimension()-this.getMeasures();return this.getOrdinate(t,e)}return z.NaN}},{key:"setOrdinate",value:function(t,e,n){}},{key:"getZ",value:function(t){return this.hasZ()?this.getOrdinate(t,2):z.NaN}},{key:"size",value:function(){}},{key:"getOrdinate",value:function(t,e){}},{key:"getCoordinate",value:function(){}},{key:"getCoordinateCopy",value:function(t){}},{key:"createCoordinate",value:function(){}},{key:"getDimension",value:function(){}},{key:"hasM",value:function(){return this.getMeasures()>0}},{key:"getX",value:function(t){}},{key:"hasZ",value:function(){return this.getDimension()-this.getMeasures()>2}},{key:"getMeasures",value:function(){return 0}},{key:"expandEnvelope",value:function(t){}},{key:"copy",value:function(){}},{key:"getY",value:function(t){}},{key:"toCoordinateArray",value:function(){}},{key:"interfaces_",get:function(){return[x]}}]);ht.X=0,ht.Y=1,ht.Z=2,ht.M=3;var lt=function(){function t(){n(this,t)}return o(t,null,[{key:"index",value:function(t,e,n){return ut.orientationIndex(t,e,n)}},{key:"isCCW",value:function(){if(arguments[0]instanceof Array){var e=arguments[0],n=e.length-1;if(n<3)throw new g("Ring has fewer than 4 points, so orientation cannot be determined");for(var i=e[0],r=0,o=1;o<=n;o++){var s=e[o];s.y>i.y&&(i=s,r=o)}var a=r;do{(a-=1)<0&&(a=n)}while(e[a].equals2D(i)&&a!==r);var u=r;do{u=(u+1)%n}while(e[u].equals2D(i)&&u!==r);var h=e[a],l=e[u];if(h.equals2D(i)||l.equals2D(i)||h.equals2D(l))return!1;var c=t.index(h,i,l);return 0===c?h.x>l.x:c>0}if(it(arguments[0],ht)){var f=arguments[0],d=f.size()-1;if(d<3)throw new g("Ring has fewer than 4 points, so orientation cannot be determined");for(var p=f.getCoordinate(0),v=0,m=1;m<=d;m++){var y=f.getCoordinate(m);y.y>p.y&&(p=y,v=m)}var w=null,b=v;do{(b-=1)<0&&(b=d),w=f.getCoordinate(b)}while(w.equals2D(p)&&b!==v);var _=null,x=v;do{x=(x+1)%d,_=f.getCoordinate(x)}while(_.equals2D(p)&&x!==v);if(w.equals2D(p)||_.equals2D(p)||w.equals2D(_))return!1;var k=t.index(w,p,_);return 0===k?w.x>_.x:k>0}}}])}();lt.CLOCKWISE=-1,lt.RIGHT=lt.CLOCKWISE,lt.COUNTERCLOCKWISE=1,lt.LEFT=lt.COUNTERCLOCKWISE,lt.COLLINEAR=0,lt.STRAIGHT=lt.COLLINEAR;var ct=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getCoordinate",value:function(){return this.yu}},{key:"getRightmostSide",value:function(t,e){var n=this.getRightmostSideOfSegment(t,e);return n<0&&(n=this.getRightmostSideOfSegment(t,e-1)),n<0&&(this.yu=null,this.checkForRightmostCoordinate(t)),n}},{key:"findRightmostEdgeAtVertex",value:function(){var t=this.wu.getEdge().getCoordinates();P.isTrue(this.gu>0&&this.gu<t.length,"rightmost point expected to be interior vertex of edge");var e=t[this.gu-1],n=t[this.gu+1],i=lt.index(this.yu,n,e),r=!1;(e.y<this.yu.y&&n.y<this.yu.y&&i===lt.COUNTERCLOCKWISE||e.y>this.yu.y&&n.y>this.yu.y&&i===lt.CLOCKWISE)&&(r=!0),r&&(this.gu=this.gu-1)}},{key:"getRightmostSideOfSegment",value:function(t,e){var n=t.getEdge().getCoordinates();if(e<0||e+1>=n.length)return-1;if(n[e].y===n[e+1].y)return-1;var i=Z.LEFT;return n[e].y<n[e+1].y&&(i=Z.RIGHT),i}},{key:"getEdge",value:function(){return this.bu}},{key:"checkForRightmostCoordinate",value:function(t){for(var e=t.getEdge().getCoordinates(),n=0;n<e.length-1;n++)(null===this.yu||e[n].x>this.yu.x)&&(this.wu=t,this.gu=n,this.yu=e[n])}},{key:"findRightmostEdgeAtNode",value:function(){var t=this.wu.getNode().getEdges();this.wu=t.getRightmostEdge(),this.wu.isForward()||(this.wu=this.wu.getSym(),this.gu=this.wu.getEdge().getCoordinates().length-1)}},{key:"findEdge",value:function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();n.isForward()&&this.checkForRightmostCoordinate(n)}P.isTrue(0!==this.gu||this.yu.equals(this.wu.getCoordinate()),"inconsistency in rightmost processing"),0===this.gu?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this.bu=this.wu,this.getRightmostSide(this.wu,this.gu)===Z.LEFT&&(this.bu=this.wu.getSym())}}],[{key:"constructor_",value:function(){this.gu=-1,this.yu=null,this.wu=null,this.bu=null}}]),ft=function(t){function i(t,r){var o;return n(this,i),(o=e(this,i,[r?t+" [ "+r+" ]":t])).pt=r?new j(r):void 0,o.name=Object.keys({TopologyException:i})[0],o}return h(i,t),o(i,[{key:"getCoordinate",value:function(){return this.pt}}])}(F),dt=o((function t(){n(this,t),this.array=[]}),[{key:"addLast",value:function(t){this.array.push(t)}},{key:"removeFirst",value:function(){return this.array.shift()}},{key:"isEmpty",value:function(){return 0===this.array.length}}]),pt=function(t){function i(t){var r;return n(this,i),(r=e(this,i)).array=[],t instanceof V&&r.addAll(t),r}return h(i,t),o(i,[{key:"interfaces_",get:function(){return[et,V]}},{key:"ensureCapacity",value:function(){}},{key:"add",value:function(t){return 1===arguments.length?this.array.push(t):this.array.splice(arguments[0],0,arguments[1]),!0}},{key:"clear",value:function(){this.array=[]}},{key:"addAll",value:function(t){var e,n=s(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.array.push(i)}}catch(t){n.e(t)}finally{n.f()}}},{key:"set",value:function(t,e){var n=this.array[t];return this.array[t]=e,n}},{key:"iterator",value:function(){return new vt(this)}},{key:"get",value:function(t){if(t<0||t>=this.size())throw new tt;return this.array[t]}},{key:"isEmpty",value:function(){return 0===this.array.length}},{key:"sort",value:function(t){t?this.array.sort((function(e,n){return t.compare(e,n)})):this.array.sort()}},{key:"size",value:function(){return this.array.length}},{key:"toArray",value:function(){return this.array.slice()}},{key:"remove",value:function(t){for(var e=0,n=this.array.length;e<n;e++)if(this.array[e]===t)return!!this.array.splice(e,1);return!1}},{key:Symbol.iterator,value:function(){return this.array.values()}}])}(et),vt=o((function t(e){n(this,t),this.arrayList=e,this.position=0}),[{key:"next",value:function(){if(this.position===this.arrayList.size())throw new G;return this.arrayList.get(this.position++)}},{key:"hasNext",value:function(){return this.position<this.arrayList.size()}},{key:"set",value:function(t){return this.arrayList.set(this.position-1,t)}},{key:"remove",value:function(){this.arrayList.remove(this.arrayList.get(this.position))}}]),mt=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"clearVisitedEdges",value:function(){for(var t=this._u.iterator();t.hasNext();)t.next().setVisited(!1)}},{key:"getRightmostCoordinate",value:function(){return this.xu}},{key:"computeNodeDepth",value:function(t){for(var e=null,n=t.getEdges().iterator();n.hasNext();){var i=n.next();if(i.isVisited()||i.getSym().isVisited()){e=i;break}}if(null===e)throw new ft("unable to find edge to compute depths at "+t.getCoordinate());t.getEdges().computeDepths(e);for(var r=t.getEdges().iterator();r.hasNext();){var o=r.next();o.setVisited(!0),this.copySymDepths(o)}}},{key:"computeDepth",value:function(t){this.clearVisitedEdges();var e=this.ku.getEdge();e.getNode(),e.getLabel(),e.setEdgeDepths(Z.RIGHT,t),this.copySymDepths(e),this.computeDepths(e)}},{key:"create",value:function(t){this.addReachable(t),this.ku.findEdge(this._u),this.xu=this.ku.getCoordinate()}},{key:"findResultEdges",value:function(){for(var t=this._u.iterator();t.hasNext();){var e=t.next();e.getDepth(Z.RIGHT)>=1&&e.getDepth(Z.LEFT)<=0&&!e.isInteriorAreaEdge()&&e.setInResult(!0)}}},{key:"computeDepths",value:function(t){var e=new X,n=new dt,i=t.getNode();for(n.addLast(i),e.add(i),t.setVisited(!0);!n.isEmpty();){var r=n.removeFirst();e.add(r),this.computeNodeDepth(r);for(var o=r.getEdges().iterator();o.hasNext();){var s=o.next().getSym();if(!s.isVisited()){var a=s.getNode();e.contains(a)||(n.addLast(a),e.add(a))}}}}},{key:"compareTo",value:function(t){var e=t;return this.xu.x<e.xu.x?-1:this.xu.x>e.xu.x?1:0}},{key:"getEnvelope",value:function(){if(null===this.$u){for(var t=new B,e=this._u.iterator();e.hasNext();)for(var n=e.next().getEdge().getCoordinates(),i=0;i<n.length-1;i++)t.expandToInclude(n[i]);this.$u=t}return this.$u}},{key:"addReachable",value:function(t){var e=new nt;for(e.add(t);!e.empty();){var n=e.pop();this.add(n,e)}}},{key:"copySymDepths",value:function(t){var e=t.getSym();e.setDepth(Z.LEFT,t.getDepth(Z.RIGHT)),e.setDepth(Z.RIGHT,t.getDepth(Z.LEFT))}},{key:"add",value:function(t,e){t.setVisited(!0),this.Su.add(t);for(var n=t.getEdges().iterator();n.hasNext();){var i=n.next();this._u.add(i);var r=i.getSym().getNode();r.isVisited()||e.push(r)}}},{key:"getNodes",value:function(){return this.Su}},{key:"getDirectedEdges",value:function(){return this._u}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this.ku=null,this._u=new pt,this.Su=new pt,this.xu=null,this.$u=null,this.ku=new ct}}]),yt=o((function t(){n(this,t)}),null,[{key:"intersection",value:function(t,e,n,i){var r=t.x<e.x?t.x:e.x,o=t.y<e.y?t.y:e.y,s=t.x>e.x?t.x:e.x,a=t.y>e.y?t.y:e.y,u=n.x<i.x?n.x:i.x,h=n.y<i.y?n.y:i.y,l=n.x>i.x?n.x:i.x,c=n.y>i.y?n.y:i.y,f=((r>u?r:u)+(s<l?s:l))/2,d=((o>h?o:h)+(a<c?a:c))/2,p=t.x-f,v=t.y-d,m=e.x-f,y=e.y-d,w=n.x-f,g=n.y-d,b=i.x-f,_=i.y-d,x=v-y,k=m-p,$=p*y-m*v,S=g-_,E=b-w,M=w*_-b*g,C=x*E-S*k,A=(k*M-E*$)/C,O=(S*$-x*M)/C;return z.isNaN(A)||z.isInfinite(A)||z.isNaN(O)||z.isInfinite(O)?null:new j(A+f,O+d)}}]),wt=o((function t(){n(this,t)}),null,[{key:"arraycopy",value:function(t,e,n,i,r){for(var o=0,s=e;s<e+r;s++)n[i+o]=t[s],o++}},{key:"getProperty",value:function(t){return{"line.separator":"\n"}[t]}}]),gt=function(){function t(){n(this,t)}return o(t,null,[{key:"log10",value:function(e){var n=Math.log(e);return z.isInfinite(n)||z.isNaN(n)?n:n/t.LOG_10}},{key:"min",value:function(t,e,n,i){var r=t;return e<r&&(r=e),n<r&&(r=n),i<r&&(r=i),r}},{key:"clamp",value:function(){if("number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1],n=arguments[2];return t<e?e:t>n?n:t}if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var i=arguments[0],r=arguments[1],o=arguments[2];return i<r?r:i>o?o:i}}},{key:"wrap",value:function(t,e){return t<0?e- -t%e:t%e}},{key:"max",value:function(){if(3===arguments.length){var t=arguments[1],e=arguments[2],n=arguments[0];return t>n&&(n=t),e>n&&(n=e),n}if(4===arguments.length){var i=arguments[1],r=arguments[2],o=arguments[3],s=arguments[0];return i>s&&(s=i),r>s&&(s=r),o>s&&(s=o),s}}},{key:"average",value:function(t,e){return(t+e)/2}}])}();gt.LOG_10=Math.log(10);var bt=function(){function t(){n(this,t)}return o(t,null,[{key:"segmentToSegment",value:function(e,n,i,r){if(e.equals(n))return t.pointToSegment(e,i,r);if(i.equals(r))return t.pointToSegment(r,e,n);var o=!1;if(B.intersects(e,n,i,r)){var s=(n.x-e.x)*(r.y-i.y)-(n.y-e.y)*(r.x-i.x);if(0===s)o=!0;else{var a=(e.y-i.y)*(r.x-i.x)-(e.x-i.x)*(r.y-i.y),u=((e.y-i.y)*(n.x-e.x)-(e.x-i.x)*(n.y-e.y))/s,h=a/s;(h<0||h>1||u<0||u>1)&&(o=!0)}}else o=!0;return o?gt.min(t.pointToSegment(e,i,r),t.pointToSegment(n,i,r),t.pointToSegment(i,e,n),t.pointToSegment(r,e,n)):0}},{key:"pointToSegment",value:function(t,e,n){if(e.x===n.x&&e.y===n.y)return t.distance(e);var i=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y),r=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/i;if(r<=0)return t.distance(e);if(r>=1)return t.distance(n);var o=((e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y))/i;return Math.abs(o)*Math.sqrt(i)}},{key:"pointToLinePerpendicular",value:function(t,e,n){var i=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y),r=((e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y))/i;return Math.abs(r)*Math.sqrt(i)}},{key:"pointToSegmentString",value:function(e,n){if(0===n.length)throw new g("Line array must contain at least one vertex");for(var i=e.distance(n[0]),r=0;r<n.length-1;r++){var o=t.pointToSegment(e,n[r],n[r+1]);o<i&&(i=o)}return i}}])}(),_t=o((function t(){n(this,t)}),[{key:"create",value:function(){if(1===arguments.length)arguments[0]instanceof Array||it(arguments[0],ht);else if(2===arguments.length);else if(3===arguments.length){var t=arguments[0],e=arguments[1];return this.create(t,e)}}}]),xt=o((function t(){n(this,t)}),[{key:"filter",value:function(t){}}]),kt=o((function t(){n(this,t)}),null,[{key:"ofLine",value:function(t){var e=t.size();if(e<=1)return 0;var n=0,i=new j;t.getCoordinate(0,i);for(var r=i.x,o=i.y,s=1;s<e;s++){t.getCoordinate(s,i);var a=i.x,u=i.y,h=a-r,l=u-o;n+=Math.sqrt(h*h+l*l),r=a,o=u}return n}}]),$t=o((function t(){n(this,t)})),St=function(){function t(){n(this,t)}return o(t,null,[{key:"copyCoord",value:function(t,e,n,i){for(var r=Math.min(t.getDimension(),n.getDimension()),o=0;o<r;o++)n.setOrdinate(i,o,t.getOrdinate(e,o))}},{key:"isRing",value:function(t){var e=t.size();return 0===e||!(e<=3)&&t.getOrdinate(0,ht.X)===t.getOrdinate(e-1,ht.X)&&t.getOrdinate(0,ht.Y)===t.getOrdinate(e-1,ht.Y)}},{key:"scroll",value:function(){if(2===arguments.length){if(it(arguments[0],ht)&&Number.isInteger(arguments[1])){var e=arguments[0],n=arguments[1];t.scroll(e,n,t.isRing(e))}else if(it(arguments[0],ht)&&arguments[1]instanceof j){var i=arguments[0],r=arguments[1],o=t.indexOf(r,i);if(o<=0)return null;t.scroll(i,o)}}else if(3===arguments.length){var s=arguments[0],a=arguments[1],u=arguments[2];if(a<=0)return null;for(var h=s.copy(),l=u?s.size()-1:s.size(),c=0;c<l;c++)for(var f=0;f<s.getDimension();f++)s.setOrdinate(c,f,h.getOrdinate((a+c)%l,f));if(u)for(var d=0;d<s.getDimension();d++)s.setOrdinate(l,d,s.getOrdinate(0,d))}}},{key:"isEqual",value:function(t,e){var n=t.size();if(n!==e.size())return!1;for(var i=Math.min(t.getDimension(),e.getDimension()),r=0;r<n;r++)for(var o=0;o<i;o++){var s=t.getOrdinate(r,o),a=e.getOrdinate(r,o);if(!(t.getOrdinate(r,o)===e.getOrdinate(r,o)||z.isNaN(s)&&z.isNaN(a)))return!1}return!0}},{key:"minCoordinateIndex",value:function(){if(1===arguments.length){var e=arguments[0];return t.minCoordinateIndex(e,0,e.size()-1)}if(3===arguments.length){for(var n=arguments[0],i=arguments[2],r=-1,o=null,s=arguments[1];s<=i;s++){var a=n.getCoordinate(s);(null===o||o.compareTo(a)>0)&&(o=a,r=s)}return r}}},{key:"extend",value:function(e,n,i){var r=e.create(i,n.getDimension()),o=n.size();if(t.copy(n,0,r,0,o),o>0)for(var s=o;s<i;s++)t.copy(n,o-1,r,s,1);return r}},{key:"reverse",value:function(e){for(var n=e.size()-1,i=Math.trunc(n/2),r=0;r<=i;r++)t.swap(e,r,n-r)}},{key:"swap",value:function(t,e,n){if(e===n)return null;for(var i=0;i<t.getDimension();i++){var r=t.getOrdinate(e,i);t.setOrdinate(e,i,t.getOrdinate(n,i)),t.setOrdinate(n,i,r)}}},{key:"copy",value:function(e,n,i,r,o){for(var s=0;s<o;s++)t.copyCoord(e,n+s,i,r+s)}},{key:"ensureValidRing",value:function(e,n){var i=n.size();return 0===i?n:i<=3?t.createClosedRing(e,n,4):n.getOrdinate(0,ht.X)===n.getOrdinate(i-1,ht.X)&&n.getOrdinate(0,ht.Y)===n.getOrdinate(i-1,ht.Y)?n:t.createClosedRing(e,n,i+1)}},{key:"indexOf",value:function(t,e){for(var n=0;n<e.size();n++)if(t.x===e.getOrdinate(n,ht.X)&&t.y===e.getOrdinate(n,ht.Y))return n;return-1}},{key:"createClosedRing",value:function(e,n,i){var r=e.create(i,n.getDimension()),o=n.size();t.copy(n,0,r,0,o);for(var s=o;s<i;s++)t.copy(n,0,r,s,1);return r}},{key:"minCoordinate",value:function(t){for(var e=null,n=0;n<t.size();n++){var i=t.getCoordinate(n);(null===e||e.compareTo(i)>0)&&(e=i)}return e}}])}(),Et=function(){function t(){n(this,t)}return o(t,null,[{key:"toDimensionSymbol",value:function(e){switch(e){case t.FALSE:return t.SYM_FALSE;case t.TRUE:return t.SYM_TRUE;case t.DONTCARE:return t.SYM_DONTCARE;case t.P:return t.SYM_P;case t.L:return t.SYM_L;case t.A:return t.SYM_A}throw new g("Unknown dimension value: "+e)}},{key:"toDimensionValue",value:function(e){switch(st.toUpperCase(e)){case t.SYM_FALSE:return t.FALSE;case t.SYM_TRUE:return t.TRUE;case t.SYM_DONTCARE:return t.DONTCARE;case t.SYM_P:return t.P;case t.SYM_L:return t.L;case t.SYM_A:return t.A}throw new g("Unknown dimension symbol: "+e)}}])}();Et.P=0,Et.L=1,Et.A=2,Et.FALSE=-1,Et.TRUE=-2,Et.DONTCARE=-3,Et.SYM_FALSE="F",Et.SYM_TRUE="T",Et.SYM_DONTCARE="*",Et.SYM_P="0",Et.SYM_L="1",Et.SYM_A="2";var Mt=o((function t(){n(this,t)}),[{key:"filter",value:function(t){}}]),Ct=o((function t(){n(this,t)}),[{key:"filter",value:function(t,e){}},{key:"isDone",value:function(){}},{key:"isGeometryChanged",value:function(){}}]),At=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"computeEnvelopeInternal",value:function(){return this.isEmpty()?new B:this.Yn.expandEnvelope(new B)}},{key:"isRing",value:function(){return this.isClosed()&&this.isSimple()}},{key:"getCoordinates",value:function(){return this.Yn.toCoordinateArray()}},{key:"copyInternal",value:function(){return new i(this.Yn.copy(),this.cu)}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];if(!this.isEquivalentClass(t))return!1;var n=t;if(this.Yn.size()!==n.Yn.size())return!1;for(var r=0;r<this.Yn.size();r++)if(!this.equal(this.Yn.getCoordinate(r),n.Yn.getCoordinate(r),e))return!1;return!0}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"normalize",value:function(){for(var t=0;t<Math.trunc(this.Yn.size()/2);t++){var e=this.Yn.size()-1-t;if(!this.Yn.getCoordinate(t).equals(this.Yn.getCoordinate(e))){if(this.Yn.getCoordinate(t).compareTo(this.Yn.getCoordinate(e))>0){var n=this.Yn.copy();St.reverse(n),this.Yn=n}return null}}}},{key:"getCoordinate",value:function(){return this.isEmpty()?null:this.Yn.getCoordinate(0)}},{key:"getBoundaryDimension",value:function(){return this.isClosed()?Et.FALSE:0}},{key:"isClosed",value:function(){return!this.isEmpty()&&this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))}},{key:"reverseInternal",value:function(){var t=this.Yn.copy();return St.reverse(t),this.getFactory().createLineString(t)}},{key:"getEndPoint",value:function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)}},{key:"getTypeCode",value:function(){return H.TYPECODE_LINESTRING}},{key:"getDimension",value:function(){return 1}},{key:"getLength",value:function(){return kt.ofLine(this.Yn)}},{key:"getNumPoints",value:function(){return this.Yn.size()}},{key:"compareToSameClass",value:function(){if(1===arguments.length){for(var t=arguments[0],e=0,n=0;e<this.Yn.size()&&n<t.Yn.size();){var i=this.Yn.getCoordinate(e).compareTo(t.Yn.getCoordinate(n));if(0!==i)return i;e++,n++}return e<this.Yn.size()?1:n<t.Yn.size()?-1:0}if(2===arguments.length){var r=arguments[0];return arguments[1].compare(this.Yn,r.Yn)}}},{key:"apply",value:function(){if(it(arguments[0],xt))for(var t=arguments[0],e=0;e<this.Yn.size();e++)t.filter(this.Yn.getCoordinate(e));else if(it(arguments[0],Ct)){var n=arguments[0];if(0===this.Yn.size())return null;for(var i=0;i<this.Yn.size()&&(n.filter(this.Yn,i),!n.isDone());i++);n.isGeometryChanged()&&this.geometryChanged()}else(it(arguments[0],Mt)||it(arguments[0],b))&&arguments[0].filter(this)}},{key:"getBoundary",value:function(){throw new Y}},{key:"isEquivalentClass",value:function(t){return t instanceof i}},{key:"getCoordinateN",value:function(t){return this.Yn.getCoordinate(t)}},{key:"getGeometryType",value:function(){return H.TYPENAME_LINESTRING}},{key:"getCoordinateSequence",value:function(){return this.Yn}},{key:"isEmpty",value:function(){return 0===this.Yn.size()}},{key:"init",value:function(t){if(null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),1===t.size())throw new g("Invalid number of points in LineString (found "+t.size()+" - must be 0 or >= 2)");this.Yn=t}},{key:"isCoordinate",value:function(t){for(var e=0;e<this.Yn.size();e++)if(this.Yn.getCoordinate(e).equals(t))return!0;return!1}},{key:"getStartPoint",value:function(){return this.isEmpty()?null:this.getPointN(0)}},{key:"getPointN",value:function(t){return this.getFactory().createPoint(this.Yn.getCoordinate(t))}},{key:"interfaces_",get:function(){return[$t]}}],[{key:"constructor_",value:function(){if(this.Yn=null,0===arguments.length);else if(2===arguments.length){var t=arguments[0],e=arguments[1];H.constructor_.call(this,e),this.init(t)}}}])}(H),Ot=o((function t(){n(this,t)})),It=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"computeEnvelopeInternal",value:function(){if(this.isEmpty())return new B;var t=new B;return t.expandToInclude(this.Eu.getX(0),this.Eu.getY(0)),t}},{key:"getCoordinates",value:function(){return this.isEmpty()?[]:[this.getCoordinate()]}},{key:"copyInternal",value:function(){return new i(this.Eu.copy(),this.cu)}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];return!!this.isEquivalentClass(t)&&(!(!this.isEmpty()||!t.isEmpty())||this.isEmpty()===t.isEmpty()&&this.equal(t.getCoordinate(),this.getCoordinate(),e))}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"normalize",value:function(){}},{key:"getCoordinate",value:function(){return 0!==this.Eu.size()?this.Eu.getCoordinate(0):null}},{key:"getBoundaryDimension",value:function(){return Et.FALSE}},{key:"reverseInternal",value:function(){return this.getFactory().createPoint(this.Eu.copy())}},{key:"getTypeCode",value:function(){return H.TYPECODE_POINT}},{key:"getDimension",value:function(){return 0}},{key:"getNumPoints",value:function(){return this.isEmpty()?0:1}},{key:"getX",value:function(){if(null===this.getCoordinate())throw new IllegalStateException("getX called on empty Point");return this.getCoordinate().x}},{key:"compareToSameClass",value:function(){if(1===arguments.length){var t=arguments[0];return this.getCoordinate().compareTo(t.getCoordinate())}if(2===arguments.length){var e=arguments[0];return arguments[1].compare(this.Eu,e.Eu)}}},{key:"apply",value:function(){if(it(arguments[0],xt)){var t=arguments[0];if(this.isEmpty())return null;t.filter(this.getCoordinate())}else if(it(arguments[0],Ct)){var e=arguments[0];if(this.isEmpty())return null;e.filter(this.Eu,0),e.isGeometryChanged()&&this.geometryChanged()}else(it(arguments[0],Mt)||it(arguments[0],b))&&arguments[0].filter(this)}},{key:"getBoundary",value:function(){return this.getFactory().createGeometryCollection()}},{key:"getGeometryType",value:function(){return H.TYPENAME_POINT}},{key:"getCoordinateSequence",value:function(){return this.Eu}},{key:"getY",value:function(){if(null===this.getCoordinate())throw new IllegalStateException("getY called on empty Point");return this.getCoordinate().y}},{key:"isEmpty",value:function(){return 0===this.Eu.size()}},{key:"init",value:function(t){null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),P.isTrue(t.size()<=1),this.Eu=t}},{key:"isSimple",value:function(){return!0}},{key:"interfaces_",get:function(){return[Ot]}}],[{key:"constructor_",value:function(){this.Eu=null;var t=arguments[0],e=arguments[1];H.constructor_.call(this,e),this.init(t)}}])}(H),Tt=function(){function t(){n(this,t)}return o(t,null,[{key:"ofRing",value:function(){if(arguments[0]instanceof Array){var e=arguments[0];return Math.abs(t.ofRingSigned(e))}if(it(arguments[0],ht)){var n=arguments[0];return Math.abs(t.ofRingSigned(n))}}},{key:"ofRingSigned",value:function(){if(arguments[0]instanceof Array){var t=arguments[0];if(t.length<3)return 0;for(var e=0,n=t[0].x,i=1;i<t.length-1;i++){var r=t[i].x-n,o=t[i+1].y;e+=r*(t[i-1].y-o)}return e/2}if(it(arguments[0],ht)){var s=arguments[0],a=s.size();if(a<3)return 0;var u=new j,h=new j,l=new j;s.getCoordinate(0,h),s.getCoordinate(1,l);var c=h.x;l.x-=c;for(var f=0,d=1;d<a-1;d++)u.y=h.y,h.x=l.x,h.y=l.y,s.getCoordinate(d+1,l),l.x-=c,f+=h.x*(u.y-l.y);return f/2}}}])}(),zt=o((function t(){n(this,t)}),null,[{key:"sort",value:function(){var t=arguments,e=arguments[0];if(1===arguments.length)e.sort((function(t,e){return t.compareTo(e)}));else if(2===arguments.length)e.sort((function(e,n){return t[1].compare(e,n)}));else if(3===arguments.length){var n=e.slice(arguments[1],arguments[2]);n.sort();var i=e.slice(0,arguments[1]).concat(n,e.slice(arguments[2],e.length));e.splice(0,e.length);var r,o=s(i);try{for(o.s();!(r=o.n()).done;){var a=r.value;e.push(a)}}catch(t){o.e(t)}finally{o.f()}}else if(4===arguments.length){var u=e.slice(arguments[1],arguments[2]);u.sort((function(e,n){return t[3].compare(e,n)}));var h=e.slice(0,arguments[1]).concat(u,e.slice(arguments[2],e.length));e.splice(0,e.length);var l,c=s(h);try{for(c.s();!(l=c.n()).done;){var f=l.value;e.push(f)}}catch(t){c.e(t)}finally{c.f()}}}},{key:"asList",value:function(t){var e,n=new pt,i=s(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;n.add(r)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"copyOf",value:function(t,e){return t.slice(0,e)}}]),Rt=o((function t(){n(this,t)})),Ft=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"computeEnvelopeInternal",value:function(){return this.Mu.getEnvelopeInternal()}},{key:"getCoordinates",value:function(){if(this.isEmpty())return[];for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=this.Mu.getCoordinates(),i=0;i<n.length;i++)t[++e]=n[i];for(var r=0;r<this.Cu.length;r++)for(var o=this.Cu[r].getCoordinates(),s=0;s<o.length;s++)t[++e]=o[s];return t}},{key:"getArea",value:function(){var t=0;t+=Tt.ofRing(this.Mu.getCoordinateSequence());for(var e=0;e<this.Cu.length;e++)t-=Tt.ofRing(this.Cu[e].getCoordinateSequence());return t}},{key:"copyInternal",value:function(){for(var t=this.Mu.copy(),e=new Array(this.Cu.length).fill(null),n=0;n<this.Cu.length;n++)e[n]=this.Cu[n].copy();return new i(t,e,this.cu)}},{key:"isRectangle",value:function(){if(0!==this.getNumInteriorRing())return!1;if(null===this.Mu)return!1;if(5!==this.Mu.getNumPoints())return!1;for(var t=this.Mu.getCoordinateSequence(),e=this.getEnvelopeInternal(),n=0;n<5;n++){var i=t.getX(n);if(i!==e.getMinX()&&i!==e.getMaxX())return!1;var r=t.getY(n);if(r!==e.getMinY()&&r!==e.getMaxY())return!1}for(var o=t.getX(0),s=t.getY(0),a=1;a<=4;a++){var u=t.getX(a),h=t.getY(a);if(u!==o==(h!==s))return!1;o=u,s=h}return!0}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];if(!this.isEquivalentClass(t))return!1;var n=t,r=this.Mu,o=n.Mu;if(!r.equalsExact(o,e))return!1;if(this.Cu.length!==n.Cu.length)return!1;for(var s=0;s<this.Cu.length;s++)if(!this.Cu[s].equalsExact(n.Cu[s],e))return!1;return!0}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"normalize",value:function(){if(0===arguments.length){this.Mu=this.normalized(this.Mu,!0);for(var t=0;t<this.Cu.length;t++)this.Cu[t]=this.normalized(this.Cu[t],!1);zt.sort(this.Cu)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(e.isEmpty())return null;var i=e.getCoordinateSequence(),r=St.minCoordinateIndex(i,0,i.size()-2);St.scroll(i,r,!0),lt.isCCW(i)===n&&St.reverse(i)}}},{key:"getCoordinate",value:function(){return this.Mu.getCoordinate()}},{key:"getNumInteriorRing",value:function(){return this.Cu.length}},{key:"getBoundaryDimension",value:function(){return 1}},{key:"reverseInternal",value:function(){for(var t=this.getExteriorRing().reverse(),e=new Array(this.getNumInteriorRing()).fill(null),n=0;n<e.length;n++)e[n]=this.getInteriorRingN(n).reverse();return this.getFactory().createPolygon(t,e)}},{key:"getTypeCode",value:function(){return H.TYPECODE_POLYGON}},{key:"getDimension",value:function(){return 2}},{key:"getLength",value:function(){var t=0;t+=this.Mu.getLength();for(var e=0;e<this.Cu.length;e++)t+=this.Cu[e].getLength();return t}},{key:"getNumPoints",value:function(){for(var t=this.Mu.getNumPoints(),e=0;e<this.Cu.length;e++)t+=this.Cu[e].getNumPoints();return t}},{key:"convexHull",value:function(){return this.getExteriorRing().convexHull()}},{key:"normalized",value:function(t,e){var n=t.copy();return this.normalize(n,e),n}},{key:"compareToSameClass",value:function(){if(1===arguments.length){var t=arguments[0],e=this.Mu,n=t.Mu;return e.compareToSameClass(n)}if(2===arguments.length){var i=arguments[1],r=arguments[0],o=this.Mu,s=r.Mu,a=o.compareToSameClass(s,i);if(0!==a)return a;for(var u=this.getNumInteriorRing(),h=r.getNumInteriorRing(),l=0;l<u&&l<h;){var c=this.getInteriorRingN(l),f=r.getInteriorRingN(l),d=c.compareToSameClass(f,i);if(0!==d)return d;l++}return l<u?1:l<h?-1:0}}},{key:"apply",value:function(){if(it(arguments[0],xt)){var t=arguments[0];this.Mu.apply(t);for(var e=0;e<this.Cu.length;e++)this.Cu[e].apply(t)}else if(it(arguments[0],Ct)){var n=arguments[0];if(this.Mu.apply(n),!n.isDone())for(var i=0;i<this.Cu.length&&(this.Cu[i].apply(n),!n.isDone());i++);n.isGeometryChanged()&&this.geometryChanged()}else if(it(arguments[0],Mt))arguments[0].filter(this);else if(it(arguments[0],b)){var r=arguments[0];r.filter(this),this.Mu.apply(r);for(var o=0;o<this.Cu.length;o++)this.Cu[o].apply(r)}}},{key:"getBoundary",value:function(){if(this.isEmpty())return this.getFactory().createMultiLineString();var t=new Array(this.Cu.length+1).fill(null);t[0]=this.Mu;for(var e=0;e<this.Cu.length;e++)t[e+1]=this.Cu[e];return t.length<=1?this.getFactory().createLinearRing(t[0].getCoordinateSequence()):this.getFactory().createMultiLineString(t)}},{key:"getGeometryType",value:function(){return H.TYPENAME_POLYGON}},{key:"getExteriorRing",value:function(){return this.Mu}},{key:"isEmpty",value:function(){return this.Mu.isEmpty()}},{key:"getInteriorRingN",value:function(t){return this.Cu[t]}},{key:"interfaces_",get:function(){return[Rt]}}],[{key:"constructor_",value:function(){this.Mu=null,this.Cu=null;var t=arguments[0],e=arguments[1],n=arguments[2];if(H.constructor_.call(this,n),null===t&&(t=this.getFactory().createLinearRing()),null===e&&(e=[]),H.hasNullElements(e))throw new g("holes must not contain null elements");if(t.isEmpty()&&H.hasNonEmptyElements(e))throw new g("shell is empty but holes are not");this.Mu=t,this.Cu=e}}])}(H),Dt=function(t){function i(){return n(this,i),e(this,i,arguments)}return h(i,t),o(i)}(K),Pt=function(t){function i(t){var r;return n(this,i),(r=e(this,i)).array=[],t instanceof V&&r.addAll(t),r}return h(i,t),o(i,[{key:"contains",value:function(t){var e,n=s(this.array);try{for(n.s();!(e=n.n()).done;)if(0===e.value.compareTo(t))return!0}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"add",value:function(t){if(this.contains(t))return!1;for(var e=0,n=this.array.length;e<n;e++)if(1===this.array[e].compareTo(t))return!!this.array.splice(e,0,t);return this.array.push(t),!0}},{key:"addAll",value:function(t){var e,n=s(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.add(i)}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"remove",value:function(){throw new Y}},{key:"size",value:function(){return this.array.length}},{key:"isEmpty",value:function(){return 0===this.array.length}},{key:"toArray",value:function(){return this.array.slice()}},{key:"iterator",value:function(){return new Nt(this.array)}}])}(Dt),Nt=o((function t(e){n(this,t),this.array=e,this.position=0}),[{key:"next",value:function(){if(this.position===this.array.length)throw new G;return this.array[this.position++]}},{key:"hasNext",value:function(){return this.position<this.array.length}},{key:"remove",value:function(){throw new Y}}]),Ut=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"computeEnvelopeInternal",value:function(){for(var t=new B,e=0;e<this.Au.length;e++)t.expandToInclude(this.Au[e].getEnvelopeInternal());return t}},{key:"getGeometryN",value:function(t){return this.Au[t]}},{key:"getCoordinates",value:function(){for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=0;n<this.Au.length;n++)for(var i=this.Au[n].getCoordinates(),r=0;r<i.length;r++)t[++e]=i[r];return t}},{key:"getArea",value:function(){for(var t=0,e=0;e<this.Au.length;e++)t+=this.Au[e].getArea();return t}},{key:"copyInternal",value:function(){for(var t=new Array(this.Au.length).fill(null),e=0;e<t.length;e++)t[e]=this.Au[e].copy();return new i(t,this.cu)}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];if(!this.isEquivalentClass(t))return!1;var n=t;if(this.Au.length!==n.Au.length)return!1;for(var r=0;r<this.Au.length;r++)if(!this.Au[r].equalsExact(n.Au[r],e))return!1;return!0}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"normalize",value:function(){for(var t=0;t<this.Au.length;t++)this.Au[t].normalize();zt.sort(this.Au)}},{key:"getCoordinate",value:function(){return this.isEmpty()?null:this.Au[0].getCoordinate()}},{key:"getBoundaryDimension",value:function(){for(var t=Et.FALSE,e=0;e<this.Au.length;e++)t=Math.max(t,this.Au[e].getBoundaryDimension());return t}},{key:"reverseInternal",value:function(){for(var t=this.Au.length,e=new pt(t),n=0;n<t;n++)e.add(this.Au[n].reverse());return this.getFactory().buildGeometry(e)}},{key:"getTypeCode",value:function(){return H.TYPECODE_GEOMETRYCOLLECTION}},{key:"getDimension",value:function(){for(var t=Et.FALSE,e=0;e<this.Au.length;e++)t=Math.max(t,this.Au[e].getDimension());return t}},{key:"getLength",value:function(){for(var t=0,e=0;e<this.Au.length;e++)t+=this.Au[e].getLength();return t}},{key:"getNumPoints",value:function(){for(var t=0,e=0;e<this.Au.length;e++)t+=this.Au[e].getNumPoints();return t}},{key:"getNumGeometries",value:function(){return this.Au.length}},{key:"compareToSameClass",value:function(){if(1===arguments.length){var t=arguments[0],e=new Pt(zt.asList(this.Au)),n=new Pt(zt.asList(t.Au));return this.compare(e,n)}if(2===arguments.length){for(var i=arguments[1],r=arguments[0],o=this.getNumGeometries(),s=r.getNumGeometries(),a=0;a<o&&a<s;){var u=this.getGeometryN(a),h=r.getGeometryN(a),l=u.compareToSameClass(h,i);if(0!==l)return l;a++}return a<o?1:a<s?-1:0}}},{key:"apply",value:function(){if(it(arguments[0],xt))for(var t=arguments[0],e=0;e<this.Au.length;e++)this.Au[e].apply(t);else if(it(arguments[0],Ct)){var n=arguments[0];if(0===this.Au.length)return null;for(var i=0;i<this.Au.length&&(this.Au[i].apply(n),!n.isDone());i++);n.isGeometryChanged()&&this.geometryChanged()}else if(it(arguments[0],Mt)){var r=arguments[0];r.filter(this);for(var o=0;o<this.Au.length;o++)this.Au[o].apply(r)}else if(it(arguments[0],b)){var s=arguments[0];s.filter(this);for(var a=0;a<this.Au.length;a++)this.Au[a].apply(s)}}},{key:"getBoundary",value:function(){return H.checkNotGeometryCollection(this),P.shouldNeverReachHere(),null}},{key:"getGeometryType",value:function(){return H.TYPENAME_GEOMETRYCOLLECTION}},{key:"isEmpty",value:function(){for(var t=0;t<this.Au.length;t++)if(!this.Au[t].isEmpty())return!1;return!0}}],[{key:"constructor_",value:function(){if(this.Au=null,0===arguments.length);else if(2===arguments.length){var t=arguments[0],e=arguments[1];if(H.constructor_.call(this,e),null===t&&(t=[]),H.hasNullElements(t))throw new g("geometries must not contain null elements");this.Au=t}}}])}(H),qt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"copyInternal",value:function(){for(var t=new Array(this.Au.length).fill(null),e=0;e<t.length;e++)t[e]=this.Au[e].copy();return new i(t,this.cu)}},{key:"isValid",value:function(){return!0}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];return!!this.isEquivalentClass(t)&&f(i,"equalsExact",this,1).call(this,t,e)}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"getCoordinate",value:function(){if(1===arguments.length&&Number.isInteger(arguments[0])){var t=arguments[0];return this.Au[t].getCoordinate()}return f(i,"getCoordinate",this,1).apply(this,arguments)}},{key:"getBoundaryDimension",value:function(){return Et.FALSE}},{key:"getTypeCode",value:function(){return H.TYPECODE_MULTIPOINT}},{key:"getDimension",value:function(){return 0}},{key:"getBoundary",value:function(){return this.getFactory().createGeometryCollection()}},{key:"getGeometryType",value:function(){return H.TYPENAME_MULTIPOINT}},{key:"interfaces_",get:function(){return[Ot]}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];Ut.constructor_.call(this,t,e)}}])}(Ut),jt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"copyInternal",value:function(){return new i(this.Yn.copy(),this.cu)}},{key:"getBoundaryDimension",value:function(){return Et.FALSE}},{key:"isClosed",value:function(){return!!this.isEmpty()||f(i,"isClosed",this,1).call(this)}},{key:"reverseInternal",value:function(){var t=this.Yn.copy();return St.reverse(t),this.getFactory().createLinearRing(t)}},{key:"getTypeCode",value:function(){return H.TYPECODE_LINEARRING}},{key:"validateConstruction",value:function(){if(!this.isEmpty()&&!f(i,"isClosed",this,1).call(this))throw new g("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<i.MINIMUM_VALID_SIZE)throw new g("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")}},{key:"getGeometryType",value:function(){return H.TYPENAME_LINEARRING}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];At.constructor_.call(this,t,e),this.validateConstruction()}}])}(At);jt.MINIMUM_VALID_SIZE=4;var Lt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"setOrdinate",value:function(t,e){switch(t){case i.X:this.x=e;break;case i.Y:this.y=e;break;default:throw new g("Invalid ordinate index: "+t)}}},{key:"getZ",value:function(){return j.NULL_ORDINATE}},{key:"getOrdinate",value:function(t){switch(t){case i.X:return this.x;case i.Y:return this.y}throw new g("Invalid ordinate index: "+t)}},{key:"setZ",value:function(t){throw new g("CoordinateXY dimension 2 does not support z-ordinate")}},{key:"copy",value:function(){return new i(this)}},{key:"toString",value:function(){return"("+this.x+", "+this.y+")"}},{key:"setCoordinate",value:function(t){this.x=t.x,this.y=t.y,this.z=t.getZ()}}],[{key:"constructor_",value:function(){if(0===arguments.length)j.constructor_.call(this);else if(1===arguments.length){if(arguments[0]instanceof i){var t=arguments[0];j.constructor_.call(this,t.x,t.y)}else if(arguments[0]instanceof j){var e=arguments[0];j.constructor_.call(this,e.x,e.y)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];j.constructor_.call(this,n,r,j.NULL_ORDINATE)}}}])}(j);Lt.X=0,Lt.Y=1,Lt.Z=-1,Lt.M=-1;var Bt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getM",value:function(){return this.Ou}},{key:"setOrdinate",value:function(t,e){switch(t){case i.X:this.x=e;break;case i.Y:this.y=e;break;case i.M:this.Ou=e;break;default:throw new g("Invalid ordinate index: "+t)}}},{key:"setM",value:function(t){this.Ou=t}},{key:"getZ",value:function(){return j.NULL_ORDINATE}},{key:"getOrdinate",value:function(t){switch(t){case i.X:return this.x;case i.Y:return this.y;case i.M:return this.Ou}throw new g("Invalid ordinate index: "+t)}},{key:"setZ",value:function(t){throw new g("CoordinateXY dimension 2 does not support z-ordinate")}},{key:"copy",value:function(){return new i(this)}},{key:"toString",value:function(){return"("+this.x+", "+this.y+" m="+this.getM()+")"}},{key:"setCoordinate",value:function(t){this.x=t.x,this.y=t.y,this.z=t.getZ(),this.Ou=t.getM()}}],[{key:"constructor_",value:function(){if(this.Ou=null,0===arguments.length)j.constructor_.call(this),this.Ou=0;else if(1===arguments.length){if(arguments[0]instanceof i){var t=arguments[0];j.constructor_.call(this,t.x,t.y),this.Ou=t.Ou}else if(arguments[0]instanceof j){var e=arguments[0];j.constructor_.call(this,e.x,e.y),this.Ou=this.getM()}}else if(3===arguments.length){var n=arguments[0],r=arguments[1],o=arguments[2];j.constructor_.call(this,n,r,j.NULL_ORDINATE),this.Ou=o}}}])}(j);Bt.X=0,Bt.Y=1,Bt.Z=-1,Bt.M=2;var Ht=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getM",value:function(){return this.Ou}},{key:"setOrdinate",value:function(t,e){switch(t){case j.X:this.x=e;break;case j.Y:this.y=e;break;case j.Z:this.z=e;break;case j.M:this.Ou=e;break;default:throw new g("Invalid ordinate index: "+t)}}},{key:"setM",value:function(t){this.Ou=t}},{key:"getOrdinate",value:function(t){switch(t){case j.X:return this.x;case j.Y:return this.y;case j.Z:return this.getZ();case j.M:return this.getM()}throw new g("Invalid ordinate index: "+t)}},{key:"copy",value:function(){return new i(this)}},{key:"toString",value:function(){return"("+this.x+", "+this.y+", "+this.getZ()+" m="+this.getM()+")"}},{key:"setCoordinate",value:function(t){this.x=t.x,this.y=t.y,this.z=t.getZ(),this.Ou=t.getM()}}],[{key:"constructor_",value:function(){if(this.Ou=null,0===arguments.length)j.constructor_.call(this),this.Ou=0;else if(1===arguments.length){if(arguments[0]instanceof i){var t=arguments[0];j.constructor_.call(this,t),this.Ou=t.Ou}else if(arguments[0]instanceof j){var e=arguments[0];j.constructor_.call(this,e),this.Ou=this.getM()}}else if(4===arguments.length){var n=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3];j.constructor_.call(this,n,r,o),this.Ou=s}}}])}(j),Wt=function(){function t(){n(this,t)}return o(t,null,[{key:"measures",value:function(t){return t instanceof Lt?0:t instanceof Bt||t instanceof Ht?1:0}},{key:"dimension",value:function(t){return t instanceof Lt?2:t instanceof Bt?3:t instanceof Ht?4:3}},{key:"create",value:function(){if(1===arguments.length){var e=arguments[0];return t.create(e,0)}if(2===arguments.length){var n=arguments[0],i=arguments[1];return 2===n?new Lt:3===n&&0===i?new j:3===n&&1===i?new Bt:4===n&&1===i?new Ht:new j}}}])}(),Vt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getCoordinate",value:function(t){return this.get(t)}},{key:"addAll",value:function(){if(2===arguments.length&&"boolean"==typeof arguments[1]&&it(arguments[0],V)){for(var t=arguments[1],e=!1,n=arguments[0].iterator();n.hasNext();)this.add(n.next(),t),e=!0;return e}return f(i,"addAll",this,1).apply(this,arguments)}},{key:"clone",value:function(){for(var t=f(i,"clone",this,1).call(this),e=0;e<this.size();e++)t.add(e,this.get(e).clone());return t}},{key:"toCoordinateArray",value:function(){if(0===arguments.length)return this.toArray(i.coordArrayType);if(1===arguments.length){if(arguments[0])return this.toArray(i.coordArrayType);for(var t=this.size(),e=new Array(t).fill(null),n=0;n<t;n++)e[n]=this.get(t-n-1);return e}}},{key:"add",value:function(){if(1===arguments.length){var t=arguments[0];return f(i,"add",this,1).call(this,t)}if(2===arguments.length){if(arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var e=arguments[0],n=arguments[1];return this.add(e,n,!0),!0}if(arguments[0]instanceof j&&"boolean"==typeof arguments[1]){var r=arguments[0];if(!arguments[1]&&this.size()>=1&&this.get(this.size()-1).equals2D(r))return null;f(i,"add",this,1).call(this,r)}else if(arguments[0]instanceof Object&&"boolean"==typeof arguments[1]){var o=arguments[0],s=arguments[1];return this.add(o,s),!0}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var a=arguments[0],u=arguments[1];if(arguments[2])for(var h=0;h<a.length;h++)this.add(a[h],u);else for(var l=a.length-1;l>=0;l--)this.add(a[l],u);return!0}if("boolean"==typeof arguments[2]&&Number.isInteger(arguments[0])&&arguments[1]instanceof j){var c=arguments[0],d=arguments[1];if(!arguments[2]){var p=this.size();if(p>0){if(c>0&&this.get(c-1).equals2D(d))return null;if(c<p&&this.get(c).equals2D(d))return null}}f(i,"add",this,1).call(this,c,d)}}else if(4===arguments.length){var v=arguments[0],m=arguments[1],y=arguments[2],w=arguments[3],g=1;y>w&&(g=-1);for(var b=y;b!==w;b+=g)this.add(v[b],m);return!0}}},{key:"closeRing",value:function(){if(this.size()>0){var t=this.get(0).copy();this.add(t,!1)}}}],[{key:"constructor_",value:function(){if(0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.ensureCapacity(t.length),this.add(t,!0)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.ensureCapacity(e.length),this.add(e,n)}}}])}(pt);Vt.coordArrayType=new Array(0).fill(null);var Gt=function(){function t(){n(this,t)}return o(t,null,[{key:"isRing",value:function(t){return!(t.length<4||!t[0].equals2D(t[t.length-1]))}},{key:"ptNotInList",value:function(e,n){for(var i=0;i<e.length;i++){var r=e[i];if(t.indexOf(r,n)<0)return r}return null}},{key:"scroll",value:function(e,n){var i=t.indexOf(n,e);if(i<0)return null;var r=new Array(e.length).fill(null);wt.arraycopy(e,i,r,0,e.length-i),wt.arraycopy(e,0,r,e.length-i,i),wt.arraycopy(r,0,e,0,e.length)}},{key:"equals",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].equals(e[n]))return!1;return!0}if(3===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2];if(i===r)return!0;if(null===i||null===r)return!1;if(i.length!==r.length)return!1;for(var s=0;s<i.length;s++)if(0!==o.compare(i[s],r[s]))return!1;return!0}}},{key:"intersection",value:function(t,e){for(var n=new Vt,i=0;i<t.length;i++)e.intersects(t[i])&&n.add(t[i],!0);return n.toCoordinateArray()}},{key:"measures",value:function(t){if(null===t||0===t.length)return 0;var e,n=0,i=s(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;n=Math.max(n,Wt.measures(r))}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"hasRepeatedPoints",value:function(t){for(var e=1;e<t.length;e++)if(t[e-1].equals(t[e]))return!0;return!1}},{key:"removeRepeatedPoints",value:function(e){return t.hasRepeatedPoints(e)?new Vt(e,!1).toCoordinateArray():e}},{key:"reverse",value:function(t){for(var e=t.length-1,n=Math.trunc(e/2),i=0;i<=n;i++){var r=t[i];t[i]=t[e-i],t[e-i]=r}}},{key:"removeNull",value:function(t){for(var e=0,n=0;n<t.length;n++)null!==t[n]&&e++;var i=new Array(e).fill(null);if(0===e)return i;for(var r=0,o=0;o<t.length;o++)null!==t[o]&&(i[r++]=t[o]);return i}},{key:"copyDeep",value:function(){if(1===arguments.length){for(var t=arguments[0],e=new Array(t.length).fill(null),n=0;n<t.length;n++)e[n]=t[n].copy();return e}if(5===arguments.length)for(var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=arguments[4],u=0;u<a;u++)o[s+u]=i[r+u].copy()}},{key:"isEqualReversed",value:function(t,e){for(var n=0;n<t.length;n++){var i=t[n],r=e[t.length-n-1];if(0!==i.compareTo(r))return!1}return!0}},{key:"envelope",value:function(t){for(var e=new B,n=0;n<t.length;n++)e.expandToInclude(t[n]);return e}},{key:"toCoordinateArray",value:function(e){return e.toArray(t.coordArrayType)}},{key:"dimension",value:function(t){if(null===t||0===t.length)return 3;var e,n=0,i=s(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;n=Math.max(n,Wt.dimension(r))}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"atLeastNCoordinatesOrNothing",value:function(t,e){return e.length>=t?e:[]}},{key:"indexOf",value:function(t,e){for(var n=0;n<e.length;n++)if(t.equals(e[n]))return n;return-1}},{key:"increasingDirection",value:function(t){for(var e=0;e<Math.trunc(t.length/2);e++){var n=t.length-1-e,i=t[e].compareTo(t[n]);if(0!==i)return i}return 1}},{key:"compare",value:function(t,e){for(var n=0;n<t.length&&n<e.length;){var i=t[n].compareTo(e[n]);if(0!==i)return i;n++}return n<e.length?-1:n<t.length?1:0}},{key:"minCoordinate",value:function(t){for(var e=null,n=0;n<t.length;n++)(null===e||e.compareTo(t[n])>0)&&(e=t[n]);return e}},{key:"extract",value:function(t,e,n){e=gt.clamp(e,0,t.length);var i=(n=gt.clamp(n,-1,t.length))-e+1;n<0&&(i=0),e>=t.length&&(i=0),n<e&&(i=0);var r=new Array(i).fill(null);if(0===i)return r;for(var o=0,s=e;s<=n;s++)r[o++]=t[s];return r}}])}(),Yt=o((function t(){n(this,t)}),[{key:"compare",value:function(t,e){var n=t,i=e;return Gt.compare(n,i)}},{key:"interfaces_",get:function(){return[R]}}]),Kt=o((function t(){n(this,t)}),[{key:"compare",value:function(t,e){var n=t,i=e;if(n.length<i.length)return-1;if(n.length>i.length)return 1;if(0===n.length)return 0;var r=Gt.compare(n,i);return Gt.isEqualReversed(n,i)?0:r}},{key:"OLDcompare",value:function(t,e){var n=t,i=e;if(n.length<i.length)return-1;if(n.length>i.length)return 1;if(0===n.length)return 0;for(var r=Gt.increasingDirection(n),o=Gt.increasingDirection(i),s=r>0?0:n.length-1,a=o>0?0:n.length-1,u=0;u<n.length;u++){var h=n[s].compareTo(i[a]);if(0!==h)return h;s+=r,a+=o}return 0}},{key:"interfaces_",get:function(){return[R]}}]);Gt.ForwardComparator=Yt,Gt.BidirectionalComparator=Kt,Gt.coordArrayType=new Array(0).fill(null);var Xt=o((function t(e){n(this,t),this.str=e}),[{key:"append",value:function(t){this.str+=t}},{key:"setCharAt",value:function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)}},{key:"toString",value:function(){return this.str}}]),Qt=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getM",value:function(t){return this.hasM()?this.Eu[t].getM():z.NaN}},{key:"setOrdinate",value:function(t,e,n){switch(e){case ht.X:this.Eu[t].x=n;break;case ht.Y:this.Eu[t].y=n;break;default:this.Eu[t].setOrdinate(e,n)}}},{key:"getZ",value:function(t){return this.hasZ()?this.Eu[t].getZ():z.NaN}},{key:"size",value:function(){return this.Eu.length}},{key:"getOrdinate",value:function(t,e){switch(e){case ht.X:return this.Eu[t].x;case ht.Y:return this.Eu[t].y;default:return this.Eu[t].getOrdinate(e)}}},{key:"getCoordinate",value:function(){if(1===arguments.length){var t=arguments[0];return this.Eu[t]}if(2===arguments.length){var e=arguments[0];arguments[1].setCoordinate(this.Eu[e])}}},{key:"getCoordinateCopy",value:function(t){var e=this.createCoordinate();return e.setCoordinate(this.Eu[t]),e}},{key:"createCoordinate",value:function(){return Wt.create(this.getDimension(),this.getMeasures())}},{key:"getDimension",value:function(){return this.Iu}},{key:"getX",value:function(t){return this.Eu[t].x}},{key:"getMeasures",value:function(){return this.Tu}},{key:"expandEnvelope",value:function(t){for(var e=0;e<this.Eu.length;e++)t.expandToInclude(this.Eu[e]);return t}},{key:"copy",value:function(){for(var e=new Array(this.size()).fill(null),n=0;n<this.Eu.length;n++){var i=this.createCoordinate();i.setCoordinate(this.Eu[n]),e[n]=i}return new t(e,this.Iu,this.Tu)}},{key:"toString",value:function(){if(this.Eu.length>0){var t=new Xt(17*this.Eu.length);t.append("("),t.append(this.Eu[0]);for(var e=1;e<this.Eu.length;e++)t.append(", "),t.append(this.Eu[e]);return t.append(")"),t.toString()}return"()"}},{key:"getY",value:function(t){return this.Eu[t].y}},{key:"toCoordinateArray",value:function(){return this.Eu}},{key:"interfaces_",get:function(){return[ht,k]}}],[{key:"constructor_",value:function(){if(this.Iu=3,this.Tu=0,this.Eu=null,1===arguments.length){if(arguments[0]instanceof Array){var e=arguments[0];t.constructor_.call(this,e,Gt.dimension(e),Gt.measures(e))}else if(Number.isInteger(arguments[0])){var n=arguments[0];this.Eu=new Array(n).fill(null);for(var i=0;i<n;i++)this.Eu[i]=new j}else if(it(arguments[0],ht)){var r=arguments[0];if(null===r)return this.Eu=new Array(0).fill(null),null;this.Iu=r.getDimension(),this.Tu=r.getMeasures(),this.Eu=new Array(r.size()).fill(null);for(var o=0;o<this.Eu.length;o++)this.Eu[o]=r.getCoordinateCopy(o)}}else if(2===arguments.length){if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var s=arguments[0],a=arguments[1];t.constructor_.call(this,s,a,Gt.measures(s))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var u=arguments[0],h=arguments[1];this.Eu=new Array(u).fill(null),this.Iu=h;for(var l=0;l<u;l++)this.Eu[l]=Wt.create(h)}}else if(3===arguments.length)if(Number.isInteger(arguments[2])&&arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var c=arguments[0],f=arguments[1],d=arguments[2];this.Iu=f,this.Tu=d,this.Eu=null===c?new Array(0).fill(null):c}else if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var p=arguments[0],v=arguments[1],m=arguments[2];this.Eu=new Array(p).fill(null),this.Iu=v,this.Tu=m;for(var y=0;y<p;y++)this.Eu[y]=this.createCoordinate()}}}])}(),Zt=function(){function t(){n(this,t)}return o(t,[{key:"readResolve",value:function(){return t.instance()}},{key:"create",value:function(){if(1===arguments.length){if(arguments[0]instanceof Array)return new Qt(arguments[0]);if(it(arguments[0],ht))return new Qt(arguments[0])}else{if(2===arguments.length){var t=arguments[1];return t>3&&(t=3),t<2&&(t=2),new Qt(arguments[0],t)}if(3===arguments.length){var e=arguments[2],n=arguments[1]-e;return e>1&&(e=1),n>3&&(n=3),n<2&&(n=2),new Qt(arguments[0],n+e,e)}}}},{key:"interfaces_",get:function(){return[_t,k]}}],[{key:"instance",value:function(){return t.instanceObject}}])}();Zt.instanceObject=new Zt;var Jt=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"copyInternal",value:function(){for(var t=new Array(this.Au.length).fill(null),e=0;e<t.length;e++)t[e]=this.Au[e].copy();return new i(t,this.cu)}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];return!!this.isEquivalentClass(t)&&f(i,"equalsExact",this,1).call(this,t,e)}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"getBoundaryDimension",value:function(){return 1}},{key:"getTypeCode",value:function(){return H.TYPECODE_MULTIPOLYGON}},{key:"getDimension",value:function(){return 2}},{key:"getBoundary",value:function(){if(this.isEmpty())return this.getFactory().createMultiLineString();for(var t=new pt,e=0;e<this.Au.length;e++)for(var n=this.Au[e].getBoundary(),i=0;i<n.getNumGeometries();i++)t.add(n.getGeometryN(i));var r=new Array(t.size()).fill(null);return this.getFactory().createMultiLineString(t.toArray(r))}},{key:"getGeometryType",value:function(){return H.TYPENAME_MULTIPOLYGON}},{key:"interfaces_",get:function(){return[Rt]}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];Ut.constructor_.call(this,t,e)}}])}(Ut),te=o((function t(){n(this,t)}),[{key:"get",value:function(){}},{key:"put",value:function(){}},{key:"size",value:function(){}},{key:"values",value:function(){}},{key:"entrySet",value:function(){}}]),ee=function(t){function i(){var t;return n(this,i),(t=e(this,i)).map=new Map,t}return h(i,t),o(i,[{key:"get",value:function(t){return this.map.get(t)||null}},{key:"put",value:function(t,e){return this.map.set(t,e),e}},{key:"values",value:function(){for(var t=new pt,e=this.map.values(),n=e.next();!n.done;)t.add(n.value),n=e.next();return t}},{key:"entrySet",value:function(){var t=new X;return this.map.entries().forEach((function(e){return t.add(e)})),t}},{key:"size",value:function(){return this.map.size()}}])}(te),ne=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"equals",value:function(e){if(!(e instanceof t))return!1;var n=e;return this.zu===n.zu&&this.vr===n.vr}},{key:"compareTo",value:function(t){var e=t,n=this.getMaximumSignificantDigits(),i=e.getMaximumSignificantDigits();return ot.compare(n,i)}},{key:"getScale",value:function(){return this.vr}},{key:"isFloating",value:function(){return this.zu===t.FLOATING||this.zu===t.FLOATING_SINGLE}},{key:"getType",value:function(){return this.zu}},{key:"toString",value:function(){var e="UNKNOWN";return this.zu===t.FLOATING?e="Floating":this.zu===t.FLOATING_SINGLE?e="Floating-Single":this.zu===t.FIXED&&(e="Fixed (Scale="+this.getScale()+")"),e}},{key:"makePrecise",value:function(){if("number"==typeof arguments[0]){var e=arguments[0];return z.isNaN(e)||this.zu===t.FLOATING_SINGLE?e:this.zu===t.FIXED?Math.round(e*this.vr)/this.vr:e}if(arguments[0]instanceof j){var n=arguments[0];if(this.zu===t.FLOATING)return null;n.x=this.makePrecise(n.x),n.y=this.makePrecise(n.y)}}},{key:"getMaximumSignificantDigits",value:function(){var e=16;return this.zu===t.FLOATING?e=16:this.zu===t.FLOATING_SINGLE?e=6:this.zu===t.FIXED&&(e=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),e}},{key:"setScale",value:function(t){this.vr=Math.abs(t)}},{key:"interfaces_",get:function(){return[k,_]}}],[{key:"constructor_",value:function(){if(this.zu=null,this.vr=null,0===arguments.length)this.zu=t.FLOATING;else if(1===arguments.length)if(arguments[0]instanceof ie){var e=arguments[0];this.zu=e,e===t.FIXED&&this.setScale(1)}else if("number"==typeof arguments[0]){var n=arguments[0];this.zu=t.FIXED,this.setScale(n)}else if(arguments[0]instanceof t){var i=arguments[0];this.zu=i.zu,this.vr=i.vr}}},{key:"mostPrecise",value:function(t,e){return t.compareTo(e)>=0?t:e}}])}(),ie=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"readResolve",value:function(){return t.nameToTypeMap.get(this.Jo)}},{key:"toString",value:function(){return this.Jo}},{key:"interfaces_",get:function(){return[k]}}],[{key:"constructor_",value:function(){this.Jo=null;var e=arguments[0];this.Jo=e,t.nameToTypeMap.put(e,this)}}])}();ie.nameToTypeMap=new ee,ne.Type=ie,ne.FIXED=new ie("FIXED"),ne.FLOATING=new ie("FLOATING"),ne.FLOATING_SINGLE=new ie("FLOATING SINGLE"),ne.maximumPreciseValue=9007199254740992;var re=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"copyInternal",value:function(){for(var t=new Array(this.Au.length).fill(null),e=0;e<t.length;e++)t[e]=this.Au[e].copy();return new i(t,this.cu)}},{key:"equalsExact",value:function(){if(2===arguments.length&&"number"==typeof arguments[1]&&arguments[0]instanceof H){var t=arguments[0],e=arguments[1];return!!this.isEquivalentClass(t)&&f(i,"equalsExact",this,1).call(this,t,e)}return f(i,"equalsExact",this,1).apply(this,arguments)}},{key:"getBoundaryDimension",value:function(){return this.isClosed()?Et.FALSE:0}},{key:"isClosed",value:function(){if(this.isEmpty())return!1;for(var t=0;t<this.Au.length;t++)if(!this.Au[t].isClosed())return!1;return!0}},{key:"getTypeCode",value:function(){return H.TYPECODE_MULTILINESTRING}},{key:"getDimension",value:function(){return 1}},{key:"getBoundary",value:function(){throw new Y}},{key:"getGeometryType",value:function(){return H.TYPENAME_MULTILINESTRING}},{key:"interfaces_",get:function(){return[$t]}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];Ut.constructor_.call(this,t,e)}}])}(Ut),oe=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"createEmpty",value:function(t){switch(t){case-1:return this.createGeometryCollection();case 0:return this.createPoint();case 1:return this.createLineString();case 2:return this.createPolygon();default:throw new g("Invalid dimension: "+t)}}},{key:"toGeometry",value:function(t){return t.isNull()?this.createPoint():t.getMinX()===t.getMaxX()&&t.getMinY()===t.getMaxY()?this.createPoint(new j(t.getMinX(),t.getMinY())):t.getMinX()===t.getMaxX()||t.getMinY()===t.getMaxY()?this.createLineString([new j(t.getMinX(),t.getMinY()),new j(t.getMaxX(),t.getMaxY())]):this.createPolygon(this.createLinearRing([new j(t.getMinX(),t.getMinY()),new j(t.getMinX(),t.getMaxY()),new j(t.getMaxX(),t.getMaxY()),new j(t.getMaxX(),t.getMinY()),new j(t.getMinX(),t.getMinY())]),null)}},{key:"createLineString",value:function(){if(0===arguments.length)return this.createLineString(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLineString(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(it(arguments[0],ht))return new At(arguments[0],this)}}},{key:"createMultiLineString",value:function(){return 0===arguments.length?new re(null,this):1===arguments.length?new re(arguments[0],this):void 0}},{key:"buildGeometry",value:function(e){for(var n=null,i=!1,r=!1,o=e.iterator();o.hasNext();){var s=o.next(),a=s.getTypeCode();null===n&&(n=a),a!==n&&(i=!0),s instanceof Ut&&(r=!0)}if(null===n)return this.createGeometryCollection();if(i||r)return this.createGeometryCollection(t.toGeometryArray(e));var u=e.iterator().next();if(e.size()>1){if(u instanceof Ft)return this.createMultiPolygon(t.toPolygonArray(e));if(u instanceof At)return this.createMultiLineString(t.toLineStringArray(e));if(u instanceof It)return this.createMultiPoint(t.toPointArray(e));P.shouldNeverReachHere("Unhandled geometry type: "+u.getGeometryType())}return u}},{key:"createMultiPointFromCoords",value:function(t){return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)}},{key:"createPoint",value:function(){if(0===arguments.length)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof j){var t=arguments[0];return this.createPoint(null!==t?this.getCoordinateSequenceFactory().create([t]):null)}if(it(arguments[0],ht))return new It(arguments[0],this)}}},{key:"getCoordinateSequenceFactory",value:function(){return this.Ru}},{key:"createPolygon",value:function(){if(0===arguments.length)return this.createPolygon(null,null);if(1===arguments.length){if(it(arguments[0],ht)){var t=arguments[0];return this.createPolygon(this.createLinearRing(t))}if(arguments[0]instanceof Array){var e=arguments[0];return this.createPolygon(this.createLinearRing(e))}if(arguments[0]instanceof jt){var n=arguments[0];return this.createPolygon(n,null)}}else if(2===arguments.length)return new Ft(arguments[0],arguments[1],this)}},{key:"getSRID",value:function(){return this.pu}},{key:"createGeometryCollection",value:function(){return 0===arguments.length?new Ut(null,this):1===arguments.length?new Ut(arguments[0],this):void 0}},{key:"getPrecisionModel",value:function(){return this.Fu}},{key:"createLinearRing",value:function(){if(0===arguments.length)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLinearRing(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(it(arguments[0],ht))return new jt(arguments[0],this)}}},{key:"createMultiPolygon",value:function(){return 0===arguments.length?new Jt(null,this):1===arguments.length?new Jt(arguments[0],this):void 0}},{key:"createMultiPoint",value:function(){if(0===arguments.length)return new qt(null,this);if(1===arguments.length){if(arguments[0]instanceof Array)return new qt(arguments[0],this);if(it(arguments[0],ht)){var t=arguments[0];if(null===t)return this.createMultiPoint(new Array(0).fill(null));for(var e=new Array(t.size()).fill(null),n=0;n<t.size();n++){var i=this.getCoordinateSequenceFactory().create(1,t.getDimension(),t.getMeasures());St.copy(t,n,i,0,1),e[n]=this.createPoint(i)}return this.createMultiPoint(e)}}}},{key:"interfaces_",get:function(){return[k]}}],[{key:"constructor_",value:function(){if(this.Fu=null,this.Ru=null,this.pu=null,0===arguments.length)t.constructor_.call(this,new ne,0);else if(1===arguments.length){if(it(arguments[0],_t)){var e=arguments[0];t.constructor_.call(this,new ne,0,e)}else if(arguments[0]instanceof ne){var n=arguments[0];t.constructor_.call(this,n,0,t.getDefaultCoordinateSequenceFactory())}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];t.constructor_.call(this,i,r,t.getDefaultCoordinateSequenceFactory())}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.Fu=o,this.Ru=a,this.pu=s}}},{key:"toMultiPolygonArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toGeometryArray",value:function(t){if(null===t)return null;var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"getDefaultCoordinateSequenceFactory",value:function(){return Zt.instance()}},{key:"toMultiLineStringArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toLineStringArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toMultiPointArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toLinearRingArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toPointArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"toPolygonArray",value:function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)}},{key:"createPointFromInternalCoord",value:function(t,e){return e.getPrecisionModel().makePrecise(t),e.getFactory().createPoint(t)}}])}(),se="XY",ae={POINT:"Point",LINE_STRING:"LineString",LINEAR_RING:"LinearRing",POLYGON:"Polygon",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",CIRCLE:"Circle"},ue="EMPTY";for(var he in ae)ae[he].toUpperCase();var le=o((function t(e){n(this,t),this.wkt=e,this.index_=-1}),[{key:"isAlpha_",value:function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"}},{key:"isNumeric_",value:function(t,e){return t>="0"&&t<="9"||"."==t&&!(void 0!==e&&e)}},{key:"isWhiteSpace_",value:function(t){return" "==t||"\t"==t||"\r"==t||"\n"==t}},{key:"nextChar_",value:function(){return this.wkt.charAt(++this.index_)}},{key:"nextToken",value:function(){var t,e=this.nextChar_(),n=this.index_,i=e;if("("==e)t=2;else if(","==e)t=5;else if(")"==e)t=3;else if(this.isNumeric_(e)||"-"==e)t=4,i=this.readNumber_();else if(this.isAlpha_(e))t=1,i=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(""!==e)throw new Error("Unexpected character: "+e);t=6}return{position:n,value:i,type:t}}},{key:"readNumber_",value:function(){var t,e=this.index_,n=!1,i=!1;do{"."==t?n=!0:"e"!=t&&"E"!=t||(i=!0),t=this.nextChar_()}while(this.isNumeric_(t,n)||!i&&("e"==t||"E"==t)||i&&("-"==t||"+"==t));return parseFloat(this.wkt.substring(e,this.index_--))}},{key:"readText_",value:function(){var t,e=this.index_;do{t=this.nextChar_()}while(this.isAlpha_(t));return this.wkt.substring(e,this.index_--).toUpperCase()}}]),ce=o((function t(e,i){n(this,t),this.lexer_=e,this.token_,this.layout_=se,this.factory=i}),[{key:"consume_",value:function(){this.token_=this.lexer_.nextToken()}},{key:"isTokenType",value:function(t){return this.token_.type==t}},{key:"match",value:function(t){var e=this.isTokenType(t);return e&&this.consume_(),e}},{key:"parse",value:function(){return this.consume_(),this.parseGeometry_()}},{key:"parseGeometryLayout_",value:function(){var t=se,e=this.token_;if(this.isTokenType(1)){var n=e.value;"Z"===n?t="XYZ":"M"===n?t="XYM":"ZM"===n&&(t="XYZM"),t!==se&&this.consume_()}return t}},{key:"parseGeometryCollectionText_",value:function(){if(this.match(2)){var t=[];do{t.push(this.parseGeometry_())}while(this.match(5));if(this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parsePointText_",value:function(){if(this.match(2)){var t=this.parsePoint_();if(this.match(3))return t}else if(this.isEmptyGeometry_())return null;throw new Error(this.formatErrorMessage_())}},{key:"parseLineStringText_",value:function(){if(this.match(2)){var t=this.parsePointList_();if(this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parsePolygonText_",value:function(){if(this.match(2)){var t=this.parseLineStringTextList_();if(this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parseMultiPointText_",value:function(){var t;if(this.match(2)){if(t=2==this.token_.type?this.parsePointTextList_():this.parsePointList_(),this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parseMultiLineStringText_",value:function(){if(this.match(2)){var t=this.parseLineStringTextList_();if(this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parseMultiPolygonText_",value:function(){if(this.match(2)){var t=this.parsePolygonTextList_();if(this.match(3))return t}else if(this.isEmptyGeometry_())return[];throw new Error(this.formatErrorMessage_())}},{key:"parsePoint_",value:function(){for(var t=[],e=this.layout_.length,n=0;n<e;++n){var i=this.token_;if(!this.match(4))break;t.push(i.value)}if(t.length==e)return t;throw new Error(this.formatErrorMessage_())}},{key:"parsePointList_",value:function(){for(var t=[this.parsePoint_()];this.match(5);)t.push(this.parsePoint_());return t}},{key:"parsePointTextList_",value:function(){for(var t=[this.parsePointText_()];this.match(5);)t.push(this.parsePointText_());return t}},{key:"parseLineStringTextList_",value:function(){for(var t=[this.parseLineStringText_()];this.match(5);)t.push(this.parseLineStringText_());return t}},{key:"parsePolygonTextList_",value:function(){for(var t=[this.parsePolygonText_()];this.match(5);)t.push(this.parsePolygonText_());return t}},{key:"isEmptyGeometry_",value:function(){var t=this.isTokenType(1)&&this.token_.value==ue;return t&&this.consume_(),t}},{key:"formatErrorMessage_",value:function(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}},{key:"parseGeometry_",value:function(){var t=this.factory,e=function(t){return i(j,d(t))},n=function(n){var i=n.map((function(n){return t.createLinearRing(n.map(e))}));return i.length>1?t.createPolygon(i[0],i.slice(1)):t.createPolygon(i[0])},r=this.token_;if(this.match(1)){var o=r.value;if(this.layout_=this.parseGeometryLayout_(),"GEOMETRYCOLLECTION"==o){var s=this.parseGeometryCollectionText_();return t.createGeometryCollection(s)}switch(o){case"POINT":var a=this.parsePointText_();return a?t.createPoint(i(j,d(a))):t.createPoint();case"LINESTRING":var u=this.parseLineStringText_().map(e);return t.createLineString(u);case"LINEARRING":var h=this.parseLineStringText_().map(e);return t.createLinearRing(h);case"POLYGON":var l=this.parsePolygonText_();return l&&0!==l.length?n(l):t.createPolygon();case"MULTIPOINT":var c=this.parseMultiPointText_();if(!c||0===c.length)return t.createMultiPoint();var f=c.map(e).map((function(e){return t.createPoint(e)}));return t.createMultiPoint(f);case"MULTILINESTRING":var p=this.parseMultiLineStringText_().map((function(n){return t.createLineString(n.map(e))}));return t.createMultiLineString(p);case"MULTIPOLYGON":var v=this.parseMultiPolygonText_();if(!v||0===v.length)return t.createMultiPolygon();var m=v.map(n);return t.createMultiPolygon(m);default:throw new Error("Invalid geometry type: "+o)}}throw new Error(this.formatErrorMessage_())}}]);function fe(t){if(t.isEmpty())return"";var e=t.getCoordinate(),n=[e.x,e.y];return void 0===e.z||Number.isNaN(e.z)||n.push(e.z),void 0===e.m||Number.isNaN(e.m)||n.push(e.m),n.join(" ")}function de(t){for(var e=t.getCoordinates().map((function(t){var e=[t.x,t.y];return void 0===t.z||Number.isNaN(t.z)||e.push(t.z),void 0===t.m||Number.isNaN(t.m)||e.push(t.m),e})),n=[],i=0,r=e.length;i<r;++i)n.push(e[i].join(" "));return n.join(", ")}function pe(t){var e=[];e.push("("+de(t.getExteriorRing())+")");for(var n=0,i=t.getNumInteriorRing();n<i;++n)e.push("("+de(t.getInteriorRingN(n))+")");return e.join(", ")}var ve={Point:fe,LineString:de,LinearRing:de,Polygon:pe,MultiPoint:function(t){for(var e=[],n=0,i=t.getNumGeometries();n<i;++n)e.push("("+fe(t.getGeometryN(n))+")");return e.join(", ")},MultiLineString:function(t){for(var e=[],n=0,i=t.getNumGeometries();n<i;++n)e.push("("+de(t.getGeometryN(n))+")");return e.join(", ")},MultiPolygon:function(t){for(var e=[],n=0,i=t.getNumGeometries();n<i;++n)e.push("("+pe(t.getGeometryN(n))+")");return e.join(", ")},GeometryCollection:function(t){for(var e=[],n=0,i=t.getNumGeometries();n<i;++n)e.push(me(t.getGeometryN(n)));return e.join(", ")}};function me(t){var e=t.getGeometryType(),n=ve[e];e=e.toUpperCase();var i=function(t){var e="";if(t.isEmpty())return e;var n=t.getCoordinate();return void 0===n.z||Number.isNaN(n.z)||(e+="Z"),void 0===n.m||Number.isNaN(n.m)||(e+="M"),e}(t);return i.length>0&&(e+=" "+i),t.isEmpty()?e+" "+ue:e+" ("+n(t)+")"}var ye=o((function t(e){n(this,t),this.geometryFactory=e||new oe,this.precisionModel=this.geometryFactory.getPrecisionModel()}),[{key:"read",value:function(t){var e=new le(t);return new ce(e,this.geometryFactory).parse()}},{key:"write",value:function(t){return me(t)}}]),we=o((function t(e){n(this,t),this.parser=new ye(e)}),[{key:"write",value:function(t){return this.parser.write(t)}}],[{key:"toLineString",value:function(t,e){if(2!==arguments.length)throw new Error("Not implemented");return"LINESTRING ( "+t.x+" "+t.y+", "+e.x+" "+e.y+" )"}}]),ge=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getIndexAlongSegment",value:function(t,e){return this.computeIntLineIndex(),this.Du[t][e]}},{key:"getTopologySummary",value:function(){var t=new Xt;return this.isEndPoint()&&t.append(" endpoint"),this.Pu&&t.append(" proper"),this.isCollinear()&&t.append(" collinear"),t.toString()}},{key:"computeIntersection",value:function(t,e,n,i){this.Nu[0][0]=t,this.Nu[0][1]=e,this.Nu[1][0]=n,this.Nu[1][1]=i,this.Uu=this.computeIntersect(t,e,n,i)}},{key:"getIntersectionNum",value:function(){return this.Uu}},{key:"computeIntLineIndex",value:function(){if(0===arguments.length)null===this.Du&&(this.Du=Array(2).fill().map((function(){return Array(2)})),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(1===arguments.length){var t=arguments[0];this.getEdgeDistance(t,0)>this.getEdgeDistance(t,1)?(this.Du[t][0]=0,this.Du[t][1]=1):(this.Du[t][0]=1,this.Du[t][1]=0)}}},{key:"isProper",value:function(){return this.hasIntersection()&&this.Pu}},{key:"setPrecisionModel",value:function(t){this.Fu=t}},{key:"isInteriorIntersection",value:function(){if(0===arguments.length)return!!this.isInteriorIntersection(0)||!!this.isInteriorIntersection(1);if(1===arguments.length){for(var t=arguments[0],e=0;e<this.Uu;e++)if(!this.qu[e].equals2D(this.Nu[t][0])&&!this.qu[e].equals2D(this.Nu[t][1]))return!0;return!1}}},{key:"getIntersection",value:function(t){return this.qu[t]}},{key:"isEndPoint",value:function(){return this.hasIntersection()&&!this.Pu}},{key:"hasIntersection",value:function(){return this.Uu!==t.NO_INTERSECTION}},{key:"getEdgeDistance",value:function(e,n){return t.computeEdgeDistance(this.qu[n],this.Nu[e][0],this.Nu[e][1])}},{key:"isCollinear",value:function(){return this.Uu===t.COLLINEAR_INTERSECTION}},{key:"toString",value:function(){return we.toLineString(this.Nu[0][0],this.Nu[0][1])+" - "+we.toLineString(this.Nu[1][0],this.Nu[1][1])+this.getTopologySummary()}},{key:"getEndpoint",value:function(t,e){return this.Nu[t][e]}},{key:"isIntersection",value:function(t){for(var e=0;e<this.Uu;e++)if(this.qu[e].equals2D(t))return!0;return!1}},{key:"getIntersectionAlongSegment",value:function(t,e){return this.computeIntLineIndex(),this.qu[this.Du[t][e]]}}],[{key:"constructor_",value:function(){this.Uu=null,this.Nu=Array(2).fill().map((function(){return Array(2)})),this.qu=new Array(2).fill(null),this.Du=null,this.Pu=null,this.ju=null,this.Lu=null,this.Fu=null,this.qu[0]=new j,this.qu[1]=new j,this.ju=this.qu[0],this.Lu=this.qu[1],this.Uu=0}},{key:"computeEdgeDistance",value:function(t,e,n){var i=Math.abs(n.x-e.x),r=Math.abs(n.y-e.y),o=-1;if(t.equals(e))o=0;else if(t.equals(n))o=i>r?i:r;else{var s=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y);0!==(o=i>r?s:a)||t.equals(e)||(o=Math.max(s,a))}return P.isTrue(!(0===o&&!t.equals(e)),"Bad distance calculation"),o}},{key:"nonRobustComputeEdgeDistance",value:function(t,e,n){var i=t.x-e.x,r=t.y-e.y,o=Math.sqrt(i*i+r*r);return P.isTrue(!(0===o&&!t.equals(e)),"Invalid distance calculation"),o}}])}();ge.DONT_INTERSECT=0,ge.DO_INTERSECT=1,ge.COLLINEAR=2,ge.NO_INTERSECTION=0,ge.POINT_INTERSECTION=1,ge.COLLINEAR_INTERSECTION=2;var be=function(t){function i(){return n(this,i),e(this,i)}return h(i,t),o(i,[{key:"isInSegmentEnvelopes",value:function(t){var e=new B(this.Nu[0][0],this.Nu[0][1]),n=new B(this.Nu[1][0],this.Nu[1][1]);return e.contains(t)&&n.contains(t)}},{key:"computeIntersection",value:function(){if(3!==arguments.length)return f(i,"computeIntersection",this,1).apply(this,arguments);var t=arguments[0],e=arguments[1],n=arguments[2];if(this.Pu=!1,B.intersects(e,n,t)&&0===lt.index(e,n,t)&&0===lt.index(n,e,t))return this.Pu=!0,(t.equals(e)||t.equals(n))&&(this.Pu=!1),this.Uu=ge.POINT_INTERSECTION,null;this.Uu=ge.NO_INTERSECTION}},{key:"intersection",value:function(t,e,n,r){var o=this.intersectionSafe(t,e,n,r);return this.isInSegmentEnvelopes(o)||(o=new j(i.nearestEndpoint(t,e,n,r))),null!==this.Fu&&this.Fu.makePrecise(o),o}},{key:"checkDD",value:function(t,e,n,i,r){var o=ut.intersection(t,e,n,i),s=this.isInSegmentEnvelopes(o);wt.out.println("DD in env = "+s+"  --------------------- "+o),r.distance(o)>1e-4&&wt.out.println("Distance = "+r.distance(o))}},{key:"intersectionSafe",value:function(t,e,n,r){var o=yt.intersection(t,e,n,r);return null===o&&(o=i.nearestEndpoint(t,e,n,r)),o}},{key:"computeCollinearIntersection",value:function(t,e,n,i){var r=B.intersects(t,e,n),o=B.intersects(t,e,i),s=B.intersects(n,i,t),a=B.intersects(n,i,e);return r&&o?(this.qu[0]=n,this.qu[1]=i,ge.COLLINEAR_INTERSECTION):s&&a?(this.qu[0]=t,this.qu[1]=e,ge.COLLINEAR_INTERSECTION):r&&s?(this.qu[0]=n,this.qu[1]=t,!n.equals(t)||o||a?ge.COLLINEAR_INTERSECTION:ge.POINT_INTERSECTION):r&&a?(this.qu[0]=n,this.qu[1]=e,!n.equals(e)||o||s?ge.COLLINEAR_INTERSECTION:ge.POINT_INTERSECTION):o&&s?(this.qu[0]=i,this.qu[1]=t,!i.equals(t)||r||a?ge.COLLINEAR_INTERSECTION:ge.POINT_INTERSECTION):o&&a?(this.qu[0]=i,this.qu[1]=e,!i.equals(e)||r||s?ge.COLLINEAR_INTERSECTION:ge.POINT_INTERSECTION):ge.NO_INTERSECTION}},{key:"computeIntersect",value:function(t,e,n,i){if(this.Pu=!1,!B.intersects(t,e,n,i))return ge.NO_INTERSECTION;var r=lt.index(t,e,n),o=lt.index(t,e,i);if(r>0&&o>0||r<0&&o<0)return ge.NO_INTERSECTION;var s=lt.index(n,i,t),a=lt.index(n,i,e);return s>0&&a>0||s<0&&a<0?ge.NO_INTERSECTION:0===r&&0===o&&0===s&&0===a?this.computeCollinearIntersection(t,e,n,i):(0===r||0===o||0===s||0===a?(this.Pu=!1,t.equals2D(n)||t.equals2D(i)?this.qu[0]=t:e.equals2D(n)||e.equals2D(i)?this.qu[0]=e:0===r?this.qu[0]=new j(n):0===o?this.qu[0]=new j(i):0===s?this.qu[0]=new j(t):0===a&&(this.qu[0]=new j(e))):(this.Pu=!0,this.qu[0]=this.intersection(t,e,n,i)),ge.POINT_INTERSECTION)}}],[{key:"nearestEndpoint",value:function(t,e,n,i){var r=t,o=bt.pointToSegment(t,n,i),s=bt.pointToSegment(e,n,i);return s<o&&(o=s,r=e),(s=bt.pointToSegment(n,t,e))<o&&(o=s,r=n),(s=bt.pointToSegment(i,t,e))<o&&(o=s,r=i),r}}])}(ge),_e=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"countSegment",value:function(t,e){if(t.x<this.Bu.x&&e.x<this.Bu.x)return null;if(this.Bu.x===e.x&&this.Bu.y===e.y)return this.Hu=!0,null;if(t.y===this.Bu.y&&e.y===this.Bu.y){var n=t.x,i=e.x;return n>i&&(n=e.x,i=t.x),this.Bu.x>=n&&this.Bu.x<=i&&(this.Hu=!0),null}if(t.y>this.Bu.y&&e.y<=this.Bu.y||e.y>this.Bu.y&&t.y<=this.Bu.y){var r=lt.index(t,e,this.Bu);if(r===lt.COLLINEAR)return this.Hu=!0,null;e.y<t.y&&(r=-r),r===lt.LEFT&&this.Wu++}}},{key:"isPointInPolygon",value:function(){return this.getLocation()!==W.EXTERIOR}},{key:"getLocation",value:function(){return this.Hu?W.BOUNDARY:this.Wu%2==1?W.INTERIOR:W.EXTERIOR}},{key:"isOnSegment",value:function(){return this.Hu}}],[{key:"constructor_",value:function(){this.Bu=null,this.Wu=0,this.Hu=!1;var t=arguments[0];this.Bu=t}},{key:"locatePointInRing",value:function(){if(arguments[0]instanceof j&&it(arguments[1],ht)){for(var e=arguments[1],n=new t(arguments[0]),i=new j,r=new j,o=1;o<e.size();o++)if(e.getCoordinate(o,i),e.getCoordinate(o-1,r),n.countSegment(i,r),n.isOnSegment())return n.getLocation();return n.getLocation()}if(arguments[0]instanceof j&&arguments[1]instanceof Array){for(var s=arguments[1],a=new t(arguments[0]),u=1;u<s.length;u++){var h=s[u],l=s[u-1];if(a.countSegment(h,l),a.isOnSegment())return a.getLocation()}return a.getLocation()}}}])}(),xe=function(){function t(){n(this,t)}return o(t,null,[{key:"isOnLine",value:function(){if(arguments[0]instanceof j&&it(arguments[1],ht)){for(var t=arguments[0],e=arguments[1],n=new be,i=new j,r=new j,o=e.size(),s=1;s<o;s++)if(e.getCoordinate(s-1,i),e.getCoordinate(s,r),n.computeIntersection(t,i,r),n.hasIntersection())return!0;return!1}if(arguments[0]instanceof j&&arguments[1]instanceof Array){for(var a=arguments[0],u=arguments[1],h=new be,l=1;l<u.length;l++){var c=u[l-1],f=u[l];if(h.computeIntersection(a,c,f),h.hasIntersection())return!0}return!1}}},{key:"locateInRing",value:function(t,e){return _e.locatePointInRing(t,e)}},{key:"isInRing",value:function(e,n){return t.locateInRing(e,n)!==W.EXTERIOR}}])}(),ke=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"setAllLocations",value:function(t){for(var e=0;e<this.location.length;e++)this.location[e]=t}},{key:"isNull",value:function(){for(var t=0;t<this.location.length;t++)if(this.location[t]!==W.NONE)return!1;return!0}},{key:"setAllLocationsIfNull",value:function(t){for(var e=0;e<this.location.length;e++)this.location[e]===W.NONE&&(this.location[e]=t)}},{key:"isLine",value:function(){return 1===this.location.length}},{key:"merge",value:function(t){if(t.location.length>this.location.length){var e=new Array(3).fill(null);e[Z.ON]=this.location[Z.ON],e[Z.LEFT]=W.NONE,e[Z.RIGHT]=W.NONE,this.location=e}for(var n=0;n<this.location.length;n++)this.location[n]===W.NONE&&n<t.location.length&&(this.location[n]=t.location[n])}},{key:"getLocations",value:function(){return this.location}},{key:"flip",value:function(){if(this.location.length<=1)return null;var t=this.location[Z.LEFT];this.location[Z.LEFT]=this.location[Z.RIGHT],this.location[Z.RIGHT]=t}},{key:"toString",value:function(){var t=new rt;return this.location.length>1&&t.append(W.toLocationSymbol(this.location[Z.LEFT])),t.append(W.toLocationSymbol(this.location[Z.ON])),this.location.length>1&&t.append(W.toLocationSymbol(this.location[Z.RIGHT])),t.toString()}},{key:"setLocations",value:function(t,e,n){this.location[Z.ON]=t,this.location[Z.LEFT]=e,this.location[Z.RIGHT]=n}},{key:"get",value:function(t){return t<this.location.length?this.location[t]:W.NONE}},{key:"isArea",value:function(){return this.location.length>1}},{key:"isAnyNull",value:function(){for(var t=0;t<this.location.length;t++)if(this.location[t]===W.NONE)return!0;return!1}},{key:"setLocation",value:function(){if(1===arguments.length){var t=arguments[0];this.setLocation(Z.ON,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.location[e]=n}}},{key:"init",value:function(t){this.location=new Array(t).fill(null),this.setAllLocations(W.NONE)}},{key:"isEqualOnSide",value:function(t,e){return this.location[e]===t.location[e]}},{key:"allPositionsEqual",value:function(t){for(var e=0;e<this.location.length;e++)if(this.location[e]!==t)return!1;return!0}}],[{key:"constructor_",value:function(){if(this.location=null,1===arguments.length){if(arguments[0]instanceof Array){var e=arguments[0];this.init(e.length)}else if(Number.isInteger(arguments[0])){var n=arguments[0];this.init(1),this.location[Z.ON]=n}else if(arguments[0]instanceof t){var i=arguments[0];if(this.init(i.location.length),null!==i)for(var r=0;r<this.location.length;r++)this.location[r]=i.location[r]}}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.init(3),this.location[Z.ON]=o,this.location[Z.LEFT]=s,this.location[Z.RIGHT]=a}}}])}(),$e=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getGeometryCount",value:function(){var t=0;return this.elt[0].isNull()||t++,this.elt[1].isNull()||t++,t}},{key:"setAllLocations",value:function(t,e){this.elt[t].setAllLocations(e)}},{key:"isNull",value:function(t){return this.elt[t].isNull()}},{key:"setAllLocationsIfNull",value:function(){if(1===arguments.length){var t=arguments[0];this.setAllLocationsIfNull(0,t),this.setAllLocationsIfNull(1,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.elt[e].setAllLocationsIfNull(n)}}},{key:"isLine",value:function(t){return this.elt[t].isLine()}},{key:"merge",value:function(t){for(var e=0;e<2;e++)null===this.elt[e]&&null!==t.elt[e]?this.elt[e]=new ke(t.elt[e]):this.elt[e].merge(t.elt[e])}},{key:"flip",value:function(){this.elt[0].flip(),this.elt[1].flip()}},{key:"getLocation",value:function(){if(1===arguments.length){var t=arguments[0];return this.elt[t].get(Z.ON)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return this.elt[e].get(n)}}},{key:"toString",value:function(){var t=new rt;return null!==this.elt[0]&&(t.append("A:"),t.append(this.elt[0].toString())),null!==this.elt[1]&&(t.append(" B:"),t.append(this.elt[1].toString())),t.toString()}},{key:"isArea",value:function(){if(0===arguments.length)return this.elt[0].isArea()||this.elt[1].isArea();if(1===arguments.length){var t=arguments[0];return this.elt[t].isArea()}}},{key:"isAnyNull",value:function(t){return this.elt[t].isAnyNull()}},{key:"setLocation",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.elt[t].setLocation(Z.ON,e)}else if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2];this.elt[n].setLocation(i,r)}}},{key:"isEqualOnSide",value:function(t,e){return this.elt[0].isEqualOnSide(t.elt[0],e)&&this.elt[1].isEqualOnSide(t.elt[1],e)}},{key:"allPositionsEqual",value:function(t,e){return this.elt[t].allPositionsEqual(e)}},{key:"toLine",value:function(t){this.elt[t].isArea()&&(this.elt[t]=new ke(this.elt[t].location[0]))}}],[{key:"constructor_",value:function(){if(this.elt=new Array(2).fill(null),1===arguments.length){if(Number.isInteger(arguments[0])){var e=arguments[0];this.elt[0]=new ke(e),this.elt[1]=new ke(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.elt[0]=new ke(n.elt[0]),this.elt[1]=new ke(n.elt[1])}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.elt[0]=new ke(W.NONE),this.elt[1]=new ke(W.NONE),this.elt[i].setLocation(r)}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.elt[0]=new ke(o,s,a),this.elt[1]=new ke(o,s,a)}else if(4===arguments.length){var u=arguments[0],h=arguments[1],l=arguments[2],c=arguments[3];this.elt[0]=new ke(W.NONE,W.NONE,W.NONE),this.elt[1]=new ke(W.NONE,W.NONE,W.NONE),this.elt[u].setLocations(h,l,c)}}},{key:"toLineLabel",value:function(e){for(var n=new t(W.NONE),i=0;i<2;i++)n.setLocation(i,e.getLocation(i));return n}}])}(),Se=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"computeRing",value:function(){if(null!==this.Vu)return null;for(var t=new Array(this.Gu.size()).fill(null),e=0;e<this.Gu.size();e++)t[e]=this.Gu.get(e);this.Vu=this.Yu.createLinearRing(t),this.Ku=lt.isCCW(this.Vu.getCoordinates())}},{key:"isIsolated",value:function(){return 1===this.Xu.getGeometryCount()}},{key:"computePoints",value:function(t){this.Qu=t;var e=t,n=!0;do{if(null===e)throw new ft("Found null DirectedEdge");if(e.getEdgeRing()===this)throw new ft("Directed Edge visited twice during ring-building at "+e.getCoordinate());this.Zu.add(e);var i=e.getLabel();P.isTrue(i.isArea()),this.mergeLabel(i),this.addPoints(e.getEdge(),e.isForward(),n),n=!1,this.setEdgeRing(e,this),e=this.getNext(e)}while(e!==this.Qu)}},{key:"getLinearRing",value:function(){return this.Vu}},{key:"getCoordinate",value:function(t){return this.Gu.get(t)}},{key:"computeMaxNodeDegree",value:function(){this.Ju=0;var t=this.Qu;do{var e=t.getNode().getEdges().getOutgoingDegree(this);e>this.Ju&&(this.Ju=e),t=this.getNext(t)}while(t!==this.Qu);this.Ju*=2}},{key:"addPoints",value:function(t,e,n){var i=t.getCoordinates();if(e){var r=1;n&&(r=0);for(var o=r;o<i.length;o++)this.Gu.add(i[o])}else{var s=i.length-2;n&&(s=i.length-1);for(var a=s;a>=0;a--)this.Gu.add(i[a])}}},{key:"isHole",value:function(){return this.Ku}},{key:"setInResult",value:function(){var t=this.Qu;do{t.getEdge().setInResult(!0),t=t.getNext()}while(t!==this.Qu)}},{key:"containsPoint",value:function(t){var e=this.getLinearRing();if(!e.getEnvelopeInternal().contains(t))return!1;if(!xe.isInRing(t,e.getCoordinates()))return!1;for(var n=this.Cu.iterator();n.hasNext();)if(n.next().containsPoint(t))return!1;return!0}},{key:"addHole",value:function(t){this.Cu.add(t)}},{key:"isShell",value:function(){return null===this.Mu}},{key:"getLabel",value:function(){return this.Xu}},{key:"getEdges",value:function(){return this.Zu}},{key:"getMaxNodeDegree",value:function(){return this.Ju<0&&this.computeMaxNodeDegree(),this.Ju}},{key:"getShell",value:function(){return this.Mu}},{key:"mergeLabel",value:function(){if(1===arguments.length){var t=arguments[0];this.mergeLabel(t,0),this.mergeLabel(t,1)}else if(2===arguments.length){var e=arguments[1],n=arguments[0].getLocation(e,Z.RIGHT);if(n===W.NONE)return null;if(this.Xu.getLocation(e)===W.NONE)return this.Xu.setLocation(e,n),null}}},{key:"setShell",value:function(t){this.Mu=t,null!==t&&t.addHole(this)}},{key:"toPolygon",value:function(t){for(var e=new Array(this.Cu.size()).fill(null),n=0;n<this.Cu.size();n++)e[n]=this.Cu.get(n).getLinearRing();return t.createPolygon(this.getLinearRing(),e)}}],[{key:"constructor_",value:function(){if(this.Qu=null,this.Ju=-1,this.Zu=new pt,this.Gu=new pt,this.Xu=new $e(W.NONE),this.Vu=null,this.Ku=null,this.Mu=null,this.Cu=new pt,this.Yu=null,0===arguments.length);else if(2===arguments.length){var t=arguments[0],e=arguments[1];this.Yu=e,this.computePoints(t),this.computeRing()}}}]),Ee=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"setEdgeRing",value:function(t,e){t.setMinEdgeRing(e)}},{key:"getNext",value:function(t){return t.getNextMin()}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];Se.constructor_.call(this,t,e)}}])}(Se),Me=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"buildMinimalRings",value:function(){var t=new pt,e=this.Qu;do{if(null===e.getMinEdgeRing()){var n=new Ee(e,this.Yu);t.add(n)}e=e.getNext()}while(e!==this.Qu);return t}},{key:"setEdgeRing",value:function(t,e){t.setEdgeRing(e)}},{key:"linkDirectedEdgesForMinimalEdgeRings",value:function(){var t=this.Qu;do{t.getNode().getEdges().linkMinimalDirectedEdges(this),t=t.getNext()}while(t!==this.Qu)}},{key:"getNext",value:function(t){return t.getNext()}}],[{key:"constructor_",value:function(){var t=arguments[0],e=arguments[1];Se.constructor_.call(this,t,e)}}])}(Se),Ce=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"setVisited",value:function(t){this.th=t}},{key:"setInResult",value:function(t){this.eh=t}},{key:"isCovered",value:function(){return this.nh}},{key:"isCoveredSet",value:function(){return this.ih}},{key:"setLabel",value:function(t){this.Xu=t}},{key:"getLabel",value:function(){return this.Xu}},{key:"setCovered",value:function(t){this.nh=t,this.ih=!0}},{key:"updateIM",value:function(t){P.isTrue(this.Xu.getGeometryCount()>=2,"found partial label"),this.computeIM(t)}},{key:"isInResult",value:function(){return this.eh}},{key:"isVisited",value:function(){return this.th}}],[{key:"constructor_",value:function(){if(this.Xu=null,this.eh=!1,this.nh=!1,this.ih=!1,this.th=!1,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.Xu=t}}}]),Ae=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"isIncidentEdgeInResult",value:function(){for(var t=this.getEdges().getEdges().iterator();t.hasNext();)if(t.next().getEdge().isInResult())return!0;return!1}},{key:"isIsolated",value:function(){return 1===this.Xu.getGeometryCount()}},{key:"getCoordinate",value:function(){return this.Si}},{key:"print",value:function(t){t.println("node "+this.Si+" lbl: "+this.Xu)}},{key:"computeIM",value:function(t){}},{key:"computeMergedLocation",value:function(t,e){var n=W.NONE;if(n=this.Xu.getLocation(e),!t.isNull(e)){var i=t.getLocation(e);n!==W.BOUNDARY&&(n=i)}return n}},{key:"setLabel",value:function(){if(2!==arguments.length||!Number.isInteger(arguments[1])||!Number.isInteger(arguments[0]))return f(i,"setLabel",this,1).apply(this,arguments);var t=arguments[0],e=arguments[1];null===this.Xu?this.Xu=new $e(t,e):this.Xu.setLocation(t,e)}},{key:"getEdges",value:function(){return this.Zu}},{key:"mergeLabel",value:function(){if(arguments[0]instanceof i){var t=arguments[0];this.mergeLabel(t.Xu)}else if(arguments[0]instanceof $e)for(var e=arguments[0],n=0;n<2;n++){var r=this.computeMergedLocation(e,n);this.Xu.getLocation(n)===W.NONE&&this.Xu.setLocation(n,r)}}},{key:"add",value:function(t){this.Zu.insert(t),t.setNode(this)}},{key:"setLabelBoundary",value:function(t){if(null===this.Xu)return null;var e=W.NONE;null!==this.Xu&&(e=this.Xu.getLocation(t));var n=null;switch(e){case W.BOUNDARY:n=W.INTERIOR;break;case W.INTERIOR:default:n=W.BOUNDARY}this.Xu.setLocation(t,n)}}],[{key:"constructor_",value:function(){this.Si=null,this.Zu=null;var t=arguments[0],e=arguments[1];this.Si=t,this.Zu=e,this.Xu=new $e(0,W.NONE)}}])}(Ce),Oe=function(t){function i(){return n(this,i),e(this,i,arguments)}return h(i,t),o(i)}(te);function Ie(t){return null==t?0:t.color}function Te(t){return null==t?null:t.parent}function ze(t,e){null!==t&&(t.color=e)}function Re(t){return null==t?null:t.left}function Fe(t){return null==t?null:t.right}var De=function(t){function i(){var t;return n(this,i),(t=e(this,i)).root_=null,t.size_=0,t}return h(i,t),o(i,[{key:"get",value:function(t){for(var e=this.root_;null!==e;){var n=t.compareTo(e.key);if(n<0)e=e.left;else{if(!(n>0))return e.value;e=e.right}}return null}},{key:"put",value:function(t,e){if(null===this.root_)return this.root_={key:t,value:e,left:null,right:null,parent:null,color:0,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var n,i,r=this.root_;do{if(n=r,(i=t.compareTo(r.key))<0)r=r.left;else{if(!(i>0)){var o=r.value;return r.value=e,o}r=r.right}}while(null!==r);var s={key:t,left:null,right:null,value:e,parent:n,color:0,getValue:function(){return this.value},getKey:function(){return this.key}};return i<0?n.left=s:n.right=s,this.fixAfterInsertion(s),this.size_++,null}},{key:"fixAfterInsertion",value:function(t){var e;for(t.color=1;null!=t&&t!==this.root_&&1===t.parent.color;)Te(t)===Re(Te(Te(t)))?1===Ie(e=Fe(Te(Te(t))))?(ze(Te(t),0),ze(e,0),ze(Te(Te(t)),1),t=Te(Te(t))):(t===Fe(Te(t))&&(t=Te(t),this.rotateLeft(t)),ze(Te(t),0),ze(Te(Te(t)),1),this.rotateRight(Te(Te(t)))):1===Ie(e=Re(Te(Te(t))))?(ze(Te(t),0),ze(e,0),ze(Te(Te(t)),1),t=Te(Te(t))):(t===Re(Te(t))&&(t=Te(t),this.rotateRight(t)),ze(Te(t),0),ze(Te(Te(t)),1),this.rotateLeft(Te(Te(t))));this.root_.color=0}},{key:"values",value:function(){var t=new pt,e=this.getFirstEntry();if(null!==e)for(t.add(e.value);null!==(e=i.successor(e));)t.add(e.value);return t}},{key:"entrySet",value:function(){var t=new X,e=this.getFirstEntry();if(null!==e)for(t.add(e);null!==(e=i.successor(e));)t.add(e);return t}},{key:"rotateLeft",value:function(t){if(null!=t){var e=t.right;t.right=e.left,null!=e.left&&(e.left.parent=t),e.parent=t.parent,null==t.parent?this.root_=e:t.parent.left===t?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e}}},{key:"rotateRight",value:function(t){if(null!=t){var e=t.left;t.left=e.right,null!=e.right&&(e.right.parent=t),e.parent=t.parent,null==t.parent?this.root_=e:t.parent.right===t?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e}}},{key:"getFirstEntry",value:function(){var t=this.root_;if(null!=t)for(;null!=t.left;)t=t.left;return t}},{key:"size",value:function(){return this.size_}},{key:"containsKey",value:function(t){for(var e=this.root_;null!==e;){var n=t.compareTo(e.key);if(n<0)e=e.left;else{if(!(n>0))return!0;e=e.right}}return!1}}],[{key:"successor",value:function(t){var e;if(null===t)return null;if(null!==t.right){for(e=t.right;null!==e.left;)e=e.left;return e}e=t.parent;for(var n=t;null!==e&&n===e.right;)n=e,e=e.parent;return e}}])}(Oe),Pe=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"find",value:function(t){return this.nodeMap.get(t)}},{key:"addNode",value:function(){if(arguments[0]instanceof j){var t=arguments[0],e=this.nodeMap.get(t);return null===e&&(e=this.nodeFact.createNode(t),this.nodeMap.put(t,e)),e}if(arguments[0]instanceof Ae){var n=arguments[0],i=this.nodeMap.get(n.getCoordinate());return null===i?(this.nodeMap.put(n.getCoordinate(),n),n):(i.mergeLabel(n),i)}}},{key:"print",value:function(t){for(var e=this.iterator();e.hasNext();)e.next().print(t)}},{key:"iterator",value:function(){return this.nodeMap.values().iterator()}},{key:"values",value:function(){return this.nodeMap.values()}},{key:"getBoundaryNodes",value:function(t){for(var e=new pt,n=this.iterator();n.hasNext();){var i=n.next();i.getLabel().getLocation(t)===W.BOUNDARY&&e.add(i)}return e}},{key:"add",value:function(t){var e=t.getCoordinate();this.addNode(e).add(t)}}],[{key:"constructor_",value:function(){this.nodeMap=new De,this.nodeFact=null;var t=arguments[0];this.nodeFact=t}}]),Ne=function(){function t(){n(this,t)}return o(t,null,[{key:"isNorthern",value:function(e){return e===t.NE||e===t.NW}},{key:"isOpposite",value:function(t,e){return t!==e&&2==(t-e+4)%4}},{key:"commonHalfPlane",value:function(t,e){if(t===e)return t;if(2==(t-e+4)%4)return-1;var n=t<e?t:e;return 0===n&&3===(t>e?t:e)?3:n}},{key:"isInHalfPlane",value:function(e,n){return n===t.SE?e===t.SE||e===t.SW:e===n||e===n+1}},{key:"quadrant",value:function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var e=arguments[0],n=arguments[1];if(0===e&&0===n)throw new g("Cannot compute the quadrant for point ( "+e+", "+n+" )");return e>=0?n>=0?t.NE:t.SE:n>=0?t.NW:t.SW}if(arguments[0]instanceof j&&arguments[1]instanceof j){var i=arguments[0],r=arguments[1];if(r.x===i.x&&r.y===i.y)throw new g("Cannot compute the quadrant for two identical points "+i);return r.x>=i.x?r.y>=i.y?t.NE:t.SE:r.y>=i.y?t.NW:t.SW}}}])}();Ne.NE=0,Ne.NW=1,Ne.SW=2,Ne.SE=3;var Ue=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"compareDirection",value:function(t){return this.rh===t.rh&&this.oh===t.oh?0:this.sh>t.sh?1:this.sh<t.sh?-1:lt.index(t.ah,t.uh,this.uh)}},{key:"getDy",value:function(){return this.oh}},{key:"getCoordinate",value:function(){return this.ah}},{key:"setNode",value:function(t){this.hh=t}},{key:"print",value:function(t){var e=Math.atan2(this.oh,this.rh),n=this.getClass().getName(),i=n.lastIndexOf("."),r=n.substring(i+1);t.print("  "+r+": "+this.ah+" - "+this.uh+" "+this.sh+":"+e+"   "+this.Xu)}},{key:"compareTo",value:function(t){var e=t;return this.compareDirection(e)}},{key:"getDirectedCoordinate",value:function(){return this.uh}},{key:"getDx",value:function(){return this.rh}},{key:"getLabel",value:function(){return this.Xu}},{key:"getEdge",value:function(){return this.fh}},{key:"getQuadrant",value:function(){return this.sh}},{key:"getNode",value:function(){return this.hh}},{key:"toString",value:function(){var t=Math.atan2(this.oh,this.rh),e=this.getClass().getName(),n=e.lastIndexOf(".");return"  "+e.substring(n+1)+": "+this.ah+" - "+this.uh+" "+this.sh+":"+t+"   "+this.Xu}},{key:"computeLabel",value:function(t){}},{key:"init",value:function(t,e){this.ah=t,this.uh=e,this.rh=e.x-t.x,this.oh=e.y-t.y,this.sh=Ne.quadrant(this.rh,this.oh),P.isTrue(!(0===this.rh&&0===this.oh),"EdgeEnd with identical endpoints found")}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){if(this.fh=null,this.Xu=null,this.hh=null,this.ah=null,this.uh=null,this.rh=null,this.oh=null,this.sh=null,1===arguments.length){var e=arguments[0];this.fh=e}else if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2];t.constructor_.call(this,n,i,r,null)}else if(4===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2],u=arguments[3];t.constructor_.call(this,o),this.init(s,a),this.Xu=u}}}])}(),qe=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getNextMin",value:function(){return this.dh}},{key:"getDepth",value:function(t){return this.ph[t]}},{key:"setVisited",value:function(t){this.th=t}},{key:"computeDirectedLabel",value:function(){this.Xu=new $e(this.fh.getLabel()),this.mh||this.Xu.flip()}},{key:"getNext",value:function(){return this.yh}},{key:"setDepth",value:function(t,e){if(-999!==this.ph[t]&&this.ph[t]!==e)throw new ft("assigned depths do not match",this.getCoordinate());this.ph[t]=e}},{key:"isInteriorAreaEdge",value:function(){for(var t=!0,e=0;e<2;e++)this.Xu.isArea(e)&&this.Xu.getLocation(e,Z.LEFT)===W.INTERIOR&&this.Xu.getLocation(e,Z.RIGHT)===W.INTERIOR||(t=!1);return t}},{key:"setNextMin",value:function(t){this.dh=t}},{key:"print",value:function(t){f(i,"print",this,1).call(this,t),t.print(" "+this.ph[Z.LEFT]+"/"+this.ph[Z.RIGHT]),t.print(" ("+this.getDepthDelta()+")"),this.eh&&t.print(" inResult")}},{key:"setMinEdgeRing",value:function(t){this.wh=t}},{key:"isLineEdge",value:function(){var t=this.Xu.isLine(0)||this.Xu.isLine(1),e=!this.Xu.isArea(0)||this.Xu.allPositionsEqual(0,W.EXTERIOR),n=!this.Xu.isArea(1)||this.Xu.allPositionsEqual(1,W.EXTERIOR);return t&&e&&n}},{key:"setEdgeRing",value:function(t){this.gh=t}},{key:"getMinEdgeRing",value:function(){return this.wh}},{key:"getDepthDelta",value:function(){var t=this.fh.getDepthDelta();return this.mh||(t=-t),t}},{key:"setInResult",value:function(t){this.eh=t}},{key:"getSym",value:function(){return this.bh}},{key:"isForward",value:function(){return this.mh}},{key:"getEdge",value:function(){return this.fh}},{key:"printEdge",value:function(t){this.print(t),t.print(" "),this.mh?this.fh.print(t):this.fh.printReverse(t)}},{key:"setSym",value:function(t){this.bh=t}},{key:"setVisitedEdge",value:function(t){this.setVisited(t),this.bh.setVisited(t)}},{key:"setEdgeDepths",value:function(t,e){var n=this.getEdge().getDepthDelta();this.mh||(n=-n);var i=1;t===Z.LEFT&&(i=-1);var r=Z.opposite(t),o=e+n*i;this.setDepth(t,e),this.setDepth(r,o)}},{key:"getEdgeRing",value:function(){return this.gh}},{key:"isInResult",value:function(){return this.eh}},{key:"setNext",value:function(t){this.yh=t}},{key:"isVisited",value:function(){return this.th}}],[{key:"constructor_",value:function(){this.mh=null,this.eh=!1,this.th=!1,this.bh=null,this.yh=null,this.dh=null,this.gh=null,this.wh=null,this.ph=[0,-999,-999];var t=arguments[0],e=arguments[1];if(Ue.constructor_.call(this,t),this.mh=e,e)this.init(t.getCoordinate(0),t.getCoordinate(1));else{var n=t.getNumPoints()-1;this.init(t.getCoordinate(n),t.getCoordinate(n-1))}this.computeDirectedLabel()}},{key:"depthFactor",value:function(t,e){return t===W.EXTERIOR&&e===W.INTERIOR?1:t===W.INTERIOR&&e===W.EXTERIOR?-1:0}}])}(Ue),je=o((function t(){n(this,t)}),[{key:"createNode",value:function(t){return new Ae(t,null)}}]),Le=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"printEdges",value:function(t){t.println("Edges:");for(var e=0;e<this.Zu.size();e++){t.println("edge "+e+":");var n=this.Zu.get(e);n.print(t),n.eiList.print(t)}}},{key:"find",value:function(t){return this.Su.find(t)}},{key:"addNode",value:function(){if(arguments[0]instanceof Ae){var t=arguments[0];return this.Su.addNode(t)}if(arguments[0]instanceof j){var e=arguments[0];return this.Su.addNode(e)}}},{key:"getNodeIterator",value:function(){return this.Su.iterator()}},{key:"linkResultDirectedEdges",value:function(){for(var t=this.Su.iterator();t.hasNext();)t.next().getEdges().linkResultDirectedEdges()}},{key:"debugPrintln",value:function(t){wt.out.println(t)}},{key:"isBoundaryNode",value:function(t,e){var n=this.Su.find(e);if(null===n)return!1;var i=n.getLabel();return null!==i&&i.getLocation(t)===W.BOUNDARY}},{key:"linkAllDirectedEdges",value:function(){for(var t=this.Su.iterator();t.hasNext();)t.next().getEdges().linkAllDirectedEdges()}},{key:"matchInSameDirection",value:function(t,e,n,i){return!!t.equals(n)&&lt.index(t,e,i)===lt.COLLINEAR&&Ne.quadrant(t,e)===Ne.quadrant(n,i)}},{key:"getEdgeEnds",value:function(){return this._h}},{key:"debugPrint",value:function(t){wt.out.print(t)}},{key:"getEdgeIterator",value:function(){return this.Zu.iterator()}},{key:"findEdgeInSameDirection",value:function(t,e){for(var n=0;n<this.Zu.size();n++){var i=this.Zu.get(n),r=i.getCoordinates();if(this.matchInSameDirection(t,e,r[0],r[1]))return i;if(this.matchInSameDirection(t,e,r[r.length-1],r[r.length-2]))return i}return null}},{key:"insertEdge",value:function(t){this.Zu.add(t)}},{key:"findEdgeEnd",value:function(t){for(var e=this.getEdgeEnds().iterator();e.hasNext();){var n=e.next();if(n.getEdge()===t)return n}return null}},{key:"addEdges",value:function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this.Zu.add(n);var i=new qe(n,!0),r=new qe(n,!1);i.setSym(r),r.setSym(i),this.add(i),this.add(r)}}},{key:"add",value:function(t){this.Su.add(t),this._h.add(t)}},{key:"getNodes",value:function(){return this.Su.values()}},{key:"findEdge",value:function(t,e){for(var n=0;n<this.Zu.size();n++){var i=this.Zu.get(n),r=i.getCoordinates();if(t.equals(r[0])&&e.equals(r[1]))return i}return null}}],[{key:"constructor_",value:function(){if(this.Zu=new pt,this.Su=null,this._h=new pt,0===arguments.length)this.Su=new Pe(new je);else if(1===arguments.length){var t=arguments[0];this.Su=new Pe(t)}}},{key:"linkResultDirectedEdges",value:function(t){for(var e=t.iterator();e.hasNext();)e.next().getEdges().linkResultDirectedEdges()}}]),Be=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"sortShellsAndHoles",value:function(t,e,n){for(var i=t.iterator();i.hasNext();){var r=i.next();r.isHole()?n.add(r):e.add(r)}}},{key:"computePolygons",value:function(t){for(var e=new pt,n=t.iterator();n.hasNext();){var i=n.next().toPolygon(this.Yu);e.add(i)}return e}},{key:"placeFreeHoles",value:function(e,n){for(var i=n.iterator();i.hasNext();){var r=i.next();if(null===r.getShell()){var o=t.findEdgeRingContaining(r,e);if(null===o)throw new ft("unable to assign hole to a shell",r.getCoordinate(0));r.setShell(o)}}}},{key:"buildMinimalEdgeRings",value:function(t,e,n){for(var i=new pt,r=t.iterator();r.hasNext();){var o=r.next();if(o.getMaxNodeDegree()>2){o.linkDirectedEdgesForMinimalEdgeRings();var s=o.buildMinimalRings(),a=this.findShell(s);null!==a?(this.placePolygonHoles(a,s),e.add(a)):n.addAll(s)}else i.add(o)}return i}},{key:"buildMaximalEdgeRings",value:function(t){for(var e=new pt,n=t.iterator();n.hasNext();){var i=n.next();if(i.isInResult()&&i.getLabel().isArea()&&null===i.getEdgeRing()){var r=new Me(i,this.Yu);e.add(r),r.setInResult()}}return e}},{key:"placePolygonHoles",value:function(t,e){for(var n=e.iterator();n.hasNext();){var i=n.next();i.isHole()&&i.setShell(t)}}},{key:"getPolygons",value:function(){return this.computePolygons(this.xh)}},{key:"findShell",value:function(t){for(var e=0,n=null,i=t.iterator();i.hasNext();){var r=i.next();r.isHole()||(n=r,e++)}return P.isTrue(e<=1,"found two shells in MinimalEdgeRing list"),n}},{key:"add",value:function(){if(1===arguments.length){var t=arguments[0];this.add(t.getEdgeEnds(),t.getNodes())}else if(2===arguments.length){var e=arguments[0],n=arguments[1];Le.linkResultDirectedEdges(n);var i=this.buildMaximalEdgeRings(e),r=new pt,o=this.buildMinimalEdgeRings(i,this.xh,r);this.sortShellsAndHoles(o,this.xh,r),this.placeFreeHoles(this.xh,r)}}}],[{key:"constructor_",value:function(){this.Yu=null,this.xh=new pt;var t=arguments[0];this.Yu=t}},{key:"findEdgeRingContaining",value:function(t,e){for(var n=t.getLinearRing(),i=n.getEnvelopeInternal(),r=n.getCoordinateN(0),o=null,s=null,a=e.iterator();a.hasNext();){var u=a.next(),h=u.getLinearRing(),l=h.getEnvelopeInternal();if(!l.equals(i)&&l.contains(i)){r=Gt.ptNotInList(n.getCoordinates(),h.getCoordinates());var c=!1;xe.isInRing(r,h.getCoordinates())&&(c=!0),c&&(null===o||s.contains(l))&&(s=(o=u).getLinearRing().getEnvelopeInternal())}}return o}}])}(),He=o((function t(){n(this,t)}),[{key:"getBounds",value:function(){}}]),We=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getItem",value:function(){return this.kh}},{key:"getBounds",value:function(){return this.$h}},{key:"interfaces_",get:function(){return[He,k]}}],[{key:"constructor_",value:function(){this.$h=null,this.kh=null;var t=arguments[0],e=arguments[1];this.$h=t,this.kh=e}}]),Ve=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"poll",value:function(){if(this.isEmpty())return null;var t=this.Sh.get(1);return this.Sh.set(1,this.Sh.get(this.Pi)),this.Pi-=1,this.reorder(1),t}},{key:"size",value:function(){return this.Pi}},{key:"reorder",value:function(t){for(var e=null,n=this.Sh.get(t);2*t<=this.Pi&&((e=2*t)!==this.Pi&&this.Sh.get(e+1).compareTo(this.Sh.get(e))<0&&e++,this.Sh.get(e).compareTo(n)<0);t=e)this.Sh.set(t,this.Sh.get(e));this.Sh.set(t,n)}},{key:"clear",value:function(){this.Pi=0,this.Sh.clear()}},{key:"peek",value:function(){return this.isEmpty()?null:this.Sh.get(1)}},{key:"isEmpty",value:function(){return 0===this.Pi}},{key:"add",value:function(t){this.Sh.add(null),this.Pi+=1;var e=this.Pi;for(this.Sh.set(0,t);t.compareTo(this.Sh.get(Math.trunc(e/2)))<0;e/=2)this.Sh.set(e,this.Sh.get(Math.trunc(e/2)));this.Sh.set(e,t)}}],[{key:"constructor_",value:function(){this.Pi=null,this.Sh=null,this.Pi=0,this.Sh=new pt,this.Sh.add(null)}}]),Ge=o((function t(){n(this,t)}),[{key:"insert",value:function(t,e){}},{key:"remove",value:function(t,e){}},{key:"query",value:function(){}}]),Ye=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getLevel",value:function(){return this.Eh}},{key:"size",value:function(){return this.Mh.size()}},{key:"getChildBoundables",value:function(){return this.Mh}},{key:"addChildBoundable",value:function(t){P.isTrue(null===this.$h),this.Mh.add(t)}},{key:"isEmpty",value:function(){return this.Mh.isEmpty()}},{key:"getBounds",value:function(){return null===this.$h&&(this.$h=this.computeBounds()),this.$h}},{key:"interfaces_",get:function(){return[He,k]}}],[{key:"constructor_",value:function(){if(this.Mh=new pt,this.$h=null,this.Eh=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.Eh=t}}}]),Ke={reverseOrder:function(){return{compare:function(t,e){return e.compareTo(t)}}},min:function(t){return Ke.sort(t),t.get(0)},sort:function(t,e){var n=t.toArray();e?zt.sort(n,e):zt.sort(n);for(var i=t.iterator(),r=0,o=n.length;r<o;r++)i.next(),i.set(n[r])},singletonList:function(t){var e=new pt;return e.add(t),e}},Xe=function(){function t(){n(this,t)}return o(t,null,[{key:"maxDistance",value:function(e,n,i,r,o,s,a,u){var h=t.distance(e,n,o,s);return h=Math.max(h,t.distance(e,n,a,u)),h=Math.max(h,t.distance(i,r,o,s)),Math.max(h,t.distance(i,r,a,u))}},{key:"distance",value:function(t,e,n,i){var r=n-t,o=i-e;return Math.sqrt(r*r+o*o)}},{key:"maximumDistance",value:function(e,n){var i=Math.min(e.getMinX(),n.getMinX()),r=Math.min(e.getMinY(),n.getMinY()),o=Math.max(e.getMaxX(),n.getMaxX()),s=Math.max(e.getMaxY(),n.getMaxY());return t.distance(i,r,o,s)}},{key:"minMaxDistance",value:function(e,n){var i=e.getMinX(),r=e.getMinY(),o=e.getMaxX(),s=e.getMaxY(),a=n.getMinX(),u=n.getMinY(),h=n.getMaxX(),l=n.getMaxY(),c=t.maxDistance(i,r,i,s,a,u,a,l);return c=Math.min(c,t.maxDistance(i,r,i,s,a,u,h,u)),c=Math.min(c,t.maxDistance(i,r,i,s,h,l,a,l)),c=Math.min(c,t.maxDistance(i,r,i,s,h,l,h,u)),c=Math.min(c,t.maxDistance(i,r,o,r,a,u,a,l)),c=Math.min(c,t.maxDistance(i,r,o,r,a,u,h,u)),c=Math.min(c,t.maxDistance(i,r,o,r,h,l,a,l)),c=Math.min(c,t.maxDistance(i,r,o,r,h,l,h,u)),c=Math.min(c,t.maxDistance(o,s,i,s,a,u,a,l)),c=Math.min(c,t.maxDistance(o,s,i,s,a,u,h,u)),c=Math.min(c,t.maxDistance(o,s,i,s,h,l,a,l)),c=Math.min(c,t.maxDistance(o,s,i,s,h,l,h,u)),c=Math.min(c,t.maxDistance(o,s,o,r,a,u,a,l)),c=Math.min(c,t.maxDistance(o,s,o,r,a,u,h,u)),c=Math.min(c,t.maxDistance(o,s,o,r,h,l,a,l)),Math.min(c,t.maxDistance(o,s,o,r,h,l,h,u))}}])}(),Qe=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"maximumDistance",value:function(){return Xe.maximumDistance(this.Ch.getBounds(),this.Ah.getBounds())}},{key:"expandToQueue",value:function(e,n){var i=t.isComposite(this.Ch),r=t.isComposite(this.Ah);if(i&&r)return t.area(this.Ch)>t.area(this.Ah)?(this.expand(this.Ch,this.Ah,!1,e,n),null):(this.expand(this.Ah,this.Ch,!0,e,n),null);if(i)return this.expand(this.Ch,this.Ah,!1,e,n),null;if(r)return this.expand(this.Ah,this.Ch,!0,e,n),null;throw new g("neither boundable is composite")}},{key:"isLeaves",value:function(){return!(t.isComposite(this.Ch)||t.isComposite(this.Ah))}},{key:"compareTo",value:function(t){var e=t;return this.Oh<e.Oh?-1:this.Oh>e.Oh?1:0}},{key:"expand",value:function(e,n,i,r,o){for(var s=e.getChildBoundables().iterator();s.hasNext();){var a=s.next(),u=null;(u=i?new t(n,a,this.Ih):new t(a,n,this.Ih)).getDistance()<o&&r.add(u)}}},{key:"getBoundable",value:function(t){return 0===t?this.Ch:this.Ah}},{key:"getDistance",value:function(){return this.Oh}},{key:"distance",value:function(){return this.isLeaves()?this.Ih.distance(this.Ch,this.Ah):this.Ch.getBounds().distance(this.Ah.getBounds())}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this.Ch=null,this.Ah=null,this.Oh=null,this.Ih=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.Ch=t,this.Ah=e,this.Ih=n,this.Oh=this.distance()}},{key:"area",value:function(t){return t.getBounds().getArea()}},{key:"isComposite",value:function(t){return t instanceof Ye}}])}(),Ze=o((function t(){n(this,t)}),[{key:"visitItem",value:function(t){}}]),Je=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"queryInternal",value:function(){if(it(arguments[2],Ze)&&arguments[0]instanceof Object&&arguments[1]instanceof Ye)for(var t=arguments[0],e=arguments[2],n=arguments[1].getChildBoundables(),i=0;i<n.size();i++){var r=n.get(i);this.getIntersectsOp().intersects(r.getBounds(),t)&&(r instanceof Ye?this.queryInternal(t,r,e):r instanceof We?e.visitItem(r.getItem()):P.shouldNeverReachHere())}else if(it(arguments[2],et)&&arguments[0]instanceof Object&&arguments[1]instanceof Ye)for(var o=arguments[0],s=arguments[2],a=arguments[1].getChildBoundables(),u=0;u<a.size();u++){var h=a.get(u);this.getIntersectsOp().intersects(h.getBounds(),o)&&(h instanceof Ye?this.queryInternal(o,h,s):h instanceof We?s.add(h.getItem()):P.shouldNeverReachHere())}}},{key:"getNodeCapacity",value:function(){return this.Th}},{key:"lastNode",value:function(t){return t.get(t.size()-1)}},{key:"size",value:function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.size(this._root));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();n instanceof Ye?t+=this.size(n):n instanceof We&&(t+=1)}return t}}},{key:"removeItem",value:function(t,e){for(var n=null,i=t.getChildBoundables().iterator();i.hasNext();){var r=i.next();r instanceof We&&r.getItem()===e&&(n=r)}return null!==n&&(t.getChildBoundables().remove(n),!0)}},{key:"itemsTree",value:function(){if(0===arguments.length){this.build();var t=this.itemsTree(this._root);return null===t?new pt:t}if(1===arguments.length){for(var e=arguments[0],n=new pt,i=e.getChildBoundables().iterator();i.hasNext();){var r=i.next();if(r instanceof Ye){var o=this.itemsTree(r);null!==o&&n.add(o)}else r instanceof We?n.add(r.getItem()):P.shouldNeverReachHere()}return n.size()<=0?null:n}}},{key:"insert",value:function(t,e){P.isTrue(!this.zh,"Cannot insert items into an STR packed R-tree after it has been built."),this.Rh.add(new We(t,e))}},{key:"boundablesAtLevel",value:function(){if(1===arguments.length){var t=arguments[0],e=new pt;return this.boundablesAtLevel(t,this._root,e),e}if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2];if(P.isTrue(n>-2),i.getLevel()===n)return r.add(i),null;for(var o=i.getChildBoundables().iterator();o.hasNext();){var s=o.next();s instanceof Ye?this.boundablesAtLevel(n,s,r):(P.isTrue(s instanceof We),-1===n&&r.add(s))}return null}}},{key:"query",value:function(){if(1===arguments.length){var t=arguments[0];this.build();var e=new pt;return this.isEmpty()||this.getIntersectsOp().intersects(this._root.getBounds(),t)&&this.queryInternal(t,this._root,e),e}if(2===arguments.length){var n=arguments[0],i=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this._root.getBounds(),n)&&this.queryInternal(n,this._root,i)}}},{key:"build",value:function(){if(this.zh)return null;this._root=this.Rh.isEmpty()?this.createNode(0):this.createHigherLevels(this.Rh,-1),this.Rh=null,this.zh=!0}},{key:"getRoot",value:function(){return this.build(),this._root}},{key:"remove",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.build(),!!this.getIntersectsOp().intersects(this._root.getBounds(),t)&&this.remove(t,this._root,e)}if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2],o=this.removeItem(i,r);if(o)return!0;for(var s=null,a=i.getChildBoundables().iterator();a.hasNext();){var u=a.next();if(this.getIntersectsOp().intersects(u.getBounds(),n)&&u instanceof Ye&&(o=this.remove(n,u,r))){s=u;break}}return null!==s&&s.getChildBoundables().isEmpty()&&i.getChildBoundables().remove(s),o}}},{key:"createHigherLevels",value:function(t,e){P.isTrue(!t.isEmpty());var n=this.createParentBoundables(t,e+1);return 1===n.size()?n.get(0):this.createHigherLevels(n,e+1)}},{key:"depth",value:function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.depth(this._root));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();if(n instanceof Ye){var i=this.depth(n);i>t&&(t=i)}}return t+1}}},{key:"createParentBoundables",value:function(t,e){P.isTrue(!t.isEmpty());var n=new pt;n.add(this.createNode(e));var i=new pt(t);Ke.sort(i,this.getComparator());for(var r=i.iterator();r.hasNext();){var o=r.next();this.lastNode(n).getChildBoundables().size()===this.getNodeCapacity()&&n.add(this.createNode(e)),this.lastNode(n).addChildBoundable(o)}return n}},{key:"isEmpty",value:function(){return this.zh?this._root.isEmpty():this.Rh.isEmpty()}},{key:"interfaces_",get:function(){return[k]}}],[{key:"constructor_",value:function(){if(this._root=null,this.zh=!1,this.Rh=new pt,this.Th=null,0===arguments.length)t.constructor_.call(this,t.DEFAULT_NODE_CAPACITY);else if(1===arguments.length){var e=arguments[0];P.isTrue(e>1,"Node capacity must be greater than 1"),this.Th=e}}},{key:"compareDoubles",value:function(t,e){return t>e?1:t<e?-1:0}}])}();Je.IntersectsOp=function(){},Je.DEFAULT_NODE_CAPACITY=10;var tn=o((function t(){n(this,t)}),[{key:"distance",value:function(t,e){}}]),en=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"createParentBoundablesFromVerticalSlices",value:function(t,e){P.isTrue(t.length>0);for(var n=new pt,i=0;i<t.length;i++)n.addAll(this.createParentBoundablesFromVerticalSlice(t[i],e));return n}},{key:"nearestNeighbourK",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.nearestNeighbourK(t,z.POSITIVE_INFINITY,e)}if(3===arguments.length){var n=arguments[0],r=arguments[2],o=arguments[1],s=new Ve;s.add(n);for(var a=new Ve;!s.isEmpty()&&o>=0;){var u=s.poll(),h=u.getDistance();if(h>=o)break;u.isLeaves()?a.size()<r?a.add(u):(a.peek().getDistance()>h&&(a.poll(),a.add(u)),o=a.peek().getDistance()):u.expandToQueue(s,o)}return i.getItems(a)}}},{key:"createNode",value:function(t){return new nn(t)}},{key:"size",value:function(){return 0===arguments.length?f(i,"size",this,1).call(this):f(i,"size",this,1).apply(this,arguments)}},{key:"insert",value:function(){if(!(2===arguments.length&&arguments[1]instanceof Object&&arguments[0]instanceof B))return f(i,"insert",this,1).apply(this,arguments);var t=arguments[0],e=arguments[1];if(t.isNull())return null;f(i,"insert",this,1).call(this,t,e)}},{key:"getIntersectsOp",value:function(){return i.intersectsOp}},{key:"verticalSlices",value:function(t,e){for(var n=Math.trunc(Math.ceil(t.size()/e)),i=new Array(e).fill(null),r=t.iterator(),o=0;o<e;o++){i[o]=new pt;for(var s=0;r.hasNext()&&s<n;){var a=r.next();i[o].add(a),s++}}return i}},{key:"query",value:function(){if(1===arguments.length){var t=arguments[0];return f(i,"query",this,1).call(this,t)}if(2===arguments.length){var e=arguments[0],n=arguments[1];f(i,"query",this,1).call(this,e,n)}}},{key:"getComparator",value:function(){return i.yComparator}},{key:"createParentBoundablesFromVerticalSlice",value:function(t,e){return f(i,"createParentBoundables",this,1).call(this,t,e)}},{key:"remove",value:function(){if(2===arguments.length&&arguments[1]instanceof Object&&arguments[0]instanceof B){var t=arguments[0],e=arguments[1];return f(i,"remove",this,1).call(this,t,e)}return f(i,"remove",this,1).apply(this,arguments)}},{key:"depth",value:function(){return 0===arguments.length?f(i,"depth",this,1).call(this):f(i,"depth",this,1).apply(this,arguments)}},{key:"createParentBoundables",value:function(t,e){P.isTrue(!t.isEmpty());var n=Math.trunc(Math.ceil(t.size()/this.getNodeCapacity())),r=new pt(t);Ke.sort(r,i.xComparator);var o=this.verticalSlices(r,Math.trunc(Math.ceil(Math.sqrt(n))));return this.createParentBoundablesFromVerticalSlices(o,e)}},{key:"nearestNeighbour",value:function(){if(1===arguments.length){if(it(arguments[0],tn)){var t=arguments[0];if(this.isEmpty())return null;var e=new Qe(this.getRoot(),this.getRoot(),t);return this.nearestNeighbour(e)}if(arguments[0]instanceof Qe){var n=arguments[0],i=z.POSITIVE_INFINITY,r=null,o=new Ve;for(o.add(n);!o.isEmpty()&&i>0;){var s=o.poll(),a=s.getDistance();if(a>=i)break;s.isLeaves()?(i=a,r=s):s.expandToQueue(o,i)}return null===r?null:[r.getBoundable(0).getItem(),r.getBoundable(1).getItem()]}}else{if(2===arguments.length){var u=arguments[0],h=arguments[1];if(this.isEmpty()||u.isEmpty())return null;var l=new Qe(this.getRoot(),u.getRoot(),h);return this.nearestNeighbour(l)}if(3===arguments.length){var c=arguments[2],f=new We(arguments[0],arguments[1]),d=new Qe(this.getRoot(),f,c);return this.nearestNeighbour(d)[0]}if(4===arguments.length){var p=arguments[2],v=arguments[3],m=new We(arguments[0],arguments[1]),y=new Qe(this.getRoot(),m,p);return this.nearestNeighbourK(y,v)}}}},{key:"isWithinDistance",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=z.POSITIVE_INFINITY,i=new Ve;for(i.add(t);!i.isEmpty();){var r=i.poll(),o=r.getDistance();if(o>e)return!1;if(r.maximumDistance()<=e)return!0;if(r.isLeaves()){if((n=o)<=e)return!0}else r.expandToQueue(i,n)}return!1}if(3===arguments.length){var s=arguments[0],a=arguments[1],u=arguments[2],h=new Qe(this.getRoot(),s.getRoot(),a);return this.isWithinDistance(h,u)}}},{key:"interfaces_",get:function(){return[Ge,k]}}],[{key:"constructor_",value:function(){if(0===arguments.length)i.constructor_.call(this,i.DEFAULT_NODE_CAPACITY);else if(1===arguments.length){var t=arguments[0];Je.constructor_.call(this,t)}}},{key:"centreX",value:function(t){return i.avg(t.getMinX(),t.getMaxX())}},{key:"avg",value:function(t,e){return(t+e)/2}},{key:"getItems",value:function(t){for(var e=new Array(t.size()).fill(null),n=0;!t.isEmpty();){var i=t.poll();e[n]=i.getBoundable(0).getItem(),n++}return e}},{key:"centreY",value:function(t){return i.avg(t.getMinY(),t.getMaxY())}}])}(Je),nn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"computeBounds",value:function(){for(var t=null,e=this.getChildBoundables().iterator();e.hasNext();){var n=e.next();null===t?t=new B(n.getBounds()):t.expandToInclude(n.getBounds())}return t}}],[{key:"constructor_",value:function(){var t=arguments[0];Ye.constructor_.call(this,t)}}])}(Ye);en.STRtreeNode=nn,en.xComparator=new(o((function t(){n(this,t)}),[{key:"interfaces_",get:function(){return[R]}},{key:"compare",value:function(t,e){return Je.compareDoubles(en.centreX(t.getBounds()),en.centreX(e.getBounds()))}}])),en.yComparator=new(o((function t(){n(this,t)}),[{key:"interfaces_",get:function(){return[R]}},{key:"compare",value:function(t,e){return Je.compareDoubles(en.centreY(t.getBounds()),en.centreY(e.getBounds()))}}])),en.intersectsOp=new(o((function t(){n(this,t)}),[{key:"interfaces_",get:function(){return[IntersectsOp]}},{key:"intersects",value:function(t,e){return t.intersects(e)}}])),en.DEFAULT_NODE_CAPACITY=10;var rn=function(){function t(){n(this,t)}return o(t,null,[{key:"relativeSign",value:function(t,e){return t<e?-1:t>e?1:0}},{key:"compare",value:function(e,n,i){if(n.equals2D(i))return 0;var r=t.relativeSign(n.x,i.x),o=t.relativeSign(n.y,i.y);switch(e){case 0:return t.compareValue(r,o);case 1:return t.compareValue(o,r);case 2:return t.compareValue(o,-r);case 3:return t.compareValue(-r,o);case 4:return t.compareValue(-r,-o);case 5:return t.compareValue(-o,-r);case 6:return t.compareValue(-o,r);case 7:return t.compareValue(r,-o)}return P.shouldNeverReachHere("invalid octant value"),0}},{key:"compareValue",value:function(t,e){return t<0?-1:t>0?1:e<0?-1:e>0?1:0}}])}(),on=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getCoordinate",value:function(){return this.coord}},{key:"print",value:function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex)}},{key:"compareTo",value:function(t){var e=t;return this.segmentIndex<e.segmentIndex?-1:this.segmentIndex>e.segmentIndex?1:this.coord.equals2D(e.coord)?0:this.Fh?e.Fh?rn.compare(this.Dh,this.coord,e.coord):1:-1}},{key:"isEndPoint",value:function(t){return 0===this.segmentIndex&&!this.Fh||this.segmentIndex===t}},{key:"toString",value:function(){return this.segmentIndex+":"+this.coord.toString()}},{key:"isInterior",value:function(){return this.Fh}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this.Ph=null,this.coord=null,this.segmentIndex=null,this.Dh=null,this.Fh=null;var t=arguments[0],e=arguments[1],n=arguments[2],i=arguments[3];this.Ph=t,this.coord=new j(e),this.segmentIndex=n,this.Dh=i,this.Fh=!e.equals2D(t.getCoordinate(n))}}]),sn=o((function t(){n(this,t)}),[{key:"hasNext",value:function(){}},{key:"next",value:function(){}},{key:"remove",value:function(){}}]),an=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getSplitCoordinates",value:function(){var t=new Vt;this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next();this.addEdgeCoordinates(n,i,t),n=i}return t.toCoordinateArray()}},{key:"addCollapsedNodes",value:function(){var t=new pt;this.findCollapsesFromInsertedNodes(t),this.findCollapsesFromExistingVertices(t);for(var e=t.iterator();e.hasNext();){var n=e.next().intValue();this.add(this.fh.getCoordinate(n),n)}}},{key:"createSplitEdgePts",value:function(t,e){var n=e.segmentIndex-t.segmentIndex+2;if(2===n)return[new j(t.coord),new j(e.coord)];var i=this.fh.getCoordinate(e.segmentIndex),r=e.isInterior()||!e.coord.equals2D(i);r||n--;var o=new Array(n).fill(null),s=0;o[s++]=new j(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)o[s++]=this.fh.getCoordinate(a);return r&&(o[s]=new j(e.coord)),o}},{key:"print",value:function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)}},{key:"findCollapsesFromExistingVertices",value:function(t){for(var e=0;e<this.fh.size()-2;e++){var n=this.fh.getCoordinate(e);this.fh.getCoordinate(e+1);var i=this.fh.getCoordinate(e+2);n.equals2D(i)&&t.add(ot.valueOf(e+1))}}},{key:"addEdgeCoordinates",value:function(t,e,n){var i=this.createSplitEdgePts(t,e);n.add(i,!1)}},{key:"iterator",value:function(){return this.Nh.values().iterator()}},{key:"addSplitEdges",value:function(t){this.addEndpoints(),this.addCollapsedNodes();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next(),r=this.createSplitEdge(n,i);t.add(r),n=i}}},{key:"findCollapseIndex",value:function(t,e,n){if(!t.coord.equals2D(e.coord))return!1;var i=e.segmentIndex-t.segmentIndex;return e.isInterior()||i--,1===i&&(n[0]=t.segmentIndex+1,!0)}},{key:"findCollapsesFromInsertedNodes",value:function(t){for(var e=new Array(1).fill(null),n=this.iterator(),i=n.next();n.hasNext();){var r=n.next();this.findCollapseIndex(i,r,e)&&t.add(ot.valueOf(e[0])),i=r}}},{key:"getEdge",value:function(){return this.fh}},{key:"addEndpoints",value:function(){var t=this.fh.size()-1;this.add(this.fh.getCoordinate(0),0),this.add(this.fh.getCoordinate(t),t)}},{key:"createSplitEdge",value:function(t,e){var n=this.createSplitEdgePts(t,e);return new cn(n,this.fh.getData())}},{key:"add",value:function(t,e){var n=new on(this.fh,t,e,this.fh.getSegmentOctant(e)),i=this.Nh.get(n);return null!==i?(P.isTrue(i.coord.equals2D(t),"Found equal nodes with different coordinates"),i):(this.Nh.put(n,n),n)}},{key:"checkSplitEdgesCorrectness",value:function(t){var e=this.fh.getCoordinates(),n=t.get(0).getCoordinate(0);if(!n.equals2D(e[0]))throw new F("bad split edge start point at "+n);var i=t.get(t.size()-1).getCoordinates(),r=i[i.length-1];if(!r.equals2D(e[e.length-1]))throw new F("bad split edge end point at "+r)}}],[{key:"constructor_",value:function(){this.Nh=new De,this.fh=null;var t=arguments[0];this.fh=t}}]),un=function(){function t(){n(this,t)}return o(t,null,[{key:"octant",value:function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var e=arguments[0],n=arguments[1];if(0===e&&0===n)throw new g("Cannot compute the octant for point ( "+e+", "+n+" )");var i=Math.abs(e),r=Math.abs(n);return e>=0?n>=0?i>=r?0:1:i>=r?7:6:n>=0?i>=r?3:2:i>=r?4:5}if(arguments[0]instanceof j&&arguments[1]instanceof j){var o=arguments[0],s=arguments[1],a=s.x-o.x,u=s.y-o.y;if(0===a&&0===u)throw new g("Cannot compute the octant for two identical points "+o);return t.octant(a,u)}}}])}(),hn=o((function t(){n(this,t)}),[{key:"getCoordinates",value:function(){}},{key:"size",value:function(){}},{key:"getCoordinate",value:function(t){}},{key:"isClosed",value:function(){}},{key:"setData",value:function(t){}},{key:"getData",value:function(){}}]),ln=o((function t(){n(this,t)}),[{key:"addIntersection",value:function(t,e){}},{key:"interfaces_",get:function(){return[hn]}}]),cn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getCoordinates",value:function(){return this.Gu}},{key:"size",value:function(){return this.Gu.length}},{key:"getCoordinate",value:function(t){return this.Gu[t]}},{key:"isClosed",value:function(){return this.Gu[0].equals(this.Gu[this.Gu.length-1])}},{key:"getSegmentOctant",value:function(t){return t===this.Gu.length-1?-1:this.safeOctant(this.getCoordinate(t),this.getCoordinate(t+1))}},{key:"setData",value:function(t){this.We=t}},{key:"safeOctant",value:function(t,e){return t.equals2D(e)?0:un.octant(t,e)}},{key:"getData",value:function(){return this.We}},{key:"addIntersection",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.addIntersectionNode(t,e)}else if(4===arguments.length){var n=arguments[1],i=arguments[3],r=new j(arguments[0].getIntersection(i));this.addIntersection(r,n)}}},{key:"toString",value:function(){return we.toLineString(new Qt(this.Gu))}},{key:"getNodeList",value:function(){return this.Uh}},{key:"addIntersectionNode",value:function(t,e){var n=e,i=n+1;if(i<this.Gu.length){var r=this.Gu[i];t.equals2D(r)&&(n=i)}return this.Uh.add(t,n)}},{key:"addIntersections",value:function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++)this.addIntersection(t,e,n,i)}},{key:"interfaces_",get:function(){return[ln]}}],[{key:"constructor_",value:function(){this.Uh=new an(this),this.Gu=null,this.We=null;var t=arguments[0],e=arguments[1];this.Gu=t,this.We=e}},{key:"getNodedSubstrings",value:function(){if(1===arguments.length){var e=arguments[0],n=new pt;return t.getNodedSubstrings(e,n),n}if(2===arguments.length)for(var i=arguments[1],r=arguments[0].iterator();r.hasNext();)r.next().getNodeList().addSplitEdges(i)}}])}(),fn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"minX",value:function(){return Math.min(this.p0.x,this.p1.x)}},{key:"orientationIndex",value:function(){if(arguments[0]instanceof t){var e=arguments[0],n=lt.index(this.p0,this.p1,e.p0),i=lt.index(this.p0,this.p1,e.p1);return n>=0&&i>=0||n<=0&&i<=0?Math.max(n,i):0}if(arguments[0]instanceof j){var r=arguments[0];return lt.index(this.p0,this.p1,r)}}},{key:"toGeometry",value:function(t){return t.createLineString([this.p0,this.p1])}},{key:"isVertical",value:function(){return this.p0.x===this.p1.x}},{key:"equals",value:function(e){if(!(e instanceof t))return!1;var n=e;return this.p0.equals(n.p0)&&this.p1.equals(n.p1)}},{key:"intersection",value:function(t){var e=new be;return e.computeIntersection(this.p0,this.p1,t.p0,t.p1),e.hasIntersection()?e.getIntersection(0):null}},{key:"project",value:function(){if(arguments[0]instanceof j){var e=arguments[0];if(e.equals(this.p0)||e.equals(this.p1))return new j(e);var n=this.projectionFactor(e),i=new j;return i.x=this.p0.x+n*(this.p1.x-this.p0.x),i.y=this.p0.y+n*(this.p1.y-this.p0.y),i}if(arguments[0]instanceof t){var r=arguments[0],o=this.projectionFactor(r.p0),s=this.projectionFactor(r.p1);if(o>=1&&s>=1)return null;if(o<=0&&s<=0)return null;var a=this.project(r.p0);o<0&&(a=this.p0),o>1&&(a=this.p1);var u=this.project(r.p1);return s<0&&(u=this.p0),s>1&&(u=this.p1),new t(a,u)}}},{key:"normalize",value:function(){this.p1.compareTo(this.p0)<0&&this.reverse()}},{key:"angle",value:function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)}},{key:"getCoordinate",value:function(t){return 0===t?this.p0:this.p1}},{key:"distancePerpendicular",value:function(t){return bt.pointToLinePerpendicular(t,this.p0,this.p1)}},{key:"minY",value:function(){return Math.min(this.p0.y,this.p1.y)}},{key:"midPoint",value:function(){return t.midPoint(this.p0,this.p1)}},{key:"projectionFactor",value:function(t){if(t.equals(this.p0))return 0;if(t.equals(this.p1))return 1;var e=this.p1.x-this.p0.x,n=this.p1.y-this.p0.y,i=e*e+n*n;return i<=0?z.NaN:((t.x-this.p0.x)*e+(t.y-this.p0.y)*n)/i}},{key:"closestPoints",value:function(t){var e=this.intersection(t);if(null!==e)return[e,e];var n=new Array(2).fill(null),i=z.MAX_VALUE,r=null,o=this.closestPoint(t.p0);i=o.distance(t.p0),n[0]=o,n[1]=t.p0;var s=this.closestPoint(t.p1);(r=s.distance(t.p1))<i&&(i=r,n[0]=s,n[1]=t.p1);var a=t.closestPoint(this.p0);(r=a.distance(this.p0))<i&&(i=r,n[0]=this.p0,n[1]=a);var u=t.closestPoint(this.p1);return(r=u.distance(this.p1))<i&&(i=r,n[0]=this.p1,n[1]=u),n}},{key:"closestPoint",value:function(t){var e=this.projectionFactor(t);return e>0&&e<1?this.project(t):this.p0.distance(t)<this.p1.distance(t)?this.p0:this.p1}},{key:"maxX",value:function(){return Math.max(this.p0.x,this.p1.x)}},{key:"getLength",value:function(){return this.p0.distance(this.p1)}},{key:"compareTo",value:function(t){var e=t,n=this.p0.compareTo(e.p0);return 0!==n?n:this.p1.compareTo(e.p1)}},{key:"reverse",value:function(){var t=this.p0;this.p0=this.p1,this.p1=t}},{key:"equalsTopo",value:function(t){return this.p0.equals(t.p0)&&this.p1.equals(t.p1)||this.p0.equals(t.p1)&&this.p1.equals(t.p0)}},{key:"lineIntersection",value:function(t){return yt.intersection(this.p0,this.p1,t.p0,t.p1)}},{key:"maxY",value:function(){return Math.max(this.p0.y,this.p1.y)}},{key:"pointAlongOffset",value:function(t,e){var n=this.p0.x+t*(this.p1.x-this.p0.x),i=this.p0.y+t*(this.p1.y-this.p0.y),r=this.p1.x-this.p0.x,o=this.p1.y-this.p0.y,s=Math.sqrt(r*r+o*o),a=0,u=0;if(0!==e){if(s<=0)throw new IllegalStateException("Cannot compute offset from zero-length line segment");a=e*r/s,u=e*o/s}return new j(n-u,i+a)}},{key:"setCoordinates",value:function(){if(1===arguments.length){var t=arguments[0];this.setCoordinates(t.p0,t.p1)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.p0.x=e.x,this.p0.y=e.y,this.p1.x=n.x,this.p1.y=n.y}}},{key:"segmentFraction",value:function(t){var e=this.projectionFactor(t);return e<0?e=0:(e>1||z.isNaN(e))&&(e=1),e}},{key:"toString",value:function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"}},{key:"isHorizontal",value:function(){return this.p0.y===this.p1.y}},{key:"reflect",value:function(t){var e=this.p1.getY()-this.p0.getY(),n=this.p0.getX()-this.p1.getX(),i=this.p0.getY()*(this.p1.getX()-this.p0.getX())-this.p0.getX()*(this.p1.getY()-this.p0.getY()),r=e*e+n*n,o=e*e-n*n,s=t.getX(),a=t.getY();return new j((-o*s-2*e*n*a-2*e*i)/r,(o*a-2*e*n*s-2*n*i)/r)}},{key:"distance",value:function(){if(arguments[0]instanceof t){var e=arguments[0];return bt.segmentToSegment(this.p0,this.p1,e.p0,e.p1)}if(arguments[0]instanceof j){var n=arguments[0];return bt.pointToSegment(n,this.p0,this.p1)}}},{key:"pointAlong",value:function(t){var e=new j;return e.x=this.p0.x+t*(this.p1.x-this.p0.x),e.y=this.p0.y+t*(this.p1.y-this.p0.y),e}},{key:"hashCode",value:function(){var t=z.doubleToLongBits(this.p0.x);t^=31*z.doubleToLongBits(this.p0.y);var e=Math.trunc(t)^Math.trunc(t>>32),n=z.doubleToLongBits(this.p1.x);return n^=31*z.doubleToLongBits(this.p1.y),e^Math.trunc(n)^Math.trunc(n>>32)}},{key:"interfaces_",get:function(){return[_,k]}}],[{key:"constructor_",value:function(){if(this.p0=null,this.p1=null,0===arguments.length)t.constructor_.call(this,new j,new j);else if(1===arguments.length){var e=arguments[0];t.constructor_.call(this,e.p0,e.p1)}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.p0=n,this.p1=i}else if(4===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];t.constructor_.call(this,new j(r,o),new j(s,a))}}},{key:"midPoint",value:function(t,e){return new j((t.x+e.x)/2,(t.y+e.y)/2)}}])}(),dn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"overlap",value:function(){if(2===arguments.length);else if(4===arguments.length){var t=arguments[1],e=arguments[2],n=arguments[3];arguments[0].getLineSegment(t,this.qh),e.getLineSegment(n,this.jh),this.overlap(this.qh,this.jh)}}}],[{key:"constructor_",value:function(){this.qh=new fn,this.jh=new fn}}]),pn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getLineSegment",value:function(t,e){e.p0=this.Gu[t],e.p1=this.Gu[t+1]}},{key:"computeSelect",value:function(t,e,n,i){var r=this.Gu[e],o=this.Gu[n];if(n-e==1)return i.select(this,e),null;if(!t.intersects(r,o))return null;var s=Math.trunc((e+n)/2);e<s&&this.computeSelect(t,e,s,i),s<n&&this.computeSelect(t,s,n,i)}},{key:"getCoordinates",value:function(){for(var t=new Array(this.Lh-this.Bh+1).fill(null),e=0,n=this.Bh;n<=this.Lh;n++)t[e++]=this.Gu[n];return t}},{key:"computeOverlaps",value:function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.computeOverlaps(this.Bh,this.Lh,t,t.Bh,t.Lh,e)}else if(6===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2],o=arguments[3],s=arguments[4],a=arguments[5];if(i-n==1&&s-o==1)return a.overlap(this,n,r,o),null;if(!this.overlaps(n,i,r,o,s))return null;var u=Math.trunc((n+i)/2),h=Math.trunc((o+s)/2);n<u&&(o<h&&this.computeOverlaps(n,u,r,o,h,a),h<s&&this.computeOverlaps(n,u,r,h,s,a)),u<i&&(o<h&&this.computeOverlaps(u,i,r,o,h,a),h<s&&this.computeOverlaps(u,i,r,h,s,a))}}},{key:"setId",value:function(t){this._id=t}},{key:"select",value:function(t,e){this.computeSelect(t,this.Bh,this.Lh,e)}},{key:"getEnvelope",value:function(){if(null===this.$u){var t=this.Gu[this.Bh],e=this.Gu[this.Lh];this.$u=new B(t,e)}return this.$u}},{key:"overlaps",value:function(t,e,n,i,r){return B.intersects(this.Gu[t],this.Gu[e],n.Gu[i],n.Gu[r])}},{key:"getEndIndex",value:function(){return this.Lh}},{key:"getStartIndex",value:function(){return this.Bh}},{key:"getContext",value:function(){return this.ce}},{key:"getId",value:function(){return this._id}}],[{key:"constructor_",value:function(){this.Gu=null,this.Bh=null,this.Lh=null,this.$u=null,this.ce=null,this._id=null;var t=arguments[0],e=arguments[1],n=arguments[2],i=arguments[3];this.Gu=t,this.Bh=e,this.Lh=n,this.ce=i}}]),vn=function(){function t(){n(this,t)}return o(t,null,[{key:"findChainEnd",value:function(t,e){for(var n=e;n<t.length-1&&t[n].equals2D(t[n+1]);)n++;if(n>=t.length-1)return t.length-1;for(var i=Ne.quadrant(t[n],t[n+1]),r=e+1;r<t.length&&(t[r-1].equals2D(t[r])||Ne.quadrant(t[r-1],t[r])===i);)r++;return r-1}},{key:"getChains",value:function(){if(1===arguments.length){var e=arguments[0];return t.getChains(e,null)}if(2===arguments.length){var n=arguments[0],i=arguments[1],r=new pt,o=0;do{var s=t.findChainEnd(n,o),a=new pn(n,o,s,i);r.add(a),o=s}while(o<n.length-1);return r}}}])}(),mn=o((function t(){n(this,t)}),[{key:"computeNodes",value:function(t){}},{key:"getNodedSubstrings",value:function(){}}]),yn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"setSegmentIntersector",value:function(t){this.Hh=t}},{key:"interfaces_",get:function(){return[mn]}}],[{key:"constructor_",value:function(){if(this.Hh=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.setSegmentIntersector(t)}}}]),wn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getMonotoneChains",value:function(){return this.Wh}},{key:"getNodedSubstrings",value:function(){return cn.getNodedSubstrings(this.Vh)}},{key:"getIndex",value:function(){return this._index}},{key:"add",value:function(t){for(var e=vn.getChains(t.getCoordinates(),t).iterator();e.hasNext();){var n=e.next();n.setId(this.Gh++),this._index.insert(n.getEnvelope(),n),this.Wh.add(n)}}},{key:"computeNodes",value:function(t){this.Vh=t;for(var e=t.iterator();e.hasNext();)this.add(e.next());this.intersectChains()}},{key:"intersectChains",value:function(){for(var t=new gn(this.Hh),e=this.Wh.iterator();e.hasNext();)for(var n=e.next(),i=this._index.query(n.getEnvelope()).iterator();i.hasNext();){var r=i.next();if(r.getId()>n.getId()&&(n.computeOverlaps(r,t),this.Yh++),this.Hh.isDone())return null}}}],[{key:"constructor_",value:function(){if(this.Wh=new pt,this._index=new en,this.Gh=0,this.Vh=null,this.Yh=0,0===arguments.length);else if(1===arguments.length){var t=arguments[0];yn.constructor_.call(this,t)}}}])}(yn),gn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"overlap",value:function(){if(4!==arguments.length)return f(i,"overlap",this,1).apply(this,arguments);var t=arguments[1],e=arguments[2],n=arguments[3],r=arguments[0].getContext(),o=e.getContext();this.Kh.processIntersections(r,t,o,n)}}],[{key:"constructor_",value:function(){this.Kh=null;var t=arguments[0];this.Kh=t}}])}(dn);wn.SegmentOverlapAction=gn;var bn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"isDeletable",value:function(t,e,n,i){var r=this.Xh[t],o=this.Xh[e],s=this.Xh[n];return!!this.isConcave(r,o,s)&&!!this.isShallow(r,o,s,i)&&this.isShallowSampled(r,o,t,n,i)}},{key:"deleteShallowConcavities",value:function(){for(var e=1,n=this.findNextNonDeletedIndex(e),i=this.findNextNonDeletedIndex(n),r=!1;i<this.Xh.length;){var o=!1;this.isDeletable(e,n,i,this.Qh)&&(this.Tr[n]=t.DELETE,o=!0,r=!0),e=o?i:n,n=this.findNextNonDeletedIndex(e),i=this.findNextNonDeletedIndex(n)}return r}},{key:"isShallowConcavity",value:function(t,e,n,i){return lt.index(t,e,n)===this.Zh&&bt.pointToSegment(e,t,n)<i}},{key:"isShallowSampled",value:function(e,n,i,r,o){var s=Math.trunc((r-i)/t.NUM_PTS_TO_CHECK);s<=0&&(s=1);for(var a=i;a<r;a+=s)if(!this.isShallow(e,n,this.Xh[a],o))return!1;return!0}},{key:"isConcave",value:function(t,e,n){return lt.index(t,e,n)===this.Zh}},{key:"simplify",value:function(t){this.Qh=Math.abs(t),t<0&&(this.Zh=lt.CLOCKWISE),this.Tr=new Array(this.Xh.length).fill(null);var e=!1;do{e=this.deleteShallowConcavities()}while(e);return this.collapseLine()}},{key:"findNextNonDeletedIndex",value:function(e){for(var n=e+1;n<this.Xh.length&&this.Tr[n]===t.DELETE;)n++;return n}},{key:"isShallow",value:function(t,e,n,i){return bt.pointToSegment(e,t,n)<i}},{key:"collapseLine",value:function(){for(var e=new Vt,n=0;n<this.Xh.length;n++)this.Tr[n]!==t.DELETE&&e.add(this.Xh[n]);return e.toCoordinateArray()}}],[{key:"constructor_",value:function(){this.Xh=null,this.Qh=null,this.Tr=null,this.Zh=lt.COUNTERCLOCKWISE;var t=arguments[0];this.Xh=t}},{key:"simplify",value:function(e,n){return new t(e).simplify(n)}}])}();bn.INIT=0,bn.DELETE=1,bn.KEEP=1,bn.NUM_PTS_TO_CHECK=10;var _n=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getCoordinates",value:function(){return this.Jh.toArray(t.COORDINATE_ARRAY_TYPE)}},{key:"setPrecisionModel",value:function(t){this.Fu=t}},{key:"addPt",value:function(t){var e=new j(t);if(this.Fu.makePrecise(e),this.isRedundant(e))return null;this.Jh.add(e)}},{key:"reverse",value:function(){}},{key:"addPts",value:function(t,e){if(e)for(var n=0;n<t.length;n++)this.addPt(t[n]);else for(var i=t.length-1;i>=0;i--)this.addPt(t[i])}},{key:"isRedundant",value:function(t){if(this.Jh.size()<1)return!1;var e=this.Jh.get(this.Jh.size()-1);return t.distance(e)<this.el}},{key:"toString",value:function(){return(new oe).createLineString(this.getCoordinates()).toString()}},{key:"closeRing",value:function(){if(this.Jh.size()<1)return null;var t=new j(this.Jh.get(0)),e=this.Jh.get(this.Jh.size()-1);if(t.equals(e))return null;this.Jh.add(t)}},{key:"setMinimumVertexDistance",value:function(t){this.el=t}}],[{key:"constructor_",value:function(){this.Jh=null,this.Fu=null,this.el=0,this.Jh=new pt}}])}();_n.COORDINATE_ARRAY_TYPE=new Array(0).fill(null);var xn=function(){function t(){n(this,t)}return o(t,null,[{key:"toDegrees",value:function(t){return 180*t/Math.PI}},{key:"normalize",value:function(e){for(;e>Math.PI;)e-=t.PI_TIMES_2;for(;e<=-Math.PI;)e+=t.PI_TIMES_2;return e}},{key:"angle",value:function(){if(1===arguments.length){var t=arguments[0];return Math.atan2(t.y,t.x)}if(2===arguments.length){var e=arguments[0],n=arguments[1],i=n.x-e.x,r=n.y-e.y;return Math.atan2(r,i)}}},{key:"isAcute",value:function(t,e,n){var i=t.x-e.x,r=t.y-e.y;return i*(n.x-e.x)+r*(n.y-e.y)>0}},{key:"isObtuse",value:function(t,e,n){var i=t.x-e.x,r=t.y-e.y;return i*(n.x-e.x)+r*(n.y-e.y)<0}},{key:"interiorAngle",value:function(e,n,i){var r=t.angle(n,e),o=t.angle(n,i);return Math.abs(o-r)}},{key:"normalizePositive",value:function(e){if(e<0){for(;e<0;)e+=t.PI_TIMES_2;e>=t.PI_TIMES_2&&(e=0)}else{for(;e>=t.PI_TIMES_2;)e-=t.PI_TIMES_2;e<0&&(e=0)}return e}},{key:"angleBetween",value:function(e,n,i){var r=t.angle(n,e),o=t.angle(n,i);return t.diff(r,o)}},{key:"diff",value:function(t,e){var n=null;return(n=t<e?e-t:t-e)>Math.PI&&(n=2*Math.PI-n),n}},{key:"toRadians",value:function(t){return t*Math.PI/180}},{key:"getTurn",value:function(e,n){var i=Math.sin(n-e);return i>0?t.COUNTERCLOCKWISE:i<0?t.CLOCKWISE:t.NONE}},{key:"angleBetweenOriented",value:function(e,n,i){var r=t.angle(n,e),o=t.angle(n,i)-r;return o<=-Math.PI?o+t.PI_TIMES_2:o>Math.PI?o-t.PI_TIMES_2:o}}])}();xn.PI_TIMES_2=2*Math.PI,xn.PI_OVER_2=Math.PI/2,xn.PI_OVER_4=Math.PI/4,xn.COUNTERCLOCKWISE=lt.COUNTERCLOCKWISE,xn.CLOCKWISE=lt.CLOCKWISE,xn.NONE=lt.COLLINEAR;var kn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"addNextSegment",value:function(t,e){if(this.nl=this.il,this.il=this.rl,this.rl=t,this.ol.setCoordinates(this.nl,this.il),this.computeOffsetSegment(this.ol,this.sl,this.Oh,this.al),this.ul.setCoordinates(this.il,this.rl),this.computeOffsetSegment(this.ul,this.sl,this.Oh,this.hl),this.il.equals(this.rl))return null;var n=lt.index(this.nl,this.il,this.rl),i=n===lt.CLOCKWISE&&this.sl===Z.LEFT||n===lt.COUNTERCLOCKWISE&&this.sl===Z.RIGHT;0===n?this.addCollinear(e):i?this.addOutsideTurn(n,e):this.addInsideTurn(n,e)}},{key:"addLineEndCap",value:function(t,e){var n=new fn(t,e),i=new fn;this.computeOffsetSegment(n,Z.LEFT,this.Oh,i);var r=new fn;this.computeOffsetSegment(n,Z.RIGHT,this.Oh,r);var o=e.x-t.x,s=e.y-t.y,a=Math.atan2(s,o);switch(this.ll.getEndCapStyle()){case y.CAP_ROUND:this.cl.addPt(i.p1),this.addDirectedFillet(e,a+Math.PI/2,a-Math.PI/2,lt.CLOCKWISE,this.Oh),this.cl.addPt(r.p1);break;case y.CAP_FLAT:this.cl.addPt(i.p1),this.cl.addPt(r.p1);break;case y.CAP_SQUARE:var u=new j;u.x=Math.abs(this.Oh)*Math.cos(a),u.y=Math.abs(this.Oh)*Math.sin(a);var h=new j(i.p1.x+u.x,i.p1.y+u.y),l=new j(r.p1.x+u.x,r.p1.y+u.y);this.cl.addPt(h),this.cl.addPt(l)}}},{key:"getCoordinates",value:function(){return this.cl.getCoordinates()}},{key:"addMitreJoin",value:function(t,e,n,i){var r=yt.intersection(e.p0,e.p1,n.p0,n.p1);if(null!==r&&(i<=0?1:r.distance(t)/Math.abs(i))<=this.ll.getMitreLimit())return this.cl.addPt(r),null;this.addLimitedMitreJoin(e,n,i,this.ll.getMitreLimit())}},{key:"addOutsideTurn",value:function(e,n){if(this.al.p1.distance(this.hl.p0)<this.Oh*t.OFFSET_SEGMENT_SEPARATION_FACTOR)return this.cl.addPt(this.al.p1),null;this.ll.getJoinStyle()===y.JOIN_MITRE?this.addMitreJoin(this.il,this.al,this.hl,this.Oh):this.ll.getJoinStyle()===y.JOIN_BEVEL?this.addBevelJoin(this.al,this.hl):(n&&this.cl.addPt(this.al.p1),this.addCornerFillet(this.il,this.al.p1,this.hl.p0,e,this.Oh),this.cl.addPt(this.hl.p0))}},{key:"createSquare",value:function(t){this.cl.addPt(new j(t.x+this.Oh,t.y+this.Oh)),this.cl.addPt(new j(t.x+this.Oh,t.y-this.Oh)),this.cl.addPt(new j(t.x-this.Oh,t.y-this.Oh)),this.cl.addPt(new j(t.x-this.Oh,t.y+this.Oh)),this.cl.closeRing()}},{key:"addSegments",value:function(t,e){this.cl.addPts(t,e)}},{key:"addFirstSegment",value:function(){this.cl.addPt(this.hl.p0)}},{key:"addCornerFillet",value:function(t,e,n,i,r){var o=e.x-t.x,s=e.y-t.y,a=Math.atan2(s,o),u=n.x-t.x,h=n.y-t.y,l=Math.atan2(h,u);i===lt.CLOCKWISE?a<=l&&(a+=2*Math.PI):a>=l&&(a-=2*Math.PI),this.cl.addPt(e),this.addDirectedFillet(t,a,l,i,r),this.cl.addPt(n)}},{key:"addLastSegment",value:function(){this.cl.addPt(this.hl.p1)}},{key:"initSideSegments",value:function(t,e,n){this.il=t,this.rl=e,this.sl=n,this.ul.setCoordinates(t,e),this.computeOffsetSegment(this.ul,n,this.Oh,this.hl)}},{key:"addLimitedMitreJoin",value:function(t,e,n,i){var r=this.ol.p1,o=xn.angle(r,this.ol.p0),s=xn.angleBetweenOriented(this.ol.p0,r,this.ul.p1)/2,a=xn.normalize(o+s),u=xn.normalize(a+Math.PI),h=i*n,l=n-h*Math.abs(Math.sin(s)),c=r.x+h*Math.cos(u),f=r.y+h*Math.sin(u),d=new j(c,f),p=new fn(r,d),v=p.pointAlongOffset(1,l),m=p.pointAlongOffset(1,-l);this.sl===Z.LEFT?(this.cl.addPt(v),this.cl.addPt(m)):(this.cl.addPt(m),this.cl.addPt(v))}},{key:"addDirectedFillet",value:function(t,e,n,i,r){var o=i===lt.CLOCKWISE?-1:1,s=Math.abs(e-n),a=Math.trunc(s/this.fl+.5);if(a<1)return null;for(var u=s/a,h=new j,l=0;l<a;l++){var c=e+o*l*u;h.x=t.x+r*Math.cos(c),h.y=t.y+r*Math.sin(c),this.cl.addPt(h)}}},{key:"computeOffsetSegment",value:function(t,e,n,i){var r=e===Z.LEFT?1:-1,o=t.p1.x-t.p0.x,s=t.p1.y-t.p0.y,a=Math.sqrt(o*o+s*s),u=r*n*o/a,h=r*n*s/a;i.p0.x=t.p0.x-h,i.p0.y=t.p0.y+u,i.p1.x=t.p1.x-h,i.p1.y=t.p1.y+u}},{key:"addInsideTurn",value:function(e,n){if(this.dl.computeIntersection(this.al.p0,this.al.p1,this.hl.p0,this.hl.p1),this.dl.hasIntersection())this.cl.addPt(this.dl.getIntersection(0));else if(this.pl=!0,this.al.p1.distance(this.hl.p0)<this.Oh*t.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this.cl.addPt(this.al.p1);else{if(this.cl.addPt(this.al.p1),this.vl>0){var i=new j((this.vl*this.al.p1.x+this.il.x)/(this.vl+1),(this.vl*this.al.p1.y+this.il.y)/(this.vl+1));this.cl.addPt(i);var r=new j((this.vl*this.hl.p0.x+this.il.x)/(this.vl+1),(this.vl*this.hl.p0.y+this.il.y)/(this.vl+1));this.cl.addPt(r)}else this.cl.addPt(this.il);this.cl.addPt(this.hl.p0)}}},{key:"createCircle",value:function(t){var e=new j(t.x+this.Oh,t.y);this.cl.addPt(e),this.addDirectedFillet(t,0,2*Math.PI,-1,this.Oh),this.cl.closeRing()}},{key:"addBevelJoin",value:function(t,e){this.cl.addPt(t.p1),this.cl.addPt(e.p0)}},{key:"init",value:function(e){this.Oh=e,this.ml=e*(1-Math.cos(this.fl/2)),this.cl=new _n,this.cl.setPrecisionModel(this.Fu),this.cl.setMinimumVertexDistance(e*t.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)}},{key:"addCollinear",value:function(t){this.dl.computeIntersection(this.nl,this.il,this.il,this.rl),this.dl.getIntersectionNum()>=2&&(this.ll.getJoinStyle()===y.JOIN_BEVEL||this.ll.getJoinStyle()===y.JOIN_MITRE?(t&&this.cl.addPt(this.al.p1),this.cl.addPt(this.hl.p0)):this.addCornerFillet(this.il,this.al.p1,this.hl.p0,lt.CLOCKWISE,this.Oh))}},{key:"closeRing",value:function(){this.cl.closeRing()}},{key:"hasNarrowConcaveAngle",value:function(){return this.pl}}],[{key:"constructor_",value:function(){this.ml=0,this.fl=null,this.vl=1,this.cl=null,this.Oh=0,this.Fu=null,this.ll=null,this.dl=null,this.nl=null,this.il=null,this.rl=null,this.ol=new fn,this.ul=new fn,this.al=new fn,this.hl=new fn,this.sl=0,this.pl=!1;var e=arguments[0],n=arguments[1],i=arguments[2];this.Fu=e,this.ll=n,this.dl=new be,this.fl=Math.PI/2/n.getQuadrantSegments(),n.getQuadrantSegments()>=8&&n.getJoinStyle()===y.JOIN_ROUND&&(this.vl=t.MAX_CLOSING_SEG_LEN_FACTOR),this.init(i)}}])}();kn.OFFSET_SEGMENT_SEPARATION_FACTOR=.001,kn.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR=.001,kn.CURVE_VERTEX_SNAP_DISTANCE_FACTOR=1e-6,kn.MAX_CLOSING_SEG_LEN_FACTOR=80;var $n=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getOffsetCurve",value:function(t,e){if(this.Oh=e,0===e)return null;var n=e<0,i=Math.abs(e),r=this.getSegGen(i);t.length<=1?this.computePointCurve(t[0],r):this.computeOffsetCurve(t,n,r);var o=r.getCoordinates();return n&&Gt.reverse(o),o}},{key:"computeSingleSidedBufferCurve",value:function(t,e,n){var i=this.simplifyTolerance(this.Oh);if(e){n.addSegments(t,!0);var r=bn.simplify(t,-i),o=r.length-1;n.initSideSegments(r[o],r[o-1],Z.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(r[s],!0)}else{n.addSegments(t,!1);var a=bn.simplify(t,i),u=a.length-1;n.initSideSegments(a[0],a[1],Z.LEFT),n.addFirstSegment();for(var h=2;h<=u;h++)n.addNextSegment(a[h],!0)}n.addLastSegment(),n.closeRing()}},{key:"computeRingBufferCurve",value:function(t,e,n){var i=this.simplifyTolerance(this.Oh);e===Z.RIGHT&&(i=-i);var r=bn.simplify(t,i),o=r.length-1;n.initSideSegments(r[o-1],r[0],e);for(var s=1;s<=o;s++){var a=1!==s;n.addNextSegment(r[s],a)}n.closeRing()}},{key:"computeLineBufferCurve",value:function(t,e){var n=this.simplifyTolerance(this.Oh),i=bn.simplify(t,n),r=i.length-1;e.initSideSegments(i[0],i[1],Z.LEFT);for(var o=2;o<=r;o++)e.addNextSegment(i[o],!0);e.addLastSegment(),e.addLineEndCap(i[r-1],i[r]);var s=bn.simplify(t,-n),a=s.length-1;e.initSideSegments(s[a],s[a-1],Z.LEFT);for(var u=a-2;u>=0;u--)e.addNextSegment(s[u],!0);e.addLastSegment(),e.addLineEndCap(s[1],s[0]),e.closeRing()}},{key:"computePointCurve",value:function(t,e){switch(this.ll.getEndCapStyle()){case y.CAP_ROUND:e.createCircle(t);break;case y.CAP_SQUARE:e.createSquare(t)}}},{key:"getLineCurve",value:function(t,e){if(this.Oh=e,this.isLineOffsetEmpty(e))return null;var n=Math.abs(e),i=this.getSegGen(n);if(t.length<=1)this.computePointCurve(t[0],i);else if(this.ll.isSingleSided()){var r=e<0;this.computeSingleSidedBufferCurve(t,r,i)}else this.computeLineBufferCurve(t,i);return i.getCoordinates()}},{key:"getBufferParameters",value:function(){return this.ll}},{key:"simplifyTolerance",value:function(t){return t*this.ll.getSimplifyFactor()}},{key:"getRingCurve",value:function(e,n,i){if(this.Oh=i,e.length<=2)return this.getLineCurve(e,i);if(0===i)return t.copyCoordinates(e);var r=this.getSegGen(i);return this.computeRingBufferCurve(e,n,r),r.getCoordinates()}},{key:"computeOffsetCurve",value:function(t,e,n){var i=this.simplifyTolerance(this.Oh);if(e){var r=bn.simplify(t,-i),o=r.length-1;n.initSideSegments(r[o],r[o-1],Z.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(r[s],!0)}else{var a=bn.simplify(t,i),u=a.length-1;n.initSideSegments(a[0],a[1],Z.LEFT),n.addFirstSegment();for(var h=2;h<=u;h++)n.addNextSegment(a[h],!0)}n.addLastSegment()}},{key:"isLineOffsetEmpty",value:function(t){return 0===t||t<0&&!this.ll.isSingleSided()}},{key:"getSegGen",value:function(t){return new kn(this.Fu,this.ll,t)}}],[{key:"constructor_",value:function(){this.Oh=0,this.Fu=null,this.ll=null;var t=arguments[0],e=arguments[1];this.Fu=t,this.ll=e}},{key:"copyCoordinates",value:function(t){for(var e=new Array(t.length).fill(null),n=0;n<e.length;n++)e[n]=new j(t[n]);return e}}])}(),Sn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"findStabbedSegments",value:function(){if(1===arguments.length){for(var t=arguments[0],e=new pt,n=this.yl.iterator();n.hasNext();){var i=n.next(),r=i.getEnvelope();t.y<r.getMinY()||t.y>r.getMaxY()||this.findStabbedSegments(t,i.getDirectedEdges(),e)}return e}if(3===arguments.length)if(it(arguments[2],et)&&arguments[0]instanceof j&&arguments[1]instanceof qe){for(var o=arguments[0],s=arguments[1],a=arguments[2],u=s.getEdge().getCoordinates(),h=0;h<u.length-1;h++)if(this.wl.p0=u[h],this.wl.p1=u[h+1],this.wl.p0.y>this.wl.p1.y&&this.wl.reverse(),!(Math.max(this.wl.p0.x,this.wl.p1.x)<o.x||this.wl.isHorizontal()||o.y<this.wl.p0.y||o.y>this.wl.p1.y||lt.index(this.wl.p0,this.wl.p1,o)===lt.RIGHT)){var l=s.getDepth(Z.LEFT);this.wl.p0.equals(u[h])||(l=s.getDepth(Z.RIGHT));var c=new En(this.wl,l);a.add(c)}}else if(it(arguments[2],et)&&arguments[0]instanceof j&&it(arguments[1],et))for(var f=arguments[0],d=arguments[2],p=arguments[1].iterator();p.hasNext();){var v=p.next();v.isForward()&&this.findStabbedSegments(f,v,d)}}},{key:"getDepth",value:function(t){var e=this.findStabbedSegments(t);return 0===e.size()?0:Ke.min(e).gl}}],[{key:"constructor_",value:function(){this.yl=null,this.wl=new fn;var t=arguments[0];this.yl=t}}]),En=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"compareTo",value:function(t){var e=t;if(this._l.minX()>=e._l.maxX())return 1;if(this._l.maxX()<=e._l.minX())return-1;var n=this._l.orientationIndex(e._l);return 0!==n||0!=(n=-1*e._l.orientationIndex(this._l))?n:this._l.compareTo(e._l)}},{key:"compareX",value:function(t,e){var n=t.p0.compareTo(e.p0);return 0!==n?n:t.p1.compareTo(e.p1)}},{key:"toString",value:function(){return this._l.toString()}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this._l=null,this.gl=null;var t=arguments[0],e=arguments[1];this._l=new fn(t),this.gl=e}}]);Sn.DepthSegment=En;var Mn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,null,[{key:"constructor_",value:function(){w.constructor_.call(this,"Projective point not representable on the Cartesian plane.")}}])}(w),Cn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getY",value:function(){var t=this.y/this.w;if(z.isNaN(t)||z.isInfinite(t))throw new Mn;return t}},{key:"getX",value:function(){var t=this.x/this.w;if(z.isNaN(t)||z.isInfinite(t))throw new Mn;return t}},{key:"getCoordinate",value:function(){var t=new j;return t.x=this.getX(),t.y=this.getY(),t}}],[{key:"constructor_",value:function(){if(this.x=null,this.y=null,this.w=null,0===arguments.length)this.x=0,this.y=0,this.w=1;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.w=1}else if(2===arguments.length){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var n=arguments[0],i=arguments[1];this.x=n,this.y=i,this.w=1}else if(arguments[0]instanceof t&&arguments[1]instanceof t){var r=arguments[0],o=arguments[1];this.x=r.y*o.w-o.y*r.w,this.y=o.x*r.w-r.x*o.w,this.w=r.x*o.y-o.x*r.y}else if(arguments[0]instanceof j&&arguments[1]instanceof j){var s=arguments[0],a=arguments[1];this.x=s.y-a.y,this.y=a.x-s.x,this.w=s.x*a.y-a.x*s.y}}else if(3===arguments.length){var u=arguments[0],h=arguments[1],l=arguments[2];this.x=u,this.y=h,this.w=l}else if(4===arguments.length){var c=arguments[0],f=arguments[1],d=arguments[2],p=arguments[3],v=c.y-f.y,m=f.x-c.x,y=c.x*f.y-f.x*c.y,w=d.y-p.y,g=p.x-d.x,b=d.x*p.y-p.x*d.y;this.x=m*b-g*y,this.y=w*y-v*b,this.w=v*g-w*m}}}])}(),An=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"area",value:function(){return t.area(this.p0,this.p1,this.p2)}},{key:"signedArea",value:function(){return t.signedArea(this.p0,this.p1,this.p2)}},{key:"interpolateZ",value:function(e){if(null===e)throw new g("Supplied point is null.");return t.interpolateZ(e,this.p0,this.p1,this.p2)}},{key:"longestSideLength",value:function(){return t.longestSideLength(this.p0,this.p1,this.p2)}},{key:"isAcute",value:function(){return t.isAcute(this.p0,this.p1,this.p2)}},{key:"circumcentre",value:function(){return t.circumcentre(this.p0,this.p1,this.p2)}},{key:"area3D",value:function(){return t.area3D(this.p0,this.p1,this.p2)}},{key:"centroid",value:function(){return t.centroid(this.p0,this.p1,this.p2)}},{key:"inCentre",value:function(){return t.inCentre(this.p0,this.p1,this.p2)}}],[{key:"constructor_",value:function(){this.p0=null,this.p1=null,this.p2=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.p0=t,this.p1=e,this.p2=n}},{key:"area",value:function(t,e,n){return Math.abs(((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2)}},{key:"signedArea",value:function(t,e,n){return((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2}},{key:"det",value:function(t,e,n,i){return t*i-e*n}},{key:"interpolateZ",value:function(t,e,n,i){var r=e.x,o=e.y,s=n.x-r,a=i.x-r,u=n.y-o,h=i.y-o,l=s*h-a*u,c=t.x-r,f=t.y-o,d=(h*c-a*f)/l,p=(-u*c+s*f)/l;return e.getZ()+d*(n.getZ()-e.getZ())+p*(i.getZ()-e.getZ())}},{key:"longestSideLength",value:function(t,e,n){var i=t.distance(e),r=e.distance(n),o=n.distance(t),s=i;return r>s&&(s=r),o>s&&(s=o),s}},{key:"circumcentreDD",value:function(t,e,n){var i=at.valueOf(t.x).subtract(n.x),r=at.valueOf(t.y).subtract(n.y),o=at.valueOf(e.x).subtract(n.x),s=at.valueOf(e.y).subtract(n.y),a=at.determinant(i,r,o,s).multiply(2),u=i.sqr().add(r.sqr()),h=o.sqr().add(s.sqr()),l=at.determinant(r,u,s,h),c=at.determinant(i,u,o,h),f=at.valueOf(n.x).subtract(l.divide(a)).doubleValue(),d=at.valueOf(n.y).add(c.divide(a)).doubleValue();return new j(f,d)}},{key:"isAcute",value:function(t,e,n){return!!xn.isAcute(t,e,n)&&!!xn.isAcute(e,n,t)&&!!xn.isAcute(n,t,e)}},{key:"circumcentre",value:function(e,n,i){var r=i.x,o=i.y,s=e.x-r,a=e.y-o,u=n.x-r,h=n.y-o,l=2*t.det(s,a,u,h),c=t.det(a,s*s+a*a,h,u*u+h*h),f=t.det(s,s*s+a*a,u,u*u+h*h);return new j(r-c/l,o+f/l)}},{key:"perpendicularBisector",value:function(t,e){var n=e.x-t.x,i=e.y-t.y,r=new Cn(t.x+n/2,t.y+i/2,1),o=new Cn(t.x-i+n/2,t.y+n+i/2,1);return new Cn(r,o)}},{key:"angleBisector",value:function(t,e,n){var i=e.distance(t),r=i/(i+e.distance(n)),o=n.x-t.x,s=n.y-t.y;return new j(t.x+r*o,t.y+r*s)}},{key:"area3D",value:function(t,e,n){var i=e.x-t.x,r=e.y-t.y,o=e.getZ()-t.getZ(),s=n.x-t.x,a=n.y-t.y,u=n.getZ()-t.getZ(),h=r*u-o*a,l=o*s-i*u,c=i*a-r*s,f=h*h+l*l+c*c;return Math.sqrt(f)/2}},{key:"centroid",value:function(t,e,n){var i=(t.x+e.x+n.x)/3,r=(t.y+e.y+n.y)/3;return new j(i,r)}},{key:"inCentre",value:function(t,e,n){var i=e.distance(n),r=t.distance(n),o=t.distance(e),s=i+r+o,a=(i*t.x+r*e.x+o*n.x)/s,u=(i*t.y+r*e.y+o*n.y)/s;return new j(a,u)}}])}(),On=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"addRingSide",value:function(t,e,n,i,r){if(0===e&&t.length<jt.MINIMUM_VALID_SIZE)return null;var o=i,s=r;t.length>=jt.MINIMUM_VALID_SIZE&&lt.isCCW(t)&&(o=r,s=i,n=Z.opposite(n));var a=this.xl.getRingCurve(t,n,e);this.addCurve(a,o,s)}},{key:"addRingBothSides",value:function(t,e){this.addRingSide(t,e,Z.LEFT,W.EXTERIOR,W.INTERIOR),this.addRingSide(t,e,Z.RIGHT,W.INTERIOR,W.EXTERIOR)}},{key:"addPoint",value:function(t){if(this.Oh<=0)return null;var e=t.getCoordinates(),n=this.xl.getLineCurve(e,this.Oh);this.addCurve(n,W.EXTERIOR,W.INTERIOR)}},{key:"addPolygon",value:function(t){var e=this.Oh,n=Z.LEFT;this.Oh<0&&(e=-this.Oh,n=Z.RIGHT);var i=t.getExteriorRing(),r=Gt.removeRepeatedPoints(i.getCoordinates());if(this.Oh<0&&this.isErodedCompletely(i,this.Oh))return null;if(this.Oh<=0&&r.length<3)return null;this.addRingSide(r,e,n,W.EXTERIOR,W.INTERIOR);for(var o=0;o<t.getNumInteriorRing();o++){var s=t.getInteriorRingN(o),a=Gt.removeRepeatedPoints(s.getCoordinates());this.Oh>0&&this.isErodedCompletely(s,-this.Oh)||this.addRingSide(a,e,Z.opposite(n),W.INTERIOR,W.EXTERIOR)}}},{key:"isTriangleErodedCompletely",value:function(t,e){var n=new An(t[0],t[1],t[2]),i=n.inCentre();return bt.pointToSegment(i,n.p0,n.p1)<Math.abs(e)}},{key:"addLineString",value:function(t){if(this.xl.isLineOffsetEmpty(this.Oh))return null;var e=Gt.removeRepeatedPoints(t.getCoordinates());if(Gt.isRing(e)&&!this.xl.getBufferParameters().isSingleSided())this.addRingBothSides(e,this.Oh);else{var n=this.xl.getLineCurve(e,this.Oh);this.addCurve(n,W.EXTERIOR,W.INTERIOR)}}},{key:"addCurve",value:function(t,e,n){if(null===t||t.length<2)return null;var i=new cn(t,new $e(0,W.BOUNDARY,e,n));this.kl.add(i)}},{key:"getCurves",value:function(){return this.add(this.$l),this.kl}},{key:"add",value:function(t){if(t.isEmpty())return null;if(t instanceof Ft)this.addPolygon(t);else if(t instanceof At)this.addLineString(t);else if(t instanceof It)this.addPoint(t);else if(t instanceof qt)this.addCollection(t);else if(t instanceof re)this.addCollection(t);else if(t instanceof Jt)this.addCollection(t);else{if(!(t instanceof Ut))throw new Y(t.getGeometryType());this.addCollection(t)}}},{key:"isErodedCompletely",value:function(t,e){var n=t.getCoordinates();if(n.length<4)return e<0;if(4===n.length)return this.isTriangleErodedCompletely(n,e);var i=t.getEnvelopeInternal(),r=Math.min(i.getHeight(),i.getWidth());return e<0&&2*Math.abs(e)>r}},{key:"addCollection",value:function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}}}],[{key:"constructor_",value:function(){this.$l=null,this.Oh=null,this.xl=null,this.kl=new pt;var t=arguments[0],e=arguments[1],n=arguments[2];this.$l=t,this.Oh=e,this.xl=n}}]),In=o((function t(){n(this,t)}),[{key:"locate",value:function(t){}}]),Tn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"next",value:function(){if(this.Sl)return this.Sl=!1,t.isAtomic(this.El)&&this._index++,this.El;if(null!==this.Ml){if(this.Ml.hasNext())return this.Ml.next();this.Ml=null}if(this._index>=this.Cl)throw new G;var e=this.El.getGeometryN(this._index++);return e instanceof Ut?(this.Ml=new t(e),this.Ml.next()):e}},{key:"remove",value:function(){throw new Y(this.getClass().getName())}},{key:"hasNext",value:function(){if(this.Sl)return!0;if(null!==this.Ml){if(this.Ml.hasNext())return!0;this.Ml=null}return!(this._index>=this.Cl)}},{key:"interfaces_",get:function(){return[sn]}}],[{key:"constructor_",value:function(){this.El=null,this.Sl=null,this.Cl=null,this._index=null,this.Ml=null;var t=arguments[0];this.El=t,this.Sl=!0,this._index=0,this.Cl=t.getNumGeometries()}},{key:"isAtomic",value:function(t){return!(t instanceof Ut)}}])}(),zn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"locate",value:function(e){return t.locate(e,this.Al)}},{key:"interfaces_",get:function(){return[In]}}],[{key:"constructor_",value:function(){this.Al=null;var t=arguments[0];this.Al=t}},{key:"locatePointInPolygon",value:function(e,n){if(n.isEmpty())return W.EXTERIOR;var i=n.getExteriorRing(),r=t.locatePointInRing(e,i);if(r!==W.INTERIOR)return r;for(var o=0;o<n.getNumInteriorRing();o++){var s=n.getInteriorRingN(o),a=t.locatePointInRing(e,s);if(a===W.BOUNDARY)return W.BOUNDARY;if(a===W.INTERIOR)return W.EXTERIOR}return W.INTERIOR}},{key:"locatePointInRing",value:function(t,e){return e.getEnvelopeInternal().intersects(t)?xe.locateInRing(t,e.getCoordinates()):W.EXTERIOR}},{key:"containsPointInPolygon",value:function(e,n){return W.EXTERIOR!==t.locatePointInPolygon(e,n)}},{key:"locateInGeometry",value:function(e,n){if(n instanceof Ft)return t.locatePointInPolygon(e,n);if(n instanceof Ut)for(var i=new Tn(n);i.hasNext();){var r=i.next();if(r!==n){var o=t.locateInGeometry(e,r);if(o!==W.EXTERIOR)return o}}return W.EXTERIOR}},{key:"isContained",value:function(e,n){return W.EXTERIOR!==t.locate(e,n)}},{key:"locate",value:function(e,n){return n.isEmpty()?W.EXTERIOR:n.getEnvelopeInternal().intersects(e)?t.locateInGeometry(e,n):W.EXTERIOR}}])}(),Rn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getNextCW",value:function(t){this.getEdges();var e=this.Ol.indexOf(t),n=e-1;return 0===e&&(n=this.Ol.size()-1),this.Ol.get(n)}},{key:"propagateSideLabels",value:function(t){for(var e=W.NONE,n=this.iterator();n.hasNext();){var i=n.next().getLabel();i.isArea(t)&&i.getLocation(t,Z.LEFT)!==W.NONE&&(e=i.getLocation(t,Z.LEFT))}if(e===W.NONE)return null;for(var r=e,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getLabel();if(a.getLocation(t,Z.ON)===W.NONE&&a.setLocation(t,Z.ON,r),a.isArea(t)){var u=a.getLocation(t,Z.LEFT),h=a.getLocation(t,Z.RIGHT);if(h!==W.NONE){if(h!==r)throw new ft("side location conflict",s.getCoordinate());u===W.NONE&&P.shouldNeverReachHere("found single null side (at "+s.getCoordinate()+")"),r=u}else P.isTrue(a.getLocation(t,Z.LEFT)===W.NONE,"found single null side"),a.setLocation(t,Z.RIGHT,r),a.setLocation(t,Z.LEFT,r)}}}},{key:"getCoordinate",value:function(){var t=this.iterator();return t.hasNext()?t.next().getCoordinate():null}},{key:"print",value:function(t){wt.out.println("EdgeEndStar:   "+this.getCoordinate());for(var e=this.iterator();e.hasNext();)e.next().print(t)}},{key:"isAreaLabelsConsistent",value:function(t){return this.computeEdgeEndLabels(t.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)}},{key:"checkAreaLabelsConsistent",value:function(t){var e=this.getEdges();if(e.size()<=0)return!0;var n=e.size()-1,i=e.get(n).getLabel().getLocation(t,Z.LEFT);P.isTrue(i!==W.NONE,"Found unlabelled area edge");for(var r=i,o=this.iterator();o.hasNext();){var s=o.next().getLabel();P.isTrue(s.isArea(t),"Found non-area edge");var a=s.getLocation(t,Z.LEFT),u=s.getLocation(t,Z.RIGHT);if(a===u)return!1;if(u!==r)return!1;r=a}return!0}},{key:"findIndex",value:function(t){this.iterator();for(var e=0;e<this.Ol.size();e++)if(this.Ol.get(e)===t)return e;return-1}},{key:"iterator",value:function(){return this.getEdges().iterator()}},{key:"getEdges",value:function(){return null===this.Ol&&(this.Ol=new pt(this.Il.values())),this.Ol}},{key:"getLocation",value:function(t,e,n){return this.Tl[t]===W.NONE&&(this.Tl[t]=zn.locate(e,n[t].getGeometry())),this.Tl[t]}},{key:"toString",value:function(){var t=new rt;t.append("EdgeEndStar:   "+this.getCoordinate()),t.append("\n");for(var e=this.iterator();e.hasNext();){var n=e.next();t.append(n),t.append("\n")}return t.toString()}},{key:"computeEdgeEndLabels",value:function(t){for(var e=this.iterator();e.hasNext();)e.next().computeLabel(t)}},{key:"computeLabelling",value:function(t){this.computeEdgeEndLabels(t[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var e=[!1,!1],n=this.iterator();n.hasNext();)for(var i=n.next().getLabel(),r=0;r<2;r++)i.isLine(r)&&i.getLocation(r)===W.BOUNDARY&&(e[r]=!0);for(var o=this.iterator();o.hasNext();)for(var s=o.next(),a=s.getLabel(),u=0;u<2;u++)if(a.isAnyNull(u)){var h=W.NONE;if(e[u])h=W.EXTERIOR;else{var l=s.getCoordinate();h=this.getLocation(u,l,t)}a.setAllLocationsIfNull(u,h)}}},{key:"getDegree",value:function(){return this.Il.size()}},{key:"insertEdgeEnd",value:function(t,e){this.Il.put(t,e),this.Ol=null}}],[{key:"constructor_",value:function(){this.Il=new De,this.Ol=null,this.Tl=[W.NONE,W.NONE]}}]),Fn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"linkResultDirectedEdges",value:function(){this.getResultAreaEdges();for(var t=null,e=null,n=this.zl,i=0;i<this.Rl.size();i++){var r=this.Rl.get(i),o=r.getSym();if(r.getLabel().isArea())switch(null===t&&r.isInResult()&&(t=r),n){case this.zl:if(!o.isInResult())continue;e=o,n=this.Fl;break;case this.Fl:if(!r.isInResult())continue;e.setNext(r),n=this.zl}}if(n===this.Fl){if(null===t)throw new ft("no outgoing dirEdge found",this.getCoordinate());P.isTrue(t.isInResult(),"unable to link last incoming dirEdge"),e.setNext(t)}}},{key:"insert",value:function(t){var e=t;this.insertEdgeEnd(e,e)}},{key:"getRightmostEdge",value:function(){var t=this.getEdges(),e=t.size();if(e<1)return null;var n=t.get(0);if(1===e)return n;var i=t.get(e-1),r=n.getQuadrant(),o=i.getQuadrant();return Ne.isNorthern(r)&&Ne.isNorthern(o)?n:Ne.isNorthern(r)||Ne.isNorthern(o)?0!==n.getDy()?n:0!==i.getDy()?i:(P.shouldNeverReachHere("found two horizontal edges incident on node"),null):i}},{key:"print",value:function(t){wt.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var e=this.iterator();e.hasNext();){var n=e.next();t.print("out "),n.print(t),t.println(),t.print("in "),n.getSym().print(t),t.println()}}},{key:"getResultAreaEdges",value:function(){if(null!==this.Rl)return this.Rl;this.Rl=new pt;for(var t=this.iterator();t.hasNext();){var e=t.next();(e.isInResult()||e.getSym().isInResult())&&this.Rl.add(e)}return this.Rl}},{key:"updateLabelling",value:function(t){for(var e=this.iterator();e.hasNext();){var n=e.next().getLabel();n.setAllLocationsIfNull(0,t.getLocation(0)),n.setAllLocationsIfNull(1,t.getLocation(1))}}},{key:"linkAllDirectedEdges",value:function(){this.getEdges();for(var t=null,e=null,n=this.Ol.size()-1;n>=0;n--){var i=this.Ol.get(n),r=i.getSym();null===e&&(e=r),null!==t&&r.setNext(t),t=i}e.setNext(t)}},{key:"computeDepths",value:function(){if(1===arguments.length){var t=arguments[0],e=this.findIndex(t),n=t.getDepth(Z.LEFT),i=t.getDepth(Z.RIGHT),r=this.computeDepths(e+1,this.Ol.size(),n);if(this.computeDepths(0,e,r)!==i)throw new ft("depth mismatch at "+t.getCoordinate())}else if(3===arguments.length){for(var o=arguments[1],s=arguments[2],a=arguments[0];a<o;a++){var u=this.Ol.get(a);u.setEdgeDepths(Z.RIGHT,s),s=u.getDepth(Z.LEFT)}return s}}},{key:"mergeSymLabels",value:function(){for(var t=this.iterator();t.hasNext();){var e=t.next();e.getLabel().merge(e.getSym().getLabel())}}},{key:"linkMinimalDirectedEdges",value:function(t){for(var e=null,n=null,i=this.zl,r=this.Rl.size()-1;r>=0;r--){var o=this.Rl.get(r),s=o.getSym();switch(null===e&&o.getEdgeRing()===t&&(e=o),i){case this.zl:if(s.getEdgeRing()!==t)continue;n=s,i=this.Fl;break;case this.Fl:if(o.getEdgeRing()!==t)continue;n.setNextMin(o),i=this.zl}}i===this.Fl&&(P.isTrue(null!==e,"found null for first outgoing dirEdge"),P.isTrue(e.getEdgeRing()===t,"unable to link last incoming dirEdge"),n.setNextMin(e))}},{key:"getOutgoingDegree",value:function(){if(0===arguments.length){for(var t=0,e=this.iterator();e.hasNext();)e.next().isInResult()&&t++;return t}if(1===arguments.length){for(var n=arguments[0],i=0,r=this.iterator();r.hasNext();)r.next().getEdgeRing()===n&&i++;return i}}},{key:"getLabel",value:function(){return this.Xu}},{key:"findCoveredLineEdges",value:function(){for(var t=W.NONE,e=this.iterator();e.hasNext();){var n=e.next(),i=n.getSym();if(!n.isLineEdge()){if(n.isInResult()){t=W.INTERIOR;break}if(i.isInResult()){t=W.EXTERIOR;break}}}if(t===W.NONE)return null;for(var r=t,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getSym();s.isLineEdge()?s.getEdge().setCovered(r===W.INTERIOR):(s.isInResult()&&(r=W.EXTERIOR),a.isInResult()&&(r=W.INTERIOR))}}},{key:"computeLabelling",value:function(t){f(i,"computeLabelling",this,1).call(this,t),this.Xu=new $e(W.NONE);for(var e=this.iterator();e.hasNext();)for(var n=e.next().getEdge().getLabel(),r=0;r<2;r++){var o=n.getLocation(r);o!==W.INTERIOR&&o!==W.BOUNDARY||this.Xu.setLocation(r,W.INTERIOR)}}}],[{key:"constructor_",value:function(){this.Rl=null,this.Xu=null,this.zl=1,this.Fl=2}}])}(Rn),Dn=function(t){function i(){return n(this,i),e(this,i)}return h(i,t),o(i,[{key:"createNode",value:function(t){return new Ae(t,new Fn)}}])}(je),Pn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"compareTo",value:function(e){var n=e;return t.compareOriented(this.Gu,this.Dl,n.Gu,n.Dl)}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this.Gu=null,this.Dl=null;var e=arguments[0];this.Gu=e,this.Dl=t.orientation(e)}},{key:"orientation",value:function(t){return 1===Gt.increasingDirection(t)}},{key:"compareOriented",value:function(t,e,n,i){for(var r=e?1:-1,o=i?1:-1,s=e?t.length:-1,a=i?n.length:-1,u=e?0:t.length-1,h=i?0:n.length-1;;){var l=t[u].compareTo(n[h]);if(0!==l)return l;var c=(u+=r)===s,f=(h+=o)===a;if(c&&!f)return-1;if(!c&&f)return 1;if(c&&f)return 0}}}])}(),Nn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"print",value:function(t){t.print("MULTILINESTRING ( ");for(var e=0;e<this.Zu.size();e++){var n=this.Zu.get(e);e>0&&t.print(","),t.print("(");for(var i=n.getCoordinates(),r=0;r<i.length;r++)r>0&&t.print(","),t.print(i[r].x+" "+i[r].y);t.println(")")}t.print(")  ")}},{key:"addAll",value:function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next())}},{key:"findEdgeIndex",value:function(t){for(var e=0;e<this.Zu.size();e++)if(this.Zu.get(e).equals(t))return e;return-1}},{key:"iterator",value:function(){return this.Zu.iterator()}},{key:"getEdges",value:function(){return this.Zu}},{key:"get",value:function(t){return this.Zu.get(t)}},{key:"findEqualEdge",value:function(t){var e=new Pn(t.getCoordinates());return this.Pl.get(e)}},{key:"add",value:function(t){this.Zu.add(t);var e=new Pn(t.getCoordinates());this.Pl.put(e,t)}}],[{key:"constructor_",value:function(){this.Zu=new pt,this.Pl=new De}}]),Un=o((function t(){n(this,t)}),[{key:"processIntersections",value:function(t,e,n,i){}},{key:"isDone",value:function(){}}]),qn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"isTrivialIntersection",value:function(e,n,i,r){if(e===i&&1===this.dl.getIntersectionNum()){if(t.isAdjacentSegments(n,r))return!0;if(e.isClosed()){var o=e.size()-1;if(0===n&&r===o||0===r&&n===o)return!0}}return!1}},{key:"getProperIntersectionPoint",value:function(){return this.Nl}},{key:"hasProperInteriorIntersection",value:function(){return this.Ul}},{key:"getLineIntersector",value:function(){return this.dl}},{key:"hasProperIntersection",value:function(){return this.ql}},{key:"processIntersections",value:function(t,e,n,i){if(t===n&&e===i)return null;this.numTests++;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];this.dl.computeIntersection(r,o,s,a),this.dl.hasIntersection()&&(this.numIntersections++,this.dl.isInteriorIntersection()&&(this.numInteriorIntersections++,this.jl=!0),this.isTrivialIntersection(t,e,n,i)||(this.Ll=!0,t.addIntersections(this.dl,e,0),n.addIntersections(this.dl,i,1),this.dl.isProper()&&(this.numProperIntersections++,this.ql=!0,this.Ul=!0)))}},{key:"hasIntersection",value:function(){return this.Ll}},{key:"isDone",value:function(){return!1}},{key:"hasInteriorIntersection",value:function(){return this.jl}},{key:"interfaces_",get:function(){return[Un]}}],[{key:"constructor_",value:function(){this.Ll=!1,this.ql=!1,this.Ul=!1,this.jl=!1,this.Nl=null,this.dl=null,this.Bl=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0;var t=arguments[0];this.dl=t}},{key:"isAdjacentSegments",value:function(t,e){return 1===Math.abs(t-e)}}])}(),jn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getSegmentIndex",value:function(){return this.segmentIndex}},{key:"getCoordinate",value:function(){return this.coord}},{key:"print",value:function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex),t.println(" dist = "+this.dist)}},{key:"compareTo",value:function(t){var e=t;return this.compare(e.segmentIndex,e.dist)}},{key:"isEndPoint",value:function(t){return 0===this.segmentIndex&&0===this.dist||this.segmentIndex===t}},{key:"toString",value:function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist}},{key:"getDistance",value:function(){return this.dist}},{key:"compare",value:function(t,e){return this.segmentIndex<t?-1:this.segmentIndex>t?1:this.dist<e?-1:this.dist>e?1:0}},{key:"interfaces_",get:function(){return[_]}}],[{key:"constructor_",value:function(){this.coord=null,this.segmentIndex=null,this.dist=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.coord=new j(t),this.segmentIndex=e,this.dist=n}}]),Ln=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"print",value:function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)}},{key:"iterator",value:function(){return this.Nh.values().iterator()}},{key:"addSplitEdges",value:function(t){this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next(),r=this.createSplitEdge(n,i);t.add(r),n=i}}},{key:"addEndpoints",value:function(){var t=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[t],t,0)}},{key:"createSplitEdge",value:function(t,e){var n=e.segmentIndex-t.segmentIndex+2,i=this.edge.pts[e.segmentIndex],r=e.dist>0||!e.coord.equals2D(i);r||n--;var o=new Array(n).fill(null),s=0;o[s++]=new j(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)o[s++]=this.edge.pts[a];return r&&(o[s]=e.coord),new Yn(o,new $e(this.edge.Xu))}},{key:"add",value:function(t,e,n){var i=new jn(t,e,n),r=this.Nh.get(i);return null!==r?r:(this.Nh.put(i,i),i)}},{key:"isIntersection",value:function(t){for(var e=this.iterator();e.hasNext();)if(e.next().coord.equals(t))return!0;return!1}}],[{key:"constructor_",value:function(){this.Nh=new De,this.edge=null;var t=arguments[0];this.edge=t}}]),Bn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"isIntersects",value:function(){return!this.isDisjoint()}},{key:"isCovers",value:function(){return(t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])||t.isTrue(this.Hl[W.INTERIOR][W.BOUNDARY])||t.isTrue(this.Hl[W.BOUNDARY][W.INTERIOR])||t.isTrue(this.Hl[W.BOUNDARY][W.BOUNDARY]))&&this.Hl[W.EXTERIOR][W.INTERIOR]===Et.FALSE&&this.Hl[W.EXTERIOR][W.BOUNDARY]===Et.FALSE}},{key:"isCoveredBy",value:function(){return(t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])||t.isTrue(this.Hl[W.INTERIOR][W.BOUNDARY])||t.isTrue(this.Hl[W.BOUNDARY][W.INTERIOR])||t.isTrue(this.Hl[W.BOUNDARY][W.BOUNDARY]))&&this.Hl[W.INTERIOR][W.EXTERIOR]===Et.FALSE&&this.Hl[W.BOUNDARY][W.EXTERIOR]===Et.FALSE}},{key:"set",value:function(){if(1===arguments.length)for(var t=arguments[0],e=0;e<t.length;e++){var n=Math.trunc(e/3),i=e%3;this.Hl[n][i]=Et.toDimensionValue(t.charAt(e))}else if(3===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2];this.Hl[r][o]=s}}},{key:"isContains",value:function(){return t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&this.Hl[W.EXTERIOR][W.INTERIOR]===Et.FALSE&&this.Hl[W.EXTERIOR][W.BOUNDARY]===Et.FALSE}},{key:"setAtLeast",value:function(){if(1===arguments.length)for(var t=arguments[0],e=0;e<t.length;e++){var n=Math.trunc(e/3),i=e%3;this.setAtLeast(n,i,Et.toDimensionValue(t.charAt(e)))}else if(3===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2];this.Hl[r][o]<s&&(this.Hl[r][o]=s)}}},{key:"setAtLeastIfValid",value:function(t,e,n){t>=0&&e>=0&&this.setAtLeast(t,e,n)}},{key:"isWithin",value:function(){return t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&this.Hl[W.INTERIOR][W.EXTERIOR]===Et.FALSE&&this.Hl[W.BOUNDARY][W.EXTERIOR]===Et.FALSE}},{key:"isTouches",value:function(e,n){return e>n?this.isTouches(n,e):(e===Et.A&&n===Et.A||e===Et.L&&n===Et.L||e===Et.L&&n===Et.A||e===Et.P&&n===Et.A||e===Et.P&&n===Et.L)&&this.Hl[W.INTERIOR][W.INTERIOR]===Et.FALSE&&(t.isTrue(this.Hl[W.INTERIOR][W.BOUNDARY])||t.isTrue(this.Hl[W.BOUNDARY][W.INTERIOR])||t.isTrue(this.Hl[W.BOUNDARY][W.BOUNDARY]))}},{key:"isOverlaps",value:function(e,n){return e===Et.P&&n===Et.P||e===Et.A&&n===Et.A?t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&t.isTrue(this.Hl[W.INTERIOR][W.EXTERIOR])&&t.isTrue(this.Hl[W.EXTERIOR][W.INTERIOR]):e===Et.L&&n===Et.L&&1===this.Hl[W.INTERIOR][W.INTERIOR]&&t.isTrue(this.Hl[W.INTERIOR][W.EXTERIOR])&&t.isTrue(this.Hl[W.EXTERIOR][W.INTERIOR])}},{key:"isEquals",value:function(e,n){return e===n&&t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&this.Hl[W.INTERIOR][W.EXTERIOR]===Et.FALSE&&this.Hl[W.BOUNDARY][W.EXTERIOR]===Et.FALSE&&this.Hl[W.EXTERIOR][W.INTERIOR]===Et.FALSE&&this.Hl[W.EXTERIOR][W.BOUNDARY]===Et.FALSE}},{key:"toString",value:function(){for(var t=new Xt("123456789"),e=0;e<3;e++)for(var n=0;n<3;n++)t.setCharAt(3*e+n,Et.toDimensionSymbol(this.Hl[e][n]));return t.toString()}},{key:"setAll",value:function(t){for(var e=0;e<3;e++)for(var n=0;n<3;n++)this.Hl[e][n]=t}},{key:"get",value:function(t,e){return this.Hl[t][e]}},{key:"transpose",value:function(){var t=this.Hl[1][0];return this.Hl[1][0]=this.Hl[0][1],this.Hl[0][1]=t,t=this.Hl[2][0],this.Hl[2][0]=this.Hl[0][2],this.Hl[0][2]=t,t=this.Hl[2][1],this.Hl[2][1]=this.Hl[1][2],this.Hl[1][2]=t,this}},{key:"matches",value:function(e){if(9!==e.length)throw new g("Should be length 9: "+e);for(var n=0;n<3;n++)for(var i=0;i<3;i++)if(!t.matches(this.Hl[n][i],e.charAt(3*n+i)))return!1;return!0}},{key:"add",value:function(t){for(var e=0;e<3;e++)for(var n=0;n<3;n++)this.setAtLeast(e,n,t.get(e,n))}},{key:"isDisjoint",value:function(){return this.Hl[W.INTERIOR][W.INTERIOR]===Et.FALSE&&this.Hl[W.INTERIOR][W.BOUNDARY]===Et.FALSE&&this.Hl[W.BOUNDARY][W.INTERIOR]===Et.FALSE&&this.Hl[W.BOUNDARY][W.BOUNDARY]===Et.FALSE}},{key:"isCrosses",value:function(e,n){return e===Et.P&&n===Et.L||e===Et.P&&n===Et.A||e===Et.L&&n===Et.A?t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&t.isTrue(this.Hl[W.INTERIOR][W.EXTERIOR]):e===Et.L&&n===Et.P||e===Et.A&&n===Et.P||e===Et.A&&n===Et.L?t.isTrue(this.Hl[W.INTERIOR][W.INTERIOR])&&t.isTrue(this.Hl[W.EXTERIOR][W.INTERIOR]):e===Et.L&&n===Et.L&&0===this.Hl[W.INTERIOR][W.INTERIOR]}},{key:"interfaces_",get:function(){return[x]}}],[{key:"constructor_",value:function(){if(this.Hl=null,0===arguments.length)this.Hl=Array(3).fill().map((function(){return Array(3)})),this.setAll(Et.FALSE);else if(1===arguments.length)if("string"==typeof arguments[0]){var e=arguments[0];t.constructor_.call(this),this.set(e)}else if(arguments[0]instanceof t){var n=arguments[0];t.constructor_.call(this),this.Hl[W.INTERIOR][W.INTERIOR]=n.Hl[W.INTERIOR][W.INTERIOR],this.Hl[W.INTERIOR][W.BOUNDARY]=n.Hl[W.INTERIOR][W.BOUNDARY],this.Hl[W.INTERIOR][W.EXTERIOR]=n.Hl[W.INTERIOR][W.EXTERIOR],this.Hl[W.BOUNDARY][W.INTERIOR]=n.Hl[W.BOUNDARY][W.INTERIOR],this.Hl[W.BOUNDARY][W.BOUNDARY]=n.Hl[W.BOUNDARY][W.BOUNDARY],this.Hl[W.BOUNDARY][W.EXTERIOR]=n.Hl[W.BOUNDARY][W.EXTERIOR],this.Hl[W.EXTERIOR][W.INTERIOR]=n.Hl[W.EXTERIOR][W.INTERIOR],this.Hl[W.EXTERIOR][W.BOUNDARY]=n.Hl[W.EXTERIOR][W.BOUNDARY],this.Hl[W.EXTERIOR][W.EXTERIOR]=n.Hl[W.EXTERIOR][W.EXTERIOR]}}},{key:"matches",value:function(){if(Number.isInteger(arguments[0])&&"string"==typeof arguments[1]){var e=arguments[0],n=arguments[1];return n===Et.SYM_DONTCARE||n===Et.SYM_TRUE&&(e>=0||e===Et.TRUE)||n===Et.SYM_FALSE&&e===Et.FALSE||n===Et.SYM_P&&e===Et.P||n===Et.SYM_L&&e===Et.L||n===Et.SYM_A&&e===Et.A}if("string"==typeof arguments[0]&&"string"==typeof arguments[1]){var i=arguments[1];return new t(arguments[0]).matches(i)}}},{key:"isTrue",value:function(t){return t>=0||t===Et.TRUE}}])}(),Hn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"size",value:function(){return this.Pi}},{key:"addAll",value:function(t){return null===t||0===t.length?null:(this.ensureCapacity(this.Pi+t.length),wt.arraycopy(t,0,this.We,this.Pi,t.length),void(this.Pi+=t.length))}},{key:"ensureCapacity",value:function(t){if(t<=this.We.length)return null;var e=Math.max(t,2*this.We.length);this.We=zt.copyOf(this.We,e)}},{key:"toArray",value:function(){var t=new Array(this.Pi).fill(null);return wt.arraycopy(this.We,0,t,0,this.Pi),t}},{key:"add",value:function(t){this.ensureCapacity(this.Pi+1),this.We[this.Pi]=t,++this.Pi}}],[{key:"constructor_",value:function(){if(this.We=null,this.Pi=0,0===arguments.length)t.constructor_.call(this,10);else if(1===arguments.length){var e=arguments[0];this.We=new Array(e).fill(null)}}}])}(),Wn=function(){function t(){n(this,t)}return o(t,[{key:"getChainStartIndices",value:function(t){var e=0,n=new Hn(Math.trunc(t.length/2));n.add(e);do{var i=this.findChainEnd(t,e);n.add(i),e=i}while(e<t.length-1);return n.toArray()}},{key:"findChainEnd",value:function(t,e){for(var n=Ne.quadrant(t[e],t[e+1]),i=e+1;i<t.length&&Ne.quadrant(t[i-1],t[i])===n;)i++;return i-1}},{key:"OLDgetChainStartIndices",value:function(e){var n=0,i=new pt;i.add(n);do{var r=this.findChainEnd(e,n);i.add(r),n=r}while(n<e.length-1);return t.toIntArray(i)}}],[{key:"toIntArray",value:function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e}}])}(),Vn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"getCoordinates",value:function(){return this.pts}},{key:"getMaxX",value:function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e>n?e:n}},{key:"getMinX",value:function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e<n?e:n}},{key:"computeIntersectsForChain",value:function(){if(4===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],i=arguments[3];this.computeIntersectsForChain(this.startIndex[t],this.startIndex[t+1],e,e.startIndex[n],e.startIndex[n+1],i)}else if(6===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3],u=arguments[4],h=arguments[5];if(o-r==1&&u-a==1)return h.addIntersections(this.e,r,s.e,a),null;if(!this.overlaps(r,o,s,a,u))return null;var l=Math.trunc((r+o)/2),c=Math.trunc((a+u)/2);r<l&&(a<c&&this.computeIntersectsForChain(r,l,s,a,c,h),c<u&&this.computeIntersectsForChain(r,l,s,c,u,h)),l<o&&(a<c&&this.computeIntersectsForChain(l,o,s,a,c,h),c<u&&this.computeIntersectsForChain(l,o,s,c,u,h))}}},{key:"overlaps",value:function(t,e,n,i,r){return B.intersects(this.pts[t],this.pts[e],n.pts[i],n.pts[r])}},{key:"getStartIndexes",value:function(){return this.startIndex}},{key:"computeIntersects",value:function(t,e){for(var n=0;n<this.startIndex.length-1;n++)for(var i=0;i<t.startIndex.length-1;i++)this.computeIntersectsForChain(n,t,i,e)}}],[{key:"constructor_",value:function(){this.e=null,this.pts=null,this.startIndex=null;var t=arguments[0];this.e=t,this.pts=t.getCoordinates();var e=new Wn;this.startIndex=e.getChainStartIndices(this.pts)}}]),Gn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"getDepth",value:function(t,e){return this.ph[t][e]}},{key:"setDepth",value:function(t,e,n){this.ph[t][e]=n}},{key:"isNull",value:function(){if(0===arguments.length){for(var e=0;e<2;e++)for(var n=0;n<3;n++)if(this.ph[e][n]!==t.NULL_VALUE)return!1;return!0}if(1===arguments.length){var i=arguments[0];return this.ph[i][1]===t.NULL_VALUE}if(2===arguments.length){var r=arguments[0],o=arguments[1];return this.ph[r][o]===t.NULL_VALUE}}},{key:"normalize",value:function(){for(var t=0;t<2;t++)if(!this.isNull(t)){var e=this.ph[t][1];this.ph[t][2]<e&&(e=this.ph[t][2]),e<0&&(e=0);for(var n=1;n<3;n++){var i=0;this.ph[t][n]>e&&(i=1),this.ph[t][n]=i}}}},{key:"getDelta",value:function(t){return this.ph[t][Z.RIGHT]-this.ph[t][Z.LEFT]}},{key:"getLocation",value:function(t,e){return this.ph[t][e]<=0?W.EXTERIOR:W.INTERIOR}},{key:"toString",value:function(){return"A: "+this.ph[0][1]+","+this.ph[0][2]+" B: "+this.ph[1][1]+","+this.ph[1][2]}},{key:"add",value:function(){if(1===arguments.length)for(var e=arguments[0],n=0;n<2;n++)for(var i=1;i<3;i++){var r=e.getLocation(n,i);r!==W.EXTERIOR&&r!==W.INTERIOR||(this.isNull(n,i)?this.ph[n][i]=t.depthAtLocation(r):this.ph[n][i]+=t.depthAtLocation(r))}else if(3===arguments.length){var o=arguments[0],s=arguments[1];arguments[2]===W.INTERIOR&&this.ph[o][s]++}}}],[{key:"constructor_",value:function(){this.ph=Array(2).fill().map((function(){return Array(3)}));for(var e=0;e<2;e++)for(var n=0;n<3;n++)this.ph[e][n]=t.NULL_VALUE}},{key:"depthAtLocation",value:function(e){return e===W.EXTERIOR?0:e===W.INTERIOR?1:t.NULL_VALUE}}])}();Gn.NULL_VALUE=-1;var Yn=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"getDepth",value:function(){return this.ph}},{key:"getCollapsedEdge",value:function(){var t=new Array(2).fill(null);return t[0]=this.pts[0],t[1]=this.pts[1],new i(t,$e.toLineLabel(this.Xu))}},{key:"isIsolated",value:function(){return this.Wl}},{key:"getCoordinates",value:function(){return this.pts}},{key:"setIsolated",value:function(t){this.Wl=t}},{key:"setName",value:function(t){this.Jo=t}},{key:"equals",value:function(t){if(!(t instanceof i))return!1;var e=t;if(this.pts.length!==e.pts.length)return!1;for(var n=!0,r=!0,o=this.pts.length,s=0;s<this.pts.length;s++)if(this.pts[s].equals2D(e.pts[s])||(n=!1),this.pts[s].equals2D(e.pts[--o])||(r=!1),!n&&!r)return!1;return!0}},{key:"getCoordinate",value:function(){if(0===arguments.length)return this.pts.length>0?this.pts[0]:null;if(1===arguments.length){var t=arguments[0];return this.pts[t]}}},{key:"print",value:function(t){t.print("edge "+this.Jo+": "),t.print("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.print(","),t.print(this.pts[e].x+" "+this.pts[e].y);t.print(")  "+this.Xu+" "+this.Vl)}},{key:"computeIM",value:function(t){i.updateIM(this.Xu,t)}},{key:"isCollapsed",value:function(){return!!this.Xu.isArea()&&3===this.pts.length&&!!this.pts[0].equals(this.pts[2])}},{key:"isClosed",value:function(){return this.pts[0].equals(this.pts[this.pts.length-1])}},{key:"getMaximumSegmentIndex",value:function(){return this.pts.length-1}},{key:"getDepthDelta",value:function(){return this.Vl}},{key:"getNumPoints",value:function(){return this.pts.length}},{key:"printReverse",value:function(t){t.print("edge "+this.Jo+": ");for(var e=this.pts.length-1;e>=0;e--)t.print(this.pts[e]+" ");t.println("")}},{key:"getMonotoneChainEdge",value:function(){return null===this.Gl&&(this.Gl=new Vn(this)),this.Gl}},{key:"getEnvelope",value:function(){if(null===this.$u){this.$u=new B;for(var t=0;t<this.pts.length;t++)this.$u.expandToInclude(this.pts[t])}return this.$u}},{key:"addIntersection",value:function(t,e,n,i){var r=new j(t.getIntersection(i)),o=e,s=t.getEdgeDistance(n,i),a=o+1;if(a<this.pts.length){var u=this.pts[a];r.equals2D(u)&&(o=a,s=0)}this.eiList.add(r,o,s)}},{key:"toString",value:function(){var t=new Xt;t.append("edge "+this.Jo+": "),t.append("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.append(","),t.append(this.pts[e].x+" "+this.pts[e].y);return t.append(")  "+this.Xu+" "+this.Vl),t.toString()}},{key:"isPointwiseEqual",value:function(t){if(this.pts.length!==t.pts.length)return!1;for(var e=0;e<this.pts.length;e++)if(!this.pts[e].equals2D(t.pts[e]))return!1;return!0}},{key:"setDepthDelta",value:function(t){this.Vl=t}},{key:"getEdgeIntersectionList",value:function(){return this.eiList}},{key:"addIntersections",value:function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++)this.addIntersection(t,e,n,i)}}],[{key:"constructor_",value:function(){if(this.pts=null,this.$u=null,this.eiList=new Ln(this),this.Jo=null,this.Gl=null,this.Wl=!0,this.ph=new Gn,this.Vl=0,1===arguments.length){var t=arguments[0];i.constructor_.call(this,t,null)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.pts=e,this.Xu=n}}},{key:"updateIM",value:function(){if(!(2===arguments.length&&arguments[1]instanceof Bn&&arguments[0]instanceof $e))return f(i,"updateIM",this).apply(this,arguments);var t=arguments[0],e=arguments[1];e.setAtLeastIfValid(t.getLocation(0,Z.ON),t.getLocation(1,Z.ON),1),t.isArea()&&(e.setAtLeastIfValid(t.getLocation(0,Z.LEFT),t.getLocation(1,Z.LEFT),2),e.setAtLeastIfValid(t.getLocation(0,Z.RIGHT),t.getLocation(1,Z.RIGHT),2))}}])}(Ce),Kn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"setWorkingPrecisionModel",value:function(t){this.Yl=t}},{key:"insertUniqueEdge",value:function(e){var n=this.Ol.findEqualEdge(e);if(null!==n){var i=n.getLabel(),r=e.getLabel();n.isPointwiseEqual(e)||(r=new $e(e.getLabel())).flip(),i.merge(r);var o=t.depthDelta(r),s=n.getDepthDelta()+o;n.setDepthDelta(s)}else this.Ol.add(e),e.setDepthDelta(t.depthDelta(e.getLabel()))}},{key:"buildSubgraphs",value:function(t,e){for(var n=new pt,i=t.iterator();i.hasNext();){var r=i.next(),o=r.getRightmostCoordinate(),s=new Sn(n).getDepth(o);r.computeDepth(s),r.findResultEdges(),n.add(r),e.add(r.getDirectedEdges(),r.getNodes())}}},{key:"createSubgraphs",value:function(t){for(var e=new pt,n=t.getNodes().iterator();n.hasNext();){var i=n.next();if(!i.isVisited()){var r=new mt;r.create(i),e.add(r)}}return Ke.sort(e,Ke.reverseOrder()),e}},{key:"createEmptyResultGeometry",value:function(){return this.Kl.createPolygon()}},{key:"getNoder",value:function(t){if(null!==this.Xl)return this.Xl;var e=new wn,n=new be;return n.setPrecisionModel(t),e.setSegmentIntersector(new qn(n)),e}},{key:"buffer",value:function(t,e){var n=this.Yl;null===n&&(n=t.getPrecisionModel()),this.Kl=t.getFactory();var i=new $n(n,this.ll),r=new On(t,e,i).getCurves();if(r.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(r,n),this.Ql=new Le(new Dn),this.Ql.addEdges(this.Ol.getEdges());var o=this.createSubgraphs(this.Ql),s=new Be(this.Kl);this.buildSubgraphs(o,s);var a=s.getPolygons();return a.size()<=0?this.createEmptyResultGeometry():this.Kl.buildGeometry(a)}},{key:"computeNodedEdges",value:function(t,e){var n=this.getNoder(e);n.computeNodes(t);for(var i=n.getNodedSubstrings().iterator();i.hasNext();){var r=i.next(),o=r.getCoordinates();if(2!==o.length||!o[0].equals2D(o[1])){var s=r.getData(),a=new Yn(r.getCoordinates(),new $e(s));this.insertUniqueEdge(a)}}}},{key:"setNoder",value:function(t){this.Xl=t}}],[{key:"constructor_",value:function(){this.ll=null,this.Yl=null,this.Xl=null,this.Kl=null,this.Ql=null,this.Ol=new Nn;var t=arguments[0];this.ll=t}},{key:"depthDelta",value:function(t){var e=t.getLocation(0,Z.LEFT),n=t.getLocation(0,Z.RIGHT);return e===W.INTERIOR&&n===W.EXTERIOR?1:e===W.EXTERIOR&&n===W.INTERIOR?-1:0}},{key:"convertSegStrings",value:function(t){for(var e=new oe,n=new pt;t.hasNext();){var i=t.next(),r=e.createLineString(i.getCoordinates());n.add(r)}return e.buildGeometry(n)}}])}(),Xn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"rescale",value:function(){if(it(arguments[0],V))for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.rescale(e.getCoordinates())}else if(arguments[0]instanceof Array){for(var n=arguments[0],i=0;i<n.length;i++)n[i].x=n[i].x/this.Zl+this.Jl,n[i].y=n[i].y/this.Zl+this.tc;2===n.length&&n[0].equals2D(n[1])&&wt.out.println(n)}}},{key:"scale",value:function(){if(it(arguments[0],V)){for(var t=arguments[0],e=new pt(t.size()),n=t.iterator();n.hasNext();){var i=n.next();e.add(new cn(this.scale(i.getCoordinates()),i.getData()))}return e}if(arguments[0]instanceof Array){for(var r=arguments[0],o=new Array(r.length).fill(null),s=0;s<r.length;s++)o[s]=new j(Math.round((r[s].x-this.Jl)*this.Zl),Math.round((r[s].y-this.tc)*this.Zl),r[s].getZ());return Gt.removeRepeatedPoints(o)}}},{key:"isIntegerPrecision",value:function(){return 1===this.Zl}},{key:"getNodedSubstrings",value:function(){var t=this.rc.getNodedSubstrings();return this.oc&&this.rescale(t),t}},{key:"computeNodes",value:function(t){var e=t;this.oc&&(e=this.scale(t)),this.rc.computeNodes(e)}},{key:"interfaces_",get:function(){return[mn]}}],[{key:"constructor_",value:function(){if(this.rc=null,this.Zl=null,this.Jl=null,this.tc=null,this.oc=!1,2===arguments.length){var e=arguments[0],n=arguments[1];t.constructor_.call(this,e,n,0,0)}else if(4===arguments.length){var i=arguments[0],r=arguments[1];this.rc=i,this.Zl=r,this.oc=!this.isIntegerPrecision()}}}])}(),Qn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"checkEndPtVertexIntersections",value:function(){if(0===arguments.length)for(var t=this.sc.iterator();t.hasNext();){var e=t.next().getCoordinates();this.checkEndPtVertexIntersections(e[0],this.sc),this.checkEndPtVertexIntersections(e[e.length-1],this.sc)}else if(2===arguments.length)for(var n=arguments[0],i=arguments[1].iterator();i.hasNext();)for(var r=i.next().getCoordinates(),o=1;o<r.length-1;o++)if(r[o].equals(n))throw new F("found endpt/interior pt intersection at index "+o+" :pt "+n)}},{key:"checkInteriorIntersections",value:function(){if(0===arguments.length)for(var t=this.sc.iterator();t.hasNext();)for(var e=t.next(),n=this.sc.iterator();n.hasNext();){var i=n.next();this.checkInteriorIntersections(e,i)}else if(2===arguments.length)for(var r=arguments[0],o=arguments[1],s=r.getCoordinates(),a=o.getCoordinates(),u=0;u<s.length-1;u++)for(var h=0;h<a.length-1;h++)this.checkInteriorIntersections(r,u,o,h);else if(4===arguments.length){var l=arguments[0],c=arguments[1],f=arguments[2],d=arguments[3];if(l===f&&c===d)return null;var p=l.getCoordinates()[c],v=l.getCoordinates()[c+1],m=f.getCoordinates()[d],y=f.getCoordinates()[d+1];if(this.dl.computeIntersection(p,v,m,y),this.dl.hasIntersection()&&(this.dl.isProper()||this.hasInteriorIntersection(this.dl,p,v)||this.hasInteriorIntersection(this.dl,m,y)))throw new F("found non-noded intersection at "+p+"-"+v+" and "+m+"-"+y)}}},{key:"checkValid",value:function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()}},{key:"checkCollapses",value:function(){if(0===arguments.length)for(var t=this.sc.iterator();t.hasNext();){var e=t.next();this.checkCollapses(e)}else if(1===arguments.length)for(var n=arguments[0].getCoordinates(),i=0;i<n.length-2;i++)this.checkCollapse(n[i],n[i+1],n[i+2])}},{key:"hasInteriorIntersection",value:function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++){var r=t.getIntersection(i);if(!r.equals(e)&&!r.equals(n))return!0}return!1}},{key:"checkCollapse",value:function(e,n,i){if(e.equals(i))throw new F("found non-noded collapse at "+t.fact.createLineString([e,n,i]))}}],[{key:"constructor_",value:function(){this.dl=new be,this.sc=null;var t=arguments[0];this.sc=t}}])}();Qn.fact=new oe;var Zn=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"intersectsScaled",value:function(t,e){var n=Math.min(t.x,e.x),i=Math.max(t.x,e.x),r=Math.min(t.y,e.y),o=Math.max(t.y,e.y),s=this.au<n||this.hu>i||this.uu<r||this.lu>o;if(s)return!1;var a=this.intersectsToleranceSquare(t,e);return P.isTrue(!(s&&a),"Found bad envelope test"),a}},{key:"initCorners",value:function(t){var e=.5;this.hu=t.x-e,this.au=t.x+e,this.lu=t.y-e,this.uu=t.y+e,this.uc[0]=new j(this.au,this.uu),this.uc[1]=new j(this.hu,this.uu),this.uc[2]=new j(this.hu,this.lu),this.uc[3]=new j(this.au,this.lu)}},{key:"intersects",value:function(t,e){return 1===this.Zl?this.intersectsScaled(t,e):(this.copyScaled(t,this.lc),this.copyScaled(e,this.vc),this.intersectsScaled(this.lc,this.vc))}},{key:"scale",value:function(t){return Math.round(t*this.Zl)}},{key:"getCoordinate",value:function(){return this.yc}},{key:"copyScaled",value:function(t,e){e.x=this.scale(t.x),e.y=this.scale(t.y)}},{key:"getSafeEnvelope",value:function(){if(null===this.wc){var e=t.SAFE_ENV_EXPANSION_FACTOR/this.Zl;this.wc=new B(this.yc.x-e,this.yc.x+e,this.yc.y-e,this.yc.y+e)}return this.wc}},{key:"intersectsPixelClosure",value:function(t,e){return this.dl.computeIntersection(t,e,this.uc[0],this.uc[1]),!!(this.dl.hasIntersection()||(this.dl.computeIntersection(t,e,this.uc[1],this.uc[2]),this.dl.hasIntersection()||(this.dl.computeIntersection(t,e,this.uc[2],this.uc[3]),this.dl.hasIntersection()||(this.dl.computeIntersection(t,e,this.uc[3],this.uc[0]),this.dl.hasIntersection()))))}},{key:"intersectsToleranceSquare",value:function(t,e){var n=!1,i=!1;return this.dl.computeIntersection(t,e,this.uc[0],this.uc[1]),!!(this.dl.isProper()||(this.dl.computeIntersection(t,e,this.uc[1],this.uc[2]),this.dl.isProper()||(this.dl.hasIntersection()&&(n=!0),this.dl.computeIntersection(t,e,this.uc[2],this.uc[3]),this.dl.isProper()||(this.dl.hasIntersection()&&(i=!0),this.dl.computeIntersection(t,e,this.uc[3],this.uc[0]),this.dl.isProper()||n&&i||t.equals(this.gc)||e.equals(this.gc)))))}},{key:"addSnappedNode",value:function(t,e){var n=t.getCoordinate(e),i=t.getCoordinate(e+1);return!!this.intersects(n,i)&&(t.addIntersection(this.getCoordinate(),e),!0)}}],[{key:"constructor_",value:function(){this.dl=null,this.gc=null,this.yc=null,this._c=null,this.lc=null,this.vc=null,this.Zl=null,this.hu=null,this.au=null,this.lu=null,this.uu=null,this.uc=new Array(4).fill(null),this.wc=null;var t=arguments[0],e=arguments[1],n=arguments[2];if(this.yc=t,this.gc=t,this.Zl=e,this.dl=n,e<=0)throw new g("Scale factor must be non-zero");1!==e&&(this.gc=new j(this.scale(t.x),this.scale(t.y)),this.lc=new j,this.vc=new j),this.initCorners(this.gc)}}])}();Zn.SAFE_ENV_EXPANSION_FACTOR=.75;var Jn=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"select",value:function(){if(1===arguments.length);else if(2===arguments.length){var t=arguments[1];arguments[0].getLineSegment(t,this.selectedSegment),this.select(this.selectedSegment)}}}],[{key:"constructor_",value:function(){this.selectedSegment=new fn}}]),ti=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"snap",value:function(){if(1===arguments.length){var t=arguments[0];return this.snap(t,null,-1)}if(3===arguments.length){var e=arguments[0],i=arguments[1],r=arguments[2],s=e.getSafeEnvelope(),a=new ei(e,i,r);return this._index.query(s,new(o((function t(){n(this,t)}),[{key:"interfaces_",get:function(){return[Ze]}},{key:"visitItem",value:function(t){t.select(s,a)}}]))),a.isNodeAdded()}}}],[{key:"constructor_",value:function(){this._index=null;var t=arguments[0];this._index=t}}]),ei=function(t){function i(){var t;return n(this,i),t=e(this,i),i.constructor_.apply(t,arguments),t}return h(i,t),o(i,[{key:"isNodeAdded",value:function(){return this.xc}},{key:"select",value:function(){if(!(2===arguments.length&&Number.isInteger(arguments[1])&&arguments[0]instanceof pn))return f(i,"select",this,1).apply(this,arguments);var t=arguments[1],e=arguments[0].getContext();if(this.$c===e&&(t===this.Sc||t+1===this.Sc))return null;this.xc|=this.Ec.addSnappedNode(e,t)}}],[{key:"constructor_",value:function(){this.Ec=null,this.$c=null,this.Sc=null,this.xc=!1;var t=arguments[0],e=arguments[1],n=arguments[2];this.Ec=t,this.$c=e,this.Sc=n}}])}(Jn);ti.HotPixelSnapAction=ei;var ni=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"processIntersections",value:function(t,e,n,i){if(t===n&&e===i)return null;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];if(this.dl.computeIntersection(r,o,s,a),this.dl.hasIntersection()&&this.dl.isInteriorIntersection()){for(var u=0;u<this.dl.getIntersectionNum();u++)this.Mc.add(this.dl.getIntersection(u));t.addIntersections(this.dl,e,0),n.addIntersections(this.dl,i,1)}}},{key:"isDone",value:function(){return!1}},{key:"getInteriorIntersections",value:function(){return this.Mc}},{key:"interfaces_",get:function(){return[Un]}}],[{key:"constructor_",value:function(){this.dl=null,this.Mc=null;var t=arguments[0];this.dl=t,this.Mc=new pt}}]),ii=o((function t(){n(this,t),t.constructor_.apply(this,arguments)}),[{key:"checkCorrectness",value:function(t){var e=cn.getNodedSubstrings(t),n=new Qn(e);try{n.checkValid()}catch(t){if(!(t instanceof w))throw t;t.printStackTrace()}}},{key:"getNodedSubstrings",value:function(){return cn.getNodedSubstrings(this.Vh)}},{key:"snapRound",value:function(t,e){var n=this.findInteriorIntersections(t,e);this.computeIntersectionSnaps(n),this.computeVertexSnaps(t)}},{key:"findInteriorIntersections",value:function(t,e){var n=new ni(e);return this.rc.setSegmentIntersector(n),this.rc.computeNodes(t),n.getInteriorIntersections()}},{key:"computeVertexSnaps",value:function(){if(it(arguments[0],V))for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.computeVertexSnaps(e)}else if(arguments[0]instanceof cn)for(var n=arguments[0],i=n.getCoordinates(),r=0;r<i.length;r++){var o=new Zn(i[r],this.Zl,this.dl);this.Cc.snap(o,n,r)&&n.addIntersection(i[r],r)}}},{key:"computeNodes",value:function(t){this.Vh=t,this.rc=new wn,this.Cc=new ti(this.rc.getIndex()),this.snapRound(t,this.dl)}},{key:"computeIntersectionSnaps",value:function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),i=new Zn(n,this.Zl,this.dl);this.Cc.snap(i)}}},{key:"interfaces_",get:function(){return[mn]}}],[{key:"constructor_",value:function(){this.Ac=null,this.dl=null,this.Zl=null,this.rc=null,this.Cc=null,this.Vh=null;var t=arguments[0];this.Ac=t,this.dl=new be,this.dl.setPrecisionModel(t),this.Zl=t.getScale()}}]),ri=function(){function t(){n(this,t),t.constructor_.apply(this,arguments)}return o(t,[{key:"bufferFixedPrecision",value:function(t){var e=new Xn(new ii(new ne(1)),t.getScale()),n=new Kn(this.ll);n.setWorkingPrecisionModel(t),n.setNoder(e),this.Oc=n.buffer(this.Ic,this.Oh)}},{key:"bufferReducedPrecision",value:function(){if(0===arguments.length){for(var e=t.MAX_PRECISION_DIGITS;e>=0;e--){try{this.bufferReducedPrecision(e)}catch(t){if(!(t instanceof ft))throw t;this.Tc=t}if(null!==this.Oc)return null}throw this.Tc}if(1===arguments.length){var n=arguments[0],i=t.precisionScaleFactor(this.Ic,this.Oh,n),r=new ne(i);this.bufferFixedPrecision(r)}}},{key:"computeGeometry",value:function(){if(this.bufferOriginalPrecision(),null!==this.Oc)return null;var t=this.Ic.getFactory().getPrecisionModel();t.getType()===ne.FIXED?this.bufferFixedPrecision(t):this.bufferReducedPrecision()}},{key:"setQuadrantSegments",value:function(t){this.ll.setQuadrantSegments(t)}},{key:"bufferOriginalPrecision",value:function(){try{var t=new Kn(this.ll);this.Oc=t.buffer(this.Ic,this.Oh)}catch(t){if(!(t instanceof F))throw t;this.Tc=t}}},{key:"getResultGeometry",value:function(t){return this.Oh=t,this.computeGeometry(),this.Oc}},{key:"setEndCapStyle",value:function(t){this.ll.setEndCapStyle(t)}}],[{key:"constructor_",value:function(){if(this.Ic=null,this.Oh=null,this.ll=new y,this.Oc=null,this.Tc=null,1===arguments.length){var t=arguments[0];this.Ic=t}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.Ic=e,this.ll=n}}},{key:"bufferOp",value:function(){if(2===arguments.length){var e=arguments[1];return new t(arguments[0]).getResultGeometry(e)}if(3===arguments.length){if(Number.isInteger(arguments[2])&&arguments[0]instanceof H&&"number"==typeof arguments[1]){var n=arguments[1],i=arguments[2],r=new t(arguments[0]);return r.setQuadrantSegments(i),r.getResultGeometry(n)}if(arguments[2]instanceof y&&arguments[0]instanceof H&&"number"==typeof arguments[1]){var o=arguments[1];return new t(arguments[0],arguments[2]).getResultGeometry(o)}}else if(4===arguments.length){var s=arguments[1],a=arguments[2],u=arguments[3],h=new t(arguments[0]);return h.setQuadrantSegments(a),h.setEndCapStyle(u),h.getResultGeometry(s)}}},{key:"precisionScaleFactor",value:function(t,e,n){var i=t.getEnvelopeInternal(),r=gt.max(Math.abs(i.getMaxX()),Math.abs(i.getMaxY()),Math.abs(i.getMinX()),Math.abs(i.getMinY()))+2*(e>0?e:0),o=n-Math.trunc(Math.log(r)/Math.log(10)+1);return Math.pow(10,o)}}])}();ri.CAP_ROUND=y.CAP_ROUND,ri.CAP_BUTT=y.CAP_FLAT,ri.CAP_FLAT=y.CAP_FLAT,ri.CAP_SQUARE=y.CAP_SQUARE,ri.MAX_PRECISION_DIGITS=12;var oi=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],si=o((function t(e){n(this,t),this.geometryFactory=e||new oe}),[{key:"read",value:function(t){var e,n=(e="string"==typeof t?JSON.parse(t):t).type;if(!ai[n])throw new Error("Unknown GeoJSON type: "+e.type);return-1!==oi.indexOf(n)?ai[n].call(this,e.coordinates):"GeometryCollection"===n?ai[n].call(this,e.geometries):ai[n].call(this,e)}},{key:"write",value:function(t){var e=t.getGeometryType();if(!ui[e])throw new Error("Geometry is not supported");return ui[e].call(this,t)}}]),ai={Feature:function(t){var e={};for(var n in t)e[n]=t[n];if(t.geometry){var i=t.geometry.type;if(!ai[i])throw new Error("Unknown GeoJSON type: "+t.type);e.geometry=this.read(t.geometry)}return t.bbox&&(e.bbox=ai.bbox.call(this,t.bbox)),e},FeatureCollection:function(t){var e={};if(t.features){e.features=[];for(var n=0;n<t.features.length;++n)e.features.push(this.read(t.features[n]))}return t.bbox&&(e.bbox=this.parse.bbox.call(this,t.bbox)),e},coordinates:function(t){for(var e=[],n=0;n<t.length;++n){var r=t[n];e.push(i(j,d(r)))}return e},bbox:function(t){return this.geometryFactory.createLinearRing([new j(t[0],t[1]),new j(t[2],t[1]),new j(t[2],t[3]),new j(t[0],t[3]),new j(t[0],t[1])])},Point:function(t){var e=i(j,d(t));return this.geometryFactory.createPoint(e)},MultiPoint:function(t){for(var e=[],n=0;n<t.length;++n)e.push(ai.Point.call(this,t[n]));return this.geometryFactory.createMultiPoint(e)},LineString:function(t){var e=ai.coordinates.call(this,t);return this.geometryFactory.createLineString(e)},MultiLineString:function(t){for(var e=[],n=0;n<t.length;++n)e.push(ai.LineString.call(this,t[n]));return this.geometryFactory.createMultiLineString(e)},Polygon:function(t){for(var e=ai.coordinates.call(this,t[0]),n=this.geometryFactory.createLinearRing(e),i=[],r=1;r<t.length;++r){var o=t[r],s=ai.coordinates.call(this,o),a=this.geometryFactory.createLinearRing(s);i.push(a)}return this.geometryFactory.createPolygon(n,i)},MultiPolygon:function(t){for(var e=[],n=0;n<t.length;++n){var i=t[n];e.push(ai.Polygon.call(this,i))}return this.geometryFactory.createMultiPolygon(e)},GeometryCollection:function(t){for(var e=[],n=0;n<t.length;++n){var i=t[n];e.push(this.read(i))}return this.geometryFactory.createGeometryCollection(e)}},ui={coordinate:function(t){var e=[t.x,t.y];return t.z&&e.push(t.z),t.m&&e.push(t.m),e},Point:function(t){return{type:"Point",coordinates:ui.coordinate.call(this,t.getCoordinate())}},MultiPoint:function(t){for(var e=[],n=0;n<t.Au.length;++n){var i=t.Au[n],r=ui.Point.call(this,i);e.push(r.coordinates)}return{type:"MultiPoint",coordinates:e}},LineString:function(t){for(var e=[],n=t.getCoordinates(),i=0;i<n.length;++i){var r=n[i];e.push(ui.coordinate.call(this,r))}return{type:"LineString",coordinates:e}},MultiLineString:function(t){for(var e=[],n=0;n<t.Au.length;++n){var i=t.Au[n],r=ui.LineString.call(this,i);e.push(r.coordinates)}return{type:"MultiLineString",coordinates:e}},Polygon:function(t){var e=[],n=ui.LineString.call(this,t.Mu);e.push(n.coordinates);for(var i=0;i<t.Cu.length;++i){var r=t.Cu[i],o=ui.LineString.call(this,r);e.push(o.coordinates)}return{type:"Polygon",coordinates:e}},MultiPolygon:function(t){for(var e=[],n=0;n<t.Au.length;++n){var i=t.Au[n],r=ui.Polygon.call(this,i);e.push(r.coordinates)}return{type:"MultiPolygon",coordinates:e}},GeometryCollection:function(t){for(var e=[],n=0;n<t.Au.length;++n){var i=t.Au[n],r=i.getGeometryType();e.push(ui[r].call(this,i))}return{type:"GeometryCollection",geometries:e}}};return{BufferOp:ri,GeoJSONReader:o((function t(e){n(this,t),this.parser=new si(e||new oe)}),[{key:"read",value:function(t){return this.parser.read(t)}}]),GeoJSONWriter:o((function t(){n(this,t),this.parser=new si(this.geometryFactory)}),[{key:"write",value:function(t){return this.parser.write(t)}}])}}()),bf.exports),xf=wf(_f);function kf(){return new $f}function $f(){this.reset()}$f.prototype={constructor:$f,reset:function(){this.s=this.t=0},add:function(t){Ef(Sf,t,this.t),Ef(this,Sf.s,this.s),this.s?this.t+=Sf.t:this.s=Sf.t},valueOf:function(){return this.s}};var Sf=new $f;function Ef(t,e,n){var i=t.s=e+n,r=i-e,o=i-r;t.t=e-o+(n-r)}var Mf=1e-6,Cf=Math.PI,Af=Cf/2,Of=Cf/4,If=2*Cf,Tf=180/Cf,zf=Cf/180,Rf=Math.abs,Ff=Math.atan,Df=Math.atan2,Pf=Math.cos,Nf=Math.sin,Uf=Math.sqrt;function qf(t){return t>1?0:t<-1?Cf:Math.acos(t)}function jf(t){return t>1?Af:t<-1?-Af:Math.asin(t)}function Lf(){}function Bf(t,e){t&&Gf.hasOwnProperty(t.type)&&Gf[t.type](t,e)}var Hf,Wf,Vf={Feature:function(t,e){Bf(t.geometry,e)},FeatureCollection:function(t,e){for(var n=t.features,i=-1,r=n.length;++i<r;)Bf(n[i].geometry,e)}},Gf={Sphere:function(t,e){e.sphere()},Point:function(t,e){t=t.coordinates,e.point(t[0],t[1],t[2])},MultiPoint:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)t=n[i],e.point(t[0],t[1],t[2])},LineString:function(t,e){Yf(t.coordinates,e,0)},MultiLineString:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)Yf(n[i],e,0)},Polygon:function(t,e){Kf(t.coordinates,e)},MultiPolygon:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)Kf(n[i],e)},GeometryCollection:function(t,e){for(var n=t.geometries,i=-1,r=n.length;++i<r;)Bf(n[i],e)}};function Yf(t,e,n){var i,r=-1,o=t.length-n;for(e.lineStart();++r<o;)i=t[r],e.point(i[0],i[1],i[2]);e.lineEnd()}function Kf(t,e){var n=-1,i=t.length;for(e.polygonStart();++n<i;)Yf(t[n],e,1);e.polygonEnd()}function Xf(t){return[Df(t[1],t[0]),jf(t[2])]}function Qf(t){var e=t[0],n=t[1],i=Pf(n);return[i*Pf(e),i*Nf(e),Nf(n)]}function Zf(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Jf(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function td(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]}function ed(t,e){return[t[0]*e,t[1]*e,t[2]*e]}function nd(t){var e=Uf(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}function id(t,e){function n(n,i){return n=t(n,i),e(n[0],n[1])}return t.invert&&e.invert&&(n.invert=function(n,i){return(n=e.invert(n,i))&&t.invert(n[0],n[1])}),n}function rd(t,e){return[t>Cf?t-If:t<-Cf?t+If:t,e]}function od(t){return function(e,n){return[(e+=t)>Cf?e-If:e<-Cf?e+If:e,n]}}function sd(t){var e=od(t);return e.invert=od(-t),e}function ad(t,e){var n=Pf(t),i=Nf(t),r=Pf(e),o=Nf(e);function s(t,e){var s=Pf(e),a=Pf(t)*s,u=Nf(t)*s,h=Nf(e),l=h*n+a*i;return[Df(u*r-l*o,a*n-h*i),jf(l*r+u*o)]}return s.invert=function(t,e){var s=Pf(e),a=Pf(t)*s,u=Nf(t)*s,h=Nf(e),l=h*r-u*o;return[Df(u*r+h*o,a*n+l*i),jf(l*n-a*i)]},s}function ud(t,e){(e=Qf(e))[0]-=t,nd(e);var n=qf(-e[1]);return((-e[2]<0?-n:n)+If-Mf)%If}function hd(){var t,e=[];return{point:function(e,n){t.push([e,n])},lineStart:function(){e.push(t=[])},lineEnd:Lf,rejoin:function(){e.length>1&&e.push(e.pop().concat(e.shift()))},result:function(){var n=e;return e=[],t=null,n}}}function ld(t,e){return Rf(t[0]-e[0])<Mf&&Rf(t[1]-e[1])<Mf}function cd(t,e,n,i){this.x=t,this.z=e,this.o=n,this.e=i,this.v=!1,this.n=this.p=null}function fd(t,e,n,i,r){var o,s,a=[],u=[];if(t.forEach((function(t){if(!((e=t.length-1)<=0)){var e,n,i=t[0],s=t[e];if(ld(i,s)){for(r.lineStart(),o=0;o<e;++o)r.point((i=t[o])[0],i[1]);r.lineEnd()}else a.push(n=new cd(i,t,null,!0)),u.push(n.o=new cd(i,null,n,!1)),a.push(n=new cd(s,t,null,!1)),u.push(n.o=new cd(s,null,n,!0))}})),a.length){for(u.sort(e),dd(a),dd(u),o=0,s=u.length;o<s;++o)u[o].e=n=!n;for(var h,l,c=a[0];;){for(var f=c,d=!0;f.v;)if((f=f.n)===c)return;h=f.z,r.lineStart();do{if(f.v=f.o.v=!0,f.e){if(d)for(o=0,s=h.length;o<s;++o)r.point((l=h[o])[0],l[1]);else i(f.x,f.n.x,1,r);f=f.n}else{if(d)for(h=f.p.z,o=h.length-1;o>=0;--o)r.point((l=h[o])[0],l[1]);else i(f.x,f.p.x,-1,r);f=f.p}h=(f=f.o).z,d=!d}while(!f.v);r.lineEnd()}}}function dd(t){if(e=t.length){for(var e,n,i=0,r=t[0];++i<e;)r.n=n=t[i],n.p=r,r=n;r.n=n=t[0],n.p=r}}function pd(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function vd(t){for(var e,n,i,r=t.length,o=-1,s=0;++o<r;)s+=t[o].length;for(n=new Array(s);--r>=0;)for(e=(i=t[r]).length;--e>=0;)n[--s]=i[e];return n}kf(),kf(),kf(),rd.invert=rd,1===(Hf=pd).length&&(Wf=Hf,Hf=function(t,e){return pd(Wf(t),e)});var md=1e9,yd=-1e9,wd=kf();function gd(t){return t}kf(),kf(),kf();var bd=1/0,_d=bd,xd=-bd,kd=xd,$d={point:function(t,e){t<bd&&(bd=t),t>xd&&(xd=t),e<_d&&(_d=e),e>kd&&(kd=e)},lineStart:Lf,lineEnd:Lf,polygonStart:Lf,polygonEnd:Lf,result:function(){var t=[[bd,_d],[xd,kd]];return xd=kd=-(_d=bd=1/0),t}};function Sd(t,e,n,i){return function(r,o){var s,a,u,h=e(o),l=r.invert(i[0],i[1]),c=hd(),f=e(c),d=!1,p={point:v,lineStart:y,lineEnd:w,polygonStart:function(){p.point=g,p.lineStart=b,p.lineEnd=_,a=[],s=[]},polygonEnd:function(){p.point=v,p.lineStart=y,p.lineEnd=w,a=vd(a);var t=function(t,e){var n=e[0],i=e[1],r=[Nf(n),-Pf(n),0],o=0,s=0;wd.reset();for(var a=0,u=t.length;a<u;++a)if(l=(h=t[a]).length)for(var h,l,c=h[l-1],f=c[0],d=c[1]/2+Of,p=Nf(d),v=Pf(d),m=0;m<l;++m,f=w,p=b,v=_,c=y){var y=h[m],w=y[0],g=y[1]/2+Of,b=Nf(g),_=Pf(g),x=w-f,k=x>=0?1:-1,$=k*x,S=$>Cf,E=p*b;if(wd.add(Df(E*k*Nf($),v*_+E*Pf($))),o+=S?x+k*If:x,S^f>=n^w>=n){var M=Jf(Qf(c),Qf(y));nd(M);var C=Jf(r,M);nd(C);var A=(S^x>=0?-1:1)*jf(C[2]);(i>A||i===A&&(M[0]||M[1]))&&(s+=S^x>=0?1:-1)}}return(o<-1e-6||o<Mf&&wd<-1e-6)^1&s}(s,l);a.length?(d||(o.polygonStart(),d=!0),fd(a,Md,t,n,o)):t&&(d||(o.polygonStart(),d=!0),o.lineStart(),n(null,null,1,o),o.lineEnd()),d&&(o.polygonEnd(),d=!1),a=s=null},sphere:function(){o.polygonStart(),o.lineStart(),n(null,null,1,o),o.lineEnd(),o.polygonEnd()}};function v(e,n){var i=r(e,n);t(e=i[0],n=i[1])&&o.point(e,n)}function m(t,e){var n=r(t,e);h.point(n[0],n[1])}function y(){p.point=m,h.lineStart()}function w(){p.point=v,h.lineEnd()}function g(t,e){u.push([t,e]);var n=r(t,e);f.point(n[0],n[1])}function b(){f.lineStart(),u=[]}function _(){g(u[0][0],u[0][1]),f.lineEnd();var t,e,n,i,r=f.clean(),h=c.result(),l=h.length;if(u.pop(),s.push(u),u=null,l)if(1&r){if((e=(n=h[0]).length-1)>0){for(d||(o.polygonStart(),d=!0),o.lineStart(),t=0;t<e;++t)o.point((i=n[t])[0],i[1]);o.lineEnd()}}else l>1&&2&r&&h.push(h.pop().concat(h.shift())),a.push(h.filter(Ed))}return p}}function Ed(t){return t.length>1}function Md(t,e){return((t=t.x)[0]<0?t[1]-Af-Mf:Af-t[1])-((e=e.x)[0]<0?e[1]-Af-Mf:Af-e[1])}kf();var Cd=Sd((function(){return!0}),(function(t){var e,n=NaN,i=NaN,r=NaN;return{lineStart:function(){t.lineStart(),e=1},point:function(o,s){var a=o>0?Cf:-Cf,u=Rf(o-n);Rf(u-Cf)<Mf?(t.point(n,i=(i+s)/2>0?Af:-Af),t.point(r,i),t.lineEnd(),t.lineStart(),t.point(a,i),t.point(o,i),e=0):r!==a&&u>=Cf&&(Rf(n-r)<Mf&&(n-=r*Mf),Rf(o-a)<Mf&&(o-=a*Mf),i=function(t,e,n,i){var r,o,s=Nf(t-n);return Rf(s)>Mf?Ff((Nf(e)*(o=Pf(i))*Nf(n)-Nf(i)*(r=Pf(e))*Nf(t))/(r*o*s)):(e+i)/2}(n,i,o,s),t.point(r,i),t.lineEnd(),t.lineStart(),t.point(a,i),e=0),t.point(n=o,i=s),r=a},lineEnd:function(){t.lineEnd(),n=i=NaN},clean:function(){return 2-e}}}),(function(t,e,n,i){var r;if(null==t)r=n*Af,i.point(-Cf,r),i.point(0,r),i.point(Cf,r),i.point(Cf,0),i.point(Cf,-r),i.point(0,-r),i.point(-Cf,-r),i.point(-Cf,0),i.point(-Cf,r);else if(Rf(t[0]-e[0])>Mf){var o=t[0]<e[0]?Cf:-Cf;r=n*o/2,i.point(-o,r),i.point(0,r),i.point(o,r)}else i.point(e[0],e[1])}),[-Cf,-Af]);function Ad(t){return function(e){var n=new Od;for(var i in t)n[i]=t[i];return n.stream=e,n}}function Od(){}function Id(t,e,n){var i=e[1][0]-e[0][0],r=e[1][1]-e[0][1],o=t.clipExtent&&t.clipExtent();t.scale(150).translate([0,0]),null!=o&&t.clipExtent(null),function(t,e){t&&Vf.hasOwnProperty(t.type)?Vf[t.type](t,e):Bf(t,e)}(n,t.stream($d));var s=$d.result(),a=Math.min(i/(s[1][0]-s[0][0]),r/(s[1][1]-s[0][1])),u=+e[0][0]+(i-a*(s[1][0]+s[0][0]))/2,h=+e[0][1]+(r-a*(s[1][1]+s[0][1]))/2;return null!=o&&t.clipExtent(o),t.scale(150*a).translate([u,h])}Od.prototype={constructor:Od,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var Td=Pf(30*zf);function zd(t,e){return+e?function(t,e){function n(i,r,o,s,a,u,h,l,c,f,d,p,v,m){var y=h-i,w=l-r,g=y*y+w*w;if(g>4*e&&v--){var b=s+f,_=a+d,x=u+p,k=Uf(b*b+_*_+x*x),$=jf(x/=k),S=Rf(Rf(x)-1)<Mf||Rf(o-c)<Mf?(o+c)/2:Df(_,b),E=t(S,$),M=E[0],C=E[1],A=M-i,O=C-r,I=w*A-y*O;(I*I/g>e||Rf((y*A+w*O)/g-.5)>.3||s*f+a*d+u*p<Td)&&(n(i,r,o,s,a,u,M,C,S,b/=k,_/=k,x,v,m),m.point(M,C),n(M,C,S,b,_,x,h,l,c,f,d,p,v,m))}}return function(e){var i,r,o,s,a,u,h,l,c,f,d,p,v={point:m,lineStart:y,lineEnd:g,polygonStart:function(){e.polygonStart(),v.lineStart=b},polygonEnd:function(){e.polygonEnd(),v.lineStart=y}};function m(n,i){n=t(n,i),e.point(n[0],n[1])}function y(){l=NaN,v.point=w,e.lineStart()}function w(i,r){var o=Qf([i,r]),s=t(i,r);n(l,c,h,f,d,p,l=s[0],c=s[1],h=i,f=o[0],d=o[1],p=o[2],16,e),e.point(l,c)}function g(){v.point=m,e.lineEnd()}function b(){y(),v.point=_,v.lineEnd=x}function _(t,e){w(i=t,e),r=l,o=c,s=f,a=d,u=p,v.point=w}function x(){n(l,c,h,f,d,p,r,o,i,s,a,u,16,e),v.lineEnd=g,g()}return v}}(t,e):function(t){return Ad({point:function(e,n){e=t(e,n),this.stream.point(e[0],e[1])}})}(t)}var Rd=Ad({point:function(t,e){this.stream.point(t*zf,e*zf)}});function Fd(t){return function(e,n){var i=Pf(e),r=Pf(n),o=t(i*r);return[o*r*Nf(e),o*Nf(n)]}}function Dd(t){return function(e,n){var i=Uf(e*e+n*n),r=t(i),o=Nf(r),s=Pf(r);return[Df(e*o,i*s),jf(i&&n*o/i)]}}Fd((function(t){return Uf(2/(1+t))})).invert=Dd((function(t){return 2*jf(t/2)}));var Pd=Fd((function(t){return(t=qf(t))&&t/Nf(t)}));function Nd(){return(t=Pd,function(t){var e,n,i,r,o,s,a,u,h,l,c=150,f=480,d=250,p=0,v=0,m=0,y=0,w=0,g=null,b=Cd,_=null,x=gd,k=.5,$=zd(M,k);function S(t){return[(t=o(t[0]*zf,t[1]*zf))[0]*c+n,i-t[1]*c]}function E(t){return(t=o.invert((t[0]-n)/c,(i-t[1])/c))&&[t[0]*Tf,t[1]*Tf]}function M(t,r){return[(t=e(t,r))[0]*c+n,i-t[1]*c]}function C(){o=id(r=function(t,e,n){return(t%=If)?e||n?id(sd(t),ad(e,n)):sd(t):e||n?ad(e,n):rd}(m,y,w),e);var t=e(p,v);return n=f-t[0]*c,i=d+t[1]*c,A()}function A(){return h=l=null,S}return S.stream=function(t){return h&&l===t?h:h=Rd(b(r,$(x(l=t))))},S.clipAngle=function(t){return arguments.length?(b=+t?function(t,e){var n=Pf(t),i=n>0,r=Rf(n)>Mf;function o(t,e){return Pf(t)*Pf(e)>n}function s(t,e,i){var r=[1,0,0],o=Jf(Qf(t),Qf(e)),s=Zf(o,o),a=o[0],u=s-a*a;if(!u)return!i&&t;var h=n*s/u,l=-n*a/u,c=Jf(r,o),f=ed(r,h);td(f,ed(o,l));var d=c,p=Zf(f,d),v=Zf(d,d),m=p*p-v*(Zf(f,f)-1);if(!(m<0)){var y=Uf(m),w=ed(d,(-p-y)/v);if(td(w,f),w=Xf(w),!i)return w;var g,b=t[0],_=e[0],x=t[1],k=e[1];_<b&&(g=b,b=_,_=g);var $=_-b,S=Rf($-Cf)<Mf;if(!S&&k<x&&(g=x,x=k,k=g),S||$<Mf?S?x+k>0^w[1]<(Rf(w[0]-b)<Mf?x:k):x<=w[1]&&w[1]<=k:$>Cf^(b<=w[0]&&w[0]<=_)){var E=ed(d,(-p+y)/v);return td(E,f),[w,Xf(E)]}}}function a(e,n){var r=i?t:Cf-t,o=0;return e<-r?o|=1:e>r&&(o|=2),n<-r?o|=4:n>r&&(o|=8),o}return Sd(o,(function(t){var e,n,u,h,l;return{lineStart:function(){h=u=!1,l=1},point:function(c,f){var d,p=[c,f],v=o(c,f),m=i?v?0:a(c,f):v?a(c+(c<0?Cf:-Cf),f):0;if(!e&&(h=u=v)&&t.lineStart(),v!==u&&(!(d=s(e,p))||ld(e,d)||ld(p,d))&&(p[0]+=Mf,p[1]+=Mf,v=o(p[0],p[1])),v!==u)l=0,v?(t.lineStart(),d=s(p,e),t.point(d[0],d[1])):(d=s(e,p),t.point(d[0],d[1]),t.lineEnd()),e=d;else if(r&&e&&i^v){var y;m&n||!(y=s(p,e,!0))||(l=0,i?(t.lineStart(),t.point(y[0][0],y[0][1]),t.point(y[1][0],y[1][1]),t.lineEnd()):(t.point(y[1][0],y[1][1]),t.lineEnd(),t.lineStart(),t.point(y[0][0],y[0][1])))}!v||e&&ld(e,p)||t.point(p[0],p[1]),e=p,u=v,n=m},lineEnd:function(){u&&t.lineEnd(),e=null},clean:function(){return l|(h&&u)<<1}}}),(function(n,i,r,o){!function(t,e,n,i,r,o){if(n){var s=Pf(e),a=Nf(e),u=i*n;null==r?(r=e+i*If,o=e-u/2):(r=ud(s,r),o=ud(s,o),(i>0?r<o:r>o)&&(r+=i*If));for(var h,l=r;i>0?l>o:l<o;l-=u)h=Xf([s,-a*Pf(l),-a*Nf(l)]),t.point(h[0],h[1])}}(o,t,e,r,n,i)}),i?[0,-t]:[-Cf,t-Cf])}(g=t*zf,6*zf):(g=null,Cd),A()):g*Tf},S.clipExtent=function(t){return arguments.length?(x=null==t?(_=s=a=u=null,gd):function(t,e,n,i){function r(r,o){return t<=r&&r<=n&&e<=o&&o<=i}function o(r,o,a,h){var l=0,c=0;if(null==r||(l=s(r,a))!==(c=s(o,a))||u(r,o)<0^a>0)do{h.point(0===l||3===l?t:n,l>1?i:e)}while((l=(l+a+4)%4)!==c);else h.point(o[0],o[1])}function s(i,r){return Rf(i[0]-t)<Mf?r>0?0:3:Rf(i[0]-n)<Mf?r>0?2:1:Rf(i[1]-e)<Mf?r>0?1:0:r>0?3:2}function a(t,e){return u(t.x,e.x)}function u(t,e){var n=s(t,1),i=s(e,1);return n!==i?n-i:0===n?e[1]-t[1]:1===n?t[0]-e[0]:2===n?t[1]-e[1]:e[0]-t[0]}return function(s){var u,h,l,c,f,d,p,v,m,y,w,g=s,b=hd(),_={point:x,lineStart:function(){_.point=k,h&&h.push(l=[]),y=!0,m=!1,p=v=NaN},lineEnd:function(){u&&(k(c,f),d&&m&&b.rejoin(),u.push(b.result())),_.point=x,m&&g.lineEnd()},polygonStart:function(){g=b,u=[],h=[],w=!0},polygonEnd:function(){var e=function(){for(var e=0,n=0,r=h.length;n<r;++n)for(var o,s,a=h[n],u=1,l=a.length,c=a[0],f=c[0],d=c[1];u<l;++u)o=f,s=d,f=(c=a[u])[0],d=c[1],s<=i?d>i&&(f-o)*(i-s)>(d-s)*(t-o)&&++e:d<=i&&(f-o)*(i-s)<(d-s)*(t-o)&&--e;return e}(),n=w&&e,r=(u=vd(u)).length;(n||r)&&(s.polygonStart(),n&&(s.lineStart(),o(null,null,1,s),s.lineEnd()),r&&fd(u,a,e,o,s),s.polygonEnd()),g=s,u=h=l=null}};function x(t,e){r(t,e)&&g.point(t,e)}function k(o,s){var a=r(o,s);if(h&&l.push([o,s]),y)c=o,f=s,d=a,y=!1,a&&(g.lineStart(),g.point(o,s));else if(a&&m)g.point(o,s);else{var u=[p=Math.max(yd,Math.min(md,p)),v=Math.max(yd,Math.min(md,v))],b=[o=Math.max(yd,Math.min(md,o)),s=Math.max(yd,Math.min(md,s))];!function(t,e,n,i,r,o){var s,a=t[0],u=t[1],h=0,l=1,c=e[0]-a,f=e[1]-u;if(s=n-a,c||!(s>0)){if(s/=c,c<0){if(s<h)return;s<l&&(l=s)}else if(c>0){if(s>l)return;s>h&&(h=s)}if(s=r-a,c||!(s<0)){if(s/=c,c<0){if(s>l)return;s>h&&(h=s)}else if(c>0){if(s<h)return;s<l&&(l=s)}if(s=i-u,f||!(s>0)){if(s/=f,f<0){if(s<h)return;s<l&&(l=s)}else if(f>0){if(s>l)return;s>h&&(h=s)}if(s=o-u,f||!(s<0)){if(s/=f,f<0){if(s>l)return;s>h&&(h=s)}else if(f>0){if(s<h)return;s<l&&(l=s)}return h>0&&(t[0]=a+h*c,t[1]=u+h*f),l<1&&(e[0]=a+l*c,e[1]=u+l*f),!0}}}}}(u,b,t,e,n,i)?a&&(g.lineStart(),g.point(o,s),w=!1):(m||(g.lineStart(),g.point(u[0],u[1])),g.point(b[0],b[1]),a||g.lineEnd(),w=!1)}p=o,v=s,m=a}return _}}(_=+t[0][0],s=+t[0][1],a=+t[1][0],u=+t[1][1]),A()):null==_?null:[[_,s],[a,u]]},S.scale=function(t){return arguments.length?(c=+t,C()):c},S.translate=function(t){return arguments.length?(f=+t[0],d=+t[1],C()):[f,d]},S.center=function(t){return arguments.length?(p=t[0]%360*zf,v=t[1]%360*zf,C()):[p*Tf,v*Tf]},S.rotate=function(t){return arguments.length?(m=t[0]%360*zf,y=t[1]%360*zf,w=t.length>2?t[2]%360*zf:0,C()):[m*Tf,y*Tf,w*Tf]},S.precision=function(t){return arguments.length?($=zd(M,k=t*t),A()):Uf(k)},S.fitExtent=function(t,e){return Id(S,t,e)},S.fitSize=function(t,e){return function(t,e,n){return Id(t,[[0,0],e],n)}(S,t,e)},function(){return e=t.apply(this,arguments),S.invert=e.invert&&E,C()}}((function(){return t}))()).scale(79.4188).clipAngle(179.999);var t}function Ud(t,e){return[t,e]}Pd.invert=Dd((function(t){return t})),Ud.invert=Ud;var{BufferOp:qd,GeoJSONReader:jd,GeoJSONWriter:Ld}=xf;function Bd(t,e,n){var i=(n=n||{}).units||"kilometers",r=n.steps||8;if(!t)throw new Error("geojson is required");if("object"!=typeof n)throw new Error("options must be an object");if("number"!=typeof r)throw new Error("steps must be an number");if(void 0===e)throw new Error("radius is required");if(r<=0)throw new Error("steps must be greater than 0");var o=[];switch(t.type){case"GeometryCollection":return mf(t,(function(t){var n=Hd(t,e,i,r);n&&o.push(n)})),lf(o);case"FeatureCollection":return vf(t,(function(t){var n=Hd(t,e,i,r);n&&vf(n,(function(t){t&&o.push(t)}))})),lf(o)}return Hd(t,e,i,r)}function Hd(t,e,n,i){var r=t.properties||{},o="Feature"===t.type?t.geometry:t;if("GeometryCollection"===o.type){var s=[];return mf(t,(function(t){var r=Hd(t,e,n,i);r&&s.push(r)})),lf(s)}var a=function(t){var e=function(t,e={}){const n=function(t,e={}){if(null!=t.bbox&&!0!==e.recompute)return t.bbox;const n=[1/0,1/0,-1/0,-1/0];return pf(t,(t=>{n[0]>t[0]&&(n[0]=t[0]),n[1]>t[1]&&(n[1]=t[1]),n[2]<t[0]&&(n[2]=t[0]),n[3]<t[1]&&(n[3]=t[1])})),n}(t);return function(t,e,n={}){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!df(t[0])||!df(t[1]))throw new Error("coordinates must contain numbers");return hf({type:"Point",coordinates:t},e,n)}([(n[0]+n[2])/2,(n[1]+n[3])/2],e.properties,e)}(t).geometry.coordinates,n=[-e[0],-e[1]];return Nd().rotate(n).scale(af)}(o),u={type:o.type,coordinates:Vd(o.coordinates,a)},h=(new jd).read(u),l=cf(function(t,e="kilometers"){const n=uf[e];if(!n)throw new Error(e+" units is invalid");return t/n}(e,n),"meters"),c=qd.bufferOp(h,l,i);if(!Wd((c=(new Ld).write(c)).coordinates))return hf({type:c.type,coordinates:Gd(c.coordinates,a)},r)}function Wd(t){return Array.isArray(t[0])?Wd(t[0]):isNaN(t[0])}function Vd(t,e){return"object"!=typeof t[0]?e(t):t.map((function(t){return Vd(t,e)}))}function Gd(t,e){return"object"!=typeof t[0]?e.invert(t):t.map((function(t){return Gd(t,e)}))}var Yd,Kd,Xd=Bd;class Qd extends i.Event{zc="https://et-api.amap.com";us={viewer:void 0,adCodes:[],areas:[],clientKey:"",clientSecret:"",time:(new Date).getTime(),style:{slightColor:"#ffff00",severeColor:"#ff0000",slightWidth:5,severeWidth:5}};Rc={};Fc=[];Dc=[];Pc;Nc;constructor(t){super(),this.us.viewer=t.viewer||this.us.viewer,this.us.time=t.time||this.us.time,this.us.adCodes=t.adCodes||this.us.adCodes,this.us.areas=t.areas||this.us.areas,this.us.clientKey=t.clientKey||this.us.clientKey,this.us.clientSecret=t.clientSecret||this.us.clientSecret,this.us.style=Object.assign(this.us.style,t.style),this.us.viewer&&this.Uc()}getLines(){return{severe:this.Pc,slight:this.Nc}}destroy(){this.Pc?.destroy(),this.Nc?.destroy(),this.Fc=[],this.Dc=[],this.Rc=[]}show(){this.Pc&&(this.Pc.show=!0),this.Nc&&(this.Nc.show=!0)}hide(){this.Pc&&(this.Pc.show=!1),this.Nc&&(this.Nc.show=!1)}update(){this.Uc()}async Uc(){this.Rc=await this.qc(),0!==this.Rc.length&&(this.jc(),this.Lc())}Bc(){if(!this.us.viewer)return;const t=this.us.viewer;t.scene.preRender.addEventListener((()=>{var e=new i.EllipsoidGeodesic;let n=t.scene,r=n.canvas.clientWidth,o=n.canvas.clientHeight,s=n.camera.getPickRay(new i.Cartesian2(0,o/2)),a=n.camera.getPickRay(new i.Cartesian2(r,o/2));if(s&&a){let t=n.globe,i=t.pick(s,n),r=t.pick(a,n);if(!i)return;if(!r)return;let o=t.ellipsoid.cartesianToCartographic(i),u=t.ellipsoid.cartesianToCartographic(r);e.setEndPoints(o,u),e.surfaceDistance,this.Pc}}))}Lc(){this.us.viewer&&(0!==this.Fc.length&&(this.Pc=this.Hc(this.Fc,this.us.style.severeColor,this.us.style.severeWidth),this.us.viewer.scene.primitives.add(this.Pc)),0!==this.Dc.length&&(this.Nc=this.Hc(this.Dc,this.us.style.slightColor,this.us.style.slightWidth),this.us.viewer.scene.primitives.add(this.Nc)),this.raiseEvent("loaded"))}Hc(t,e,n){const r=[];return t.forEach((t=>{const o=Xd({type:"LineString",coordinates:t.lngLats},n/2,{units:"meters"}),s=o?.geometry.coordinates;s&&r.push(new i.GeometryInstance({geometry:new i.PolygonGeometry({polygonHierarchy:new i.PolygonHierarchy(i.Cartesian3.fromDegreesArray(s.flat(3)))}),attributes:{color:i.ColorGeometryInstanceAttribute.fromColor(i.Color.fromCssColorString(e))}}))})),new i.GroundPrimitive({geometryInstances:r,asynchronous:!1})}Wc(t,e,n){const r=[];t.forEach((t=>{const e=i.Cartesian3.fromDegreesArray(t.lngLats.flat()),o=new i.GroundPolylineGeometry({positions:e,width:n});o&&r.push(new i.GeometryInstance({geometry:o}))}));const o=new i.PolylineMaterialAppearance({translucent:!1});return o.material=new i.Material({fabric:{type:"Color",uniforms:{color:i.Color.fromCssColorString(e)}}}),new i.GroundPolylinePrimitive({geometryInstances:r,appearance:o,asynchronous:!1})}jc(){this.Rc.forEach((t=>{t.linkList.forEach((t=>{const e=t.lngLats.split(";").map((t=>{const e=t.split(",");return[+e[0],+e[1]]}));4===t.state?this.Fc.push({roadName:t.roadName,roadType:t.roadType,lngLats:e}):this.Dc.push({roadName:t.roadName,roadType:t.roadType,lngLats:e})}))}))}async qc(){const t=Math.round((new Date).getTime()/1e3),e=`${this.us.adCodes.join("")}${this.us.clientKey}${t}`;let n=await async function(t,e){const n=new TextEncoder,i=n.encode(e),r=n.encode(t),o=await crypto.subtle.importKey("raw",i,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),s=await crypto.subtle.sign("HMAC",o,r);return Array.from(new Uint8Array(s)).map((t=>t.toString(16).padStart(2,"0"))).join("")}(e,this.us.clientSecret);const i=await fetch(`${this.zc}/congestion/history?clientKey=${this.us.clientKey}&timestamp=${t}&digest=${n.toString()}&adCodes=${this.us.adCodes.join()}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adCodes:this.us.adCodes,areas:this.us.areas,startTime:this.us.time/1e3,endTime:this.us.time/1e3+3600,pageSize:9999,queryList:[{duration:"4",roadType:"0",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"1",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"2",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"3",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"4",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"5",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"6",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"7",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"8",distance:"200",congestRate:"0",congestType:"0"},{duration:"4",roadType:"9",distance:"200",congestRate:"0",congestType:"0"}]})}),r=await i.json();if(0!==r.code)throw new Error(":",r.message);return r.data.list}}class Zd extends i.Entity{us;Vc;Gc=0;Yc=0;Kc;Xc;Qc;constructor(t){t.eyeOffset=t.eyeOffset||[0,0,0],t.controlOptions=t.controlOptions||{speed:10,steeringSpeed:15};const e=i.Cartesian3.fromDegrees(t.position[0],t.position[1],t.position[2]),n=new i.HeadingPitchRoll(i.Math.toRadians(t.heading-90),0,0);super({position:e,orientation:i.Transforms.headingPitchRollQuaternion(e,n),model:{uri:t.uri,scale:t.scale||1,runAnimations:t.runAnimations}}),this.us=t}Zc(){const t=i.Cartesian3.fromDegrees(-123.0744619,44.0503706,5e3),e=new i.HeadingPitchRoll,n=i.Transforms.localFrameToFixedFrameGenerator("north","west");i.Transforms.headingPitchRollToFixedFrame(t,e,i.Ellipsoid.WGS84,n)}static Jc=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyA","KeyS","KeyD","KeyW"];static tf;static ef=[];static nf=0;static if(t){const e=-1!==Zd.Jc.indexOf(t.code);e&&-1==Zd.ef.indexOf(t.code)&&Zd.ef.push(t.code),e&&!Zd.nf&&(Zd.nf=requestAnimationFrame(Zd.rf),Zd.tf&&(Zd.tf.Xc=(new Date).getTime()))}static sf(t){const e=-1!==Zd.Jc.indexOf(t.code),n=Zd.ef.indexOf(t.code);e&&-1!==n&&Zd.ef.splice(n,1)}static rf(){Zd.nf=0;const t=Zd.tf;if(t)if(Zd.ef.length){const e=(new Date).getTime();if(t.Xc&&e-t.Xc){const n=(e-t.Xc)/1e3/3600*1e3*t.us.controlOptions.speed,r=(e-t.Xc)/1e3*t.us.controlOptions.steeringSpeed;if(t.Gc<=1){t.model.runAnimations=!0;let e=0;switch(Zd.ef.sort().join(",")){case"ArrowUp":case"KeyW":e=0;break;case"ArrowDown":case"KeyS":e=180;break;case"ArrowLeft":case"KeyA":e=-90;break;case"ArrowRight":case"KeyD":e=90;break;case"ArrowDown,ArrowLeft":case"KeyA,KeyS":e=-135;break;case"ArrowDown,ArrowRight":case"KeyD,KeyS":e=135;break;case"ArrowLeft,ArrowUp":case"KeyA,KeyW":e=-45;break;case"ArrowRight,ArrowUp":case"KeyD,KeyW":e=45}const r=180*t.us.viewer.camera.heading/Math.PI+e,o=new i.HeadingPitchRoll(i.Math.toRadians(r-90),0,0);t.us.heading=r;const s=Math.sin(r*Math.PI/180)*n,a=Math.cos(r*Math.PI/180)*n,u=zc(new i.Cartesian3(s,a,0),t.us.position),h=i.Cartographic.fromCartesian(u),l=i.Math.toDegrees(h.longitude),c=i.Math.toDegrees(h.latitude);t.us.position=[l,c,t.us.position[2]];const f=i.Cartesian3.fromDegrees(l,c,t.us.position[2]);t.position=f;const d=i.Transforms.headingPitchRollQuaternion(f,o);t.orientation=d}else{t.model.runAnimations=!1;let e=0,o=0;switch(Zd.ef.sort().join(",")){case"ArrowUp":case"KeyW":o=1;break;case"ArrowDown":case"KeyS":o=-1;break;case"ArrowLeft":case"KeyA":e=-1;break;case"ArrowRight":case"KeyD":e=1;break;case"ArrowDown,ArrowLeft":case"KeyA,KeyS":e=1,o=-1;break;case"ArrowDown,ArrowRight":case"KeyD,KeyS":e=-1,o=-1;break;case"ArrowLeft,ArrowUp":case"KeyA,KeyW":e=-1,o=1;break;case"ArrowRight,ArrowUp":case"KeyD,KeyW":e=1,o=1}const s=180*t.us.viewer.camera.heading/Math.PI+r*e,a=new i.HeadingPitchRoll(i.Math.toRadians(s-90),0,0);t.us.heading=s;const u=Math.sin(s*Math.PI/180)*n*o,h=Math.cos(s*Math.PI/180)*n*o,l=zc(new i.Cartesian3(u,h,0),t.us.position),c=i.Cartographic.fromCartesian(l),f=i.Math.toDegrees(c.longitude),d=i.Math.toDegrees(c.latitude);t.us.position=[f,d,t.us.position[2]];const p=i.Cartesian3.fromDegrees(f,d,t.us.position[2]);t.position=p;const v=i.Transforms.headingPitchRollQuaternion(p,a);t.orientation=v;const m=zc(new i.Cartesian3(t.us.eyeOffset[0],t.us.eyeOffset[1],t.us.eyeOffset[2]),t.us.position);t.us.viewer.camera.setView({destination:m,orientation:{heading:i.Math.toRadians(t.us.heading),pitch:t.us.viewer.camera.pitch}})}}Zd.nf=requestAnimationFrame(Zd.rf),t.Xc=e}else t.model.runAnimations=!1,t.Xc=void 0}af(){this.getPrimitive().hf.uf.forEach((t=>{t.runtimeChannels.forEach((t=>{t.animate(0)}))}))}getPrimitive(){if(this.Vc)return this.Vc;{const t=this.us.viewer.scene.primitives.length;for(let e=0;e<t;e+=1){const t=this.us.viewer.scene.primitives.get(e);if(t.id==this)return this.Vc=t,t}}}startControlModel(t=0){this.Yc||Zd.tf!==this&&(Zd.tf&&Zd.tf.stopControlModel(),Zd.tf=this,document.addEventListener("keydown",Zd.if),document.addEventListener("keyup",Zd.sf),Zd.nf=requestAnimationFrame(Zd.rf),this.switchTrackingMode(t))}setControlOptions(t){this.us.controlOptions=t}switchTrackingMode(e){Zd.tf==this&&(this.us.viewer.trackedEntity=void 0,this.Gc=e,0==e?(this.viewFrom=void 0,this.show=!0):1==e?(this.show=!0,this.us.viewFrom?this.viewFrom=new t.Cartesian3(this.us.viewFrom[0],this.us.viewFrom[1],this.us.viewFrom[2]):this.viewFrom=void 0,this.us.viewer.trackedEntity=this):(this.us.viewer.trackedEntity=this,this.show=!1,requestAnimationFrame((()=>{const t=zc(new i.Cartesian3(this.us.eyeOffset[0],this.us.eyeOffset[1],this.us.eyeOffset[2]),this.us.position);this.us.viewer.camera.setView({destination:t,orientation:{heading:i.Math.toRadians(this.us.heading),pitch:0}})}))))}stopControlModel(){document.removeEventListener("keydown",Zd.if),document.removeEventListener("keyup",Zd.sf),Zd.nf&&(cancelAnimationFrame(Zd.nf),Zd.nf=0),Zd.tf=void 0,Zd.ef=[],this.Gc=0,this.Xc=void 0}moveAlong(e,n,r,o,s,a){if(Zd.tf!==this&&this.stopControlModel(),o=o||e.lf(),this.Yc)return;n&&(this.us.viewFrom&&(this.viewFrom=new t.Cartesian3(this.us.viewFrom[0],this.us.viewFrom[1],this.us.viewFrom[2])),this.us.viewer.trackedEntity=this);const u=this;u.position=e.cf.getValue(o);let h=(new Date).getTime(),l=-1;this.Kc=o;const c=()=>{let n=(new Date).getTime()-h;const d=i.JulianDate.addSeconds(o,n/1e3,new i.JulianDate);this.Kc=d;const p=e.cf.getValue(d);u.position=p;const v=e.ff.getValue(d);if(u.orientation=v,p&&this.Qc){const e=(this.Qc?.steeringSpeed||30)*Math.PI/180,n=i.Matrix3.fromQuaternion(v),r=i.Matrix4.fromRotation(n),o=new t.Cartesian3(-this.Qc.range*Math.cos(this.Qc.pitch*Math.PI/180),0,-this.Qc.range*Math.sin(this.Qc.pitch*Math.PI/180));var m=new i.Cartesian4(o.x,o.y,o.z,1),y=i.Matrix4.multiplyByVector(r,m,new i.Cartesian4),w=new i.Cartesian3(y.x,y.y,y.z);const s=t.Cartesian3.add(p,w,new t.Cartesian3);let a=this.us.viewer.camera.pitch,u=this.us.viewer.camera.heading;const h=Rc(s),l=Rc(p),c=Math.atan2(l.lng-h.lng,l.lat-h.lat),d=this.Qc.pitch*Math.PI/180;let g=u,b=a;const _=(new Date).getTime(),x=(_-f)/1e3*e;f=_,Math.abs(d-a)<x?b=d:d>a?b+=x:b-=x;const k=Fc(u,c);Math.abs(k)<x?g=c:k>0?g+=x:g-=x,this.us.viewer.camera.lookAt(p,new i.HeadingPitchRange(g,b,this.Qc.range))}if(n>=e.df)r?(h=(new Date).getTime(),this.Yc=requestAnimationFrame(c)):(this.Kc=void 0,this.Yc=0),l!==e.pf.length-1&&a?.call(u,{index:e.pf.length-1}),s?.call(u,{index:e.pf.length-1});else{if(a){const t=e.vf(d);-1!==t&&t!==l&&(l=t,a?.call(u,{index:t}))}this.Yc=requestAnimationFrame(c)}};let f=(new Date).getTime();this.Yc=requestAnimationFrame(c)}follow(t){this.Qc=t?{pitch:-90,range:100,steeringSpeed:30,...t}:void 0}stopFollow(){this.Qc=void 0}stopMoveAlong(){if(this.Yc)return cancelAnimationFrame(this.Yc),this.Yc=0,this.us.viewer.trackedEntity==this&&(this.us.viewer.trackedEntity=void 0),this.Kc}}class Jd{cf;pf=[];df;mf;ff;constructor(t){this.mf=t;const e=new i.SampledPositionProperty;this.df=t[t.length-1].time.getTime()-t[0].time.getTime();for(let n=0,r=t.length;n<r;n+=1){const r=t[n],o=i.JulianDate.fromDate(r.time);this.pf.push(o);const s=i.Cartesian3.fromDegrees(r.position[0],r.position[1],r.position[2]);e.addSample(o,s)}this.ff=new i.VelocityOrientationProperty(e),this.cf=e}lf(){return this.pf[0]}vf(t){for(let e=0;e<this.pf.length;e+=1)if(i.JulianDate.equalsEpsilon(this.pf[e],t,.1))return e;return-1}yf(t){return this.mf[t]}}function tp(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if("Feature"===t.type&&null!==t.geometry&&"Point"===t.geometry.type)return[...t.geometry.coordinates];if("Point"===t.type)return[...t.coordinates]}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return[...t];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function ep(t,e,n={}){var i=tp(t),r=tp(e),o=ff(r[1]-i[1]),s=ff(r[0]-i[0]),a=ff(i[1]),u=ff(r[1]),h=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(a)*Math.cos(u);return cf(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),n.units)}function np(t,e={}){return function(t){var n=0;return function(t){!function(t,e){mf(t,(function(t,n,i,r,o){var s,a=null===t?null:t.type;switch(a){case null:case"Point":case"LineString":case"Polygon":return!1!==e(hf(t,i,{bbox:r,id:o}),n,0)&&void 0}switch(a){case"MultiPoint":s="Point";break;case"MultiLineString":s="LineString";break;case"MultiPolygon":s="Polygon"}for(var u=0;u<t.coordinates.length;u++){var h=t.coordinates[u];if(!1===e(hf({type:s,coordinates:h},i),n,u))return!1}}))}(t,(function(t,i,r){if(t.geometry){var o=t.geometry.type;if("Point"!==o&&"MultiPoint"!==o){var s,a=0,u=0,h=0;return!1!==pf(t,(function(r,o,l,c,f){if(void 0===s||i>a||c>u||f>h)return s=r,a=i,u=c,h=f,void 0;var d=function(t,e,n={}){if(t.length<2)throw new Error("coordinates must be an array of two or more positions");return hf({type:"LineString",coordinates:t},e,n)}([s,r],t.properties);if(!1===function(t){n=((t,n)=>{const i=n.geometry.coordinates;return t+ep(i[0],i[1],e)})(n,t)}(d))return!1;s=r}))&&void 0}}}))}(t),n}(t)}class ip{Ln;wf;gf;bf;_f=0;Qn={};xf=this.kf.bind(this);$f=this.Sf.bind(this);Ef=this.Mf.bind(this);Cf="";Af=this.Of.bind(this);If=this.Tf.bind(this);zf=this.Rf.bind(this);Ff=!1;constructor(t){this.Ln=t.viewer,this.wf=t.line,this.gf=t.moveSpeed,this.bf=0,this.Uc()}lock(){var t=this.Ln.scene.screenSpaceCameraController;this.Qn={enableTranslate:t.enableTranslate,enableZoom:t.enableZoom,enableRotate:t.enableRotate,enableTilt:t.enableTilt,enableLook:t.enableLook,inertiaSpin:t.inertiaSpin,inertiaTranslate:t.inertiaTranslate,inertiaZoom:t.inertiaZoom},t.enableTranslate=!1,t.enableRotate=!1,t.enableZoom=!1,t.enableLook=!1,t.enableTilt=!1,t.inertiaSpin=0,t.inertiaTranslate=0,t.inertiaZoom=0,this.Df()}unlock(){var t=this.Ln.scene.screenSpaceCameraController;t.enableTranslate=this.Qn.enableTranslate,t.enableZoom=this.Qn.enableZoom,t.enableRotate=this.Qn.enableRotate,t.enableTilt=this.Qn.enableTilt,t.enableLook=this.Qn.enableLook,t.inertiaSpin=this.Qn.inertiaSpin,t.inertiaTranslate=this.Qn.inertiaTranslate,t.inertiaZoom=this.Qn.inertiaZoom}destroy(){this.unlock(),document.removeEventListener("keydown",this.xf),document.removeEventListener("keyup",this.$f);let t=new i.ScreenSpaceEventHandler(this.Ln.scene.canvas);t.removeInputAction(i.ScreenSpaceEventType.MIDDLE_DOWN),t.removeInputAction(i.ScreenSpaceEventType.MOUSE_MOVE),t.removeInputAction(i.ScreenSpaceEventType.MIDDLE_UP)}move(t){"forward"===t?(this.bf+=this.gf,this.bf=Math.min(this.bf,this._f)):(this.bf-=this.gf,this.bf=Math.max(this.bf,0)),this.Pf()}Uc(){this._f=1e3*np({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:this.wf}},{units:"kilometers"}),document.addEventListener("keydown",this.xf),document.addEventListener("keyup",this.$f),this.lock(),this.Mf()}Df(){let t=new i.ScreenSpaceEventHandler(this.Ln.scene.canvas);t.setInputAction(this.Af,i.ScreenSpaceEventType.MIDDLE_DOWN),t.setInputAction(this.If,i.ScreenSpaceEventType.MOUSE_MOVE),t.setInputAction(this.zf,i.ScreenSpaceEventType.MIDDLE_UP)}Of(t){this.Ff=!0}Tf(t){if(!this.Ff)return;const e=t.endPosition.x-t.startPosition.x,n=t.endPosition.y-t.startPosition.y;this.Ln.camera.setView({destination:this.Ln.camera.position,orientation:{heading:this.Ln.camera.heading-e/1e3,pitch:this.Ln.camera.pitch+n/1e3,roll:0}})}Rf(t){this.Ff=!1}Pf(){const t=this.Nf(this.wf,this.bf);if(t){const e=i.Cartesian3.fromDegrees(t[0],t[1],t[2]);this.Ln.camera.setView({destination:e,orientation:{heading:this.Ln.camera.heading,pitch:this.Ln.camera.pitch,roll:0}})}}kf(t){"KeyW"===t.code?this.Cf="W":"KeyS"===t.code&&(this.Cf="S")}Sf(t){"KeyW"!==t.code&&"KeyS"!==t.code||(this.Cf="")}Mf(){requestAnimationFrame(this.Ef),this.Cf&&("W"===this.Cf&&(this.bf+=this.gf,this.bf=Math.min(this.bf,this._f)),"S"===this.Cf&&(this.bf-=this.gf,this.bf=Math.max(this.bf,0)),this.Pf())}Nf(t,e){let n=0;for(let i=1;i<t.length;i++){const r=t[i-1],o=t[i],s=1e3*ep({type:"Point",coordinates:r},{type:"Point",coordinates:o},{units:"kilometers"});if(n<=e&&n+s>e){const t=(e-n)/s;return[r[0]+(o[0]-r[0])*t,r[1]+(o[1]-r[1])*t,r[2]+(o[2]-r[2])*t]}n+=s}}}class rp{Ln;us={viewer:void 0,moveRate:1,rotateRate:1};Uf=!1;qf={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1,moveUp:!1,moveDown:!1,lookUp:!1,lookDown:!1,lookLeft:!1,lookRight:!1,twistLeft:!1,twistRight:!1,zoomIn:!1,zoomOut:!1};jf=this.if.bind(this);Lf=this.sf.bind(this);Bf=this.Hf.bind(this);constructor(t){t.viewer&&(this.Ln=t.viewer,this.us=Object.assign(this.us,t),this.Wf())}destroy(){const t=this.Ln;t&&(t.clock.onTick.removeEventListener(this.Bf),document.removeEventListener("keydown",this.jf,!1),document.removeEventListener("keyup",this.Lf,!1),t.scene.screenSpaceCameraController.enableRotate=!0,t.scene.screenSpaceCameraController.enableTranslate=!0,t.scene.screenSpaceCameraController.enableZoom=!0,t.scene.screenSpaceCameraController.enableTilt=!0,t.scene.screenSpaceCameraController.enableLook=!0)}Wf(){this.Ln&&(document.addEventListener("keydown",this.jf,!1),document.addEventListener("keyup",this.Lf,!1),this.Ln.clock.onTick.addEventListener(this.Bf),this.Vf())}Gf(t){switch(t){case 87:return"moveForward";case 83:return"moveBackward";case 68:return"moveRight";case 65:return"moveLeft";case 81:return"moveUp";case 69:return"moveDown";case 38:return"lookUp";case 40:return"lookDown";case 37:return"lookLeft";case 39:return"lookRight";case 96:return"twistLeft";case 110:return"twistRight";case 107:return"zoomIn";case 109:return"zoomOut";default:return}}if(t){let e=this.Gf(t.keyCode);void 0!==e&&(this.qf[e]=!0)}sf(t){let e=this.Gf(t.keyCode);void 0!==e&&(this.qf[e]=!1)}Hf(){if(!this.Ln)return;let t=this.Ln.camera,e=this.Ln.scene.globe.ellipsoid.cartesianToCartographic(t.position).height,n=e/40*this.us.moveRate;const i=this.qf;i.moveForward&&t.moveForward(n),i.moveBackward&&t.moveBackward(n),i.moveLeft&&t.moveLeft(n),i.moveRight&&t.moveRight(n),i.moveUp&&t.moveUp(n),i.moveDown&&t.moveDown(n),i.lookUp&&t.lookUp(),i.lookDown&&t.lookDown(),i.lookLeft&&t.lookLeft(),i.lookRight&&t.lookRight(),i.twistLeft&&t.twistLeft(),i.twistRight&&t.twistRight(),i.zoomIn&&t.zoomIn(e/2),i.zoomOut&&t.zoomOut(e/2)}Vf(){if(!this.Ln)return;const t=this.Ln;t.scene.screenSpaceCameraController.enableRotate=!1,t.scene.screenSpaceCameraController.enableTranslate=!1,t.scene.screenSpaceCameraController.enableZoom=!1,t.scene.screenSpaceCameraController.enableTilt=!1,t.scene.screenSpaceCameraController.enableLook=!1,t.screenSpaceEventHandler.setInputAction(this.Yf,i.ScreenSpaceEventType.LEFT_DOWN),t.screenSpaceEventHandler.setInputAction(this.Kf,i.ScreenSpaceEventType.MOUSE_MOVE),t.screenSpaceEventHandler.setInputAction(this.Xf,i.ScreenSpaceEventType.LEFT_UP)}Yf=()=>{this.Uf=!0};Xf=()=>{this.Uf=!1};Kf=t=>{if(this.Ln&&this.Uf){const{startPosition:e,endPosition:n}=t,i=(n.x-e.x)/100*this.us.rotateRate,r=-(n.y-e.y)/100*this.us.rotateRate;this.Ln.camera.setView({orientation:{heading:this.Ln.camera.heading+i,pitch:this.Ln.camera.pitch+r,roll:this.Ln.camera.roll}})}}}class op{static runningAnimation;us;status=exports.CameraAnimationStatus.stop;Qf;Zf=0;Jf;td=-1;constructor(t){this.us=t}start(t){op.runningAnimation!==this&&op.runningAnimation?.stop();const e=this.us.path;if(t=t||e.lf(),this.status==exports.CameraAnimationStatus.running)return;const n=this.us.viewer,i=e.cf.getValue(t),r=e.ed.getValue(t);n.camera.setView({destination:i,orientation:{heading:r.x,pitch:r.y,roll:r.z}}),this.Jf=(new Date).getTime(),this.td=0,this.Qf=t,this.status=exports.CameraAnimationStatus.running,this.Zf=requestAnimationFrame(this.Zc)}Zc=()=>{const t=this.us.path,e=(new Date).getTime();let n=e-this.Jf,r=i.JulianDate.addSeconds(this.Qf,n/1e3,new i.JulianDate);this.Qf=r;const o=this.us.viewer;if(r>=t.nd())this.us.repeat?(this.Jf=e,this.Qf=t.lf(),r=this.Qf,this.Zf=requestAnimationFrame(this.Zc)):(r=t.nd(),this.Qf=void 0,this.Zf=0),this.td!==t.pf.length-1&&this.us.onReachKeyNode?.call(this,{index:t.pf.length-1}),this.us.onEnd?.call(this,{index:t.pf.length-1});else{if(this.us.onReachKeyNode){const e=t.vf(r);-1!==e&&e!==this.td&&(this.td=e,this.us.onReachKeyNode?.call(this,{index:e}))}this.Jf=e,this.Zf=requestAnimationFrame(this.Zc)}const s=t.cf.getValue(r),a=t.ed.getValue(r);o.camera.setView({destination:s,orientation:{heading:a.x,pitch:a.y,roll:a.z}})};stop(){if(this.status===exports.CameraAnimationStatus.running)return this.Zf&&cancelAnimationFrame(this.Zf),this.status=exports.CameraAnimationStatus.stop,this.Qf}pause(){if(this.status===exports.CameraAnimationStatus.running)return this.Zf&&cancelAnimationFrame(this.Zf),this.status=exports.CameraAnimationStatus.paused,this.Qf}resume(t){this.status==exports.CameraAnimationStatus.paused&&(this.status=exports.CameraAnimationStatus.running,this.Qf=t,this.Jf=(new Date).getTime(),this.Zf=requestAnimationFrame(this.Zc))}}class sp{cf;ed;pf=[];mf;constructor(t,e,n){let r;r=t[0].pos?t:t.map((t=>({pos:t}))),e&&n&&this.rd(r,e,n),this.mf=r;const o=new i.SampledPositionProperty,s=new i.SampledProperty(i.Cartesian3);let a;for(let t=0,e=r.length;t<e;t+=1){const e=r[t],n=i.JulianDate.fromDate(e.time);this.pf.push(n);const u=i.Cartesian3.fromDegrees(e.pos.lng,e.pos.lat,e.pos.height);o.addSample(n,u);let h=i.Math.toRadians(e.pos.heading);const l=2*Math.PI;h=(h%l+l)%l,a&&(h=a+Fc(a,h)),a=h;const c=new i.Cartesian3(a,i.Math.toRadians(e.pos.pitch),i.Math.toRadians(e.pos.roll));s.addSample(n,c)}this.cf=o,this.ed=s}rd(e,n,i){let r=(new Date).getTime();e.forEach(((o,s)=>{let a=o;if(s>0){const o=t.Cartesian3.distance(t.Cartesian3.fromDegrees(a.pos.lng,a.pos.lat,a.pos.height),t.Cartesian3.fromDegrees(e[s-1].pos.lng,e[s-1].pos.lat,e[s-1].pos.height)),u=180*Fc(e[s-1].pos.heading,a.pos.heading)/Math.PI;r+=1e3*Math.round(Math.max(o/n,Math.abs(u)/i,Math.abs(a.pos.pitch-e[s-1].pos.pitch)/i))}e[s].time=new Date(r)}))}lf(){return this.pf[0]}nd(){return this.pf[this.pf.length-1]}vf(t){for(let e=0;e<this.pf.length;e+=1)if(i.JulianDate.equalsEpsilon(this.pf[e],t,.1))return e;return-1}yf(t){return this.mf[t]}}exports.CameraAnimationStatus=void 0,(Yd=exports.CameraAnimationStatus||(exports.CameraAnimationStatus={}))[Yd.stop=0]="stop",Yd[Yd.running=1]="running",Yd[Yd.paused=2]="paused";class ap{us;qs=new up;constructor(t){this.us=t,this.od()}od(){const t=this.us.viewer.scene.context,e=i.ShaderProgram.fromCache({context:t,vertexShaderSource:"#version 300 es\nprecision highp int;precision highp float;in vec3 position;uniform mat4 u_vp2;void main(){gl_Position=u_vp2*vec4(position,1.0f);}",fragmentShaderSource:"#version 300 es\nprecision highp float;void main(){out_FragColor=vec4(1,0,0,0.3);}",attributeLocations:{position:0}}),n={enabled:!0,equationRgb:i.BlendEquation.ADD,equationAlpha:i.BlendEquation.ADD,functionSourceRgb:i.BlendFunction.SOURCE_ALPHA,functionDestinationRgb:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:i.BlendFunction.ONE,functionDestinationAlpha:i.BlendFunction.ONE_MINUS_SOURCE_ALPHA},r=i.RenderState.fromCache({depthTest:{enabled:!0},blending:n,depthMask:!0,colorMask:{red:!1,green:!1,blue:!1,alpha:!1}}),o=i.Cartesian3.fromDegrees(this.us.enuCenter[0],this.us.enuCenter[1],this.us.enuCenter[2]),s={u_vp2:()=>{let t=this.us.viewer.camera.frustum.projectionMatrix;const e=i.Transforms.eastNorthUpToFixedFrame(o);var n=i.Matrix4.multiply(this.us.viewer.camera.viewMatrix,e,new i.Matrix4);return i.Matrix4.multiply(t,n,new i.Matrix4)}},a=new i.VertexArray({name:"glbDepth",context:t,attributes:[{index:0,vertexBuffer:i.Buffer.createVertexBuffer({usage:i.BufferUsage.STATIC_DRAW,typedArray:new Float32Array(this.us.vertices),context:t}),componentsPerAttribute:3,componentDatatype:i.ComponentDatatype.FLOAT}],indexBuffer:i.Buffer.createIndexBuffer({context:t,typedArray:new Uint32Array(this.us.faces),usage:i.BufferUsage.STATIC_DRAW,indexDatatype:i.IndexDatatype.UNSIGNED_INT})}),u=new i.DrawCommand({vertexArray:a,shaderProgram:e,uniformMap:s,renderState:r,pass:i.Pass.OPAQUE,count:this.us.faces.length});this.qs.Ze=u,this.us.viewer.scene.primitives.add(this.qs)}}class up{Ze;rn=!0;ve=!1;constructor(){}update(t){this.ve||this.rn&&t.commandList.push(this.Ze)}isDestroyed(){return this.ve}show(){0==this.rn&&(this.rn=!0)}hide(){this.rn&&(this.rn=!1)}destroy(){this.ve=!0,this.Ze.vertexArray.getAttribute(1).vertexBuffer.destroy(),this.Ze.vertexArray.ln=[],this.Ze.vertexArray.destroy()}}class hp extends i.Event{us={viewer:void 0,uri:"",adcode:"110000",bounds:[-90,-180,180,90],startTime:"20240901102940",endTime:"20240908102940",meshUri:"",meshEnuCenter:[120.14099999999999,30.240000000000002,0],meshHeight:0,style:{modelUri:"",modelScale:1}};Rc={};sd=[];ad;constructor(t){super(),this.us.viewer=t.viewer||this.us.viewer,this.us.meshEnuCenter=t.meshEnuCenter||this.us.meshEnuCenter,this.us.uri=t.uri||this.us.uri,this.us.meshUri=t.meshUri||this.us.meshUri,this.us.startTime=t.startTime||this.us.startTime,this.us.adcode=t.adcode||this.us.adcode,this.us.bounds=t.bounds||this.us.bounds,this.us.meshHeight=t.meshHeight||this.us.meshHeight,this.us.style=Object.assign(this.us.style,t.style),this.us.viewer&&this.Uc()}destroy(){this.Rc=[],this.sd.forEach((t=>{this.us.viewer?.entities.remove(t)}))}show(){this.sd.forEach((t=>{t.show=!0}))}hide(){this.sd.forEach((t=>{t.show=!1}))}update(){this.Uc()}async Uc(){this.Rc=await this.qc(),this.ud(),this.hd()}ud(){const t=this.us.viewer;if(!t)return;const e=["./car0.glb","./car1.glb","./car4.glb","./car5.glb","./car6.glb","./car13.glb"];for(let n=0;n<this.Rc.length;n++){const r=this.Rc[n],o=i.Cartesian3.fromDegrees(r[0].point[0],r[0].point[1],this.us.meshHeight),s=t.entities.add({name:`Model ${n}`,position:o,orientation:i.Transforms.headingPitchRollQuaternion(o,new i.HeadingPitchRoll(0,0,0)),model:{uri:this.us.style.modelUri||e[0],scale:this.us.style.modelScale||1,heightReference:i.HeightReference.RELATIVE_TO_TERRAIN}});this.sd.push(s)}}hd(){const t=this.us.viewer;if(!t)return;let e=1/0,n=0;for(let t=0;t<this.Rc.length;t++){const i=this.Rc[t];e=Math.min(e,i[0].time),n=Math.max(n,i[i.length-1].time)}const r=i.JulianDate.now();for(let t=0;t<this.Rc.length;t++){const e=this.Rc[t],n=new i.SampledPositionProperty;for(let t=1;t<e.length;t++){const o=e[t].point,s=e[t].time,a=i.JulianDate.addSeconds(r,s,new i.JulianDate),u=i.Cartesian3.fromDegrees(o[0],o[1],this.us.meshHeight);n.addSample(a,u)}const o=this.sd[t];o.position=n;const s=new i.VelocityOrientationProperty(n,i.Ellipsoid.WGS84);o.orientation=s}const o=t.clock;o.shouldAnimate=!0,o.startTime=i.JulianDate.addSeconds(r,e,new i.JulianDate),o.currentTime=o.startTime,o.stopTime=i.JulianDate.addSeconds(r,n,new i.JulianDate),o.clockRange=i.ClockRange.LOOP_STOP,o.multiplier=1}async qc(){const t=await fetch(this.us.uri,{method:"GET"}),e=await t.json();if(0!==e.code)throw new Error(":"+e.message);return e.data.trackPoint}async ld(){if(!this.us.viewer)return;const t=await this.fd();this.ad=new ap({viewer:this.us.viewer,enuCenter:this.us.meshEnuCenter,vertices:t.vertices,faces:t.faces})}async fd(){const t=await fetch(this.us.meshUri,{method:"GET"}),e=await t.json();if(!e.faces||!e.vertices)throw new Error("Mesh :"+e.message);return e}}!function(t){t[t.distance=0]="distance",t[t.groundArea=1]="groundArea"}(Kd||(Kd={}));class lp{dd=Kd.distance;pd;vd;md=[];_o="closed";yd=[];wd;Yn=[];Ln;us;ve=!1;constructor(e,n){this.us={unit:"",precision:.1,...n},this.Ln=e;const r=t=>{let n;return this.dd===Kd.distance?n=e.entities.add({polyline:{positions:t,width:5,material:new i.PolylineOutlineMaterialProperty({color:new i.Color(0,98/255,254/255,1),outlineColor:i.Color.WHITE,outlineWidth:2}),depthFailMaterial:new i.PolylineOutlineMaterialProperty({color:new i.Color(0,98/255,254/255,1),outlineColor:i.Color.WHITE,outlineWidth:2})}}):this.dd===Kd.groundArea&&(n=e.entities.add({polygon:{hierarchy:t,material:new i.ColorMaterialProperty(new i.Color(0,98/255,254/255,.3))}})),e.scene.requestRender(),n};this.pd=new t.ScreenSpaceEventHandler(e.canvas);const o=t=>{let n=e.scene.pickPosition(t);if(!n){const r=e.scene.pick(t,1,1);!r||r.id!=this.wd&&-1===this.Yn.indexOf(r.id)||(n=r.id.position.getValue(i.JulianDate.now()))}return n};this.pd.setInputAction((t=>{if("open"!==this._o)return;const e=o(t.position);if(i.defined(e))if(this.vd){this.yd.pop();const t=this.yd[this.yd.length-1];if(this.yd.push(e,e),this.dd==Kd.distance){let n=i.Cartesian3.distance(e,t);const r=this.us.unit;if(""==r&&(n*=10),""==r&&(n*=100),""==r&&(n*=1e3),"dm"==r&&(n*=10),"cm"==r&&(n*=100),"mm"==r&&(n*=1e3),this.us.precision<=1){const t=Math.round(1/this.us.precision);n=Math.round(n*t)/t}else n=Math.round(n/this.us.precision)*this.us.precision;const o=new i.Cartesian3;i.Cartesian3.add(t,e,o),i.Cartesian3.divideByScalar(o,2,o),this.Yn.push(this.gd(o,n+" "+r))}this.Yn.push(this.bd(e))}else{this.wd=this.bd(e);const t=[e,e],n=new i.CallbackProperty((()=>{if(this.vd)return this.dd===Kd.groundArea?new i.PolygonHierarchy(this.yd):this.yd}),!1);this.vd=r(n),this.yd=t,this.Yn.push(this.bd(e))}}),i.ScreenSpaceEventType.LEFT_CLICK),this.pd.setInputAction((t=>{if("open"===this._o&&i.defined(this.wd)){const e=o(t.endPosition);i.defined(e)&&(this.wd.position.setValue(e),this.yd.pop(),this.yd.push(e),this.Ln.scene.requestRender())}}),i.ScreenSpaceEventType.MOUSE_MOVE),this.pd.setInputAction((t=>{this._d()}),i.ScreenSpaceEventType.RIGHT_CLICK)}destroy(){this.stop(!0),this.pd.destroy(),this.ve=!0}xd(){if(this.vd)if(this.dd===Kd.distance)this.vd.polyline.positions=this.yd,this.yd.length<2?(this.Ln.entities.remove(this.vd),this.Yn.forEach((t=>{this.Ln.entities.remove(t)}))):(this.md.push(this.vd),this.md.push.apply(this.md,this.Yn),this.Yn=[]);else if(this.dd===Kd.groundArea)if(this.vd.polygon.hierarchy=new i.PolygonHierarchy(this.yd),this.yd.length<3)this.Ln.entities.remove(this.vd),this.Yn.forEach((t=>{this.Ln.entities.remove(t)}));else{this.md.push(this.vd),this.md.push.apply(this.md,this.Yn);const t=new i.Cartesian3;this.yd.forEach((e=>{t.x+=e.x,t.y+=e.y,t.z+=e.z})),i.Cartesian3.divideByScalar(t,this.yd.length,t),this.md.push(this.gd(t,"100")),this.Yn=[]}return this.Ln.scene.requestRender(),this.vd}bd(t){const e=this.Ln.entities.add({position:t,point:{color:new i.Color(0,98/255,254/255,1),outlineColor:i.Color.WHITE,outlineWidth:1.5,pixelSize:5}});return this.Ln.scene.requestRender(),e}gd(t,e){const n=this.Ln.entities.add({position:t,label:{text:e,font:"12px sans-serif",horizontalOrigin:i.HorizontalOrigin.CENTER,verticalOrigin:i.VerticalOrigin.CENTER,fillColor:i.Color.GHOSTWHITE,showBackground:!0,backgroundColor:new i.Color(0,98/255,254/255,1),backgroundPadding:new i.Cartesian2(4,4),pixelOffset:new i.Cartesian2(0,-20),disableDepthTestDistance:Number.POSITIVE_INFINITY}});return this.Ln.scene.requestRender(),n}_d(){"open"===this._o&&(this.yd.pop(),this.Ln.entities.remove(this.wd),this.wd=void 0,this.xd(),this.vd=void 0,this.yd=[])}kd(){this.ve||(this._o="open")}distance(t=!1){this.vd&&this._d(),this.dd=Kd.distance,this.kd()}area(t=!1){this.vd&&this._d(),this.dd=Kd.groundArea,this.kd()}stop(t){this._o="closed",t&&this.clear()}clear(){this._d(),this.wd&&this.Ln.entities.remove(this.wd),this.Yn.forEach((t=>{this.Ln.entities.remove(t)})),this.vd&&this.Ln.entities.remove(this.vd),this.md.forEach((t=>{this.Ln.entities.remove(t)})),this.Ln.scene.requestRender()}}Math.PI;const cp=180/Math.PI,fp=6378137,dp=20037508.342789244,pp=t=>{const e=t[0],n=t[1];return[e/fp*cp,(2*Math.atan(Math.exp(n/fp))-Math.PI/2)*cp]},vp=t=>2*dp/2**t,mp=pp,yp=(t,e,n)=>{const i=[-20037508.342789244,-20037508.342789244,20037508.342789244,20037508.342789244];let r;return r=void 0===n?40075016.68557849:256*Math.pow(2,n),[t=(t/r-.5)*i[2]*2,e=-(e/r-.5)*i[2]*2]},wp=t=>pp((t=>{const e=t[0],n=vp(e),i=t[1],r=t[2];return[(i+.5)*n-dp,dp-(r+.5)*n]})(t)),gp=(t,e=!1)=>{const n=t[0],i=vp(n),r=t[1],o=t[2],s=r*i-dp,a=s+i,u=dp-o*i,h=pp([s,u-i]),l=pp([a,u]),c=[h[0],h[1],l[0],l[1]];return e?[h,[l[0],h[1]],l,[h[0],l[1]]]:c};class bp{Zo;Jo="";ts=!1;es;ns;rs;_show=!0;ss;Ln;$d;Sd;Ed=0;Md=0;us;constructor(t){this.us=t,this.Ln=t.viewer,this.es=new i.Event,this.ns=new i.Event,this.Sd=new Bc({Pi:100,Fi:(t,e)=>{e.entity&&this.Zo.remove(e.entity)}}),this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this.$d=[[4,11,5],[4,12,5],[4,13,5],[4,11,6],[4,12,6],[4,13,6],[4,12,7],[4,13,7]]}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}update(){const t=(new Date).getTime();if(t-this.Ed<1e3)return!0;this.Ed=t;const e=this.Zo,n=this.Ln,r=n.scene.canvas,o=new i.Cartesian2(r.clientWidth/2,r.clientHeight/2),s=n.scene.pickPosition(o);if(s){const r=n.scene.camera,o=i.Cartesian3.distance(r.positionWC,s),a=Math.min(this.us.zooms[1],Math.round(Math.log2(2400/o))+16);if(a>=this.us.zooms[0]&&this.show){const n=i.Cartographic.fromCartesian(s).height;if(n>=-400){if(e.suspendEvents(),e.removeAll(),this.us.forceUpdateTime&&this.Md){const e=Math.floor(t/(1e3*this.us.forceUpdateTime));e!==this.Md&&(this.Sd._e(),this.Md=e)}const o=r.frustum.computeCullingVolume(r.positionWC,r.directionWC,r.upWC).planes;(new Date).getTime();const s=[],u=t=>{let e=!1,h=!1;const l=gp(t),c=wp(t);let f=[c[0],c[1],n];const d=f[0],p=f[1],v=f[2],m=Mc([l[0],l[1],n],f),y=Mc([l[2],l[3],n],f),w=[m.x,m.y,m.z,y.x,y.y,Math.max(n,y.z)],g=4800*2**(16-t[0]),b=i.Cartesian3.fromDegrees(d,p,v),_=i.Transforms.eastNorthUpToFixedFrame(b),x=i.Matrix4.inverse(_,new i.Matrix4),k=o.map((t=>{const e=new i.Cartesian3(t.x,t.y,t.z),n=t.w,r=i.Matrix4.multiplyByPointAsVector(x,e,new i.Cartesian3),o=i.Cartesian3.multiplyByScalar(e,-n,new i.Cartesian3),s=i.Matrix4.multiplyByPoint(x,o,new i.Cartesian3),a=-i.Cartesian3.dot(r,s);return new i.Cartesian4(r.x,r.y,r.z,a)})),$=new i.Cartesian3(w[0],w[1],w[2]),S=new i.Cartesian3(w[3],w[4],w[5]),E=new i.AxisAlignedBoundingBox($,S);if(e=new i.CullingVolume(k).computeVisibility(E)!==i.Intersect.OUTSIDE,e){const e=((t,e,n)=>{const i=Ic(t,n);return((t,e,n,i,r,o,s,a,u)=>{let h=Math.max(t-s,0,s-i),l=Math.max(e-a,0,a-r),c=Math.max(n-u,0,u-o);return Math.sqrt(h*h+l*l+c*c)})(e[0],e[1],e[2],e[3],e[4],e[5],i.x,i.y,i.z)})(r.positionWC,w,f);if(h=e<=g,h)if(t[0]<a){const e=t[0]+1,n=[[e,t[1]<<1,t[2]<<1],[e,t[1]<<1,1+(t[2]<<1)],[e,1+(t[1]<<1),t[2]<<1],[e,1+(t[1]<<1),1+(t[2]<<1)]];for(let t=0;t<n.length;t+=1){const e=n[t];u(e)}}else s.push(t)}return[e,h,!1,!1]};for(let t=0;t<this.$d.length;t+=1){const e=this.$d[t];u(e)}s.forEach((t=>{t.join("_");const n=this.us.getTileUrl(t,new Date),r=this.Sd.Yi(n,!1);if(r)"loaded"==r.status&&(e.contains(r.entity)||(e.add(r.entity),this.us.viewer.scene.requestRender()));else{const r=document.createElement("img");r.crossOrigin="anonymous",r.src=n;const o=gp(t);r.onload=()=>{const s=new i.Entity({id:n,rectangle:{coordinates:i.Rectangle.fromDegrees(o[0],o[1],o[2],o[3]),material:new i.ImageMaterialProperty({image:r}),zIndex:t[0]}});e.add(s),this.us.viewer.scene.requestRender();const a=this.Sd.Yi(n,!0);a.entity=s,a.status="loaded"},r.onerror=()=>{this.Sd.Yi(n,!0).status="error"};const s={status:"loading",entity:null};this.Sd.Xi(n,s)}})),e.resumeEvents()}}else e.removeAll()}return!0}}class _p{Ln;ys;ve=!1;constructor(t){const e=t.viewer;this.Ln=e,this.ys=new bp(t),e.dataSources.add(this.ys)}setVisibility(t,e){this.ys&&(this.ys.show=e)}hide(){this.ys&&(this.ys.show=!1)}show(){this.ys&&(this.ys.show=!0)}destory(){this.ys&&(this.ys.entities.removeAll(),this.Ln?.dataSources.remove(this.ys),this.ys=void 0),this.ve=!0,this.Ln=void 0}}class xp extends _p{constructor(t){super({name:"",viewer:t,forceUpdateTime:300,zooms:[8,17],getTileUrl:(t,e)=>`https://history.traffic.amap.com/traffic?type=2&day=${e.getDay()}&hh=${e.getHours()}&mm=${5*Math.floor(e.getMinutes()/5)}&x=${t[1]}&y=${t[2]}&z=${t[0]}`})}}class kp extends _p{constructor(t){super({name:"",viewer:t,forceUpdateTime:0,zooms:[3,18],getTileUrl:t=>`https://wprd0${(t[1]+t[2])%4+1}.is.autonavi.com/appmaptile?x=${t[1]}&y=${t[2]}&z=${t[0]}&lang=zh_cn&size=1&scl=1&style=8`})}}class $p{Zo;Jo="";ts=!1;es;ns;rs;_show=!0;ss;Ln;$d;Sd;Ed=0;Md=0;us;constructor(t){this.us=t,this.Ln=t.viewer,this.es=new i.Event,this.ns=new i.Event,this.Sd=new Bc({Pi:100,Fi:(t,e)=>{e.entity&&this.Zo.remove(e.entity)}}),this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this.$d=[[4,11,5],[4,12,5],[4,13,5],[4,11,6],[4,12,6],[4,13,6],[4,12,7],[4,13,7]]}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}update(){const t={0:"fff93a43",1:"fffcac19",2:"ff20a962",3:"ff83171c",4:"ffadadad"},e=(new Date).getTime();if(e-this.Ed<1e3)return!0;this.Ed=e;const n=this.Zo,r=this.Ln,o=r.scene.canvas,s=new i.Cartesian2(o.clientWidth/2,o.clientHeight/2),a=r.scene.pickPosition(s);if(a){const o=r.scene.camera,s=i.Cartesian3.distance(o.positionWC,a),u=Math.min(this.us.zooms[1],Math.round(Math.log2(2400/s))+16);if(u>=this.us.zooms[0]&&this.show){const r=10;i.Cartographic.fromCartesian(a).height;{n.suspendEvents(),n.removeAll();const s=Math.floor(e/12e4);s!==this.Md&&(this.Md=s);const a=o.frustum.computeCullingVolume(o.positionWC,o.directionWC,o.upWC).planes;(new Date).getTime();const h=[],l=t=>{let e=!1,n=!1;const s=gp(t),c=wp(t);let f=[c[0],c[1],r];const d=f[0],p=f[1],v=f[2],m=Mc([s[0],s[1],r],f),y=Mc([s[2],s[3],r],f),w=[m.x,m.y,m.z,y.x,y.y,Math.max(r,y.z)],g=4800*2**(16-t[0]),b=i.Cartesian3.fromDegrees(d,p,v),_=i.Transforms.eastNorthUpToFixedFrame(b),x=i.Matrix4.inverse(_,new i.Matrix4),k=a.map((t=>{const e=new i.Cartesian3(t.x,t.y,t.z),n=t.w,r=i.Matrix4.multiplyByPointAsVector(x,e,new i.Cartesian3),o=i.Cartesian3.multiplyByScalar(e,-n,new i.Cartesian3),s=i.Matrix4.multiplyByPoint(x,o,new i.Cartesian3),a=-i.Cartesian3.dot(r,s);return new i.Cartesian4(r.x,r.y,r.z,a)})),$=new i.Cartesian3(w[0],w[1],w[2]),S=new i.Cartesian3(w[3],w[4],w[5]),E=new i.AxisAlignedBoundingBox($,S);if(e=new i.CullingVolume(k).computeVisibility(E)!==i.Intersect.OUTSIDE,e){const e=((t,e,n)=>{const i=Ic(t,n);return((t,e,n,i,r,o,s,a,u)=>{let h=Math.max(t-s,0,s-i),l=Math.max(e-a,0,a-r),c=Math.max(n-u,0,u-o);return Math.sqrt(h*h+l*l+c*c)})(e[0],e[1],e[2],e[3],e[4],e[5],i.x,i.y,i.z)})(o.positionWC,w,f);if(n=e<=g,n)if(t[0]<u){const e=t[0]+1,n=[[e,t[1]<<1,t[2]<<1],[e,t[1]<<1,1+(t[2]<<1)],[e,1+(t[1]<<1),t[2]<<1],[e,1+(t[1]<<1),1+(t[2]<<1)]];for(let t=0;t<n.length;t+=1){const e=n[t];l(e)}}else h.push(t)}return[e,n,!1,!1]};for(let t=0;t<this.$d.length;t+=1){const e=this.$d[t];l(e)}h.forEach((e=>{const r=function(t,e,n){let i,r,o,s,a,u;return s=Math.floor(n/2),o=n-s,i=(1<<s)-1<<o,r=(1<<o)-1,u=e&i|t&r,a=t&i|e&r,[n,a,u]}(e[1],e[2],e[0]),o="https://vdata.amap.com/traffic?key="+this.us.key+"&v=YunJingCesium&t="+r,s=o+"&w="+12e4*this.Md;let a=this.Sd.Yi(o,!1),u=!1;a?("loaded"==a.status&&(a.entities.forEach((t=>{n.add(t)})),this.us.viewer.scene.requestRender()),a.Md!==this.Md&&(u=!0)):(u=!0,a={status:"loading",entities:[]},this.Sd.Xi(o,a)),u&&fetch(s).then((n=>{try{n.json().then((n=>{const a=this.Sd.Yi(o,!1);if(a&&(a.status="loaded",a.entities=[],n.data)){n=(n=n.data)[r.join("_")];const o=(u=e[0],2*dp/256/Math.pow(2,u));for(let r=0,u=n.length;r<u;r++){const u=n[r],h=Nc(t[r]);for(let t=0,n=u.length;t<n;t++){const n=u[t],r=.6*n[0]*this.us.lineWidthFactor;for(let t=0,u=n[1].length;t<u;t++){const u=[],l=Uc(n[1][t]);for(let t=0,n=l.length;t<n;t+=2){const n=o*(256*e[1]+l[t]),r=o*(256*e[2]+l[t+1]),s=mp(yp(n,r)),a=i.Cartesian3.fromDegrees(s[0],s[1],0);u.push(a)}const c=new i.Entity({id:s+"_"+a.entities.length,polyline:{positions:u,clampToGround:!0,material:new i.Color(...h),zIndex:e[0],width:3*r}});a.entities.push(c)}}}a.Md=this.Md}var u}))}catch(t){const e=this.Sd.Yi(o,!1);if(e)return void(e.status="loaded")}}))})),n.resumeEvents()}}else n.removeAll()}return!0}}class Sp{Ln;ys;ve=!1;constructor(t){t.zooms=t.zooms||[7,17],t.zooms=[Math.max(7,t.zooms[0]),Math.min(17,t.zooms[1])],t.lineWidthFactor=t.lineWidthFactor||1;const e=t.viewer;this.Ln=e,this.ys=new $p(t),e.dataSources.add(this.ys)}setVisibility(t,e){this.ys&&(this.ys.show=e)}hide(){this.ys&&(this.ys.show=!1)}show(){this.ys&&(this.ys.show=!0)}destroy(){this.ys&&(this.ys.entities.removeAll(),this.Ln?.dataSources.remove(this.ys),this.ys=void 0),this.ve=!0,this.Ln=void 0}}class Ep{Zo;Jo="";ts=!1;es;ns;rs;_show=!0;ss;Ln;us;hs;Ut;ls;cs;fs;ds;vs;constructor(t){this.us=t,this.vs=t.cb,this.Ln=t.viewer,this.Ut=t.tiles,this.hs=t.api_url,this.ds={},this.ls=t.data,this.cs={},this.fs=new Bc({Pi:10,Fi:this.onDrop}),this.es=new i.Event,this.ns=new i.Event,this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this.init()}init(){for(let t of this.ls)this.drawMonomer(this.Zo,t,this.ds);this.vs&&this.vs(this.Zo)}drawMonomer(t,e,n){const r=e.id.toString().split("@")[0];if(void 0!==n[r])return;let o=[],s=e.min_height;const a=e.contours;for(let t of a){const n=parseFloat(t[0]),i=parseFloat(t[1]);o.push(n),o.push(i),o.push(e.max_height)}t.add({name:"polygon",polygon:{hierarchy:i.Cartesian3.fromDegreesArrayHeights(o),material:i.Color.BLUE.withAlpha(.3),extrudedHeight:s,perPositionHeight:!0}}),n[r]=e}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}onDrop=(t,e)=>{delete this.cs[t],this.ds=[],this.ls=[],this.Zo.removeAll();for(let t in this.cs)this.ls=this.ls.concat(this.cs[t]);for(let t of this.ls)this.drawMonomer(this.Zo,t,this.ds);return!0};updateData(t){for(let e of t)this.fs.Zi(e)||(this.fs.Xi(e,"1"),fetch(this.hs+e+".json").then((t=>t.json())).then((t=>{this.cs[e]=t,this.ls=[];for(let t in this.cs)this.ls=this.ls.concat(this.cs[t]);for(let t of this.ls)this.drawMonomer(this.Zo,t,this.ds)})).catch((t=>{})));return!0}update(){return!0}pick(t){var e=this.Ln.scene.pick(t);return e?null!=e?.id?.id?this.ds[e.id.id]:void 0:null}}class Mp{Ln;ys;ve=!1;constructor(t){const e=t.viewer;this.Ln=e,this.ys=new Ep(t),e.dataSources.add(this.ys)}setVisibility(t,e){this.ys&&(this.ys.show=e)}hide(){this.ys&&(this.ys.entities.show=!1)}show(){this.ys&&(this.ys.entities.show=!0)}destory(){this.ys&&(this.ys.entities.removeAll(),this.Ln?.dataSources.remove(this.ys),this.ys=void 0),this.ve=!0,this.Ln=void 0}getEntities(){return this.ys?.entities}update(t){return this.ys?.updateData(t)}pick(t){return this.ys?.pick(t)}}var Cp,Ap,Op=function(){if(Ap)return Cp;Ap=1,Cp=function(n,i){i||(i={});var r,o,s,a,u,h,l,c,f,d,p,v=null==i.cutoff?.25:i.cutoff,m=null==i.radius?8:i.radius,y=i.channel||0;if(ArrayBuffer.isView(n)||Array.isArray(n)){if(!i.width||!i.height)throw Error("For raw data width and height should be provided by options");r=i.width,o=i.height,a=n,h=i.stride?i.stride:Math.floor(n.length/r/o)}else window.HTMLCanvasElement&&n instanceof window.HTMLCanvasElement?(l=(c=n).getContext("2d"),r=c.width,o=c.height,a=(f=l.getImageData(0,0,r,o)).data,h=4):window.CanvasRenderingContext2D&&n instanceof window.CanvasRenderingContext2D?(l=n,r=(c=n.canvas).width,o=c.height,a=(f=l.getImageData(0,0,r,o)).data,h=4):window.ImageData&&n instanceof window.ImageData&&(f=n,r=n.width,o=n.height,a=f.data,h=4);if(s=Math.max(r,o),window.Uint8ClampedArray&&a instanceof window.Uint8ClampedArray||window.Uint8Array&&a instanceof window.Uint8Array)for(u=a,a=Array(r*o),d=0,p=Math.floor(u.length/h);d<p;d++)a[d]=u[d*h+y]/255;else if(1!==h)throw Error("Raw data can have only 1 value per pixel");var w=Array(r*o),g=Array(r*o),b=Array(s),_=Array(s),x=Array(s+1),k=Array(s);for(d=0,p=r*o;d<p;d++){var $=a[d];w[d]=1===$?0:0===$?t:Math.pow(Math.max(0,.5-$),2),g[d]=1===$?t:0===$?0:Math.pow(Math.max(0,$-.5),2)}e(w,r,o,b,_,k,x),e(g,r,o,b,_,k,x);var S=window.Float32Array?new Float32Array(r*o):new Array(r*o);for(d=0,p=r*o;d<p;d++)S[d]=Math.min(Math.max(1-((w[d]-g[d])/m+v),0),1);return S};var t=1e20;function e(t,e,i,r,o,s,a){for(var u=0;u<e;u++){for(var h=0;h<i;h++)r[h]=t[h*e+u];for(n(r,o,s,a,i),h=0;h<i;h++)t[h*e+u]=o[h]}for(h=0;h<i;h++){for(u=0;u<e;u++)r[u]=t[h*e+u];for(n(r,o,s,a,e),u=0;u<e;u++)t[h*e+u]=Math.sqrt(o[u])}}function n(t,e,n,i,r){n[0]=0,i[0]=-1e20,i[1]=1e20;for(var o=1,s=0;o<r;o++){for(var a=(t[o]+o*o-(t[n[s]]+n[s]*n[s]))/(2*o-2*n[s]);a<=i[s];)s--,a=(t[o]+o*o-(t[n[s]]+n[s]*n[s]))/(2*o-2*n[s]);n[++s]=o,i[s]=a,i[s+1]=1e20}for(o=0,s=0;o<r;o++){for(;i[s+1]<o;)s++;e[o]=(o-n[s])*(o-n[s])+t[n[s]]}}return Cp}(),Ip=wf(Op);function Tp(e){return e===t.HeightReference.CLAMP_TO_GROUND||e===t.HeightReference.CLAMP_TO_3D_TILE||e===t.HeightReference.CLAMP_TO_TERRAIN}const zp=t.Billboard.SHOW_INDEX,Rp=t.Billboard.POSITION_INDEX,Fp=t.Billboard.PIXEL_OFFSET_INDEX,Dp=t.Billboard.EYE_OFFSET_INDEX,Pp=t.Billboard.HORIZONTAL_ORIGIN_INDEX,Np=t.Billboard.VERTICAL_ORIGIN_INDEX,Up=t.Billboard.SCALE_INDEX,qp=t.Billboard.IMAGE_INDEX_INDEX,jp=t.Billboard.COLOR_INDEX,Lp=t.Billboard.ROTATION_INDEX,Bp=t.Billboard.ALIGNED_AXIS_INDEX,Hp=t.Billboard.SCALE_BY_DISTANCE_INDEX,Wp=t.Billboard.TRANSLUCENCY_BY_DISTANCE_INDEX,Vp=t.Billboard.PIXEL_OFFSET_SCALE_BY_DISTANCE_INDEX,Gp=t.Billboard.DISTANCE_DISPLAY_CONDITION,Yp=t.Billboard.DISABLE_DEPTH_DISTANCE,Kp=t.Billboard.TEXTURE_COORDINATE_BOUNDS,Xp=t.Billboard.SDF_INDEX,Qp=t.Billboard.NUMBER_OF_PROPERTIES;let Zp;const Jp={positionHighAndScale:0,positionLowAndRotation:1,compressedAttribute0:2,compressedAttribute1:3,compressedAttribute2:4,eyeOffset:5,scaleByDistance:6,pixelOffsetScaleByDistance:7,compressedAttribute3:8,textureCoordinateBoundsOrLabelTranslate:9,a_batchId:10,sdf:11},tv={direction:0,positionHighAndScale:1,positionLowAndRotation:2,compressedAttribute0:3,compressedAttribute1:4,compressedAttribute2:5,eyeOffset:6,scaleByDistance:7,pixelOffsetScaleByDistance:8,compressedAttribute3:9,textureCoordinateBoundsOrLabelTranslate:10,a_batchId:11,sdf:12,roadDirection:13};function ev(e){e=t.defaultValue(e,t.defaultValue.EMPTY_OBJECT),this._scene=e.scene,this._batchTable=e.batchTable,this._textureAtlas=void 0,this._textureAtlasGUID=void 0,this._destroyTextureAtlas=!0,this._sp=void 0,this._spTranslucent=void 0,this._rsOpaque=void 0,this._rsTranslucent=void 0,this._vaf=void 0,this._billboards=[],this._billboardsToUpdate=[],this._billboardsToUpdateIndex=0,this._billboardsRemoved=!1,this._createVertexArray=!1,this._shaderRotation=!1,this._compiledShaderRotation=!1,this._shaderAlignedAxis=!1,this._compiledShaderAlignedAxis=!1,this._shaderScaleByDistance=!1,this._compiledShaderScaleByDistance=!1,this._shaderTranslucencyByDistance=!1,this._compiledShaderTranslucencyByDistance=!1,this._shaderPixelOffsetScaleByDistance=!1,this._compiledShaderPixelOffsetScaleByDistance=!1,this._shaderDistanceDisplayCondition=!1,this._compiledShaderDistanceDisplayCondition=!1,this._shaderDisableDepthDistance=!1,this._compiledShaderDisableDepthDistance=!1,this._shaderClampToGround=!1,this._compiledShaderClampToGround=!1,this._propertiesChanged=new Uint32Array(Qp),this._maxSize=0,this._maxEyeOffset=0,this._maxScale=1,this._maxPixelOffset=0,this._allHorizontalCenter=!0,this._allVerticalCenter=!0,this._allSizedInMeters=!0,this._baseVolume=new t.BoundingSphere,this._baseVolumeWC=new t.BoundingSphere,this._baseVolume2D=new t.BoundingSphere,this._boundingVolume=new t.BoundingSphere,this._boundingVolumeDirty=!1,this._colorCommands=[],this.show=t.defaultValue(e.show,!0),this.modelMatrix=t.Matrix4.clone(t.defaultValue(e.modelMatrix,t.Matrix4.IDENTITY)),this._modelMatrix=t.Matrix4.clone(t.Matrix4.IDENTITY),this.debugShowBoundingVolume=t.defaultValue(e.debugShowBoundingVolume,!1),this.debugShowTextureAtlas=t.defaultValue(e.debugShowTextureAtlas,!1),this.blendOption=t.defaultValue(e.blendOption,t.BlendOption.OPAQUE_AND_TRANSLUCENT),this._blendOption=void 0,this._mode=t.SceneMode.SCENE3D,this._buffersUsage=[t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW,t.BufferUsage.STATIC_DRAW],this._highlightColor=t.Color.clone(t.Color.WHITE);const n=this;this._uniforms={u_atlas:function(){return n._textureAtlas.texture},u_highlightColor:function(){return n._highlightColor}};const i=this._scene;t.defined(i)&&t.defined(i.terrainProviderChanged)&&(this._removeCallbackFunc=i.terrainProviderChanged.addEventListener((function(){const e=this._billboards,n=e.length;for(let i=0;i<n;++i)t.defined(e[i])&&e[i]._updateClamping()}),this))}function nv(t){const e=t.length;for(let n=0;n<e;++n)t[n]&&t[n]._destroy()}function iv(e){if(e._billboardsRemoved){e._billboardsRemoved=!1;const n=[],i=e._billboards,r=i.length;for(let e=0,o=0;e<r;++e){const r=i[e];t.defined(r)&&(r._index=o++,n.push(r))}e._billboards=n}}let rv;function ov(e){let n=e.cache.billboardCollection_indexBufferBatched;if(t.defined(n))return n;const i=new Uint16Array(98298);for(let t=0,e=0;t<98298;t+=6,e+=4)i[t]=e,i[t+1]=e+1,i[t+2]=e+2,i[t+3]=e+0,i[t+4]=e+2,i[t+5]=e+3;return n=t.Buffer.createIndexBuffer({context:e,typedArray:i,usage:t.BufferUsage.STATIC_DRAW,indexDatatype:t.IndexDatatype.UNSIGNED_SHORT}),n.vertexArrayDestroyable=!1,e.cache.billboardCollection_indexBufferBatched=n,n}function sv(e){let n=e.cache.billboardCollection_indexBufferInstanced2;return t.defined(n)||(n=t.Buffer.createIndexBuffer({context:e,typedArray:new Uint16Array([0,1,2,0,2,3]),usage:t.BufferUsage.STATIC_DRAW,indexDatatype:t.IndexDatatype.UNSIGNED_SHORT}),n.vertexArrayDestroyable=!1,e.cache.billboardCollection_indexBufferInstanced2=n),n}function av(e){let n=e.cache.billboardCollection_vertexBufferInstanced2;return t.defined(n)||(n=t.Buffer.createVertexBuffer({context:e,typedArray:new Float32Array([0,0,1,0,1,1,0,1]),usage:t.BufferUsage.STATIC_DRAW}),n.vertexArrayDestroyable=!1,e.cache.billboardCollection_vertexBufferInstanced2=n),n}Object.defineProperties(ev.prototype,{length:{get:function(){return iv(this),this._billboards.length}},textureAtlas:{get:function(){return this._textureAtlas},set:function(t){this._textureAtlas!==t&&(this._textureAtlas=this._destroyTextureAtlas&&this._textureAtlas&&this._textureAtlas.destroy(),this._textureAtlas=t,this._createVertexArray=!0)}},destroyTextureAtlas:{get:function(){return this._destroyTextureAtlas},set:function(t){this._destroyTextureAtlas=t}}}),ev.prototype.add=function(e){const n=new t.Billboard(e,this);return n._index=this._billboards.length,this._billboards.push(n),this._createVertexArray=!0,n},ev.prototype.remove=function(t){return!!this.contains(t)&&(this._billboards[t._index]=void 0,this._billboardsRemoved=!0,this._createVertexArray=!0,t._destroy(),!0)},ev.prototype.removeAll=function(){nv(this._billboards),this._billboards=[],this._billboardsToUpdate=[],this._billboardsToUpdateIndex=0,this._billboardsRemoved=!1,this._createVertexArray=!0},ev.prototype._updateBillboard=function(t,e){t._dirty||(this._billboardsToUpdate[this._billboardsToUpdateIndex++]=t),++this._propertiesChanged[e]},ev.prototype.contains=function(e){return t.defined(e)&&e._billboardCollection===this},ev.prototype.get=function(e){return t.Check.typeOf.number("index",e),iv(this),this._billboards[e]},ev.prototype.computeNewBuffersUsage=function(){const e=this._buffersUsage;let n=!1;const i=this._propertiesChanged;for(let r=0;r<Qp;++r){const o=0===i[r]?t.BufferUsage.STATIC_DRAW:t.BufferUsage.STREAM_DRAW;n=n||e[r]!==o,e[r]=o}return n};const uv=new t.EncodedCartesian3;function hv(e,n,i,r,o){let s;const a=r[Zp.positionHighAndScale],u=r[Zp.positionLowAndRotation],h=o._getActualPosition();e._mode===t.SceneMode.SCENE3D&&(t.BoundingSphere.expand(e._baseVolume,h,e._baseVolume),e._boundingVolumeDirty=!0),t.EncodedCartesian3.fromCartesian(h,uv);const l=o.scale,c=o.rotation;0!==c&&(e._shaderRotation=!0),e._maxScale=Math.max(e._maxScale,l);const f=uv.high,d=uv.low;e._instanced?(s=o._index,a(s,f.x,f.y,f.z,l),u(s,d.x,d.y,d.z,c)):(s=4*o._index,a(s+0,f.x,f.y,f.z,l),a(s+1,f.x,f.y,f.z,l),a(s+2,f.x,f.y,f.z,l),a(s+3,f.x,f.y,f.z,l),u(s+0,d.x,d.y,d.z,c),u(s+1,d.x,d.y,d.z,c),u(s+2,d.x,d.y,d.z,c),u(s+3,d.x,d.y,d.z,c))}const lv=new t.Cartesian2,cv=32768,fv=65536,dv=4096,pv=256,vv=1/256;function mv(e,n,i,r,o){let s;const a=r[Zp.compressedAttribute0],u=o.pixelOffset,h=u.x,l=u.y,c=o._translate,f=c.x,d=c.y;e._maxPixelOffset=Math.max(e._maxPixelOffset,Math.abs(h+f),Math.abs(-l+d));const p=o.horizontalOrigin;let v=o._verticalOrigin,m=o.show&&o.clusterShow;0===o.color.alpha&&(m=!1),v===t.VerticalOrigin.BASELINE&&(v=t.VerticalOrigin.BOTTOM),e._allHorizontalCenter=e._allHorizontalCenter&&p===t.HorizontalOrigin.CENTER,e._allVerticalCenter=e._allVerticalCenter&&v===t.VerticalOrigin.CENTER;let y=0,w=0,g=0,b=0;const _=o._imageIndex;if(-1!==_){const e=i[_];if(!t.defined(e))throw new t.DeveloperError(`Invalid billboard image index: ${_}`);y=e.x,w=e.y,g=e.width,b=e.height}const x=y+g,k=w+b;let $=128*Math.floor(t.Math.clamp(h,-32768,cv)+cv);$+=32*(p+1),$+=8*(v+1),$+=4*(m?1:0);let S=Math.floor(t.Math.clamp(l,-32768,cv)+cv)*pv,E=Math.floor(t.Math.clamp(f,-32768,cv)+cv)*pv;const M=(t.Math.clamp(d,-32768,cv)+cv)*vv,C=Math.floor(M);S+=C,E+=Math.floor((M-C)*pv),lv.x=y,lv.y=w;const A=t.AttributeCompression.compressTextureCoordinates(lv);lv.x=x;const O=t.AttributeCompression.compressTextureCoordinates(lv);lv.y=k;const I=t.AttributeCompression.compressTextureCoordinates(lv);lv.x=y;const T=t.AttributeCompression.compressTextureCoordinates(lv);e._instanced?(s=o._index,a(s,$,S,E,A)):(s=4*o._index,a(s+0,$+0,S,E,A),a(s+1,$+2,S,E,O),a(s+2,$+3,S,E,I),a(s+3,$+1,S,E,T))}function yv(e,n,i,r,o){let s;const a=r[Zp.compressedAttribute1],u=o.alignedAxis;t.Cartesian3.equals(u,t.Cartesian3.ZERO)||(e._shaderAlignedAxis=!0);let h=0,l=1,c=1,f=1;const d=o.translucencyByDistance;t.defined(d)&&(h=d.near,l=d.nearValue,c=d.far,f=d.farValue,1===l&&1===f||(e._shaderTranslucencyByDistance=!0));let p=0;const v=o._imageIndex;if(-1!==v){const e=i[v];if(!t.defined(e))throw new t.DeveloperError(`Invalid billboard image index: ${v}`);p=e.width}const m=e._textureAtlas.texture.width,y=Math.round(t.defaultValue(o.width,m*p));e._maxSize=Math.max(e._maxSize,y);let w=t.Math.clamp(y,0,fv),g=0;Math.abs(t.Cartesian3.magnitudeSquared(u)-1)<t.Math.EPSILON6&&(g=t.AttributeCompression.octEncodeFloat(u)),l=t.Math.clamp(l,0,1),l=1===l?255:255*l|0,w=w*pv+l,f=t.Math.clamp(f,0,1),f=1===f?255:255*f|0,g=g*pv+f,e._instanced?(s=o._index,a(s,w,g,h,c)):(s=4*o._index,a(s+0,w,g,h,c),a(s+1,w,g,h,c),a(s+2,w,g,h,c),a(s+3,w,g,h,c))}function wv(e,n,i,r,o){let s;const a=r[Zp.compressedAttribute2],u=o.color,h=t.defined(e._batchTable)?t.Color.WHITE:o.getPickId(n.context).color,l=o.sizeInMeters?1:0,c=Math.abs(t.Cartesian3.magnitudeSquared(o.alignedAxis)-1)<t.Math.EPSILON6?1:0;e._allSizedInMeters=e._allSizedInMeters&&1===l;let f=0;const d=o._imageIndex;if(-1!==d){const e=i[d];if(!t.defined(e))throw new t.DeveloperError(`Invalid billboard image index: ${d}`);f=e.height}const p=e._textureAtlas.texture.dimensions,v=Math.round(t.defaultValue(o.height,p.y*f));e._maxSize=Math.max(e._maxSize,v);let m=t.defaultValue(o._labelHorizontalOrigin,-2);m+=2;const y=4*v+m;let w=t.Color.floatToByte(u.red),g=t.Color.floatToByte(u.green),b=t.Color.floatToByte(u.blue);const _=w*fv+g*pv+b;w=t.Color.floatToByte(h.red),g=t.Color.floatToByte(h.green),b=t.Color.floatToByte(h.blue);const x=w*fv+g*pv+b;let k=t.Color.floatToByte(u.alpha)*fv+t.Color.floatToByte(h.alpha)*pv;k+=2*l+c,e._instanced?(s=o._index,a(s,_,x,k,y)):(s=4*o._index,a(s+0,_,x,k,y),a(s+1,_,x,k,y),a(s+2,_,x,k,y),a(s+3,_,x,k,y))}function gv(e,n,i,r,o){let s;const a=r[Zp.eyeOffset],u=o.eyeOffset;let h=u.z;if(o._heightReference!==t.HeightReference.NONE&&(h*=1.005),e._maxEyeOffset=Math.max(e._maxEyeOffset,Math.abs(u.x),Math.abs(u.y),Math.abs(h)),e._instanced){let e=0,n=0;const r=o._imageIndex;if(-1!==r){const o=i[r];if(!t.defined(o))throw new t.DeveloperError(`Invalid billboard image index: ${r}`);e=o.width,n=o.height}lv.x=e,lv.y=n;const l=t.AttributeCompression.compressTextureCoordinates(lv);s=o._index,a(s,u.x,u.y,h,l)}else s=4*o._index,a(s+0,u.x,u.y,h,0),a(s+1,u.x,u.y,h,0),a(s+2,u.x,u.y,h,0),a(s+3,u.x,u.y,h,0)}function bv(e,n,i,r,o){let s;const a=r[Zp.scaleByDistance];let u=0,h=1,l=1,c=1;const f=o.scaleByDistance;t.defined(f)&&(u=f.near,h=f.nearValue,l=f.far,c=f.farValue,1===h&&1===c||(e._shaderScaleByDistance=!0)),e._instanced?(s=o._index,a(s,u,h,l,c)):(s=4*o._index,a(s+0,u,h,l,c),a(s+1,u,h,l,c),a(s+2,u,h,l,c),a(s+3,u,h,l,c))}function _v(e,n,i,r,o){let s;const a=r[Zp.pixelOffsetScaleByDistance];let u=0,h=1,l=1,c=1;const f=o.pixelOffsetScaleByDistance;t.defined(f)&&(u=f.near,h=f.nearValue,l=f.far,c=f.farValue,1===h&&1===c||(e._shaderPixelOffsetScaleByDistance=!0)),e._instanced?(s=o._index,a(s,u,h,l,c)):(s=4*o._index,a(s+0,u,h,l,c),a(s+1,u,h,l,c),a(s+2,u,h,l,c),a(s+3,u,h,l,c))}function xv(e,n,i,r,o){let s;const a=r[Zp.compressedAttribute3];let u=0,h=Number.MAX_VALUE;const l=o.distanceDisplayCondition;t.defined(l)&&(u=l.near,h=l.far,u*=u,h*=h,e._shaderDistanceDisplayCondition=!0);let c=o.disableDepthTestDistance;const f=Tp(o.heightReference)&&n.context.depthTexture;let d,p;if(t.defined(c)||(c=f?5e3:0),c*=c,(f||c>0)&&(e._shaderDisableDepthDistance=!0,c===Number.POSITIVE_INFINITY&&(c=-1)),t.defined(o._labelDimensions))p=o._labelDimensions.x,d=o._labelDimensions.y;else{let n=0,r=0;const s=o._imageIndex;if(-1!==s){const e=i[s];if(!t.defined(e))throw new t.DeveloperError(`Invalid billboard image index: ${s}`);n=e.height,r=e.width}d=Math.round(t.defaultValue(o.height,e._textureAtlas.texture.dimensions.y*n));const a=e._textureAtlas.texture.width;p=Math.round(t.defaultValue(o.width,a*r))}const v=Math.floor(t.Math.clamp(p,0,dv)),m=Math.floor(t.Math.clamp(d,0,dv)),y=v*dv+m;e._instanced?(s=o._index,a(s,u,h,c,y)):(s=4*o._index,a(s+0,u,h,c,y),a(s+1,u,h,c,y),a(s+2,u,h,c,y),a(s+3,u,h,c,y))}function kv(e,n,i,r,o){if(Tp(o.heightReference)){const i=e._scene,r=n.context,o=n.globeTranslucencyState.translucent,s=t.defined(i.globe)&&i.globe.depthTestAgainstTerrain;e._shaderClampToGround=r.depthTexture&&!o&&s}let s;const a=r[Zp.textureCoordinateBoundsOrLabelTranslate];if(t.ContextLimits.maximumVertexTextureImageUnits>0){let n=0,i=0;return t.defined(o._labelTranslate)&&(n=o._labelTranslate.x,i=o._labelTranslate.y),void(e._instanced?(s=o._index,a(s,n,i,0,0)):(s=4*o._index,a(s+0,n,i,0,0),a(s+1,n,i,0,0),a(s+2,n,i,0,0),a(s+3,n,i,0,0)))}let u=0,h=0,l=0,c=0;const f=o._imageIndex;if(-1!==f){const e=i[f];if(!t.defined(e))throw new t.DeveloperError(`Invalid billboard image index: ${f}`);u=e.x,h=e.y,l=e.width,c=e.height}const d=u+l,p=h+c;e._instanced?(s=o._index,a(s,u,h,d,p)):(s=4*o._index,a(s+0,u,h,d,p),a(s+1,u,h,d,p),a(s+2,u,h,d,p),a(s+3,u,h,d,p))}function $v(e,n,i,r,o){if(!e._sdf)return;let s;const a=r[Zp.sdf],u=o.outlineColor,h=o.outlineWidth,l=t.Color.floatToByte(u.red),c=t.Color.floatToByte(u.green),f=t.Color.floatToByte(u.blue),d=l*fv+c*pv+f,p=h/t.SDFSettings.RADIUS,v=t.Color.floatToByte(u.alpha)*fv+t.Color.floatToByte(p)*pv;e._instanced?(s=o._index,a(s,d,v)):(s=4*o._index,a(s+0,d+0,v),a(s+1,d+2,v),a(s+2,d+3,v),a(s+3,d+1,v))}function Sv(e,n,i,r,o){hv(e,0,0,r,o),mv(e,0,i,r,o),yv(e,0,i,r,o),wv(e,n,i,r,o),gv(e,0,i,r,o),bv(e,0,0,r,o),_v(e,0,0,r,o),xv(e,n,i,r,o),kv(e,n,i,r,o),function(e,n,i,r,o){if(!t.defined(e._batchTable))return;const s=r[Zp.a_batchId],a=o._batchIndex;let u;e._instanced?(u=o._index,s(u,a)):(u=4*o._index,s(u+0,a),s(u+1,a),s(u+2,a),s(u+3,a))}(e,0,0,r,o),$v(e,0,0,r,o),function(t,e,n,i,r){if(!t._sdf)return;const o=i[Zp.roadDirection],s=r.roadDirection;o(r._index,s.x,s.y,s.z,s.w)}(e,0,0,r,o)}function Ev(e,n,i,r,o,s){let a;r.mode===t.SceneMode.SCENE3D?(a=e._baseVolume,e._boundingVolumeDirty=!0):a=e._baseVolume2D;const u=[];for(let e=0;e<i;++e){const i=n[e],h=i.position,l=t.Billboard._computeActualPosition(i,h,r,o);t.defined(l)&&(i._setActualPosition(l),s?u.push(l):t.BoundingSphere.expand(a,l,a))}s&&t.BoundingSphere.fromPoints(u,a)}const Mv=[];ev.prototype.update=function(e){if(iv(this),!this.show)return;let n=this._billboards,i=n.length;const r=e.context;this._instanced=r.instancedArrays,Zp=this._instanced?tv:Jp,rv=this._instanced?sv:ov;let o=this._textureAtlas;if(!t.defined(o)){o=this._textureAtlas=new t.TextureAtlas({context:r});for(let t=0;t<i;++t)n[t]._loadImage()}const s=o.textureCoordinates;if(0===s.length)return;!function(e,n){const i=n.mode,r=e._billboards,o=e._billboardsToUpdate,s=e._modelMatrix;e._createVertexArray||e._mode!==i||i!==t.SceneMode.SCENE3D&&!t.Matrix4.equals(s,e.modelMatrix)?(e._mode=i,t.Matrix4.clone(e.modelMatrix,s),e._createVertexArray=!0,i!==t.SceneMode.SCENE3D&&i!==t.SceneMode.SCENE2D&&i!==t.SceneMode.COLUMBUS_VIEW||Ev(e,r,r.length,n,s,!0)):i===t.SceneMode.MORPHING?Ev(e,r,r.length,n,s,!0):i!==t.SceneMode.SCENE2D&&i!==t.SceneMode.COLUMBUS_VIEW||Ev(e,o,e._billboardsToUpdateIndex,n,s,!1)}(this,e),n=this._billboards,i=n.length;const a=this._billboardsToUpdate,u=this._billboardsToUpdateIndex,h=this._propertiesChanged,l=o.guid,c=this._createVertexArray||this._textureAtlasGUID!==l;let f;this._textureAtlasGUID=l;const d=e.passes,p=d.pick;if(c||!p&&this.computeNewBuffersUsage()){this._createVertexArray=!1;for(let t=0;t<Qp;++t)h[t]=0;if(this._vaf=this._vaf&&this._vaf.destroy(),i>0){this._vaf=function(e,n,i,r,o,s){const a=[{index:Zp.positionHighAndScale,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Rp]},{index:Zp.positionLowAndRotation,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Rp]},{index:Zp.compressedAttribute0,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Fp]},{index:Zp.compressedAttribute1,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Wp]},{index:Zp.compressedAttribute2,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[jp]},{index:Zp.eyeOffset,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Dp]},{index:Zp.scaleByDistance,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Hp]},{index:Zp.pixelOffsetScaleByDistance,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Vp]},{index:Zp.compressedAttribute3,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Gp]},{index:Zp.textureCoordinateBoundsOrLabelTranslate,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Kp]}];r&&a.push({index:Zp.direction,componentsPerAttribute:2,componentDatatype:t.ComponentDatatype.FLOAT,vertexBuffer:av(e)}),t.defined(o)&&a.push({index:Zp.a_batchId,componentsPerAttribute:1,componentDatatype:t.ComponentDatatype.FLOAT,bufferUsage:t.BufferUsage.STATIC_DRAW}),s&&(a.push({index:Zp.sdf,componentsPerAttribute:2,componentDatatype:t.ComponentDatatype.FLOAT,usage:i[Xp]}),a.push({index:Zp.roadDirection,componentsPerAttribute:4,componentDatatype:t.ComponentDatatype.FLOAT,usage:t.BufferUsage.STATIC_DRAW}));const u=r?n:4*n;return new t.VertexArrayFacade(e,a,u,r)}(r,i,this._buffersUsage,this._instanced,this._batchTable,this._sdf),f=this._vaf.writers;for(let t=0;t<i;++t){const n=this._billboards[t];n._dirty=!1,Sv(this,e,s,f,n)}this._vaf.commit(rv(r))}this._billboardsToUpdateIndex=0}else if(u>0){const t=Mv;t.length=0,(h[Rp]||h[Lp]||h[Up])&&t.push(hv),(h[qp]||h[Fp]||h[Pp]||h[Np]||h[zp])&&(t.push(mv),this._instanced&&t.push(gv)),(h[qp]||h[Bp]||h[Wp])&&(t.push(yv),t.push(wv)),(h[qp]||h[jp])&&t.push(wv),h[Dp]&&t.push(gv),h[Hp]&&t.push(bv),h[Vp]&&t.push(_v),(h[Gp]||h[Yp]||h[qp]||h[Rp])&&t.push(xv),(h[qp]||h[Rp])&&t.push(kv),h[Xp]&&t.push($v);const n=t.length;if(f=this._vaf.writers,u/i>.1){for(let i=0;i<u;++i){const r=a[i];r._dirty=!1;for(let i=0;i<n;++i)t[i](this,e,s,f,r)}this._vaf.commit(rv(r))}else{for(let i=0;i<u;++i){const r=a[i];r._dirty=!1;for(let i=0;i<n;++i)t[i](this,e,s,f,r);this._instanced?this._vaf.subCommit(r._index,1):this._vaf.subCommit(4*r._index,4)}this._vaf.endSubCommits()}this._billboardsToUpdateIndex=0}if(u>1.5*i&&(a.length=i),!t.defined(this._vaf)||!t.defined(this._vaf.va))return;let v;this._boundingVolumeDirty&&(this._boundingVolumeDirty=!1,t.BoundingSphere.transform(this._baseVolume,this.modelMatrix,this._baseVolumeWC));let m=t.Matrix4.IDENTITY;e.mode===t.SceneMode.SCENE3D?(m=this.modelMatrix,v=t.BoundingSphere.clone(this._baseVolumeWC,this._boundingVolume)):v=t.BoundingSphere.clone(this._baseVolume2D,this._boundingVolume),function(t,e,n){let i=1;t._allSizedInMeters&&0===t._maxPixelOffset||(i=e.camera.getPixelSize(n,e.context.drawingBufferWidth,e.context.drawingBufferHeight));let r=i*t._maxScale*t._maxSize*2;t._allHorizontalCenter&&t._allVerticalCenter&&(r*=.5);const o=i*t._maxPixelOffset+t._maxEyeOffset;n.radius+=r+o}(this,e,v);const y=this._blendOption!==this.blendOption;if(this._blendOption=this.blendOption,y){this._blendOption===t.BlendOption.OPAQUE||this._blendOption===t.BlendOption.OPAQUE_AND_TRANSLUCENT?this._rsOpaque=t.RenderState.fromCache({depthTest:{enabled:!0,func:t.WebGLConstants.LESS},depthMask:!0}):this._rsOpaque=void 0;const e=this._blendOption===t.BlendOption.TRANSLUCENT;this._blendOption===t.BlendOption.TRANSLUCENT||this._blendOption===t.BlendOption.OPAQUE_AND_TRANSLUCENT?this._rsTranslucent=t.RenderState.fromCache({depthTest:{enabled:!1,func:e?t.WebGLConstants.LEQUAL:t.WebGLConstants.LESS},depthMask:!1,blending:t.BlendingState.ALPHA_BLEND}):this._rsTranslucent=void 0}let w,g,b,_,x;this._shaderDisableDepthDistance=this._shaderDisableDepthDistance||0!==e.minimumDisableDepthTestDistance;const k=t.ContextLimits.maximumVertexTextureImageUnits>0;if(y||this._shaderRotation!==this._compiledShaderRotation||this._shaderAlignedAxis!==this._compiledShaderAlignedAxis||this._shaderScaleByDistance!==this._compiledShaderScaleByDistance||this._shaderTranslucencyByDistance!==this._compiledShaderTranslucencyByDistance||this._shaderPixelOffsetScaleByDistance!==this._compiledShaderPixelOffsetScaleByDistance||this._shaderDistanceDisplayCondition!==this._compiledShaderDistanceDisplayCondition||this._shaderDisableDepthDistance!==this._compiledShaderDisableDepthDistance||this._shaderClampToGround!==this._compiledShaderClampToGround||this._sdf!==this._compiledSDF){w="#ifdef INSTANCED\nin vec2 direction;\n#endif\nin vec4 positionHighAndScale;in vec4 positionLowAndRotation;in vec4 compressedAttribute0;in vec4 compressedAttribute1;in vec4 compressedAttribute2;in vec4 eyeOffset;in vec4 scaleByDistance;in vec4 pixelOffsetScaleByDistance;in vec4 compressedAttribute3;in vec2 sdf;\n#if defined(VERTEX_DEPTH_CHECK) || defined(FRAGMENT_DEPTH_CHECK)\nin vec4 textureCoordinateBoundsOrLabelTranslate;\n#endif\n#ifdef VECTOR_TILE\nin float a_batchId;\n#endif\n#ifdef SDF\nin vec4 roadDirection;\n#endif\nout vec2 v_textureCoordinates;\n#ifdef FRAGMENT_DEPTH_CHECK\nout vec4 v_textureCoordinateBounds;out vec4 v_originTextureCoordinateAndTranslate;out vec4 v_compressed;out mat2 v_rotationMatrix;\n#endif\nout vec4 v_pickColor;out vec4 v_color;\n#ifdef SDF\nout vec4 v_outlineColor;out float v_outlineWidth;\n#endif\nout float v_discard;const float UPPER_BOUND=32768.0;const float SHIFT_LEFT16=65536.0;const float SHIFT_LEFT12=4096.0;const float SHIFT_LEFT8=256.0;const float SHIFT_LEFT7=128.0;const float SHIFT_LEFT5=32.0;const float SHIFT_LEFT3=8.0;const float SHIFT_LEFT2=4.0;const float SHIFT_LEFT1=2.0;const float SHIFT_RIGHT12=1.0/4096.0;const float SHIFT_RIGHT8=1.0/256.0;const float SHIFT_RIGHT7=1.0/128.0;const float SHIFT_RIGHT5=1.0/32.0;const float SHIFT_RIGHT3=1.0/8.0;const float SHIFT_RIGHT2=1.0/4.0;const float SHIFT_RIGHT1=1.0/2.0;vec4 addScreenSpaceOffset(vec4 positionEC,vec2 imageSize,float scale,vec2 direction,vec2 origin,vec2 translate,vec2 pixelOffset,vec3 alignedAxis,bool validAlignedAxis,float rotation,bool sizeInMeters,out mat2 rotationMatrix,out float mpp){vec2 halfSize=imageSize*scale*0.5;halfSize*=((direction*2.0)-1.0);vec2 originTranslate=origin*abs(halfSize);\n#if defined(ROTATION) || defined(ALIGNED_AXIS)\nif(validAlignedAxis||rotation!=0.0){float angle=rotation;if(validAlignedAxis){vec4 projectedAlignedAxis=czm_modelView3D*vec4(alignedAxis,0.0);angle+=sign(-projectedAlignedAxis.x)*acos(sign(projectedAlignedAxis.y)*(projectedAlignedAxis.y*projectedAlignedAxis.y)/(projectedAlignedAxis.x*projectedAlignedAxis.x+projectedAlignedAxis.y*projectedAlignedAxis.y));}float cosTheta=cos(angle);float sinTheta=sin(angle);rotationMatrix=mat2(cosTheta,sinTheta,-sinTheta,cosTheta);halfSize=rotationMatrix*halfSize;}else{rotationMatrix=mat2(1.0,0.0,0.0,1.0);}\n#endif\nmpp=czm_metersPerPixel(positionEC);positionEC.xy+=(originTranslate+halfSize)*czm_branchFreeTernary(sizeInMeters,1.0,mpp);positionEC.xy+=(translate+pixelOffset)*mpp;return positionEC;}float getGlobeDepth(vec4 positionEC){vec4 posWC=czm_eyeToWindowCoordinates(positionEC);float globeDepth=czm_unpackDepth(texture(czm_globeDepthTexture,posWC.xy/czm_viewport.zw));if(globeDepth==0.0){return 0.0;}vec4 eyeCoordinate=czm_windowToEyeCoordinates(posWC.xy,globeDepth);return eyeCoordinate.z/eyeCoordinate.w;}float crossProduct(vec2 a,vec2 b){return a.x*b.y-a.y*b.x;}void main(){vec3 positionHigh=positionHighAndScale.xyz;vec3 positionLow=positionLowAndRotation.xyz;float scale=positionHighAndScale.w;\n#if defined(ROTATION) || defined(ALIGNED_AXIS)\nfloat rotation=positionLowAndRotation.w;\n#else\nfloat rotation=0.0;\n#endif\nfloat compressed=compressedAttribute0.x;vec2 pixelOffset;pixelOffset.x=floor(compressed*SHIFT_RIGHT7);compressed-=pixelOffset.x*SHIFT_LEFT7;pixelOffset.x-=UPPER_BOUND;vec2 origin;origin.x=floor(compressed*SHIFT_RIGHT5);compressed-=origin.x*SHIFT_LEFT5;origin.y=floor(compressed*SHIFT_RIGHT3);compressed-=origin.y*SHIFT_LEFT3;\n#ifdef FRAGMENT_DEPTH_CHECK\nvec2 depthOrigin=origin.xy;\n#endif\norigin-=vec2(1.0);float show=floor(compressed*SHIFT_RIGHT2);compressed-=show*SHIFT_LEFT2;\n#ifdef INSTANCED\nvec2 textureCoordinatesBottomLeft=czm_decompressTextureCoordinates(compressedAttribute0.w);vec2 textureCoordinatesRange=czm_decompressTextureCoordinates(eyeOffset.w);vec2 textureCoordinates=textureCoordinatesBottomLeft+direction*textureCoordinatesRange;\n#else\nvec2 direction;direction.x=floor(compressed*SHIFT_RIGHT1);direction.y=compressed-direction.x*SHIFT_LEFT1;vec2 textureCoordinates=czm_decompressTextureCoordinates(compressedAttribute0.w);\n#endif\nfloat temp=compressedAttribute0.y*SHIFT_RIGHT8;pixelOffset.y=-(floor(temp)-UPPER_BOUND);vec2 translate;translate.y=(temp-floor(temp))*SHIFT_LEFT16;temp=compressedAttribute0.z*SHIFT_RIGHT8;translate.x=floor(temp)-UPPER_BOUND;translate.y+=(temp-floor(temp))*SHIFT_LEFT8;translate.y-=UPPER_BOUND;temp=compressedAttribute1.x*SHIFT_RIGHT8;float temp2=floor(compressedAttribute2.w*SHIFT_RIGHT2);vec2 imageSize=vec2(floor(temp),temp2);\n#ifdef FRAGMENT_DEPTH_CHECK\nfloat labelHorizontalOrigin=floor(compressedAttribute2.w-(temp2*SHIFT_LEFT2));float applyTranslate=0.0;if(labelHorizontalOrigin!=0.0){applyTranslate=1.0;labelHorizontalOrigin-=2.0;depthOrigin.x=labelHorizontalOrigin+1.0;}depthOrigin=vec2(1.0)-(depthOrigin*0.5);\n#endif\n#ifdef EYE_DISTANCE_TRANSLUCENCY\nvec4 translucencyByDistance;translucencyByDistance.x=compressedAttribute1.z;translucencyByDistance.z=compressedAttribute1.w;translucencyByDistance.y=((temp-floor(temp))*SHIFT_LEFT8)/255.0;temp=compressedAttribute1.y*SHIFT_RIGHT8;translucencyByDistance.w=((temp-floor(temp))*SHIFT_LEFT8)/255.0;\n#endif\n#if defined(VERTEX_DEPTH_CHECK) || defined(FRAGMENT_DEPTH_CHECK)\ntemp=compressedAttribute3.w;temp=temp*SHIFT_RIGHT12;vec2 dimensions;dimensions.y=(temp-floor(temp))*SHIFT_LEFT12;dimensions.x=floor(temp);\n#endif\n#ifdef ALIGNED_AXIS\nvec3 alignedAxis=czm_octDecode(floor(compressedAttribute1.y*SHIFT_RIGHT8));temp=compressedAttribute2.z*SHIFT_RIGHT5;bool validAlignedAxis=(temp-floor(temp))*SHIFT_LEFT1>0.0;\n#else\nvec3 alignedAxis=vec3(0.0);bool validAlignedAxis=false;\n#endif\nvec4 pickColor;vec4 color;temp=compressedAttribute2.y;temp=temp*SHIFT_RIGHT8;pickColor.b=(temp-floor(temp))*SHIFT_LEFT8;temp=floor(temp)*SHIFT_RIGHT8;pickColor.g=(temp-floor(temp))*SHIFT_LEFT8;pickColor.r=floor(temp);temp=compressedAttribute2.x;temp=temp*SHIFT_RIGHT8;color.b=(temp-floor(temp))*SHIFT_LEFT8;temp=floor(temp)*SHIFT_RIGHT8;color.g=(temp-floor(temp))*SHIFT_LEFT8;color.r=floor(temp);temp=compressedAttribute2.z*SHIFT_RIGHT8;bool sizeInMeters=floor((temp-floor(temp))*SHIFT_LEFT7)>0.0;temp=floor(temp)*SHIFT_RIGHT8;pickColor.a=(temp-floor(temp))*SHIFT_LEFT8;pickColor/=255.0;color.a=floor(temp);color/=255.0;vec4 p=czm_translateRelativeToEye(positionHigh,positionLow);vec4 positionEC=czm_modelViewRelativeToEye*p;\n#if defined(FRAGMENT_DEPTH_CHECK) || defined(VERTEX_DEPTH_CHECK)\nfloat eyeDepth=positionEC.z;\n#endif\npositionEC=czm_eyeOffset(positionEC,eyeOffset.xyz);positionEC.xyz*=show;vec4 rawPosition=positionEC;\n#if defined(EYE_DISTANCE_SCALING) || defined(EYE_DISTANCE_TRANSLUCENCY) || defined(EYE_DISTANCE_PIXEL_OFFSET) || defined(DISTANCE_DISPLAY_CONDITION) || defined(DISABLE_DEPTH_DISTANCE)\nfloat lengthSq;if(czm_sceneMode==czm_sceneMode2D){lengthSq=czm_eyeHeight2D.y;}else{lengthSq=dot(positionEC.xyz,positionEC.xyz);}\n#endif\n#ifdef EYE_DISTANCE_SCALING\nfloat distanceScale=czm_nearFarScalar(scaleByDistance,lengthSq);scale*=distanceScale;translate*=distanceScale;if(scale==0.0){positionEC.xyz=vec3(0.0);}\n#endif\nfloat translucency=1.0;\n#ifdef EYE_DISTANCE_TRANSLUCENCY\ntranslucency=czm_nearFarScalar(translucencyByDistance,lengthSq);if(translucency==0.0){positionEC.xyz=vec3(0.0);}\n#endif\n#ifdef EYE_DISTANCE_PIXEL_OFFSET\nfloat pixelOffsetScale=czm_nearFarScalar(pixelOffsetScaleByDistance,lengthSq);pixelOffset*=pixelOffsetScale;\n#endif\n#ifdef DISTANCE_DISPLAY_CONDITION\nfloat nearSq=compressedAttribute3.x;float farSq=compressedAttribute3.y;if(lengthSq<nearSq||lengthSq>farSq){positionEC.xyz=vec3(0.0);}\n#endif\nmat2 rotationMatrix;float mpp;\n#ifdef DISABLE_DEPTH_DISTANCE\nfloat disableDepthTestDistance=compressedAttribute3.z;\n#endif\n#ifdef VERTEX_DEPTH_CHECK\nif(lengthSq<disableDepthTestDistance){float depthsilon=10.0;vec2 labelTranslate=textureCoordinateBoundsOrLabelTranslate.xy;vec4 pEC1=addScreenSpaceOffset(positionEC,dimensions,scale,vec2(0.0),origin,labelTranslate,pixelOffset,alignedAxis,validAlignedAxis,rotation,sizeInMeters,rotationMatrix,mpp);float globeDepth1=getGlobeDepth(pEC1);if(globeDepth1!=0.0&&pEC1.z+depthsilon<globeDepth1){vec4 pEC2=addScreenSpaceOffset(positionEC,dimensions,scale,vec2(0.0,1.0),origin,labelTranslate,pixelOffset,alignedAxis,validAlignedAxis,rotation,sizeInMeters,rotationMatrix,mpp);float globeDepth2=getGlobeDepth(pEC2);if(globeDepth2!=0.0&&pEC2.z+depthsilon<globeDepth2){vec4 pEC3=addScreenSpaceOffset(positionEC,dimensions,scale,vec2(1.0),origin,labelTranslate,pixelOffset,alignedAxis,validAlignedAxis,rotation,sizeInMeters,rotationMatrix,mpp);float globeDepth3=getGlobeDepth(pEC3);if(globeDepth3!=0.0&&pEC3.z+depthsilon<globeDepth3){positionEC.xyz=vec3(0.0);}}}}\n#endif\npositionEC=addScreenSpaceOffset(positionEC,imageSize,scale,direction,origin,translate,pixelOffset,alignedAxis,validAlignedAxis,rotation,sizeInMeters,rotationMatrix,mpp);\n#ifdef SDF\nif(roadDirection.w>0.0){vec4 projectedPosition=czm_projection*rawPosition;vec4 worldPosition=czm_inverseView*rawPosition;vec4 endPosition=vec4(worldPosition.xyz+roadDirection.xyz,1.0);vec4 projectedEndPosition=czm_viewProjection*endPosition;vec4 ndcPos=projectedPosition/projectedPosition.w;vec4 ndcEndPos=projectedEndPosition/projectedEndPosition.w;vec2 screenPos=(czm_viewportTransformation*ndcPos).xy;vec2 screenEndPos=(czm_viewportTransformation*ndcEndPos).xy;vec2 screenDir=normalize(screenEndPos-screenPos);vec2 originDir=vec2(1.0,0.0);float cosThetaValue=dot(originDir,screenDir);float sign=crossProduct(originDir,screenDir);float theta=czm_branchFreeTernary(sign>0.0,1.0,-1.0)*acos(cosThetaValue);if(theta>czm_piOverTwo){theta=theta-czm_pi;}if(theta<-czm_piOverTwo){theta=theta+czm_pi;}float cosTheta=cos(theta);float sinTheta=sin(theta);mat4 T=mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0,0.0,-rawPosition.x,-rawPosition.y,-rawPosition.z,1.0);mat4 R=mat4(cosTheta,sinTheta,0.0,0.0,-sinTheta,cosTheta,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0);mat4 invT=mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0,0.0,rawPosition.x,rawPosition.y,rawPosition.z,1.0);positionEC=invT*R*T*positionEC;}\n#endif\ngl_Position=czm_projection*positionEC;v_textureCoordinates=textureCoordinates;\n#ifdef LOG_DEPTH\nczm_vertexLogDepth();\n#endif\n#ifdef DISABLE_DEPTH_DISTANCE\nif(disableDepthTestDistance==0.0&&czm_minimumDisableDepthTestDistance!=0.0){disableDepthTestDistance=czm_minimumDisableDepthTestDistance;}if(disableDepthTestDistance!=0.0){float zclip=gl_Position.z/gl_Position.w;bool clipped=(zclip<-1.0||zclip>1.0);if(!clipped&&(disableDepthTestDistance<0.0||(lengthSq>0.0&&lengthSq<disableDepthTestDistance))){gl_Position.z=-gl_Position.w;\n#ifdef LOG_DEPTH\nv_depthFromNearPlusOne=1.0;\n#endif\n}}\n#endif\n#ifdef FRAGMENT_DEPTH_CHECK\nif(sizeInMeters){translate/=mpp;dimensions/=mpp;imageSize/=mpp;}\n#if defined(ROTATION) || defined(ALIGNED_AXIS)\nv_rotationMatrix=rotationMatrix;\n#else\nv_rotationMatrix=mat2(1.0,0.0,0.0,1.0);\n#endif\nfloat enableDepthCheck=0.0;if(lengthSq<disableDepthTestDistance){enableDepthCheck=1.0;}float dw=floor(clamp(dimensions.x,0.0,SHIFT_LEFT12));float dh=floor(clamp(dimensions.y,0.0,SHIFT_LEFT12));float iw=floor(clamp(imageSize.x,0.0,SHIFT_LEFT12));float ih=floor(clamp(imageSize.y,0.0,SHIFT_LEFT12));v_compressed.x=eyeDepth;v_compressed.y=applyTranslate*SHIFT_LEFT1+enableDepthCheck;v_compressed.z=dw*SHIFT_LEFT12+dh;v_compressed.w=iw*SHIFT_LEFT12+ih;v_originTextureCoordinateAndTranslate.xy=depthOrigin;v_originTextureCoordinateAndTranslate.zw=translate;v_textureCoordinateBounds=textureCoordinateBoundsOrLabelTranslate;\n#endif\n#ifdef SDF\nvec4 outlineColor;float outlineWidth;temp=sdf.x;temp=temp*SHIFT_RIGHT8;outlineColor.b=(temp-floor(temp))*SHIFT_LEFT8;temp=floor(temp)*SHIFT_RIGHT8;outlineColor.g=(temp-floor(temp))*SHIFT_LEFT8;outlineColor.r=floor(temp);temp=sdf.y;temp=temp*SHIFT_RIGHT8;float temp3=(temp-floor(temp))*SHIFT_LEFT8;temp=floor(temp)*SHIFT_RIGHT8;outlineWidth=(temp-floor(temp))*SHIFT_LEFT8;outlineColor.a=floor(temp);outlineColor/=255.0;v_outlineWidth=outlineWidth/255.0;v_outlineColor=outlineColor;v_outlineColor.a*=translucency;\n#endif\nv_pickColor=pickColor;v_color=color;v_color.a*=translucency;v_discard=0.0;if(lengthSq<disableDepthTestDistance){float sceneDepth=getGlobeDepth(rawPosition);if(positionEC.z+10.<sceneDepth){v_discard=1.0;}}}",g="uniform sampler2D u_atlas;\n#ifdef VECTOR_TILE\nuniform vec4 u_highlightColor;\n#endif\nin vec2 v_textureCoordinates;in vec4 v_pickColor;in vec4 v_color;\n#ifdef SDF\nin vec4 v_outlineColor;in float v_outlineWidth;\n#endif\nin float v_discard;\n#ifdef FRAGMENT_DEPTH_CHECK\nin vec4 v_textureCoordinateBounds;in vec4 v_originTextureCoordinateAndTranslate;in vec4 v_compressed;in mat2 v_rotationMatrix;const float SHIFT_LEFT12=4096.0;const float SHIFT_LEFT1=2.0;const float SHIFT_RIGHT12=1.0/4096.0;const float SHIFT_RIGHT1=1.0/2.0;float getGlobeDepth(vec2 adjustedST,vec2 depthLookupST,bool applyTranslate,vec2 dimensions,vec2 imageSize){vec2 lookupVector=imageSize*(depthLookupST-adjustedST);lookupVector=v_rotationMatrix*lookupVector;vec2 labelOffset=(dimensions-imageSize)*(depthLookupST-vec2(0.0,v_originTextureCoordinateAndTranslate.y));vec2 translation=v_originTextureCoordinateAndTranslate.zw;if(applyTranslate){translation+=(dimensions*v_originTextureCoordinateAndTranslate.xy*vec2(1.0,0.0));}vec2 st=((lookupVector-translation+labelOffset)+gl_FragCoord.xy)/czm_viewport.zw;float logDepthOrDepth=czm_unpackDepth(texture(czm_globeDepthTexture,st));if(logDepthOrDepth==0.0){return 0.0;}vec4 eyeCoordinate=czm_windowToEyeCoordinates(gl_FragCoord.xy,logDepthOrDepth);return eyeCoordinate.z/eyeCoordinate.w;}\n#endif\n#ifdef SDF\nfloat getDistance(vec2 position){return texture(u_atlas,position).r;}vec4 getSDFColor(vec2 position,float outlineWidth,vec4 outlineColor,float smoothing){float distance=getDistance(position);if(outlineWidth>0.0){float outlineEdge=clamp(SDF_EDGE-outlineWidth,0.0,SDF_EDGE);float outlineFactor=smoothstep(SDF_EDGE-smoothing,SDF_EDGE+smoothing,distance);vec4 sdfColor=mix(outlineColor,v_color,outlineFactor);float alpha=smoothstep(outlineEdge-smoothing,outlineEdge+smoothing,distance);return vec4(sdfColor.rgb,sdfColor.a*alpha);}else{float alpha=smoothstep(SDF_EDGE-smoothing,SDF_EDGE+smoothing,distance);return vec4(v_color.rgb,v_color.a*alpha);}}\n#endif\nvoid main(){if(v_discard>0.0){discard;return;}vec4 color=texture(u_atlas,v_textureCoordinates);\n#ifdef SDF\nfloat outlineWidth=v_outlineWidth;vec4 outlineColor=v_outlineColor;float distance=getDistance(v_textureCoordinates);\n#if (__VERSION__ == 300 || defined(GL_OES_standard_derivatives))\nfloat smoothing=fwidth(distance);vec2 sampleOffset=0.354*vec2(dFdx(v_textureCoordinates)+dFdy(v_textureCoordinates));vec4 center=getSDFColor(v_textureCoordinates,outlineWidth,outlineColor,smoothing);vec4 color1=getSDFColor(v_textureCoordinates+vec2(sampleOffset.x,sampleOffset.y),outlineWidth,outlineColor,smoothing);vec4 color2=getSDFColor(v_textureCoordinates+vec2(-sampleOffset.x,sampleOffset.y),outlineWidth,outlineColor,smoothing);vec4 color3=getSDFColor(v_textureCoordinates+vec2(-sampleOffset.x,-sampleOffset.y),outlineWidth,outlineColor,smoothing);vec4 color4=getSDFColor(v_textureCoordinates+vec2(sampleOffset.x,-sampleOffset.y),outlineWidth,outlineColor,smoothing);color=(center+color1+color2+color3+color4)/5.0;\n#else\nfloat smoothing=1.0/32.0;color=getSDFColor(v_textureCoordinates,outlineWidth,outlineColor,smoothing);\n#endif\ncolor=czm_gammaCorrect(color);\n#else\ncolor=czm_gammaCorrect(color);color*=czm_gammaCorrect(v_color);\n#endif\n#if !defined(OPAQUE) && !defined(TRANSLUCENT)\nif(color.a<0.005){discard;}\n#else\n#ifdef OPAQUE\nif(color.a<0.995){discard;}\n#else\nif(color.a>=0.995){discard;}\n#endif\n#endif\n#ifdef VECTOR_TILE\ncolor*=u_highlightColor;\n#endif\nout_FragColor=color;\n#ifdef LOG_DEPTH\nczm_writeLogDepth();\n#endif\n}",x=[],t.defined(this._batchTable)&&(x.push("VECTOR_TILE"),w=this._batchTable.getVertexShaderCallback(!1,"a_batchId",void 0)(w),g=this._batchTable.getFragmentShaderCallback(!1,void 0)(g)),b=new t.ShaderSource({defines:x,sources:[w]}),this._instanced&&b.defines.push("INSTANCED"),this._shaderRotation&&b.defines.push("ROTATION"),this._shaderAlignedAxis&&b.defines.push("ALIGNED_AXIS"),this._shaderScaleByDistance&&b.defines.push("EYE_DISTANCE_SCALING"),this._shaderTranslucencyByDistance&&b.defines.push("EYE_DISTANCE_TRANSLUCENCY"),this._shaderPixelOffsetScaleByDistance&&b.defines.push("EYE_DISTANCE_PIXEL_OFFSET"),this._shaderDistanceDisplayCondition&&b.defines.push("DISTANCE_DISPLAY_CONDITION"),this._shaderDisableDepthDistance&&b.defines.push("DISABLE_DEPTH_DISTANCE"),this._shaderClampToGround&&(k?b.defines.push("VERTEX_DEPTH_CHECK"):b.defines.push("FRAGMENT_DEPTH_CHECK"));const e=1-t.SDFSettings.CUTOFF;this._sdf&&b.defines.push("SDF");const n=t.defined(this._batchTable)?"VECTOR_TILE":"";this._blendOption===t.BlendOption.OPAQUE_AND_TRANSLUCENT&&(_=new t.ShaderSource({defines:["OPAQUE",n],sources:[g]}),this._shaderClampToGround&&(k?_.defines.push("VERTEX_DEPTH_CHECK"):_.defines.push("FRAGMENT_DEPTH_CHECK")),this._sdf&&(_.defines.push("SDF"),_.defines.push(`SDF_EDGE ${e}`)),this._sp=t.ShaderProgram.replaceCache({context:r,shaderProgram:this._sp,vertexShaderSource:b,fragmentShaderSource:_,attributeLocations:Zp}),_=new t.ShaderSource({defines:["TRANSLUCENT",n],sources:[g]}),this._shaderClampToGround&&(k?_.defines.push("VERTEX_DEPTH_CHECK"):_.defines.push("FRAGMENT_DEPTH_CHECK")),this._sdf&&(_.defines.push("SDF"),_.defines.push(`SDF_EDGE ${e}`)),this._spTranslucent=t.ShaderProgram.replaceCache({context:r,shaderProgram:this._spTranslucent,vertexShaderSource:b,fragmentShaderSource:_,attributeLocations:Zp})),this._blendOption===t.BlendOption.OPAQUE&&(_=new t.ShaderSource({defines:[n],sources:[g]}),this._shaderClampToGround&&(k?_.defines.push("VERTEX_DEPTH_CHECK"):_.defines.push("FRAGMENT_DEPTH_CHECK")),this._sdf&&(_.defines.push("SDF"),_.defines.push(`SDF_EDGE ${e}`)),this._sp=t.ShaderProgram.replaceCache({context:r,shaderProgram:this._sp,vertexShaderSource:b,fragmentShaderSource:_,attributeLocations:Zp})),this._blendOption===t.BlendOption.TRANSLUCENT&&(_=new t.ShaderSource({defines:[n],sources:[g]}),this._shaderClampToGround&&(k?_.defines.push("VERTEX_DEPTH_CHECK"):_.defines.push("FRAGMENT_DEPTH_CHECK")),this._sdf&&(_.defines.push("SDF"),_.defines.push(`SDF_EDGE ${e}`)),this._spTranslucent=t.ShaderProgram.replaceCache({context:r,shaderProgram:this._spTranslucent,vertexShaderSource:b,fragmentShaderSource:_,attributeLocations:Zp})),this._compiledShaderRotation=this._shaderRotation,this._compiledShaderAlignedAxis=this._shaderAlignedAxis,this._compiledShaderScaleByDistance=this._shaderScaleByDistance,this._compiledShaderTranslucencyByDistance=this._shaderTranslucencyByDistance,this._compiledShaderPixelOffsetScaleByDistance=this._shaderPixelOffsetScaleByDistance,this._compiledShaderDistanceDisplayCondition=this._shaderDistanceDisplayCondition,this._compiledShaderDisableDepthDistance=this._shaderDisableDepthDistance,this._compiledShaderClampToGround=this._shaderClampToGround,this._compiledSDF=this._sdf}const $=e.commandList;if(d.render||d.pick){const n=this._colorCommands,r=this._blendOption===t.BlendOption.OPAQUE,o=this._blendOption===t.BlendOption.OPAQUE_AND_TRANSLUCENT,s=this._vaf.va,a=s.length;let u,h=this._uniforms;t.defined(this._batchTable)?(h=this._batchTable.getUniformMapCallback()(h),u=this._batchTable.getPickId()):u="v_pickColor",n.length=a;const l=o?2*a:a;for(let e=0;e<l;++e){let a=n[e];t.defined(a)||(a=n[e]=new t.DrawCommand);const l=r||o&&e%2==0;a.pass=l||!o?t.Pass.OPAQUE:t.Pass.TRANSLUCENT,a.owner=this;const c=o?Math.floor(e/2):e;a.boundingVolume=v,a.modelMatrix=m,a.count=s[c].indicesCount,a.shaderProgram=l?this._sp:this._spTranslucent,a.uniformMap=h,a.vertexArray=s[c].va,a.renderState=l?this._rsOpaque:this._rsTranslucent,a.debugShowBoundingVolume=this.debugShowBoundingVolume,a.pickId=u,this._instanced&&(a.count=6,a.instanceCount=i),$.push(a)}this.debugShowTextureAtlas&&(t.defined(this.debugCommand)||(this.debugCommand=function(e,n){const i=n.createViewportQuadCommand("uniform sampler2D billboard_texture; \nin vec2 v_textureCoordinates; \nvoid main() \n{ \n    out_FragColor = texture(billboard_texture, v_textureCoordinates); \n} \n",{uniformMap:{billboard_texture:function(){return e._textureAtlas.texture}}});return i.pass=t.Pass.OVERLAY,i}(this,e.context)),$.push(this.debugCommand))}},ev.prototype.isDestroyed=function(){return!1},ev.prototype.destroy=function(){return t.defined(this._removeCallbackFunc)&&(this._removeCallbackFunc(),this._removeCallbackFunc=void 0),this._textureAtlas=this._destroyTextureAtlas&&this._textureAtlas&&this._textureAtlas.destroy(),this._sp=this._sp&&this._sp.destroy(),this._spTranslucent=this._spTranslucent&&this._spTranslucent.destroy(),this._vaf=this._vaf&&this._vaf.destroy(),nv(this._billboards),t.destroyObject(this)};var Cv,Av,Ov={exports:{}},Iv=(Cv||(Cv=1,(Av=Ov).exports&&(Av.exports=function(){var t=3,e=4,n=12,i=13,r=16,o=17;function s(t,e){void 0===e&&(e=0);var n=t.charCodeAt(e);if(55296<=n&&n<=56319&&e<t.length-1){var i=n;return 56320<=(r=t.charCodeAt(e+1))&&r<=57343?1024*(i-55296)+(r-56320)+65536:i}if(56320<=n&&n<=57343&&e>=1){var r=n;return 55296<=(i=t.charCodeAt(e-1))&&i<=56319?1024*(i-55296)+(r-56320)+65536:r}return n}function a(s,a,u){var h=[s].concat(a).concat([u]),l=h[h.length-2],c=u,f=h.lastIndexOf(14);if(f>1&&h.slice(1,f).every((function(e){return e==t}))&&-1==[t,i,o].indexOf(s))return 2;var d=h.lastIndexOf(e);if(d>0&&h.slice(1,d).every((function(t){return t==e}))&&-1==[n,e].indexOf(l))return h.filter((function(t){return t==e})).length%2==1?3:4;if(0==l&&1==c)return 0;if(2==l||0==l||1==l)return 14==c&&a.every((function(e){return e==t}))?2:1;if(2==c||0==c||1==c)return 1;if(6==l&&(6==c||7==c||9==c||10==c))return 0;if(!(9!=l&&7!=l||7!=c&&8!=c))return 0;if((10==l||8==l)&&8==c)return 0;if(c==t||15==c)return 0;if(5==c)return 0;if(l==n)return 0;var p=-1!=h.indexOf(t)?h.lastIndexOf(t)-1:h.length-2;return-1!=[i,o].indexOf(h[p])&&h.slice(p+1,-1).every((function(e){return e==t}))&&14==c||15==l&&-1!=[r,o].indexOf(c)?0:-1!=a.indexOf(e)?2:l==e&&c==e?0:1}function u(s){return 1536<=s&&s<=1541||1757==s||1807==s||2274==s||3406==s||69821==s||70082<=s&&s<=70083||72250==s||72326<=s&&s<=72329||73030==s?n:13==s?0:10==s?1:0<=s&&s<=9||11<=s&&s<=12||14<=s&&s<=31||127<=s&&s<=159||173==s||1564==s||6158==s||8203==s||8206<=s&&s<=8207||8232==s||8233==s||8234<=s&&s<=8238||8288<=s&&s<=8292||8293==s||8294<=s&&s<=8303||55296<=s&&s<=57343||65279==s||65520<=s&&s<=65528||65529<=s&&s<=65531||113824<=s&&s<=113827||119155<=s&&s<=119162||917504==s||917505==s||917506<=s&&s<=917535||917632<=s&&s<=917759||918e3<=s&&s<=921599?2:768<=s&&s<=879||1155<=s&&s<=1159||1160<=s&&s<=1161||1425<=s&&s<=1469||1471==s||1473<=s&&s<=1474||1476<=s&&s<=1477||1479==s||1552<=s&&s<=1562||1611<=s&&s<=1631||1648==s||1750<=s&&s<=1756||1759<=s&&s<=1764||1767<=s&&s<=1768||1770<=s&&s<=1773||1809==s||1840<=s&&s<=1866||1958<=s&&s<=1968||2027<=s&&s<=2035||2070<=s&&s<=2073||2075<=s&&s<=2083||2085<=s&&s<=2087||2089<=s&&s<=2093||2137<=s&&s<=2139||2260<=s&&s<=2273||2275<=s&&s<=2306||2362==s||2364==s||2369<=s&&s<=2376||2381==s||2385<=s&&s<=2391||2402<=s&&s<=2403||2433==s||2492==s||2494==s||2497<=s&&s<=2500||2509==s||2519==s||2530<=s&&s<=2531||2561<=s&&s<=2562||2620==s||2625<=s&&s<=2626||2631<=s&&s<=2632||2635<=s&&s<=2637||2641==s||2672<=s&&s<=2673||2677==s||2689<=s&&s<=2690||2748==s||2753<=s&&s<=2757||2759<=s&&s<=2760||2765==s||2786<=s&&s<=2787||2810<=s&&s<=2815||2817==s||2876==s||2878==s||2879==s||2881<=s&&s<=2884||2893==s||2902==s||2903==s||2914<=s&&s<=2915||2946==s||3006==s||3008==s||3021==s||3031==s||3072==s||3134<=s&&s<=3136||3142<=s&&s<=3144||3146<=s&&s<=3149||3157<=s&&s<=3158||3170<=s&&s<=3171||3201==s||3260==s||3263==s||3266==s||3270==s||3276<=s&&s<=3277||3285<=s&&s<=3286||3298<=s&&s<=3299||3328<=s&&s<=3329||3387<=s&&s<=3388||3390==s||3393<=s&&s<=3396||3405==s||3415==s||3426<=s&&s<=3427||3530==s||3535==s||3538<=s&&s<=3540||3542==s||3551==s||3633==s||3636<=s&&s<=3642||3655<=s&&s<=3662||3761==s||3764<=s&&s<=3769||3771<=s&&s<=3772||3784<=s&&s<=3789||3864<=s&&s<=3865||3893==s||3895==s||3897==s||3953<=s&&s<=3966||3968<=s&&s<=3972||3974<=s&&s<=3975||3981<=s&&s<=3991||3993<=s&&s<=4028||4038==s||4141<=s&&s<=4144||4146<=s&&s<=4151||4153<=s&&s<=4154||4157<=s&&s<=4158||4184<=s&&s<=4185||4190<=s&&s<=4192||4209<=s&&s<=4212||4226==s||4229<=s&&s<=4230||4237==s||4253==s||4957<=s&&s<=4959||5906<=s&&s<=5908||5938<=s&&s<=5940||5970<=s&&s<=5971||6002<=s&&s<=6003||6068<=s&&s<=6069||6071<=s&&s<=6077||6086==s||6089<=s&&s<=6099||6109==s||6155<=s&&s<=6157||6277<=s&&s<=6278||6313==s||6432<=s&&s<=6434||6439<=s&&s<=6440||6450==s||6457<=s&&s<=6459||6679<=s&&s<=6680||6683==s||6742==s||6744<=s&&s<=6750||6752==s||6754==s||6757<=s&&s<=6764||6771<=s&&s<=6780||6783==s||6832<=s&&s<=6845||6846==s||6912<=s&&s<=6915||6964==s||6966<=s&&s<=6970||6972==s||6978==s||7019<=s&&s<=7027||7040<=s&&s<=7041||7074<=s&&s<=7077||7080<=s&&s<=7081||7083<=s&&s<=7085||7142==s||7144<=s&&s<=7145||7149==s||7151<=s&&s<=7153||7212<=s&&s<=7219||7222<=s&&s<=7223||7376<=s&&s<=7378||7380<=s&&s<=7392||7394<=s&&s<=7400||7405==s||7412==s||7416<=s&&s<=7417||7616<=s&&s<=7673||7675<=s&&s<=7679||8204==s||8400<=s&&s<=8412||8413<=s&&s<=8416||8417==s||8418<=s&&s<=8420||8421<=s&&s<=8432||11503<=s&&s<=11505||11647==s||11744<=s&&s<=11775||12330<=s&&s<=12333||12334<=s&&s<=12335||12441<=s&&s<=12442||42607==s||42608<=s&&s<=42610||42612<=s&&s<=42621||42654<=s&&s<=42655||42736<=s&&s<=42737||43010==s||43014==s||43019==s||43045<=s&&s<=43046||43204<=s&&s<=43205||43232<=s&&s<=43249||43302<=s&&s<=43309||43335<=s&&s<=43345||43392<=s&&s<=43394||43443==s||43446<=s&&s<=43449||43452==s||43493==s||43561<=s&&s<=43566||43569<=s&&s<=43570||43573<=s&&s<=43574||43587==s||43596==s||43644==s||43696==s||43698<=s&&s<=43700||43703<=s&&s<=43704||43710<=s&&s<=43711||43713==s||43756<=s&&s<=43757||43766==s||44005==s||44008==s||44013==s||64286==s||65024<=s&&s<=65039||65056<=s&&s<=65071||65438<=s&&s<=65439||66045==s||66272==s||66422<=s&&s<=66426||68097<=s&&s<=68099||68101<=s&&s<=68102||68108<=s&&s<=68111||68152<=s&&s<=68154||68159==s||68325<=s&&s<=68326||69633==s||69688<=s&&s<=69702||69759<=s&&s<=69761||69811<=s&&s<=69814||69817<=s&&s<=69818||69888<=s&&s<=69890||69927<=s&&s<=69931||69933<=s&&s<=69940||70003==s||70016<=s&&s<=70017||70070<=s&&s<=70078||70090<=s&&s<=70092||70191<=s&&s<=70193||70196==s||70198<=s&&s<=70199||70206==s||70367==s||70371<=s&&s<=70378||70400<=s&&s<=70401||70460==s||70462==s||70464==s||70487==s||70502<=s&&s<=70508||70512<=s&&s<=70516||70712<=s&&s<=70719||70722<=s&&s<=70724||70726==s||70832==s||70835<=s&&s<=70840||70842==s||70845==s||70847<=s&&s<=70848||70850<=s&&s<=70851||71087==s||71090<=s&&s<=71093||71100<=s&&s<=71101||71103<=s&&s<=71104||71132<=s&&s<=71133||71219<=s&&s<=71226||71229==s||71231<=s&&s<=71232||71339==s||71341==s||71344<=s&&s<=71349||71351==s||71453<=s&&s<=71455||71458<=s&&s<=71461||71463<=s&&s<=71467||72193<=s&&s<=72198||72201<=s&&s<=72202||72243<=s&&s<=72248||72251<=s&&s<=72254||72263==s||72273<=s&&s<=72278||72281<=s&&s<=72283||72330<=s&&s<=72342||72344<=s&&s<=72345||72752<=s&&s<=72758||72760<=s&&s<=72765||72767==s||72850<=s&&s<=72871||72874<=s&&s<=72880||72882<=s&&s<=72883||72885<=s&&s<=72886||73009<=s&&s<=73014||73018==s||73020<=s&&s<=73021||73023<=s&&s<=73029||73031==s||92912<=s&&s<=92916||92976<=s&&s<=92982||94095<=s&&s<=94098||113821<=s&&s<=113822||119141==s||119143<=s&&s<=119145||119150<=s&&s<=119154||119163<=s&&s<=119170||119173<=s&&s<=119179||119210<=s&&s<=119213||119362<=s&&s<=119364||121344<=s&&s<=121398||121403<=s&&s<=121452||121461==s||121476==s||121499<=s&&s<=121503||121505<=s&&s<=121519||122880<=s&&s<=122886||122888<=s&&s<=122904||122907<=s&&s<=122913||122915<=s&&s<=122916||122918<=s&&s<=122922||125136<=s&&s<=125142||125252<=s&&s<=125258||917536<=s&&s<=917631||917760<=s&&s<=917999?t:127462<=s&&s<=127487?e:2307==s||2363==s||2366<=s&&s<=2368||2377<=s&&s<=2380||2382<=s&&s<=2383||2434<=s&&s<=2435||2495<=s&&s<=2496||2503<=s&&s<=2504||2507<=s&&s<=2508||2563==s||2622<=s&&s<=2624||2691==s||2750<=s&&s<=2752||2761==s||2763<=s&&s<=2764||2818<=s&&s<=2819||2880==s||2887<=s&&s<=2888||2891<=s&&s<=2892||3007==s||3009<=s&&s<=3010||3014<=s&&s<=3016||3018<=s&&s<=3020||3073<=s&&s<=3075||3137<=s&&s<=3140||3202<=s&&s<=3203||3262==s||3264<=s&&s<=3265||3267<=s&&s<=3268||3271<=s&&s<=3272||3274<=s&&s<=3275||3330<=s&&s<=3331||3391<=s&&s<=3392||3398<=s&&s<=3400||3402<=s&&s<=3404||3458<=s&&s<=3459||3536<=s&&s<=3537||3544<=s&&s<=3550||3570<=s&&s<=3571||3635==s||3763==s||3902<=s&&s<=3903||3967==s||4145==s||4155<=s&&s<=4156||4182<=s&&s<=4183||4228==s||6070==s||6078<=s&&s<=6085||6087<=s&&s<=6088||6435<=s&&s<=6438||6441<=s&&s<=6443||6448<=s&&s<=6449||6451<=s&&s<=6456||6681<=s&&s<=6682||6741==s||6743==s||6765<=s&&s<=6770||6916==s||6965==s||6971==s||6973<=s&&s<=6977||6979<=s&&s<=6980||7042==s||7073==s||7078<=s&&s<=7079||7082==s||7143==s||7146<=s&&s<=7148||7150==s||7154<=s&&s<=7155||7204<=s&&s<=7211||7220<=s&&s<=7221||7393==s||7410<=s&&s<=7411||7415==s||43043<=s&&s<=43044||43047==s||43136<=s&&s<=43137||43188<=s&&s<=43203||43346<=s&&s<=43347||43395==s||43444<=s&&s<=43445||43450<=s&&s<=43451||43453<=s&&s<=43456||43567<=s&&s<=43568||43571<=s&&s<=43572||43597==s||43755==s||43758<=s&&s<=43759||43765==s||44003<=s&&s<=44004||44006<=s&&s<=44007||44009<=s&&s<=44010||44012==s||69632==s||69634==s||69762==s||69808<=s&&s<=69810||69815<=s&&s<=69816||69932==s||70018==s||70067<=s&&s<=70069||70079<=s&&s<=70080||70188<=s&&s<=70190||70194<=s&&s<=70195||70197==s||70368<=s&&s<=70370||70402<=s&&s<=70403||70463==s||70465<=s&&s<=70468||70471<=s&&s<=70472||70475<=s&&s<=70477||70498<=s&&s<=70499||70709<=s&&s<=70711||70720<=s&&s<=70721||70725==s||70833<=s&&s<=70834||70841==s||70843<=s&&s<=70844||70846==s||70849==s||71088<=s&&s<=71089||71096<=s&&s<=71099||71102==s||71216<=s&&s<=71218||71227<=s&&s<=71228||71230==s||71340==s||71342<=s&&s<=71343||71350==s||71456<=s&&s<=71457||71462==s||72199<=s&&s<=72200||72249==s||72279<=s&&s<=72280||72343==s||72751==s||72766==s||72873==s||72881==s||72884==s||94033<=s&&s<=94078||119142==s||119149==s?5:4352<=s&&s<=4447||43360<=s&&s<=43388?6:4448<=s&&s<=4519||55216<=s&&s<=55238?7:4520<=s&&s<=4607||55243<=s&&s<=55291?8:44032==s||44060==s||44088==s||44116==s||44144==s||44172==s||44200==s||44228==s||44256==s||44284==s||44312==s||44340==s||44368==s||44396==s||44424==s||44452==s||44480==s||44508==s||44536==s||44564==s||44592==s||44620==s||44648==s||44676==s||44704==s||44732==s||44760==s||44788==s||44816==s||44844==s||44872==s||44900==s||44928==s||44956==s||44984==s||45012==s||45040==s||45068==s||45096==s||45124==s||45152==s||45180==s||45208==s||45236==s||45264==s||45292==s||45320==s||45348==s||45376==s||45404==s||45432==s||45460==s||45488==s||45516==s||45544==s||45572==s||45600==s||45628==s||45656==s||45684==s||45712==s||45740==s||45768==s||45796==s||45824==s||45852==s||45880==s||45908==s||45936==s||45964==s||45992==s||46020==s||46048==s||46076==s||46104==s||46132==s||46160==s||46188==s||46216==s||46244==s||46272==s||46300==s||46328==s||46356==s||46384==s||46412==s||46440==s||46468==s||46496==s||46524==s||46552==s||46580==s||46608==s||46636==s||46664==s||46692==s||46720==s||46748==s||46776==s||46804==s||46832==s||46860==s||46888==s||46916==s||46944==s||46972==s||47e3==s||47028==s||47056==s||47084==s||47112==s||47140==s||47168==s||47196==s||47224==s||47252==s||47280==s||47308==s||47336==s||47364==s||47392==s||47420==s||47448==s||47476==s||47504==s||47532==s||47560==s||47588==s||47616==s||47644==s||47672==s||47700==s||47728==s||47756==s||47784==s||47812==s||47840==s||47868==s||47896==s||47924==s||47952==s||47980==s||48008==s||48036==s||48064==s||48092==s||48120==s||48148==s||48176==s||48204==s||48232==s||48260==s||48288==s||48316==s||48344==s||48372==s||48400==s||48428==s||48456==s||48484==s||48512==s||48540==s||48568==s||48596==s||48624==s||48652==s||48680==s||48708==s||48736==s||48764==s||48792==s||48820==s||48848==s||48876==s||48904==s||48932==s||48960==s||48988==s||49016==s||49044==s||49072==s||49100==s||49128==s||49156==s||49184==s||49212==s||49240==s||49268==s||49296==s||49324==s||49352==s||49380==s||49408==s||49436==s||49464==s||49492==s||49520==s||49548==s||49576==s||49604==s||49632==s||49660==s||49688==s||49716==s||49744==s||49772==s||49800==s||49828==s||49856==s||49884==s||49912==s||49940==s||49968==s||49996==s||50024==s||50052==s||50080==s||50108==s||50136==s||50164==s||50192==s||50220==s||50248==s||50276==s||50304==s||50332==s||50360==s||50388==s||50416==s||50444==s||50472==s||50500==s||50528==s||50556==s||50584==s||50612==s||50640==s||50668==s||50696==s||50724==s||50752==s||50780==s||50808==s||50836==s||50864==s||50892==s||50920==s||50948==s||50976==s||51004==s||51032==s||51060==s||51088==s||51116==s||51144==s||51172==s||51200==s||51228==s||51256==s||51284==s||51312==s||51340==s||51368==s||51396==s||51424==s||51452==s||51480==s||51508==s||51536==s||51564==s||51592==s||51620==s||51648==s||51676==s||51704==s||51732==s||51760==s||51788==s||51816==s||51844==s||51872==s||51900==s||51928==s||51956==s||51984==s||52012==s||52040==s||52068==s||52096==s||52124==s||52152==s||52180==s||52208==s||52236==s||52264==s||52292==s||52320==s||52348==s||52376==s||52404==s||52432==s||52460==s||52488==s||52516==s||52544==s||52572==s||52600==s||52628==s||52656==s||52684==s||52712==s||52740==s||52768==s||52796==s||52824==s||52852==s||52880==s||52908==s||52936==s||52964==s||52992==s||53020==s||53048==s||53076==s||53104==s||53132==s||53160==s||53188==s||53216==s||53244==s||53272==s||53300==s||53328==s||53356==s||53384==s||53412==s||53440==s||53468==s||53496==s||53524==s||53552==s||53580==s||53608==s||53636==s||53664==s||53692==s||53720==s||53748==s||53776==s||53804==s||53832==s||53860==s||53888==s||53916==s||53944==s||53972==s||54e3==s||54028==s||54056==s||54084==s||54112==s||54140==s||54168==s||54196==s||54224==s||54252==s||54280==s||54308==s||54336==s||54364==s||54392==s||54420==s||54448==s||54476==s||54504==s||54532==s||54560==s||54588==s||54616==s||54644==s||54672==s||54700==s||54728==s||54756==s||54784==s||54812==s||54840==s||54868==s||54896==s||54924==s||54952==s||54980==s||55008==s||55036==s||55064==s||55092==s||55120==s||55148==s||55176==s?9:44033<=s&&s<=44059||44061<=s&&s<=44087||44089<=s&&s<=44115||44117<=s&&s<=44143||44145<=s&&s<=44171||44173<=s&&s<=44199||44201<=s&&s<=44227||44229<=s&&s<=44255||44257<=s&&s<=44283||44285<=s&&s<=44311||44313<=s&&s<=44339||44341<=s&&s<=44367||44369<=s&&s<=44395||44397<=s&&s<=44423||44425<=s&&s<=44451||44453<=s&&s<=44479||44481<=s&&s<=44507||44509<=s&&s<=44535||44537<=s&&s<=44563||44565<=s&&s<=44591||44593<=s&&s<=44619||44621<=s&&s<=44647||44649<=s&&s<=44675||44677<=s&&s<=44703||44705<=s&&s<=44731||44733<=s&&s<=44759||44761<=s&&s<=44787||44789<=s&&s<=44815||44817<=s&&s<=44843||44845<=s&&s<=44871||44873<=s&&s<=44899||44901<=s&&s<=44927||44929<=s&&s<=44955||44957<=s&&s<=44983||44985<=s&&s<=45011||45013<=s&&s<=45039||45041<=s&&s<=45067||45069<=s&&s<=45095||45097<=s&&s<=45123||45125<=s&&s<=45151||45153<=s&&s<=45179||45181<=s&&s<=45207||45209<=s&&s<=45235||45237<=s&&s<=45263||45265<=s&&s<=45291||45293<=s&&s<=45319||45321<=s&&s<=45347||45349<=s&&s<=45375||45377<=s&&s<=45403||45405<=s&&s<=45431||45433<=s&&s<=45459||45461<=s&&s<=45487||45489<=s&&s<=45515||45517<=s&&s<=45543||45545<=s&&s<=45571||45573<=s&&s<=45599||45601<=s&&s<=45627||45629<=s&&s<=45655||45657<=s&&s<=45683||45685<=s&&s<=45711||45713<=s&&s<=45739||45741<=s&&s<=45767||45769<=s&&s<=45795||45797<=s&&s<=45823||45825<=s&&s<=45851||45853<=s&&s<=45879||45881<=s&&s<=45907||45909<=s&&s<=45935||45937<=s&&s<=45963||45965<=s&&s<=45991||45993<=s&&s<=46019||46021<=s&&s<=46047||46049<=s&&s<=46075||46077<=s&&s<=46103||46105<=s&&s<=46131||46133<=s&&s<=46159||46161<=s&&s<=46187||46189<=s&&s<=46215||46217<=s&&s<=46243||46245<=s&&s<=46271||46273<=s&&s<=46299||46301<=s&&s<=46327||46329<=s&&s<=46355||46357<=s&&s<=46383||46385<=s&&s<=46411||46413<=s&&s<=46439||46441<=s&&s<=46467||46469<=s&&s<=46495||46497<=s&&s<=46523||46525<=s&&s<=46551||46553<=s&&s<=46579||46581<=s&&s<=46607||46609<=s&&s<=46635||46637<=s&&s<=46663||46665<=s&&s<=46691||46693<=s&&s<=46719||46721<=s&&s<=46747||46749<=s&&s<=46775||46777<=s&&s<=46803||46805<=s&&s<=46831||46833<=s&&s<=46859||46861<=s&&s<=46887||46889<=s&&s<=46915||46917<=s&&s<=46943||46945<=s&&s<=46971||46973<=s&&s<=46999||47001<=s&&s<=47027||47029<=s&&s<=47055||47057<=s&&s<=47083||47085<=s&&s<=47111||47113<=s&&s<=47139||47141<=s&&s<=47167||47169<=s&&s<=47195||47197<=s&&s<=47223||47225<=s&&s<=47251||47253<=s&&s<=47279||47281<=s&&s<=47307||47309<=s&&s<=47335||47337<=s&&s<=47363||47365<=s&&s<=47391||47393<=s&&s<=47419||47421<=s&&s<=47447||47449<=s&&s<=47475||47477<=s&&s<=47503||47505<=s&&s<=47531||47533<=s&&s<=47559||47561<=s&&s<=47587||47589<=s&&s<=47615||47617<=s&&s<=47643||47645<=s&&s<=47671||47673<=s&&s<=47699||47701<=s&&s<=47727||47729<=s&&s<=47755||47757<=s&&s<=47783||47785<=s&&s<=47811||47813<=s&&s<=47839||47841<=s&&s<=47867||47869<=s&&s<=47895||47897<=s&&s<=47923||47925<=s&&s<=47951||47953<=s&&s<=47979||47981<=s&&s<=48007||48009<=s&&s<=48035||48037<=s&&s<=48063||48065<=s&&s<=48091||48093<=s&&s<=48119||48121<=s&&s<=48147||48149<=s&&s<=48175||48177<=s&&s<=48203||48205<=s&&s<=48231||48233<=s&&s<=48259||48261<=s&&s<=48287||48289<=s&&s<=48315||48317<=s&&s<=48343||48345<=s&&s<=48371||48373<=s&&s<=48399||48401<=s&&s<=48427||48429<=s&&s<=48455||48457<=s&&s<=48483||48485<=s&&s<=48511||48513<=s&&s<=48539||48541<=s&&s<=48567||48569<=s&&s<=48595||48597<=s&&s<=48623||48625<=s&&s<=48651||48653<=s&&s<=48679||48681<=s&&s<=48707||48709<=s&&s<=48735||48737<=s&&s<=48763||48765<=s&&s<=48791||48793<=s&&s<=48819||48821<=s&&s<=48847||48849<=s&&s<=48875||48877<=s&&s<=48903||48905<=s&&s<=48931||48933<=s&&s<=48959||48961<=s&&s<=48987||48989<=s&&s<=49015||49017<=s&&s<=49043||49045<=s&&s<=49071||49073<=s&&s<=49099||49101<=s&&s<=49127||49129<=s&&s<=49155||49157<=s&&s<=49183||49185<=s&&s<=49211||49213<=s&&s<=49239||49241<=s&&s<=49267||49269<=s&&s<=49295||49297<=s&&s<=49323||49325<=s&&s<=49351||49353<=s&&s<=49379||49381<=s&&s<=49407||49409<=s&&s<=49435||49437<=s&&s<=49463||49465<=s&&s<=49491||49493<=s&&s<=49519||49521<=s&&s<=49547||49549<=s&&s<=49575||49577<=s&&s<=49603||49605<=s&&s<=49631||49633<=s&&s<=49659||49661<=s&&s<=49687||49689<=s&&s<=49715||49717<=s&&s<=49743||49745<=s&&s<=49771||49773<=s&&s<=49799||49801<=s&&s<=49827||49829<=s&&s<=49855||49857<=s&&s<=49883||49885<=s&&s<=49911||49913<=s&&s<=49939||49941<=s&&s<=49967||49969<=s&&s<=49995||49997<=s&&s<=50023||50025<=s&&s<=50051||50053<=s&&s<=50079||50081<=s&&s<=50107||50109<=s&&s<=50135||50137<=s&&s<=50163||50165<=s&&s<=50191||50193<=s&&s<=50219||50221<=s&&s<=50247||50249<=s&&s<=50275||50277<=s&&s<=50303||50305<=s&&s<=50331||50333<=s&&s<=50359||50361<=s&&s<=50387||50389<=s&&s<=50415||50417<=s&&s<=50443||50445<=s&&s<=50471||50473<=s&&s<=50499||50501<=s&&s<=50527||50529<=s&&s<=50555||50557<=s&&s<=50583||50585<=s&&s<=50611||50613<=s&&s<=50639||50641<=s&&s<=50667||50669<=s&&s<=50695||50697<=s&&s<=50723||50725<=s&&s<=50751||50753<=s&&s<=50779||50781<=s&&s<=50807||50809<=s&&s<=50835||50837<=s&&s<=50863||50865<=s&&s<=50891||50893<=s&&s<=50919||50921<=s&&s<=50947||50949<=s&&s<=50975||50977<=s&&s<=51003||51005<=s&&s<=51031||51033<=s&&s<=51059||51061<=s&&s<=51087||51089<=s&&s<=51115||51117<=s&&s<=51143||51145<=s&&s<=51171||51173<=s&&s<=51199||51201<=s&&s<=51227||51229<=s&&s<=51255||51257<=s&&s<=51283||51285<=s&&s<=51311||51313<=s&&s<=51339||51341<=s&&s<=51367||51369<=s&&s<=51395||51397<=s&&s<=51423||51425<=s&&s<=51451||51453<=s&&s<=51479||51481<=s&&s<=51507||51509<=s&&s<=51535||51537<=s&&s<=51563||51565<=s&&s<=51591||51593<=s&&s<=51619||51621<=s&&s<=51647||51649<=s&&s<=51675||51677<=s&&s<=51703||51705<=s&&s<=51731||51733<=s&&s<=51759||51761<=s&&s<=51787||51789<=s&&s<=51815||51817<=s&&s<=51843||51845<=s&&s<=51871||51873<=s&&s<=51899||51901<=s&&s<=51927||51929<=s&&s<=51955||51957<=s&&s<=51983||51985<=s&&s<=52011||52013<=s&&s<=52039||52041<=s&&s<=52067||52069<=s&&s<=52095||52097<=s&&s<=52123||52125<=s&&s<=52151||52153<=s&&s<=52179||52181<=s&&s<=52207||52209<=s&&s<=52235||52237<=s&&s<=52263||52265<=s&&s<=52291||52293<=s&&s<=52319||52321<=s&&s<=52347||52349<=s&&s<=52375||52377<=s&&s<=52403||52405<=s&&s<=52431||52433<=s&&s<=52459||52461<=s&&s<=52487||52489<=s&&s<=52515||52517<=s&&s<=52543||52545<=s&&s<=52571||52573<=s&&s<=52599||52601<=s&&s<=52627||52629<=s&&s<=52655||52657<=s&&s<=52683||52685<=s&&s<=52711||52713<=s&&s<=52739||52741<=s&&s<=52767||52769<=s&&s<=52795||52797<=s&&s<=52823||52825<=s&&s<=52851||52853<=s&&s<=52879||52881<=s&&s<=52907||52909<=s&&s<=52935||52937<=s&&s<=52963||52965<=s&&s<=52991||52993<=s&&s<=53019||53021<=s&&s<=53047||53049<=s&&s<=53075||53077<=s&&s<=53103||53105<=s&&s<=53131||53133<=s&&s<=53159||53161<=s&&s<=53187||53189<=s&&s<=53215||53217<=s&&s<=53243||53245<=s&&s<=53271||53273<=s&&s<=53299||53301<=s&&s<=53327||53329<=s&&s<=53355||53357<=s&&s<=53383||53385<=s&&s<=53411||53413<=s&&s<=53439||53441<=s&&s<=53467||53469<=s&&s<=53495||53497<=s&&s<=53523||53525<=s&&s<=53551||53553<=s&&s<=53579||53581<=s&&s<=53607||53609<=s&&s<=53635||53637<=s&&s<=53663||53665<=s&&s<=53691||53693<=s&&s<=53719||53721<=s&&s<=53747||53749<=s&&s<=53775||53777<=s&&s<=53803||53805<=s&&s<=53831||53833<=s&&s<=53859||53861<=s&&s<=53887||53889<=s&&s<=53915||53917<=s&&s<=53943||53945<=s&&s<=53971||53973<=s&&s<=53999||54001<=s&&s<=54027||54029<=s&&s<=54055||54057<=s&&s<=54083||54085<=s&&s<=54111||54113<=s&&s<=54139||54141<=s&&s<=54167||54169<=s&&s<=54195||54197<=s&&s<=54223||54225<=s&&s<=54251||54253<=s&&s<=54279||54281<=s&&s<=54307||54309<=s&&s<=54335||54337<=s&&s<=54363||54365<=s&&s<=54391||54393<=s&&s<=54419||54421<=s&&s<=54447||54449<=s&&s<=54475||54477<=s&&s<=54503||54505<=s&&s<=54531||54533<=s&&s<=54559||54561<=s&&s<=54587||54589<=s&&s<=54615||54617<=s&&s<=54643||54645<=s&&s<=54671||54673<=s&&s<=54699||54701<=s&&s<=54727||54729<=s&&s<=54755||54757<=s&&s<=54783||54785<=s&&s<=54811||54813<=s&&s<=54839||54841<=s&&s<=54867||54869<=s&&s<=54895||54897<=s&&s<=54923||54925<=s&&s<=54951||54953<=s&&s<=54979||54981<=s&&s<=55007||55009<=s&&s<=55035||55037<=s&&s<=55063||55065<=s&&s<=55091||55093<=s&&s<=55119||55121<=s&&s<=55147||55149<=s&&s<=55175||55177<=s&&s<=55203?10:9757==s||9977==s||9994<=s&&s<=9997||127877==s||127938<=s&&s<=127940||127943==s||127946<=s&&s<=127948||128066<=s&&s<=128067||128070<=s&&s<=128080||128110==s||128112<=s&&s<=128120||128124==s||128129<=s&&s<=128131||128133<=s&&s<=128135||128170==s||128372<=s&&s<=128373||128378==s||128400==s||128405<=s&&s<=128406||128581<=s&&s<=128583||128587<=s&&s<=128591||128675==s||128692<=s&&s<=128694||128704==s||128716==s||129304<=s&&s<=129308||129310<=s&&s<=129311||129318==s||129328<=s&&s<=129337||129341<=s&&s<=129342||129489<=s&&s<=129501?i:127995<=s&&s<=127999?14:8205==s?15:9792==s||9794==s||9877<=s&&s<=9878||9992==s||10084==s||127752==s||127806==s||127859==s||127891==s||127908==s||127912==s||127979==s||127981==s||128139==s||128187<=s&&s<=128188||128295==s||128300==s||128488==s||128640==s||128658==s?r:128102<=s&&s<=128105?o:11}return this.nextBreak=function(t,e){if(void 0===e&&(e=0),e<0)return 0;if(e>=t.length-1)return t.length;for(var n,i,r=u(s(t,e)),o=[],h=e+1;h<t.length;h++)if(i=h-1,!(55296<=(n=t).charCodeAt(i)&&n.charCodeAt(i)<=56319&&56320<=n.charCodeAt(i+1)&&n.charCodeAt(i+1)<=57343)){var l=u(s(t,h));if(a(r,o,l))return h;o.push(l)}return t.length},this.splitGraphemes=function(t){for(var e,n=[],i=0;(e=this.nextBreak(t,i))<t.length;)n.push(t.slice(i,e)),i=e;return i<t.length&&n.push(t.slice(i)),n},this.iterateGraphemes=function(t){var e=0,n={next:function(){var n,i;return(i=this.nextBreak(t,e))<t.length?(n=t.slice(e,i),e=i,{value:n,done:!1}):e<t.length?(n=t.slice(e),e=t.length,{value:n,done:!1}):{value:void 0,done:!0}}.bind(this)};return"undefined"!=typeof Symbol&&Symbol.iterator&&(n[Symbol.iterator]=function(){return n}),n},this.countGraphemes=function(t){for(var e,n=0,i=0;(e=this.nextBreak(t,i))<t.length;)i=e,n++;return i<t.length&&n++,n},this})),Ov.exports),Tv=wf(Iv);function zv(){this.textureInfo=void 0,this.dimensions=void 0,this.billboard=void 0}function Rv(t,e,n){this.labelCollection=t,this.index=e,this.dimensions=n}const Fv="ID_WHITE_PIXEL",Dv=new t.Cartesian2(4,4),Pv=new t.BoundingRectangle(1,1,1,1),Nv={};function Uv(e,n,i,r,o,s,a){return Nv.font=n,Nv.fillColor=i,Nv.strokeColor=r,Nv.strokeWidth=o,Nv.padding=t.SDFSettings.PADDING,a===t.VerticalOrigin.CENTER?Nv.textBaseline="middle":a===t.VerticalOrigin.TOP?Nv.textBaseline="top":Nv.textBaseline="bottom",Nv.fill=s===t.LabelStyle.FILL||s===t.LabelStyle.FILL_AND_OUTLINE,Nv.stroke=s===t.LabelStyle.OUTLINE||s===t.LabelStyle.FILL_AND_OUTLINE,Nv.backgroundColor=t.Color.BLACK,t.writeTextToCanvas(e,Nv)}function qv(e,n){n.textureInfo=void 0,n.dimensions=void 0;const i=n.billboard;t.defined(i)&&(i.show=!1,i.image=void 0,t.defined(i._removeCallbackFunc)&&(i._removeCallbackFunc(),i._removeCallbackFunc=void 0),e._reuseBillboards&&e._spareBillboards.push(i),n.billboard=void 0)}function jv(t,e,n,i){i.index=t.addImageSync(e,n)}const Lv=new Tv;function Bv(e,n){const i=n._renderedText,r=Lv.splitGraphemes(i),o=r.length,s=n._glyphs,a=s.length;let u,h,l;if(n._relativeSize=n._fontSize/t.SDFSettings.FONT_SIZE,o<a)for(h=o;h<a;++h)qv(e,s[h]);s.length=o;const c=n.show&&n._showBackground&&i.split("\n").join("").length>0;let f=n._backgroundBillboard;const d=e._backgroundBillboardCollection;c?(t.defined(f)||(f=d.add({collection:e,image:Fv,imageSubRegion:Pv}),n._backgroundBillboard=f),f.color=n._backgroundColor,f.show=n._show,f.position=n._position,f.eyeOffset=n._eyeOffset,f.pixelOffset=n._pixelOffset,f.horizontalOrigin=t.HorizontalOrigin.LEFT,f.verticalOrigin=n._verticalOrigin,f.heightReference=n._heightReference,f.scale=n.totalScale,f.pickPrimitive=n,f.id=n._id,f.translucencyByDistance=n._translucencyByDistance,f.pixelOffsetScaleByDistance=n._pixelOffsetScaleByDistance,f.scaleByDistance=n._scaleByDistance,f.distanceDisplayCondition=n._distanceDisplayCondition,f.disableDepthTestDistance=n._disableDepthTestDistance,f.clusterShow=n.clusterShow):t.defined(f)&&(d.remove(f),n._backgroundBillboard=f=void 0);const p=e._glyphTextureCache;for(l=0;l<o;++l){const i=r[l],o=n._verticalOrigin,a=JSON.stringify([i,n._fontFamily,n._fontStyle,n._fontWeight,+o]);let h=p[a];if(!t.defined(h)){const r=Uv(i,`${n._fontStyle} ${n._fontWeight} ${t.SDFSettings.FONT_SIZE}px ${n._fontFamily}`,t.Color.WHITE,t.Color.WHITE,0,t.LabelStyle.FILL,o);if(h=new Rv(e,-1,r.dimensions),p[a]=h,r.width>0&&r.height>0){const n=Ip(r,{cutoff:t.SDFSettings.CUTOFF,radius:t.SDFSettings.RADIUS}),o=r.getContext("2d"),s=r.width,u=r.height,l=o.getImageData(0,0,s,u);for(let t=0;t<s;t++)for(let e=0;e<u;e++){const i=e*s+t,r=255*n[i],o=4*i;l.data[o+0]=r,l.data[o+1]=r,l.data[o+2]=r,l.data[o+3]=r}o.putImageData(l,0,0)," "!==i&&jv(e._textureAtlas,a,r,h)}}if(u=s[l],t.defined(u)?-1===h.index?qv(e,u):t.defined(u.textureInfo)&&(u.textureInfo=void 0):(u=new zv,s[l]=u),u.textureInfo=h,u.dimensions=h.dimensions,-1!==h.index){let i=u.billboard;const r=e._spareBillboards;t.defined(i)||(r.length>0?i=r.pop():(i=e._billboardCollection.add({collection:e}),i._labelDimensions=new t.Cartesian2,i._labelTranslate=new t.Cartesian2),u.billboard=i),i.show=n._show,i.position=n._position,i.eyeOffset=n._eyeOffset,i.pixelOffset=n._pixelOffset,i.horizontalOrigin=t.HorizontalOrigin.LEFT,i.verticalOrigin=n._verticalOrigin,i.heightReference=n._heightReference,i.scale=n.totalScale,i.pickPrimitive=n,i.id=n._id,i.image=a,i.translucencyByDistance=n._translucencyByDistance,i.pixelOffsetScaleByDistance=n._pixelOffsetScaleByDistance,i.scaleByDistance=n._scaleByDistance,i.distanceDisplayCondition=n._distanceDisplayCondition,i.disableDepthTestDistance=n._disableDepthTestDistance,i._batchIndex=n._batchIndex,i.outlineColor=n.outlineColor,i.roadDirection=n.roadDirection||Cesium.Cartesian4.ZERO.clone(),n.style===t.LabelStyle.FILL_AND_OUTLINE?(i.color=n._fillColor,i.outlineWidth=n.outlineWidth):n.style===t.LabelStyle.FILL?(i.color=n._fillColor,i.outlineWidth=0):n.style===t.LabelStyle.OUTLINE&&(i.color=t.Color.TRANSPARENT,i.outlineWidth=n.outlineWidth)}}n._repositionAllGlyphs=!0}function Hv(e,n,i){return n===t.HorizontalOrigin.CENTER?-e/2:n===t.HorizontalOrigin.RIGHT?-(e+i.x):i.x}const Wv=new t.Cartesian2,Vv=new t.Cartesian2;function Gv(e){const n=e._glyphs,i=e._renderedText;let r,o,s=0,a=0;const u=[];let h,l=Number.NEGATIVE_INFINITY,c=0,f=1;const d=n.length,p=e._backgroundBillboard,v=t.Cartesian2.clone(t.defined(p)?e._backgroundPadding:t.Cartesian2.ZERO,Vv);for(v.x/=e._relativeSize,v.y/=e._relativeSize,h=0;h<d;++h)"\n"===i.charAt(h)?(u.push(s),++f,s=0):(r=n[h],o=r.dimensions,c=Math.max(c,o.height-o.descent),l=Math.max(l,o.descent),s+=o.width-o.minx,h<d-1&&(s+=n[h+1].dimensions.minx),a=Math.max(a,s));u.push(s);const m=c+l,y=e.totalScale,w=e._horizontalOrigin,g=e._verticalOrigin;let b=0,_=u[b],x=Hv(_,w,v);const k=(t.defined(e._lineHeight)?e._lineHeight:1.2*e._fontSize)/e._relativeSize,$=k*(f-1);let S=a,E=m+$;t.defined(p)&&(S+=2*v.x,E+=2*v.y,p._labelHorizontalOrigin=w),Wv.x=x*y,Wv.y=0;let M=!0,C=0;for(h=0;h<d;++h)if("\n"===i.charAt(h))++b,C+=k,_=u[b],x=Hv(_,w,v),Wv.x=x*y,M=!0;else if(r=n[h],o=r.dimensions,g===t.VerticalOrigin.TOP?(Wv.y=o.height-c-v.y,Wv.y+=t.SDFSettings.PADDING):g===t.VerticalOrigin.CENTER?Wv.y=($+o.height-c)/2:g===t.VerticalOrigin.BASELINE?(Wv.y=$,Wv.y-=t.SDFSettings.PADDING):(Wv.y=$+l+v.y,Wv.y-=t.SDFSettings.PADDING),Wv.y=(Wv.y-o.descent-C)*y,M&&(Wv.x-=t.SDFSettings.PADDING*y,M=!1),t.defined(r.billboard)&&(r.billboard._setTranslate(Wv),r.billboard._labelDimensions.x=S,r.billboard._labelDimensions.y=E,r.billboard._labelHorizontalOrigin=w),h<d-1){const t=n[h+1];Wv.x+=(o.width-o.minx+t.dimensions.minx)*y}if(t.defined(p)&&i.split("\n").join("").length>0&&(x=w===t.HorizontalOrigin.CENTER?-a/2-v.x:w===t.HorizontalOrigin.RIGHT?-(a+2*v.x):0,Wv.x=x*y,g===t.VerticalOrigin.TOP?Wv.y=m-c-l:g===t.VerticalOrigin.CENTER?Wv.y=(m-c)/2-l:g===t.VerticalOrigin.BASELINE?Wv.y=-v.y-l:Wv.y=0,Wv.y=Wv.y*y,p.width=S,p.height=E,p._setTranslate(Wv),p._labelTranslate=t.Cartesian2.clone(Wv,p._labelTranslate)),(A=e.heightReference)===t.HeightReference.CLAMP_TO_GROUND||A===t.HeightReference.CLAMP_TO_3D_TILE||A===t.HeightReference.CLAMP_TO_TERRAIN)for(h=0;h<d;++h){r=n[h];const e=r.billboard;t.defined(e)&&(e._labelTranslate=t.Cartesian2.clone(Wv,e._labelTranslate))}var A}function Yv(e,n){const i=n._glyphs;for(let t=0,n=i.length;t<n;++t)qv(e,i[t]);t.defined(n._backgroundBillboard)&&(e._backgroundBillboardCollection.remove(n._backgroundBillboard),n._backgroundBillboard=void 0),n._labelCollection=void 0,t.defined(n._removeCallbackFunc)&&n._removeCallbackFunc(),t.destroyObject(n)}function Kv(e){e=t.defaultValue(e,t.defaultValue.EMPTY_OBJECT),this.preloadSDF=!!e.preloadSDF,this.preloadSDFTextureUrl=t.defaultValue(e.preloadSDFTextureUrl,""),this.preloadSDFConfigUrl=t.defaultValue(e.preloadSDFConfigUrl,""),this._reuseBillboards=t.defaultValue(e.reuseBillboards,!0),this._scene=e.scene,this._batchTable=e.batchTable,this._textureAtlas=void 0,this._backgroundTextureAtlas=void 0,this._backgroundBillboardCollection=new ev({scene:this._scene}),this._backgroundBillboardCollection.destroyTextureAtlas=!1,this._billboardCollection=new ev({scene:this._scene,batchTable:this._batchTable}),this._billboardCollection.destroyTextureAtlas=!1,this._billboardCollection._sdf=!0,this._spareBillboards=[],this._glyphTextureCache={},this._labels=[],this._labelsToUpdate=[],this._totalGlyphCount=0,this._highlightColor=t.Color.clone(t.Color.WHITE),this.show=t.defaultValue(e.show,!0),this.modelMatrix=t.Matrix4.clone(t.defaultValue(e.modelMatrix,t.Matrix4.IDENTITY)),this.debugShowBoundingVolume=t.defaultValue(e.debugShowBoundingVolume,!1),this.blendOption=t.defaultValue(e.blendOption,t.BlendOption.OPAQUE_AND_TRANSLUCENT),this.preloadSDF?this.preload():this.preloaded=!0}Object.defineProperties(Kv.prototype,{length:{get:function(){return this._labels.length}}}),Kv.prototype.add=function(e){const n=new t.Label(e,this);return this._labels.push(n),this._labelsToUpdate.push(n),n},Kv.prototype.remove=function(e){if(t.defined(e)&&e._labelCollection===this){const t=this._labels.indexOf(e);if(-1!==t)return this._labels.splice(t,1),Yv(this,e),!0}return!1},Kv.prototype.removeAll=function(){const t=this._labels;for(let e=0,n=t.length;e<n;++e)Yv(this,t[e]);t.length=0},Kv.prototype.contains=function(e){return t.defined(e)&&e._labelCollection===this},Kv.prototype.get=function(e){if(!t.defined(e))throw new t.DeveloperError("index is required.");return this._labels[e]},Kv.prototype.update=function(e){if(!this.show)return;const n=this._billboardCollection,i=this._backgroundBillboardCollection;n.modelMatrix=this.modelMatrix,n.debugShowBoundingVolume=this.debugShowBoundingVolume,i.modelMatrix=this.modelMatrix,i.debugShowBoundingVolume=this.debugShowBoundingVolume;const r=e.context;t.defined(this._textureAtlas)||(this._textureAtlas=new t.TextureAtlas({context:r}),n.textureAtlas=this._textureAtlas),t.defined(this._backgroundTextureAtlas)||(this._backgroundTextureAtlas=new t.TextureAtlas({context:r,initialSize:Dv}),i.textureAtlas=this._backgroundTextureAtlas,function(t){const e=document.createElement("canvas");e.width=Dv.x,e.height=Dv.y;const n=e.getContext("2d");n.fillStyle="#fff",n.fillRect(0,0,e.width,e.height),t.addImage(Fv,e)}(this._backgroundTextureAtlas));const o=this._labelsToUpdate.length;for(let t=0;t<o;++t){const e=this._labelsToUpdate[t];if(e.isDestroyed())continue;const n=e._glyphs.length;e._rebindAllGlyphs&&(Bv(this,e),e._rebindAllGlyphs=!1),e._repositionAllGlyphs&&(Gv(e),e._repositionAllGlyphs=!1);const i=e._glyphs.length-n;this._totalGlyphCount+=i}const s=i.length>0?t.BlendOption.TRANSLUCENT:this.blendOption;n.blendOption=s,i.blendOption=s,n._highlightColor=this._highlightColor,i._highlightColor=this._highlightColor,this._labelsToUpdate.length=0,i.update(e),n.update(e)},Kv.prototype.isDestroyed=function(){return!1},Kv.prototype.destroy=function(){return this.removeAll(),this._billboardCollection=this._billboardCollection.destroy(),this._textureAtlas=this._textureAtlas&&this._textureAtlas.destroy(),this._backgroundBillboardCollection=this._backgroundBillboardCollection.destroy(),this._backgroundTextureAtlas=this._backgroundTextureAtlas&&this._backgroundTextureAtlas.destroy(),t.destroyObject(this)};const Xv=new RegExp(/[\u0000-\u0008\u000E-\u001F\u00ad\u202a-\u206f\u200b-\u200f]/,"g"),Qv={};function Zv(t,e,n=0,i=t.length-1,r=tm){for(;i>n;){if(i-n>600){const o=i-n+1,s=e-n+1,a=Math.log(o),u=.5*Math.exp(2*a/3),h=.5*Math.sqrt(a*u*(o-u)/o)*(s-o/2<0?-1:1);Zv(t,e,Math.max(n,Math.floor(e-s*u/o+h)),Math.min(i,Math.floor(e+(o-s)*u/o+h)),r)}const o=t[e];let s=n,a=i;for(Jv(t,n,e),r(t[i],o)>0&&Jv(t,n,i);s<a;){for(Jv(t,s,a),s++,a--;r(t[s],o)<0;)s++;for(;r(t[a],o)>0;)a--}0===r(t[n],o)?Jv(t,n,a):(a++,Jv(t,a,i)),a<=e&&(n=a+1),e<=a&&(i=a-1)}}function Jv(t,e,n){const i=t[e];t[e]=t[n],t[n]=i}function tm(t,e){return t<e?-1:t>e?1:0}Kv.prototype.computeLabelSize=function(e){const n=`${e.fontSize}:${e.text}`;if(Qv[n])return Qv[n];t.defined(this._textureAtlas)||(this._textureAtlas=new t.TextureAtlas({context:this._scene.context}),this._billboardCollection.textureAtlas=this._textureAtlas);const i=e.text.replace(Xv,""),r=Lv.splitGraphemes(i),o=r.length,s=[];let a,u;s.length=o;const h=this._glyphTextureCache;for(u=0;u<o;++u){const n=r[u],i=e.verticalOrigin,o=JSON.stringify([n,e.fontFamily,e.fontStyle,e.fontWeight,+i]);let l=h[o];if(!t.defined(l)){const r=Uv(n,`${e.fontStyle} ${e.fontWeight} ${t.SDFSettings.FONT_SIZE}px ${e.fontFamily}`,t.Color.WHITE,t.Color.WHITE,0,t.LabelStyle.FILL,i);if(l=new Rv(this,-1,r.dimensions),h[o]=l,r.width>0&&r.height>0){const e=Ip(r,{cutoff:t.SDFSettings.CUTOFF,radius:t.SDFSettings.RADIUS}),i=r.getContext("2d"),s=r.width,a=r.height,u=i.getImageData(0,0,s,a);for(let t=0;t<s;t++)for(let n=0;n<a;n++){const i=n*s+t,r=255*e[i],o=4*i;u.data[o+0]=r,u.data[o+1]=r,u.data[o+2]=r,u.data[o+3]=r}i.putImageData(u,0,0)," "!==n&&jv(this._textureAtlas,o,r,l)}}a=new zv,s[u]=a,a.textureInfo=l,a.dimensions=l.dimensions}let l,c,f=0,d=0,p=Number.NEGATIVE_INFINITY,v=0,m=1;const y=s.length;for(c=0;c<y;++c)"\n"===i.charAt(c)?(++m,f=0):(a=s[c],l=a.dimensions,v=Math.max(v,l.height-l.descent),p=Math.max(p,l.descent),f+=l.width-l.minx,c<y-1&&(f+=s[c+1].dimensions.minx),d=Math.max(d,f));let w=v+p+(t.defined(e.lineHeight)?e.lineHeight:1.2*e.fontSize)/e.relativeSize*(m-1);const g={width:d*e.totalScale,height:w*e.totalScale};return Qv[n]=g,g},Kv.prototype.preload=async function(){const e=t=>fetch(t).then((t=>t.json()));try{const[i,r]=await Promise.all([(n=this.preloadSDFTextureUrl,new Promise(((t,e)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{t(i)},i.onerror=()=>{e()},i.src=n}))),e(this.preloadSDFConfigUrl)]),o=new t.TextureAtlas({context:this._scene.context,initialSize:new t.Cartesian2(r.dimensions.x,r.dimensions.y)}),s=[...r.font];s.unshift("");const a={},u={};Object.keys(r.indexHash).forEach((t=>{s[0]=t;const e=JSON.stringify(s);a[e]=r.indexHash[t],u[e]=Promise.resolve(r.indexHash[t])})),o._indexHash=a,o._idHash=u,o._root=r.root,o._textureCoordinates=r.textureCoordinates.map((e=>new t.BoundingRectangle(e[0],e[1],e[2],e[3])));const h=new t.Texture({context:this._scene.context,width:r.dimensions.x,height:r.dimensions.y,pixelFormat:o._pixelFormat});h.copyFrom({width:r.dimensions.x,height:r.dimensions.y,source:i}),o._texture=h,this._textureAtlas=o,this._billboardCollection._textureAtlas=o,Object.keys(r.glyphTextureCache).forEach((t=>{s[0]=t;const e=JSON.stringify(s),n={width:r.glyphTextureCache[t][0],height:r.glyphTextureCache[t][1],ascent:r.glyphTextureCache[t][2],descent:r.glyphTextureCache[t][3],minx:r.glyphTextureCache[t][4]},i=r.glyphTextureCache[t][5];this._glyphTextureCache[e]=new Rv(this,i,n)})),this.preloaded=!0}catch(t){this._textureAtlas&&this._textureAtlas.destroy(),this._textureAtlas=void 0,this._billboardCollection._textureAtlas=void 0,this._glyphTextureCache={},this.preloaded=!0}var n};class em{constructor(t=9){this.Cd=Math.max(4,t),this.Ad=Math.max(2,Math.ceil(.4*this.Cd)),this.clear()}all(){return this.Od(this.data,[])}search(t){let e=this.data;const n=[];if(!fm(t,e))return n;const i=this.toBBox,r=[];for(;e;){for(let o=0;o<e.children.length;o++){const s=e.children[o],a=e.leaf?i(s):s;fm(t,a)&&(e.leaf?n.push(s):cm(t,a)?this.Od(s,n):r.push(s))}e=r.pop()}return n}collides(t){let e=this.data;if(!fm(t,e))return!1;const n=[];for(;e;){for(let i=0;i<e.children.length;i++){const r=e.children[i],o=e.leaf?this.toBBox(r):r;if(fm(t,o)){if(e.leaf||cm(t,o))return!0;n.push(r)}}e=n.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this.Ad){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this.Id(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this.Td(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this.zd(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this.zd(t,this.data.height-1),this}clear(){return this.data=dm([]),this}remove(t,e){if(!t)return this;let n=this.data;const i=this.toBBox(t),r=[],o=[];let s,a,u;for(;n||r.length;){if(n||(n=r.pop(),a=r[r.length-1],s=o.pop(),u=!0),n.leaf){const i=nm(t,n.children,e);if(-1!==i)return n.children.splice(i,1),r.push(n),this.Rd(r),this}u||n.leaf||!cm(n,i)?a?(s++,n=a.children[s],u=!1):n=null:(r.push(n),o.push(s),s=0,a=n,n=n.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}Od(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}Id(t,e,n,i){const r=n-e+1;let o,s=this.Cd;if(r<=s)return o=dm(t.slice(e,n+1)),im(o,this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),o=dm([]),o.leaf=!1,o.height=i;const a=Math.ceil(r/s),u=a*Math.ceil(Math.sqrt(s));pm(t,e,n,u,this.compareMinX);for(let r=e;r<=n;r+=u){const e=Math.min(r+u-1,n);pm(t,r,e,a,this.compareMinY);for(let n=r;n<=e;n+=a){const r=Math.min(n+a-1,e);o.children.push(this.Id(t,n,r,i-1))}}return im(o,this.toBBox),o}Fd(t,e,n,i){for(;i.push(e),!e.leaf&&i.length-1!==n;){let n,i=1/0,s=1/0;for(let a=0;a<e.children.length;a++){const u=e.children[a],h=um(u),l=(r=t,o=u,(Math.max(o.maxX,r.maxX)-Math.min(o.minX,r.minX))*(Math.max(o.maxY,r.maxY)-Math.min(o.minY,r.minY))-h);l<s?(s=l,i=h<i?h:i,n=u):l===s&&h<i&&(i=h,n=u)}e=n||e.children[0]}var r,o;return e}zd(t,e,n){const i=n?t:this.toBBox(t),r=[],o=this.Fd(i,this.data,e,r);for(o.children.push(t),om(o,i);e>=0&&r[e].children.length>this.Cd;)this.Dd(r,e),e--;this.Pd(i,r,e)}Dd(t,e){const n=t[e],i=n.children.length,r=this.Ad;this.Nd(n,r,i);const o=this.Ud(n,r,i),s=dm(n.children.splice(o,n.children.length-o));s.height=n.height,s.leaf=n.leaf,im(n,this.toBBox),im(s,this.toBBox),e?t[e-1].children.push(s):this.Td(n,s)}Td(t,e){this.data=dm([t,e]),this.data.height=t.height+1,this.data.leaf=!1,im(this.data,this.toBBox)}Ud(t,e,n){let i,r=1/0,o=1/0;for(let s=e;s<=n-e;s++){const e=rm(t,0,s,this.toBBox),a=rm(t,s,n,this.toBBox),u=lm(e,a),h=um(e)+um(a);u<r?(r=u,i=s,o=h<o?h:o):u===r&&h<o&&(o=h,i=s)}return i||n-e}Nd(t,e,n){const i=t.leaf?this.compareMinX:sm,r=t.leaf?this.compareMinY:am;this.qd(t,e,n,i)<this.qd(t,e,n,r)&&t.children.sort(i)}qd(t,e,n,i){t.children.sort(i);const r=this.toBBox,o=rm(t,0,e,r),s=rm(t,n-e,n,r);let a=hm(o)+hm(s);for(let i=e;i<n-e;i++){const e=t.children[i];om(o,t.leaf?r(e):e),a+=hm(o)}for(let i=n-e-1;i>=e;i--){const e=t.children[i];om(s,t.leaf?r(e):e),a+=hm(s)}return a}Pd(t,e,n){for(let i=n;i>=0;i--)om(e[i],t)}Rd(t){for(let e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():im(t[n],this.toBBox)}}function nm(t,e,n){if(!n)return e.indexOf(t);for(let i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function im(t,e){rm(t,0,t.children.length,e,t)}function rm(t,e,n,i,r){r||(r=dm(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let o=e;o<n;o++){const e=t.children[o];om(r,t.leaf?i(e):e)}return r}function om(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function sm(t,e){return t.minX-e.minX}function am(t,e){return t.minY-e.minY}function um(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function hm(t){return t.maxX-t.minX+(t.maxY-t.minY)}function lm(t,e){const n=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),r=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,r-n)*Math.max(0,o-i)}function cm(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function fm(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function dm(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function pm(t,e,n,i,r){const o=[e,n];for(;o.length;){if((n=o.pop())-(e=o.pop())<=i)continue;const s=e+Math.ceil((n-e)/i/2)*i;Zv(t,s,e,n,r),o.push(e,s,s,n)}}var vm,mm,ym,wm,gm,bm,_m={},xm=function(){if(vm)return _m;vm=1;var t=_m.Poi={};t.read=function(e,n){return e.readFields(t.jd,{minzoom:0,maxzoom:0,pos:[],poiid:"",indoorid:"",name:"",rank:0,name_zh:"",name_en:"",name_local:"",local_lang:"",character:[],character_en:[],name_spilt:[],altitude:0},n)},t.jd=function(t,e,n){1===t?e.minzoom=n.readVarint():2===t?e.maxzoom=n.readVarint():3===t?n.readPackedVarint(e.pos,!0):4===t?e.poiid=n.readString():5===t?e.indoorid=n.readString():6===t?e.name=n.readString():7===t?e.rank=n.readVarint():8===t?e.name_zh=n.readString():9===t?e.name_en=n.readString():10===t?e.name_local=n.readString():11===t?e.local_lang=n.readString():12===t?n.readPackedVarint(e.character):13===t?n.readPackedVarint(e.character_en):14===t?n.readPackedVarint(e.name_spilt):15===t&&(e.altitude=n.readVarint(!0))},t.write=function(t,e){t.minzoom&&e.writeVarintField(1,t.minzoom),t.maxzoom&&e.writeVarintField(2,t.maxzoom),t.pos&&e.writePackedVarint(3,t.pos),t.poiid&&e.writeStringField(4,t.poiid),t.indoorid&&e.writeStringField(5,t.indoorid),t.name&&e.writeStringField(6,t.name),t.rank&&e.writeVarintField(7,t.rank),t.name_zh&&e.writeStringField(8,t.name_zh),t.name_en&&e.writeStringField(9,t.name_en),t.name_local&&e.writeStringField(10,t.name_local),t.local_lang&&e.writeStringField(11,t.local_lang),t.character&&e.writePackedVarint(12,t.character),t.character_en&&e.writePackedVarint(13,t.character_en),t.name_spilt&&e.writePackedVarint(14,t.name_spilt),t.altitude&&e.writeVarintField(15,t.altitude)};var e=_m.PoiSameStyle={};e.read=function(t,n){return t.readFields(e.jd,{styleid:"",items:[],resolution:0},n)},e.jd=function(e,n,i){1===e?n.styleid=i.readString():2===e?n.items.push(t.read(i,i.readVarint()+i.pos)):3===e&&(n.resolution=i.readVarint())},e.write=function(e,n){if(e.styleid&&n.writeStringField(1,e.styleid),e.items)for(var i=0;i<e.items.length;i++)n.writeMessage(2,t.write,e.items[i]);e.resolution&&n.writeVarintField(3,e.resolution)};var n=_m.PoiLayer={};return n.read=function(t,e){return t.readFields(n.jd,{poilabel:[]},e)},n.jd=function(t,n,i){1===t&&n.poilabel.push(e.read(i,i.readVarint()+i.pos))},n.write=function(t,n){if(t.poilabel)for(var i=0;i<t.poilabel.length;i++)n.writeMessage(1,e.write,t.poilabel[i])},_m}(),km=function(){if(ym)return mm;ym=1;const t=2147483648;function e(t,e){const r=function(t,e){const r=i(t,e);let o=n(180),s=n(90);const a=o/(1<<r),u=s/(1<<r);return o=a>0?Math.floor(a+.5):Math.floor(a-.5),s=u>0?Math.floor(u+.5):Math.floor(u-.5),[o,s]}(t,e);return[2*r[0],2*r[1]]}function n(e){return Math.floor(e*t/180+.5)}function i(t,e){return 33-e-t}function r(e){return 180*e/t}function o(t,n){const i=e(t.z,n),r=i[0],o=i[1],s=1<<t.z;return[-r/2+t.x*r/s,o/2-(t.y+1)*o/s]}function s(t,e,n){const s=o(t,e),a=i(t.z,e);for(var u=[],h=0;h<n.length;h+=2){const t=n[h]+s[0];let e=t<<a;const i=n[h+1]+s[1]<<a;t>0&&e<0&&(e=2147483647);const o=r(e),l=r(i);u.push([o,l])}return u}function a(t){for(var e=0,n=2,i=t.length;n<i;n+=2)e+=((t[n]-t[n-2])**2+(t[n+1]-t[n-1])**2)**.5;return e}function u(t,e){for(var n=0,i=0,r=t.length;i<r;i+=2){var o=a(t.slice(i,i+4));if(!(o+n<e)){var s=(e-n)/o;return[Math.round(t[i]+s*(t[i+2]-t[i])),Math.round(t[i+1]+s*(t[i+3]-t[i+1])),i]}n+=o}return null}function h(t,e){e=e/180*Math.PI;let n=0,i=0,r=0;for(var o=2,s=t.length;o<s;o+=2){var a=t[o]-t[o-2],u=t[o+1]-t[o-1],h=(a**2+u**2)**.5;if(2==o)n=a,i=u,r=h;else{if(Math.acos((a*n+u*i)/h/r)>e)return!1;n=a,i=u,r=h}}return!0}return mm={getWorldSize:e,riseLevel:function(t,e,r,a){var u=function(t,e,r){var s=t.z;const a=o(t,e),u=i(s,e);for(var h=[],l=0;l<r.length;l+=1){var c=r[l][0],f=r[l][1];f<-90&&(f=-90),f>90&&(f=90),c<-180&&(c=-180),c>180&&(c=180);let t=n(c),e=n(f);const i=t/(1<<u),o=e/(1<<u);t=i>0?Math.floor(i+.5):Math.floor(i-.5),e=o>0?Math.floor(o+.5):Math.floor(o-.5),t-=a[0],e-=a[1],h.push(t,e)}return h}(a,r-1,s(e,r,t));return u},ptsLength:a,getSmoothSlice:function(t,e,n){for(var i=function(t,e){var n=[],i=[],r=a(t);if(r>=e){for(var o=Math.floor(r/e),s=1;s<=o;s+=1)n.push(u(t,e*s));var h=[],l=[],c=0,f=void 0;for(s=0;s<n.length;s+=1){f=n[s][2]+2;var d=t.slice(c,f);l=[n[s][0],n[s][1]];for(var p=h.concat(d).concat(l),v=2;v<p.length;v+=2)p[v]===p[v-2]&&p[v+1]===p[v-1]&&(p.splice(v,2),v-=2);i.push(p),h=l,c=f}return i}}(t,e)||[],r=0;r<i.length;r+=1)h(i[r],n)||(i.splice(r,1),r-=1);return i},tileInnerCoords2LngLat:s,tileInnerCoord2LngLat:function(t,e,n,s){const a=o(t,e),u=n+a[0],h=s+a[1],l=i(t.z,e);return n=u<<l,s=h<<l,u>0&&n<0&&(n=2147483647),[r(n),r(s)]}},mm}(),$m={},Sm=function(){if(bm)return gm;bm=1,gm=e;var t=(wm||(wm=1,$m.read=function(t,e,n,i,r){var o,s,a=8*r-i-1,u=(1<<a)-1,h=u>>1,l=-7,c=n?r-1:0,f=n?-1:1,d=t[e+c];for(c+=f,o=d&(1<<-l)-1,d>>=-l,l+=a;l>0;o=256*o+t[e+c],c+=f,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=i;l>0;s=256*s+t[e+c],c+=f,l-=8);if(0===o)o=1-h;else{if(o===u)return s?NaN:1/0*(d?-1:1);s+=Math.pow(2,i),o-=h}return(d?-1:1)*s*Math.pow(2,o-i)},$m.write=function(t,e,n,i,r,o){var s,a,u,h=8*o-r-1,l=(1<<h)-1,c=l>>1,f=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,d=i?0:o-1,p=i?1:-1,v=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-s))<1&&(s--,u*=2),(e+=s+c>=1?f/u:f*Math.pow(2,1-c))*u>=2&&(s++,u/=2),s+c>=l?(a=0,s=l):s+c>=1?(a=(e*u-1)*Math.pow(2,r),s+=c):(a=e*Math.pow(2,c-1)*Math.pow(2,r),s=0));r>=8;t[n+d]=255&a,d+=p,a/=256,r-=8);for(s=s<<r|a,h+=r;h>0;t[n+d]=255&s,d+=p,s/=256,h-=8);t[n+d-p]|=128*v}),$m);function e(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var n=4294967296,i=1/n,r="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");function o(t){return t.type===e.Bytes?t.readVarint()+t.pos:t.pos+1}function s(t,e,n){return n?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function a(t,e,n){var i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(i);for(var r=n.pos-1;r>=t;r--)n.buf[r+i]=n.buf[r]}function u(t,e){for(var n=0;n<t.length;n++)e.writeVarint(t[n])}function h(t,e){for(var n=0;n<t.length;n++)e.writeSVarint(t[n])}function l(t,e){for(var n=0;n<t.length;n++)e.writeFloat(t[n])}function c(t,e){for(var n=0;n<t.length;n++)e.writeDouble(t[n])}function f(t,e){for(var n=0;n<t.length;n++)e.writeBoolean(t[n])}function d(t,e){for(var n=0;n<t.length;n++)e.writeFixed32(t[n])}function p(t,e){for(var n=0;n<t.length;n++)e.writeSFixed32(t[n])}function v(t,e){for(var n=0;n<t.length;n++)e.writeFixed64(t[n])}function m(t,e){for(var n=0;n<t.length;n++)e.writeSFixed64(t[n])}function y(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function w(t,e,n){t[n]=e,t[n+1]=e>>>8,t[n+2]=e>>>16,t[n+3]=e>>>24}function g(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(t,e,n){for(n=n||this.length;this.pos<n;){var i=this.readVarint(),r=i>>3,o=this.pos;this.type=7&i,t(r,e,this),this.pos===o&&this.skip(i)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=y(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=g(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=y(this.buf,this.pos)+y(this.buf,this.pos+4)*n;return this.pos+=8,t},readSFixed64:function(){var t=y(this.buf,this.pos)+g(this.buf,this.pos+4)*n;return this.pos+=8,t},readFloat:function(){var e=t.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=t.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(t){var e,n,i=this.buf;return e=127&(n=i[this.pos++]),n<128?e:(e|=(127&(n=i[this.pos++]))<<7,n<128?e:(e|=(127&(n=i[this.pos++]))<<14,n<128?e:(e|=(127&(n=i[this.pos++]))<<21,n<128?e:function(t,e,n){var i,r,o=n.buf;if(i=(112&(r=o[n.pos++]))>>4,r<128)return s(t,i,e);if(i|=(127&(r=o[n.pos++]))<<3,r<128)return s(t,i,e);if(i|=(127&(r=o[n.pos++]))<<10,r<128)return s(t,i,e);if(i|=(127&(r=o[n.pos++]))<<17,r<128)return s(t,i,e);if(i|=(127&(r=o[n.pos++]))<<24,r<128)return s(t,i,e);if(i|=(1&(r=o[n.pos++]))<<31,r<128)return s(t,i,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(n=i[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&r?function(t,e,n){return r.decode(t.subarray(e,n))}(this.buf,e,t):function(t,e,n){for(var i="",r=e;r<n;){var o,s,a,u=t[r],h=null,l=u>239?4:u>223?3:u>191?2:1;if(r+l>n)break;1===l?u<128&&(h=u):2===l?128==(192&(o=t[r+1]))&&(h=(31&u)<<6|63&o)<=127&&(h=null):3===l?(o=t[r+1],s=t[r+2],128==(192&o)&&128==(192&s)&&((h=(15&u)<<12|(63&o)<<6|63&s)<=2047||h>=55296&&h<=57343)&&(h=null)):4===l&&(o=t[r+1],s=t[r+2],a=t[r+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&((h=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)<=65535||h>=1114112)&&(h=null)),null===h?(h=65533,l=1):h>65535&&(h-=65536,i+=String.fromCharCode(h>>>10&1023|55296),h=56320|1023&h),i+=String.fromCharCode(h),r+=l}return i}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,n){if(this.type!==e.Bytes)return t.push(this.readVarint(n));var i=o(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(n));return t},readPackedSVarint:function(t){if(this.type!==e.Bytes)return t.push(this.readSVarint());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==e.Bytes)return t.push(this.readBoolean());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==e.Bytes)return t.push(this.readFloat());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==e.Bytes)return t.push(this.readDouble());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==e.Bytes)return t.push(this.readFixed32());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==e.Bytes)return t.push(this.readSFixed32());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==e.Bytes)return t.push(this.readFixed64());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==e.Bytes)return t.push(this.readSFixed64());var n=o(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed64());return t},skip:function(t){var n=7&t;if(n===e.Varint)for(;this.buf[this.pos++]>127;);else if(n===e.Bytes)this.pos=this.readVarint()+this.pos;else if(n===e.Fixed32)this.pos+=4;else{if(n!==e.Fixed64)throw new Error("Unimplemented type: "+n);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),w(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),w(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),w(this.buf,-1&t,this.pos),w(this.buf,Math.floor(t*i),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),w(this.buf,-1&t,this.pos),w(this.buf,Math.floor(t*i),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var n,i;if(t>=0?(n=t%4294967296|0,i=t/4294967296|0):(i=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,i=i+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,n){n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos]=127&t}(n,0,e),function(t,e){var n=(7&t)<<4;e.buf[e.pos++]|=n|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t)))))}(i,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,n){for(var i,r,o=0;o<e.length;o++){if((i=e.charCodeAt(o))>55295&&i<57344){if(!r){i>56319||o+1===e.length?(t[n++]=239,t[n++]=191,t[n++]=189):r=i;continue}if(i<56320){t[n++]=239,t[n++]=191,t[n++]=189,r=i;continue}i=r-55296<<10|i-56320|65536,r=null}else r&&(t[n++]=239,t[n++]=191,t[n++]=189,r=null);i<128?t[n++]=i:(i<2048?t[n++]=i>>6|192:(i<65536?t[n++]=i>>12|224:(t[n++]=i>>18|240,t[n++]=i>>12&63|128),t[n++]=i>>6&63|128),t[n++]=63&i|128)}return n}(this.buf,t,this.pos);var n=this.pos-e;n>=128&&a(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),t.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),t.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var n=0;n<e;n++)this.buf[this.pos++]=t[n]},writeRawMessage:function(t,e){this.pos++;var n=this.pos;t(e,this);var i=this.pos-n;i>=128&&a(n,i,this),this.pos=n-1,this.writeVarint(i),this.pos+=i},writeMessage:function(t,n,i){this.writeTag(t,e.Bytes),this.writeRawMessage(n,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,u,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,h,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,f,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,l,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,c,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,d,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,p,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,v,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,m,e)},writeBytesField:function(t,n){this.writeTag(t,e.Bytes),this.writeBytes(n)},writeFixed32Field:function(t,n){this.writeTag(t,e.Fixed32),this.writeFixed32(n)},writeSFixed32Field:function(t,n){this.writeTag(t,e.Fixed32),this.writeSFixed32(n)},writeFixed64Field:function(t,n){this.writeTag(t,e.Fixed64),this.writeFixed64(n)},writeSFixed64Field:function(t,n){this.writeTag(t,e.Fixed64),this.writeSFixed64(n)},writeVarintField:function(t,n){this.writeTag(t,e.Varint),this.writeVarint(n)},writeSVarintField:function(t,n){this.writeTag(t,e.Varint),this.writeSVarint(n)},writeStringField:function(t,n){this.writeTag(t,e.Bytes),this.writeString(n)},writeFloatField:function(t,n){this.writeTag(t,e.Fixed32),this.writeFloat(n)},writeDoubleField:function(t,n){this.writeTag(t,e.Fixed64),this.writeDouble(n)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}},gm}(),Em=wf(Sm);class Mm{Zo;Jo="PoiDataSource";ts=!1;es;ns;rs;_show=!0;ss;_scene;_id=0;We;Ld=1;Bd={};Hd;Ed=0;Wd={};tilesetUrl;tileset;SSE;constructor(t){this.es=new i.Event,this.ns=new i.Event,this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this._scene=t.scene,this.tilesetUrl=t.tileset,this.Hd=this.tilesetUrl.substring(0,this.tilesetUrl.lastIndexOf("/")),this.SSE=t.SSE,this.We=new Bc({Pi:30,Fi:this.onDrop})}Vd=!1;onDrop=(t,e)=>{delete this.Bd[t],this.Vd=!0};async loadTileset(){try{const t=await fetch(this.tilesetUrl),e=await t.json();this.tileset=e}catch(t){}}getViewFrustum(){const t=this._scene.camera,e=this.tileset.metadata.enuCenterGCJ02,n=t.frustum.computeCullingVolume(t.positionWC,t.directionWC,t.upWC).planes,r=i.Cartesian3.fromDegrees(...e),o=i.Transforms.eastNorthUpToFixedFrame(r),s=i.Matrix4.inverse(o,new i.Matrix4),a=n.map((t=>{const e=new i.Cartesian3(t.x,t.y,t.z),n=t.w,r=i.Matrix4.multiplyByPointAsVector(s,e,new i.Cartesian3),o=i.Cartesian3.multiplyByScalar(e,-n,new i.Cartesian3),a=i.Matrix4.multiplyByPoint(s,o,new i.Cartesian3),u=-i.Cartesian3.dot(r,a);return new i.Cartesian4(r.x,r.y,r.z,u)}));return new i.CullingVolume(a)}getTileKey(t){return t.coord.join("-")}computeTilesToRender(){if(!this.tileset)return{};const t=this._scene.camera,e=t.frustum.sseDenominator,n=this._scene.context.drawingBufferHeight,{enuCenterGCJ02:r}=this.tileset.metadata,o=this.getViewFrustum(),s=this.tileset.root,a=Ic(t.position,r),u=t=>{const e=new i.Cartesian3(t[0],t[1],t[2]),n=new i.Cartesian3(t[0]-t[3],t[1]-t[7],t[2]-t[11]),r=new i.Cartesian3(t[0]+t[3],t[1]-t[7],t[2]-t[11]),o=new i.Cartesian3(t[0]-t[3],t[1]+t[7],t[2]-t[11]),s=new i.Cartesian3(t[0]+t[3],t[1]+t[7],t[2]-t[11]);return Math.min(i.Cartesian3.distance(a,e),i.Cartesian3.distance(a,n),i.Cartesian3.distance(a,r),i.Cartesian3.distance(a,o),i.Cartesian3.distance(a,s))},h={},l={},c=[s];for(;c.length;){let t=c.length;for(let r=0;r<t;r++){const t=c.shift(),r=t.boundingVolume.box,a=new i.Cartesian3(r[0]-r[3],r[1]-r[7],r[2]-r[11]),f=new i.Cartesian3(r[0]+r[3],r[1]+r[7],r[2]+r[11]),d=new i.AxisAlignedBoundingBox(a,f);if(o.computeVisibility(d)!==i.Intersect.OUTSIDE){const i=u(r),o=t.geometricError*n/(i*e),a=t.children.length>0;if(t===s||o>this.SSE&&a){let e;if(t.coord){const n=t.content.uri,i=n.startsWith("http")?n:this.Hd+"/"+n,r=this.getTileKey(t);h[r]=i,l[r]&&delete h[l[r]],e=r}for(let n=0;n<t.children.length;n++)c.push(t.children[n]),e&&(l[this.getTileKey(t.children[n])]=e)}else if(t.coord){const e=t.content.uri,n=e.startsWith("http")?e:this.Hd+"/"+e,i=this.getTileKey(t);h[i]=n,l[i]&&delete h[l[i]]}}}}return h}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}update(){const t=Date.now();if(t-this.Ed<1e3)return!0;if(this.Ed=t,!this.tileset&&2!==this.Ld)return this.loadTileset(),!0;const e=this.computeTilesToRender(),n=this.tileChanged(this.Wd,e);if(this.Wd=e,!n&&!this.Vd)return!0;this.Vd=!1;const i=Object.keys(e);for(let t=0;t<i.length;t++){const n=i[t];this.We.Zi(n)||2===this.Bd[n]||this.fetchTile(n,e[n])}return!0}tileChanged(t,e){const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!0;for(let t=0;t<n.length;t++)if(!e[n[t]])return!0;return!1}async fetchTile(t,e){try{this.Bd[t]=2;const n=await fetch(e),r=await n.arrayBuffer(),o=new Em(r),s=xm.PoiLayer.read(o),a=t.split("-").map((t=>parseInt(t,10))),u={z:a[0],x:a[1],y:a[2]};let h=[];for(let t=0;t<s.poilabel.length;t++){const e=s.poilabel[t],n=[];e.items.forEach((t=>{n.push(t.pos[0],t.pos[1])}));const r=km.tileInnerCoords2LngLat(u,e.resolution,n);e.items.forEach(((t,n)=>{h.push({position:i.Cartesian3.fromDegrees(r[n][0],r[n][1],t.altitude),name:t.name,rank:t.rank,poiid:t.poiid,minzoom:t.minzoom,maxzoom:t.maxzoom,id:++this._id,coord:[u.z,u.x,u.y],styleId:e.styleid,type:"poi"})}))}this.We.Xi(t,h),this.Bd[t]=3,this.changedEvent.raiseEvent(t)}catch(e){this.Bd[t]=4}}getData(){const t=this.Wd,e=Object.keys(t);let n=[];for(let t=0;t<e.length;t++){const i=this.We.Yi(e[t],!1);i&&(n=n.concat(i))}return n.sort(((t,e)=>t.rank!=e.rank?t.rank<e.rank:t.coord[0]!=e.coord[0]?t.coord[0]>e.coord[0]:t.id<e.id)),n}}var Cm,Am={},Om=function(){if(Cm)return Am;Cm=1;var t=Am.Road={};t.read=function(e,n){return e.readFields(t.jd,{minzoom:0,maxzoom:0,path:[],shield:"",shieldType:0,name:"",rank:0,name_zh:"",name_en:"",name_local:"",local_lang:"",character:[],id:0},n)},t.jd=function(t,e,n){1===t?e.minzoom=n.readVarint():2===t?e.maxzoom=n.readVarint():3===t?n.readPackedVarint(e.path,!0):4===t?e.shield=n.readString():5===t?e.shieldType=n.readVarint():6===t?e.name=n.readString():7===t?e.rank=n.readVarint():8===t?e.name_zh=n.readString():9===t?e.name_en=n.readString():10===t?e.name_local=n.readString():11===t?e.local_lang=n.readString():12===t?n.readPackedVarint(e.character):13===t&&(e.id=n.readVarint())},t.write=function(t,e){t.minzoom&&e.writeVarintField(1,t.minzoom),t.maxzoom&&e.writeVarintField(2,t.maxzoom),t.path&&e.writePackedVarint(3,t.path),t.shield&&e.writeStringField(4,t.shield),t.shieldType&&e.writeVarintField(5,t.shieldType),t.name&&e.writeStringField(6,t.name),t.rank&&e.writeVarintField(7,t.rank),t.name_zh&&e.writeStringField(8,t.name_zh),t.name_en&&e.writeStringField(9,t.name_en),t.name_local&&e.writeStringField(10,t.name_local),t.local_lang&&e.writeStringField(11,t.local_lang),t.character&&e.writePackedVarint(12,t.character),t.id&&e.writeVarintField(13,t.id)};var e=Am.RoadSameStyle={};e.read=function(t,n){return t.readFields(e.jd,{styleid:"",items:[],resolution:0},n)},e.jd=function(e,n,i){1===e?n.styleid=i.readString():2===e?n.items.push(t.read(i,i.readVarint()+i.pos)):3===e&&(n.resolution=i.readVarint())},e.write=function(e,n){if(e.styleid&&n.writeStringField(1,e.styleid),e.items)for(var i=0;i<e.items.length;i++)n.writeMessage(2,t.write,e.items[i]);e.resolution&&n.writeVarintField(3,e.resolution)};var n=Am.RoadLayer={};return n.read=function(t,e){return t.readFields(n.jd,{road:[]},e)},n.jd=function(t,n,i){1===t&&n.road.push(e.read(i,i.readVarint()+i.pos))},n.write=function(t,n){if(t.road)for(var i=0;i<t.road.length;i++)n.writeMessage(1,e.write,t.road[i])},Am}();class Im{Zo;Jo="RoadDataSource";ts=!1;es;ns;rs;_show=!0;ss;_scene;_id=0;We;Ld=1;Bd={};Hd;Ed=0;Wd={};tilesetUrl;tileset;SSE;constructor(t){this.es=new i.Event,this.ns=new i.Event,this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this._scene=t.scene,this.tilesetUrl=t.tileset,this.Hd=this.tilesetUrl.substring(0,this.tilesetUrl.lastIndexOf("/")),this.SSE=t.SSE,this.We=new Bc({Pi:30,Fi:this.onDrop})}Vd=!1;onDrop=(t,e)=>{delete this.Bd[t],this.Vd=!0};async loadTileset(){try{const t=await fetch(this.tilesetUrl),e=await t.json();this.tileset=e}catch(t){}}getViewFrustum(){const t=this._scene.camera,e=this.tileset.metadata.enuCenterGCJ02,n=t.frustum.computeCullingVolume(t.positionWC,t.directionWC,t.upWC).planes,r=i.Cartesian3.fromDegrees(...e),o=i.Transforms.eastNorthUpToFixedFrame(r),s=i.Matrix4.inverse(o,new i.Matrix4),a=n.map((t=>{const e=new i.Cartesian3(t.x,t.y,t.z),n=t.w,r=i.Matrix4.multiplyByPointAsVector(s,e,new i.Cartesian3),o=i.Cartesian3.multiplyByScalar(e,-n,new i.Cartesian3),a=i.Matrix4.multiplyByPoint(s,o,new i.Cartesian3),u=-i.Cartesian3.dot(r,a);return new i.Cartesian4(r.x,r.y,r.z,u)}));return new i.CullingVolume(a)}getTileKey(t){return t.coord.join("-")}computeTilesToRender(){if(!this.tileset)return{};const t=this._scene.camera,e=t.frustum.sseDenominator,n=this._scene.context.drawingBufferHeight,{enuCenterGCJ02:r}=this.tileset.metadata,o=this.getViewFrustum(),s=this.tileset.root,a=Ic(t.position,r),u=t=>{const e=new i.Cartesian3(t[0],t[1],t[2]),n=new i.Cartesian3(t[0]-t[3],t[1]-t[7],t[2]-t[11]),r=new i.Cartesian3(t[0]+t[3],t[1]-t[7],t[2]-t[11]),o=new i.Cartesian3(t[0]-t[3],t[1]+t[7],t[2]-t[11]),s=new i.Cartesian3(t[0]+t[3],t[1]+t[7],t[2]-t[11]);return Math.min(i.Cartesian3.distance(a,e),i.Cartesian3.distance(a,n),i.Cartesian3.distance(a,r),i.Cartesian3.distance(a,o),i.Cartesian3.distance(a,s))},h={},l={},c=[s];for(;c.length;){let t=c.length;for(let r=0;r<t;r++){const t=c.shift(),r=t.boundingVolume.box,a=new i.Cartesian3(r[0]-r[3],r[1]-r[7],r[2]-r[11]),f=new i.Cartesian3(r[0]+r[3],r[1]+r[7],r[2]+r[11]),d=new i.AxisAlignedBoundingBox(a,f);if(o.computeVisibility(d)!==i.Intersect.OUTSIDE){const i=u(r),o=t.geometricError*n/(i*e),a=t.children.length>0;if(t===s||o>this.SSE&&a){let e;if(t.coord){const n=t.content.uri,i=n.startsWith("http")?n:this.Hd+"/"+n,r=this.getTileKey(t);h[r]=i,l[r]&&delete l[r],e=r}for(let n=0;n<t.children.length;n++)c.push(t.children[n]),e&&(l[this.getTileKey(t.children[n])]=e)}else if(t.coord){const e=t.content.uri,n=e.startsWith("http")?e:this.Hd+"/"+e,i=this.getTileKey(t);h[i]=n,l[i]&&delete l[i]}}}}return h}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}update(){const t=Date.now();if(t-this.Ed<1e3)return!0;if(this.Ed=t,!this.tileset&&2!==this.Ld)return this.loadTileset(),!0;const e=this.computeTilesToRender(),n=this.tileChanged(this.Wd,e);if(this.Wd=e,!n&&!this.Vd)return!0;this.Vd=!1;const i=Object.keys(e);for(let t=0;t<i.length;t++){const n=i[t];this.We.Zi(n)||2===this.Bd[n]||this.fetchTile(n,e[n])}return!0}tileChanged(t,e){const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!0;for(let t=0;t<n.length;t++)if(!e[n[t]])return!0;return!1}async fetchTile(e,n){try{this.Bd[e]=2;const i=await fetch(n),r=await i.arrayBuffer(),o=new Em(r),s=Om.RoadLayer.read(o),a=e.split("-").map((t=>parseInt(t,10))),u={z:a[0],x:a[1],y:a[2]};let h=[];for(let e=0;e<s.road.length;e++){const n=s.road[e],{resolution:i,styleid:r,items:o}=n;if(20015!==parseInt(r.split(":")[0],10))for(let e=0;e<o.length;e++){const n=o[e];if(!(n.path.length<6))if(n.shield){const{rank:e,minzoom:r,maxzoom:o,shield:s,shieldType:a,path:l}=n,c=[l[0],l[1],l[2]],f=km.tileInnerCoords2LngLat(u,i,[c[0],c[1]])[0],d={coord:u,name:s,styleId:`40001:${a}`,rank:e,minzoom:r,maxzoom:o,position:t.Cartesian3.fromDegrees(f[0],f[1],c[2]),id:++this._id,type:"road",subType:"guideboard"};h.push(d)}else if(n.name){const{rank:e,minzoom:o,maxzoom:s,path:a,name:l}=n,c=a.length/3,f=[];for(let t=0;t<c;t+=1)f.push(a[3*t],a[3*t+1]);const d=km.tileInnerCoords2LngLat(u,i,f);for(let t=0;t<c;t+=1)d[t].push(a[3*t+2]);let p=d[0],v=d[c-1];const m=t.Cartesian3.fromDegrees(p[0],p[1],p[2]),y=t.Cartesian3.fromDegrees(v[0],v[1],v[2]);let w,g,b;if(t.Cartesian3.distance(m,y)>100){if(c>2){let e,n,i=0,r=-1/0;for(let o=0;o<d.length-1;o++){const s=Math.max(d[o][2],d[o+1][2]);e=t.Cartesian3.fromDegrees(d[o][0],d[o][1],s),n=t.Cartesian3.fromDegrees(d[o+1][0],d[o+1][1],s);const a=t.Cartesian3.distance(e,n);a>r&&(r=a,i=o,w=e,g=n)}b=t.Cartesian3.midpoint(w,g,new t.Cartesian3)}else{const e=Math.max(p[2],v[2]);w=t.Cartesian3.fromDegrees(p[0],p[1],e),g=t.Cartesian3.fromDegrees(v[0],v[1],e),b=t.Cartesian3.midpoint(w,g,new t.Cartesian3)}const n=t.Cartesian3.subtract(g,w,new t.Cartesian3),i=t.Cartesian3.magnitude(n);let a;const f=1e4;a=i<f?new t.Cartesian3(w.x+f/i*n.x,w.y+f/i*n.y,w.z+f/i*n.z):g;const m={coord:u,name:l,styleId:r,rank:e,minzoom:o,maxzoom:s,position:b,start:w,end:a,id:++this._id,type:"road",subType:"roadname",path:d};h.push(m)}}}}this.We.Xi(e,h),this.Bd[e]=3,this.changedEvent.raiseEvent(e)}catch(t){this.Bd[e]=4}}getData(){const t=this.Wd,e=Object.keys(t);let n=[];for(let t=0;t<e.length;t++){const i=this.We.Yi(e[t],!1);i&&(n=n.concat(i))}return n.sort(((t,e)=>t.rank!=e.rank?t.rank<e.rank:t.coord[0]!=e.coord[0]?t.coord[0]>e.coord[0]:t.id<e.id)),n}}var Tm,zm,Rm,Fm=wf(function(){if(zm)return Tm;zm=1;var t=/^\s+|\s+$/g,e=/^[-+]0x[0-9a-f]+$/i,n=/^0b[01]+$/i,i=/^0o[0-7]+$/i,r=parseInt,o="object"==typeof yf&&yf&&yf.Object===Object&&yf,s="object"==typeof self&&self&&self.Object===Object&&self,a=o||s||Function("","return this")(),u={}.toString,h=Math.max,l=Math.min,c=function(){return a.Date.now()};function f(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function d(o){if("number"==typeof o)return o;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&"[object Symbol]"==u.call(t)}(o))return NaN;if(f(o)){var s="function"==typeof o.valueOf?o.valueOf():o;o=f(s)?s+"":s}if("string"!=typeof o)return 0===o?o:+o;o=o.replace(t,"");var a=n.test(o);return a||i.test(o)?r(o.slice(2),a?2:8):e.test(o)?NaN:+o}return Tm=function(t,e,n){var i,r,o,s,a,u,p=0,v=!1,m=!1,y=!0;if("function"!=typeof t)throw new TypeError("Expected a function");function w(e){var n=i,o=r;return i=r=void 0,p=e,s=t.apply(o,n)}function g(t){var n=t-u;return void 0===u||n>=e||n<0||m&&t-p>=o}function b(){var t=c();if(g(t))return _(t);a=setTimeout(b,function(t){var n=e-(t-u);return m?l(n,o-(t-p)):n}(t))}function _(t){return a=void 0,y&&i?w(t):(i=r=void 0,s)}function x(){var t=c(),n=g(t);if(i=arguments,r=this,u=t,n){if(void 0===a)return function(t){return p=t,a=setTimeout(b,e),v?w(t):s}(u);if(m)return a=setTimeout(b,e),w(u)}return void 0===a&&(a=setTimeout(b,e)),s}return e=d(e)||0,f(n)&&(v=!!n.leading,o=(m="maxWait"in n)?h(d(n.maxWait)||0,e):o,y="trailing"in n?!!n.trailing:y),x.cancel=function(){void 0!==a&&clearTimeout(a),p=0,i=u=r=a=void 0},x.flush=function(){return void 0===a?s:_(c())},x}}()),Dm={exports:{}},Pm=(Rm||(Rm=1,function(t){!function(){function e(t,e){document.addEventListener?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function n(t){this.g=document.createElement("div"),this.g.setAttribute("aria-hidden","true"),this.g.appendChild(document.createTextNode(t)),this.h=document.createElement("span"),this.i=document.createElement("span"),this.m=document.createElement("span"),this.j=document.createElement("span"),this.l=-1,this.h.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.i.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.j.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.m.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.h.appendChild(this.m),this.i.appendChild(this.j),this.g.appendChild(this.h),this.g.appendChild(this.i)}function i(t,e){t.g.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+e+";"}function r(t){var e=t.g.offsetWidth,n=e+100;return t.j.style.width=n+"px",t.i.scrollLeft=n,t.h.scrollLeft=t.h.scrollWidth+100,t.l!==e&&(t.l=e,!0)}function o(t,n){function i(){var t=o;r(t)&&null!==t.g.parentNode&&n(t.l)}var o=t;e(t.h,i),e(t.i,i),r(t)}function s(t,e,n){e=e||{},n=n||window,this.family=t,this.style=e.style||"normal",this.weight=e.weight||"normal",this.stretch=e.stretch||"normal",this.context=n}var a=null,u=null,h=null,l=null;function c(t){return null===l&&(l=!!t.document.fonts),l}function f(t,e){var n=t.style,i=t.weight;if(null===h){var r=document.createElement("div");try{r.style.font="condensed 100px sans-serif"}catch(t){}h=""!==r.style.font}return[n,i,h?t.stretch:"","100px",e].join(" ")}s.prototype.load=function(t,e){var r=this,s=t||"BESbswy",h=0,l=e||3e3,d=(new Date).getTime();return new Promise((function(t,e){if(c(r.context)&&!function(t){return null===u&&(c(t)&&/Apple/.test(window.navigator.vendor)?(t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent),u=!!t&&603>parseInt(t[1],10)):u=!1),u}(r.context)){var p=new Promise((function(t,e){!function n(){(new Date).getTime()-d>=l?e(Error(l+"ms timeout exceeded")):r.context.document.fonts.load(f(r,'"'+r.family+'"'),s).then((function(e){1<=e.length?t():setTimeout(n,25)}),e)}()})),v=new Promise((function(t,e){h=setTimeout((function(){e(Error(l+"ms timeout exceeded"))}),l)}));Promise.race([v,p]).then((function(){clearTimeout(h),t(r)}),e)}else!function(t){document.body?t():document.addEventListener?document.addEventListener("DOMContentLoaded",(function e(){document.removeEventListener("DOMContentLoaded",e),t()})):document.attachEvent("onreadystatechange",(function e(){"interactive"!=document.readyState&&"complete"!=document.readyState||(document.detachEvent("onreadystatechange",e),t())}))}((function(){function u(){var e;(e=-1!=m&&-1!=y||-1!=m&&-1!=w||-1!=y&&-1!=w)&&((e=m!=y&&m!=w&&y!=w)||(null===a&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),a=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=a&&(m==g&&y==g&&w==g||m==b&&y==b&&w==b||m==_&&y==_&&w==_)),e=!e),e&&(null!==x.parentNode&&x.parentNode.removeChild(x),clearTimeout(h),t(r))}var c=new n(s),p=new n(s),v=new n(s),m=-1,y=-1,w=-1,g=-1,b=-1,_=-1,x=document.createElement("div");x.dir="ltr",i(c,f(r,"sans-serif")),i(p,f(r,"serif")),i(v,f(r,"monospace")),x.appendChild(c.g),x.appendChild(p.g),x.appendChild(v.g),r.context.document.body.appendChild(x),g=c.g.offsetWidth,b=p.g.offsetWidth,_=v.g.offsetWidth,function t(){if((new Date).getTime()-d>=l)null!==x.parentNode&&x.parentNode.removeChild(x),e(Error(l+"ms timeout exceeded"));else{var n=r.context.document.hidden;!0!==n&&void 0!==n||(m=c.g.offsetWidth,y=p.g.offsetWidth,w=v.g.offsetWidth,u()),h=setTimeout(t,50)}}(),o(c,(function(t){m=t,u()})),i(c,f(r,'"'+r.family+'",sans-serif')),o(p,(function(t){y=t,u()})),i(p,f(r,'"'+r.family+'",serif')),o(v,(function(t){w=t,u()})),i(v,f(r,'"'+r.family+'",monospace'))}))}))},t.exports=s}()}(Dm)),Dm.exports),Nm=wf(Pm);class Um{Ln;_scene;_labels;Gd;Yd;Kd;Xd={};Qd={};disableDepthTestDistance=2e3;fontSize="20";fontFamily="AlibabaPuHuiTi";styleUrl="https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/static/3dgs/cesiumjs-sdk/dist/style.json";styles=null;fontStyle="normal";fontWeight="800";iconSize=24;iconTextSpacing=4;lineHeight=void 0;Zd;tileset;Jd=200;ve=!1;tp=[];ep=12e4;np=!1;ip=1e3;collisionBuffer=new i.Cartesian2(20,20);rp=0;set SSE(t){this.Jd=t,this.poiDataSource.SSE=this.Jd,this.roadDataSource.SSE=this.Jd}get SSE(){return this.Jd}poiDataSource;roadDataSource;_dirty=!0;op=new i.Cartesian3(0,0,0);sp=new i.Cartesian3(0,0,0);preloadSDF=!0;preloadSDFTextureUrl="https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/static/3dgs/cesiumjs-sdk/AlibabaPuHuiTi-2-55-Regular/SDF.png";preloadSDFConfigUrl="https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/static/3dgs/cesiumjs-sdk/AlibabaPuHuiTi-2-55-Regular/SDF.json";constructor(e){this.Zd=new em,this.preloadSDF=!1!==e.preloadSDF,this._labels=new Kv({blendOption:t.BlendOption.TRANSLUCENT,scene:e.viewer.scene,preloadSDF:this.preloadSDF,preloadSDFTextureUrl:this.preloadSDFTextureUrl,preloadSDFConfigUrl:this.preloadSDFConfigUrl}),this.Yd=new Kv({blendOption:t.BlendOption.TRANSLUCENT,scene:e.viewer.scene,reuseBillboards:!1}),this.Gd=new ev({blendOption:t.BlendOption.TRANSLUCENT}),this.Kd=new ev({blendOption:t.BlendOption.TRANSLUCENT}),this.Ln=e.viewer,this._scene=e.viewer.scene,this.poiDataSource=new Mm({scene:this._scene,tileset:e.poiTileset,SSE:this.SSE}),this.roadDataSource=new Im({scene:this._scene,tileset:e.roadTileset,SSE:this.SSE}),this.Ln.dataSources.add(this.poiDataSource),this.Ln.dataSources.add(this.roadDataSource),this.onData=Fm(this.onData,500,{maxWait:1e3}),this.poiDataSource.changedEvent.addEventListener(this.onData),this.roadDataSource.changedEvent.addEventListener(this.onData),this.ap(),this.hp(),this.Ln.camera.moveEnd.addEventListener(this.requestRender)}set show(t){this._labels.show=!!t,this.Yd.show=!!t,this.Gd.show=!!t,this.Kd.show=!!t}get show(){return this._labels.show}onData=()=>{this.ve||(this._dirty=!0,this.requestRender())};update(t){if(!this.styles||!this.show||!this.np)return;if(!this._labels.preloaded)return;const e=this._scene.camera.position.clone(),{heading:n,pitch:r,roll:o}=this._scene.camera,s=new i.Cartesian3(n,r,o),a=i.Cartesian3.distance(e,this.op)<1&&i.Cartesian3.equalsEpsilon(s,this.sp,Math.PI/180),u=Date.now();if(u-this.rp>this.ip&&(!a||this._dirty)){this.rp=u,this.op=e,this.sp=s,this._dirty=!1;let t=this.poiDataSource.getData();this.tp.length&&(t=[].concat(this.tp).concat(t));const n=this.roadDataSource.getData(),i=this.computeItemsToRender(t,n),{pois:r,roads:o}=i;this.updateRoads(this.Qd,o),this.updatePois(this.Xd,r)}this.Kd.update(t),this.Yd.update(t),this.Gd.update(t),this._labels.update(t)}isDestroyed(){return this.ve}destroy(){this._labels.destroy(),this.Gd.destroy(),this.Yd.destroy(),this.Kd.destroy(),this.Xd={},this.Qd={},this.poiDataSource.changedEvent.removeEventListener(this.onData),this.roadDataSource.changedEvent.removeEventListener(this.onData),this.ve=!0,this.Ln.camera.moveEnd.removeEventListener(this.requestRender),this.requestRender()}addPoi(e){const n=`${Math.min(Math.floor(this.getZoom()),20)}:${e.styleId}`,r={...this.styles[n]};if(r)if(0===r.layout){const t=this.iconSize*r.transform[0],n=this.iconSize*r.transform[1],o=this.getIconUrl(r.file),s=this.Gd.add({position:e.position,image:o,horizontalOrigin:i.HorizontalOrigin.CENTER,verticalOrigin:i.VerticalOrigin.CENTER,width:t,height:n,disableDepthTestDistance:this.disableDepthTestDistance});this.Xd[e.id]={icon:s}}else if(1===r.layout){const n=e.name,o={text:n,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${r.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:r.size/t.SDFSettings.FONT_SIZE,relativeSize:r.size/t.SDFSettings.FONT_SIZE},s=this._labels.computeLabelSize(o),a=new t.Cartesian2(-s.width/2,-s.height/2),u=this.lineHeight?`/${this.lineHeight}px`:"",h=`${this.fontStyle} ${this.fontWeight} ${r.size}px${u} ${this.fontFamily}`,l=this._labels.add({position:e.position,text:n,font:h,horizontalOrigin:i.HorizontalOrigin.LEFT,verticalOrigin:i.VerticalOrigin.TOP,fillColor:i.Color.fromCssColorString(r.fill),style:i.LabelStyle.FILL_AND_OUTLINE,disableDepthTestDistance:this.disableDepthTestDistance,outlineColor:i.Color.fromCssColorString(r.haloFill),outlineWidth:r.haloRadius,pixelOffset:a});this.Xd[e.id]={label:l}}else if(2===r.layout){const n=e.name,o=this.iconSize*r.transform[0],s=this.iconSize*r.transform[1],a=this.getIconUrl(r.file),u=this.Gd.add({position:e.position,image:a,horizontalOrigin:i.HorizontalOrigin.CENTER,verticalOrigin:i.VerticalOrigin.CENTER,width:o,height:s,disableDepthTestDistance:this.disableDepthTestDistance,pixelOffset:new i.Cartesian2(0,r.shieldDy)}),h={text:n,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${r.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:r.size/t.SDFSettings.FONT_SIZE,relativeSize:r.size/t.SDFSettings.FONT_SIZE},l=this._labels.computeLabelSize(h),c=new t.Cartesian2(-l.width/2,-l.height/2),f=this.lineHeight?`/${this.lineHeight}px`:"",d=`${this.fontStyle} ${this.fontWeight} ${r.size}px${f} ${this.fontFamily}`,p=this._labels.add({position:e.position,text:n,font:d,horizontalOrigin:i.HorizontalOrigin.LEFT,verticalOrigin:i.VerticalOrigin.TOP,fillColor:i.Color.fromCssColorString(r.fill),style:i.LabelStyle.FILL_AND_OUTLINE,disableDepthTestDistance:this.disableDepthTestDistance,outlineColor:i.Color.fromCssColorString(r.haloFill),outlineWidth:r.haloRadius,pixelOffset:c});this.Xd[e.id]={icon:u,label:p}}else if(3===r.layout){const n=e.name,o=this.iconSize*r.transform[0],s=this.iconSize*r.transform[1],a=this.getIconUrl(r.file),u=this.Gd.add({position:e.position,image:a,horizontalOrigin:i.HorizontalOrigin.CENTER,verticalOrigin:i.VerticalOrigin.CENTER,width:o,height:s,disableDepthTestDistance:e.external?1/0:this.disableDepthTestDistance,pixelOffset:new i.Cartesian2(0,r.shieldDy)}),h={text:n,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${r.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:r.size/t.SDFSettings.FONT_SIZE,relativeSize:r.size/t.SDFSettings.FONT_SIZE},l=this._labels.computeLabelSize(h),c=new t.Cartesian2(o/2+this.iconTextSpacing,r.shieldDy-l.height/2),f=this.lineHeight?`/${this.lineHeight}px`:"",d=`${this.fontStyle} ${this.fontWeight} ${r.size}px${f} ${this.fontFamily}`,p=this._labels.add({position:e.position,text:n,font:d,horizontalOrigin:i.HorizontalOrigin.LEFT,verticalOrigin:i.VerticalOrigin.TOP,fillColor:i.Color.fromCssColorString(r.fill),style:i.LabelStyle.FILL_AND_OUTLINE,disableDepthTestDistance:e.external?1/0:this.disableDepthTestDistance,outlineColor:i.Color.fromCssColorString(r.haloFill),outlineWidth:r.haloRadius,pixelOffset:c});this.Xd[e.id]={icon:u,label:p}}}addRoad(e){const n=`${Math.min(Math.floor(this.getZoom()),20)}:${e.styleId}`,r=this.styles[n];if(!r)return;const o=e.subType;if("roadname"===o){const n=e.name,o={text:n,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${r.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:r.size/t.SDFSettings.FONT_SIZE,relativeSize:r.size/t.SDFSettings.FONT_SIZE},s=this._labels.computeLabelSize(o),a=new t.Cartesian2(-s.width/2,-s.height/2),u=this.lineHeight?`/${this.lineHeight}px`:"",h=`${this.fontStyle} ${this.fontWeight} ${r.size}px${u} ${this.fontFamily}`,l=this.Yd.add({position:e.position,text:n,font:h,horizontalOrigin:i.HorizontalOrigin.LEFT,verticalOrigin:i.VerticalOrigin.TOP,fillColor:i.Color.fromCssColorString(r.fill),style:i.LabelStyle.FILL_AND_OUTLINE,disableDepthTestDistance:this.disableDepthTestDistance,outlineColor:i.Color.fromCssColorString(r.haloFill),outlineWidth:r.haloRadius,pixelOffset:a});l.roadDirection=new i.Cartesian4(e.end.x-e.position.x,e.end.y-e.position.y,e.end.z-e.position.z,1),this.Qd[e.id]={label:l}}else if("guideboard"===o){const n=e.name,o=this.iconSize*r.transform[0],s=this.iconSize*r.transform[1],a=this.getIconUrl(r.file),u=this.Kd.add({position:e.position,image:a,horizontalOrigin:i.HorizontalOrigin.CENTER,verticalOrigin:i.VerticalOrigin.CENTER,width:o,height:s,disableDepthTestDistance:this.disableDepthTestDistance}),h={text:n,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${r.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:r.size/t.SDFSettings.FONT_SIZE,relativeSize:r.size/t.SDFSettings.FONT_SIZE},l=this._labels.computeLabelSize(h),c=new t.Cartesian2(-l.width/2,-l.height/2),f=this.lineHeight?`/${this.lineHeight}px`:"",d=`${this.fontStyle} ${this.fontWeight} ${r.size}px${f} ${this.fontFamily}`,p=this.Yd.add({position:e.position,text:n,font:d,horizontalOrigin:i.HorizontalOrigin.LEFT,verticalOrigin:i.VerticalOrigin.TOP,fillColor:i.Color.fromCssColorString(r.fill),style:i.LabelStyle.FILL_AND_OUTLINE,disableDepthTestDistance:this.disableDepthTestDistance,outlineColor:i.Color.fromCssColorString(r.haloFill),outlineWidth:r.haloRadius,pixelOffset:c});this.Qd[e.id]={icon:u,label:p}}}getIconUrl(t){return"https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/static/3dgs/cesiumjs-sdk"+t.substring(1)}debugShowOrigin(t){this.Ln.entities.add({position:t,point:{pixelSize:1,color:i.Color.RED,outlineColor:i.Color.WHITE,outlineWidth:1}})}computeScreenSpaceSize(e){const n=this.Ln.scene.cartesianToCanvasCoordinates(e.position);if(!n)return;const r=`${Math.min(Math.floor(this.getZoom()),20)}:${e.styleId}`,o=this.styles[r];if(o){if(0===o.layout){const t=this.iconSize*o.transform[0],e=this.iconSize*o.transform[1];return new i.BoundingRectangle(n.x-t/2,n.y-e/2,t,e)}if(1===o.layout){const r={text:e.name,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${o.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:o.size/t.SDFSettings.FONT_SIZE,relativeSize:o.size/t.SDFSettings.FONT_SIZE},s=this._labels.computeLabelSize(r);return new i.BoundingRectangle(n.x-s.width/2,n.y-s.height/2,s.width,s.height)}if(2===o.layout){const r=e.name,s=this.iconSize*o.transform[0],a=this.iconSize*o.transform[1],u={text:r,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${o.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:o.size/t.SDFSettings.FONT_SIZE,relativeSize:o.size/t.SDFSettings.FONT_SIZE},h=this._labels.computeLabelSize(u),l=Math.max(s,h.width),c=Math.max(a,h.height);return new i.BoundingRectangle(n.x-l/2,n.y-c/2,l,c)}if(3===o.layout){const r=e.name,s=this.iconSize*o.transform[0],a=this.iconSize*o.transform[1],u={text:r,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${o.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:o.size/t.SDFSettings.FONT_SIZE,relativeSize:o.size/t.SDFSettings.FONT_SIZE},h=this._labels.computeLabelSize(u),l=Math.max(a,h.height);return new i.BoundingRectangle(n.x-s/2,n.y-l/2+o.shieldDy,s+h.width+this.iconTextSpacing,l)}}}computeScreenSpaceSizeRoad(e){const n=this.Ln.scene,r=`${Math.min(Math.floor(this.getZoom()),20)}:${e.styleId}`,o=this.styles[r];if(o){if("guideboard"===e.subType){const r=n.cartesianToCanvasCoordinates(e.position);if(!r)return;const s=e.name,a=this.iconSize*o.transform[0],u=this.iconSize*o.transform[1],h={text:s,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${o.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:o.size/t.SDFSettings.FONT_SIZE,relativeSize:o.size/t.SDFSettings.FONT_SIZE},l=this._labels.computeLabelSize(h),c=Math.max(a,l.width),f=Math.max(u,l.height);return new i.BoundingRectangle(r.x-c/2,r.y-f/2,c,f)}if("roadname"===e.subType){const r=n.cartesianToCanvasCoordinates(e.position),s=n.cartesianToCanvasCoordinates(e.end);if(!r||!s)return;e.screenPos=r,e.endScreenPos=s;const a=i.Cartesian2.subtract(s,r,new i.Cartesian2);a.y*=-1;const u=i.Cartesian2.normalize(a,new i.Cartesian2),h=new i.Cartesian2(1,0),l=i.Cartesian2.dot(h,u),c=(i.Cartesian2.cross(h,u)>0?1:-1)*Math.acos(l),f={text:e.name,fontStyle:this.fontStyle,fontWeight:this.fontWeight,fontSize:`${o.size}`,fontFamily:this.fontFamily,verticalOrigin:t.VerticalOrigin.TOP,totalScale:o.size/t.SDFSettings.FONT_SIZE,relativeSize:o.size/t.SDFSettings.FONT_SIZE},d=this._labels.computeLabelSize(f),p=[-d.width/2,d.height/2],v=[d.width/2,d.height/2],m=[-d.width/2,-d.height/2],y=[d.width/2,-d.height/2],w=Math.cos(c),g=Math.sin(c),b=[w*p[0]-g*p[1],g*p[0]+w*p[1]],_=[w*v[0]-g*v[1],g*v[0]+w*v[1]],x=[w*m[0]-g*m[1],g*m[0]+w*m[1]],k=[w*y[0]-g*y[1],g*y[0]+w*y[1]];return i.BoundingRectangle.fromPoints([new i.Cartesian2(r.x+b[0],r.y-b[1]),new i.Cartesian2(r.x+_[0],r.y-_[1]),new i.Cartesian2(r.x+x[0],r.y-x[1]),new i.Cartesian2(r.x+k[0],r.y-k[1])])}}}computePoiToRender(t){const e=this.getZoom();this.Zd.clear();const n=new i.BoundingRectangle;n.x=0,n.y=0,n.width=this._scene.canvas.clientWidth,n.height=this._scene.canvas.clientHeight;const r=[];for(let o=0;o<t.length;o++){const s=t[o],a=20===s.maxzoom?999:s.maxzoom;if(e<s.minzoom||e>a)continue;const u=this.computeScreenSpaceSize(s);if(!u)continue;const{x:h,y:l,width:c,height:f}=u;if(n.intersect(u)===i.Intersect.OUTSIDE)continue;const d={minX:h-this.collisionBuffer.x,minY:l-this.collisionBuffer.y,maxX:h+c+this.collisionBuffer.x,maxY:l+f+this.collisionBuffer.y};this.Zd.collides(d)||(this.Zd.insert(d),r.push(s))}return r}computeItemsToRender(t,e){const n=this.getZoom();this.Zd.clear();const r=new i.BoundingRectangle;r.x=0,r.y=0,r.width=this._scene.canvas.clientWidth,r.height=this._scene.canvas.clientHeight;const o=[];for(let t=0;t<e.length;t++){const s=e[t],a=20===s.maxzoom?999:s.maxzoom;if(n<s.minzoom||n>a)continue;const u=this.computeScreenSpaceSizeRoad(s);if(!u)continue;const{x:h,y:l,width:c,height:f}=u;if(r.intersect(u)===i.Intersect.OUTSIDE)continue;const d={minX:h-this.collisionBuffer.x,minY:l-this.collisionBuffer.y,maxX:h+c+this.collisionBuffer.x,maxY:l+f+this.collisionBuffer.y,data:s};this.Zd.collides(d)||(this.Zd.insert(d),o.push(s),s.bbox=u)}const s=[];for(let e=0;e<t.length;e++){const o=t[e],a=20===o.maxzoom?999:o.maxzoom;if(n<o.minzoom||n>a)continue;const u=this.computeScreenSpaceSize(o);if(!u)continue;const{x:h,y:l,width:c,height:f}=u;if(r.intersect(u)===i.Intersect.OUTSIDE)continue;const d={minX:h-this.collisionBuffer.x,minY:l-this.collisionBuffer.y,maxX:h+c+this.collisionBuffer.x,maxY:l+f+this.collisionBuffer.y,data:o};if(!o.external){if(this.Zd.collides(d))continue;this.Zd.insert(d)}s.push(o),o.bbox=u}return{pois:s,roads:o}}diff(t,e){const n=e.reduce(((t,e)=>(t[e.id]=e,t)),{}),i=Object.keys(t),r=[],o=[];for(let t=0;t<i.length;t++)n[i[t]]||r.push(i[t]);for(let n=0;n<e.length;n++)t[e[n].id]||o.push(e[n]);return{add:o,remove:r}}getZoom(){const t=this._scene.camera.position,e=i.Ellipsoid.WGS84.cartesianToCartographic(t).height;return Math.log2(169066473.75/e)}updateRoads(t,e){const{add:n,remove:i}=this.diff(t,e);for(let t=0;t<i.length;t++){const e=i[t],{label:n,icon:r}=this.Qd[e];n&&this.Yd.remove(n),r&&this.Kd.remove(r),delete this.Qd[e]}for(let t=0;t<n.length;t++){const e=n[t];this.addRoad(e)}}updatePois(t,e){const{add:n,remove:i}=this.diff(t,e);for(let t=0;t<i.length;t++){const e=i[t];if(this.Xd[e]){const{icon:t,label:n}=this.Xd[e];t&&this.Gd.remove(t),n&&this._labels.remove(n),delete this.Xd[e]}}for(let t=0;t<n.length;t++){const e=n[t];this.addPoi(e)}}ap(){const t=document.createElement("style");t.id="AlibabaPuHuiTi",t.innerHTML='\n      @font-face {\n        font-family: "AlibabaPuHuiTi";\n        src: url("https://amappc.oss-cn-zhangjiakou.aliyuncs.com/gis/static/3dgs/cesiumjs-sdk/AlibabaPuHuiTi-2-55-Regular/AlibabaPuHuiTi-2-55-Regular.woff2")\n          format("woff2");\n        font-weight: normal;\n        font-style: normal;\n      }\n    ',document.head.appendChild(t),new Nm("AlibabaPuHuiTi").load(null,this.ep).then((()=>{this.np=!0,this.requestRender()}))}async hp(){try{const t=await fetch(this.styleUrl),e=await t.json();this.styles=e}catch(t){}}pick(t){const e={minX:t.x,minY:t.y,maxX:t.x+1,maxY:t.y+1},n=this.Zd.search(e)[0];if("poi"===n?.data?.type)return n.data.poiid}setExtraPois(t){this.tp=t,this._dirty=!0,this.requestRender()}lp=null;requestRender=()=>{clearTimeout(this.lp);const t=Date.now()-this.rp;t>this.ip?this.Ln.scene.requestRender():this.lp=setTimeout((()=>{this.Ln.scene.requestRender()}),this.ip-t+1)}}class qm{endpoint="https://address-search.amap.com/v3/query/place/text";constructor(){}async search(t){try{const e={method:"GET"},n=Object.keys(t).map((e=>`${e}=${encodeURIComponent(t[e])}`)).join("&"),i=this.endpoint+"?"+n,r=await fetch(i,e),o=await r.json();if(0===o.code){const t=o.pois.map((t=>{const[e,n]=t.location.split(",").map((t=>parseFloat(t))),i=parseFloat(t.height)||0;return{name:t.name,position:[e,n,i]}}));return{success:!0,data:t,message:""}}throw new Error(`Failed to fetch ${i}`)}catch(t){return{success:!1,data:[],message:t.message}}}}class jm{Zo;Jo="BuildingDataSource";ts=!1;es;ns;rs;_show=!0;ss;_scene;We;Ld=1;Bd={};Hd;Ed=0;Wd={};tilesetUrl;tileset;minDistance;worker;constructor(t){this.es=new i.Event,this.ns=new i.Event,this.ts=!1,this.rs=new i.Event,this.Zo=new i.EntityCollection,this.ss=new i.EntityCluster,this._scene=t.scene,this.tilesetUrl=t.tileset,this.Hd=this.tilesetUrl.substring(0,this.tilesetUrl.lastIndexOf("/")),this.minDistance=t.minDistance,this.We=new Bc({Pi:30,Fi:this.onDrop});const e=new Blob(['var factory;factory=function(){"use strict";var t="undefined"!=typeof document?document.currentScript:null;function n(t){return null!=t}function e(t){let n;this.name="DeveloperError",this.message=t;try{throw new Error}catch(t){n=t.stack}this.stack=n}n(Object.create)&&(e.prototype=Object.create(Error.prototype),e.prototype.constructor=e),e.prototype.toString=function(){let t=`${this.name}: ${this.message}`;return n(this.stack)&&(t+=`\\n${this.stack.toString()}`),t},e.throwInstantiationError=function(){throw new e("This function defines an interface and should not be called directly.")};const r={};function i(t,n,e){return`Expected ${e} to be typeof ${n}, actual typeof was ${t}`}function o(t,n){return null!=t?t:n}r.typeOf={},r.defined=function(t,r){if(!n(r))throw new e(function(t){return`${t} is required, actual value was undefined`}(t))},r.typeOf.func=function(t,n){if("function"!=typeof n)throw new e(i(typeof n,"function",t))},r.typeOf.string=function(t,n){if("string"!=typeof n)throw new e(i(typeof n,"string",t))},r.typeOf.number=function(t,n){if("number"!=typeof n)throw new e(i(typeof n,"number",t))},r.typeOf.number.lessThan=function(t,n,i){if(r.typeOf.number(t,n),n>=i)throw new e(`Expected ${t} to be less than ${i}, actual value was ${n}`)},r.typeOf.number.lessThanOrEquals=function(t,n,i){if(r.typeOf.number(t,n),n>i)throw new e(`Expected ${t} to be less than or equal to ${i}, actual value was ${n}`)},r.typeOf.number.greaterThan=function(t,n,i){if(r.typeOf.number(t,n),n<=i)throw new e(`Expected ${t} to be greater than ${i}, actual value was ${n}`)},r.typeOf.number.greaterThanOrEquals=function(t,n,i){if(r.typeOf.number(t,n),n<i)throw new e(`Expected ${t} to be greater than or equal to ${i}, actual value was ${n}`)},r.typeOf.object=function(t,n){if("object"!=typeof n)throw new e(i(typeof n,"object",t))},r.typeOf.bool=function(t,n){if("boolean"!=typeof n)throw new e(i(typeof n,"boolean",t))},r.typeOf.bigint=function(t,n){if("bigint"!=typeof n)throw new e(i(typeof n,"bigint",t))},r.typeOf.number.equals=function(t,n,i,o){if(r.typeOf.number(t,i),r.typeOf.number(n,o),i!==o)throw new e(`${t} must be equal to ${n}, the actual values are ${i} and ${o}`)},o.EMPTY_OBJECT=Object.freeze({});var u,s,c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function a(t){return t&&t.t&&{}.hasOwnProperty.call(t,"default")?t.default:t}var f=function(){if(s)return u;s=1;var t=function(t){null==t&&(t=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,t.constructor==Array?this.init_by_array(t,t.length):this.init_seed(t)};return t.prototype.init_seed=function(t){for(this.mt[0]=t>>>0,this.mti=1;this.mti<this.N;this.mti++)t=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&t)>>>16)<<16)+1812433253*(65535&t)+this.mti,this.mt[this.mti]>>>=0},t.prototype.init_by_array=function(t,n){var e,r,i;for(this.init_seed(19650218),e=1,r=0,i=this.N>n?this.N:n;i;i--){var o=this.mt[e-1]^this.mt[e-1]>>>30;this.mt[e]=(this.mt[e]^(1664525*((4294901760&o)>>>16)<<16)+1664525*(65535&o))+t[r]+r,this.mt[e]>>>=0,r++,++e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1),r>=n&&(r=0)}for(i=this.N-1;i;i--)o=this.mt[e-1]^this.mt[e-1]>>>30,this.mt[e]=(this.mt[e]^(1566083941*((4294901760&o)>>>16)<<16)+1566083941*(65535&o))-e,this.mt[e]>>>=0,++e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1);this.mt[0]=2147483648},t.prototype.random_int=function(){var t,n=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var e;for(this.mti==this.N+1&&this.init_seed(5489),e=0;e<this.N-this.M;e++)t=this.mt[e]&this.UPPER_MASK|this.mt[e+1]&this.LOWER_MASK,this.mt[e]=this.mt[e+this.M]^t>>>1^n[1&t];for(;e<this.N-1;e++)t=this.mt[e]&this.UPPER_MASK|this.mt[e+1]&this.LOWER_MASK,this.mt[e]=this.mt[e+(this.M-this.N)]^t>>>1^n[1&t];t=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^t>>>1^n[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,(t^=t>>>18)>>>0},t.prototype.random_int31=function(){return this.random_int()>>>1},t.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},t.prototype.random=function(){return this.random_int()*(1/4294967296)},t.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},t.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},u=t}(),h=a(f);const l={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,GRAVITATIONALPARAMETER:3986004418e5,SOLAR_RADIUS:6955e5,LUNAR_RADIUS:1737400,SIXTY_FOUR_KILOBYTES:65536,FOUR_GIGABYTES:4294967296};l.sign=o(Math.sign,(function(t){return 0==(t=+t)||t!=t?t:t>0?1:-1})),l.signNotZero=function(t){return t<0?-1:1},l.toSNorm=function(t,n){return n=o(n,255),Math.round((.5*l.clamp(t,-1,1)+.5)*n)},l.fromSNorm=function(t,n){return n=o(n,255),l.clamp(t,0,n)/n*2-1},l.normalize=function(t,n,e){return 0===(e=Math.max(e-n,0))?0:l.clamp((t-n)/e,0,1)},l.sinh=o(Math.sinh,(function(t){return(Math.exp(t)-Math.exp(-t))/2})),l.cosh=o(Math.cosh,(function(t){return(Math.exp(t)+Math.exp(-t))/2})),l.lerp=function(t,n,e){return(1-e)*t+e*n},l.PI=Math.PI,l.ONE_OVER_PI=1/Math.PI,l.PI_OVER_TWO=Math.PI/2,l.PI_OVER_THREE=Math.PI/3,l.PI_OVER_FOUR=Math.PI/4,l.PI_OVER_SIX=Math.PI/6,l.THREE_PI_OVER_TWO=3*Math.PI/2,l.TWO_PI=2*Math.PI,l.ONE_OVER_TWO_PI=1/(2*Math.PI),l.RADIANS_PER_DEGREE=Math.PI/180,l.DEGREES_PER_RADIAN=180/Math.PI,l.RADIANS_PER_ARCSECOND=l.RADIANS_PER_DEGREE/3600,l.toRadians=function(t){if(!n(t))throw new e("degrees is required.");return t*l.RADIANS_PER_DEGREE},l.toDegrees=function(t){if(!n(t))throw new e("radians is required.");return t*l.DEGREES_PER_RADIAN},l.convertLongitudeRange=function(t){if(!n(t))throw new e("angle is required.");const r=l.TWO_PI,i=t-Math.floor(t/r)*r;return i<-Math.PI?i+r:i>=Math.PI?i-r:i},l.clampToLatitudeRange=function(t){if(!n(t))throw new e("angle is required.");return l.clamp(t,-1*l.PI_OVER_TWO,l.PI_OVER_TWO)},l.negativePiToPi=function(t){if(!n(t))throw new e("angle is required.");return t>=-l.PI&&t<=l.PI?t:l.zeroToTwoPi(t+l.PI)-l.PI},l.zeroToTwoPi=function(t){if(!n(t))throw new e("angle is required.");if(t>=0&&t<=l.TWO_PI)return t;const r=l.mod(t,l.TWO_PI);return Math.abs(r)<l.EPSILON14&&Math.abs(t)>l.EPSILON14?l.TWO_PI:r},l.mod=function(t,r){if(!n(t))throw new e("m is required.");if(!n(r))throw new e("n is required.");if(0===r)throw new e("divisor cannot be 0.");return l.sign(t)===l.sign(r)&&Math.abs(t)<Math.abs(r)?t:(t%r+r)%r},l.equalsEpsilon=function(t,r,i,u){if(!n(t))throw new e("left is required.");if(!n(r))throw new e("right is required.");i=o(i,0),u=o(u,i);const s=Math.abs(t-r);return s<=u||s<=i*Math.max(Math.abs(t),Math.abs(r))},l.lessThan=function(t,r,i){if(!n(t))throw new e("first is required.");if(!n(r))throw new e("second is required.");if(!n(i))throw new e("absoluteEpsilon is required.");return t-r<-i},l.lessThanOrEquals=function(t,r,i){if(!n(t))throw new e("first is required.");if(!n(r))throw new e("second is required.");if(!n(i))throw new e("absoluteEpsilon is required.");return t-r<i},l.greaterThan=function(t,r,i){if(!n(t))throw new e("first is required.");if(!n(r))throw new e("second is required.");if(!n(i))throw new e("absoluteEpsilon is required.");return t-r>i},l.greaterThanOrEquals=function(t,r,i){if(!n(t))throw new e("first is required.");if(!n(r))throw new e("second is required.");if(!n(i))throw new e("absoluteEpsilon is required.");return t-r>-i};const d=[1];l.factorial=function(t){if("number"!=typeof t||t<0)throw new e("A number greater than or equal to 0 is required.");const n=d.length;if(t>=n){let e=d[n-1];for(let r=n;r<=t;r++){const t=e*r;d.push(t),e=t}}return d[t]},l.incrementWrap=function(t,r,i){if(i=o(i,0),!n(t))throw new e("n is required.");if(r<=i)throw new e("maximumValue must be greater than minimumValue.");return++t>r&&(t=i),t},l.isPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>4294967295)throw new e("A number between 0 and (2^32)-1 is required.");return 0!==t&&!(t&t-1)},l.nextPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>2147483648)throw new e("A number between 0 and 2^31 is required.");return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},l.previousPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>4294967295)throw new e("A number between 0 and (2^32)-1 is required.");return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,((t|=t>>32)>>>0)-(t>>>1)},l.clamp=function(t,n,e){return r.typeOf.number("value",t),r.typeOf.number("min",n),r.typeOf.number("max",e),t<n?n:t>e?e:t};let w=new h;function m(t,n,e){this.x=o(t,0),this.y=o(n,0),this.z=o(e,0)}l.setRandomNumberSeed=function(t){if(!n(t))throw new e("seed is required.");w=new h(t)},l.nextRandomNumber=function(){return w.random()},l.randomBetween=function(t,n){return l.nextRandomNumber()*(n-t)+t},l.acosClamped=function(t){if(!n(t))throw new e("value is required.");return Math.acos(l.clamp(t,-1,1))},l.asinClamped=function(t){if(!n(t))throw new e("value is required.");return Math.asin(l.clamp(t,-1,1))},l.chordLength=function(t,r){if(!n(t))throw new e("angle is required.");if(!n(r))throw new e("radius is required.");return 2*r*Math.sin(.5*t)},l.logBase=function(t,r){if(!n(t))throw new e("number is required.");if(!n(r))throw new e("base is required.");return Math.log(t)/Math.log(r)},l.cbrt=o(Math.cbrt,(function(t){const n=Math.pow(Math.abs(t),1/3);return t<0?-n:n})),l.log2=o(Math.log2,(function(t){return Math.log(t)*Math.LOG2E})),l.fog=function(t,n){const e=t*n;return 1-Math.exp(-e*e)},l.fastApproximateAtan=function(t){return r.typeOf.number("x",t),t*(-.1784*Math.abs(t)-.0663*t*t+1.0301)},l.fastApproximateAtan2=function(t,n){let i;r.typeOf.number("x",t),r.typeOf.number("y",n);let o=Math.abs(t);i=Math.abs(n);const u=Math.max(o,i);i=Math.min(o,i);const s=i/u;if(isNaN(s))throw new e("either x or y must be nonzero");return o=l.fastApproximateAtan(s),o=Math.abs(n)>Math.abs(t)?l.PI_OVER_TWO-o:o,o=t<0?l.PI-o:o,o=n<0?-o:o,o},m.fromSpherical=function(t,e){r.typeOf.object("spherical",t),n(e)||(e=new m);const i=t.clock,u=t.cone,s=o(t.magnitude,1),c=s*Math.sin(u);return e.x=c*Math.cos(i),e.y=c*Math.sin(i),e.z=s*Math.cos(u),e},m.fromElements=function(t,e,r,i){return n(i)?(i.x=t,i.y=e,i.z=r,i):new m(t,e,r)},m.clone=function(t,e){if(n(t))return n(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e):new m(t.x,t.y,t.z)},m.fromCartesian4=m.clone,m.packedLength=3,m.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t.x,n[e++]=t.y,n[e]=t.z,n},m.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new m),i.x=t[e++],i.y=t[e++],i.z=t[e],i},m.packArray=function(t,i){r.defined("array",t);const o=t.length,u=3*o;if(n(i)){if(!Array.isArray(i)&&i.length!==u)throw new e("If result is a typed array, it must have exactly array.length * 3 elements");i.length!==u&&(i.length=u)}else i=new Array(u);for(let n=0;n<o;++n)m.pack(t[n],i,3*n);return i},m.unpackArray=function(t,i){if(r.defined("array",t),r.typeOf.number.greaterThanOrEquals("array.length",t.length,3),t.length%3!=0)throw new e("array length must be a multiple of 3.");const o=t.length;n(i)?i.length=o/3:i=new Array(o/3);for(let n=0;n<o;n+=3){const e=n/3;i[e]=m.unpack(t,n,i[e])}return i},m.fromArray=m.unpack,m.maximumComponent=function(t){return r.typeOf.object("cartesian",t),Math.max(t.x,t.y,t.z)},m.minimumComponent=function(t){return r.typeOf.object("cartesian",t),Math.min(t.x,t.y,t.z)},m.minimumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},m.maximumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},m.clamp=function(t,n,e,i){r.typeOf.object("value",t),r.typeOf.object("min",n),r.typeOf.object("max",e),r.typeOf.object("result",i);const o=l.clamp(t.x,n.x,e.x),u=l.clamp(t.y,n.y,e.y),s=l.clamp(t.z,n.z,e.z);return i.x=o,i.y=u,i.z=s,i},m.magnitudeSquared=function(t){return r.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y+t.z*t.z},m.magnitude=function(t){return Math.sqrt(m.magnitudeSquared(t))};const g=new m;m.distance=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),m.subtract(t,n,g),m.magnitude(g)},m.distanceSquared=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),m.subtract(t,n,g),m.magnitudeSquared(g)},m.normalize=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const i=m.magnitude(t);if(n.x=t.x/i,n.y=t.y/i,n.z=t.z/i,isNaN(n.x)||isNaN(n.y)||isNaN(n.z))throw new e("normalized result is not a number");return n},m.dot=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),t.x*n.x+t.y*n.y+t.z*n.z},m.multiplyComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},m.divideComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},m.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},m.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},m.multiplyByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},m.divideByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x/n,e.y=t.y/n,e.z=t.z/n,e},m.negate=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=-t.x,n.y=-t.y,n.z=-t.z,n},m.abs=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=Math.abs(t.x),n.y=Math.abs(t.y),n.z=Math.abs(t.z),n};const v=new m;m.lerp=function(t,n,e,i){return r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i),m.multiplyByScalar(n,e,v),i=m.multiplyByScalar(t,1-e,i),m.add(v,i,i)};const p=new m,y=new m;m.angleBetween=function(t,n){r.typeOf.object("left",t),r.typeOf.object("right",n),m.normalize(t,p),m.normalize(n,y);const e=m.dot(p,y),i=m.magnitude(m.cross(p,y,p));return Math.atan2(i,e)};const b=new m;m.mostOrthogonalAxis=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const e=m.normalize(t,b);return m.abs(e,e),e.x<=e.y?e.x<=e.z?m.clone(m.UNIT_X,n):m.clone(m.UNIT_Z,n):e.y<=e.z?m.clone(m.UNIT_Y,n):m.clone(m.UNIT_Z,n)},m.projectVector=function(t,n,e){r.defined("a",t),r.defined("b",n),r.defined("result",e);const i=m.dot(t,n)/m.dot(n,n);return m.multiplyByScalar(n,i,e)},m.equals=function(t,e){return t===e||n(t)&&n(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z},m.equalsArray=function(t,n,e){return t.x===n[e]&&t.y===n[e+1]&&t.z===n[e+2]},m.equalsEpsilon=function(t,e,r,i){return t===e||n(t)&&n(e)&&l.equalsEpsilon(t.x,e.x,r,i)&&l.equalsEpsilon(t.y,e.y,r,i)&&l.equalsEpsilon(t.z,e.z,r,i)},m.cross=function(t,n,e){r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e);const i=t.x,o=t.y,u=t.z,s=n.x,c=n.y,a=n.z,f=o*a-u*c,h=u*s-i*a,l=i*c-o*s;return e.x=f,e.y=h,e.z=l,e},m.midpoint=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=.5*(t.x+n.x),e.y=.5*(t.y+n.y),e.z=.5*(t.z+n.z),e},m.fromDegrees=function(t,n,e,i,o){return r.typeOf.number("longitude",t),r.typeOf.number("latitude",n),t=l.toRadians(t),n=l.toRadians(n),m.fromRadians(t,n,e,i,o)};let M=new m,A=new m;function x(t,n,e,r){this.x=o(t,0),this.y=o(n,0),this.z=o(e,0),this.w=o(r,0)}m.o=new m(40680631590769,40680631590769,40408299984661.445),m.fromRadians=function(t,e,i,u,s){r.typeOf.number("longitude",t),r.typeOf.number("latitude",e),i=o(i,0);const c=n(u)?u.radiiSquared:m.o,a=Math.cos(e);M.x=a*Math.cos(t),M.y=a*Math.sin(t),M.z=Math.sin(e),M=m.normalize(M,M),m.multiplyComponents(c,M,A);const f=Math.sqrt(m.dot(M,A));return A=m.divideByScalar(A,f,A),M=m.multiplyByScalar(M,i,M),n(s)||(s=new m),m.add(A,M,s)},m.fromDegreesArray=function(t,i,o){if(r.defined("coordinates",t),t.length<2||t.length%2!=0)throw new e("the number of coordinates must be a multiple of 2 and at least 2");const u=t.length;n(o)?o.length=u/2:o=new Array(u/2);for(let n=0;n<u;n+=2){const e=t[n],r=t[n+1],u=n/2;o[u]=m.fromDegrees(e,r,0,i,o[u])}return o},m.fromRadiansArray=function(t,i,o){if(r.defined("coordinates",t),t.length<2||t.length%2!=0)throw new e("the number of coordinates must be a multiple of 2 and at least 2");const u=t.length;n(o)?o.length=u/2:o=new Array(u/2);for(let n=0;n<u;n+=2){const e=t[n],r=t[n+1],u=n/2;o[u]=m.fromRadians(e,r,0,i,o[u])}return o},m.fromDegreesArrayHeights=function(t,i,o){if(r.defined("coordinates",t),t.length<3||t.length%3!=0)throw new e("the number of coordinates must be a multiple of 3 and at least 3");const u=t.length;n(o)?o.length=u/3:o=new Array(u/3);for(let n=0;n<u;n+=3){const e=t[n],r=t[n+1],u=t[n+2],s=n/3;o[s]=m.fromDegrees(e,r,u,i,o[s])}return o},m.fromRadiansArrayHeights=function(t,i,o){if(r.defined("coordinates",t),t.length<3||t.length%3!=0)throw new e("the number of coordinates must be a multiple of 3 and at least 3");const u=t.length;n(o)?o.length=u/3:o=new Array(u/3);for(let n=0;n<u;n+=3){const e=t[n],r=t[n+1],u=t[n+2],s=n/3;o[s]=m.fromRadians(e,r,u,i,o[s])}return o},m.ZERO=Object.freeze(new m(0,0,0)),m.ONE=Object.freeze(new m(1,1,1)),m.UNIT_X=Object.freeze(new m(1,0,0)),m.UNIT_Y=Object.freeze(new m(0,1,0)),m.UNIT_Z=Object.freeze(new m(0,0,1)),m.prototype.clone=function(t){return m.clone(this,t)},m.prototype.equals=function(t){return m.equals(this,t)},m.prototype.equalsEpsilon=function(t,n,e){return m.equalsEpsilon(this,t,n,e)},m.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z})`},x.fromElements=function(t,e,r,i,o){return n(o)?(o.x=t,o.y=e,o.z=r,o.w=i,o):new x(t,e,r,i)},x.fromColor=function(t,e){return r.typeOf.object("color",t),n(e)?(e.x=t.red,e.y=t.green,e.z=t.blue,e.w=t.alpha,e):new x(t.red,t.green,t.blue,t.alpha)},x.clone=function(t,e){if(n(t))return n(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e):new x(t.x,t.y,t.z,t.w)},x.packedLength=4,x.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t.x,n[e++]=t.y,n[e++]=t.z,n[e]=t.w,n},x.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new x),i.x=t[e++],i.y=t[e++],i.z=t[e++],i.w=t[e],i},x.packArray=function(t,i){r.defined("array",t);const o=t.length,u=4*o;if(n(i)){if(!Array.isArray(i)&&i.length!==u)throw new e("If result is a typed array, it must have exactly array.length * 4 elements");i.length!==u&&(i.length=u)}else i=new Array(u);for(let n=0;n<o;++n)x.pack(t[n],i,4*n);return i},x.unpackArray=function(t,i){if(r.defined("array",t),r.typeOf.number.greaterThanOrEquals("array.length",t.length,4),t.length%4!=0)throw new e("array length must be a multiple of 4.");const o=t.length;n(i)?i.length=o/4:i=new Array(o/4);for(let n=0;n<o;n+=4){const e=n/4;i[e]=x.unpack(t,n,i[e])}return i},x.fromArray=x.unpack,x.maximumComponent=function(t){return r.typeOf.object("cartesian",t),Math.max(t.x,t.y,t.z,t.w)},x.minimumComponent=function(t){return r.typeOf.object("cartesian",t),Math.min(t.x,t.y,t.z,t.w)},x.minimumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},x.maximumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},x.clamp=function(t,n,e,i){r.typeOf.object("value",t),r.typeOf.object("min",n),r.typeOf.object("max",e),r.typeOf.object("result",i);const o=l.clamp(t.x,n.x,e.x),u=l.clamp(t.y,n.y,e.y),s=l.clamp(t.z,n.z,e.z),c=l.clamp(t.w,n.w,e.w);return i.x=o,i.y=u,i.z=s,i.w=c,i},x.magnitudeSquared=function(t){return r.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},x.magnitude=function(t){return Math.sqrt(x.magnitudeSquared(t))};const E=new x;x.distance=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),x.subtract(t,n,E),x.magnitude(E)},x.distanceSquared=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),x.subtract(t,n,E),x.magnitudeSquared(E)},x.normalize=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const i=x.magnitude(t);if(n.x=t.x/i,n.y=t.y/i,n.z=t.z/i,n.w=t.w/i,isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||isNaN(n.w))throw new e("normalized result is not a number");return n},x.dot=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w},x.multiplyComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},x.divideComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},x.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},x.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},x.multiplyByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},x.divideByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x/n,e.y=t.y/n,e.z=t.z/n,e.w=t.w/n,e},x.negate=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=-t.x,n.y=-t.y,n.z=-t.z,n.w=-t.w,n},x.abs=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=Math.abs(t.x),n.y=Math.abs(t.y),n.z=Math.abs(t.z),n.w=Math.abs(t.w),n};const k=new x;x.lerp=function(t,n,e,i){return r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i),x.multiplyByScalar(n,e,k),i=x.multiplyByScalar(t,1-e,i),x.add(k,i,i)};const q=new x;x.mostOrthogonalAxis=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const e=x.normalize(t,q);return x.abs(e,e),e.x<=e.y?e.x<=e.z?e.x<=e.w?x.clone(x.UNIT_X,n):x.clone(x.UNIT_W,n):e.z<=e.w?x.clone(x.UNIT_Z,n):x.clone(x.UNIT_W,n):e.y<=e.z?e.y<=e.w?x.clone(x.UNIT_Y,n):x.clone(x.UNIT_W,n):e.z<=e.w?x.clone(x.UNIT_Z,n):x.clone(x.UNIT_W,n)},x.equals=function(t,e){return t===e||n(t)&&n(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},x.equalsArray=function(t,n,e){return t.x===n[e]&&t.y===n[e+1]&&t.z===n[e+2]&&t.w===n[e+3]},x.equalsEpsilon=function(t,e,r,i){return t===e||n(t)&&n(e)&&l.equalsEpsilon(t.x,e.x,r,i)&&l.equalsEpsilon(t.y,e.y,r,i)&&l.equalsEpsilon(t.z,e.z,r,i)&&l.equalsEpsilon(t.w,e.w,r,i)},x.ZERO=Object.freeze(new x(0,0,0,0)),x.ONE=Object.freeze(new x(1,1,1,1)),x.UNIT_X=Object.freeze(new x(1,0,0,0)),x.UNIT_Y=Object.freeze(new x(0,1,0,0)),x.UNIT_Z=Object.freeze(new x(0,0,1,0)),x.UNIT_W=Object.freeze(new x(0,0,0,1)),x.prototype.clone=function(t){return x.clone(this,t)},x.prototype.equals=function(t){return x.equals(this,t)},x.prototype.equalsEpsilon=function(t,n,e){return x.equalsEpsilon(this,t,n,e)},x.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z}, ${this.w})`};const $=new Float32Array(1),S=new Uint8Array($.buffer),I=new Uint32Array([287454020]),O=68===new Uint8Array(I.buffer)[0];function R(t,n,e,r,i,u,s,c,a){this[0]=o(t,0),this[1]=o(r,0),this[2]=o(s,0),this[3]=o(n,0),this[4]=o(i,0),this[5]=o(c,0),this[6]=o(e,0),this[7]=o(u,0),this[8]=o(a,0)}x.packFloat=function(t,e){return r.typeOf.number("value",t),n(e)||(e=new x),$[0]=t,O?(e.x=S[0],e.y=S[1],e.z=S[2],e.w=S[3]):(e.x=S[3],e.y=S[2],e.z=S[1],e.w=S[0]),e},x.unpackFloat=function(t){return r.typeOf.object("packedFloat",t),O?(S[0]=t.x,S[1]=t.y,S[2]=t.z,S[3]=t.w):(S[0]=t.w,S[1]=t.z,S[2]=t.y,S[3]=t.x),$[0]},R.packedLength=9,R.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t[0],n[e++]=t[1],n[e++]=t[2],n[e++]=t[3],n[e++]=t[4],n[e++]=t[5],n[e++]=t[6],n[e++]=t[7],n[e++]=t[8],n},R.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new R),i[0]=t[e++],i[1]=t[e++],i[2]=t[e++],i[3]=t[e++],i[4]=t[e++],i[5]=t[e++],i[6]=t[e++],i[7]=t[e++],i[8]=t[e++],i},R.packArray=function(t,i){r.defined("array",t);const o=t.length,u=9*o;if(n(i)){if(!Array.isArray(i)&&i.length!==u)throw new e("If result is a typed array, it must have exactly array.length * 9 elements");i.length!==u&&(i.length=u)}else i=new Array(u);for(let n=0;n<o;++n)R.pack(t[n],i,9*n);return i},R.unpackArray=function(t,i){if(r.defined("array",t),r.typeOf.number.greaterThanOrEquals("array.length",t.length,9),t.length%9!=0)throw new e("array length must be a multiple of 9.");const o=t.length;n(i)?i.length=o/9:i=new Array(o/9);for(let n=0;n<o;n+=9){const e=n/9;i[e]=R.unpack(t,n,i[e])}return i},R.clone=function(t,e){if(n(t))return n(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e):new R(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])},R.fromArray=R.unpack,R.fromColumnMajorArray=function(t,n){return r.defined("values",t),R.clone(t,n)},R.fromRowMajorArray=function(t,e){return r.defined("values",t),n(e)?(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e):new R(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},R.fromQuaternion=function(t,e){r.typeOf.object("quaternion",t);const i=t.x*t.x,o=t.x*t.y,u=t.x*t.z,s=t.x*t.w,c=t.y*t.y,a=t.y*t.z,f=t.y*t.w,h=t.z*t.z,l=t.z*t.w,d=t.w*t.w,w=i-c-h+d,m=2*(o-l),g=2*(u+f),v=2*(o+l),p=-i+c-h+d,y=2*(a-s),b=2*(u-f),M=2*(a+s),A=-i-c+h+d;return n(e)?(e[0]=w,e[1]=v,e[2]=b,e[3]=m,e[4]=p,e[5]=M,e[6]=g,e[7]=y,e[8]=A,e):new R(w,m,g,v,p,y,b,M,A)},R.fromHeadingPitchRoll=function(t,e){r.typeOf.object("headingPitchRoll",t);const i=Math.cos(-t.pitch),o=Math.cos(-t.heading),u=Math.cos(t.roll),s=Math.sin(-t.pitch),c=Math.sin(-t.heading),a=Math.sin(t.roll),f=i*o,h=-u*c+a*s*o,l=a*c+u*s*o,d=i*c,w=u*o+a*s*c,m=-a*o+u*s*c,g=-s,v=a*i,p=u*i;return n(e)?(e[0]=f,e[1]=d,e[2]=g,e[3]=h,e[4]=w,e[5]=v,e[6]=l,e[7]=m,e[8]=p,e):new R(f,h,l,d,w,m,g,v,p)},R.fromScale=function(t,e){return r.typeOf.object("scale",t),n(e)?(e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=t.y,e[5]=0,e[6]=0,e[7]=0,e[8]=t.z,e):new R(t.x,0,0,0,t.y,0,0,0,t.z)},R.fromUniformScale=function(t,e){return r.typeOf.number("scale",t),n(e)?(e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=t,e[5]=0,e[6]=0,e[7]=0,e[8]=t,e):new R(t,0,0,0,t,0,0,0,t)},R.fromCrossProduct=function(t,e){return r.typeOf.object("vector",t),n(e)?(e[0]=0,e[1]=t.z,e[2]=-t.y,e[3]=-t.z,e[4]=0,e[5]=t.x,e[6]=t.y,e[7]=-t.x,e[8]=0,e):new R(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0)},R.fromRotationX=function(t,e){r.typeOf.number("angle",t);const i=Math.cos(t),o=Math.sin(t);return n(e)?(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=i,e[5]=o,e[6]=0,e[7]=-o,e[8]=i,e):new R(1,0,0,0,i,-o,0,o,i)},R.fromRotationY=function(t,e){r.typeOf.number("angle",t);const i=Math.cos(t),o=Math.sin(t);return n(e)?(e[0]=i,e[1]=0,e[2]=-o,e[3]=0,e[4]=1,e[5]=0,e[6]=o,e[7]=0,e[8]=i,e):new R(i,0,o,0,1,0,-o,0,i)},R.fromRotationZ=function(t,e){r.typeOf.number("angle",t);const i=Math.cos(t),o=Math.sin(t);return n(e)?(e[0]=i,e[1]=o,e[2]=0,e[3]=-o,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e):new R(i,-o,0,o,i,0,0,0,1)},R.toArray=function(t,e){return r.typeOf.object("matrix",t),n(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e):[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},R.getElementIndex=function(t,n){return r.typeOf.number.greaterThanOrEquals("row",n,0),r.typeOf.number.lessThanOrEquals("row",n,2),r.typeOf.number.greaterThanOrEquals("column",t,0),r.typeOf.number.lessThanOrEquals("column",t,2),3*t+n},R.getColumn=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,2),r.typeOf.object("result",e);const i=3*n,o=t[i],u=t[i+1],s=t[i+2];return e.x=o,e.y=u,e.z=s,e},R.setColumn=function(t,n,e,i){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,2),r.typeOf.object("cartesian",e),r.typeOf.object("result",i);const o=3*n;return(i=R.clone(t,i))[o]=e.x,i[o+1]=e.y,i[o+2]=e.z,i},R.getRow=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,2),r.typeOf.object("result",e);const i=t[n],o=t[n+3],u=t[n+6];return e.x=i,e.y=o,e.z=u,e},R.setRow=function(t,n,e,i){return r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,2),r.typeOf.object("cartesian",e),r.typeOf.object("result",i),(i=R.clone(t,i))[n]=e.x,i[n+3]=e.y,i[n+6]=e.z,i};const P=new m;R.setScale=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("scale",n),r.typeOf.object("result",e);const i=R.getScale(t,P),o=n.x/i.x,u=n.y/i.y,s=n.z/i.z;return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*u,e[4]=t[4]*u,e[5]=t[5]*u,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e};const j=new m;R.setUniformScale=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number("scale",n),r.typeOf.object("result",e);const i=R.getScale(t,j),o=n/i.x,u=n/i.y,s=n/i.z;return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*u,e[4]=t[4]*u,e[5]=t[5]*u,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e};const F=new m;R.getScale=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n.x=m.magnitude(m.fromElements(t[0],t[1],t[2],F)),n.y=m.magnitude(m.fromElements(t[3],t[4],t[5],F)),n.z=m.magnitude(m.fromElements(t[6],t[7],t[8],F)),n};const N=new m;R.getMaximumScale=function(t){return R.getScale(t,N),m.maximumComponent(N)};const U=new m;R.setRotation=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("result",e);const i=R.getScale(t,U);return e[0]=n[0]*i.x,e[1]=n[1]*i.x,e[2]=n[2]*i.x,e[3]=n[3]*i.y,e[4]=n[4]*i.y,e[5]=n[5]*i.y,e[6]=n[6]*i.z,e[7]=n[7]*i.z,e[8]=n[8]*i.z,e};const T=new m;R.getRotation=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=R.getScale(t,T);return n[0]=t[0]/e.x,n[1]=t[1]/e.x,n[2]=t[2]/e.x,n[3]=t[3]/e.y,n[4]=t[4]/e.y,n[5]=t[5]/e.y,n[6]=t[6]/e.z,n[7]=t[7]/e.z,n[8]=t[8]/e.z,n},R.multiply=function(t,n,e){r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e);const i=t[0]*n[0]+t[3]*n[1]+t[6]*n[2],o=t[1]*n[0]+t[4]*n[1]+t[7]*n[2],u=t[2]*n[0]+t[5]*n[1]+t[8]*n[2],s=t[0]*n[3]+t[3]*n[4]+t[6]*n[5],c=t[1]*n[3]+t[4]*n[4]+t[7]*n[5],a=t[2]*n[3]+t[5]*n[4]+t[8]*n[5],f=t[0]*n[6]+t[3]*n[7]+t[6]*n[8],h=t[1]*n[6]+t[4]*n[7]+t[7]*n[8],l=t[2]*n[6]+t[5]*n[7]+t[8]*n[8];return e[0]=i,e[1]=o,e[2]=u,e[3]=s,e[4]=c,e[5]=a,e[6]=f,e[7]=h,e[8]=l,e},R.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e},R.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e},R.multiplyByVector=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("cartesian",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z,s=t[0]*i+t[3]*o+t[6]*u,c=t[1]*i+t[4]*o+t[7]*u,a=t[2]*i+t[5]*o+t[8]*u;return e.x=s,e.y=c,e.z=a,e},R.multiplyByScalar=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},R.multiplyByScale=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.object("scale",n),r.typeOf.object("result",e),e[0]=t[0]*n.x,e[1]=t[1]*n.x,e[2]=t[2]*n.x,e[3]=t[3]*n.y,e[4]=t[4]*n.y,e[5]=t[5]*n.y,e[6]=t[6]*n.z,e[7]=t[7]*n.z,e[8]=t[8]*n.z,e},R.multiplyByUniformScale=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.number("scale",n),r.typeOf.object("result",e),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},R.negate=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n[3]=-t[3],n[4]=-t[4],n[5]=-t[5],n[6]=-t[6],n[7]=-t[7],n[8]=-t[8],n},R.transpose=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=t[0],i=t[3],o=t[6],u=t[1],s=t[4],c=t[7],a=t[2],f=t[5],h=t[8];return n[0]=e,n[1]=i,n[2]=o,n[3]=u,n[4]=s,n[5]=c,n[6]=a,n[7]=f,n[8]=h,n};const z=[1,0,0],C=[2,2,1];function D(t){let n=0;for(let e=0;e<3;++e){const r=t[R.getElementIndex(C[e],z[e])];n+=2*r*r}return Math.sqrt(n)}function B(t,n){const e=l.EPSILON15;let r=0,i=1;for(let n=0;n<3;++n){const e=Math.abs(t[R.getElementIndex(C[n],z[n])]);e>r&&(i=n,r=e)}let o=1,u=0;const s=z[i],c=C[i];if(Math.abs(t[R.getElementIndex(c,s)])>e){const n=(t[R.getElementIndex(c,c)]-t[R.getElementIndex(s,s)])/2/t[R.getElementIndex(c,s)];let e;e=n<0?-1/(-n+Math.sqrt(1+n*n)):1/(n+Math.sqrt(1+n*n)),o=1/Math.sqrt(1+e*e),u=e*o}return(n=R.clone(R.IDENTITY,n))[R.getElementIndex(s,s)]=n[R.getElementIndex(c,c)]=o,n[R.getElementIndex(c,s)]=u,n[R.getElementIndex(s,c)]=-u,n}const L=new R,_=new R;R.computeEigenDecomposition=function(t,e){r.typeOf.object("matrix",t);const i=l.EPSILON20;let o=0,u=0;n(e)||(e={});const s=e.unitary=R.clone(R.IDENTITY,e.unitary),c=e.diagonal=R.clone(t,e.diagonal),a=i*function(t){let n=0;for(let e=0;e<9;++e){const r=t[e];n+=r*r}return Math.sqrt(n)}(c);for(;u<10&&D(c)>a;)B(c,L),R.transpose(L,_),R.multiply(c,L,c),R.multiply(_,c,c),R.multiply(s,L,s),++o>2&&(++u,o=0);return e},R.abs=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n[0]=Math.abs(t[0]),n[1]=Math.abs(t[1]),n[2]=Math.abs(t[2]),n[3]=Math.abs(t[3]),n[4]=Math.abs(t[4]),n[5]=Math.abs(t[5]),n[6]=Math.abs(t[6]),n[7]=Math.abs(t[7]),n[8]=Math.abs(t[8]),n},R.determinant=function(t){r.typeOf.object("matrix",t);const n=t[0],e=t[3],i=t[6],o=t[1],u=t[4],s=t[7],c=t[2],a=t[5],f=t[8];return n*(u*f-a*s)+o*(a*i-e*f)+c*(e*s-u*i)},R.inverse=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const i=t[0],o=t[1],u=t[2],s=t[3],c=t[4],a=t[5],f=t[6],h=t[7],d=t[8],w=R.determinant(t);if(Math.abs(w)<=l.EPSILON15)throw new e("matrix is not invertible");n[0]=c*d-h*a,n[1]=h*u-o*d,n[2]=o*a-c*u,n[3]=f*a-s*d,n[4]=i*d-f*u,n[5]=s*u-i*a,n[6]=s*h-f*c,n[7]=f*o-i*h,n[8]=i*c-s*o;const m=1/w;return R.multiplyByScalar(n,m,n)};const V=new R;function H(t){let n;this.name="RuntimeError",this.message=t;try{throw new Error}catch(t){n=t.stack}this.stack=n}function Y(t,n,e,r,i,u,s,c,a,f,h,l,d,w,m,g){this[0]=o(t,0),this[1]=o(i,0),this[2]=o(a,0),this[3]=o(d,0),this[4]=o(n,0),this[5]=o(u,0),this[6]=o(f,0),this[7]=o(w,0),this[8]=o(e,0),this[9]=o(s,0),this[10]=o(h,0),this[11]=o(m,0),this[12]=o(r,0),this[13]=o(c,0),this[14]=o(l,0),this[15]=o(g,0)}R.inverseTranspose=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),R.inverse(R.transpose(t,V),n)},R.equals=function(t,e){return t===e||n(t)&&n(e)&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},R.equalsEpsilon=function(t,e,r){return r=o(r,0),t===e||n(t)&&n(e)&&Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r&&Math.abs(t[4]-e[4])<=r&&Math.abs(t[5]-e[5])<=r&&Math.abs(t[6]-e[6])<=r&&Math.abs(t[7]-e[7])<=r&&Math.abs(t[8]-e[8])<=r},R.IDENTITY=Object.freeze(new R(1,0,0,0,1,0,0,0,1)),R.ZERO=Object.freeze(new R(0,0,0,0,0,0,0,0,0)),R.COLUMN0ROW0=0,R.COLUMN0ROW1=1,R.COLUMN0ROW2=2,R.COLUMN1ROW0=3,R.COLUMN1ROW1=4,R.COLUMN1ROW2=5,R.COLUMN2ROW0=6,R.COLUMN2ROW1=7,R.COLUMN2ROW2=8,Object.defineProperties(R.prototype,{length:{get:function(){return R.packedLength}}}),R.prototype.clone=function(t){return R.clone(this,t)},R.prototype.equals=function(t){return R.equals(this,t)},R.equalsArray=function(t,n,e){return t[0]===n[e]&&t[1]===n[e+1]&&t[2]===n[e+2]&&t[3]===n[e+3]&&t[4]===n[e+4]&&t[5]===n[e+5]&&t[6]===n[e+6]&&t[7]===n[e+7]&&t[8]===n[e+8]},R.prototype.equalsEpsilon=function(t,n){return R.equalsEpsilon(this,t,n)},R.prototype.toString=function(){return`(${this[0]}, ${this[3]}, ${this[6]})\\n(${this[1]}, ${this[4]}, ${this[7]})\\n(${this[2]}, ${this[5]}, ${this[8]})`},n(Object.create)&&(H.prototype=Object.create(Error.prototype),H.prototype.constructor=H),H.prototype.toString=function(){let t=`${this.name}: ${this.message}`;return n(this.stack)&&(t+=`\\n${this.stack.toString()}`),t},Y.packedLength=16,Y.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t[0],n[e++]=t[1],n[e++]=t[2],n[e++]=t[3],n[e++]=t[4],n[e++]=t[5],n[e++]=t[6],n[e++]=t[7],n[e++]=t[8],n[e++]=t[9],n[e++]=t[10],n[e++]=t[11],n[e++]=t[12],n[e++]=t[13],n[e++]=t[14],n[e]=t[15],n},Y.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new Y),i[0]=t[e++],i[1]=t[e++],i[2]=t[e++],i[3]=t[e++],i[4]=t[e++],i[5]=t[e++],i[6]=t[e++],i[7]=t[e++],i[8]=t[e++],i[9]=t[e++],i[10]=t[e++],i[11]=t[e++],i[12]=t[e++],i[13]=t[e++],i[14]=t[e++],i[15]=t[e],i},Y.packArray=function(t,i){r.defined("array",t);const o=t.length,u=16*o;if(n(i)){if(!Array.isArray(i)&&i.length!==u)throw new e("If result is a typed array, it must have exactly array.length * 16 elements");i.length!==u&&(i.length=u)}else i=new Array(u);for(let n=0;n<o;++n)Y.pack(t[n],i,16*n);return i},Y.unpackArray=function(t,i){if(r.defined("array",t),r.typeOf.number.greaterThanOrEquals("array.length",t.length,16),t.length%16!=0)throw new e("array length must be a multiple of 16.");const o=t.length;n(i)?i.length=o/16:i=new Array(o/16);for(let n=0;n<o;n+=16){const e=n/16;i[e]=Y.unpack(t,n,i[e])}return i},Y.clone=function(t,e){if(n(t))return n(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):new Y(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])},Y.fromArray=Y.unpack,Y.fromColumnMajorArray=function(t,n){return r.defined("values",t),Y.clone(t,n)},Y.fromRowMajorArray=function(t,e){return r.defined("values",t),n(e)?(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e):new Y(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},Y.fromRotationTranslation=function(t,e,i){return r.typeOf.object("rotation",t),e=o(e,m.ZERO),n(i)?(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=0,i[4]=t[3],i[5]=t[4],i[6]=t[5],i[7]=0,i[8]=t[6],i[9]=t[7],i[10]=t[8],i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,i):new Y(t[0],t[3],t[6],e.x,t[1],t[4],t[7],e.y,t[2],t[5],t[8],e.z,0,0,0,1)},Y.fromTranslationQuaternionRotationScale=function(t,e,i,o){r.typeOf.object("translation",t),r.typeOf.object("rotation",e),r.typeOf.object("scale",i),n(o)||(o=new Y);const u=i.x,s=i.y,c=i.z,a=e.x*e.x,f=e.x*e.y,h=e.x*e.z,l=e.x*e.w,d=e.y*e.y,w=e.y*e.z,m=e.y*e.w,g=e.z*e.z,v=e.z*e.w,p=e.w*e.w,y=a-d-g+p,b=2*(f-v),M=2*(h+m),A=2*(f+v),x=-a+d-g+p,E=2*(w-l),k=2*(h-m),q=2*(w+l),$=-a-d+g+p;return o[0]=y*u,o[1]=A*u,o[2]=k*u,o[3]=0,o[4]=b*s,o[5]=x*s,o[6]=q*s,o[7]=0,o[8]=M*c,o[9]=E*c,o[10]=$*c,o[11]=0,o[12]=t.x,o[13]=t.y,o[14]=t.z,o[15]=1,o},Y.fromTranslationRotationScale=function(t,n){return r.typeOf.object("translationRotationScale",t),Y.fromTranslationQuaternionRotationScale(t.translation,t.rotation,t.scale,n)},Y.fromTranslation=function(t,n){return r.typeOf.object("translation",t),Y.fromRotationTranslation(R.IDENTITY,t,n)},Y.fromScale=function(t,e){return r.typeOf.object("scale",t),n(e)?(e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t.y,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t.z,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e):new Y(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1)},Y.fromUniformScale=function(t,e){return r.typeOf.number("scale",t),n(e)?(e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e):new Y(t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1)},Y.fromRotation=function(t,e){return r.typeOf.object("rotation",t),n(e)||(e=new Y),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};const Z=new m,W=new m,Q=new m;Y.fromCamera=function(t,e){r.typeOf.object("camera",t);const i=t.position,o=t.direction,u=t.up;r.typeOf.object("camera.position",i),r.typeOf.object("camera.direction",o),r.typeOf.object("camera.up",u),m.normalize(o,Z),m.normalize(m.cross(Z,u,W),W),m.normalize(m.cross(W,Z,Q),Q);const s=W.x,c=W.y,a=W.z,f=Z.x,h=Z.y,l=Z.z,d=Q.x,w=Q.y,g=Q.z,v=i.x,p=i.y,y=i.z,b=s*-v+c*-p+a*-y,M=d*-v+w*-p+g*-y,A=f*v+h*p+l*y;return n(e)?(e[0]=s,e[1]=d,e[2]=-f,e[3]=0,e[4]=c,e[5]=w,e[6]=-h,e[7]=0,e[8]=a,e[9]=g,e[10]=-l,e[11]=0,e[12]=b,e[13]=M,e[14]=A,e[15]=1,e):new Y(s,c,a,b,d,w,g,M,-f,-h,-l,A,0,0,0,1)},Y.computePerspectiveFieldOfView=function(t,n,e,i,o){r.typeOf.number.greaterThan("fovY",t,0),r.typeOf.number.lessThan("fovY",t,Math.PI),r.typeOf.number.greaterThan("near",e,0),r.typeOf.number.greaterThan("far",i,0),r.typeOf.object("result",o);const u=1/Math.tan(.5*t),s=u/n,c=(i+e)/(e-i),a=2*i*e/(e-i);return o[0]=s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=u,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=c,o[11]=-1,o[12]=0,o[13]=0,o[14]=a,o[15]=0,o},Y.computeOrthographicOffCenter=function(t,n,e,i,o,u,s){r.typeOf.number("left",t),r.typeOf.number("right",n),r.typeOf.number("bottom",e),r.typeOf.number("top",i),r.typeOf.number("near",o),r.typeOf.number("far",u),r.typeOf.object("result",s);let c=1/(n-t),a=1/(i-e),f=1/(u-o);const h=-(n+t)*c,l=-(i+e)*a,d=-(u+o)*f;return c*=2,a*=2,f*=-2,s[0]=c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=f,s[11]=0,s[12]=h,s[13]=l,s[14]=d,s[15]=1,s},Y.computePerspectiveOffCenter=function(t,n,e,i,o,u,s){r.typeOf.number("left",t),r.typeOf.number("right",n),r.typeOf.number("bottom",e),r.typeOf.number("top",i),r.typeOf.number("near",o),r.typeOf.number("far",u),r.typeOf.object("result",s);const c=2*o/(n-t),a=2*o/(i-e),f=(n+t)/(n-t),h=(i+e)/(i-e),l=-(u+o)/(u-o),d=-2*u*o/(u-o);return s[0]=c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a,s[6]=0,s[7]=0,s[8]=f,s[9]=h,s[10]=l,s[11]=-1,s[12]=0,s[13]=0,s[14]=d,s[15]=0,s},Y.computeInfinitePerspectiveOffCenter=function(t,n,e,i,o,u){r.typeOf.number("left",t),r.typeOf.number("right",n),r.typeOf.number("bottom",e),r.typeOf.number("top",i),r.typeOf.number("near",o),r.typeOf.object("result",u);const s=2*o/(n-t),c=2*o/(i-e),a=(n+t)/(n-t),f=(i+e)/(i-e),h=-2*o;return u[0]=s,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=c,u[6]=0,u[7]=0,u[8]=a,u[9]=f,u[10]=-1,u[11]=-1,u[12]=0,u[13]=0,u[14]=h,u[15]=0,u},Y.computeViewportTransformation=function(t,e,r,i){n(i)||(i=new Y),t=o(t,o.EMPTY_OBJECT);const u=o(t.x,0),s=o(t.y,0),c=o(t.width,0),a=o(t.height,0);e=o(e,0);const f=.5*c,h=.5*a,l=.5*((r=o(r,1))-e),d=f,w=h,m=l,g=u+f,v=s+h,p=e+l;return i[0]=d,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=w,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=m,i[11]=0,i[12]=g,i[13]=v,i[14]=p,i[15]=1,i},Y.computeView=function(t,n,e,i,o){return r.typeOf.object("position",t),r.typeOf.object("direction",n),r.typeOf.object("up",e),r.typeOf.object("right",i),r.typeOf.object("result",o),o[0]=i.x,o[1]=e.x,o[2]=-n.x,o[3]=0,o[4]=i.y,o[5]=e.y,o[6]=-n.y,o[7]=0,o[8]=i.z,o[9]=e.z,o[10]=-n.z,o[11]=0,o[12]=-m.dot(i,t),o[13]=-m.dot(e,t),o[14]=m.dot(n,t),o[15]=1,o},Y.toArray=function(t,e){return r.typeOf.object("matrix",t),n(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},Y.getElementIndex=function(t,n){return r.typeOf.number.greaterThanOrEquals("row",n,0),r.typeOf.number.lessThanOrEquals("row",n,3),r.typeOf.number.greaterThanOrEquals("column",t,0),r.typeOf.number.lessThanOrEquals("column",t,3),4*t+n},Y.getColumn=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,3),r.typeOf.object("result",e);const i=4*n,o=t[i],u=t[i+1],s=t[i+2],c=t[i+3];return e.x=o,e.y=u,e.z=s,e.w=c,e},Y.setColumn=function(t,n,e,i){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,3),r.typeOf.object("cartesian",e),r.typeOf.object("result",i);const o=4*n;return(i=Y.clone(t,i))[o]=e.x,i[o+1]=e.y,i[o+2]=e.z,i[o+3]=e.w,i},Y.getRow=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,3),r.typeOf.object("result",e);const i=t[n],o=t[n+4],u=t[n+8],s=t[n+12];return e.x=i,e.y=o,e.z=u,e.w=s,e},Y.setRow=function(t,n,e,i){return r.typeOf.object("matrix",t),r.typeOf.number.greaterThanOrEquals("index",n,0),r.typeOf.number.lessThanOrEquals("index",n,3),r.typeOf.object("cartesian",e),r.typeOf.object("result",i),(i=Y.clone(t,i))[n]=e.x,i[n+4]=e.y,i[n+8]=e.z,i[n+12]=e.w,i},Y.setTranslation=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.object("translation",n),r.typeOf.object("result",e),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=n.x,e[13]=n.y,e[14]=n.z,e[15]=t[15],e};const J=new m;Y.setScale=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("scale",n),r.typeOf.object("result",e);const i=Y.getScale(t,J),o=n.x/i.x,u=n.y/i.y,s=n.z/i.z;return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3],e[4]=t[4]*u,e[5]=t[5]*u,e[6]=t[6]*u,e[7]=t[7],e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};const G=new m;Y.setUniformScale=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.number("scale",n),r.typeOf.object("result",e);const i=Y.getScale(t,G),o=n/i.x,u=n/i.y,s=n/i.z;return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3],e[4]=t[4]*u,e[5]=t[5]*u,e[6]=t[6]*u,e[7]=t[7],e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};const X=new m;Y.getScale=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n.x=m.magnitude(m.fromElements(t[0],t[1],t[2],X)),n.y=m.magnitude(m.fromElements(t[4],t[5],t[6],X)),n.z=m.magnitude(m.fromElements(t[8],t[9],t[10],X)),n};const K=new m;Y.getMaximumScale=function(t){return Y.getScale(t,K),m.maximumComponent(K)};const tt=new m;Y.setRotation=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("result",e);const i=Y.getScale(t,tt);return e[0]=n[0]*i.x,e[1]=n[1]*i.x,e[2]=n[2]*i.x,e[3]=t[3],e[4]=n[3]*i.y,e[5]=n[4]*i.y,e[6]=n[5]*i.y,e[7]=t[7],e[8]=n[6]*i.z,e[9]=n[7]*i.z,e[10]=n[8]*i.z,e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};const nt=new m;Y.getRotation=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=Y.getScale(t,nt);return n[0]=t[0]/e.x,n[1]=t[1]/e.x,n[2]=t[2]/e.x,n[3]=t[4]/e.y,n[4]=t[5]/e.y,n[5]=t[6]/e.y,n[6]=t[8]/e.z,n[7]=t[9]/e.z,n[8]=t[10]/e.z,n},Y.multiply=function(t,n,e){r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e);const i=t[0],o=t[1],u=t[2],s=t[3],c=t[4],a=t[5],f=t[6],h=t[7],l=t[8],d=t[9],w=t[10],m=t[11],g=t[12],v=t[13],p=t[14],y=t[15],b=n[0],M=n[1],A=n[2],x=n[3],E=n[4],k=n[5],q=n[6],$=n[7],S=n[8],I=n[9],O=n[10],R=n[11],P=n[12],j=n[13],F=n[14],N=n[15],U=i*b+c*M+l*A+g*x,T=o*b+a*M+d*A+v*x,z=u*b+f*M+w*A+p*x,C=s*b+h*M+m*A+y*x,D=i*E+c*k+l*q+g*$,B=o*E+a*k+d*q+v*$,L=u*E+f*k+w*q+p*$,_=s*E+h*k+m*q+y*$,V=i*S+c*I+l*O+g*R,H=o*S+a*I+d*O+v*R,Y=u*S+f*I+w*O+p*R,Z=s*S+h*I+m*O+y*R,W=i*P+c*j+l*F+g*N,Q=o*P+a*j+d*F+v*N,J=u*P+f*j+w*F+p*N,G=s*P+h*j+m*F+y*N;return e[0]=U,e[1]=T,e[2]=z,e[3]=C,e[4]=D,e[5]=B,e[6]=L,e[7]=_,e[8]=V,e[9]=H,e[10]=Y,e[11]=Z,e[12]=W,e[13]=Q,e[14]=J,e[15]=G,e},Y.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e[9]=t[9]+n[9],e[10]=t[10]+n[10],e[11]=t[11]+n[11],e[12]=t[12]+n[12],e[13]=t[13]+n[13],e[14]=t[14]+n[14],e[15]=t[15]+n[15],e},Y.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e[9]=t[9]-n[9],e[10]=t[10]-n[10],e[11]=t[11]-n[11],e[12]=t[12]-n[12],e[13]=t[13]-n[13],e[14]=t[14]-n[14],e[15]=t[15]-n[15],e},Y.multiplyTransformation=function(t,n,e){r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e);const i=t[0],o=t[1],u=t[2],s=t[4],c=t[5],a=t[6],f=t[8],h=t[9],l=t[10],d=t[12],w=t[13],m=t[14],g=n[0],v=n[1],p=n[2],y=n[4],b=n[5],M=n[6],A=n[8],x=n[9],E=n[10],k=n[12],q=n[13],$=n[14],S=i*g+s*v+f*p,I=o*g+c*v+h*p,O=u*g+a*v+l*p,R=i*y+s*b+f*M,P=o*y+c*b+h*M,j=u*y+a*b+l*M,F=i*A+s*x+f*E,N=o*A+c*x+h*E,U=u*A+a*x+l*E,T=i*k+s*q+f*$+d,z=o*k+c*q+h*$+w,C=u*k+a*q+l*$+m;return e[0]=S,e[1]=I,e[2]=O,e[3]=0,e[4]=R,e[5]=P,e[6]=j,e[7]=0,e[8]=F,e[9]=N,e[10]=U,e[11]=0,e[12]=T,e[13]=z,e[14]=C,e[15]=1,e},Y.multiplyByMatrix3=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("rotation",n),r.typeOf.object("result",e);const i=t[0],o=t[1],u=t[2],s=t[4],c=t[5],a=t[6],f=t[8],h=t[9],l=t[10],d=n[0],w=n[1],m=n[2],g=n[3],v=n[4],p=n[5],y=n[6],b=n[7],M=n[8],A=i*d+s*w+f*m,x=o*d+c*w+h*m,E=u*d+a*w+l*m,k=i*g+s*v+f*p,q=o*g+c*v+h*p,$=u*g+a*v+l*p,S=i*y+s*b+f*M,I=o*y+c*b+h*M,O=u*y+a*b+l*M;return e[0]=A,e[1]=x,e[2]=E,e[3]=0,e[4]=k,e[5]=q,e[6]=$,e[7]=0,e[8]=S,e[9]=I,e[10]=O,e[11]=0,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Y.multiplyByTranslation=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("translation",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z,s=i*t[0]+o*t[4]+u*t[8]+t[12],c=i*t[1]+o*t[5]+u*t[9]+t[13],a=i*t[2]+o*t[6]+u*t[10]+t[14];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=s,e[13]=c,e[14]=a,e[15]=t[15],e},Y.multiplyByScale=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("scale",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z;return 1===i&&1===o&&1===u?Y.clone(t,e):(e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=t[3],e[4]=o*t[4],e[5]=o*t[5],e[6]=o*t[6],e[7]=t[7],e[8]=u*t[8],e[9]=u*t[9],e[10]=u*t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e)},Y.multiplyByUniformScale=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.number("scale",n),r.typeOf.object("result",e),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3],e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7],e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Y.multiplyByVector=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("cartesian",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z,s=n.w,c=t[0]*i+t[4]*o+t[8]*u+t[12]*s,a=t[1]*i+t[5]*o+t[9]*u+t[13]*s,f=t[2]*i+t[6]*o+t[10]*u+t[14]*s,h=t[3]*i+t[7]*o+t[11]*u+t[15]*s;return e.x=c,e.y=a,e.z=f,e.w=h,e},Y.multiplyByPointAsVector=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("cartesian",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z,s=t[0]*i+t[4]*o+t[8]*u,c=t[1]*i+t[5]*o+t[9]*u,a=t[2]*i+t[6]*o+t[10]*u;return e.x=s,e.y=c,e.z=a,e},Y.multiplyByPoint=function(t,n,e){r.typeOf.object("matrix",t),r.typeOf.object("cartesian",n),r.typeOf.object("result",e);const i=n.x,o=n.y,u=n.z,s=t[0]*i+t[4]*o+t[8]*u+t[12],c=t[1]*i+t[5]*o+t[9]*u+t[13],a=t[2]*i+t[6]*o+t[10]*u+t[14];return e.x=s,e.y=c,e.z=a,e},Y.multiplyByScalar=function(t,n,e){return r.typeOf.object("matrix",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n,e},Y.negate=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n[3]=-t[3],n[4]=-t[4],n[5]=-t[5],n[6]=-t[6],n[7]=-t[7],n[8]=-t[8],n[9]=-t[9],n[10]=-t[10],n[11]=-t[11],n[12]=-t[12],n[13]=-t[13],n[14]=-t[14],n[15]=-t[15],n},Y.transpose=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=t[1],i=t[2],o=t[3],u=t[6],s=t[7],c=t[11];return n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=e,n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=i,n[9]=u,n[10]=t[10],n[11]=t[14],n[12]=o,n[13]=s,n[14]=c,n[15]=t[15],n},Y.abs=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n[0]=Math.abs(t[0]),n[1]=Math.abs(t[1]),n[2]=Math.abs(t[2]),n[3]=Math.abs(t[3]),n[4]=Math.abs(t[4]),n[5]=Math.abs(t[5]),n[6]=Math.abs(t[6]),n[7]=Math.abs(t[7]),n[8]=Math.abs(t[8]),n[9]=Math.abs(t[9]),n[10]=Math.abs(t[10]),n[11]=Math.abs(t[11]),n[12]=Math.abs(t[12]),n[13]=Math.abs(t[13]),n[14]=Math.abs(t[14]),n[15]=Math.abs(t[15]),n},Y.equals=function(t,e){return t===e||n(t)&&n(e)&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[3]===e[3]&&t[7]===e[7]&&t[11]===e[11]&&t[15]===e[15]},Y.equalsEpsilon=function(t,e,r){return r=o(r,0),t===e||n(t)&&n(e)&&Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r&&Math.abs(t[4]-e[4])<=r&&Math.abs(t[5]-e[5])<=r&&Math.abs(t[6]-e[6])<=r&&Math.abs(t[7]-e[7])<=r&&Math.abs(t[8]-e[8])<=r&&Math.abs(t[9]-e[9])<=r&&Math.abs(t[10]-e[10])<=r&&Math.abs(t[11]-e[11])<=r&&Math.abs(t[12]-e[12])<=r&&Math.abs(t[13]-e[13])<=r&&Math.abs(t[14]-e[14])<=r&&Math.abs(t[15]-e[15])<=r},Y.getTranslation=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n.x=t[12],n.y=t[13],n.z=t[14],n},Y.getMatrix3=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],n};const et=new R,rt=new R,it=new x,ot=new x(0,0,0,1);Y.inverse=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=t[0],i=t[4],o=t[8],u=t[12],s=t[1],c=t[5],a=t[9],f=t[13],h=t[2],d=t[6],w=t[10],m=t[14],g=t[3],v=t[7],p=t[11],y=t[15];let b=w*y,M=m*p,A=d*y,E=m*v,k=d*p,q=w*v,$=h*y,S=m*g,I=h*p,O=w*g,P=h*v,j=d*g;const F=b*c+E*a+k*f-(M*c+A*a+q*f),N=M*s+$*a+O*f-(b*s+S*a+I*f),U=A*s+S*c+P*f-(E*s+$*c+j*f),T=q*s+I*c+j*a-(k*s+O*c+P*a),z=M*i+A*o+q*u-(b*i+E*o+k*u),C=b*e+S*o+I*u-(M*e+$*o+O*u),D=E*e+$*i+j*u-(A*e+S*i+P*u),B=k*e+O*i+P*o-(q*e+I*i+j*o);b=o*f,M=u*a,A=i*f,E=u*c,k=i*a,q=o*c,$=e*f,S=u*s,I=e*a,O=o*s,P=e*c,j=i*s;const L=b*v+E*p+k*y-(M*v+A*p+q*y),_=M*g+$*p+O*y-(b*g+S*p+I*y),V=A*g+S*v+P*y-(E*g+$*v+j*y),Z=q*g+I*v+j*p-(k*g+O*v+P*p),W=A*w+q*m+M*d-(k*m+b*d+E*w),Q=I*m+b*h+S*w-($*w+O*m+M*h),J=$*d+j*m+E*h-(P*m+A*h+S*d),G=P*w+k*h+O*d-(I*d+j*w+q*h);let X=e*F+i*N+o*U+u*T;if(Math.abs(X)<l.EPSILON21){if(R.equalsEpsilon(Y.getMatrix3(t,et),rt,l.EPSILON7)&&x.equals(Y.getRow(t,3,it),ot))return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=0,n[11]=0,n[12]=-t[12],n[13]=-t[13],n[14]=-t[14],n[15]=1,n;throw new H("matrix is not invertible because its determinate is zero.")}return X=1/X,n[0]=F*X,n[1]=N*X,n[2]=U*X,n[3]=T*X,n[4]=z*X,n[5]=C*X,n[6]=D*X,n[7]=B*X,n[8]=L*X,n[9]=_*X,n[10]=V*X,n[11]=Z*X,n[12]=W*X,n[13]=Q*X,n[14]=J*X,n[15]=G*X,n},Y.inverseTransformation=function(t,n){r.typeOf.object("matrix",t),r.typeOf.object("result",n);const e=t[0],i=t[1],o=t[2],u=t[4],s=t[5],c=t[6],a=t[8],f=t[9],h=t[10],l=t[12],d=t[13],w=t[14],m=-e*l-i*d-o*w,g=-u*l-s*d-c*w,v=-a*l-f*d-h*w;return n[0]=e,n[1]=u,n[2]=a,n[3]=0,n[4]=i,n[5]=s,n[6]=f,n[7]=0,n[8]=o,n[9]=c,n[10]=h,n[11]=0,n[12]=m,n[13]=g,n[14]=v,n[15]=1,n};const ut=new Y;let st;Y.inverseTranspose=function(t,n){return r.typeOf.object("matrix",t),r.typeOf.object("result",n),Y.inverse(Y.transpose(t,ut),n)},Y.IDENTITY=Object.freeze(new Y(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)),Y.ZERO=Object.freeze(new Y(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),Y.COLUMN0ROW0=0,Y.COLUMN0ROW1=1,Y.COLUMN0ROW2=2,Y.COLUMN0ROW3=3,Y.COLUMN1ROW0=4,Y.COLUMN1ROW1=5,Y.COLUMN1ROW2=6,Y.COLUMN1ROW3=7,Y.COLUMN2ROW0=8,Y.COLUMN2ROW1=9,Y.COLUMN2ROW2=10,Y.COLUMN2ROW3=11,Y.COLUMN3ROW0=12,Y.COLUMN3ROW1=13,Y.COLUMN3ROW2=14,Y.COLUMN3ROW3=15,Object.defineProperties(Y.prototype,{length:{get:function(){return Y.packedLength}}}),Y.prototype.clone=function(t){return Y.clone(this,t)},Y.prototype.equals=function(t){return Y.equals(this,t)},Y.equalsArray=function(t,n,e){return t[0]===n[e]&&t[1]===n[e+1]&&t[2]===n[e+2]&&t[3]===n[e+3]&&t[4]===n[e+4]&&t[5]===n[e+5]&&t[6]===n[e+6]&&t[7]===n[e+7]&&t[8]===n[e+8]&&t[9]===n[e+9]&&t[10]===n[e+10]&&t[11]===n[e+11]&&t[12]===n[e+12]&&t[13]===n[e+13]&&t[14]===n[e+14]&&t[15]===n[e+15]},Y.prototype.equalsEpsilon=function(t,n){return Y.equalsEpsilon(this,t,n)},Y.prototype.toString=function(){return`(${this[0]}, ${this[4]}, ${this[8]}, ${this[12]})\\n(${this[1]}, ${this[5]}, ${this[9]}, ${this[13]})\\n(${this[2]}, ${this[6]}, ${this[10]}, ${this[14]})\\n(${this[3]}, ${this[7]}, ${this[11]}, ${this[15]})`};const ct={requestFullscreen:void 0,exitFullscreen:void 0,fullscreenEnabled:void 0,fullscreenElement:void 0,fullscreenchange:void 0,fullscreenerror:void 0},at={};let ft,ht,lt,dt,wt,mt,gt,vt,pt,yt,bt,Mt,At,xt,Et,kt,qt,$t;function St(t){const n=t.split(".");for(let t=0,e=n.length;t<e;++t)n[t]=parseInt(n[t],10);return n}function It(){if(!n(ht)&&(ht=!1,!jt())){const t=/ Chrome\\/([\\.0-9]+)/.exec(ft.userAgent);null!==t&&(ht=!0,lt=St(t[1]))}return ht}function Ot(){if(!n(dt)&&(dt=!1,!It()&&!jt()&&/ Safari\\/[\\.0-9]+/.test(ft.userAgent))){const t=/ Version\\/([\\.0-9]+)/.exec(ft.userAgent);null!==t&&(dt=!0,wt=St(t[1]))}return dt}function Rt(){if(!n(mt)){mt=!1;const t=/ AppleWebKit\\/([\\.0-9]+)(\\+?)/.exec(ft.userAgent);null!==t&&(mt=!0,gt=St(t[1]),gt.isNightly=!!t[2])}return mt}function Pt(){if(!n(vt)){let t;vt=!1,"Microsoft Internet Explorer"===ft.appName?(t=/MSIE ([0-9]{1,}[\\.0-9]{0,})/.exec(ft.userAgent),null!==t&&(vt=!0,pt=St(t[1]))):"Netscape"===ft.appName&&(t=/Trident\\/.*rv:([0-9]{1,}[\\.0-9]{0,})/.exec(ft.userAgent),null!==t&&(vt=!0,pt=St(t[1])))}return vt}function jt(){if(!n(yt)){yt=!1;const t=/ Edg\\/([\\.0-9]+)/.exec(ft.userAgent);null!==t&&(yt=!0,bt=St(t[1]))}return yt}function Ft(){if(!n(Mt)){Mt=!1;const t=/Firefox\\/([\\.0-9]+)/.exec(ft.userAgent);null!==t&&(Mt=!0,At=St(t[1]))}return Mt}function Nt(){if(!n($t)){const t=document.createElement("canvas");t.setAttribute("style","image-rendering: -moz-crisp-edges;image-rendering: pixelated;");const e=t.style.imageRendering;$t=n(e)&&""!==e,$t&&(qt=e)}return $t}function Ut(){if(!Ut.initialized)throw new e("You must call FeatureDetection.supportsWebP.initialize and wait for the promise to resolve before calling FeatureDetection.supportsWebP");return Ut.u}Object.defineProperties(at,{element:{get:function(){if(at.supportsFullscreen())return document[ct.fullscreenElement]}},changeEventName:{get:function(){if(at.supportsFullscreen())return ct.fullscreenchange}},errorEventName:{get:function(){if(at.supportsFullscreen())return ct.fullscreenerror}},enabled:{get:function(){if(at.supportsFullscreen())return document[ct.fullscreenEnabled]}},fullscreen:{get:function(){if(at.supportsFullscreen())return null!==at.element}}}),at.supportsFullscreen=function(){if(n(st))return st;st=!1;const t=document.body;if("function"==typeof t.requestFullscreen)return ct.requestFullscreen="requestFullscreen",ct.exitFullscreen="exitFullscreen",ct.fullscreenEnabled="fullscreenEnabled",ct.fullscreenElement="fullscreenElement",ct.fullscreenchange="fullscreenchange",ct.fullscreenerror="fullscreenerror",st=!0,st;const e=["webkit","moz","o","ms","khtml"];let r;for(let n=0,i=e.length;n<i;++n){const i=e[n];r=`${i}RequestFullscreen`,"function"==typeof t[r]?(ct.requestFullscreen=r,st=!0):(r=`${i}RequestFullScreen`,"function"==typeof t[r]&&(ct.requestFullscreen=r,st=!0)),r=`${i}ExitFullscreen`,"function"==typeof document[r]?ct.exitFullscreen=r:(r=`${i}CancelFullScreen`,"function"==typeof document[r]&&(ct.exitFullscreen=r)),r=`${i}FullscreenEnabled`,void 0!==document[r]?ct.fullscreenEnabled=r:(r=`${i}FullScreenEnabled`,void 0!==document[r]&&(ct.fullscreenEnabled=r)),r=`${i}FullscreenElement`,void 0!==document[r]?ct.fullscreenElement=r:(r=`${i}FullScreenElement`,void 0!==document[r]&&(ct.fullscreenElement=r)),r=`${i}fullscreenchange`,void 0!==document[`on${r}`]&&("ms"===i&&(r="MSFullscreenChange"),ct.fullscreenchange=r),r=`${i}fullscreenerror`,void 0!==document[`on${r}`]&&("ms"===i&&(r="MSFullscreenError"),ct.fullscreenerror=r)}return st},at.requestFullscreen=function(t,n){at.supportsFullscreen()&&t[ct.requestFullscreen]({vrDisplay:n})},at.exitFullscreen=function(){at.supportsFullscreen()&&document[ct.exitFullscreen]()},at.h=ct,ft="undefined"!=typeof navigator?navigator:{},Ut.l=void 0,Ut.u=void 0,Ut.initialize=function(){return n(Ut.l)||(Ut.l=new Promise((t=>{const n=new Image;n.onload=function(){Ut.u=n.width>0&&n.height>0,t(Ut.u)},n.onerror=function(){Ut.u=!1,t(Ut.u)},n.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA"}))),Ut.l},Object.defineProperties(Ut,{initialized:{get:function(){return n(Ut.u)}}});const Tt=[];"undefined"!=typeof ArrayBuffer&&(Tt.push(Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array),"undefined"!=typeof Uint8ClampedArray&&Tt.push(Uint8ClampedArray),"undefined"!=typeof Uint8ClampedArray&&Tt.push(Uint8ClampedArray),"undefined"!=typeof BigInt64Array&&Tt.push(BigInt64Array),"undefined"!=typeof BigUint64Array&&Tt.push(BigUint64Array));const zt={isChrome:It,chromeVersion:function(){return It()&&lt},isSafari:Ot,safariVersion:function(){return Ot()&&wt},isWebkit:Rt,webkitVersion:function(){return Rt()&&gt},isInternetExplorer:Pt,internetExplorerVersion:function(){return Pt()&&pt},isEdge:jt,edgeVersion:function(){return jt()&&bt},isFirefox:Ft,firefoxVersion:function(){return Ft()&&At},isWindows:function(){return n(xt)||(xt=/Windows/i.test(ft.appVersion)),xt},isIPadOrIOS:function(){return n(Et)||(Et="iPhone"===navigator.platform||"iPod"===navigator.platform||"iPad"===navigator.platform),Et},hardwareConcurrency:o(ft.hardwareConcurrency,3),supportsPointerEvents:function(){return n(kt)||(kt=!Ft()&&"undefined"!=typeof PointerEvent&&(!n(ft.pointerEnabled)||ft.pointerEnabled)),kt},supportsImageRenderingPixelated:Nt,supportsWebP:Ut,imageRenderingValue:function(){return Nt()?qt:void 0},typedArrayTypes:Tt};function Ct(t,n){this.x=o(t,0),this.y=o(n,0)}zt.supportsBasis=function(t){return zt.supportsWebAssembly()&&t.context.supportsBasis},zt.supportsFullscreen=function(){return at.supportsFullscreen()},zt.supportsTypedArrays=function(){return"undefined"!=typeof ArrayBuffer},zt.supportsBigInt64Array=function(){return"undefined"!=typeof BigInt64Array},zt.supportsBigUint64Array=function(){return"undefined"!=typeof BigUint64Array},zt.supportsBigInt=function(){return"undefined"!=typeof BigInt},zt.supportsWebWorkers=function(){return"undefined"!=typeof Worker},zt.supportsWebAssembly=function(){return"undefined"!=typeof WebAssembly},zt.supportsWebgl2=function(t){return r.defined("scene",t),t.context.webgl2},zt.supportsEsmWebWorkers=function(){return!Ft()||parseInt(At)>=114},Ct.fromElements=function(t,e,r){return n(r)?(r.x=t,r.y=e,r):new Ct(t,e)},Ct.clone=function(t,e){if(n(t))return n(e)?(e.x=t.x,e.y=t.y,e):new Ct(t.x,t.y)},Ct.fromCartesian3=Ct.clone,Ct.fromCartesian4=Ct.clone,Ct.packedLength=2,Ct.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t.x,n[e]=t.y,n},Ct.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new Ct),i.x=t[e++],i.y=t[e],i},Ct.packArray=function(t,i){r.defined("array",t);const o=t.length,u=2*o;if(n(i)){if(!Array.isArray(i)&&i.length!==u)throw new e("If result is a typed array, it must have exactly array.length * 2 elements");i.length!==u&&(i.length=u)}else i=new Array(u);for(let n=0;n<o;++n)Ct.pack(t[n],i,2*n);return i},Ct.unpackArray=function(t,i){if(r.defined("array",t),r.typeOf.number.greaterThanOrEquals("array.length",t.length,2),t.length%2!=0)throw new e("array length must be a multiple of 2.");const o=t.length;n(i)?i.length=o/2:i=new Array(o/2);for(let n=0;n<o;n+=2){const e=n/2;i[e]=Ct.unpack(t,n,i[e])}return i},Ct.fromArray=Ct.unpack,Ct.maximumComponent=function(t){return r.typeOf.object("cartesian",t),Math.max(t.x,t.y)},Ct.minimumComponent=function(t){return r.typeOf.object("cartesian",t),Math.min(t.x,t.y)},Ct.minimumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},Ct.maximumByComponent=function(t,n,e){return r.typeOf.object("first",t),r.typeOf.object("second",n),r.typeOf.object("result",e),e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},Ct.clamp=function(t,n,e,i){r.typeOf.object("value",t),r.typeOf.object("min",n),r.typeOf.object("max",e),r.typeOf.object("result",i);const o=l.clamp(t.x,n.x,e.x),u=l.clamp(t.y,n.y,e.y);return i.x=o,i.y=u,i},Ct.magnitudeSquared=function(t){return r.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y},Ct.magnitude=function(t){return Math.sqrt(Ct.magnitudeSquared(t))};const Dt=new Ct;Ct.distance=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),Ct.subtract(t,n,Dt),Ct.magnitude(Dt)},Ct.distanceSquared=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),Ct.subtract(t,n,Dt),Ct.magnitudeSquared(Dt)},Ct.normalize=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const i=Ct.magnitude(t);if(n.x=t.x/i,n.y=t.y/i,isNaN(n.x)||isNaN(n.y))throw new e("normalized result is not a number");return n},Ct.dot=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),t.x*n.x+t.y*n.y},Ct.cross=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),t.x*n.y-t.y*n.x},Ct.multiplyComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x*n.x,e.y=t.y*n.y,e},Ct.divideComponents=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x/n.x,e.y=t.y/n.y,e},Ct.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x+n.x,e.y=t.y+n.y,e},Ct.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x-n.x,e.y=t.y-n.y,e},Ct.multiplyByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x*n,e.y=t.y*n,e},Ct.divideByScalar=function(t,n,e){return r.typeOf.object("cartesian",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x/n,e.y=t.y/n,e},Ct.negate=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=-t.x,n.y=-t.y,n},Ct.abs=function(t,n){return r.typeOf.object("cartesian",t),r.typeOf.object("result",n),n.x=Math.abs(t.x),n.y=Math.abs(t.y),n};const Bt=new Ct;Ct.lerp=function(t,n,e,i){return r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i),Ct.multiplyByScalar(n,e,Bt),i=Ct.multiplyByScalar(t,1-e,i),Ct.add(Bt,i,i)};const Lt=new Ct,_t=new Ct;Ct.angleBetween=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),Ct.normalize(t,Lt),Ct.normalize(n,_t),l.acosClamped(Ct.dot(Lt,_t))};const Vt=new Ct;Ct.mostOrthogonalAxis=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const e=Ct.normalize(t,Vt);return Ct.abs(e,e),e.x<=e.y?Ct.clone(Ct.UNIT_X,n):Ct.clone(Ct.UNIT_Y,n)},Ct.equals=function(t,e){return t===e||n(t)&&n(e)&&t.x===e.x&&t.y===e.y},Ct.equalsArray=function(t,n,e){return t.x===n[e]&&t.y===n[e+1]},Ct.equalsEpsilon=function(t,e,r,i){return t===e||n(t)&&n(e)&&l.equalsEpsilon(t.x,e.x,r,i)&&l.equalsEpsilon(t.y,e.y,r,i)},Ct.ZERO=Object.freeze(new Ct(0,0)),Ct.ONE=Object.freeze(new Ct(1,1)),Ct.UNIT_X=Object.freeze(new Ct(1,0)),Ct.UNIT_Y=Object.freeze(new Ct(0,1)),Ct.prototype.clone=function(t){return Ct.clone(this,t)},Ct.prototype.equals=function(t){return Ct.equals(this,t)},Ct.prototype.equalsEpsilon=function(t,n,e){return Ct.equalsEpsilon(this,t,n,e)},Ct.prototype.toString=function(){return`(${this.x}, ${this.y})`};const Ht=new m,Yt=new m;function Zt(t,r,i,o,u){if(!n(t))throw new e("cartesian is required.");if(!n(r))throw new e("oneOverRadii is required.");if(!n(i))throw new e("oneOverRadiiSquared is required.");if(!n(o))throw new e("centerToleranceSquared is required.");const s=t.x,c=t.y,a=t.z,f=r.x,h=r.y,d=r.z,w=s*s*f*f,g=c*c*h*h,v=a*a*d*d,p=w+g+v,y=Math.sqrt(1/p),b=m.multiplyByScalar(t,y,Ht);if(p<o)return isFinite(y)?m.clone(b,u):void 0;const M=i.x,A=i.y,x=i.z,E=Yt;E.x=b.x*M*2,E.y=b.y*A*2,E.z=b.z*x*2;let k,q,$,S,I,O,R,P,j,F,N,U=(1-y)*m.magnitude(t)/(.5*m.magnitude(E)),T=0;do{U-=T,$=1/(1+U*M),S=1/(1+U*A),I=1/(1+U*x),O=$*$,R=S*S,P=I*I,j=O*$,F=R*S,N=P*I,k=w*O+g*R+v*P-1,q=w*j*M+g*F*A+v*N*x,T=k/(-2*q)}while(Math.abs(k)>l.EPSILON12);return n(u)?(u.x=s*$,u.y=c*S,u.z=a*I,u):new m(s*$,c*S,a*I)}function Wt(t,n,e){this.longitude=o(t,0),this.latitude=o(n,0),this.height=o(e,0)}Wt.fromRadians=function(t,e,i,u){return r.typeOf.number("longitude",t),r.typeOf.number("latitude",e),i=o(i,0),n(u)?(u.longitude=t,u.latitude=e,u.height=i,u):new Wt(t,e,i)},Wt.fromDegrees=function(t,n,e,i){return r.typeOf.number("longitude",t),r.typeOf.number("latitude",n),t=l.toRadians(t),n=l.toRadians(n),Wt.fromRadians(t,n,e,i)};const Qt=new m,Jt=new m,Gt=new m;function Xt(t,n,e,i){n=o(n,0),e=o(e,0),i=o(i,0),r.typeOf.number.greaterThanOrEquals("x",n,0),r.typeOf.number.greaterThanOrEquals("y",e,0),r.typeOf.number.greaterThanOrEquals("z",i,0),t.m=new m(n,e,i),t.v=new m(n*n,e*e,i*i),t.p=new m(n*n*n*n,e*e*e*e,i*i*i*i),t.A=new m(0===n?0:1/n,0===e?0:1/e,0===i?0:1/i),t.k=new m(0===n?0:1/(n*n),0===e?0:1/(e*e),0===i?0:1/(i*i)),t.q=Math.min(n,e,i),t.$=Math.max(n,e,i),t.S=l.EPSILON1,0!==t.v.z&&(t.I=t.v.x/t.v.z)}function Kt(t,n,e){this.m=void 0,this.v=void 0,this.p=void 0,this.A=void 0,this.k=void 0,this.q=void 0,this.$=void 0,this.S=void 0,this.I=void 0,Xt(this,t,n,e)}Wt.O=new m(1/6378137,1/6378137,1/6356752.314245179),Wt.R=new m(1/40680631590769,1/40680631590769,1/40408299984661.445),Wt.P=l.EPSILON1,Wt.fromCartesian=function(t,e,r){const i=n(e)?e.oneOverRadii:Wt.O,o=n(e)?e.oneOverRadiiSquared:Wt.R,u=Zt(t,i,o,n(e)?e.S:Wt.P,Jt);if(!n(u))return;let s=m.multiplyComponents(u,o,Qt);s=m.normalize(s,s);const c=m.subtract(t,u,Gt),a=Math.atan2(s.y,s.x),f=Math.asin(s.z),h=l.sign(m.dot(c,t))*m.magnitude(c);return n(r)?(r.longitude=a,r.latitude=f,r.height=h,r):new Wt(a,f,h)},Wt.toCartesian=function(t,n,e){return r.defined("cartographic",t),m.fromRadians(t.longitude,t.latitude,t.height,n,e)},Wt.clone=function(t,e){if(n(t))return n(e)?(e.longitude=t.longitude,e.latitude=t.latitude,e.height=t.height,e):new Wt(t.longitude,t.latitude,t.height)},Wt.equals=function(t,e){return t===e||n(t)&&n(e)&&t.longitude===e.longitude&&t.latitude===e.latitude&&t.height===e.height},Wt.equalsEpsilon=function(t,e,r){return r=o(r,0),t===e||n(t)&&n(e)&&Math.abs(t.longitude-e.longitude)<=r&&Math.abs(t.latitude-e.latitude)<=r&&Math.abs(t.height-e.height)<=r},Wt.ZERO=Object.freeze(new Wt(0,0,0)),Wt.prototype.clone=function(t){return Wt.clone(this,t)},Wt.prototype.equals=function(t){return Wt.equals(this,t)},Wt.prototype.equalsEpsilon=function(t,n){return Wt.equalsEpsilon(this,t,n)},Wt.prototype.toString=function(){return`(${this.longitude}, ${this.latitude}, ${this.height})`},Object.defineProperties(Kt.prototype,{radii:{get:function(){return this.m}},radiiSquared:{get:function(){return this.v}},radiiToTheFourth:{get:function(){return this.p}},oneOverRadii:{get:function(){return this.A}},oneOverRadiiSquared:{get:function(){return this.k}},minimumRadius:{get:function(){return this.q}},maximumRadius:{get:function(){return this.$}}}),Kt.clone=function(t,e){if(!n(t))return;const r=t.m;return n(e)?(m.clone(r,e.m),m.clone(t.v,e.v),m.clone(t.p,e.p),m.clone(t.A,e.A),m.clone(t.k,e.k),e.q=t.q,e.$=t.$,e.S=t.S,e):new Kt(r.x,r.y,r.z)},Kt.fromCartesian3=function(t,e){return n(e)||(e=new Kt),n(t)?(Xt(e,t.x,t.y,t.z),e):e},Kt.WGS84=Object.freeze(new Kt(6378137,6378137,6356752.314245179)),Kt.UNIT_SPHERE=Object.freeze(new Kt(1,1,1)),Kt.MOON=Object.freeze(new Kt(l.LUNAR_RADIUS,l.LUNAR_RADIUS,l.LUNAR_RADIUS)),Kt.j=Kt.WGS84,Object.defineProperties(Kt,{default:{get:function(){return Kt.j},set:function(t){r.typeOf.object("value",t),Kt.j=t,m.o=t.radiiSquared,Wt.O=t.oneOverRadii,Wt.R=t.oneOverRadiiSquared,Wt.P=t.S}}}),Kt.prototype.clone=function(t){return Kt.clone(this,t)},Kt.packedLength=m.packedLength,Kt.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),m.pack(t.m,n,e),n},Kt.unpack=function(t,n,e){r.defined("array",t),n=o(n,0);const i=m.unpack(t,n);return Kt.fromCartesian3(i,e)},Kt.prototype.geocentricSurfaceNormal=m.normalize,Kt.prototype.geodeticSurfaceNormalCartographic=function(t,e){r.typeOf.object("cartographic",t);const i=t.longitude,o=t.latitude,u=Math.cos(o),s=u*Math.cos(i),c=u*Math.sin(i),a=Math.sin(o);return n(e)||(e=new m),e.x=s,e.y=c,e.z=a,m.normalize(e,e)},Kt.prototype.geodeticSurfaceNormal=function(t,i){if(r.typeOf.object("cartesian",t),isNaN(t.x)||isNaN(t.y)||isNaN(t.z))throw new e("cartesian has a NaN component");if(!m.equalsEpsilon(t,m.ZERO,l.EPSILON14))return n(i)||(i=new m),i=m.multiplyComponents(t,this.k,i),m.normalize(i,i)};const tn=new m,nn=new m;Kt.prototype.cartographicToCartesian=function(t,e){const r=tn,i=nn;this.geodeticSurfaceNormalCartographic(t,r),m.multiplyComponents(this.v,r,i);const o=Math.sqrt(m.dot(r,i));return m.divideByScalar(i,o,i),m.multiplyByScalar(r,t.height,r),n(e)||(e=new m),m.add(i,r,e)},Kt.prototype.cartographicArrayToCartesianArray=function(t,e){r.defined("cartographics",t);const i=t.length;n(e)?e.length=i:e=new Array(i);for(let n=0;n<i;n++)e[n]=this.cartographicToCartesian(t[n],e[n]);return e};const en=new m,rn=new m,on=new m;Kt.prototype.cartesianToCartographic=function(t,e){const r=this.scaleToGeodeticSurface(t,rn);if(!n(r))return;const i=this.geodeticSurfaceNormal(r,en),o=m.subtract(t,r,on),u=Math.atan2(i.y,i.x),s=Math.asin(i.z),c=l.sign(m.dot(o,t))*m.magnitude(o);return n(e)?(e.longitude=u,e.latitude=s,e.height=c,e):new Wt(u,s,c)},Kt.prototype.cartesianArrayToCartographicArray=function(t,e){r.defined("cartesians",t);const i=t.length;n(e)?e.length=i:e=new Array(i);for(let n=0;n<i;++n)e[n]=this.cartesianToCartographic(t[n],e[n]);return e},Kt.prototype.scaleToGeodeticSurface=function(t,n){return Zt(t,this.A,this.k,this.S,n)},Kt.prototype.scaleToGeocentricSurface=function(t,e){r.typeOf.object("cartesian",t),n(e)||(e=new m);const i=t.x,o=t.y,u=t.z,s=this.k,c=1/Math.sqrt(i*i*s.x+o*o*s.y+u*u*s.z);return m.multiplyByScalar(t,c,e)},Kt.prototype.transformPositionToScaledSpace=function(t,e){return n(e)||(e=new m),m.multiplyComponents(t,this.A,e)},Kt.prototype.transformPositionFromScaledSpace=function(t,e){return n(e)||(e=new m),m.multiplyComponents(t,this.m,e)},Kt.prototype.equals=function(t){return this===t||n(t)&&m.equals(this.m,t.m)},Kt.prototype.toString=function(){return this.m.toString()},Kt.prototype.getSurfaceNormalIntersectionWithZAxis=function(t,i,u){if(r.typeOf.object("position",t),!l.equalsEpsilon(this.m.x,this.m.y,l.EPSILON15))throw new e("Ellipsoid must be an ellipsoid of revolution (radii.x == radii.y)");r.typeOf.number.greaterThan("Ellipsoid.radii.z",this.m.z,0),i=o(i,0);const s=this.I;if(n(u)||(u=new m),u.x=0,u.y=0,u.z=t.z*(1-s),!(Math.abs(u.z)>=this.m.z-i))return u};const un=new m;Kt.prototype.getLocalCurvature=function(t,e){r.typeOf.object("surfacePosition",t),n(e)||(e=new Ct);const i=this.getSurfaceNormalIntersectionWithZAxis(t,0,un),o=m.distance(t,i),u=o*(this.minimumRadius*o/this.maximumRadius**2)**2;return Ct.fromElements(1/o,1/u,e)};const sn=[.14887433898163,.43339539412925,.67940956829902,.86506336668898,.97390652851717,0],cn=[.29552422471475,.26926671930999,.21908636251598,.14945134915058,.066671344308684,0];function an(t,n,e){r.typeOf.number("a",t),r.typeOf.number("b",n),r.typeOf.func("func",e);const i=.5*(n+t),o=.5*(n-t);let u=0;for(let t=0;t<5;t++){const n=o*sn[t];u+=cn[t]*(e(i+n)+e(i-n))}return u*=o,u}function fn(t,n,e){r.defined("array",t),r.defined("itemToFind",n),r.defined("comparator",e);let i,o,u=0,s=t.length-1;for(;u<=s;)if(i=~~((u+s)/2),o=e(t[i],n),o<0)u=i+1;else{if(!(o>0))return i;s=i-1}return~(s+1)}function hn(t,n,e,r,i){this.xPoleWander=t,this.yPoleWander=n,this.xPoleOffset=e,this.yPoleOffset=r,this.ut1MinusUtc=i}function ln(t){if(null===t||isNaN(t))throw new e("year is required and must be a number.");return t%4==0&&t%100!=0||t%400==0}Kt.prototype.surfaceArea=function(t){r.typeOf.object("rectangle",t);const n=t.west;let e=t.east;const i=t.south,o=t.north;for(;e<n;)e+=l.TWO_PI;const u=this.v,s=u.x,c=u.y,a=u.z,f=s*c;return an(i,o,(function(t){const r=Math.cos(t),i=Math.sin(t);return Math.cos(t)*an(n,e,(function(t){const n=Math.cos(t),e=Math.sin(t);return Math.sqrt(f*i*i+a*(c*n*n+s*e*e)*r*r)}))}))};const dn=[31,28,31,30,31,30,31,31,30,31,30,31];function wn(t,n,i,u,s,c,a,f){t=o(t,1),n=o(n,1),i=o(i,1),u=o(u,0),s=o(s,0),c=o(c,0),a=o(a,0),f=o(f,!1),r.typeOf.number.greaterThanOrEquals("Year",t,1),r.typeOf.number.lessThanOrEquals("Year",t,9999),r.typeOf.number.greaterThanOrEquals("Month",n,1),r.typeOf.number.lessThanOrEquals("Month",n,12),r.typeOf.number.greaterThanOrEquals("Day",i,1),r.typeOf.number.lessThanOrEquals("Day",i,31),r.typeOf.number.greaterThanOrEquals("Hour",u,0),r.typeOf.number.lessThanOrEquals("Hour",u,23),r.typeOf.number.greaterThanOrEquals("Minute",s,0),r.typeOf.number.lessThanOrEquals("Minute",s,59),r.typeOf.bool("IsLeapSecond",f),r.typeOf.number.greaterThanOrEquals("Second",c,0),r.typeOf.number.lessThanOrEquals("Second",c,f?60:59),r.typeOf.number.greaterThanOrEquals("Millisecond",a,0),r.typeOf.number.lessThan("Millisecond",a,1e3),function(){const r=2===n&&ln(t)?dn[n-1]+1:dn[n-1];if(i>r)throw new e("Month and Day represents invalid date")}(),this.year=t,this.month=n,this.day=i,this.hour=u,this.minute=s,this.second=c,this.millisecond=a,this.isLeapSecond=f}function mn(t,n){this.julianDate=t,this.offset=n}var gn=Object.freeze({SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,MINUTES_PER_HOUR:60,HOURS_PER_DAY:24,SECONDS_PER_HOUR:3600,MINUTES_PER_DAY:1440,SECONDS_PER_DAY:86400,DAYS_PER_JULIAN_CENTURY:36525,PICOSECOND:1e-9,MODIFIED_JULIAN_DATE_DIFFERENCE:2400000.5}),vn=Object.freeze({UTC:0,TAI:1});const pn=new wn,yn=[31,28,31,30,31,30,31,31,30,31,30,31];function bn(t,n){return Un.compare(t.julianDate,n.julianDate)}const Mn=new mn;function An(t){Mn.julianDate=t;const n=Un.leapSeconds;let e=fn(n,Mn,bn);e<0&&(e=~e),e>=n.length&&(e=n.length-1);let r=n[e].offset;e>0&&Un.secondsDifference(n[e].julianDate,t)>r&&(e--,r=n[e].offset),Un.addSeconds(t,r,t)}function xn(t,n){Mn.julianDate=t;const e=Un.leapSeconds;let r=fn(e,Mn,bn);if(r<0&&(r=~r),0===r)return Un.addSeconds(t,-e[0].offset,n);if(r>=e.length)return Un.addSeconds(t,-e[r-1].offset,n);const i=Un.secondsDifference(e[r].julianDate,t);return 0===i?Un.addSeconds(t,-e[r].offset,n):i<=1?void 0:Un.addSeconds(t,-e[--r].offset,n)}function En(t,n,e){const r=n/gn.SECONDS_PER_DAY|0;return t+=r,(n-=gn.SECONDS_PER_DAY*r)<0&&(t--,n+=gn.SECONDS_PER_DAY),e.dayNumber=t,e.secondsOfDay=n,e}function kn(t,n,e,r,i,o,u){const s=(n-14)/12|0,c=t+4800+s;let a=(1461*c/4|0)+(367*(n-2-12*s)/12|0)-(3*((c+100)/100|0)/4|0)+e-32075;(r-=12)<0&&(r+=24);const f=o+(r*gn.SECONDS_PER_HOUR+i*gn.SECONDS_PER_MINUTE+u*gn.SECONDS_PER_MILLISECOND);return f>=43200&&(a-=1),[a,f]}const qn=/^(\\d{4})$/,$n=/^(\\d{4})-(\\d{2})$/,Sn=/^(\\d{4})-?(\\d{3})$/,In=/^(\\d{4})-?W(\\d{2})-?(\\d{1})?$/,On=/^(\\d{4})-?(\\d{2})-?(\\d{2})$/,Rn=/([Z+\\-])?(\\d{2})?:?(\\d{2})?$/,Pn=/^(\\d{2})(\\.\\d+)?/.source+Rn.source,jn=/^(\\d{2}):?(\\d{2})(\\.\\d+)?/.source+Rn.source,Fn=/^(\\d{2}):?(\\d{2}):?(\\d{2})(\\.\\d+)?/.source+Rn.source,Nn="Invalid ISO 8601 date.";function Un(t,n,e){this.dayNumber=void 0,this.secondsOfDay=void 0,t=o(t,0),n=o(n,0),e=o(e,vn.UTC);const r=0|t;En(r,n+=(t-r)*gn.SECONDS_PER_DAY,this),e===vn.UTC&&An(this)}Un.fromGregorianDate=function(t,r){if(!(t instanceof wn))throw new e("date must be a valid GregorianDate.");const i=kn(t.year,t.month,t.day,t.hour,t.minute,t.second,t.millisecond);return n(r)?(En(i[0],i[1],r),An(r),r):new Un(i[0],i[1],vn.UTC)},Un.fromDate=function(t,r){if(!(t instanceof Date)||isNaN(t.getTime()))throw new e("date must be a valid JavaScript Date.");const i=kn(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.getUTCMilliseconds());return n(r)?(En(i[0],i[1],r),An(r),r):new Un(i[0],i[1],vn.UTC)},Un.fromIso8601=function(t,r){if("string"!=typeof t)throw new e(Nn);let i,o=(t=t.replace(",",".")).split("T"),u=1,s=1,c=0,a=0,f=0,h=0;const l=o[0],d=o[1];let w,m,g,v;if(!n(l))throw new e(Nn);if(o=l.match(On),null!==o){if(g=l.split("-").length-1,g>0&&2!==g)throw new e(Nn);i=+o[1],u=+o[2],s=+o[3]}else if(o=l.match($n),null!==o)i=+o[1],u=+o[2];else if(o=l.match(qn),null!==o)i=+o[1];else{let t;if(o=l.match(Sn),null!==o){if(i=+o[1],t=+o[2],m=ln(i),t<1||m&&t>366||!m&&t>365)throw new e(Nn)}else{if(o=l.match(In),null===o)throw new e(Nn);{i=+o[1];const r=+o[2],u=+o[3]||0;if(g=l.split("-").length-1,g>0&&(!n(o[3])&&1!==g||n(o[3])&&2!==g))throw new e(Nn);t=7*r+u-new Date(Date.UTC(i,0,4)).getUTCDay()-3}}w=new Date(Date.UTC(i,0,1)),w.setUTCDate(t),u=w.getUTCMonth()+1,s=w.getUTCDate()}if(m=ln(i),u<1||u>12||s<1||(2!==u||!m)&&s>yn[u-1]||m&&2===u&&s>29)throw new e(Nn);if(n(d)){if(o=d.match(Fn),null!==o){if(g=d.split(":").length-1,g>0&&2!==g&&3!==g)throw new e(Nn);c=+o[1],a=+o[2],f=+o[3],h=1e3*+(o[4]||0),v=5}else if(o=d.match(jn),null!==o){if(g=d.split(":").length-1,g>2)throw new e(Nn);c=+o[1],a=+o[2],f=60*+(o[3]||0),v=4}else{if(o=d.match(Pn),null===o)throw new e(Nn);c=+o[1],a=60*+(o[2]||0),v=3}if(a>=60||f>=61||c>24||24===c&&(a>0||f>0||h>0))throw new e(Nn);const t=o[v],n=+o[v+1],r=+(o[v+2]||0);switch(t){case"+":c-=n,a-=r;break;case"-":c+=n,a+=r;break;case"Z":break;default:a+=new Date(Date.UTC(i,u-1,s,c,a)).getTimezoneOffset()}}const p=60===f;for(p&&f--;a>=60;)a-=60,c++;for(;c>=24;)c-=24,s++;for(w=m&&2===u?29:yn[u-1];s>w;)s-=w,u++,u>12&&(u-=12,i++),w=m&&2===u?29:yn[u-1];for(;a<0;)a+=60,c--;for(;c<0;)c+=24,s--;for(;s<1;)u--,u<1&&(u+=12,i--),w=m&&2===u?29:yn[u-1],s+=w;const y=kn(i,u,s,c,a,f,h);return n(r)?(En(y[0],y[1],r),An(r)):r=new Un(y[0],y[1],vn.UTC),p&&Un.addSeconds(r,1,r),r},Un.now=function(t){return Un.fromDate(new Date,t)};const Tn=new Un(0,0,vn.TAI);Un.toGregorianDate=function(t,r){if(!n(t))throw new e("julianDate is required.");let i=!1,o=xn(t,Tn);n(o)||(Un.addSeconds(t,-1,Tn),o=xn(Tn,Tn),i=!0);let u=o.dayNumber;const s=o.secondsOfDay;s>=43200&&(u+=1);let c=u+68569|0;const a=4*c/146097|0;c=c-((146097*a+3)/4|0)|0;const f=4e3*(c+1)/1461001|0;c=c-(1461*f/4|0)+31|0;const h=80*c/2447|0,l=c-(2447*h/80|0)|0;c=h/11|0;const d=h+2-12*c|0,w=100*(a-49)+f+c|0;let m=s/gn.SECONDS_PER_HOUR|0,g=s-m*gn.SECONDS_PER_HOUR;const v=g/gn.SECONDS_PER_MINUTE|0;g-=v*gn.SECONDS_PER_MINUTE;let p=0|g;const y=(g-p)/gn.SECONDS_PER_MILLISECOND;return m+=12,m>23&&(m-=24),i&&(p+=1),n(r)?(r.year=w,r.month=d,r.day=l,r.hour=m,r.minute=v,r.second=p,r.millisecond=y,r.isLeapSecond=i,r):new wn(w,d,l,m,v,p,y,i)},Un.toDate=function(t){if(!n(t))throw new e("julianDate is required.");const r=Un.toGregorianDate(t,pn);let i=r.second;return r.isLeapSecond&&(i-=1),new Date(Date.UTC(r.year,r.month-1,r.day,r.hour,r.minute,i,r.millisecond))},Un.toIso8601=function(t,r){if(!n(t))throw new e("julianDate is required.");const i=Un.toGregorianDate(t,pn);let o=i.year,u=i.month,s=i.day,c=i.hour;const a=i.minute,f=i.second,h=i.millisecond;let l;if(1e4===o&&1===u&&1===s&&0===c&&0===a&&0===f&&0===h&&(o=9999,u=12,s=31,c=24),!n(r)&&0!==h){const t=.01*h;return l=t<1e-6?t.toFixed(20).replace(".","").replace(/0+$/,""):t.toString().replace(".",""),`${o.toString().padStart(4,"0")}-${u.toString().padStart(2,"0")}-${s.toString().padStart(2,"0")}T${c.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}.${l}Z`}return n(r)&&0!==r?(l=(.01*h).toFixed(r).replace(".","").slice(0,r),`${o.toString().padStart(4,"0")}-${u.toString().padStart(2,"0")}-${s.toString().padStart(2,"0")}T${c.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}.${l}Z`):`${o.toString().padStart(4,"0")}-${u.toString().padStart(2,"0")}-${s.toString().padStart(2,"0")}T${c.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}Z`},Un.clone=function(t,e){if(n(t))return n(e)?(e.dayNumber=t.dayNumber,e.secondsOfDay=t.secondsOfDay,e):new Un(t.dayNumber,t.secondsOfDay,vn.TAI)},Un.compare=function(t,r){if(!n(t))throw new e("left is required.");if(!n(r))throw new e("right is required.");const i=t.dayNumber-r.dayNumber;return 0!==i?i:t.secondsOfDay-r.secondsOfDay},Un.equals=function(t,e){return t===e||n(t)&&n(e)&&t.dayNumber===e.dayNumber&&t.secondsOfDay===e.secondsOfDay},Un.equalsEpsilon=function(t,e,r){return r=o(r,0),t===e||n(t)&&n(e)&&Math.abs(Un.secondsDifference(t,e))<=r},Un.totalDays=function(t){if(!n(t))throw new e("julianDate is required.");return t.dayNumber+t.secondsOfDay/gn.SECONDS_PER_DAY},Un.secondsDifference=function(t,r){if(!n(t))throw new e("left is required.");if(!n(r))throw new e("right is required.");return(t.dayNumber-r.dayNumber)*gn.SECONDS_PER_DAY+(t.secondsOfDay-r.secondsOfDay)},Un.daysDifference=function(t,r){if(!n(t))throw new e("left is required.");if(!n(r))throw new e("right is required.");return t.dayNumber-r.dayNumber+(t.secondsOfDay-r.secondsOfDay)/gn.SECONDS_PER_DAY},Un.computeTaiMinusUtc=function(t){Mn.julianDate=t;const n=Un.leapSeconds;let e=fn(n,Mn,bn);return e<0&&(e=~e,--e,e<0&&(e=0)),n[e].offset},Un.addSeconds=function(t,r,i){if(!n(t))throw new e("julianDate is required.");if(!n(r))throw new e("seconds is required.");if(!n(i))throw new e("result is required.");return En(t.dayNumber,t.secondsOfDay+r,i)},Un.addMinutes=function(t,r,i){if(!n(t))throw new e("julianDate is required.");if(!n(r))throw new e("minutes is required.");if(!n(i))throw new e("result is required.");const o=t.secondsOfDay+r*gn.SECONDS_PER_MINUTE;return En(t.dayNumber,o,i)},Un.addHours=function(t,r,i){if(!n(t))throw new e("julianDate is required.");if(!n(r))throw new e("hours is required.");if(!n(i))throw new e("result is required.");const o=t.secondsOfDay+r*gn.SECONDS_PER_HOUR;return En(t.dayNumber,o,i)},Un.addDays=function(t,r,i){if(!n(t))throw new e("julianDate is required.");if(!n(r))throw new e("days is required.");if(!n(i))throw new e("result is required.");return En(t.dayNumber+r,t.secondsOfDay,i)},Un.lessThan=function(t,n){return Un.compare(t,n)<0},Un.lessThanOrEquals=function(t,n){return Un.compare(t,n)<=0},Un.greaterThan=function(t,n){return Un.compare(t,n)>0},Un.greaterThanOrEquals=function(t,n){return Un.compare(t,n)>=0},Un.prototype.clone=function(t){return Un.clone(this,t)},Un.prototype.equals=function(t){return Un.equals(this,t)},Un.prototype.equalsEpsilon=function(t,n){return Un.equalsEpsilon(this,t,n)},Un.prototype.toString=function(){return Un.toIso8601(this)},Un.leapSeconds=[new mn(new Un(2441317,43210,vn.TAI),10),new mn(new Un(2441499,43211,vn.TAI),11),new mn(new Un(2441683,43212,vn.TAI),12),new mn(new Un(2442048,43213,vn.TAI),13),new mn(new Un(2442413,43214,vn.TAI),14),new mn(new Un(2442778,43215,vn.TAI),15),new mn(new Un(2443144,43216,vn.TAI),16),new mn(new Un(2443509,43217,vn.TAI),17),new mn(new Un(2443874,43218,vn.TAI),18),new mn(new Un(2444239,43219,vn.TAI),19),new mn(new Un(2444786,43220,vn.TAI),20),new mn(new Un(2445151,43221,vn.TAI),21),new mn(new Un(2445516,43222,vn.TAI),22),new mn(new Un(2446247,43223,vn.TAI),23),new mn(new Un(2447161,43224,vn.TAI),24),new mn(new Un(2447892,43225,vn.TAI),25),new mn(new Un(2448257,43226,vn.TAI),26),new mn(new Un(2448804,43227,vn.TAI),27),new mn(new Un(2449169,43228,vn.TAI),28),new mn(new Un(2449534,43229,vn.TAI),29),new mn(new Un(2450083,43230,vn.TAI),30),new mn(new Un(2450630,43231,vn.TAI),31),new mn(new Un(2451179,43232,vn.TAI),32),new mn(new Un(2453736,43233,vn.TAI),33),new mn(new Un(2454832,43234,vn.TAI),34),new mn(new Un(2456109,43235,vn.TAI),35),new mn(new Un(2457204,43236,vn.TAI),36),new mn(new Un(2457754,43237,vn.TAI),37)];var zn,Cn,Dn,Bn,Ln,_n,Vn,Hn={exports:{}},Yn={exports:{}},Zn=Yn.exports,Wn={exports:{}},Qn=Wn.exports,Jn={exports:{}},Gn=Jn.exports,Xn=(Bn||(Bn=1,_n=Hn.exports,Vn=function(t,n,e,r){var i=r&&r.URI;function o(t,n){var e=arguments.length>=1;if(!(this instanceof o))return e?arguments.length>=2?new o(t,n):new o(t):new o;if(void 0===t){if(e)throw new TypeError("undefined is not a valid argument for URI");t="undefined"!=typeof location?location.href+"":""}if(null===t&&e)throw new TypeError("null is not a valid argument for URI");return this.href(t),void 0!==n?this.absoluteTo(n):this}o.version="1.19.11";var u=o.prototype,s={}.hasOwnProperty;function c(t){return t.replace(/([.*+?^=!:${}()|[\\]\\/\\\\])/g,"\\\\$1")}function a(t){return void 0===t?"Undefined":String({}.toString.call(t)).slice(8,-1)}function f(t){return"Array"===a(t)}function h(t,n){var e,r,i={};if("RegExp"===a(n))i=null;else if(f(n))for(e=0,r=n.length;e<r;e++)i[n[e]]=!0;else i[n]=!0;for(e=0,r=t.length;e<r;e++)(i&&void 0!==i[t[e]]||!i&&n.test(t[e]))&&(t.splice(e,1),r--,e--);return t}function l(t,n){var e,r;if(f(n)){for(e=0,r=n.length;e<r;e++)if(!l(t,n[e]))return!1;return!0}var i=a(n);for(e=0,r=t.length;e<r;e++)if("RegExp"===i){if("string"==typeof t[e]&&t[e].match(n))return!0}else if(t[e]===n)return!0;return!1}function d(t,n){if(!f(t)||!f(n))return!1;if(t.length!==n.length)return!1;t.sort(),n.sort();for(var e=0,r=t.length;e<r;e++)if(t[e]!==n[e])return!1;return!0}function w(t){return t.replace(/^\\/+|\\/+$/g,"")}function m(t){return escape(t)}function g(t){return encodeURIComponent(t).replace(/[!\'()*]/g,m).replace(/\\*/g,"%2A")}o.F=function(){return{protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null,preventInvalidHostname:o.preventInvalidHostname,duplicateQueryParameters:o.duplicateQueryParameters,escapeQuerySpace:o.escapeQuerySpace}},o.preventInvalidHostname=!1,o.duplicateQueryParameters=!1,o.escapeQuerySpace=!0,o.protocol_expression=/^[a-z][a-z0-9.+-]*$/i,o.idn_expression=/[^a-z0-9\\._-]/i,o.punycode_expression=/(xn--)/i,o.ip4_expression=/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/,o.ip6_expression=/^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$/,o.find_uri_expression=/\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:\'".,<>?]))/gi,o.findUri={start:/\\b(?:([a-z][a-z0-9.+-]*:\\/\\/)|www\\.)/gi,end:/[\\s\\r\\n]|$/,trim:/[`!()\\[\\]{};:\'".,<>?]+$/,parens:/(\\([^\\)]*\\)|\\[[^\\]]*\\]|\\{[^}]*\\}|<[^>]*>)/g},o.leading_whitespace_expression=/^[\\x00-\\x20\\u00a0\\u1680\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]+/,o.ascii_tab_whitespace=/[\\u0009\\u000A\\u000D]+/g,o.defaultPorts={http:"80",https:"443",ftp:"21",gopher:"70",ws:"80",wss:"443"},o.hostProtocols=["http","https"],o.invalid_hostname_characters=/[^a-zA-Z0-9\\.\\-:_]/,o.domAttributes={a:"href",blockquote:"cite",link:"href",base:"href",script:"src",form:"action",img:"src",area:"href",iframe:"src",embed:"src",source:"src",track:"src",input:"src",audio:"src",video:"src"},o.getDomAttribute=function(t){if(t&&t.nodeName){var n=t.nodeName.toLowerCase();if("input"!==n||"image"===t.type)return o.domAttributes[n]}},o.encode=g,o.decode=decodeURIComponent,o.iso8859=function(){o.encode=escape,o.decode=unescape},o.unicode=function(){o.encode=g,o.decode=decodeURIComponent},o.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/gi,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\\/\\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}},reserved:{encode:{expression:/%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/gi,map:{"%3A":":","%2F":"/","%3F":"?","%23":"#","%5B":"[","%5D":"]","%40":"@","%21":"!","%24":"$","%26":"&","%27":"\'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"="}}},urnpath:{encode:{expression:/%(21|24|27|28|29|2A|2B|2C|3B|3D|40)/gi,map:{"%21":"!","%24":"$","%27":"\'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"=","%40":"@"}},decode:{expression:/[\\/\\?#:]/g,map:{"/":"%2F","?":"%3F","#":"%23",":":"%3A"}}}},o.encodeQuery=function(t,n){var e=o.encode(t+"");return void 0===n&&(n=o.escapeQuerySpace),n?e.replace(/%20/g,"+"):e},o.decodeQuery=function(t,n){t+="",void 0===n&&(n=o.escapeQuerySpace);try{return o.decode(n?t.replace(/\\+/g,"%20"):t)}catch(n){return t}};var v,p={encode:"encode",decode:"decode"},y=function(t,n){return function(e){try{return o[n](e+"").replace(o.characters[t][n].expression,(function(e){return o.characters[t][n].map[e]}))}catch(t){return e}}};for(v in p)o[v+"PathSegment"]=y("pathname",p[v]),o[v+"UrnPathSegment"]=y("urnpath",p[v]);var b=function(t,n,e){return function(r){var i;i=e?function(t){return o[n](o[e](t))}:o[n];for(var u=(r+"").split(t),s=0,c=u.length;s<c;s++)u[s]=i(u[s]);return u.join(t)}};function M(t){return function(n,e){return void 0===n?this.F[t]||"":(this.F[t]=n||null,this.build(!e),this)}}function A(t,n){return function(e,r){return void 0===e?this.F[t]||"":(null!==e&&(e+="").charAt(0)===n&&(e=e.substring(1)),this.F[t]=e,this.build(!r),this)}}o.decodePath=b("/","decodePathSegment"),o.decodeUrnPath=b(":","decodeUrnPathSegment"),o.recodePath=b("/","encodePathSegment","decode"),o.recodeUrnPath=b(":","encodeUrnPathSegment","decode"),o.encodeReserved=y("reserved","encode"),o.parse=function(t,n){var e;return n||(n={preventInvalidHostname:o.preventInvalidHostname}),(e=(t=(t=t.replace(o.leading_whitespace_expression,"")).replace(o.ascii_tab_whitespace,"")).indexOf("#"))>-1&&(n.fragment=t.substring(e+1)||null,t=t.substring(0,e)),(e=t.indexOf("?"))>-1&&(n.query=t.substring(e+1)||null,t=t.substring(0,e)),"//"===(t=(t=t.replace(/^(https?|ftp|wss?)?:+[/\\\\]*/i,"$1://")).replace(/^[/\\\\]{2,}/i,"//")).substring(0,2)?(n.protocol=null,t=t.substring(2),t=o.parseAuthority(t,n)):(e=t.indexOf(":"))>-1&&(n.protocol=t.substring(0,e)||null,n.protocol&&!n.protocol.match(o.protocol_expression)?n.protocol=void 0:"//"===t.substring(e+1,e+3).replace(/\\\\/g,"/")?(t=t.substring(e+3),t=o.parseAuthority(t,n)):(t=t.substring(e+1),n.urn=!0)),n.path=t,n},o.parseHost=function(t,n){t||(t="");var e,r,i=(t=t.replace(/\\\\/g,"/")).indexOf("/");if(-1===i&&(i=t.length),"["===t.charAt(0))e=t.indexOf("]"),n.hostname=t.substring(1,e)||null,n.port=t.substring(e+2,i)||null,"/"===n.port&&(n.port=null);else{var u=t.indexOf(":"),s=t.indexOf("/"),c=t.indexOf(":",u+1);-1!==c&&(-1===s||c<s)?(n.hostname=t.substring(0,i)||null,n.port=null):(r=t.substring(0,i).split(":"),n.hostname=r[0]||null,n.port=r[1]||null)}return n.hostname&&"/"!==t.substring(i).charAt(0)&&(i++,t="/"+t),n.preventInvalidHostname&&o.ensureValidHostname(n.hostname,n.protocol),n.port&&o.ensureValidPort(n.port),t.substring(i)||"/"},o.parseAuthority=function(t,n){return t=o.parseUserinfo(t,n),o.parseHost(t,n)},o.parseUserinfo=function(t,n){var e=t;-1!==t.indexOf("\\\\")&&(t=t.replace(/\\\\/g,"/"));var r,i=t.indexOf("/"),u=t.lastIndexOf("@",i>-1?i:t.length-1);return u>-1&&(-1===i||u<i)?(r=t.substring(0,u).split(":"),n.username=r[0]?o.decode(r[0]):null,r.shift(),n.password=r[0]?o.decode(r.join(":")):null,t=e.substring(u+1)):(n.username=null,n.password=null),t},o.parseQuery=function(t,n){if(!t)return{};if(!(t=t.replace(/&+/g,"&").replace(/^\\?*&*|&+$/g,"")))return{};for(var e,r,i,u={},c=t.split("&"),a=c.length,f=0;f<a;f++)e=c[f].split("="),r=o.decodeQuery(e.shift(),n),i=e.length?o.decodeQuery(e.join("="),n):null,"__proto__"!==r&&(s.call(u,r)?("string"!=typeof u[r]&&null!==u[r]||(u[r]=[u[r]]),u[r].push(i)):u[r]=i);return u},o.build=function(t){var n="",e=!1;return t.protocol&&(n+=t.protocol+":"),t.urn||!n&&!t.hostname||(n+="//",e=!0),n+=o.buildAuthority(t)||"","string"==typeof t.path&&("/"!==t.path.charAt(0)&&e&&(n+="/"),n+=t.path),"string"==typeof t.query&&t.query&&(n+="?"+t.query),"string"==typeof t.fragment&&t.fragment&&(n+="#"+t.fragment),n},o.buildHost=function(t){var n="";return t.hostname?(o.ip6_expression.test(t.hostname)?n+="["+t.hostname+"]":n+=t.hostname,t.port&&(n+=":"+t.port),n):""},o.buildAuthority=function(t){return o.buildUserinfo(t)+o.buildHost(t)},o.buildUserinfo=function(t){var n="";return t.username&&(n+=o.encode(t.username)),t.password&&(n+=":"+o.encode(t.password)),n&&(n+="@"),n},o.buildQuery=function(t,n,e){var r,i,u,c,a="";for(i in t)if("__proto__"!==i&&s.call(t,i))if(f(t[i]))for(r={},u=0,c=t[i].length;u<c;u++)void 0!==t[i][u]&&void 0===r[t[i][u]+""]&&(a+="&"+o.buildQueryParameter(i,t[i][u],e),!0!==n&&(r[t[i][u]+""]=!0));else void 0!==t[i]&&(a+="&"+o.buildQueryParameter(i,t[i],e));return a.substring(1)},o.buildQueryParameter=function(t,n,e){return o.encodeQuery(t,e)+(null!==n?"="+o.encodeQuery(n,e):"")},o.addQuery=function(t,n,e){if("object"==typeof n)for(var r in n)s.call(n,r)&&o.addQuery(t,r,n[r]);else{if("string"!=typeof n)throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");if(void 0===t[n])return void(t[n]=e);"string"==typeof t[n]&&(t[n]=[t[n]]),f(e)||(e=[e]),t[n]=(t[n]||[]).concat(e)}},o.setQuery=function(t,n,e){if("object"==typeof n)for(var r in n)s.call(n,r)&&o.setQuery(t,r,n[r]);else{if("string"!=typeof n)throw new TypeError("URI.setQuery() accepts an object, string as the name parameter");t[n]=void 0===e?null:e}},o.removeQuery=function(t,n,e){var r,i,u;if(f(n))for(r=0,i=n.length;r<i;r++)t[n[r]]=void 0;else if("RegExp"===a(n))for(u in t)n.test(u)&&(t[u]=void 0);else if("object"==typeof n)for(u in n)s.call(n,u)&&o.removeQuery(t,u,n[u]);else{if("string"!=typeof n)throw new TypeError("URI.removeQuery() accepts an object, string, RegExp as the first parameter");void 0!==e?"RegExp"===a(e)?!f(t[n])&&e.test(t[n])?t[n]=void 0:t[n]=h(t[n],e):t[n]!==String(e)||f(e)&&1!==e.length?f(t[n])&&(t[n]=h(t[n],e)):t[n]=void 0:t[n]=void 0}},o.hasQuery=function(t,n,e,r){switch(a(n)){case"String":break;case"RegExp":for(var i in t)if(s.call(t,i)&&n.test(i)&&(void 0===e||o.hasQuery(t,i,e)))return!0;return!1;case"Object":for(var u in n)if(s.call(n,u)&&!o.hasQuery(t,u,n[u]))return!1;return!0;default:throw new TypeError("URI.hasQuery() accepts a string, regular expression or object as the name parameter")}switch(a(e)){case"Undefined":return n in t;case"Boolean":return e===Boolean(f(t[n])?t[n].length:t[n]);case"Function":return!!e(t[n],n,t);case"Array":return!!f(t[n])&&(r?l:d)(t[n],e);case"RegExp":return f(t[n])?!!r&&l(t[n],e):Boolean(t[n]&&t[n].match(e));case"Number":e=String(e);case"String":return f(t[n])?!!r&&l(t[n],e):t[n]===e;default:throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter")}},o.joinPaths=function(){for(var t=[],n=[],e=0,r=0;r<arguments.length;r++){var i=new o(arguments[r]);t.push(i);for(var u=i.segment(),s=0;s<u.length;s++)"string"==typeof u[s]&&n.push(u[s]),u[s]&&e++}if(!n.length||!e)return new o("");var c=new o("").segment(n);return""!==t[0].path()&&"/"!==t[0].path().slice(0,1)||c.path("/"+c.path()),c.normalize()},o.commonPath=function(t,n){var e,r=Math.min(t.length,n.length);for(e=0;e<r;e++)if(t.charAt(e)!==n.charAt(e)){e--;break}return e<1?t.charAt(0)===n.charAt(0)&&"/"===t.charAt(0)?"/":"":("/"===t.charAt(e)&&"/"===n.charAt(e)||(e=t.substring(0,e).lastIndexOf("/")),t.substring(0,e+1))},o.withinString=function(t,n,e){e||(e={});var r=e.start||o.findUri.start,i=e.end||o.findUri.end,u=e.trim||o.findUri.trim,s=e.parens||o.findUri.parens,c=/[a-z0-9-]=["\']?$/i;for(r.lastIndex=0;;){var a=r.exec(t);if(!a)break;var f=a.index;if(e.ignoreHtml){var h=t.slice(Math.max(f-3,0),f);if(h&&c.test(h))continue}for(var l=f+t.slice(f).search(i),d=t.slice(f,l),w=-1;;){var m=s.exec(d);if(!m)break;var g=m.index+m[0].length;w=Math.max(w,g)}if(!((d=w>-1?d.slice(0,w)+d.slice(w).replace(u,""):d.replace(u,"")).length<=a[0].length||e.ignore&&e.ignore.test(d))){var v=n(d,f,l=f+d.length,t);void 0!==v?(v=String(v),t=t.slice(0,f)+v+t.slice(l),r.lastIndex=f+v.length):r.lastIndex=l}}return r.lastIndex=0,t},o.ensureValidHostname=function(n,e){var r=!!n,i=!1;if(!!e&&(i=l(o.hostProtocols,e)),i&&!r)throw new TypeError("Hostname cannot be empty, if protocol is "+e);if(n&&n.match(o.invalid_hostname_characters)){if(!t)throw new TypeError(\'Hostname "\'+n+\'" contains characters other than [A-Z0-9.-:_] and Punycode.js is not available\');if(t.toASCII(n).match(o.invalid_hostname_characters))throw new TypeError(\'Hostname "\'+n+\'" contains characters other than [A-Z0-9.-:_]\')}},o.ensureValidPort=function(t){if(t){var n=Number(t);if(!(/^[0-9]+$/.test(n)&&n>0&&n<65536))throw new TypeError(\'Port "\'+t+\'" is not a valid port\')}},o.noConflict=function(t){if(t){var n={URI:this.noConflict()};return r.URITemplate&&"function"==typeof r.URITemplate.noConflict&&(n.URITemplate=r.URITemplate.noConflict()),r.IPv6&&"function"==typeof r.IPv6.noConflict&&(n.IPv6=r.IPv6.noConflict()),r.SecondLevelDomains&&"function"==typeof r.SecondLevelDomains.noConflict&&(n.SecondLevelDomains=r.SecondLevelDomains.noConflict()),n}return r.URI===this&&(r.URI=i),this},u.build=function(t){return!0===t?this.U=!0:(void 0===t||this.U)&&(this.T=o.build(this.F),this.U=!1),this},u.clone=function(){return new o(this)},u.valueOf=u.toString=function(){return this.build(!1).T},u.protocol=M("protocol"),u.username=M("username"),u.password=M("password"),u.hostname=M("hostname"),u.port=M("port"),u.query=A("query","?"),u.fragment=A("fragment","#"),u.search=function(t,n){var e=this.query(t,n);return"string"==typeof e&&e.length?"?"+e:e},u.hash=function(t,n){var e=this.fragment(t,n);return"string"==typeof e&&e.length?"#"+e:e},u.pathname=function(t,n){if(void 0===t||!0===t){var e=this.F.path||(this.F.hostname?"/":"");return t?(this.F.urn?o.decodeUrnPath:o.decodePath)(e):e}return this.F.urn?this.F.path=t?o.recodeUrnPath(t):"":this.F.path=t?o.recodePath(t):"/",this.build(!n),this},u.path=u.pathname,u.href=function(t,n){var e;if(void 0===t)return this.toString();this.T="",this.F=o.F();var r=t instanceof o,i="object"==typeof t&&(t.hostname||t.path||t.pathname);if(t.nodeName&&(t=t[o.getDomAttribute(t)]||"",i=!1),!r&&i&&void 0!==t.pathname&&(t=t.toString()),"string"==typeof t||t instanceof String)this.F=o.parse(String(t),this.F);else{if(!r&&!i)throw new TypeError("invalid input");var u=r?t.F:t;for(e in u)"query"!==e&&s.call(this.F,e)&&(this.F[e]=u[e]);u.query&&this.query(u.query,!1)}return this.build(!n),this},u.is=function(t){var n=!1,r=!1,i=!1,u=!1,s=!1,c=!1,a=!1,f=!this.F.urn;switch(this.F.hostname&&(f=!1,r=o.ip4_expression.test(this.F.hostname),i=o.ip6_expression.test(this.F.hostname),s=(u=!(n=r||i))&&e&&e.has(this.F.hostname),c=u&&o.idn_expression.test(this.F.hostname),a=u&&o.punycode_expression.test(this.F.hostname)),t.toLowerCase()){case"relative":return f;case"absolute":return!f;case"domain":case"name":return u;case"sld":return s;case"ip":return n;case"ip4":case"ipv4":case"inet4":return r;case"ip6":case"ipv6":case"inet6":return i;case"idn":return c;case"url":return!this.F.urn;case"urn":return!!this.F.urn;case"punycode":return a}return null};var x=u.protocol,E=u.port,k=u.hostname;u.protocol=function(t,n){if(t&&!(t=t.replace(/:(\\/\\/)?$/,"")).match(o.protocol_expression))throw new TypeError(\'Protocol "\'+t+"\\" contains characters other than [A-Z0-9.+-] or doesn\'t start with [A-Z]");return x.call(this,t,n)},u.scheme=u.protocol,u.port=function(t,n){return this.F.urn?void 0===t?"":this:(void 0!==t&&(0===t&&(t=null),t&&(":"===(t+="").charAt(0)&&(t=t.substring(1)),o.ensureValidPort(t))),E.call(this,t,n))},u.hostname=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0!==t){var e={preventInvalidHostname:this.F.preventInvalidHostname};if("/"!==o.parseHost(t,e))throw new TypeError(\'Hostname "\'+t+\'" contains characters other than [A-Z0-9.-]\');t=e.hostname,this.F.preventInvalidHostname&&o.ensureValidHostname(t,this.F.protocol)}return k.call(this,t,n)},u.origin=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t){var e=this.protocol();return this.authority()?(e?e+"://":"")+this.authority():""}var r=o(t);return this.protocol(r.protocol()).authority(r.authority()).build(!n),this},u.host=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t)return this.F.hostname?o.buildHost(this.F):"";if("/"!==o.parseHost(t,this.F))throw new TypeError(\'Hostname "\'+t+\'" contains characters other than [A-Z0-9.-]\');return this.build(!n),this},u.authority=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t)return this.F.hostname?o.buildAuthority(this.F):"";if("/"!==o.parseAuthority(t,this.F))throw new TypeError(\'Hostname "\'+t+\'" contains characters other than [A-Z0-9.-]\');return this.build(!n),this},u.userinfo=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t){var e=o.buildUserinfo(this.F);return e?e.substring(0,e.length-1):e}return"@"!==t[t.length-1]&&(t+="@"),o.parseUserinfo(t,this.F),this.build(!n),this},u.resource=function(t,n){var e;return void 0===t?this.path()+this.search()+this.hash():(e=o.parse(t),this.F.path=e.path,this.F.query=e.query,this.F.fragment=e.fragment,this.build(!n),this)},u.subdomain=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t){if(!this.F.hostname||this.is("IP"))return"";var e=this.F.hostname.length-this.domain().length-1;return this.F.hostname.substring(0,e)||""}var r=this.F.hostname.length-this.domain().length,i=this.F.hostname.substring(0,r),u=new RegExp("^"+c(i));if(t&&"."!==t.charAt(t.length-1)&&(t+="."),-1!==t.indexOf(":"))throw new TypeError("Domains cannot contain colons");return t&&o.ensureValidHostname(t,this.F.protocol),this.F.hostname=this.F.hostname.replace(u,t),this.build(!n),this},u.domain=function(t,n){if(this.F.urn)return void 0===t?"":this;if("boolean"==typeof t&&(n=t,t=void 0),void 0===t){if(!this.F.hostname||this.is("IP"))return"";var e=this.F.hostname.match(/\\./g);if(e&&e.length<2)return this.F.hostname;var r=this.F.hostname.length-this.tld(n).length-1;return r=this.F.hostname.lastIndexOf(".",r-1)+1,this.F.hostname.substring(r)||""}if(!t)throw new TypeError("cannot set domain empty");if(-1!==t.indexOf(":"))throw new TypeError("Domains cannot contain colons");if(o.ensureValidHostname(t,this.F.protocol),!this.F.hostname||this.is("IP"))this.F.hostname=t;else{var i=new RegExp(c(this.domain())+"$");this.F.hostname=this.F.hostname.replace(i,t)}return this.build(!n),this},u.tld=function(t,n){if(this.F.urn)return void 0===t?"":this;if("boolean"==typeof t&&(n=t,t=void 0),void 0===t){if(!this.F.hostname||this.is("IP"))return"";var r=this.F.hostname.lastIndexOf("."),i=this.F.hostname.substring(r+1);return!0!==n&&e&&e.list[i.toLowerCase()]&&e.get(this.F.hostname)||i}var o;if(!t)throw new TypeError("cannot set TLD empty");if(t.match(/[^a-zA-Z0-9-]/)){if(!e||!e.is(t))throw new TypeError(\'TLD "\'+t+\'" contains characters other than [A-Z0-9]\');o=new RegExp(c(this.tld())+"$"),this.F.hostname=this.F.hostname.replace(o,t)}else{if(!this.F.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");o=new RegExp(c(this.tld())+"$"),this.F.hostname=this.F.hostname.replace(o,t)}return this.build(!n),this},u.directory=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t||!0===t){if(!this.F.path&&!this.F.hostname)return"";if("/"===this.F.path)return"/";var e=this.F.path.length-this.filename().length-1,r=this.F.path.substring(0,e)||(this.F.hostname?"/":"");return t?o.decodePath(r):r}var i=this.F.path.length-this.filename().length,u=this.F.path.substring(0,i),s=new RegExp("^"+c(u));return this.is("relative")||(t||(t="/"),"/"!==t.charAt(0)&&(t="/"+t)),t&&"/"!==t.charAt(t.length-1)&&(t+="/"),t=o.recodePath(t),this.F.path=this.F.path.replace(s,t),this.build(!n),this},u.filename=function(t,n){if(this.F.urn)return void 0===t?"":this;if("string"!=typeof t){if(!this.F.path||"/"===this.F.path)return"";var e=this.F.path.lastIndexOf("/"),r=this.F.path.substring(e+1);return t?o.decodePathSegment(r):r}var i=!1;"/"===t.charAt(0)&&(t=t.substring(1)),t.match(/\\.?\\//)&&(i=!0);var u=new RegExp(c(this.filename())+"$");return t=o.recodePath(t),this.F.path=this.F.path.replace(u,t),i?this.normalizePath(n):this.build(!n),this},u.suffix=function(t,n){if(this.F.urn)return void 0===t?"":this;if(void 0===t||!0===t){if(!this.F.path||"/"===this.F.path)return"";var e,r,i=this.filename(),u=i.lastIndexOf(".");return-1===u?"":(e=i.substring(u+1),r=/^[a-z0-9%]+$/i.test(e)?e:"",t?o.decodePathSegment(r):r)}"."===t.charAt(0)&&(t=t.substring(1));var s,a=this.suffix();if(a)s=t?new RegExp(c(a)+"$"):new RegExp(c("."+a)+"$");else{if(!t)return this;this.F.path+="."+o.recodePath(t)}return s&&(t=o.recodePath(t),this.F.path=this.F.path.replace(s,t)),this.build(!n),this},u.segment=function(t,n,e){var r=this.F.urn?":":"/",i=this.path(),o="/"===i.substring(0,1),u=i.split(r);if(void 0!==t&&"number"!=typeof t&&(e=n,n=t,t=void 0),void 0!==t&&"number"!=typeof t)throw new Error(\'Bad segment "\'+t+\'", must be 0-based integer\');if(o&&u.shift(),t<0&&(t=Math.max(u.length+t,0)),void 0===n)return void 0===t?u:u[t];if(null===t||void 0===u[t])if(f(n)){u=[];for(var s=0,c=n.length;s<c;s++)(n[s].length||u.length&&u[u.length-1].length)&&(u.length&&!u[u.length-1].length&&u.pop(),u.push(w(n[s])))}else(n||"string"==typeof n)&&(n=w(n),""===u[u.length-1]?u[u.length-1]=n:u.push(n));else n?u[t]=w(n):u.splice(t,1);return o&&u.unshift(""),this.path(u.join(r),e)},u.segmentCoded=function(t,n,e){var r,i,u;if("number"!=typeof t&&(e=n,n=t,t=void 0),void 0===n){if(f(r=this.segment(t,n,e)))for(i=0,u=r.length;i<u;i++)r[i]=o.decode(r[i]);else r=void 0!==r?o.decode(r):void 0;return r}if(f(n))for(i=0,u=n.length;i<u;i++)n[i]=o.encode(n[i]);else n="string"==typeof n||n instanceof String?o.encode(n):n;return this.segment(t,n,e)};var q=u.query;return u.query=function(t,n){if(!0===t)return o.parseQuery(this.F.query,this.F.escapeQuerySpace);if("function"==typeof t){var e=o.parseQuery(this.F.query,this.F.escapeQuerySpace),r=t.call(this,e);return this.F.query=o.buildQuery(r||e,this.F.duplicateQueryParameters,this.F.escapeQuerySpace),this.build(!n),this}return void 0!==t&&"string"!=typeof t?(this.F.query=o.buildQuery(t,this.F.duplicateQueryParameters,this.F.escapeQuerySpace),this.build(!n),this):q.call(this,t,n)},u.setQuery=function(t,n,e){var r=o.parseQuery(this.F.query,this.F.escapeQuerySpace);if("string"==typeof t||t instanceof String)r[t]=void 0!==n?n:null;else{if("object"!=typeof t)throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");for(var i in t)s.call(t,i)&&(r[i]=t[i])}return this.F.query=o.buildQuery(r,this.F.duplicateQueryParameters,this.F.escapeQuerySpace),"string"!=typeof t&&(e=n),this.build(!e),this},u.addQuery=function(t,n,e){var r=o.parseQuery(this.F.query,this.F.escapeQuerySpace);return o.addQuery(r,t,void 0===n?null:n),this.F.query=o.buildQuery(r,this.F.duplicateQueryParameters,this.F.escapeQuerySpace),"string"!=typeof t&&(e=n),this.build(!e),this},u.removeQuery=function(t,n,e){var r=o.parseQuery(this.F.query,this.F.escapeQuerySpace);return o.removeQuery(r,t,n),this.F.query=o.buildQuery(r,this.F.duplicateQueryParameters,this.F.escapeQuerySpace),"string"!=typeof t&&(e=n),this.build(!e),this},u.hasQuery=function(t,n,e){var r=o.parseQuery(this.F.query,this.F.escapeQuerySpace);return o.hasQuery(r,t,n,e)},u.setSearch=u.setQuery,u.addSearch=u.addQuery,u.removeSearch=u.removeQuery,u.hasSearch=u.hasQuery,u.normalize=function(){return this.F.urn?this.normalizeProtocol(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},u.normalizeProtocol=function(t){return"string"==typeof this.F.protocol&&(this.F.protocol=this.F.protocol.toLowerCase(),this.build(!t)),this},u.normalizeHostname=function(e){return this.F.hostname&&(this.is("IDN")&&t?this.F.hostname=t.toASCII(this.F.hostname):this.is("IPv6")&&n&&(this.F.hostname=n.best(this.F.hostname)),this.F.hostname=this.F.hostname.toLowerCase(),this.build(!e)),this},u.normalizePort=function(t){return"string"==typeof this.F.protocol&&this.F.port===o.defaultPorts[this.F.protocol]&&(this.F.port=null,this.build(!t)),this},u.normalizePath=function(t){var n,e=this.F.path;if(!e)return this;if(this.F.urn)return this.F.path=o.recodeUrnPath(this.F.path),this.build(!t),this;if("/"===this.F.path)return this;var r,i,u="";for("/"!==(e=o.recodePath(e)).charAt(0)&&(n=!0,e="/"+e),"/.."!==e.slice(-3)&&"/."!==e.slice(-2)||(e+="/"),e=e.replace(/(\\/(\\.\\/)+)|(\\/\\.$)/g,"/").replace(/\\/{2,}/g,"/"),n&&(u=e.substring(1).match(/^(\\.\\.\\/)+/)||"")&&(u=u[0]);-1!==(r=e.search(/\\/\\.\\.(\\/|$)/));)0!==r?(-1===(i=e.substring(0,r).lastIndexOf("/"))&&(i=r),e=e.substring(0,i)+e.substring(r+3)):e=e.substring(3);return n&&this.is("relative")&&(e=u+e.substring(1)),this.F.path=e,this.build(!t),this},u.normalizePathname=u.normalizePath,u.normalizeQuery=function(t){return"string"==typeof this.F.query&&(this.F.query.length?this.query(o.parseQuery(this.F.query,this.F.escapeQuerySpace)):this.F.query=null,this.build(!t)),this},u.normalizeFragment=function(t){return this.F.fragment||(this.F.fragment=null,this.build(!t)),this},u.normalizeSearch=u.normalizeQuery,u.normalizeHash=u.normalizeFragment,u.iso8859=function(){var t=o.encode,n=o.decode;o.encode=escape,o.decode=decodeURIComponent;try{this.normalize()}finally{o.encode=t,o.decode=n}return this},u.unicode=function(){var t=o.encode,n=o.decode;o.encode=g,o.decode=unescape;try{this.normalize()}finally{o.encode=t,o.decode=n}return this},u.readable=function(){var n=this.clone();n.username("").password("").normalize();var e="";if(n.F.protocol&&(e+=n.F.protocol+"://"),n.F.hostname&&(n.is("punycode")&&t?(e+=t.toUnicode(n.F.hostname),n.F.port&&(e+=":"+n.F.port)):e+=n.host()),n.F.hostname&&n.F.path&&"/"!==n.F.path.charAt(0)&&(e+="/"),e+=n.path(!0),n.F.query){for(var r="",i=0,u=n.F.query.split("&"),s=u.length;i<s;i++){var c=(u[i]||"").split("=");r+="&"+o.decodeQuery(c[0],this.F.escapeQuerySpace).replace(/&/g,"%26"),void 0!==c[1]&&(r+="="+o.decodeQuery(c[1],this.F.escapeQuerySpace).replace(/&/g,"%26"))}e+="?"+r.substring(1)}return e+o.decodeQuery(n.hash(),!0)},u.absoluteTo=function(t){var n,e,r,i=this.clone(),u=["protocol","username","password","hostname","port"];if(this.F.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(t instanceof o||(t=new o(t)),i.F.protocol)return i;if(i.F.protocol=t.F.protocol,this.F.hostname)return i;for(e=0;r=u[e];e++)i.F[r]=t.F[r];return i.F.path?(".."===i.F.path.substring(-2)&&(i.F.path+="/"),"/"!==i.path().charAt(0)&&(n=(n=t.directory())||(0===t.path().indexOf("/")?"/":""),i.F.path=(n?n+"/":"")+i.F.path,i.normalizePath())):(i.F.path=t.F.path,i.F.query||(i.F.query=t.F.query)),i.build(),i},u.relativeTo=function(t){var n,e,r,i,u,s=this.clone().normalize();if(s.F.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(t=new o(t).normalize(),n=s.F,e=t.F,i=s.path(),u=t.path(),"/"!==i.charAt(0))throw new Error("URI is already relative");if("/"!==u.charAt(0))throw new Error("Cannot calculate a URI relative to another relative URI");if(n.protocol===e.protocol&&(n.protocol=null),n.username!==e.username||n.password!==e.password)return s.build();if(null!==n.protocol||null!==n.username||null!==n.password)return s.build();if(n.hostname!==e.hostname||n.port!==e.port)return s.build();if(n.hostname=null,n.port=null,i===u)return n.path="",s.build();if(!(r=o.commonPath(i,u)))return s.build();var c=e.path.substring(r.length).replace(/[^\\/]*$/,"").replace(/.*?\\//g,"../");return n.path=c+n.path.substring(r.length)||"./",s.build()},u.equals=function(t){var n,e,r,i,u,c=this.clone(),a=new o(t),h={};if(c.normalize(),a.normalize(),c.toString()===a.toString())return!0;if(r=c.query(),i=a.query(),c.query(""),a.query(""),c.toString()!==a.toString())return!1;if(r.length!==i.length)return!1;for(u in n=o.parseQuery(r,this.F.escapeQuerySpace),e=o.parseQuery(i,this.F.escapeQuerySpace),n)if(s.call(n,u)){if(f(n[u])){if(!d(n[u],e[u]))return!1}else if(n[u]!==e[u])return!1;h[u]=!0}for(u in e)if(s.call(e,u)&&!h[u])return!1;return!0},u.preventInvalidHostname=function(t){return this.F.preventInvalidHostname=!!t,this},u.duplicateQueryParameters=function(t){return this.F.duplicateQueryParameters=!!t,this},u.escapeQuerySpace=function(t){return this.F.escapeQuerySpace=!!t,this},o},(Ln=Hn).exports?Ln.exports=Vn(function(){return zn||(zn=1,t=Yn,n=Yn.exports,function(e){var r=n&&!n.nodeType&&n,i=!t.nodeType&&t,o="object"==typeof c&&c;o.global!==o&&o.window!==o&&o.self!==o||(e=o);var u,s,a=2147483647,f=36,h=/^xn--/,l=/[^\\x20-\\x7E]/,d={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},w=Math.floor,m=String.fromCharCode;function g(t){throw new RangeError(d[t])}function v(t,n){for(var e=t.length,r=[];e--;)r[e]=n(t[e]);return r}function p(t,n){var e=t.split("@"),r="";return e.length>1&&(r=e[0]+"@",t=e[1]),r+v((t=t.replace(/[\\x2E\\u3002\\uFF0E\\uFF61]/g,".")).split("."),n).join(".")}function y(t){for(var n,e,r=[],i=0,o=t.length;i<o;)(n=t.charCodeAt(i++))>=55296&&n<=56319&&i<o?56320==(64512&(e=t.charCodeAt(i++)))?r.push(((1023&n)<<10)+(1023&e)+65536):(r.push(n),i--):r.push(n);return r}function b(t){return v(t,(function(t){var n="";return t>65535&&(n+=m((t-=65536)>>>10&1023|55296),t=56320|1023&t),n+m(t)})).join("")}function M(t,n){return t+22+75*(t<26)-((0!=n)<<5)}function A(t,n,e){var r=0;for(t=e?w(t/700):t>>1,t+=w(t/n);t>455;r+=f)t=w(t/35);return w(r+36*t/(t+38))}function x(t){var n,e,r,i,o,u,s,c,h,l,d,m=[],v=t.length,p=0,y=128,M=72;for((e=t.lastIndexOf("-"))<0&&(e=0),r=0;r<e;++r)t.charCodeAt(r)>=128&&g("not-basic"),m.push(t.charCodeAt(r));for(i=e>0?e+1:0;i<v;){for(o=p,u=1,s=f;i>=v&&g("invalid-input"),((c=(d=t.charCodeAt(i++))-48<10?d-22:d-65<26?d-65:d-97<26?d-97:f)>=f||c>w((a-p)/u))&&g("overflow"),p+=c*u,!(c<(h=s<=M?1:s>=M+26?26:s-M));s+=f)u>w(a/(l=f-h))&&g("overflow"),u*=l;M=A(p-o,n=m.length+1,0==o),w(p/n)>a-y&&g("overflow"),y+=w(p/n),p%=n,m.splice(p++,0,y)}return b(m)}function E(t){var n,e,r,i,o,u,s,c,h,l,d,v,p,b,x,E=[];for(v=(t=y(t)).length,n=128,e=0,o=72,u=0;u<v;++u)(d=t[u])<128&&E.push(m(d));for(r=i=E.length,i&&E.push("-");r<v;){for(s=a,u=0;u<v;++u)(d=t[u])>=n&&d<s&&(s=d);for(s-n>w((a-e)/(p=r+1))&&g("overflow"),e+=(s-n)*p,n=s,u=0;u<v;++u)if((d=t[u])<n&&++e>a&&g("overflow"),d==n){for(c=e,h=f;!(c<(l=h<=o?1:h>=o+26?26:h-o));h+=f)x=c-l,b=f-l,E.push(m(M(l+x%b,0))),c=w(x/b);E.push(m(M(c,0))),o=A(e,p,r==i),e=0,++r}++e,++n}return E.join("")}if(u={version:"1.3.2",ucs2:{decode:y,encode:b},decode:x,encode:E,toASCII:function(t){return p(t,(function(t){return l.test(t)?"xn--"+E(t):t}))},toUnicode:function(t){return p(t,(function(t){return h.test(t)?x(t.slice(4).toLowerCase()):t}))}},r&&i)if(t.exports==r)i.exports=u;else for(s in u)u.hasOwnProperty(s)&&(r[s]=u[s]);else e.punycode=u}(Zn)),Yn.exports;var t,n}(),function(){return Cn||(Cn=1,n=Qn,e=function(t){var n=t&&t.IPv6;return{best:function(t){var n,e,r=t.toLowerCase().split(":"),i=r.length,o=8;for(""===r[0]&&""===r[1]&&""===r[2]?(r.shift(),r.shift()):""===r[0]&&""===r[1]?r.shift():""===r[i-1]&&""===r[i-2]&&r.pop(),-1!==r[(i=r.length)-1].indexOf(".")&&(o=7),n=0;n<i&&""!==r[n];n++);if(n<o)for(r.splice(n,1,"0000");r.length<o;)r.splice(n,0,"0000");for(var u=0;u<o;u++){e=r[u].split("");for(var s=0;s<3&&"0"===e[0]&&e.length>1;s++)e.splice(0,1);r[u]=e.join("")}var c=-1,a=0,f=0,h=-1,l=!1;for(u=0;u<o;u++)l?"0"===r[u]?f+=1:(l=!1,f>a&&(c=h,a=f)):"0"===r[u]&&(l=!0,h=u,f=1);f>a&&(c=h,a=f),a>1&&r.splice(c,a,""),i=r.length;var d="";for(""===r[0]&&(d=":"),u=0;u<i&&(d+=r[u],u!==i-1);u++)d+=":";return""===r[i-1]&&(d+=":"),d},noConflict:function(){return t.IPv6===this&&(t.IPv6=n),this}}},(t=Wn).exports?t.exports=e():n.IPv6=e(n)),Wn.exports;var t,n,e}(),function(){return Dn||(Dn=1,n=Gn,e=function(t){var n=t&&t.SecondLevelDomains,e={list:{ac:" com gov mil net org ",ae:" ac co gov mil name net org pro sch ",af:" com edu gov net org ",al:" com edu gov mil net org ",ao:" co ed gv it og pb ",ar:" com edu gob gov int mil net org tur ",at:" ac co gv or ",au:" asn com csiro edu gov id net org ",ba:" co com edu gov mil net org rs unbi unmo unsa untz unze ",bb:" biz co com edu gov info net org store tv ",bh:" biz cc com edu gov info net org ",bn:" com edu gov net org ",bo:" com edu gob gov int mil net org tv ",br:" adm adv agr am arq art ato b bio blog bmd cim cng cnt com coop ecn edu eng esp etc eti far flog fm fnd fot fst g12 ggf gov imb ind inf jor jus lel mat med mil mus net nom not ntr odo org ppg pro psc psi qsl rec slg srv tmp trd tur tv vet vlog wiki zlg ",bs:" com edu gov net org ",bz:" du et om ov rg ",ca:" ab bc mb nb nf nl ns nt nu on pe qc sk yk ",ck:" biz co edu gen gov info net org ",cn:" ac ah bj com cq edu fj gd gov gs gx gz ha hb he hi hl hn jl js jx ln mil net nm nx org qh sc sd sh sn sx tj tw xj xz yn zj ",co:" com edu gov mil net nom org ",cr:" ac c co ed fi go or sa ",cy:" ac biz com ekloges gov ltd name net org parliament press pro tm ",do:" art com edu gob gov mil net org sld web ",dz:" art asso com edu gov net org pol ",ec:" com edu fin gov info med mil net org pro ",eg:" com edu eun gov mil name net org sci ",er:" com edu gov ind mil net org rochest w ",es:" com edu gob nom org ",et:" biz com edu gov info name net org ",fj:" ac biz com info mil name net org pro ",fk:" ac co gov net nom org ",fr:" asso com f gouv nom prd presse tm ",gg:" co net org ",gh:" com edu gov mil org ",gn:" ac com gov net org ",gr:" com edu gov mil net org ",gt:" com edu gob ind mil net org ",gu:" com edu gov net org ",hk:" com edu gov idv net org ",hu:" 2000 agrar bolt casino city co erotica erotika film forum games hotel info ingatlan jogasz konyvelo lakas media news org priv reklam sex shop sport suli szex tm tozsde utazas video ",id:" ac co go mil net or sch web ",il:" ac co gov idf k12 muni net org ",in:" ac co edu ernet firm gen gov i ind mil net nic org res ",iq:" com edu gov i mil net org ",ir:" ac co dnssec gov i id net org sch ",it:" edu gov ",je:" co net org ",jo:" com edu gov mil name net org sch ",jp:" ac ad co ed go gr lg ne or ",ke:" ac co go info me mobi ne or sc ",kh:" com edu gov mil net org per ",ki:" biz com de edu gov info mob net org tel ",km:" asso com coop edu gouv k medecin mil nom notaires pharmaciens presse tm veterinaire ",kn:" edu gov net org ",kr:" ac busan chungbuk chungnam co daegu daejeon es gangwon go gwangju gyeongbuk gyeonggi gyeongnam hs incheon jeju jeonbuk jeonnam k kg mil ms ne or pe re sc seoul ulsan ",kw:" com edu gov net org ",ky:" com edu gov net org ",kz:" com edu gov mil net org ",lb:" com edu gov net org ",lk:" assn com edu gov grp hotel int ltd net ngo org sch soc web ",lr:" com edu gov net org ",lv:" asn com conf edu gov id mil net org ",ly:" com edu gov id med net org plc sch ",ma:" ac co gov m net org press ",mc:" asso tm ",me:" ac co edu gov its net org priv ",mg:" com edu gov mil nom org prd tm ",mk:" com edu gov inf name net org pro ",ml:" com edu gov net org presse ",mn:" edu gov org ",mo:" com edu gov net org ",mt:" com edu gov net org ",mv:" aero biz com coop edu gov info int mil museum name net org pro ",mw:" ac co com coop edu gov int museum net org ",mx:" com edu gob net org ",my:" com edu gov mil name net org sch ",nf:" arts com firm info net other per rec store web ",ng:" biz com edu gov mil mobi name net org sch ",ni:" ac co com edu gob mil net nom org ",np:" com edu gov mil net org ",nr:" biz com edu gov info net org ",om:" ac biz co com edu gov med mil museum net org pro sch ",pe:" com edu gob mil net nom org sld ",ph:" com edu gov i mil net ngo org ",pk:" biz com edu fam gob gok gon gop gos gov net org web ",pl:" art bialystok biz com edu gda gdansk gorzow gov info katowice krakow lodz lublin mil net ngo olsztyn org poznan pwr radom slupsk szczecin torun warszawa waw wroc wroclaw zgora ",pr:" ac biz com edu est gov info isla name net org pro prof ",ps:" com edu gov net org plo sec ",pw:" belau co ed go ne or ",ro:" arts com firm info nom nt org rec store tm www ",rs:" ac co edu gov in org ",sb:" com edu gov net org ",sc:" com edu gov net org ",sh:" co com edu gov net nom org ",sl:" com edu gov net org ",st:" co com consulado edu embaixada gov mil net org principe saotome store ",sv:" com edu gob org red ",sz:" ac co org ",tr:" av bbs bel biz com dr edu gen gov info k12 name net org pol tel tsk tv web ",tt:" aero biz cat co com coop edu gov info int jobs mil mobi museum name net org pro tel travel ",tw:" club com ebiz edu game gov idv mil net org ",mu:" ac co com gov net or org ",mz:" ac co edu gov org ",na:" co com ",nz:" ac co cri geek gen govt health iwi maori mil net org parliament school ",pa:" abo ac com edu gob ing med net nom org sld ",pt:" com edu gov int net nome org publ ",py:" com edu gov mil net org ",qa:" com edu gov mil net org ",re:" asso com nom ",ru:" ac adygeya altai amur arkhangelsk astrakhan bashkiria belgorod bir bryansk buryatia cbg chel chelyabinsk chita chukotka chuvashia com dagestan e-burg edu gov grozny int irkutsk ivanovo izhevsk jar joshkar-ola kalmykia kaluga kamchatka karelia kazan kchr kemerovo khabarovsk khakassia khv kirov koenig komi kostroma kranoyarsk kuban kurgan kursk lipetsk magadan mari mari-el marine mil mordovia mosreg msk murmansk nalchik net nnov nov novosibirsk nsk omsk orenburg org oryol penza perm pp pskov ptz rnd ryazan sakhalin samara saratov simbirsk smolensk spb stavropol stv surgut tambov tatarstan tom tomsk tsaritsyn tsk tula tuva tver tyumen udm udmurtia ulan-ude vladikavkaz vladimir vladivostok volgograd vologda voronezh vrn vyatka yakutia yamal yekaterinburg yuzhno-sakhalinsk ",rw:" ac co com edu gouv gov int mil net ",sa:" com edu gov med net org pub sch ",sd:" com edu gov info med net org tv ",se:" a ac b bd c d e f g h i k l m n o org p parti pp press r s t tm u w x y z ",sg:" com edu gov idn net org per ",sn:" art com edu gouv org perso univ ",sy:" com edu gov mil net news org ",th:" ac co go in mi net or ",tj:" ac biz co com edu go gov info int mil name net nic org test web ",tn:" agrinet com defense edunet ens fin gov ind info intl mincom nat net org perso rnrt rns rnu tourism ",tz:" ac co go ne or ",ua:" biz cherkassy chernigov chernovtsy ck cn co com crimea cv dn dnepropetrovsk donetsk dp edu gov if in ivano-frankivsk kh kharkov kherson khmelnitskiy kiev kirovograd km kr ks kv lg lugansk lutsk lviv me mk net nikolaev od odessa org pl poltava pp rovno rv sebastopol sumy te ternopil uzhgorod vinnica vn zaporizhzhe zhitomir zp zt ",ug:" ac co go ne or org sc ",uk:" ac bl british-library co cym gov govt icnet jet lea ltd me mil mod national-library-scotland nel net nhs nic nls org orgn parliament plc police sch scot soc ",us:" dni fed isa kids nsn ",uy:" com edu gub mil net org ",ve:" co com edu gob info mil net org web ",vi:" co com k12 net org ",vn:" ac biz com edu gov health info int name net org pro ",ye:" co com gov ltd me net org plc ",yu:" ac co edu gov org ",za:" ac agric alt bourse city co cybernet db edu gov grondar iaccess imt inca landesign law mil net ngo nis nom olivetti org pix school tm web ",zm:" ac co com edu gov net org sch ",com:"ar br cn de eu gb gr hu jpn kr no qc ru sa se uk us uy za ",net:"gb jp se uk ",org:"ae",de:"com "},has:function(t){var n=t.lastIndexOf(".");if(n<=0||n>=t.length-1)return!1;var r=t.lastIndexOf(".",n-1);if(r<=0||r>=n-1)return!1;var i=e.list[t.slice(n+1)];return!!i&&i.indexOf(" "+t.slice(r+1,n)+" ")>=0},is:function(t){var n=t.lastIndexOf(".");if(n<=0||n>=t.length-1)return!1;if(t.lastIndexOf(".",n-1)>=0)return!1;var r=e.list[t.slice(n+1)];return!!r&&r.indexOf(" "+t.slice(0,n)+" ")>=0},get:function(t){var n=t.lastIndexOf(".");if(n<=0||n>=t.length-1)return null;var r=t.lastIndexOf(".",n-1);if(r<=0||r>=n-1)return null;var i=e.list[t.slice(n+1)];return i?i.indexOf(" "+t.slice(r+1,n)+" ")<0?null:t.slice(r+1):null},noConflict:function(){return t.SecondLevelDomains===this&&(t.SecondLevelDomains=n),this}};return e},(t=Jn).exports?t.exports=e():n.SecondLevelDomains=e(n)),Jn.exports;var t,n,e}()):_n.URI=Vn(_n.punycode,_n.IPv6,_n.SecondLevelDomains,_n)),Hn.exports),Kn=a(Xn);function te(t,n){if(null===t||"object"!=typeof t)return t;n=o(n,!1);const e=new t.constructor;for(const r in t)if(t.hasOwnProperty(r)){let i=t[r];n&&(i=te(i,n)),e[r]=i}return e}function ne(t,e,r){r=o(r,!1);const i={},u=n(t),s=n(e);let c,a,f;if(u)for(c in t)t.hasOwnProperty(c)&&(a=t[c],s&&r&&"object"==typeof a&&e.hasOwnProperty(c)?(f=e[c],i[c]="object"==typeof f?ne(a,f,r):a):i[c]=a);if(s)for(c in e)e.hasOwnProperty(c)&&!i.hasOwnProperty(c)&&(f=e[c],i[c]=f);return i}function ee(){let t,n;const e=new Promise((function(e,r){t=e,n=r}));return{resolve:t,reject:n,promise:e}}function re(t,n){let e;return"undefined"!=typeof document&&(e=document),re.C(t,n,e)}re.C=function(t,r,i){if(!n(t))throw new e("relative uri is required.");if(!n(r)){if(void 0===i)return t;r=o(i.baseURI,i.location.href)}const u=new Kn(t);return""!==u.scheme()?u.toString():u.absoluteTo(r).toString()};const ie={};function oe(t,e,r){n(e)||(e=t.width),n(r)||(r=t.height);let i=ie[e];n(i)||(i={},ie[e]=i);let o=i[r];if(!n(o)){const t=document.createElement("canvas");t.width=e,t.height=r,o=t.getContext("2d",{willReadFrequently:!0}),o.globalCompositeOperation="copy",i[r]=o}return o.drawImage(t,0,0,e,r),o.getImageData(0,0,e,r).data}const ue=/^blob:/i;function se(t){return r.typeOf.string("uri",t),ue.test(t)}let ce;const ae=/^data:/i;function fe(t){return r.typeOf.string("uri",t),ae.test(t)}var he=Object.freeze({UNISSUED:0,ISSUED:1,ACTIVE:2,RECEIVED:3,CANCELLED:4,FAILED:5}),le=Object.freeze({TERRAIN:0,IMAGERY:1,TILES3D:2,OTHER:3});function de(t){t=o(t,o.EMPTY_OBJECT);const n=o(t.throttleByServer,!1),e=o(t.throttle,!1);this.url=t.url,this.requestFunction=t.requestFunction,this.cancelFunction=t.cancelFunction,this.priorityFunction=t.priorityFunction,this.priority=o(t.priority,0),this.throttle=e,this.throttleByServer=n,this.type=o(t.type,le.OTHER),this.serverKey=t.serverKey,this.state=he.UNISSUED,this.deferred=void 0,this.cancelled=!1}function we(t,n,e){this.statusCode=t,this.response=n,this.responseHeaders=e,"string"==typeof this.responseHeaders&&(this.responseHeaders=function(t){const n={};if(!t)return n;const e=t.split("\\r\\n");for(let t=0;t<e.length;++t){const r=e[t],i=r.indexOf(": ");if(i>0){const t=r.substring(0,i),e=r.substring(i+2);n[t]=e}}return n}(this.responseHeaders))}function me(){this.D=[],this.B=[],this.L=[],this._=!1}function ge(t,n){return n-t}function ve(t){r.typeOf.object("options",t),r.defined("options.comparator",t.comparator),this.V=t.comparator,this.H=[],this.Y=0,this.Z=void 0}function pe(t,n,e){const r=t[n];t[n]=t[e],t[e]=r}de.prototype.cancel=function(){this.cancelled=!0},de.prototype.clone=function(t){return n(t)?(t.url=this.url,t.requestFunction=this.requestFunction,t.cancelFunction=this.cancelFunction,t.priorityFunction=this.priorityFunction,t.priority=this.priority,t.throttle=this.throttle,t.throttleByServer=this.throttleByServer,t.type=this.type,t.serverKey=this.serverKey,t.state=he.UNISSUED,t.deferred=void 0,t.cancelled=!1,t):new de(this)},we.prototype.toString=function(){let t="Request has failed.";return n(this.statusCode)&&(t+=` Status Code: ${this.statusCode}`),t},Object.defineProperties(me.prototype,{numberOfListeners:{get:function(){return this.D.length-this.L.length}}}),me.prototype.addEventListener=function(t,n){r.typeOf.func("listener",t),this.D.push(t),this.B.push(n);const e=this;return function(){e.removeEventListener(t,n)}},me.prototype.removeEventListener=function(t,n){r.typeOf.func("listener",t);const e=this.D,i=this.B;let o=-1;for(let r=0;r<e.length;r++)if(e[r]===t&&i[r]===n){o=r;break}return-1!==o&&(this._?(this.L.push(o),e[o]=void 0,i[o]=void 0):(e.splice(o,1),i.splice(o,1)),!0)},me.prototype.raiseEvent=function(){let t;this._=!0;const e=this.D,r=this.B;let i=e.length;for(t=0;t<i;t++)n(e[t])&&e[t].apply(r[t],arguments);const o=this.L;if(i=o.length,i>0){for(o.sort(ge),t=0;t<i;t++){const n=o[t];e.splice(n,1),r.splice(n,1)}o.length=0}this._=!1},Object.defineProperties(ve.prototype,{length:{get:function(){return this.Y}},internalArray:{get:function(){return this.H}},maximumLength:{get:function(){return this.Z},set:function(t){r.typeOf.number.greaterThanOrEquals("maximumLength",t,0);const n=this.Y;if(t<n){const e=this.H;for(let r=t;r<n;++r)e[r]=void 0;this.Y=t,e.length=t}this.Z=t}},comparator:{get:function(){return this.V}}}),ve.prototype.reserve=function(t){t=o(t,this.Y),this.H.length=t},ve.prototype.heapify=function(t){t=o(t,0);const n=this.Y,e=this.V,r=this.H;let i=-1,u=!0;for(;u;){const o=2*(t+1),s=o-1;i=s<n&&e(r[s],r[t])<0?s:t,o<n&&e(r[o],r[i])<0&&(i=o),i!==t?(pe(r,i,t),t=i):u=!1}},ve.prototype.resort=function(){const t=this.Y;for(let n=Math.ceil(t/2);n>=0;--n)this.heapify(n)},ve.prototype.insert=function(t){r.defined("element",t);const e=this.H,i=this.V,o=this.Z;let u,s=this.Y++;for(s<e.length?e[s]=t:e.push(t);0!==s;){const t=Math.floor((s-1)/2);if(!(i(e[s],e[t])<0))break;pe(e,s,t),s=t}return n(o)&&this.Y>o&&(u=e[o],this.Y=o),u},ve.prototype.pop=function(t){if(t=o(t,0),0===this.Y)return;r.typeOf.number.lessThan("index",t,this.Y);const n=this.H,e=n[t];return pe(n,t,--this.Y),this.heapify(t),n[this.Y]=void 0,e};const ye={numberOfAttemptedRequests:0,numberOfActiveRequests:0,numberOfCancelledRequests:0,numberOfCancelledActiveRequests:0,numberOfFailedRequests:0,numberOfActiveRequestsEver:0,lastNumberOfActiveRequests:0};let be=20;const Me=new ve({comparator:function(t,n){return t.priority-n.priority}});Me.maximumLength=be,Me.reserve(be);const Ae=[];let xe={};const Ee="undefined"!=typeof document?new Kn(document.location.href):new Kn,ke=new me;function qe(){}function $e(t){n(t.priorityFunction)&&(t.priority=t.priorityFunction())}function Se(t){return t.state===he.UNISSUED&&(t.state=he.ISSUED,t.deferred=ee()),t.deferred.promise}function Ie(t){const n=Se(t);return t.state=he.ACTIVE,Ae.push(t),++ye.numberOfActiveRequests,++ye.numberOfActiveRequestsEver,++xe[t.serverKey],t.requestFunction().then(function(t){return function(n){if(t.state===he.CANCELLED)return;const e=t.deferred;--ye.numberOfActiveRequests,--xe[t.serverKey],ke.raiseEvent(),t.state=he.RECEIVED,t.deferred=void 0,e.resolve(n)}}(t)).catch(function(t){return function(n){t.state!==he.CANCELLED&&(++ye.numberOfFailedRequests,--ye.numberOfActiveRequests,--xe[t.serverKey],ke.raiseEvent(n),t.state=he.FAILED,t.deferred.reject(n))}}(t)),n}function Oe(t){const e=t.state===he.ACTIVE;if(t.state=he.CANCELLED,++ye.numberOfCancelledRequests,n(t.deferred)){const n=t.deferred;t.deferred=void 0,n.reject()}e&&(--ye.numberOfActiveRequests,--xe[t.serverKey],++ye.numberOfCancelledActiveRequests),n(t.cancelFunction)&&t.cancelFunction()}qe.maximumRequests=50,qe.maximumRequestsPerServer=18,qe.requestsByServer={},qe.throttleRequests=!0,qe.debugShowStatistics=!1,qe.requestCompletedEvent=ke,Object.defineProperties(qe,{statistics:{get:function(){return ye}},priorityHeapLength:{get:function(){return be},set:function(t){if(t<be)for(;Me.length>t;)Oe(Me.pop());be=t,Me.maximumLength=t,Me.reserve(t)}}}),qe.serverHasOpenSlots=function(t,n){n=o(n,1);const e=o(qe.requestsByServer[t],qe.maximumRequestsPerServer);return xe[t]+n<=e},qe.heapHasOpenSlots=function(t){return Me.length+t<=be},qe.update=function(){let t,n,e=0;const r=Ae.length;for(t=0;t<r;++t)n=Ae[t],n.cancelled&&Oe(n),n.state===he.ACTIVE?e>0&&(Ae[t-e]=n):++e;Ae.length-=e;const i=Me.internalArray,o=Me.length;for(t=0;t<o;++t)$e(i[t]);Me.resort();const u=Math.max(qe.maximumRequests-Ae.length,0);let s=0;for(;s<u&&Me.length>0;)n=Me.pop(),n.cancelled?Oe(n):!n.throttleByServer||qe.serverHasOpenSlots(n.serverKey)?(Ie(n),++s):Oe(n);qe.debugShowStatistics&&(0===ye.numberOfActiveRequests&&ye.lastNumberOfActiveRequests>0&&(ye.numberOfAttemptedRequests>0&&(ye.numberOfAttemptedRequests=0),ye.numberOfCancelledRequests>0&&(ye.numberOfCancelledRequests=0),ye.numberOfCancelledActiveRequests>0&&(ye.numberOfCancelledActiveRequests=0),ye.numberOfFailedRequests>0&&(ye.numberOfFailedRequests=0)),ye.lastNumberOfActiveRequests=ye.numberOfActiveRequests)},qe.getServerKey=function(t){r.typeOf.string("url",t);let e=new Kn(t);""===e.scheme()&&(e=e.absoluteTo(Ee),e.normalize());let i=e.authority();return/:/.test(i)||(i=`${i}:${"https"===e.scheme()?"443":"80"}`),n(xe[i])||(xe[i]=0),i},qe.request=function(t){if(r.typeOf.object("request",t),r.typeOf.string("request.url",t.url),r.typeOf.func("request.requestFunction",t.requestFunction),fe(t.url)||se(t.url))return ke.raiseEvent(),t.state=he.RECEIVED,t.requestFunction();if(++ye.numberOfAttemptedRequests,n(t.serverKey)||(t.serverKey=qe.getServerKey(t.url)),qe.throttleRequests&&t.throttleByServer&&!qe.serverHasOpenSlots(t.serverKey))return;if(!qe.throttleRequests||!t.throttle)return Ie(t);if(Ae.length>=qe.maximumRequests)return;$e(t);const e=Me.insert(t);if(n(e)){if(e===t)return;Oe(e)}return Se(t)},qe.clearForSpecs=function(){for(;Me.length>0;)Oe(Me.pop());const t=Ae.length;for(let n=0;n<t;++n)Oe(Ae[n]);Ae.length=0,xe={},ye.numberOfAttemptedRequests=0,ye.numberOfActiveRequests=0,ye.numberOfCancelledRequests=0,ye.numberOfCancelledActiveRequests=0,ye.numberOfFailedRequests=0,ye.numberOfActiveRequestsEver=0,ye.lastNumberOfActiveRequests=0},qe.numberOfActiveRequestsByServer=function(t){return xe[t]},qe.requestHeap=Me;const Re={};let Pe={};Re.add=function(t,r){if(!n(t))throw new e("host is required.");if(!n(r)||r<=0)throw new e("port is required to be greater than 0.");const i=`${t.toLowerCase()}:${r}`;n(Pe[i])||(Pe[i]=!0)},Re.remove=function(t,r){if(!n(t))throw new e("host is required.");if(!n(r)||r<=0)throw new e("port is required to be greater than 0.");const i=`${t.toLowerCase()}:${r}`;n(Pe[i])&&delete Pe[i]},Re.contains=function(t){if(!n(t))throw new e("url is required.");const r=function(t){const n=new Kn(t);n.normalize();let e=n.authority();if(0!==e.length){if(n.authority(e),-1!==e.indexOf("@")){const t=e.split("@");e=t[1]}if(-1===e.indexOf(":")){let t=n.scheme();if(0===t.length&&(t=window.location.protocol,t=t.substring(0,t.length-1)),"http"===t)e+=":80";else{if("https"!==t)return;e+=":443"}}return e}}(t);return!(!n(r)||!n(Pe[r]))},Re.clear=function(){Pe={}};const je=function(){try{const t=new XMLHttpRequest;return t.open("GET","#",!0),t.responseType="blob","blob"===t.responseType}catch(t){return!1}}();function Fe(t){"string"==typeof(t=o(t,o.EMPTY_OBJECT))&&(t={url:t}),r.typeOf.string("options.url",t.url),this.W=void 0,this.J=Ne(t.templateValues,{}),this.G=Ne(t.queryParameters,{}),this.headers=Ne(t.headers,{}),this.request=o(t.request,new de),this.proxy=t.proxy,this.retryCallback=t.retryCallback,this.retryAttempts=o(t.retryAttempts,0),this.X=0,o(t.parseUrl,!0)?this.parseUrl(t.url,!0,!0):this.W=t.url,this.K=t.credits}function Ne(t,e){return n(t)?te(t):e}let Ue;function Te(t,e,r){if(!r)return ne(t,e);const i=te(t,!0);for(const t in e)if(e.hasOwnProperty(t)){let r=i[t];const o=e[t];n(r)?(Array.isArray(r)||(r=i[t]=[r]),i[t]=r.concat(o)):i[t]=Array.isArray(o)?o.slice():o}return i}function ze(t){const e=t.resource,r=t.flipY,i=t.skipColorSpaceConversion,o=t.preferImageBitmap,u=e.request;u.url=e.url,u.requestFunction=function(){let t=!1;e.isDataUri||e.isBlobUri||(t=e.isCrossOriginUrl);const n=ee();return Fe.nt.createImage(u,t,n,r,i,o),n.promise};const s=qe.request(u);if(n(s))return s.catch((function(t){return u.state!==he.FAILED?Promise.reject(t):e.retryOnError(t).then((function(n){return n?(u.state=he.UNISSUED,u.deferred=void 0,ze({resource:e,flipY:r,skipColorSpaceConversion:i,preferImageBitmap:o})):Promise.reject(t)}))}))}function Ce(t,e,r){const i={};i[e]=r,t.setQueryParameters(i);const o=t.request,u=t.url;o.url=u,o.requestFunction=function(){const t=ee();return window[r]=function(n){t.resolve(n);try{delete window[r]}catch(t){window[r]=void 0}},Fe.nt.loadAndExecuteScript(u,r,t),t.promise};const s=qe.request(o);if(n(s))return s.catch((function(n){return o.state!==he.FAILED?Promise.reject(n):t.retryOnError(n).then((function(i){return i?(o.state=he.UNISSUED,o.deferred=void 0,Ce(t,e,r)):Promise.reject(n)}))}))}function De(t){if(t.state===he.ISSUED||t.state===he.ACTIVE)throw new H("The Resource is already being fetched.");t.state=he.UNISSUED,t.deferred=void 0}Fe.createIfNeeded=function(t){return t instanceof Fe?t.getDerivedResource({request:t.request}):"string"!=typeof t?t:new Fe({url:t})},Fe.supportsImageBitmapOptions=function(){return n(Ue)?Ue:"function"!=typeof createImageBitmap?(Ue=Promise.resolve(!1),Ue):(Ue=Fe.fetchBlob({url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAABGdBTUEAAE4g3rEiDgAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAADElEQVQI12Ng6GAAAAEUAIngE3ZiAAAAAElFTkSuQmCC"}).then((function(t){return Promise.all([createImageBitmap(t,{imageOrientation:"flipY",premultiplyAlpha:"none",colorSpaceConversion:"none"}),createImageBitmap(t)])})).then((function(t){const n=oe(t[0]),e=oe(t[1]);return n[1]!==e[1]})).catch((function(){return!1})),Ue)},Object.defineProperties(Fe,{isBlobSupported:{get:function(){return je}}}),Object.defineProperties(Fe.prototype,{queryParameters:{get:function(){return this.G}},templateValues:{get:function(){return this.J}},url:{get:function(){return this.getUrlComponent(!0,!0)},set:function(t){this.parseUrl(t,!1,!1)}},extension:{get:function(){return function(t){if(!n(t))throw new e("uri is required.");const r=new Kn(t);r.normalize();let i=r.path(),o=i.lastIndexOf("/");return-1!==o&&(i=i.substr(o+1)),o=i.lastIndexOf("."),i=-1===o?"":i.substr(o+1),i}(this.W)}},isDataUri:{get:function(){return fe(this.W)}},isBlobUri:{get:function(){return se(this.W)}},isCrossOriginUrl:{get:function(){return function(t){n(ce)||(ce=document.createElement("a")),ce.href=window.location.href;const e=ce.host,r=ce.protocol;return ce.href=t,ce.href=ce.href,r!==ce.protocol||e!==ce.host}(this.W)}},hasHeaders:{get:function(){return Object.keys(this.headers).length>0}},credits:{get:function(){return this.K}}}),Fe.prototype.toString=function(){return this.getUrlComponent(!0,!0)},Fe.prototype.parseUrl=function(t,r,i,o){let u=new Kn(t);const s=0===(c=u.query()).length?{}:-1===c.indexOf("=")?{[c]:void 0}:function(t){if(!n(t))throw new e("queryString is required.");const r={};if(""===t)return r;const i=t.replace(/\\+/g,"%20").split(/[&;]/);for(let t=0,e=i.length;t<e;++t){const e=i[t].split("="),o=decodeURIComponent(e[0]);let u=e[1];u=n(u)?decodeURIComponent(u):"";const s=r[o];"string"==typeof s?r[o]=[s,u]:Array.isArray(s)?s.push(u):r[o]=u}return r}(c);var c;this.G=r?Te(s,this.queryParameters,i):s,u.search(""),u.fragment(""),n(o)&&""===u.scheme()&&(u=u.absoluteTo(re(o))),this.W=u.toString()},Fe.prototype.getUrlComponent=function(t,r){if(this.isDataUri)return this.W;let i=this.W;t&&(i=`${i}${function(t){const r=Object.keys(t);return 0===r.length?"":1!==r.length||n(t[r[0]])?`?${function(t){if(!n(t))throw new e("obj is required.");let r="";for(const n in t)if(t.hasOwnProperty(n)){const e=t[n],i=`${encodeURIComponent(n)}=`;if(Array.isArray(e))for(let t=0,n=e.length;t<n;++t)r+=`${i+encodeURIComponent(e[t])}&`;else r+=`${i+encodeURIComponent(e)}&`}return r=r.slice(0,-1),r}(t)}`:`?${r[0]}`}(this.queryParameters)}`),i=i.replace(/%7B/g,"{").replace(/%7D/g,"}");const o=this.J;return Object.keys(o).length>0&&(i=i.replace(/{(.*?)}/g,(function(t,e){const r=o[e];return n(r)?encodeURIComponent(r):t}))),r&&n(this.proxy)&&(i=this.proxy.getURL(i)),i},Fe.prototype.setQueryParameters=function(t,n){this.G=n?Te(this.G,t,!1):Te(t,this.G,!1)},Fe.prototype.appendQueryParameters=function(t){this.G=Te(t,this.G,!0)},Fe.prototype.setTemplateValues=function(t,n){this.J=n?ne(this.J,t):ne(t,this.J)},Fe.prototype.getDerivedResource=function(t){const e=this.clone();if(e.X=0,n(t.url)){const n=o(t.preserveQueryParameters,!1);e.parseUrl(t.url,!0,n,this.W)}return n(t.queryParameters)&&(e.G=ne(t.queryParameters,e.queryParameters)),n(t.templateValues)&&(e.J=ne(t.templateValues,e.templateValues)),n(t.headers)&&(e.headers=ne(t.headers,e.headers)),n(t.proxy)&&(e.proxy=t.proxy),n(t.request)&&(e.request=t.request),n(t.retryCallback)&&(e.retryCallback=t.retryCallback),n(t.retryAttempts)&&(e.retryAttempts=t.retryAttempts),e},Fe.prototype.retryOnError=function(t){const n=this.retryCallback;if("function"!=typeof n||this.X>=this.retryAttempts)return Promise.resolve(!1);const e=this;return Promise.resolve(n(this,t)).then((function(t){return++e.X,t}))},Fe.prototype.clone=function(t){return n(t)?(t.W=this.W,t.G=te(this.G),t.J=te(this.J),t.headers=te(this.headers),t.proxy=this.proxy,t.retryCallback=this.retryCallback,t.retryAttempts=this.retryAttempts,t.X=0,t.request=this.request.clone(),t):new Fe({url:this.W,queryParameters:this.queryParameters,templateValues:this.templateValues,headers:this.headers,proxy:this.proxy,retryCallback:this.retryCallback,retryAttempts:this.retryAttempts,request:this.request.clone(),parseUrl:!1,credits:n(this.credits)?this.credits.slice():void 0})},Fe.prototype.getBaseUri=function(t){return function(t,r){if(!n(t))throw new e("uri is required.");let i="";const o=t.lastIndexOf("/");return-1!==o&&(i=t.substring(0,o+1)),r?(0!==(t=new Kn(t)).query().length&&(i+=`?${t.query()}`),0!==t.fragment().length&&(i+=`#${t.fragment()}`),i):i}(this.getUrlComponent(t),t)},Fe.prototype.appendForwardSlash=function(){var t;this.W=(0!==(t=this.W).length&&"/"===t[t.length-1]||(t=`${t}/`),t)},Fe.prototype.fetchArrayBuffer=function(){return this.fetch({responseType:"arraybuffer"})},Fe.fetchArrayBuffer=function(t){return new Fe(t).fetchArrayBuffer()},Fe.prototype.fetchBlob=function(){return this.fetch({responseType:"blob"})},Fe.fetchBlob=function(t){return new Fe(t).fetchBlob()},Fe.prototype.fetchImage=function(t){t=o(t,o.EMPTY_OBJECT);const e=o(t.preferImageBitmap,!1),r=o(t.preferBlob,!1),i=o(t.flipY,!1),u=o(t.skipColorSpaceConversion,!1);if(De(this.request),!je||this.isDataUri||this.isBlobUri||!this.hasHeaders&&!r)return ze({resource:this,flipY:i,skipColorSpaceConversion:u,preferImageBitmap:e});const s=this.fetchBlob();if(!n(s))return;let c,a,f,h;return Fe.supportsImageBitmapOptions().then((function(t){return c=t,a=c&&e,s})).then((function(t){if(!n(t))return;if(h=t,a)return Fe.createImageBitmapFromBlob(t,{flipY:i,premultiplyAlpha:!1,skipColorSpaceConversion:u});const e=window.URL.createObjectURL(t);return f=new Fe({url:e}),ze({resource:f,flipY:i,skipColorSpaceConversion:u,preferImageBitmap:!1})})).then((function(t){if(n(t))return t.blob=h,a||window.URL.revokeObjectURL(f.url),t})).catch((function(t){return n(f)&&window.URL.revokeObjectURL(f.url),t.blob=h,Promise.reject(t)}))},Fe.fetchImage=function(t){return new Fe(t).fetchImage({flipY:t.flipY,skipColorSpaceConversion:t.skipColorSpaceConversion,preferBlob:t.preferBlob,preferImageBitmap:t.preferImageBitmap})},Fe.prototype.fetchText=function(){return this.fetch({responseType:"text"})},Fe.fetchText=function(t){return new Fe(t).fetchText()},Fe.prototype.fetchJson=function(){const t=this.fetch({responseType:"text",headers:{Accept:"application/json,*/*;q=0.01"}});if(n(t))return t.then((function(t){if(n(t))return JSON.parse(t)}))},Fe.fetchJson=function(t){return new Fe(t).fetchJson()},Fe.prototype.fetchXML=function(){return this.fetch({responseType:"document",overrideMimeType:"text/xml"})},Fe.fetchXML=function(t){return new Fe(t).fetchXML()},Fe.prototype.fetchJsonp=function(t){let e;t=o(t,"callback"),De(this.request);do{e=`loadJsonp${l.nextRandomNumber().toString().substring(2,8)}`}while(n(window[e]));return Ce(this,t,e)},Fe.fetchJsonp=function(t){return new Fe(t).fetchJsonp(t.callbackParameterName)},Fe.prototype.rt=function(t){const e=this;De(e.request);const r=e.request,i=e.url;r.url=i,r.requestFunction=function(){const o=t.responseType,u=ne(t.headers,e.headers),s=t.overrideMimeType,c=t.method,a=t.data,f=ee(),h=Fe.nt.loadWithXhr(i,o,c,a,u,f,s);return n(h)&&n(h.abort)&&(r.cancelFunction=function(){h.abort()}),f.promise};const o=qe.request(r);if(n(o))return o.then((function(t){return r.cancelFunction=void 0,t})).catch((function(n){return r.cancelFunction=void 0,r.state!==he.FAILED?Promise.reject(n):e.retryOnError(n).then((function(i){return i?(r.state=he.UNISSUED,r.deferred=void 0,e.fetch(t)):Promise.reject(n)}))}))};const Be=/^data:(.*?)(;base64)?,(.*)$/;function Le(t,n){const e=decodeURIComponent(n);return t?atob(e):e}function _e(t,n){const e=Le(t,n),r=new ArrayBuffer(e.length),i=new Uint8Array(r);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return r}Fe.prototype.fetch=function(t){return(t=Ne(t,{})).method="GET",this.rt(t)},Fe.fetch=function(t){return new Fe(t).fetch({responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.prototype.delete=function(t){return(t=Ne(t,{})).method="DELETE",this.rt(t)},Fe.delete=function(t){return new Fe(t).delete({responseType:t.responseType,overrideMimeType:t.overrideMimeType,data:t.data})},Fe.prototype.head=function(t){return(t=Ne(t,{})).method="HEAD",this.rt(t)},Fe.head=function(t){return new Fe(t).head({responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.prototype.options=function(t){return(t=Ne(t,{})).method="OPTIONS",this.rt(t)},Fe.options=function(t){return new Fe(t).options({responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.prototype.post=function(t,n){return r.defined("data",t),(n=Ne(n,{})).method="POST",n.data=t,this.rt(n)},Fe.post=function(t){return new Fe(t).post(t.data,{responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.prototype.put=function(t,n){return r.defined("data",t),(n=Ne(n,{})).method="PUT",n.data=t,this.rt(n)},Fe.put=function(t){return new Fe(t).put(t.data,{responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.prototype.patch=function(t,n){return r.defined("data",t),(n=Ne(n,{})).method="PATCH",n.data=t,this.rt(n)},Fe.patch=function(t){return new Fe(t).patch(t.data,{responseType:t.responseType,overrideMimeType:t.overrideMimeType})},Fe.nt={},Fe.nt.loadImageElement=function(t,n,e){const r=new Image;r.onload=function(){0===r.naturalWidth&&0===r.naturalHeight&&0===r.width&&0===r.height&&(r.width=300,r.height=150),e.resolve(r)},r.onerror=function(t){e.reject(t)},n&&(Re.contains(t)?r.crossOrigin="use-credentials":r.crossOrigin=""),r.src=t},Fe.nt.createImage=function(t,e,r,i,o,u){const s=t.url;Fe.supportsImageBitmapOptions().then((function(c){if(!c||!u)return void Fe.nt.loadImageElement(s,e,r);const a=ee(),f=Fe.nt.loadWithXhr(s,"blob","GET",void 0,void 0,a,void 0,void 0,void 0);return n(f)&&n(f.abort)&&(t.cancelFunction=function(){f.abort()}),a.promise.then((function(t){if(n(t))return Fe.createImageBitmapFromBlob(t,{flipY:i,premultiplyAlpha:!1,skipColorSpaceConversion:o});r.reject(new H(`Successfully retrieved ${s} but it contained no content.`))})).then((function(t){r.resolve(t)}))})).catch((function(t){r.reject(t)}))},Fe.createImageBitmapFromBlob=function(t,n){return r.defined("options",n),r.typeOf.bool("options.flipY",n.flipY),r.typeOf.bool("options.premultiplyAlpha",n.premultiplyAlpha),r.typeOf.bool("options.skipColorSpaceConversion",n.skipColorSpaceConversion),createImageBitmap(t,{imageOrientation:n.flipY?"flipY":"none",premultiplyAlpha:n.premultiplyAlpha?"premultiply":"none",colorSpaceConversion:n.skipColorSpaceConversion?"none":"default"})};const Ve="undefined"==typeof XMLHttpRequest;function He(t){t=o(t,o.EMPTY_OBJECT),this.ot=void 0,this.ut=void 0,this.ct=-1,this.ft=-1,this.ht=-1,this.lt=-1,this.dt=-1,this.wt=-1,this.vt=-1,this.yt=0,this.bt=-1,this.Mt=o(t.addNewLeapSeconds,!0),n(t.data)?Ze(this,t.data):Ze(this,{columnNames:["dateIso8601","modifiedJulianDateUtc","xPoleWanderRadians","yPoleWanderRadians","ut1MinusUtcSeconds","lengthOfDayCorrectionSeconds","xCelestialPoleOffsetRadians","yCelestialPoleOffsetRadians","taiMinusUtcSeconds"],samples:[]})}function Ye(t,n){return Un.compare(t.julianDate,n)}function Ze(t,e){if(!n(e.columnNames))throw new H("Error in loaded EOP data: The columnNames property is required.");if(!n(e.samples))throw new H("Error in loaded EOP data: The samples property is required.");const r=e.columnNames.indexOf("modifiedJulianDateUtc"),i=e.columnNames.indexOf("xPoleWanderRadians"),o=e.columnNames.indexOf("yPoleWanderRadians"),u=e.columnNames.indexOf("ut1MinusUtcSeconds"),s=e.columnNames.indexOf("xCelestialPoleOffsetRadians"),c=e.columnNames.indexOf("yCelestialPoleOffsetRadians"),a=e.columnNames.indexOf("taiMinusUtcSeconds");if(r<0||i<0||o<0||u<0||s<0||c<0||a<0)throw new H("Error in loaded EOP data: The columnNames property must include modifiedJulianDateUtc, xPoleWanderRadians, yPoleWanderRadians, ut1MinusUtcSeconds, xCelestialPoleOffsetRadians, yCelestialPoleOffsetRadians, and taiMinusUtcSeconds columns");const f=t.ut=e.samples,h=t.ot=[];let l;t.ct=r,t.ft=i,t.ht=o,t.lt=u,t.dt=s,t.wt=c,t.vt=a,t.yt=e.columnNames.length,t.bt=void 0;const d=t.Mt;for(let e=0,i=f.length;e<i;e+=t.yt){const t=f[e+r],i=f[e+a],o=new Un(t+gn.MODIFIED_JULIAN_DATE_DIFFERENCE,i,vn.TAI);if(h.push(o),d){if(i!==l&&n(l)){const t=Un.leapSeconds,n=fn(t,o,Ye);if(n<0){const e=new mn(o,i);t.splice(~n,0,e)}}l=i}}}function We(t,n,e,r,i){const o=e*r;i.xPoleWander=n[o+t.ft],i.yPoleWander=n[o+t.ht],i.xPoleOffset=n[o+t.dt],i.yPoleOffset=n[o+t.wt],i.ut1MinusUtc=n[o+t.lt]}function Qe(t,n,e){return n+t*(e-n)}function Je(t,n,e,r,i,o,u){const s=t.yt;if(o>n.length-1)return u.xPoleWander=0,u.yPoleWander=0,u.xPoleOffset=0,u.yPoleOffset=0,u.ut1MinusUtc=0,u;const c=n[i],a=n[o];if(c.equals(a)||r.equals(c))return We(t,e,i,s,u),u;if(r.equals(a))return We(t,e,o,s,u),u;const f=Un.secondsDifference(r,c)/Un.secondsDifference(a,c),h=i*s,l=o*s;let d=e[h+t.lt],w=e[l+t.lt];const m=w-d;if(m>.5||m<-.5){const n=e[h+t.vt],i=e[l+t.vt];n!==i&&(a.equals(r)?d=w:w-=i-n)}return u.xPoleWander=Qe(f,e[h+t.ft],e[l+t.ft]),u.yPoleWander=Qe(f,e[h+t.ht],e[l+t.ht]),u.xPoleOffset=Qe(f,e[h+t.dt],e[l+t.dt]),u.yPoleOffset=Qe(f,e[h+t.wt],e[l+t.wt]),u.ut1MinusUtc=Qe(f,d,w),u}function Ge(t,n,e){this.heading=o(t,0),this.pitch=o(n,0),this.roll=o(e,0)}Fe.nt.loadWithXhr=function(t,r,i,u,s,c,a){const f=Be.exec(t);if(null!==f)return void c.resolve(function(t,n){n=o(n,"");const r=t[1],i=!!t[2],u=t[3];let s,c;switch(n){case"":case"text":return Le(i,u);case"arraybuffer":return _e(i,u);case"blob":return s=_e(i,u),new Blob([s],{type:r});case"document":return c=new DOMParser,c.parseFromString(Le(i,u),r);case"json":return JSON.parse(Le(i,u));default:throw new e(`Unhandled responseType: ${n}`)}}(f,r));if(Ve)return void function(t,n,e,r,i,o){fetch(t,{method:e,headers:i}).then((async t=>{if(!t.ok){const n={};return t.headers.forEach(((t,e)=>{n[e]=t})),void o.reject(new we(t.status,t,n))}switch(n){case"text":o.resolve(t.text());break;case"json":o.resolve(t.json());break;default:o.resolve(new Uint8Array(await t.arrayBuffer()).buffer)}})).catch((()=>{o.reject(new we)}))}(t,r,i,0,s,c);const h=new XMLHttpRequest;if(Re.contains(t)&&(h.withCredentials=!0),h.open(i,t,!0),n(a)&&n(h.overrideMimeType)&&h.overrideMimeType(a),n(s))for(const t in s)s.hasOwnProperty(t)&&h.setRequestHeader(t,s[t]);n(r)&&(h.responseType=r);let l=!1;return"string"==typeof t&&(l=0===t.indexOf("file://")||"undefined"!=typeof window&&"file://"===window.location.origin),h.onload=function(){if((h.status<200||h.status>=300)&&(!l||0!==h.status))return void c.reject(new we(h.status,h.response,h.getAllResponseHeaders()));const t=h.response,e=h.responseType;if("HEAD"===i||"OPTIONS"===i){const t=h.getAllResponseHeaders().trim().split(/[\\r\\n]+/),n={};return t.forEach((function(t){const e=t.split(": "),r=e.shift();n[r]=e.join(": ")})),void c.resolve(n)}if(204===h.status)c.resolve(void 0);else if(!n(t)||n(r)&&e!==r)if("json"===r&&"string"==typeof t)try{c.resolve(JSON.parse(t))}catch(t){c.reject(t)}else(""===e||"document"===e)&&n(h.responseXML)&&h.responseXML.hasChildNodes()?c.resolve(h.responseXML):""!==e&&"text"!==e||!n(h.responseText)?c.reject(new H("Invalid XMLHttpRequest response type.")):c.resolve(h.responseText);else c.resolve(t)},h.onerror=function(t){c.reject(new we)},h.send(u),h},Fe.nt.loadAndExecuteScript=function(t,n,e){return function(t){const n=document.createElement("script");return n.async=!0,n.src=t,new Promise(((t,e)=>{window.crossOriginIsolated&&n.setAttribute("crossorigin","anonymous");const r=document.getElementsByTagName("head")[0];n.onload=function(){n.onload=void 0,r.removeChild(n),t()},n.onerror=function(t){e(t)},r.appendChild(n)}))}(t).catch((function(t){e.reject(t)}))},Fe.At={},Fe.At.createImage=Fe.nt.createImage,Fe.At.loadWithXhr=Fe.nt.loadWithXhr,Fe.At.loadAndExecuteScript=Fe.nt.loadAndExecuteScript,Fe.DEFAULT=Object.freeze(new Fe({url:"undefined"==typeof document?"":document.location.href.split("?")[0]})),He.fromUrl=async function(t,n){r.defined("url",t),n=o(n,o.EMPTY_OBJECT);const e=Fe.createIfNeeded(t);let i;try{i=await e.fetchJson()}catch(t){throw new H(`An error occurred while retrieving the EOP data from the URL ${e.url}.`)}return new He({addNewLeapSeconds:n.addNewLeapSeconds,data:i})},He.NONE=Object.freeze({compute:function(t,e){return n(e)?(e.xPoleWander=0,e.yPoleWander=0,e.xPoleOffset=0,e.yPoleOffset=0,e.ut1MinusUtc=0):e=new hn(0,0,0,0,0),e}}),He.prototype.compute=function(t,e){if(!n(this.ut))return;if(n(e)||(e=new hn(0,0,0,0,0)),0===this.ut.length)return e.xPoleWander=0,e.yPoleWander=0,e.xPoleOffset=0,e.yPoleOffset=0,e.ut1MinusUtc=0,e;const r=this.ot,i=this.bt;let o=0,u=0;if(n(i)){const s=r[i],c=r[i+1],a=Un.lessThanOrEquals(s,t),f=!n(c),h=f||Un.greaterThanOrEquals(c,t);if(a&&h)return o=i,!f&&c.equals(t)&&++o,u=o+1,Je(this,r,this.ut,t,o,u,e),e}let s=fn(r,t,Un.compare,this.ct);return s>=0?(s<r.length-1&&r[s+1].equals(t)&&++s,o=s,u=s):(u=~s,o=u-1,o<0&&(o=0)),this.bt=o,Je(this,r,this.ut,t,o,u,e),e},Ge.fromQuaternion=function(t,r){if(!n(t))throw new e("quaternion is required");n(r)||(r=new Ge);const i=2*(t.w*t.y-t.z*t.x),o=1-2*(t.x*t.x+t.y*t.y),u=2*(t.w*t.x+t.y*t.z),s=1-2*(t.y*t.y+t.z*t.z),c=2*(t.w*t.z+t.x*t.y);return r.heading=-Math.atan2(c,s),r.roll=Math.atan2(u,o),r.pitch=-l.asinClamped(i),r},Ge.fromDegrees=function(t,r,i,o){if(!n(t))throw new e("heading is required");if(!n(r))throw new e("pitch is required");if(!n(i))throw new e("roll is required");return n(o)||(o=new Ge),o.heading=t*l.RADIANS_PER_DEGREE,o.pitch=r*l.RADIANS_PER_DEGREE,o.roll=i*l.RADIANS_PER_DEGREE,o},Ge.clone=function(t,e){if(n(t))return n(e)?(e.heading=t.heading,e.pitch=t.pitch,e.roll=t.roll,e):new Ge(t.heading,t.pitch,t.roll)},Ge.equals=function(t,e){return t===e||n(t)&&n(e)&&t.heading===e.heading&&t.pitch===e.pitch&&t.roll===e.roll},Ge.equalsEpsilon=function(t,e,r,i){return t===e||n(t)&&n(e)&&l.equalsEpsilon(t.heading,e.heading,r,i)&&l.equalsEpsilon(t.pitch,e.pitch,r,i)&&l.equalsEpsilon(t.roll,e.roll,r,i)},Ge.prototype.clone=function(t){return Ge.clone(this,t)},Ge.prototype.equals=function(t){return Ge.equals(this,t)},Ge.prototype.equalsEpsilon=function(t,n,e){return Ge.equalsEpsilon(this,t,n,e)},Ge.prototype.toString=function(){return`(${this.heading}, ${this.pitch}, ${this.roll})`};const Xe=/((?:.*\\/)|^)Cesium\\.js(?:\\?|\\#|$)/;let Ke,tr,nr;function er(t){return"undefined"==typeof document?t:(n(Ke)||(Ke=document.createElement("a")),Ke.href=t,Ke.href)}function rr(){if(n(tr))return tr;let r;if(r="undefined"!=typeof CESIUM_BASE_URL?CESIUM_BASE_URL:n("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:t&&"SCRIPT"===t.tagName.toUpperCase()&&t.src||new URL("building-worker.generated.js",document.baseURI).href)?re(".","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:t&&"SCRIPT"===t.tagName.toUpperCase()&&t.src||new URL("building-worker.generated.js",document.baseURI).href):"object"==typeof define&&n(define.amd)&&!define.amd.toUrlUndefined&&n(require.toUrl)?re("..",ur("Core/buildModuleUrl.js")):function(){const t=document.getElementsByTagName("script");for(let n=0,e=t.length;n<e;++n){const e=t[n].getAttribute("src"),r=Xe.exec(e);if(null!==r)return r[1]}}(),!n(r))throw new e("Unable to determine Cesium base URL automatically, try defining a global variable called CESIUM_BASE_URL.");return tr=new Fe({url:er(r)}),tr.appendForwardSlash(),tr}function ir(t){return er(require.toUrl(`../${t}`))}function or(t){return rr().getDerivedResource({url:t}).url}function ur(t){return n(nr)||(nr="object"==typeof define&&n(define.amd)&&!define.amd.toUrlUndefined&&n(require.toUrl)?ir:or),nr(t)}function sr(t,n,e){this.x=t,this.y=n,this.s=e}function cr(t){t=o(t,o.EMPTY_OBJECT),this.xt=Fe.createIfNeeded(t.xysFileUrlTemplate),this.Et=o(t.interpolationOrder,9),this.kt=o(t.sampleZeroJulianEphemerisDate,2442396.5),this.qt=new Un(this.kt,0,vn.TAI),this.$t=o(t.stepSizeDays,1),this.St=o(t.samplesPerXysFile,1e3),this.It=o(t.totalSamples,27426),this.ut=new Array(3*this.It),this.Ot=[];const n=this.Et,e=this.Rt=new Array(n+1),r=this.Pt=new Array(n+1),i=Math.pow(this.$t,n);for(let t=0;t<=n;++t){e[t]=i,r[t]=t*this.$t;for(let r=0;r<=n;++r)r!==t&&(e[t]*=t-r);e[t]=1/e[t]}this.jt=new Array(n+1),this.Ft=new Array(n+1)}ur.Nt=Xe,ur.Ut=or,ur.Tt=function(){tr=void 0},ur.setBaseUrl=function(t){tr=Fe.DEFAULT.getDerivedResource({url:t})},ur.getCesiumBaseUrl=rr;const ar=new Un(0,0,vn.TAI);function fr(t,n,e){const r=ar;return r.dayNumber=n,r.secondsOfDay=e,Un.daysDifference(r,t.qt)}function hr(t,e){if(t.Ot[e])return t.Ot[e];let r;const i=t.xt;r=n(i)?i.getDerivedResource({templateValues:{0:e}}):new Fe({url:ur(`Assets/IAU2006_XYS/IAU2006_XYS_${e}.json`)});const o=r.fetchJson().then((function(n){t.Ot[e]=!1;const r=t.ut,i=n.samples,o=e*t.St*3;for(let t=0,n=i.length;t<n;++t)r[o+t]=i[t]}));return t.Ot[e]=o,o}function lr(t,n,e,r){this.x=o(t,0),this.y=o(n,0),this.z=o(e,0),this.w=o(r,0)}cr.prototype.preload=function(t,n,e,r){const i=fr(this,t,n),o=fr(this,e,r);let u=i/this.$t-this.Et/2|0;u<0&&(u=0);let s=o/this.$t-this.Et/2|0+this.Et;s>=this.It&&(s=this.It-1);const c=u/this.St|0,a=s/this.St|0,f=[];for(let t=c;t<=a;++t)f.push(hr(this,t));return Promise.all(f)},cr.prototype.computeXysRadians=function(t,e,r){const i=fr(this,t,e);if(i<0)return;const o=i/this.$t|0;if(o>=this.It)return;const u=this.Et;let s=o-(u/2|0);s<0&&(s=0);let c=s+u;c>=this.It&&(c=this.It-1,s=c-u,s<0&&(s=0));let a=!1;const f=this.ut;if(n(f[3*s])||(hr(this,s/this.St|0),a=!0),n(f[3*c])||(hr(this,c/this.St|0),a=!0),a)return;n(r)?(r.x=0,r.y=0,r.s=0):r=new sr(0,0,0);const h=i-s*this.$t,l=this.jt,d=this.Rt,w=this.Ft,m=this.Pt;let g,v;for(g=0;g<=u;++g)l[g]=h-m[g];for(g=0;g<=u;++g){for(w[g]=1,v=0;v<=u;++v)v!==g&&(w[g]*=l[v]);w[g]*=d[g];let t=3*(s+g);r.x+=w[g]*f[t++],r.y+=w[g]*f[t++],r.s+=w[g]*f[t]}return r};let dr=new m;lr.fromAxisAngle=function(t,e,i){r.typeOf.object("axis",t),r.typeOf.number("angle",e);const o=e/2,u=Math.sin(o);dr=m.normalize(t,dr);const s=dr.x*u,c=dr.y*u,a=dr.z*u,f=Math.cos(o);return n(i)?(i.x=s,i.y=c,i.z=a,i.w=f,i):new lr(s,c,a,f)};const wr=[1,2,0],mr=new Array(3);lr.fromRotationMatrix=function(t,e){let i,o,u,s,c;r.typeOf.object("matrix",t);const a=t[R.COLUMN0ROW0],f=t[R.COLUMN1ROW1],h=t[R.COLUMN2ROW2],l=a+f+h;if(l>0)i=Math.sqrt(l+1),c=.5*i,i=.5/i,o=(t[R.COLUMN1ROW2]-t[R.COLUMN2ROW1])*i,u=(t[R.COLUMN2ROW0]-t[R.COLUMN0ROW2])*i,s=(t[R.COLUMN0ROW1]-t[R.COLUMN1ROW0])*i;else{const n=wr;let e=0;f>a&&(e=1),h>a&&h>f&&(e=2);const r=n[e],l=n[r];i=Math.sqrt(t[R.getElementIndex(e,e)]-t[R.getElementIndex(r,r)]-t[R.getElementIndex(l,l)]+1);const d=mr;d[e]=.5*i,i=.5/i,c=(t[R.getElementIndex(l,r)]-t[R.getElementIndex(r,l)])*i,d[r]=(t[R.getElementIndex(r,e)]+t[R.getElementIndex(e,r)])*i,d[l]=(t[R.getElementIndex(l,e)]+t[R.getElementIndex(e,l)])*i,o=-d[0],u=-d[1],s=-d[2]}return n(e)?(e.x=o,e.y=u,e.z=s,e.w=c,e):new lr(o,u,s,c)};const gr=new lr;let vr=new lr,pr=new lr,yr=new lr;lr.fromHeadingPitchRoll=function(t,n){return r.typeOf.object("headingPitchRoll",t),yr=lr.fromAxisAngle(m.UNIT_X,t.roll,gr),pr=lr.fromAxisAngle(m.UNIT_Y,-t.pitch,n),n=lr.multiply(pr,yr,pr),vr=lr.fromAxisAngle(m.UNIT_Z,-t.heading,gr),lr.multiply(vr,n,n)};const br=new m,Mr=new m,Ar=new lr,xr=new lr,Er=new lr;lr.packedLength=4,lr.pack=function(t,n,e){return r.typeOf.object("value",t),r.defined("array",n),e=o(e,0),n[e++]=t.x,n[e++]=t.y,n[e++]=t.z,n[e]=t.w,n},lr.unpack=function(t,e,i){return r.defined("array",t),e=o(e,0),n(i)||(i=new lr),i.x=t[e],i.y=t[e+1],i.z=t[e+2],i.w=t[e+3],i},lr.packedInterpolationLength=3,lr.convertPackedArrayForInterpolation=function(t,e,r,i){lr.unpack(t,4*r,Er),lr.conjugate(Er,Er);for(let o=0,u=r-e+1;o<u;o++){const r=3*o;lr.unpack(t,4*(e+o),Ar),lr.multiply(Ar,Er,Ar),Ar.w<0&&lr.negate(Ar,Ar),lr.computeAxis(Ar,br);const u=lr.computeAngle(Ar);n(i)||(i=[]),i[r]=br.x*u,i[r+1]=br.y*u,i[r+2]=br.z*u}},lr.unpackInterpolationResult=function(t,e,r,i,o){n(o)||(o=new lr),m.fromArray(t,0,Mr);const u=m.magnitude(Mr);return lr.unpack(e,4*i,xr),0===u?lr.clone(lr.IDENTITY,Ar):lr.fromAxisAngle(Mr,u,Ar),lr.multiply(Ar,xr,o)},lr.clone=function(t,e){if(n(t))return n(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e):new lr(t.x,t.y,t.z,t.w)},lr.conjugate=function(t,n){return r.typeOf.object("quaternion",t),r.typeOf.object("result",n),n.x=-t.x,n.y=-t.y,n.z=-t.z,n.w=t.w,n},lr.magnitudeSquared=function(t){return r.typeOf.object("quaternion",t),t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},lr.magnitude=function(t){return Math.sqrt(lr.magnitudeSquared(t))},lr.normalize=function(t,n){r.typeOf.object("result",n);const e=1/lr.magnitude(t),i=t.x*e,o=t.y*e,u=t.z*e,s=t.w*e;return n.x=i,n.y=o,n.z=u,n.w=s,n},lr.inverse=function(t,n){r.typeOf.object("result",n);const e=lr.magnitudeSquared(t);return n=lr.conjugate(t,n),lr.multiplyByScalar(n,1/e,n)},lr.add=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},lr.subtract=function(t,n,e){return r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e),e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},lr.negate=function(t,n){return r.typeOf.object("quaternion",t),r.typeOf.object("result",n),n.x=-t.x,n.y=-t.y,n.z=-t.z,n.w=-t.w,n},lr.dot=function(t,n){return r.typeOf.object("left",t),r.typeOf.object("right",n),t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w},lr.multiply=function(t,n,e){r.typeOf.object("left",t),r.typeOf.object("right",n),r.typeOf.object("result",e);const i=t.x,o=t.y,u=t.z,s=t.w,c=n.x,a=n.y,f=n.z,h=n.w,l=s*c+i*h+o*f-u*a,d=s*a-i*f+o*h+u*c,w=s*f+i*a-o*c+u*h,m=s*h-i*c-o*a-u*f;return e.x=l,e.y=d,e.z=w,e.w=m,e},lr.multiplyByScalar=function(t,n,e){return r.typeOf.object("quaternion",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},lr.divideByScalar=function(t,n,e){return r.typeOf.object("quaternion",t),r.typeOf.number("scalar",n),r.typeOf.object("result",e),e.x=t.x/n,e.y=t.y/n,e.z=t.z/n,e.w=t.w/n,e},lr.computeAxis=function(t,n){r.typeOf.object("quaternion",t),r.typeOf.object("result",n);const e=t.w;if(Math.abs(e-1)<l.EPSILON6||Math.abs(e+1)<l.EPSILON6)return n.x=1,n.y=n.z=0,n;const i=1/Math.sqrt(1-e*e);return n.x=t.x*i,n.y=t.y*i,n.z=t.z*i,n},lr.computeAngle=function(t){return r.typeOf.object("quaternion",t),Math.abs(t.w-1)<l.EPSILON6?0:2*Math.acos(t.w)};let kr=new lr;lr.lerp=function(t,n,e,i){return r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i),kr=lr.multiplyByScalar(n,e,kr),i=lr.multiplyByScalar(t,1-e,i),lr.add(kr,i,i)};let qr=new lr,$r=new lr,Sr=new lr;lr.slerp=function(t,n,e,i){r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i);let o=lr.dot(t,n),u=n;if(o<0&&(o=-o,u=qr=lr.negate(n,qr)),1-o<l.EPSILON6)return lr.lerp(t,u,e,i);const s=Math.acos(o);return $r=lr.multiplyByScalar(t,Math.sin((1-e)*s),$r),Sr=lr.multiplyByScalar(u,Math.sin(e*s),Sr),i=lr.add($r,Sr,i),lr.multiplyByScalar(i,1/Math.sin(s),i)},lr.log=function(t,n){r.typeOf.object("quaternion",t),r.typeOf.object("result",n);const e=l.acosClamped(t.w);let i=0;return 0!==e&&(i=e/Math.sin(e)),m.multiplyByScalar(t,i,n)},lr.exp=function(t,n){r.typeOf.object("cartesian",t),r.typeOf.object("result",n);const e=m.magnitude(t);let i=0;return 0!==e&&(i=Math.sin(e)/e),n.x=t.x*i,n.y=t.y*i,n.z=t.z*i,n.w=Math.cos(e),n};const Ir=new m,Or=new m,Rr=new lr,Pr=new lr;lr.computeInnerQuadrangle=function(t,n,e,i){r.typeOf.object("q0",t),r.typeOf.object("q1",n),r.typeOf.object("q2",e),r.typeOf.object("result",i);const o=lr.conjugate(n,Rr);lr.multiply(o,e,Pr);const u=lr.log(Pr,Ir);lr.multiply(o,t,Pr);const s=lr.log(Pr,Or);return m.add(u,s,u),m.multiplyByScalar(u,.25,u),m.negate(u,u),lr.exp(u,Rr),lr.multiply(n,Rr,i)},lr.squad=function(t,n,e,i,o,u){r.typeOf.object("q0",t),r.typeOf.object("q1",n),r.typeOf.object("s0",e),r.typeOf.object("s1",i),r.typeOf.number("t",o),r.typeOf.object("result",u);const s=lr.slerp(t,n,o,Rr),c=lr.slerp(e,i,o,Pr);return lr.slerp(s,c,2*o*(1-o),u)};const jr=new lr,Fr=1.9011074535173003,Nr=zt.supportsTypedArrays()?new Float32Array(8):[],Ur=zt.supportsTypedArrays()?new Float32Array(8):[],Tr=zt.supportsTypedArrays()?new Float32Array(8):[],zr=zt.supportsTypedArrays()?new Float32Array(8):[];for(let t=0;t<7;++t){const n=t+1,e=2*n+1;Nr[t]=1/(n*e),Ur[t]=n/e}Nr[7]=Fr/136,Ur[7]=8*Fr/17,lr.fastSlerp=function(t,n,e,i){r.typeOf.object("start",t),r.typeOf.object("end",n),r.typeOf.number("t",e),r.typeOf.object("result",i);let o,u=lr.dot(t,n);u>=0?o=1:(o=-1,u=-u);const s=u-1,c=1-e,a=e*e,f=c*c;for(let t=7;t>=0;--t)Tr[t]=(Nr[t]*a-Ur[t])*s,zr[t]=(Nr[t]*f-Ur[t])*s;const h=o*e*(1+Tr[0]*(1+Tr[1]*(1+Tr[2]*(1+Tr[3]*(1+Tr[4]*(1+Tr[5]*(1+Tr[6]*(1+Tr[7])))))))),l=c*(1+zr[0]*(1+zr[1]*(1+zr[2]*(1+zr[3]*(1+zr[4]*(1+zr[5]*(1+zr[6]*(1+zr[7])))))))),d=lr.multiplyByScalar(t,l,jr);return lr.multiplyByScalar(n,h,i),lr.add(d,i,i)},lr.fastSquad=function(t,n,e,i,o,u){r.typeOf.object("q0",t),r.typeOf.object("q1",n),r.typeOf.object("s0",e),r.typeOf.object("s1",i),r.typeOf.number("t",o),r.typeOf.object("result",u);const s=lr.fastSlerp(t,n,o,Rr),c=lr.fastSlerp(e,i,o,Pr);return lr.fastSlerp(s,c,2*o*(1-o),u)},lr.equals=function(t,e){return t===e||n(t)&&n(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},lr.equalsEpsilon=function(t,e,r){return r=o(r,0),t===e||n(t)&&n(e)&&Math.abs(t.x-e.x)<=r&&Math.abs(t.y-e.y)<=r&&Math.abs(t.z-e.z)<=r&&Math.abs(t.w-e.w)<=r},lr.ZERO=Object.freeze(new lr(0,0,0,0)),lr.IDENTITY=Object.freeze(new lr(0,0,0,1)),lr.prototype.clone=function(t){return lr.clone(this,t)},lr.prototype.equals=function(t){return lr.equals(this,t)},lr.prototype.equalsEpsilon=function(t,n){return lr.equalsEpsilon(this,t,n)},lr.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z}, ${this.w})`};const Cr={},Dr={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},Br={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},Lr={},_r={east:new m,north:new m,up:new m,west:new m,south:new m,down:new m};let Vr=new m,Hr=new m,Yr=new m;Cr.localFrameToFixedFrameGenerator=function(t,r){if(!Dr.hasOwnProperty(t)||!Dr[t].hasOwnProperty(r))throw new e("firstAxis and secondAxis must be east, north, up, west, south or down.");const i=Dr[t][r];let u;const s=t+r;return n(Lr[s])?u=Lr[s]:(u=function(u,s,c){if(!n(u))throw new e("origin is required.");if(isNaN(u.x)||isNaN(u.y)||isNaN(u.z))throw new e("origin has a NaN component");if(n(c)||(c=new Y),m.equalsEpsilon(u,m.ZERO,l.EPSILON14))m.unpack(Br[t],0,Vr),m.unpack(Br[r],0,Hr),m.unpack(Br[i],0,Yr);else if(l.equalsEpsilon(u.x,0,l.EPSILON14)&&l.equalsEpsilon(u.y,0,l.EPSILON14)){const n=l.sign(u.z);m.unpack(Br[t],0,Vr),"east"!==t&&"west"!==t&&m.multiplyByScalar(Vr,n,Vr),m.unpack(Br[r],0,Hr),"east"!==r&&"west"!==r&&m.multiplyByScalar(Hr,n,Hr),m.unpack(Br[i],0,Yr),"east"!==i&&"west"!==i&&m.multiplyByScalar(Yr,n,Yr)}else{(s=o(s,Kt.default)).geodeticSurfaceNormal(u,_r.up);const n=_r.up,e=_r.east;e.x=-u.y,e.y=u.x,e.z=0,m.normalize(e,_r.east),m.cross(n,e,_r.north),m.multiplyByScalar(_r.up,-1,_r.down),m.multiplyByScalar(_r.east,-1,_r.west),m.multiplyByScalar(_r.north,-1,_r.south),Vr=_r[t],Hr=_r[r],Yr=_r[i]}return c[0]=Vr.x,c[1]=Vr.y,c[2]=Vr.z,c[3]=0,c[4]=Hr.x,c[5]=Hr.y,c[6]=Hr.z,c[7]=0,c[8]=Yr.x,c[9]=Yr.y,c[10]=Yr.z,c[11]=0,c[12]=u.x,c[13]=u.y,c[14]=u.z,c[15]=1,c},Lr[s]=u),u},Cr.eastNorthUpToFixedFrame=Cr.localFrameToFixedFrameGenerator("east","north"),Cr.northEastDownToFixedFrame=Cr.localFrameToFixedFrameGenerator("north","east"),Cr.northUpEastToFixedFrame=Cr.localFrameToFixedFrameGenerator("north","up"),Cr.northWestUpToFixedFrame=Cr.localFrameToFixedFrameGenerator("north","west");const Zr=new lr,Wr=new m(1,1,1),Qr=new Y;Cr.headingPitchRollToFixedFrame=function(t,n,e,i,u){r.typeOf.object("HeadingPitchRoll",n),i=o(i,Cr.eastNorthUpToFixedFrame);const s=lr.fromHeadingPitchRoll(n,Zr),c=Y.fromTranslationQuaternionRotationScale(m.ZERO,s,Wr,Qr);return u=i(t,e,u),Y.multiply(u,c,u)};const Jr=new Y,Gr=new R;Cr.headingPitchRollQuaternion=function(t,n,e,i,o){r.typeOf.object("HeadingPitchRoll",n);const u=Cr.headingPitchRollToFixedFrame(t,n,e,i,Jr),s=Y.getMatrix3(u,Gr);return lr.fromRotationMatrix(s,o)};const Xr=new m(1,1,1),Kr=new m,ti=new Y,ni=new Y,ei=new R,ri=new lr;Cr.fixedFrameToHeadingPitchRoll=function(t,e,i,u){r.defined("transform",t),e=o(e,Kt.default),i=o(i,Cr.eastNorthUpToFixedFrame),n(u)||(u=new Ge);const s=Y.getTranslation(t,Kr);if(m.equals(s,m.ZERO))return u.heading=0,u.pitch=0,u.roll=0,u;let c=Y.inverseTransformation(i(s,e,ti),ti),a=Y.setScale(t,Xr,ni);a=Y.setTranslation(a,m.ZERO,a),c=Y.multiply(c,a,c);let f=lr.fromRotationMatrix(Y.getMatrix3(c,ei),ri);return f=lr.normalize(f,f),Ge.fromQuaternion(f,u)};const ii=l.TWO_PI/86400;let oi=new Un;Cr.computeIcrfToCentralBodyFixedMatrix=function(t,e){let r=Cr.computeIcrfToFixedMatrix(t,e);return n(r)||(r=Cr.computeTemeToPseudoFixedMatrix(t,e)),r},Cr.computeTemeToPseudoFixedMatrix=function(t,r){if(!n(t))throw new e("date is required.");oi=Un.addSeconds(t,-Un.computeTaiMinusUtc(t),oi);const i=oi.dayNumber,o=oi.secondsOfDay;let u;const s=i-2451545;u=o>=43200?(s+.5)/gn.DAYS_PER_JULIAN_CENTURY:(s-.5)/gn.DAYS_PER_JULIAN_CENTURY;const c=(24110.54841+u*(8640184.812866+u*(.093104+-62e-7*u)))*ii%l.TWO_PI+(72921158553e-15+11772758384668e-32*(i-2451545.5))*((o+.5*gn.SECONDS_PER_DAY)%gn.SECONDS_PER_DAY),a=Math.cos(c),f=Math.sin(c);return n(r)?(r[0]=a,r[1]=-f,r[2]=0,r[3]=f,r[4]=a,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r):new R(a,f,0,-f,a,0,0,0,1)},Cr.iau2006XysData=new cr,Cr.earthOrientationParameters=He.NONE;const ui=32.184;Cr.preloadIcrfFixed=function(t){const n=t.start.dayNumber,e=t.start.secondsOfDay+ui,r=t.stop.dayNumber,i=t.stop.secondsOfDay+ui;return Cr.iau2006XysData.preload(n,e,r,i)},Cr.computeIcrfToFixedMatrix=function(t,r){if(!n(t))throw new e("date is required.");n(r)||(r=new R);const i=Cr.computeFixedToIcrfMatrix(t,r);if(n(i))return R.transpose(i,r)};const si=new Ge,ci=new R,ai=new Un;Cr.computeMoonFixedToIcrfMatrix=function(t,r){if(!n(t))throw new e("date is required.");const i=Un.addSeconds(t,32.184,ai),o=Un.totalDays(i)-2451545,u=l.toRadians(12.112)-l.toRadians(.052992)*o,s=l.toRadians(24.224)-l.toRadians(.105984)*o,c=l.toRadians(227.645)+l.toRadians(13.012)*o,a=l.toRadians(261.105)+l.toRadians(13.340716)*o,f=l.toRadians(358)+l.toRadians(.9856)*o;return si.pitch=l.toRadians(180)-l.toRadians(3.878)*Math.sin(u)-l.toRadians(.12)*Math.sin(s)+l.toRadians(.07)*Math.sin(c)-l.toRadians(.017)*Math.sin(a),si.roll=l.toRadians(-23.47)+l.toRadians(1.543)*Math.cos(u)+l.toRadians(.24)*Math.cos(s)-l.toRadians(.028)*Math.cos(c)+l.toRadians(.007)*Math.cos(a),si.heading=l.toRadians(154.375)+l.toRadians(13.17635831)*o+l.toRadians(3.558)*Math.sin(u)+l.toRadians(.121)*Math.sin(s)-l.toRadians(.064)*Math.sin(c)+l.toRadians(.016)*Math.sin(a)+l.toRadians(.025)*Math.sin(f),R.fromHeadingPitchRoll(si,ci)},Cr.computeIcrfToMoonFixedMatrix=function(t,r){if(!n(t))throw new e("date is required.");n(r)||(r=new R);const i=Cr.computeMoonFixedToIcrfMatrix(t,r);if(n(i))return R.transpose(i,r)};const fi=new sr(0,0,0),hi=new hn(0,0,0,0,0),li=new R,di=new R;Cr.computeFixedToIcrfMatrix=function(t,r){if(!n(t))throw new e("date is required.");n(r)||(r=new R);const i=Cr.earthOrientationParameters.compute(t,hi);if(!n(i))return;const o=t.dayNumber,u=t.secondsOfDay+ui,s=Cr.iau2006XysData.computeXysRadians(o,u,fi);if(!n(s))return;const c=s.x+i.xPoleOffset,a=s.y+i.yPoleOffset,f=1/(1+Math.sqrt(1-c*c-a*a)),h=li;h[0]=1-f*c*c,h[3]=-f*c*a,h[6]=c,h[1]=-f*c*a,h[4]=1-f*a*a,h[7]=a,h[2]=-c,h[5]=-a,h[8]=1-f*(c*c+a*a);const d=R.fromRotationZ(-s.s,di),w=R.multiply(h,d,li),m=t.dayNumber-2451545,g=(t.secondsOfDay-Un.computeTaiMinusUtc(t)+i.ut1MinusUtc)/gn.SECONDS_PER_DAY;let v=.779057273264+g+.00273781191135448*(m+g);v=v%1*l.TWO_PI;const p=R.fromRotationZ(v,di),y=R.multiply(w,p,li),b=Math.cos(i.xPoleWander),M=Math.cos(i.yPoleWander),A=Math.sin(i.xPoleWander),x=Math.sin(i.yPoleWander);let E=o-2451545+u/gn.SECONDS_PER_DAY;E/=36525;const k=-47e-6*E*l.RADIANS_PER_DEGREE/3600,q=Math.cos(k),$=Math.sin(k),S=di;return S[0]=b*q,S[1]=b*$,S[2]=A,S[3]=-M*$+x*A*q,S[4]=M*q+x*A*$,S[5]=-x*b,S[6]=-x*$-M*A*q,S[7]=x*q-M*A*$,S[8]=M*b,R.multiply(y,S,r)};const wi=new x;Cr.pointToWindowCoordinates=function(t,n,e,r){return(r=Cr.pointToGLWindowCoordinates(t,n,e,r)).y=2*n[5]-r.y,r},Cr.pointToGLWindowCoordinates=function(t,r,i,o){if(!n(t))throw new e("modelViewProjectionMatrix is required.");if(!n(r))throw new e("viewportTransformation is required.");if(!n(i))throw new e("point is required.");n(o)||(o=new Ct);const u=wi;return Y.multiplyByVector(t,x.fromElements(i.x,i.y,i.z,1,u),u),x.multiplyByScalar(u,1/u.w,u),Y.multiplyByVector(r,u,u),Ct.fromCartesian4(u,o)};const mi=new m,gi=new m,vi=new m;Cr.rotationMatrixFromPositionVelocity=function(t,r,i,u){if(!n(t))throw new e("position is required.");if(!n(r))throw new e("velocity is required.");const s=o(i,Kt.default).geodeticSurfaceNormal(t,mi);let c=m.cross(r,s,gi);m.equalsEpsilon(c,m.ZERO,l.EPSILON6)&&(c=m.clone(m.UNIT_X,c));const a=m.cross(c,r,vi);return m.normalize(a,a),m.cross(r,a,c),m.negate(c,c),m.normalize(c,c),n(u)||(u=new R),u[0]=r.x,u[1]=r.y,u[2]=r.z,u[3]=c.x,u[4]=c.y,u[5]=c.z,u[6]=a.x,u[7]=a.y,u[8]=a.z,u};const pi=new Y(0,0,1,0,1,0,0,0,0,1,0,0,0,0,0,1),yi=new Wt,bi=new m,Mi=new m,Ai=new R,xi=new Y,Ei=new Y;function ki(t,n,e=2){const r=t.length;let i=function(t,n,e,r){let i;if(1==function(t,n,e,r){let i=0;for(let n=0,o=e-r;n<e;n+=r)i+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return i}(t,0,e,r)>0)for(let n=0;n<e;n+=r)i=Li(n/r|0,t[n],t[n+1],i);else for(let n=e-r;n>=0;n-=r)i=Li(n/r|0,t[n],t[n+1],i);return i&&Ui(i,i.next)&&(_i(i),i=i.next),i}(t,0,r,e);const o=[];if(!i||i.next===i.prev)return o;let u,s,c;if(t.length>80*e){u=1/0,s=1/0;let n=-1/0,i=-1/0;for(let o=e;o<r;o+=e){const e=t[o],r=t[o+1];e<u&&(u=e),r<s&&(s=r),e>n&&(n=e),r>i&&(i=r)}c=Math.max(n-u,i-s),c=0!==c?32767/c:0}return $i(i,o,e,u,s,c,0),o}function qi(t,n){if(!t)return t;n||(n=t);let e,r=t;do{if(e=!1,r.steiner||!Ui(r,r.next)&&0!==Ni(r.prev,r,r.next))r=r.next;else{if(_i(r),r=n=r.prev,r===r.next)break;e=!0}}while(e||r!==n);return n}function $i(t,n,e,r,i,o,u){if(!t)return;!u&&o&&function(t,n,e,r){let i=t;do{0===i.z&&(i.z=Pi(i.x,i.y,n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){let n,e=1;do{let r,i=t;t=null;let o=null;for(n=0;i;){n++;let u=i,s=0;for(let t=0;t<e&&(s++,u=u.nextZ,u);t++);let c=e;for(;s>0||c>0&&u;)0!==s&&(0===c||!u||i.z<=u.z)?(r=i,i=i.nextZ,s--):(r=u,u=u.nextZ,c--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=u}o.nextZ=null,e*=2}while(n>1)}(i)}(t,r,i,o);let s=t;for(;t.prev!==t.next;){const c=t.prev,a=t.next;if(o?Ii(t,r,i,o):Si(t))n.push(c.i,t.i,a.i),_i(t),t=a.next,s=a.next;else if((t=a)===s){u?1===u?$i(t=Oi(qi(t),n),n,e,r,i,o,2):2===u&&Ri(t,n,e,r,i,o):$i(qi(t),n,e,r,i,o,1);break}}}function Si(t){const n=t.prev,e=t,r=t.next;if(Ni(n,e,r)>=0)return!1;const i=n.x,o=e.x,u=r.x,s=n.y,c=e.y,a=r.y,f=Math.min(i,o,u),h=Math.min(s,c,a),l=Math.max(i,o,u),d=Math.max(s,c,a);let w=r.next;for(;w!==n;){if(w.x>=f&&w.x<=l&&w.y>=h&&w.y<=d&&ji(i,s,o,c,u,a,w.x,w.y)&&Ni(w.prev,w,w.next)>=0)return!1;w=w.next}return!0}function Ii(t,n,e,r){const i=t.prev,o=t,u=t.next;if(Ni(i,o,u)>=0)return!1;const s=i.x,c=o.x,a=u.x,f=i.y,h=o.y,l=u.y,d=Math.min(s,c,a),w=Math.min(f,h,l),m=Math.max(s,c,a),g=Math.max(f,h,l),v=Pi(d,w,n,e,r),p=Pi(m,g,n,e,r);let y=t.prevZ,b=t.nextZ;for(;y&&y.z>=v&&b&&b.z<=p;){if(y.x>=d&&y.x<=m&&y.y>=w&&y.y<=g&&y!==i&&y!==u&&ji(s,f,c,h,a,l,y.x,y.y)&&Ni(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,b.x>=d&&b.x<=m&&b.y>=w&&b.y<=g&&b!==i&&b!==u&&ji(s,f,c,h,a,l,b.x,b.y)&&Ni(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;y&&y.z>=v;){if(y.x>=d&&y.x<=m&&y.y>=w&&y.y<=g&&y!==i&&y!==u&&ji(s,f,c,h,a,l,y.x,y.y)&&Ni(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;b&&b.z<=p;){if(b.x>=d&&b.x<=m&&b.y>=w&&b.y<=g&&b!==i&&b!==u&&ji(s,f,c,h,a,l,b.x,b.y)&&Ni(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function Oi(t,n){let e=t;do{const r=e.prev,i=e.next.next;!Ui(r,i)&&Ti(r,e,e.next,i)&&Di(r,i)&&Di(i,r)&&(n.push(r.i,e.i,i.i),_i(e),_i(e.next),e=t=i),e=e.next}while(e!==t);return qi(e)}function Ri(t,n,e,r,i,o){let u=t;do{let t=u.next.next;for(;t!==u.prev;){if(u.i!==t.i&&Fi(u,t)){let s=Bi(u,t);return u=qi(u,u.next),s=qi(s,s.next),$i(u,n,e,r,i,o,0),void $i(s,n,e,r,i,o,0)}t=t.next}u=u.next}while(u!==t)}function Pi(t,n,e,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function ji(t,n,e,r,i,o,u,s){return!(t===u&&n===s)&&function(t,n,e,r,i,o,u,s){return(i-u)*(n-s)>=(t-u)*(o-s)&&(t-u)*(r-s)>=(e-u)*(n-s)&&(e-u)*(o-s)>=(i-u)*(r-s)}(t,n,e,r,i,o,u,s)}function Fi(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){let e=t;do{if(e.i!==t.i&&e.next.i!==t.i&&e.i!==n.i&&e.next.i!==n.i&&Ti(e,e.next,t,n))return!0;e=e.next}while(e!==t);return!1}(t,n)&&(Di(t,n)&&Di(n,t)&&function(t,n){let e=t,r=!1;const i=(t.x+n.x)/2,o=(t.y+n.y)/2;do{e.y>o!=e.next.y>o&&e.next.y!==e.y&&i<(e.next.x-e.x)*(o-e.y)/(e.next.y-e.y)+e.x&&(r=!r),e=e.next}while(e!==t);return r}(t,n)&&(Ni(t.prev,t,n.prev)||Ni(t,n.prev,n))||Ui(t,n)&&Ni(t.prev,t,t.next)>0&&Ni(n.prev,n,n.next)>0)}function Ni(t,n,e){return(n.y-t.y)*(e.x-n.x)-(n.x-t.x)*(e.y-n.y)}function Ui(t,n){return t.x===n.x&&t.y===n.y}function Ti(t,n,e,r){const i=Ci(Ni(t,n,e)),o=Ci(Ni(t,n,r)),u=Ci(Ni(e,r,t)),s=Ci(Ni(e,r,n));return i!==o&&u!==s||!(0!==i||!zi(t,e,n))||!(0!==o||!zi(t,r,n))||!(0!==u||!zi(e,t,r))||!(0!==s||!zi(e,n,r))}function zi(t,n,e){return n.x<=Math.max(t.x,e.x)&&n.x>=Math.min(t.x,e.x)&&n.y<=Math.max(t.y,e.y)&&n.y>=Math.min(t.y,e.y)}function Ci(t){return t>0?1:t<0?-1:0}function Di(t,n){return Ni(t.prev,t,t.next)<0?Ni(t,n,t.next)>=0&&Ni(t,t.prev,n)>=0:Ni(t,n,t.prev)<0||Ni(t,t.next,n)<0}function Bi(t,n){const e=Vi(t.i,t.x,t.y),r=Vi(n.i,n.x,n.y),i=t.next,o=n.prev;return t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,o.next=r,r.prev=o,r}function Li(t,n,e,r){const i=Vi(t,n,e);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function _i(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Vi(t,n,e){return{i:t,x:n,y:e,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}Cr.basisTo2D=function(t,r,i){if(!n(t))throw new e("projection is required.");if(!n(r))throw new e("matrix is required.");if(!n(i))throw new e("result is required.");const o=Y.getTranslation(r,Mi),u=t.ellipsoid;let s;if(m.equals(o,m.ZERO))s=m.clone(m.ZERO,bi);else{const n=u.cartesianToCartographic(o,yi);s=t.project(n,bi),m.fromElements(s.z,s.x,s.y,s)}const c=Cr.eastNorthUpToFixedFrame(o,u,xi),a=Y.inverseTransformation(c,Ei),f=Y.getMatrix3(r,Ai),h=Y.multiplyByMatrix3(a,f,i);return Y.multiply(pi,h,i),Y.setTranslation(i,s,i),i},Cr.ellipsoidTo2DModelMatrix=function(t,r,i){if(!n(t))throw new e("projection is required.");if(!n(r))throw new e("center is required.");if(!n(i))throw new e("result is required.");const o=t.ellipsoid,u=Cr.eastNorthUpToFixedFrame(r,o,xi),s=Y.inverseTransformation(u,Ei),c=o.cartesianToCartographic(r,yi),a=t.project(c,bi);m.fromElements(a.z,a.x,a.y,a);const f=Y.fromTranslation(a,xi);return Y.multiply(pi,s,i),Y.multiply(f,i,i),i};var Hi,Yi,Zi,Wi,Qi,Ji,Gi={},Xi=function(){if(Zi)return Yi;Zi=1,Yi=n;var t=(Hi||(Hi=1,Gi.read=function(t,n,e,r,i){var o,u,s=8*i-r-1,c=(1<<s)-1,a=c>>1,f=-7,h=e?i-1:0,l=e?-1:1,d=t[n+h];for(h+=l,o=d&(1<<-f)-1,d>>=-f,f+=s;f>0;o=256*o+t[n+h],h+=l,f-=8);for(u=o&(1<<-f)-1,o>>=-f,f+=r;f>0;u=256*u+t[n+h],h+=l,f-=8);if(0===o)o=1-a;else{if(o===c)return u?NaN:1/0*(d?-1:1);u+=Math.pow(2,r),o-=a}return(d?-1:1)*u*Math.pow(2,o-r)},Gi.write=function(t,n,e,r,i,o){var u,s,c,a=8*o-i-1,f=(1<<a)-1,h=f>>1,l=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:o-1,w=r?1:-1,m=n<0||0===n&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(s=isNaN(n)?1:0,u=f):(u=Math.floor(Math.log(n)/Math.LN2),n*(c=Math.pow(2,-u))<1&&(u--,c*=2),(n+=u+h>=1?l/c:l*Math.pow(2,1-h))*c>=2&&(u++,c/=2),u+h>=f?(s=0,u=f):u+h>=1?(s=(n*c-1)*Math.pow(2,i),u+=h):(s=n*Math.pow(2,h-1)*Math.pow(2,i),u=0));i>=8;t[e+d]=255&s,d+=w,s/=256,i-=8);for(u=u<<i|s,a+=i;a>0;t[e+d]=255&u,d+=w,u/=256,a-=8);t[e+d-w]|=128*m}),Gi);function n(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}n.Varint=0,n.Fixed64=1,n.Bytes=2,n.Fixed32=5;var e=4294967296,r=1/e,i="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");function o(t){return t.type===n.Bytes?t.readVarint()+t.pos:t.pos+1}function u(t,n,e){return e?4294967296*n+(t>>>0):4294967296*(n>>>0)+(t>>>0)}function s(t,n,e){var r=n<=16383?1:n<=2097151?2:n<=268435455?3:Math.floor(Math.log(n)/(7*Math.LN2));e.realloc(r);for(var i=e.pos-1;i>=t;i--)e.buf[i+r]=e.buf[i]}function c(t,n){for(var e=0;e<t.length;e++)n.writeVarint(t[e])}function a(t,n){for(var e=0;e<t.length;e++)n.writeSVarint(t[e])}function f(t,n){for(var e=0;e<t.length;e++)n.writeFloat(t[e])}function h(t,n){for(var e=0;e<t.length;e++)n.writeDouble(t[e])}function l(t,n){for(var e=0;e<t.length;e++)n.writeBoolean(t[e])}function d(t,n){for(var e=0;e<t.length;e++)n.writeFixed32(t[e])}function w(t,n){for(var e=0;e<t.length;e++)n.writeSFixed32(t[e])}function m(t,n){for(var e=0;e<t.length;e++)n.writeFixed64(t[e])}function g(t,n){for(var e=0;e<t.length;e++)n.writeSFixed64(t[e])}function v(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+16777216*t[n+3]}function p(t,n,e){t[e]=n,t[e+1]=n>>>8,t[e+2]=n>>>16,t[e+3]=n>>>24}function y(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+(t[n+3]<<24)}return n.prototype={destroy:function(){this.buf=null},readFields:function(t,n,e){for(e=e||this.length;this.pos<e;){var r=this.readVarint(),i=r>>3,o=this.pos;this.type=7&r,t(i,n,this),this.pos===o&&this.skip(r)}return n},readMessage:function(t,n){return this.readFields(t,n,this.readVarint()+this.pos)},readFixed32:function(){var t=v(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=y(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=v(this.buf,this.pos)+v(this.buf,this.pos+4)*e;return this.pos+=8,t},readSFixed64:function(){var t=v(this.buf,this.pos)+y(this.buf,this.pos+4)*e;return this.pos+=8,t},readFloat:function(){var n=t.read(this.buf,this.pos,!0,23,4);return this.pos+=4,n},readDouble:function(){var n=t.read(this.buf,this.pos,!0,52,8);return this.pos+=8,n},readVarint:function(t){var n,e,r=this.buf;return n=127&(e=r[this.pos++]),e<128?n:(n|=(127&(e=r[this.pos++]))<<7,e<128?n:(n|=(127&(e=r[this.pos++]))<<14,e<128?n:(n|=(127&(e=r[this.pos++]))<<21,e<128?n:function(t,n,e){var r,i,o=e.buf;if(r=(112&(i=o[e.pos++]))>>4,i<128)return u(t,r,n);if(r|=(127&(i=o[e.pos++]))<<3,i<128)return u(t,r,n);if(r|=(127&(i=o[e.pos++]))<<10,i<128)return u(t,r,n);if(r|=(127&(i=o[e.pos++]))<<17,i<128)return u(t,r,n);if(r|=(127&(i=o[e.pos++]))<<24,i<128)return u(t,r,n);if(r|=(1&(i=o[e.pos++]))<<31,i<128)return u(t,r,n);throw new Error("Expected varint not more than 10 bytes")}(n|=(15&(e=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,n=this.pos;return this.pos=t,t-n>=12&&i?function(t,n,e){return i.decode(t.subarray(n,e))}(this.buf,n,t):function(t,n,e){for(var r="",i=n;i<e;){var o,u,s,c=t[i],a=null,f=c>239?4:c>223?3:c>191?2:1;if(i+f>e)break;1===f?c<128&&(a=c):2===f?128==(192&(o=t[i+1]))&&(a=(31&c)<<6|63&o)<=127&&(a=null):3===f?(o=t[i+1],u=t[i+2],128==(192&o)&&128==(192&u)&&((a=(15&c)<<12|(63&o)<<6|63&u)<=2047||a>=55296&&a<=57343)&&(a=null)):4===f&&(o=t[i+1],u=t[i+2],s=t[i+3],128==(192&o)&&128==(192&u)&&128==(192&s)&&((a=(15&c)<<18|(63&o)<<12|(63&u)<<6|63&s)<=65535||a>=1114112)&&(a=null)),null===a?(a=65533,f=1):a>65535&&(a-=65536,r+=String.fromCharCode(a>>>10&1023|55296),a=56320|1023&a),r+=String.fromCharCode(a),i+=f}return r}(this.buf,n,t)},readBytes:function(){var t=this.readVarint()+this.pos,n=this.buf.subarray(this.pos,t);return this.pos=t,n},readPackedVarint:function(t,e){if(this.type!==n.Bytes)return t.push(this.readVarint(e));var r=o(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==n.Bytes)return t.push(this.readSVarint());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==n.Bytes)return t.push(this.readBoolean());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==n.Bytes)return t.push(this.readFloat());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==n.Bytes)return t.push(this.readDouble());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==n.Bytes)return t.push(this.readFixed32());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==n.Bytes)return t.push(this.readSFixed32());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==n.Bytes)return t.push(this.readFixed64());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==n.Bytes)return t.push(this.readSFixed64());var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===n.Varint)for(;this.buf[this.pos++]>127;);else if(e===n.Bytes)this.pos=this.readVarint()+this.pos;else if(e===n.Fixed32)this.pos+=4;else{if(e!==n.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,n){this.writeVarint(t<<3|n)},realloc:function(t){for(var n=this.length||16;n<this.pos+t;)n*=2;if(n!==this.length){var e=new Uint8Array(n);e.set(this.buf),this.buf=e,this.length=n}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),p(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),p(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),p(this.buf,-1&t,this.pos),p(this.buf,Math.floor(t*r),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),p(this.buf,-1&t,this.pos),p(this.buf,Math.floor(t*r),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,n){var e,r;if(t>=0?(e=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(e=~(-t%4294967296))?e=e+1|0:(e=0,r=r+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn\'t fit into 10 bytes");n.realloc(10),function(t,n,e){e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos]=127&t}(e,0,n),function(t,n){var e=(7&t)<<4;n.buf[n.pos++]|=e|((t>>>=3)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t)))))}(r,n)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var n=this.pos;this.pos=function(t,n,e){for(var r,i,o=0;o<n.length;o++){if((r=n.charCodeAt(o))>55295&&r<57344){if(!i){r>56319||o+1===n.length?(t[e++]=239,t[e++]=191,t[e++]=189):i=r;continue}if(r<56320){t[e++]=239,t[e++]=191,t[e++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[e++]=239,t[e++]=191,t[e++]=189,i=null);r<128?t[e++]=r:(r<2048?t[e++]=r>>6|192:(r<65536?t[e++]=r>>12|224:(t[e++]=r>>18|240,t[e++]=r>>12&63|128),t[e++]=r>>6&63|128),t[e++]=63&r|128)}return e}(this.buf,t,this.pos);var e=this.pos-n;e>=128&&s(n,e,this),this.pos=n-1,this.writeVarint(e),this.pos+=e},writeFloat:function(n){this.realloc(4),t.write(this.buf,n,this.pos,!0,23,4),this.pos+=4},writeDouble:function(n){this.realloc(8),t.write(this.buf,n,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var n=t.length;this.writeVarint(n),this.realloc(n);for(var e=0;e<n;e++)this.buf[this.pos++]=t[e]},writeRawMessage:function(t,n){this.pos++;var e=this.pos;t(n,this);var r=this.pos-e;r>=128&&s(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,r){this.writeTag(t,n.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(t,n){n.length&&this.writeMessage(t,c,n)},writePackedSVarint:function(t,n){n.length&&this.writeMessage(t,a,n)},writePackedBoolean:function(t,n){n.length&&this.writeMessage(t,l,n)},writePackedFloat:function(t,n){n.length&&this.writeMessage(t,f,n)},writePackedDouble:function(t,n){n.length&&this.writeMessage(t,h,n)},writePackedFixed32:function(t,n){n.length&&this.writeMessage(t,d,n)},writePackedSFixed32:function(t,n){n.length&&this.writeMessage(t,w,n)},writePackedFixed64:function(t,n){n.length&&this.writeMessage(t,m,n)},writePackedSFixed64:function(t,n){n.length&&this.writeMessage(t,g,n)},writeBytesField:function(t,e){this.writeTag(t,n.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,n.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,n.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,n.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,n.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,n.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,n.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,n.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,n.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,n.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,n){this.writeVarintField(t,Boolean(n))}},Yi}(),Ki=a(Xi),to={},no=function(){if(Wi)return to;Wi=1;var t=to.Ring={};t.read=function(n,e){return n.readFields(t.zt,{path:[]},e)},t.zt=function(t,n,e){1===t&&e.readPackedVarint(n.path,!0)},t.write=function(t,n){t.path&&n.writePackedVarint(1,t.path)};var n=to.Building={};n.read=function(t,e){return t.readFields(n.zt,{minzoom:0,maxzoom:0,path:[],height:0,indoorid:"",altitude:0},e)},n.zt=function(n,e,r){1===n?e.minzoom=r.readVarint():2===n?e.maxzoom=r.readVarint():3===n?e.path.push(t.read(r,r.readVarint()+r.pos)):4===n?e.height=r.readVarint():5===n?e.indoorid=r.readString():6===n&&(e.altitude=r.readVarint(!0))},n.write=function(n,e){if(n.minzoom&&e.writeVarintField(1,n.minzoom),n.maxzoom&&e.writeVarintField(2,n.maxzoom),n.path)for(var r=0;r<n.path.length;r++)e.writeMessage(3,t.write,n.path[r]);n.height&&e.writeVarintField(4,n.height),n.indoorid&&e.writeStringField(5,n.indoorid),n.altitude&&e.writeVarintField(6,n.altitude)};var e=to.BuildingSameStyle={};e.read=function(t,n){return t.readFields(e.zt,{mainkey:0,subkey:0,items:[],resolution:0},n)},e.zt=function(t,e,r){1===t?e.mainkey=r.readVarint():2===t?e.subkey=r.readVarint():3===t?e.items.push(n.read(r,r.readVarint()+r.pos)):4===t&&(e.resolution=r.readVarint())},e.write=function(t,e){if(t.mainkey&&e.writeVarintField(1,t.mainkey),t.subkey&&e.writeVarintField(2,t.subkey),t.items)for(var r=0;r<t.items.length;r++)e.writeMessage(3,n.write,t.items[r]);t.resolution&&e.writeVarintField(4,t.resolution)};var r=to.BuildingLayer={};return r.read=function(t,n){return t.readFields(r.zt,{building:[]},n)},r.zt=function(t,n,r){1===t&&n.building.push(e.read(r,r.readVarint()+r.pos))},r.write=function(t,n){if(t.building)for(var r=0;r<t.building.length;r++)n.writeMessage(1,e.write,t.building[r])},to}(),eo=function(){if(Ji)return Qi;Ji=1;const t=2147483648;function n(t,n){const i=function(t,n){const i=r(t,n);let o=e(180),u=e(90);const s=o/(1<<i),c=u/(1<<i);return o=s>0?Math.floor(s+.5):Math.floor(s-.5),u=c>0?Math.floor(c+.5):Math.floor(c-.5),[o,u]}(t,n);return[2*i[0],2*i[1]]}function e(n){return Math.floor(n*t/180+.5)}function r(t,n){return 33-n-t}function i(n){return 180*n/t}function o(t,e){const r=n(t.z,e),i=r[0],o=r[1],u=1<<t.z;return[-i/2+t.x*i/u,o/2-(t.y+1)*o/u]}function u(t,n,e){const u=o(t,n),s=r(t.z,n);for(var c=[],a=0;a<e.length;a+=2){const t=e[a]+u[0];let n=t<<s;const r=e[a+1]+u[1]<<s;t>0&&n<0&&(n=2147483647);const o=i(n),f=i(r);c.push([o,f])}return c}function s(t){for(var n=0,e=2,r=t.length;e<r;e+=2)n+=((t[e]-t[e-2])**2+(t[e+1]-t[e-1])**2)**.5;return n}function c(t,n){for(var e=0,r=0,i=t.length;r<i;r+=2){var o=s(t.slice(r,r+4));if(!(o+e<n)){var u=(n-e)/o;return[Math.round(t[r]+u*(t[r+2]-t[r])),Math.round(t[r+1]+u*(t[r+3]-t[r+1])),r]}e+=o}return null}function a(t,n){n=n/180*Math.PI;let e=0,r=0,i=0;for(var o=2,u=t.length;o<u;o+=2){var s=t[o]-t[o-2],c=t[o+1]-t[o-1],a=(s**2+c**2)**.5;if(2==o)e=s,r=c,i=a;else{if(Math.acos((s*e+c*r)/a/i)>n)return!1;e=s,r=c,i=a}}return!0}return Qi={getWorldSize:n,riseLevel:function(t,n,i,s){return function(t,n,i){var u=t.z;const s=o(t,n),c=r(u,n);for(var a=[],f=0;f<i.length;f+=1){var h=i[f][0],l=i[f][1];l<-90&&(l=-90),l>90&&(l=90),h<-180&&(h=-180),h>180&&(h=180);let t=e(h),n=e(l);const r=t/(1<<c),o=n/(1<<c);t=r>0?Math.floor(r+.5):Math.floor(r-.5),n=o>0?Math.floor(o+.5):Math.floor(o-.5),t-=s[0],n-=s[1],a.push(t,n)}return a}(s,i-1,u(n,i,t))},ptsLength:s,getSmoothSlice:function(t,n,e){for(var r=function(t,n){var e=[],r=[],i=s(t);if(i>=n){for(var o=Math.floor(i/n),u=1;u<=o;u+=1)e.push(c(t,n*u));var a=[],f=[],h=0,l=void 0;for(u=0;u<e.length;u+=1){l=e[u][2]+2;var d=t.slice(h,l);f=[e[u][0],e[u][1]];for(var w=a.concat(d).concat(f),m=2;m<w.length;m+=2)w[m]===w[m-2]&&w[m+1]===w[m-1]&&(w.splice(m,2),m-=2);r.push(w),a=f,h=l}return r}}(t,n)||[],i=0;i<r.length;i+=1)a(r[i],e)||(r.splice(i,1),i-=1);return r},tileInnerCoords2LngLat:u,tileInnerCoord2LngLat:function(t,n,e,u){const s=o(t,n),c=e+s[0],a=u+s[1],f=r(t.z,n);return e=c<<f,u=a<<f,c>0&&e<0&&(e=2147483647),[i(e),i(u)]}}}();self.onmessage=function(t){!async function(t){const{coord:n,url:e,center:r}=t;try{const t=await fetch(e),i=await t.arrayBuffer(),o=new Ki(i),u=no.BuildingLayer.read(o),s=n.split("-").map((t=>parseInt(t,10))),c={z:s[0],x:s[1],y:s[2]},a=m.fromDegrees(...r),f=Cr.eastNorthUpToFixedFrame(a),h=Y.inverse(f,new Y);let l=[],d=[],w=[],g=[],v=0;for(let t=0;t<u.building.length;t++){const n=u.building[t];n.items.forEach((t=>{const{altitude:e,height:r}=t,i=t.path[0].path,o=eo.tileInnerCoords2LngLat(c,n.resolution,i),u=ki(o.flat()),s=u.length/3,a=o.length,f=o.map((t=>{const n=Y.multiplyByPoint(h,m.fromDegrees(t[0],t[1],e+0),new m);return[n.x,n.y,n.z]})),p=o.map((t=>{const n=Y.multiplyByPoint(h,m.fromDegrees(t[0],t[1],e+r+0),new m);return[n.x,n.y,n.z]})),y=m.fromArray(f[0]),b=m.fromArray(p[0]),M=m.subtract(b,y,new m),A=m.normalize(M,new m),x=m.multiplyByScalar(A,-1,new m);for(let t=0;t<a;t++)w.push(x.x,x.y,x.z),g.push(0);for(let t=0;t<a;t++)w.push(A.x,A.y,A.z),g.push(0);l=l.concat(f.flat(99),p.flat(99));for(let t=0;t<s;t+=1)d.push(v+u[3*t+2]),d.push(v+u[3*t+1]),d.push(v+u[3*t]);for(let t=0;t<s;t+=1)d.push(v+a+u[3*t]),d.push(v+a+u[3*t+1]),d.push(v+a+u[3*t+2]);for(let t=0;t<a;t++){const n=p[t],e=f[t],r=f[(t+1)%a],i=p[(t+1)%a];l.push(...n),l.push(...e),l.push(...r),l.push(...i),g.push(1,1,1,1);const o=new m(n[0]-e[0],n[1]-e[1],n[2]-e[2]),u=new m(r[0]-e[0],r[1]-e[1],r[2]-e[2]),s=m.cross(u,o,new m),c=m.normalize(s,new m);w.push(c.x,c.y,c.z,c.x,c.y,c.z,c.x,c.y,c.z,c.x,c.y,c.z),d.push(v+2*a+4*t+0),d.push(v+2*a+4*t+1),d.push(v+2*a+4*t+2),d.push(v+2*a+4*t+0),d.push(v+2*a+4*t+2),d.push(v+2*a+4*t+3)}v+=6*a}))}const p={id:n,coord:[c.z,c.x,c.y],vertices:new Float32Array(l),normals:new Float32Array(w),indices:new Uint16Array(d),faces:new Float32Array(g),model:f};self.postMessage({coord:n,status:3,data:p})}catch(t){self.postMessage({coord:n,status:4})}}(t.data)}},"function"==typeof define&&define.amd?define(factory):factory();\n'],{type:"application/javascript"}),n=URL.createObjectURL(e);this.worker=new Worker(n),this.worker.addEventListener("message",this.onMessage)}Vd=!1;onDrop=(t,e)=>{delete this.Bd[t],this.Vd=!0};async loadTileset(){try{const t=await fetch(this.tilesetUrl),e=await t.json();this.tileset=e}catch(t){}}getViewFrustum(){const t=this._scene.camera,e=this.tileset.metadata.enuCenterGCJ02,n=t.frustum.computeCullingVolume(t.positionWC,t.directionWC,t.upWC).planes,r=i.Cartesian3.fromDegrees(...e),o=i.Transforms.eastNorthUpToFixedFrame(r),s=i.Matrix4.inverse(o,new i.Matrix4),a=n.map((t=>{const e=new i.Cartesian3(t.x,t.y,t.z),n=t.w,r=i.Matrix4.multiplyByPointAsVector(s,e,new i.Cartesian3),o=i.Cartesian3.multiplyByScalar(e,-n,new i.Cartesian3),a=i.Matrix4.multiplyByPoint(s,o,new i.Cartesian3),u=-i.Cartesian3.dot(r,a);return new i.Cartesian4(r.x,r.y,r.z,u)}));return new i.CullingVolume(a)}getTileKey(t){return t.coord.join("-")}computeTilesToRender(){if(!this.tileset)return{};const t=this._scene.camera,{enuCenterGCJ02:e}=this.tileset.metadata,n=this.getViewFrustum(),r=this.tileset.root,o=Ic(t.position,e),s=t=>{const e=new i.Cartesian3(t[0],t[1],t[2]),n=new i.Cartesian3(t[0]-t[3],t[1]-t[7],t[2]-t[11]),r=new i.Cartesian3(t[0]+t[3],t[1]-t[7],t[2]-t[11]),s=new i.Cartesian3(t[0]-t[3],t[1]+t[7],t[2]-t[11]),a=new i.Cartesian3(t[0]+t[3],t[1]+t[7],t[2]-t[11]);return Math.min(i.Cartesian3.distance(o,e),i.Cartesian3.distance(o,n),i.Cartesian3.distance(o,r),i.Cartesian3.distance(o,s),i.Cartesian3.distance(o,a))},a={},u=r.boundingVolume.box,h=new i.Cartesian3(u[0]-u[3],u[1]-u[7],u[2]-u[11]),l=new i.Cartesian3(u[0]+u[3],u[1]+u[7],u[2]+u[11]),c=new i.AxisAlignedBoundingBox(h,l);if(n.computeVisibility(c)===i.Intersect.OUTSIDE)return a;let f=r.children.length;for(let t=0;t<f;t++){const e=r.children[t],o=e.boundingVolume.box,u=new i.Cartesian3(o[0]-o[3],o[1]-o[7],o[2]-o[11]),h=new i.Cartesian3(o[0]+o[3],o[1]+o[7],o[2]+o[11]),l=new i.AxisAlignedBoundingBox(u,h);if(n.computeVisibility(l)!==i.Intersect.OUTSIDE&&s(o)<2e3){const t=e.content.uri,n=t.startsWith("http")?t:this.Hd+"/"+t;a[this.getTileKey(e)]=n}}return a}get name(){return this.Jo}clock=null;get entities(){return this.Zo}get isLoading(){return this.ts}get changedEvent(){return this.es}get errorEvent(){return this.ns}get loadingEvent(){return this.rs}get show(){return this._show}set show(t){this._show=t}get clustering(){return this.ss}set clustering(t){if(!i.defined(t))throw new i.DeveloperError("value must be defined.");this.ss=t}update(){const t=Date.now();if(t-this.Ed<1e3)return!0;if(this.Ed=t,!this.tileset&&2!==this.Ld)return this.loadTileset(),!0;const e=this.computeTilesToRender(),n=this.tileChanged(this.Wd,e);if(this.Wd=e,!n&&!this.Vd)return!0;this.Vd=!1;const i=Object.keys(e);for(let t=0;t<i.length;t++){const n=i[t];this.We.Zi(n)||2===this.Bd[n]||this.worker.postMessage({coord:n,url:e[n],center:this.tileset.metadata.enuCenterGCJ02})}return this.changedEvent.raiseEvent(),!0}tileChanged(t,e){const n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!0;for(let t=0;t<n.length;t++)if(!e[n[t]])return!0;return!1}getData(){const t=this.Wd,e=Object.keys(t);let n=[];for(let t=0;t<e.length;t++){const i=this.We.Yi(e[t],!1);i&&n.push(i)}return n}onMessage=t=>{const{coord:e,status:n,data:i}=t.data;3===n?(this.We.Xi(e,i),this.Bd[e]=3,this.changedEvent.raiseEvent(e)):this.Bd[e]=4}}class Lm{show=!0;command;attributeLocations={position:0,normal:1,face:2};data;layer;wallColor;roofColor;createCommand(t){const e=i.RenderState.fromCache({depthTest:{enabled:!0},depthMask:!0,blending:i.BlendingState.ALPHA_BLEND});var n=new i.ShaderSource({sources:["in vec3 position;in vec3 normal;in float face;out vec3 v_positionEC;out vec3 v_normalEC;out float v_face;void main(){v_positionEC=(czm_modelView*vec4(position,1.0)).xyz;v_normalEC=czm_normal*normal;v_face=face;gl_Position=czm_modelViewProjection*vec4(position,1.0);}"]}),r=new i.ShaderSource({sources:["in vec3 v_positionEC;in vec3 v_normalEC;in float v_face;uniform vec4 u_roofColor;uniform vec4 u_wallColor;void main(){float lambert=dot(czm_sunDirectionEC,v_normalEC);lambert=0.8+lambert*0.2;vec3 color=(1.0-v_face)*u_roofColor.xyz+v_face*u_wallColor.xyz;out_FragColor=vec4(color*lambert,1.0);}"]}),o={u_wallColor:()=>this.wallColor,u_roofColor:()=>this.roofColor},s=i.ShaderProgram.fromCache({context:t,vertexShaderSource:n,fragmentShaderSource:r,attributeLocations:this.attributeLocations});return new i.DrawCommand({vertexArray:this.createVertexArray(t),primitiveType:i.PrimitiveType.TRIANGLES,renderState:e,shaderProgram:s,uniformMap:o,owner:this,pass:i.Pass.OPAQUE,modelMatrix:this.data.model})}createVertexArray(t){var e=new i.Geometry({attributes:{position:new i.GeometryAttribute({componentDatatype:i.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:this.data.vertices}),normal:new i.GeometryAttribute({componentDatatype:i.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:this.data.normals}),face:new i.GeometryAttribute({componentDatatype:i.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:this.data.faces})},indices:this.data.indices,primitiveType:i.PrimitiveType.TRIANGLES,boundingSphere:i.BoundingSphere.fromVertices(this.data.positions)});return i.VertexArray.fromGeometry({context:t,geometry:e,attributeLocations:this.attributeLocations,bufferUsage:i.BufferUsage.STATIC_DRAW})}constructor(t={}){this.data=t.data,this.layer=t.layer,this.wallColor=t.wallColor,this.roofColor=t.roofColor}update(t){this.show&&this.layer&&(i.defined(this.command)||(this.command=this.createCommand(t.context)),i.defined(this.command)&&t.commandList.push(this.command))}isDestroyed(){return!1}destroy(){return i.defined(this.command)&&(this.command.shaderProgram=this.command.shaderProgram&&this.command.shaderProgram.destroy()),i.destroyObject(this)}setWallColor(t){this.wallColor=t,this.command=null}setRoofColor(t){this.roofColor=t,this.command=null}}class Bm{show=!0;dataSource;Ln;_scene;ve=!1;cp=2e3;_dirty=!0;fp={};dp;set roofColor(t){this.dp=t,Object.keys(this.fp).forEach((e=>{this.fp[e].setRoofColor(t)})),this.requestRender()}get roofColor(){return this.dp}pp;set wallColor(t){this.pp=t,Object.keys(this.fp).forEach((e=>{this.fp[e].setWallColor(t)})),this.requestRender()}get wallColor(){return this.pp}set minDistance(t){this.cp=t,this.dataSource.minDistance=this.cp}get minDistance(){return this.cp}onData=()=>{this.ve||(this._dirty=!0,this.requestRender())};requestRender=()=>{this.Ln.scene.requestRender()};isDestroyed(){return this.ve}destroy(){this.dataSource.changedEvent.removeEventListener(this.onData),this.ve=!0,this.Ln.dataSources.remove(this.dataSource),Object.keys(this.fp).forEach((t=>{this._scene.primitives.remove(this.fp[t])})),this.requestRender()}constructor(t){this.pp=t.wallColor||new i.Color(.7,.7,.7,.7),this.dp=t.roofColor||new i.Color(.92,.92,.92,1),this.Ln=t.viewer,this._scene=t.viewer.scene,this.cp=t.minDistance||2e3,this.dataSource=new jm({scene:this._scene,tileset:t.tileset,minDistance:this.minDistance}),this.onData=Fm(this.onData,500,{maxWait:1e3}),this.dataSource.changedEvent.addEventListener(this.onData),this.Ln.dataSources.add(this.dataSource)}vp(t,e){const n=e.reduce(((t,e)=>(t[e.id]=e,t)),{}),i=Object.keys(t),r=[],o=[];for(let t=0;t<i.length;t++)n[i[t]]||r.push(i[t]);for(let n=0;n<e.length;n++)t[e[n].id]||o.push(e[n]);return{add:o,remove:r}}update(t){const e=this.dataSource.getData(),{add:n,remove:i}=this.vp(this.fp,e);for(let t=0;t<i.length;t++){const e=i[t];this._scene.primitives.remove(this.fp[e]),delete this.fp[e]}for(let t=0;t<n.length;t++){const e=n[t].id,i=new Lm({data:n[t],layer:this,wallColor:this.wallColor,roofColor:this.roofColor});this.fp[e]=i}Object.keys(this.fp).forEach((e=>{this.fp[e].update(t)}))}debugElements=[];visualizeTiles(){const e=this.dataSource.Wd,n=t=>{const[e,n,i]=t,r=Math.pow(2,e),o=360/r,s=180/r;return{bl:[n*o-180,90-(i+1)*s,0],br:[(n+1)*o-180,90-(i+1)*s,0],tl:[n*o-180,90-i*s,0],tr:[(n+1)*o-180,90-i*s,0]}},r=Object.keys(e).map((t=>t.split("-").map((t=>parseInt(t,10)))));this.debugElements.forEach((t=>this.Ln.entities.remove(t))),this.debugElements=[];for(let e=0;e<r.length;e++){const o=r[e],{bl:s,br:a,tl:u,tr:h}=n(o),l=t.Cartesian3.fromDegreesArray([s[0],s[1],a[0],a[1],h[0],h[1],u[0],u[1]]),c=this.Ln.entities.add({name:o.join("-"),polyline:{hierarchy:l,positions:l,material:i.Color.BLUE.withAlpha(.9),outline:!0,outlineColor:i.Color.RED,outlineWidth:10,width:8},disableDepthTestDistance:Number.POSITIVE_INFINITY});this.debugElements.push(c);const f=t.Cartesian3.fromDegrees((s[0]+h[0])/2,(s[1]+h[1])/2),d=this.Ln.entities.add({position:f,name:r.join("-"),label:{text:o.join("-"),fillColor:i.Color.WHITE,font:"20px sans-serif",disableDepthTestDistance:Number.POSITIVE_INFINITY}});this.debugElements.push(d)}this.Ln.scene.requestRender()}}class Hm{url;zoom;mp={};constructor(t){this.url=t?.url,this.zoom=t?.zoom||17}async sample(t,e){try{const n=function(t,e,n){const i=Math.pow(2,n),r=360/i,o=180/i;return[n,Math.floor(t/r)+i/2,i/2-Math.ceil(e/o)]}(t,e,this.zoom),i=n.join("_")+".bin",r=this.url.endsWith("/")?this.url+i:this.url+"/"+i;let o=this.mp[r];o||(o=this.yp(r));const s=await o;if(!s)return void delete this.mp[r];const{width:a,height:u,transform:h,data:l}=s,c=Math.floor((t-h[2])/h[0])+Math.floor((e-h[5])/h[4])*a;if(c>=0&&c<a*u){const t=l[c];if(-9999===t)return;return t}return}catch(t){return}}yp(t){const e=fetch(t).then((t=>{if(!t.ok)throw new Error(`HTTP status: ${t.status}`);return t.arrayBuffer()})).then((t=>{const e=new Uint32Array(t),n=e[0],i=e[1],r=new Float64Array(t,8);return{width:n,height:i,transform:[r[0],r[1],r[2],r[3],r[4],r[5]],data:new Int16Array(t,56)}})).catch((t=>null));return this.mp[t]=e,e}}const Wm=function(t,e){var n,i,r=t[0],o=t[1],s=e[0],a=e[1],u=s[0],h=s[1],l=a[0],c=a[1],f=l-u,d=c-h,p=0===f&&0===d?0:(f*(r-u)+d*(o-h))/(f*f+d*d||0);return p<=0?(n=u,i=h):p>=1?(n=l,i=c):(n=u+p*f,i=h+p*d),[n,i]},Vm=function(t,e){return((t[0]-e[0])**2+(t[1]-e[1])**2)**.5},Gm=function(t,e){var n=1/0;let i;for(let r=0;r<e.length;r+=1){const o=e[r];for(let e=0,r=1,s=o.length;r<s;e=r,r+=1){let s=Wm(t,[o[e],o[r]]);const a=Vm(s,t);a<n&&(n=a,i=s)}}return i},Ym=function(t,e){var n=1/0;let i;for(let r=0;r<e.length;r+=1){const o=e[r];let s=Gm(t,o);const a=Vm(s,t);a<n&&(n=a,i=s)}return i},Km=(t,e,n=!1)=>{const i=t[0],r=t[1];let o,s,a,u,h=!1;const l=e.length;for(let t=0,c=l-1;t<l;c=t,t+=1){let l=!1;if(o=e[t][0],s=e[t][1],a=e[c][0],u=e[c][1],o===i&&s===r||a===i&&u===r)return!!n;if(s<r==u>=r){const t=(a-o)*(r-s)/(u-s)+o;if(i===t)return!!n;l=i<t}l&&(h=!h)}return h},Xm=(t,e,n=!1)=>!!Km(t,e[0],n)&&!e.slice(1).find((e=>Km(t,e,!n))),Qm=(t,e,n=!1)=>!!e.find((e=>Xm(t,e,n))),Zm=(t,e)=>{let n=0;if(t[0]===e[0])n=t[1]>e[1]?Math.PI:0;else if(t[1]===e[1])n=t[0]>e[0]?Math.PI/2:-Math.PI/2;else{const i=t[0]-e[0],r=t[1]-e[1];n=Math.atan(i/r),i>0&&r>0?n=Math.PI-n:i<0&&r<0||i>0&&r<0?n=-n:i<0&&r>0&&(n=Math.PI-n)}return n};var Jm=Ym,ty=(t,e)=>{const n=9e-6,i=t.map((t=>{const e=t.map((t=>[t[0]*n,t[1]*n])),i=e.length;return e[0][0]===e[i-1][0]&&e[0][1]===e[i-1][1]||e.push(e[0]),e})),r=Bd(function(t,e,n={}){for(const e of t){if(e.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(e[e.length-1].length!==e[0].length)throw new Error("First and last Position are not equivalent.");for(let t=0;t<e[e.length-1].length;t++)if(e[e.length-1][t]!==e[0][t])throw new Error("First and last Position are not equivalent.")}return hf({type:"Polygon",coordinates:t},e,n)}(i),e/1e3,{units:"kilometers",steps:1});if(r)return"MultiPolygon"==r.geometry.type?r.geometry.coordinates.map(((t,e)=>t.map((t=>t.map((t=>[t[0]/n,t[1]/n])))))):[r.geometry.coordinates.map((t=>t.map((t=>[t[0]/n,t[1]/n]))))]},ey=Qm;const ny={distance:Vm,distanceToLineString:function(t,e){let n=1/0;for(let i=0,r=1,o=e.length;r<o;i=r,r+=1){const o=Wm(t,[e[i],e[r]]);n=Math.min(n,Vm(o,t))}return n},closestOnSegment:Wm,closestOnLineString:function(t,e){var n=1/0;let i;for(let r=0,o=1,s=e.length;o<s;r=o,o+=1){let s=Wm(t,[e[r],e[o]]);const a=Vm(s,t);a<n&&(n=a,i=s)}return i},closestOnMultiLineString:Gm,closestOnMultiPolygon:Ym,pointInMultiPolygon:Qm,pointInPolygon:Xm,pointInRing:Km,dividePathByUnit:(t,e,n=0)=>{if(!e)return[];n%=e;const i=[0],r=t.length;for(let e=1;e<r;e+=1){const n=t[e][0]-t[e-1][0],r=t[e][1]-t[e-1][1];i[e]=i[e-1]+(n**2+r**2)**.5}const o=[];let s=0;for(let a=1;a<r;a+=1)if(i[a]-n-s*e>=e-1e-8){let r=i[a]-n-e*s;const u=Math.floor((r+1e-8)/e);s+=u,r=i[a]-n-e*s;const h=Zm(t[a-1],t[a]);for(let n=0;n<u;n+=1){const s=(r+e*(u-1-n))/(i[a]-i[a-1]),l=[t[a][0]-s*(t[a][0]-t[a-1][0]),t[a][1]-s*(t[a][1]-t[a-1][1]),void 0!==t[a][2]?t[a][2]-s*(t[a][2]-t[a-1][2]):0,h];o.push(l)}}return o}};var iy=2*Math.PI;class ry{Wn;wp;gp;bp;_p;xp;kp;$p;Sp;Ep;Mp;Cp=0;ce;Ap;Op;Ip;Tp;zp;Rp;Fp;Dp;Hn;Pp;Np=0;constructor(t,e,n){this.Pp=n;var i=void 0===(e=e||{}).title?"joystick":e.title,r=void 0===e.width?0:e.width,o=void 0===e.height?0:e.height;this.Ap=void 0===e.internalFillColor?"rgba(255,255,255,0.4)":e.internalFillColor,this.Op=void 0===e.internalLineWidth?2:e.internalLineWidth,this.Ip=void 0===e.internalStrokeColor?"rgba(255,255,255,0.6)":e.internalStrokeColor,this.Tp=void 0===e.externalLineWidth?2:e.externalLineWidth,this.zp=void 0===e.externalStrokeColor?"rgba(255,255,255,0.3)":e.externalStrokeColor,this.Rp=void 0===e.autoReturnToCenter||e.autoReturnToCenter;var s=t;s.style.touchAction="none";var a=document.createElement("canvas");this.Wn=a,a.style.width="100%",a.id=i,0===r&&(r=s.clientWidth),0===o&&(o=s.clientHeight),a.width=r,a.height=o,s.appendChild(a),this.Hn=t,this.ce=a.getContext("2d"),this.Fp=a.width/4-12,this.xp=this.Fp+20,this.Dp=this.Fp+30,this.bp=a.width/2,this._p=a.height/2,this.Sp=a.width/10,this.Ep=-1*this.Sp,this.kp=a.height/10,this.$p=-1*this.kp,this.wp=this.bp,this.gp=this._p,this.Hn.style.display="none",this.Up(),this.qp(),this.Mp=null,this.jp=this.jp.bind(this),this.Lp=this.Lp.bind(this),this.Bp=this.Bp.bind(this),this.Hp=this.Hp.bind(this),this.Wp=this.Wp.bind(this),this.Vp=this.Vp.bind(this)}Up=()=>{this.ce.beginPath(),this.ce.arc(this.bp,this._p,this.Dp,0,iy,!1),this.ce.shadowBlur=5,this.ce.shadowColor="white",this.ce.lineWidth=this.Tp,this.ce.strokeStyle=this.zp,this.ce.stroke()};qp=()=>{this.ce.beginPath();const t=this.wp-this.bp,e=this.gp-this._p,n=(t**2+e**2)**.5;if(n>this.xp){const i=this.xp/n;this.wp=i*t+this.bp,this.gp=i*e+this._p}this.ce.arc(this.wp,this.gp,this.Fp,0,iy,!1);var i=this.ce.createRadialGradient(this.bp,this._p,5,this.bp,this._p,200);i.addColorStop(0,this.Ap),i.addColorStop(1,this.Ip),this.ce.shadowBlur=5,this.ce.shadowColor="white",this.ce.fillStyle=i,this.ce.fill(),this.ce.lineWidth=this.Op,this.ce.strokeStyle=this.Ip,this.ce.stroke()};Hp(t){0==this.Cp&&1==t.touches.length&&(this.Cp=1)}Wp(t){1===this.Cp&&1==t.touches.length&&(this.wp=t.touches[0].pageX,this.gp=t.touches[0].pageY,"BODY"===this.Wn.offsetParent.tagName.toUpperCase()?(this.wp-=this.Wn.offsetLeft,this.gp-=this.Wn.offsetTop):(this.wp-=this.Wn.offsetParent.offsetLeft,this.gp-=this.Wn.offsetParent.offsetTop),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Up(),this.qp())}Vp(t){t.touches[0]||(this.Cp=0,this.Rp&&(this.wp=this.bp,this.gp=this._p),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Up(),this.qp())}jp(t){t.stopPropagation(),this.Cp=1}Lp(t){1===this.Cp&&(t.stopPropagation(),this.wp=t.pageX,this.gp=t.pageY,"BODY"===this.Wn.offsetParent.tagName.toUpperCase()?(this.wp-=this.Wn.offsetLeft,this.gp-=this.Wn.offsetTop):(this.wp-=this.Wn.offsetParent.offsetLeft,this.gp-=this.Wn.offsetParent.offsetTop),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Up(),this.qp())}Bp(t){this.Cp=0,this.Rp&&(this.wp=this.bp,this.gp=this._p),this.ce.clearRect(0,0,this.Wn.width,this.Wn.height),this.Up(),this.qp()}open(){"ontouchstart"in document.documentElement?(this.Wn.addEventListener("touchstart",this.Hp,!0),document.addEventListener("touchmove",this.Wp,!0),document.addEventListener("touchend",this.Vp,!0)):(this.Wn.addEventListener("mousedown",this.jp,!0),document.addEventListener("mousemove",this.Lp,!0),document.addEventListener("mouseup",this.Bp,!0)),this.Hn.style.display="block",this.Np=window.setInterval((()=>{this.Pp({x:this.GetX(),y:this.GetY()})}),50)}close(){"ontouchstart"in document.documentElement?(this.Wn.removeEventListener("touchstart",this.Hp),document.removeEventListener("touchmove",this.Wp),document.removeEventListener("touchend",this.Vp)):(this.Wn.removeEventListener("mousedown",this.jp),document.removeEventListener("mousemove",this.Lp),document.removeEventListener("mouseup",this.Bp)),this.Hn.style.display="none",clearInterval(this.Np),this.Np=0}getCardinalDirection(){let t="",e=this.wp-this.bp,n=this.gp-this._p;return n>=this.$p&&n<=this.kp&&(t="C"),n<this.$p&&(t="N"),n>this.kp&&(t="S"),e<this.Ep&&("C"===t?t="W":t+="W"),e>this.Sp&&("C"===t?t="E":t+="E"),t}GetWidth(){return this.Wn.width}GetHeight(){return this.Wn.height}GetPosX(){return this.wp}GetPosY(){return this.gp}GetX(){return parseFloat(((this.wp-this.bp)/this.xp*100).toFixed())}GetY(){return parseFloat(((this.gp-this._p)/this.xp*100*-1).toFixed())}GetDir(){return this.getCardinalDirection()}}class oy{_o="closed";us;Xc;qf;Gp=new t.Cartesian2;Yp=new t.Cartesian2;pd;ef;Kp;Xp;Ws;Qp;Zp=!1;Jp={};wf=[];tv=0;bf=0;ev=1;Qn=!1;nv;iv;nf=0;rv=0;ov=-10;sv;av;uv;hv;lv;constructor(t){t.isIndoor?this.Ws=new nf(1,1,.1):this.Ws=new nf(1,1,.01),t.buffer=t.buffer||.2,t.speed=t.speed||1,t.steeringSpeed=t.steeringSpeed||10,t.lookingMode=t.lookingMode||"scene",t.fixSpeedByHeight=null==t.fixSpeedByHeight||t.fixSpeedByHeight,t.isIndoor&&(t.fixSpeedByHeight=!1),this.us=t,this.Zp="fixedLine"===t.lookingMode,this.ev=t.fixedLineMoveSpeed||1,this.Zp&&t.cameraInfos&&(this.Jp=t.cameraInfos,this.wf=t.cameraInfos.map((t=>t.position)),this.tv=1e3*np({type:"Feature",properties:{},geometry:{type:"LineString",coordinates:this.wf}},{units:"kilometers"}));const e=t.viewer.canvas;e.setAttribute("tabindex","0"),e.onclick=function(){e.focus()},this.ef=[],this.pd=new i.ScreenSpaceEventHandler(e),this.rf=this.rf.bind(this),this.if=this.if.bind(this),this.sf=this.sf.bind(this),this.cv();const n=document.createElement("div");n.style.cssText="width:150px;height:150px;position:absolute;bottom:50px;left:0;border-radius:100%",this.Qp=n,this.Xp=new ry(n,{width:150,height:150,externalLineWidth:1,internalLineWidth:1},this.fv.bind(this));const r=this.us.yunjingLayer.ws.xo();r?(this.uv=r,this.dv(r)):this.us.yunjingLayer.on("configloaded",(t=>{this.uv=t,this.dv(t)}))}dv(t){const e=t.limitBounds;if(e&&e.polygon){const t=e.polygon;if(this.us.buffer){const n=ty(t,-this.us.buffer);n&&(this.hv={multiPolygon:n,minz:e.minz,maxz:e.maxz});const i=ty(t,-this.us.buffer-.01);i&&(this.lv={multiPolygon:i,minz:e.minz,maxz:e.maxz})}else{this.hv={multiPolygon:[t],minz:e.minz,maxz:e.maxz};const n=ty(t,-.01);n&&(this.lv={multiPolygon:n,minz:e.minz,maxz:e.maxz})}}}fv(t){if(this.Kp,t.x||t.y){const e=i.Cartographic.fromCartesian(this.us.viewer.camera.positionWC,void 0,this.pv);let n=.05*this.us.speed;this.us.fixSpeedByHeight&&(n*=Math.max(1.8,e.height-this.us.yunjingLayer.getBaseHeight())/2),"fixedLine"===this.us.lookingMode?(n*=t.y,this.moveByLine(t.y>0?"forward":"backward",t.y)):this.move([t.x,t.y,0],n,!0)}}cv(){}vv(){const t=this.us.yunjingLayer.$i().map((t=>t.Vt));if(0===t.length)return;const e=new Set,n={},i=this.us.boxesSize||.5;for(var r=0;r<t.length;r++){const s=t[r],a=s.byteLength/4/3;if(a<=0)continue;const u=new Float32Array(s);for(var o=0;o<a;o+=1){const t=3*o,r=u[t],s=u[t+1],a=u[t+2],h=`${Math.floor(r/i)}_${Math.floor(s/i)}_${Math.floor(a/i)}`;e.has(h)?n[h]+=1:(e.add(h),n[h]=1)}}if(!(e.size<=0)){for(let t in n)n[t]<20&&e.delete(t);this.Kp={isCode:!0,dis:i,codes:e}}}mv(t){let e=this.uv.enuCenter;const n={},r=[];t.forEach((t=>{const o=[(t[0]+t[3])/2,(t[1]+t[4])/2,(t[2]+t[5])/2],s=[Math.abs(t[0]-t[3])/1,Math.abs(t[1]-t[4])/1,Math.abs(t[2]-t[5])/1];let a=zc(new i.Cartesian3(...o),e),u=Rc(a);const h=`${Math.round(t[0]/5)}_${Math.round(t[1]/5)}`,l={bbox:t,center:u,alt:t[5],ecef:a,size:s,radius:Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2])/2};n[h]?n[h].push(l):n[h]=[l],r.push(l)}));const o=[],s=r.length;for(let t=0;t<s;t++){const{center:e,size:n,alt:s}=r[t],a=new i.Cartesian3(...n),u=i.Matrix4.multiplyByTranslation(i.Transforms.eastNorthUpToFixedFrame(i.Cartesian3.fromDegrees(e.lng,e.lat,e.height)),new i.Cartesian3(0,0,0),new i.Matrix4),h=new i.GeometryInstance({geometry:i.BoxGeometry.fromDimensions({vertexFormat:i.VertexFormat.POSITION_AND_NORMAL,dimensions:a}),modelMatrix:u,attributes:{color:i.ColorGeometryInstanceAttribute.fromColor(new i.Color(1,(150-Math.min(150,s))/150,(150-Math.min(150,s))/150,.6))}});o.push(h)}this.us.viewer.scene.primitives.add(new i.Primitive({geometryInstances:o,appearance:new i.PerInstanceColorAppearance({translucent:!0,closed:!0,renderState:{depthTest:{enabled:!0}}})}))}static Jc=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyA","KeyS","KeyD","KeyW","KeyQ","KeyE"];open(){if("openning"==this._o)return;this._o="openning";const e=this.us.viewer,n=e.scene;n.screenSpaceCameraController.enableRotate=!1,n.screenSpaceCameraController.enableTranslate=!1,n.screenSpaceCameraController.enableZoom=!1,n.screenSpaceCameraController.enableLook=!1,n.screenSpaceCameraController.yv/=3,this.Gp.x=this.Gp.y=0,this.Yp.x=this.Yp.y=0,this.qf={inertiaing:!1,looking:!1,moveForward:!1,moveBackward:!1,moveUp:!1,moveDown:!1,moveLeft:!1,moveRight:!1,dragging:!1,noObstacleAvoidance:!1};const r=this.pd,o=-1!==navigator.userAgent.toLowerCase().indexOf("mobile"),s=t=>{this.qf.inertiaing=!1,this.qf.looking=!0,this.qf.dragging=!1,this.Yp.x=this.Gp.x=t.position.x,this.Yp.y=this.Gp.y=t.position.y},a=()=>{this.qf.inertiaing=!1,this.qf.looking=!1,this.qf.dragging=!1,this.Xc=void 0},u=e=>{this.qf.inertiaing=!1,this.qf.dragging=!0,this.qf.looking=!1,this.Yp.x=this.Gp.x=e.position.x,this.Yp.y=this.Gp.y=e.position.y;const n=this.us.viewer.camera;let r;if(this.us.isIndoor)r=new t.Cartesian3(0,0,-1.5);else{const e=i.Cartographic.fromCartesian(n.positionWC,void 0,this.pv);r=new t.Cartesian3(0,0,-(e.height-this.us.yunjingLayer.getBaseHeight()))}this.Ws.Rs(new t.Cartesian3,r),this.nv=this.Js(this.Yp),this.rv=(new Date).getTime(),this.iv=void 0},h=()=>{if(this.qf.dragging=!1,!this.us.isIndoor&&this.iv&&(new Date).getTime()-this.rv<10){this.qf.inertiaing=!0;const e=this.us.viewer.camera,n=i.Cartographic.fromCartesian(e.positionWC,void 0,this.pv);let r=this.ov;this.us.fixSpeedByHeight&&(r*=Math.max(1.8,n.height-this.us.yunjingLayer.getBaseHeight())/2);const o=this.iv,s=t.Cartesian2.magnitude(this.iv);let a=s/Math.abs(r);a=Math.min(1,a),r=-s/a;const u=(o.x<0?-1:1)*Math.abs(o.x/s)*r,h=(o.y<0?-1:1)*Math.abs(o.y/s)*r;this.sv=u,this.av=h}else this.iv=void 0;this.Xc=void 0},l=t=>{(this.qf.looking||this.qf.dragging)&&(this.Yp=i.Cartesian2.clone(t.endPosition,this.Yp)),(this.qf.dragging||this.qf?.inertiaing)&&this.wv()},c=this.us.viewer.camera,f=e=>{if(this.qf.inertiaing=!1,e.distance){if(e.distance.startPosition.y===e.distance.endPosition.y)return;e=5*(e.distance.endPosition.y-e.distance.startPosition.y)}const n=i.Cartographic.fromCartesian(c.positionWC,void 0,this.pv),r=this.uv.enuCenter;if(!r)return;let o=(this.us.isIndoor?1.5:Math.max(1.8,n.height-this.us.yunjingLayer.getBaseHeight()))*e/1e3;const s=new i.Cartesian3;i.Cartesian3.add(c.positionWC,i.Cartesian3.multiplyByScalar(c.directionWC,o,s),s);const a=Ic(s,r,this.gv);if(!this.bv(a)){const e=this._v(a);if(!e)return;{const n=Tc(e,r);t.Cartesian3.fromRadians(n[0],n[1],n[2],void 0,s)}}c.setView({destination:s,orientation:{heading:c.heading,pitch:c.pitch,roll:0}})};r.setInputAction(f,i.ScreenSpaceEventType.WHEEL),r.setInputAction(f,i.ScreenSpaceEventType.PINCH_MOVE),r.setInputAction(f,i.ScreenSpaceEventType.WHEEL,i.KeyboardEventModifier.SHIFT),r.setInputAction(f,i.ScreenSpaceEventType.WHEEL),r.setInputAction(f,i.ScreenSpaceEventType.PINCH_MOVE),r.setInputAction(f,i.ScreenSpaceEventType.WHEEL,i.KeyboardEventModifier.SHIFT),document.addEventListener("keydown",this.if,!1),document.addEventListener("keyup",this.sf,!1),this.nf=requestAnimationFrame(this.rf),o?(e._element.appendChild(this.Qp),this.Xp.open(),r.setInputAction(s,i.ScreenSpaceEventType.LEFT_DOWN),r.setInputAction(a,i.ScreenSpaceEventType.LEFT_UP),r.setInputAction(l,i.ScreenSpaceEventType.MOUSE_MOVE)):(r.setInputAction(s,i.ScreenSpaceEventType.RIGHT_DOWN),r.setInputAction(s,i.ScreenSpaceEventType.RIGHT_DOWN,i.KeyboardEventModifier.SHIFT),r.setInputAction(a,i.ScreenSpaceEventType.RIGHT_UP),r.setInputAction(a,i.ScreenSpaceEventType.RIGHT_UP,i.KeyboardEventModifier.SHIFT),r.setInputAction(u,i.ScreenSpaceEventType.LEFT_DOWN),r.setInputAction(u,i.ScreenSpaceEventType.LEFT_DOWN,i.KeyboardEventModifier.SHIFT),r.setInputAction(h,i.ScreenSpaceEventType.LEFT_UP),r.setInputAction(h,i.ScreenSpaceEventType.LEFT_UP,i.KeyboardEventModifier.SHIFT),r.setInputAction(l,i.ScreenSpaceEventType.MOUSE_MOVE),r.setInputAction(l,i.ScreenSpaceEventType.MOUSE_MOVE,i.KeyboardEventModifier.SHIFT));const d=new t.Quaternion,p=new t.Matrix3,v=new t.Cartesian3;return c.rotate=(e,n)=>{if(n){const r=this.uv.enuCenter,o=n,s=t.Quaternion.fromAxisAngle(e,-o,d),a=t.Matrix3.fromQuaternion(s,p);t.Matrix3.multiplyByVector(a,c.position,v);const u=c._actualTransform;i.Matrix4.multiplyByPoint(u,v,v);const h=Ic(v,r,this.gv);if(!this.bv(h))return}i.Camera.prototype.rotate.call(c,e,n)},this}close(){const t=-1!==navigator.userAgent.toLowerCase().indexOf("mobile");document.removeEventListener("keydown",this.if),document.removeEventListener("keyup",this.sf),this.nf&&cancelAnimationFrame(this.nf),this.ef=[],this.Xc=void 0;const e=this.us.viewer,n=e.scene;n.screenSpaceCameraController.enableRotate=!0,n.screenSpaceCameraController.enableTranslate=!0,n.screenSpaceCameraController.enableZoom=!0,n.screenSpaceCameraController.enableTilt=!0,n.screenSpaceCameraController.enableLook=!0,n.screenSpaceCameraController.yv*=3;const r=this.pd;t?(e._element.removeChild(this.Qp),this.Xp.close(),r.removeInputAction(i.ScreenSpaceEventType.LEFT_DOWN),r.removeInputAction(i.ScreenSpaceEventType.LEFT_UP),r.removeInputAction(i.ScreenSpaceEventType.MOUSE_MOVE)):(r.removeInputAction(i.ScreenSpaceEventType.RIGHT_DOWN),r.removeInputAction(i.ScreenSpaceEventType.RIGHT_DOWN,i.KeyboardEventModifier.SHIFT),r.removeInputAction(i.ScreenSpaceEventType.RIGHT_UP),r.removeInputAction(i.ScreenSpaceEventType.RIGHT_UP,i.KeyboardEventModifier.SHIFT),r.removeInputAction(i.ScreenSpaceEventType.LEFT_DOWN),r.removeInputAction(i.ScreenSpaceEventType.LEFT_DOWN,i.KeyboardEventModifier.SHIFT),r.removeInputAction(i.ScreenSpaceEventType.LEFT_UP),r.removeInputAction(i.ScreenSpaceEventType.LEFT_UP,i.KeyboardEventModifier.SHIFT),r.removeInputAction(i.ScreenSpaceEventType.MOUSE_MOVE),r.removeInputAction(i.ScreenSpaceEventType.MOUSE_MOVE,i.KeyboardEventModifier.SHIFT)),r.removeInputAction(i.ScreenSpaceEventType.WHEEL),r.removeInputAction(i.ScreenSpaceEventType.PINCH_MOVE),r.removeInputAction(i.ScreenSpaceEventType.WHEEL,i.KeyboardEventModifier.SHIFT),this.us.viewer.camera.rotate=i.Camera.prototype.rotate}set speed(t){this.us.speed=t||.5}if(t){if(this.qf.inertiaing=!1,"Shift"==t.key)return void(this.qf.noObstacleAvoidance=!0);const e={ArrowDown:"ArrowUp",ArrowUp:"ArrowDown",ArrowLeft:"ArrowRight",ArrowRight:"ArrowLeft",KeyA:"KeyD",KeyD:"KeyA",KeyS:"KeyW",KeyW:"KeyS"};if(-1!==oy.Jc.indexOf(t.code)&&-1==this.ef.indexOf(t.code)){if(e[t.code]){const n=this.ef.indexOf(e[t.code]);-1!==n&&this.ef.splice(n,1)}this.ef.push(t.code)}}sf(t){if("Shift"==t.key)return void(this.qf.noObstacleAvoidance=!1);const e=-1!==oy.Jc.indexOf(t.code),n=this.ef.indexOf(t.code);e&&-1!==n&&this.ef.splice(n,1),this.Xc=void 0}xv=new i.Ray;Js(e){const n=this.us.viewer.camera,r=i.Cartographic.fromCartesian(n.positionWC,void 0,this.pv),o=[180*r.longitude/Math.PI,180*r.latitude/Math.PI,r.height],s=n.getPickRay(e,this.xv),a=t.Cartesian3.add(s.origin,s.direction,s.origin),u=new t.Cartesian3;let h;return t.Cartesian3.normalize(Ic(a,o,a),u),h=this.us.isIndoor?new t.Cartesian3(0,0,-1.5):new t.Cartesian3(0,0,-(r.height-this.us.yunjingLayer.getBaseHeight())),this.Ws.Rs(new t.Cartesian3,h),this.Ws.Fs(u,!0)}pv=new i.Cartographic;wv(){const e=(new Date).getTime(),n=this.uv.enuCenter;if(!this.ef.length&&!this.qf?.looking&&this.qf?.dragging&&n){const r=this.us.viewer.camera,o=i.Cartographic.fromCartesian(r.positionWC,void 0,this.pv);this.Gp.x=this.Yp.x,this.Gp.y=this.Yp.y;const s=this.Js(this.Yp);if(this.nv){const a=t.Cartesian3.subtract(s,this.nv,this.gv);if(a.x||a.y){this.iv=t.Cartesian2.multiplyByScalar(a,1e3/(e-this.rv),this.iv||new t.Cartesian2);const s=i.Math.toDegrees(o.longitude),u=i.Math.toDegrees(o.latitude),h=i.Cartesian3.fromElements(-a.x,-a.y,0,this.gv);let l=new t.Cartesian3;l=zc(h,[s,u,o.height],void 0,l);let c=Rc(l);const f=Mc([c.lng,c.lat,o.height],n);if(this.bv(f))r.setView({destination:t.Cartesian3.fromDegrees(c.lng,c.lat,o.height,void 0,l),orientation:{heading:r.heading,pitch:r.pitch,roll:0}});else{const e=this._v(f);if(e){const i=Tc(e,n);r.setView({destination:t.Cartesian3.fromRadians(i[0],i[1],o.height,void 0,l),orientation:{heading:r.heading,pitch:r.pitch,roll:0}})}}}else this.iv=void 0}this.nv=s,this.rv=e}}rf(){this.nf=0;const e=this.uv?.enuCenter;if(e){const n=this.us.viewer.camera,r=i.Cartographic.fromCartesian(n.positionWC,void 0,this.pv);if(this.ef.length||this.qf?.looking){let o=0,s=0,a=0;if(this.ef.length){const t=(new Date).getTime();if(this.Xc&&t-this.Xc){let e=(t-this.Xc)/1e3*this.us.speed;this.us.fixSpeedByHeight&&(e*=Math.max(1.8,r.height-this.us.yunjingLayer.getBaseHeight())/2);let i=0;switch(this.ef.sort().join(",")){case"ArrowUp":case"KeyW":i=0;break;case"ArrowDown":case"KeyS":i=180;break;case"ArrowLeft":case"KeyA":i=-90;break;case"ArrowRight":case"KeyD":i=90;break;case"ArrowDown,ArrowLeft":case"KeyA,KeyS":i=-135;break;case"ArrowDown,ArrowRight":case"KeyD,KeyS":i=135;break;case"ArrowLeft,ArrowUp":case"KeyA,KeyW":i=-45;break;case"ArrowRight,ArrowUp":case"KeyD,KeyW":i=45;break;case"KeyQ":i=0,a=1;break;case"KeyE":i=0,a=-1}i=n.heading+i*Math.PI/180,o=Math.sin(i)*e,s=Math.cos(i)*e,a&&(a*=e,o=s=0)}this.Xc=t}else this.Xc=void 0;let u=0,h=0;const l=this.us.viewer.canvas,c=l.clientWidth,f=l.clientHeight,d=(this.Yp.x-this.Gp.x)/c,p=-(this.Yp.y-this.Gp.y)/f,v=30;u=d*v*Math.PI/180*2,h=p*v*Math.PI/180,"scene"==this.us.lookingMode&&(u=-u,h=-h),this.Gp.x=this.Yp.x,this.Gp.y=this.Yp.y;const m=i.Math.toDegrees(r.longitude),y=i.Math.toDegrees(r.latitude);let w=zc(new i.Cartesian3(o,s,a),[m,y,r.height]);const g=Ic(w,e);if(!this.bv(g)){const i=this._v(g);if(i){const n=Tc(i,e);t.Cartesian3.fromRadians(n[0],n[1],r.height,void 0,w)}else w.x=n.positionWC.x,w.y=n.positionWC.y,w.z=n.positionWC.z}n.setView({destination:w,orientation:{heading:n.heading+u,pitch:Math.max(-90,Math.min(this.us.yunjingLayer.getMaxPitch(),n.pitch+h)),roll:0}})}else if(this.qf?.inertiaing&&this.iv){const o=(new Date).getTime(),s=this.iv,a=this.sv,u=this.av;let h;h=Math.abs(a)>Math.abs(u)?Math.abs(s.x)/Math.abs(a):Math.abs(s.y)/Math.abs(u);let l,c,f=(o-this.rv)/1e3;if(f>=h&&(f=h),l=s.x*f+.5*a*f*f,c=s.y*f+.5*u*f*f,this.iv.x=s.x+a*f,this.iv.y=s.y+u*f,l||c){const o=i.Math.toDegrees(r.longitude),s=i.Math.toDegrees(r.latitude);let a=zc(i.Cartesian3.fromElements(-l,-c,0,this.gv),[o,s,r.height],void 0,new t.Cartesian3);const u=Ic(a,e,this.gv);if(!this.bv(u)){const i=this._v(u);if(i){const n=Tc(i,e);t.Cartesian3.fromRadians(n[0],n[1],r.height,void 0,a)}else a.x=n.positionWC.x,a.y=n.positionWC.y,a.z=n.positionWC.z}n.setView({destination:a,orientation:{heading:n.heading,pitch:n.pitch,roll:0}})}else this.qf.inertiaing=!1,this.iv=void 0;this.rv=o}}this.nf=requestAnimationFrame(this.rf)}move(e,n,r=!0){e instanceof i.Cartesian3||(e=new i.Cartesian3(e[0],e[1],e[2])),e=i.Cartesian3.normalize(e,e);const o=this.us.viewer.camera,s=i.Matrix3.fromRotationZ(-o.heading),a=this.uv.enuCenter;i.Matrix3.multiplyByVector(s,e,e);const u=e.x*n,h=e.y*n,l=e.z*n,c=i.Cartographic.fromCartesian(o.positionWC,void 0,this.pv),f=i.Math.toDegrees(c.longitude),d=i.Math.toDegrees(c.latitude);let p=zc(new i.Cartesian3(u,h,l),[f,d,c.height]);const v=Ic(p,a);if(r&&!this.bv(v)){const e=this._v(v);if(!e)return;{const n=Tc(e,a);t.Cartesian3.fromRadians(n[0],n[1],c.height,void 0,p)}}o.setView({destination:p,orientation:{heading:o.heading,pitch:o.pitch,roll:0}})}setMode(t){this.us.lookingMode=t,this.Zp="fixedLine"===this.us.lookingMode,this.Xp.open()}moveByLine(t,e){if(!this.wf||!this.Zp)return;if("forward"===t){if(this.bf+=e*this.ev,this.bf=Math.min(this.bf,this.tv),this.bf===this.tv)return!0}else if(this.bf+=e*this.ev,this.bf=Math.max(this.bf,0),0===this.bf)return!0;const{position:n,rotation:r,up:o,dir:s}=this.Nf(this.wf,this.bf),a=this.us.viewer.camera;if(n&&o&&s){const t=i.Cartesian3.fromDegrees(n[0],n[1],n[2]);a.flyTo({duration:0,destination:t,orientation:{up:o,direction:s}})}else if(n&&r){const t=i.Cartesian3.fromDegrees(n[0],n[1],n[2]);a.flyTo({duration:0,destination:t,orientation:r})}return!1}kv(t){if(!this.Kp||this.qf.noObstacleAvoidance)return!1;const e=this.us.buffer;if(this.Kp.isCode){const n=this.Kp.dis,i=Math.floor((t.x-e)/n),r=Math.floor((t.x+e)/n),o=Math.floor((t.y-e)/n),s=Math.floor((t.y+e)/n),a=Math.floor((t.z-e)/n),u=Math.floor((t.z+e)/n);for(let t=i;t<=r;t+=1)for(let e=o;e<=s;e+=1)for(let n=a;n<=u;n+=1){const i=`${t}_${e}_${n}`;if(this.Kp.codes.has(i))return!0}return!1}return this.Kp.find(((n,i)=>{const r=t.x;if(r>=n[0]-e&&r<=n[3]+e){const i=t.y;if(i>=n[1]-e&&i<=n[4]+e){const i=t.z;if(i>=n[2]-e&&i<=n[5]+e)return!0}}}))}gv=new t.Cartesian3;$v=new t.Cartesian3;bv(t){const e=Ic(this.us.viewer.camera.positionWC,this.uv.enuCenter,this.$v),n=this.hv;if(n){if(this.qf.noObstacleAvoidance)return!0;const e=n.minz,i=n.maxz;return!!(t.z>=e&&t.z<=i&&ey([t.x,t.y],n.multiPolygon))}return!!this.kv(e)||!this.kv(t)}_v(e){const n=this.lv;if(n&&this.hv){const i=n.minz,r=n.maxz,o=ey([e.x,e.y],n.multiPolygon),s=new t.Cartesian3;if(o)s.x=e.x,s.y=e.y,s.z=Math.min(r,Math.max(i,e.z));else{const t=Jm([e.x,e.y],n.multiPolygon);s.x=t[0],s.y=t[1],s.z=Math.min(r,Math.max(i,e.z))}return s}}Nf(t,e){let n=0;const r=this.Jp;for(let o=1;o<t.length;o++){const s=t[o-1],a=t[o],u=r[o-1],h=r[o],l=1e3*ep({type:"Point",coordinates:s},{type:"Point",coordinates:a},{units:"kilometers"});if(n<=e&&n+l>e){const t=(e-n)/l,c=[s[0]+(a[0]-s[0])*t,s[1]+(a[1]-s[1])*t,s[2]+(a[2]-s[2])*t];return u.up?{position:c,up:new i.Cartesian3(u.up[0]+(h.up[0]-u.up[0])*t,u.up[1]+(h.up[1]-u.up[1])*t,u.up[2]+(h.up[2]-u.up[2])*t),dir:new i.Cartesian3(u.dir[0]+(h.dir[0]-u.dir[0])*t,u.dir[1]+(h.dir[1]-u.dir[1])*t,u.dir[2]+(h.dir[2]-u.dir[2])*t)}:{position:c,rotation:new i.HeadingPitchRoll(r[o-1].rotation[0]+(r[o].rotation[0]-r[o-1].rotation[0])*t,r[o-1].rotation[1]+(r[o].rotation[1]-r[o-1].rotation[1])*t,r[o-1].rotation[2]+(r[o].rotation[2]-r[o-1].rotation[2])*t)}}n+=l}return{}}}class sy extends i.Primitive{framebuffer;clearCommand;textures=[];_scene;Ln;constructor(t){if(super(t),!t.viewer)throw new Error("AMapPrimitive: viewer ");this.Ln=t.viewer,this._scene=t.viewer.scene,this.Mn(),this.clearCommand=this.Sv()}update(t){this.An(),super.update()}getTextures(){return{color:this.framebuffer.getColorTexture(0),depth:this.framebuffer.depthTexture}}Mn(){const{drawingBufferWidth:t,drawingBufferHeight:e}=this._scene.context,n=2*Math.floor(t),r=2*Math.floor(e),o=this._scene.context,s=new i.Texture({context:o,width:n,height:r,pixelFormat:i.PixelFormat.RGBA,pixelDatatype:i.PixelDatatype.UNSIGNED_BYTE}),a=new i.Texture({context:o,width:n,height:r,pixelFormat:i.PixelFormat.DEPTH_COMPONENT,pixelDatatype:i.PixelDatatype.UNSIGNED_INT});this.textures=[s],this.framebuffer&&this.framebuffer.destroy(),this.framebuffer=new i.Framebuffer({context:this._scene.context,colorTextures:this.textures,depthTexture:a}),this.framebuffer.Rn="AMapPrimitive",this.framebuffer.Dn=[n,r]}An(){}Sv(){return new i.ClearCommand({framebuffer:this.framebuffer,color:new i.Color(0,0,0,0),depth:1,stencil:0,pass:i.Pass.OVERLAY})}}class ay extends Cl{pd;vd;md=[];_o="closed";yd=[];wd;Yn=[];Ln;us;ve=!1;Ls;Ev;Mv=[];Cv=-1;Av;Ov=-1;Iv=[];constructor(e){super(),this.us={},this.Ln=e,this.pd=new t.ScreenSpaceEventHandler(e.canvas),this.Ls=[]}Tv(t){return this.Mv.find((e=>{const n=e.position?.getValue(i.JulianDate.now());if(n){const e=this.Ln.scene.cartesianToCanvasCoordinates(n);if(i.Cartesian2.distance(t,e)<5)return!0}return!1}))}open(t){const e=this.Ln;if(this.ve||(this._o="open"),!this.Ev||t!=this.Ev){if(this.xd(),t&&t.polygon){const n=t.polygon?.hierarchy?.getValue(i.JulianDate.now()).positions,r=n.length;i.Cartesian3.equals(n[0],n[r-1])&&n.pop(),this.Ls=n,t.polygon.hierarchy=new i.CallbackProperty((()=>new i.PolygonHierarchy(this.Ls)),!1),t.polyline&&(t.polyline.positions=new i.CallbackProperty((()=>this.Ls),!1)),this.Ls.forEach((t=>{const n=e.entities.add({position:t,point:{pixelSize:10,color:i.Color.YELLOW,outlineColor:i.Color.BLACK,outlineWidth:2,disableDepthTestDistance:Number.POSITIVE_INFINITY}});this.Mv.push(n)})),this.Ev=t}else this.Ls=[],this.Ev=e.entities.add({polygon:{hierarchy:new i.CallbackProperty((()=>new i.PolygonHierarchy(this.Ls)),!1),material:new i.Color(0,98/255,254/255,.5),outline:!0,outlineColor:i.Color.WHITE,outlineWidth:2},polyline:{positions:new i.CallbackProperty((()=>this.Ls),!1),material:i.Color.RED}});this.pd.setInputAction((t=>{const n=e.scene.pickPosition(t.endPosition);n&&(this.Av&&-1!==this.Ov?(this.Av.position=n,this.Ls[this.Ov]=n):this.wd?(this.wd.position=n,this.Ls[this.Cv]=n):(this.wd=e.entities.add({position:n,point:{pixelSize:10,color:i.Color.YELLOW,outlineColor:i.Color.BLACK,outlineWidth:2,disableDepthTestDistance:Number.POSITIVE_INFINITY}}),this.Ls.push(n),this.Cv=this.Ls.length-1))}),i.ScreenSpaceEventType.MOUSE_MOVE),this.pd.setInputAction((t=>{this.xd()}),i.ScreenSpaceEventType.RIGHT_DOWN),this.pd.setInputAction((t=>{const n=e.scene.pickPosition(t.position);if(n)if(this.Av)this.Av=void 0,this.Ov=-1;else{const r=this.Tv(t.position);if(r){this.wd&&(e.entities.remove(this.wd),this.Ls.pop()),this.wd=void 0,this.Cv=-1,this.Av=r;const t=this.Mv.indexOf(r);t!==this.Mv.length-1&&(this.Mv.unshift(...this.Mv.splice(t+1)),this.Ls.unshift(...this.Ls.splice(t+1))),this.Ov=this.Mv.length-1}else{this.Ls[this.Cv]=n;const t=e.entities.add({position:n,point:{pixelSize:10,color:i.Color.YELLOW,outlineColor:i.Color.BLACK,outlineWidth:2,disableDepthTestDistance:Number.POSITIVE_INFINITY}});this.Mv.push(t),this.wd&&e.entities.remove(this.wd),this.wd=void 0}}}),i.ScreenSpaceEventType.LEFT_CLICK)}}destroy(){this.close(!0),this.pd.destroy(),this.ve=!0}xd(){if(this.wd&&(this.Ln.entities.remove(this.wd),this.Cv=-1,this.wd=void 0,this.Ls.pop()),this.Av&&(this.Av=void 0,this.Ov=-1),this.Ev)return this.Mv.forEach((t=>{this.Ln.entities.remove(t)})),this.Mv=[],this.Ls.length>=3?(this.Ls.push(this.Ls[0]),this.Ev.polygon&&(this.Ev.polygon.hierarchy=this.Ev.polygon.hierarchy?.getValue(i.JulianDate.now()),this.Ev.polygon.material=new i.Color(0,150/255,254/255,.5)),this.Ev.polyline&&(this.Ev.polyline.positions=this.Ev.polyline.positions?.getValue(i.JulianDate.now()),this.Ev.polyline.material=i.Color.GREEN),this.emit("EditComplete",{polygon:this.Ev}),this.Iv.push(this.Ev),this.Ls=[],this.Ev=this.Ln.entities.add({polygon:{hierarchy:new i.CallbackProperty((()=>new i.PolygonHierarchy(this.Ls)),!1),material:new i.Color(0,98/255,254/255,.5)},polyline:{positions:new i.CallbackProperty((()=>this.Ls),!1),material:i.Color.RED}})):this.Ls=[],this.Ln.scene.requestRender(),this.vd}close(t){this._o="closed",this.pd.removeInputAction(i.ScreenSpaceEventType.LEFT_CLICK),this.pd.removeInputAction(i.ScreenSpaceEventType.RIGHT_DOWN),this.pd.removeInputAction(i.ScreenSpaceEventType.MOUSE_MOVE),this.xd(),t&&this.clear()}clear(){this.xd(),this.wd&&this.Ln.entities.remove(this.wd),this.Iv.forEach((t=>{this.Ln.entities.remove(t)})),this.Ls=[],this.Ln.scene.requestRender()}}const uy={YunJingLayer:Qc,CameraLayer:sf,AMapTerrain:r,AMapSatelliteLayer:o,ENU2ECEF:zc,ECEF2ENU:Ic,ECEF2LLA:Rc,ENU2LLA:Tc,ModelEntity:Zd,ModelAnimationPath:Jd,AnimationPath:Jd,AMapTraffic:Qd,SinglePick:jc,SinglePlane:Lc,FixedLineViewControl:ip,CameraAnimation:op,CameraAnimationPath:sp,CameraAnimationStatus:exports.CameraAnimationStatus,TrackPoint:hp,FirstViewControl:rp,RangingTool:lp,TrafficHistoryLayer:xp,RoadNetLayer:kp,TrafficLayer:Sp,PoiLayer:Um,BuildingLayer:Bm,MonomerLayer:Xc,MonomerDrawLayer:Mp,FirstPersonInteraction:oy,LLA2ENU:Mc,TerrainSampler:Hm,PlaceSearch:qm,PolygonEditor:ay,Math:ny};window.YunJing=uy,exports.AMapPrimitive=sy,exports.AMapSatelliteLayer=o,exports.AMapTerrain=r,exports.AMapTraffic=Qd,exports.AnimationPath=Jd,exports.BuildingLayer=Bm,exports.CameraAnimation=op,exports.CameraAnimationPath=sp,exports.CameraLayer=sf,exports.ECEF2ENU=Ic,exports.ECEF2LLA=Rc,exports.ENU2ECEF=zc,exports.ENU2LLA=Tc,exports.FirstPersonInteraction=oy,exports.FirstViewControl=rp,exports.FixedLineViewControl=ip,exports.LLA2ENU=Mc,exports.Math=ny,exports.ModelAnimationPath=Jd,exports.ModelEntity=Zd,exports.MonomerDrawLayer=Mp,exports.MonomerLayer=Xc,exports.PlaceSearch=qm,exports.PoiLayer=Um,exports.PolygonEditor=ay,exports.RangingTool=lp,exports.RoadNetLayer=kp,exports.SinglePick=jc,exports.SinglePlane=Lc,exports.TerrainSampler=Hm,exports.TrackPoint=hp,exports.TrafficHistoryLayer=xp,exports.TrafficLayer=Sp,exports.YunJingLayer=Qc;
